<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="icon" type="image/png" href="/favicon.png" sizes="32x32">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="manifest" href="/manifest.json">
    <title>Bonfire Night & Guy Fawkes - English for Cool Dudes</title>
    <script src="https://cdn.tailwindcss.com"></script>
   
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* --- COOL DUDES BRANDING & MOBILE-FIRST STYLES --- */
        :root {
            --color-primary: #DC2626; /* Bright Red - Fire/Danger */
            --color-secondary: #F59E0B; /* Orange - Flames */
            --color-accent: #FBBF24; /* Yellow - Sparks */
            --color-background: #FEF3C7; /* Warm Cream */
            --color-text: #1F2937;
            --color-correct: #10B981;
            --color-incorrect: #DC2626;
            --color-new-feature: #7C3AED; /* Purple */
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
            line-height: 1.6;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
        }

        /* === REUSABLE HEADER STYLES === */
        .header {
            background: #FFFFFF;
            border-bottom: 1px solid #D1D5DB;
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--color-primary) 0%, #991B1B 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .site-title {
            font-size: 20px;
            font-weight: 600;
            color: #1A202C;
            letter-spacing: -0.02em;
            text-decoration: none;
        }

        .header-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-button {
            text-decoration: none;
            padding: 7px 14px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
            cursor: pointer;
            border: 1px solid #E5E9F2;
            background: transparent;
        }

        .header-button.login {
            background: #F8F9FB;
            color: #4A5568;
        }

        .header-button.login:hover {
            background: #FFFFFF;
            color: #2C3E50;
            border-color: #718096;
        }

        .header-button.signup {
            background: var(--color-primary);
            color: white;
            border: 1px solid transparent;
        }

        .header-button.signup:hover {
            background: #991B1B;
            box-shadow: 0 2px 5px rgba(220, 38, 38, 0.4);
        }

        .header-button.dashboard {
            background: #FEF3C7;
            color: #92400E;
            border-color: #FBBF24;
        }

        .header-button.dashboard:hover {
            background: #FBBF24;
            border-color: #F59E0B;
        }

        .header-button.logout {
            background: #F8F9FB;
            color: #E53E3E;
        }

        .header-button.logout:hover {
            background: #FEEBEB;
            color: #C53030;
            border-color: #FBD3DA;
        }

        .user-greeting {
            font-size: 14px;
            color: #4A5568;
            font-weight: 600;
            margin-right: 5px;
            white-space: nowrap;
        }
        
        /* Lesson Layout */
        .lesson-container {
            max-width: 800px;
            margin: 20px auto 40px;
            padding: 0 15px;
            min-height: 80vh; /* Ensure footer pushes down */
        }
        
        /* Content Blocks */
        .content-card {
            background-color: #FFFFFF;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 3px solid transparent; 
        }
        
        /* Collapsible Header Style */
        .collapsible-header {
            color: var(--color-primary);
            font-size: 1.8em;
            font-weight: 600;
            margin-bottom: 15px;
            border-bottom: 3px solid var(--color-secondary);
            padding-bottom: 3px;
            cursor: pointer; 
            user-select: none;
            transition: color 0.2s;
        }
        .collapsible-header:hover {
            color: #991B1B;
        }

        /* Reading Text Style */
        .reading-text {
            background: #FEF2F2; 
            border: 1px solid #FCA5A5;
            padding: 15px;
            border-radius: 8px;
            font-size: 1.05em;
            white-space: pre-wrap;
        }
        
        /* Dictionary Word Style */
        .dictionary-word {
            text-decoration: underline dashed var(--color-primary) 2px;
            cursor: help;
            font-weight: 600; 
            color: var(--color-primary);
        }

        /* Quiz Options */
        .quiz-option {
            background: #FFFFFF;
            border: 2px solid #E5E9F2;
            padding: 15px; 
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            display: block;
            user-select: none;
            line-height: 1.4;
        }
        .quiz-option:hover {
            background: #FEF2F2;
            border-color: var(--color-primary);
        }
        .quiz-option.selected {
            background: var(--color-accent);
            color: var(--color-text);
            border-color: var(--color-secondary);
            box-shadow: 0 0 0 3px var(--color-secondary);
            transform: scale(1.01);
        }
        .quiz-option.correct { 
            background: var(--color-correct) !important;
            color: white;
            border-color: var(--color-correct) !important;
        }
        .quiz-option.incorrect { 
            background: var(--color-incorrect) !important;
            color: white;
            border-color: var(--color-incorrect) !important;
        }
        .quiz-option.disabled {
            pointer-events: none;
            opacity: 0.8;
        }
        
        /* Gap Fill Styles */
        .word-bank {
            background: #FED7AA;
            border: 2px solid var(--color-secondary);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .word-option {
            background-color: var(--color-primary); 
            color: white;
            padding: 10px 14px; 
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s, opacity 0.3s;
            font-weight: 600;
            transform: scale(1);
            transition: transform 0.1s;
        }
        .word-option:active {
            transform: scale(0.95);
        }
        .word-option.used {
            opacity: 0.3;
            pointer-events: none;
            background-color: #AAB8C2;
            transform: none;
        }
        .word-option.selected {
            box-shadow: 0 0 0 4px #F59E0B; 
            background-color: #991B1B; 
        }
        .gap-input {
            display: inline-block;
            text-align: center;
            padding: 6px 10px;
            min-width: 110px; 
            height: 40px; 
            background-color: #E5E9F2;
            border: 1px dashed var(--color-primary);
            border-radius: 4px;
            color: var(--color-text);
            font-style: italic;
            cursor: pointer;
            line-height: 28px; 
            vertical-align: middle;
            font-weight: 600;
            margin: 0 4px;
            transition: all 0.2s ease;
        }
        .gap-input:hover {
            border-color: var(--color-secondary);
        }
        .gap-input.filled {
             background-color: var(--color-accent);
             color: var(--color-text);
             font-style: normal;
             border-style: solid;
        }
        .gap-input.correct {
             background-color: var(--color-correct) !important;
             color: white;
             font-style: normal;
             pointer-events: none; /* Disable click on correct answers */
        }
        .gap-input.incorrect {
             background-color: var(--color-incorrect) !important;
             color: white;
             font-style: normal;
        }

        /* Check/Next Button */
        .check-btn {
            background-color: var(--color-primary);
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 15px;
            display: block;
            width: 100%;
            border: none;
            box-shadow: 0 4px #991B1B; 
            text-transform: uppercase;
        }
        .check-btn:hover {
            background-color: #991B1B;
        }
        .check-btn:active {
            box-shadow: 0 1px #991B1B;
            transform: translateY(3px);
        }
        
        /* Save to Dashboard Button */
        #save-words-section {
            background: #EDE9FE;
            border: 2px solid #C4B5FD;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        #save-words-btn {
            background-color: var(--color-new-feature);
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            display: block;
            width: 100%;
            border: none;
            box-shadow: 0 4px #5B21B6;
            text-transform: uppercase;
            font-size: 1.1em;
            text-align: center;
        }
        #save-words-btn:hover:not(:disabled) {
            background-color: #5B21B6;
        }
        #save-words-btn:active:not(:disabled) {
            box-shadow: 0 1px #5B21B6;
            transform: translateY(3px);
        }
        #save-words-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #login-prompt {
            background: #FEF3C7;
            border: 2px solid #FCD34D;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        #login-prompt p {
            color: #D97706;
            font-weight: 600;
            margin-bottom: 15px;
        }

        #login-prompt a {
            color: #7C3AED;
            text-decoration: none;
            font-weight: 600;
        }

        /* Feedback Pop-up */
        #feedback-popup {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 30px;
            background: var(--color-secondary);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
            font-size: 1.2em;
            font-weight: 600;
            text-align: center;
        }
        /* Dictionary Pop-up */
        #dictionary-popup {
            position: fixed; 
            max-width: 250px;
            padding: 15px;
            background: var(--color-primary); 
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            z-index: 1001;
            display: none;
            font-size: 0.95em;
            line-height: 1.4;
            border: 3px solid var(--color-secondary);
            text-align: left;
        }
        .next-btn {
            background-color: var(--color-secondary);
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            float: right;
            margin-top: 10px;
        }
        
        /* Final Summary List Format */
        #learned-words-list {
            list-style: none;
            padding-left: 0;
            margin-left: 0;
        }
        #learned-words-list li {
            margin-bottom: 5px; 
            font-size: 1.05em;
            line-height: 1.2;
            cursor: help; /* New: Make list items look clickable/helpful */
        }
/* --- ADDED FOOTER STYLES --- */
        .footer {
            background: #FFFFFF;
            border-top: 1px solid #E5E9F2;
            padding: 32px 20px;
            margin-top: 60px;
            text-align: center;
        }

        .footer-text {
            font-size: 14px;
            color: #718096;
        }
        @media (max-width: 768px) {
            .user-greeting {
                display: none;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <span class="logo">üòé</span>
                <a href="/intermediate/" class="site-title">English For Cool Dudes</a>
            </div>
            
            <div id="logged-out-buttons" class="header-buttons" style="display: none;">
                <a href="/login/" class="header-button login">Login</a>
                <a href="/signup/" class="header-button signup">Sign Up</a>
            </div>

            <div id="logged-in-buttons" class="header-buttons" style="display: none;">
                <span class="user-greeting" id="user-greeting">Hey Cool Dude! üëã</span>
                <a href="/dashboard/" class="header-button dashboard">My Dashboard</a>
                <button id="logout-btn" class="header-button logout">Sign Out</button>
            </div>
        </div>
    </header>

    <main class="lesson-container">
        <h1 class="text-3xl font-black text-gray-800 mb-5">üî• Bonfire Night: Guy Fawkes and the Gunpowder Plot</h1>
        <p class="text-gray-600 mb-8">Level: Upper Intermediate | Topic: British Culture & History</p>
        
        <div class="flex justify-between items-center text-sm font-semibold mb-2 text-gray-600">
            <span>Progress: Stage <span id="current-stage">1</span> of 5</span>
            <span id="lesson-progress-text"></span>
        </div>
        
        <div class="content-card" data-section-id="0" data-completed="false">
            <h2 class="collapsible-header" onclick="toggleCollapse('reading-content')">üìú Reading Text (Click to Read/Hide the Text. Click <span class="dictionary-word" data-definition="Strong, thick, heavy type with a line underneath.">bold-underlined words</span> for definitions!)</h2>
            <div class="reading-text text-justify" id="reading-content" style="display: none;">
                <h4 class="text-xl font-extrabold text-gray-800 mb-3 mt-3">Remember, Remember the Fifth of November</h4>

                Every year on November 5th, Britain erupts in flames and fireworks as the nation celebrates Bonfire Night, also known as Guy Fawkes Night. This annual tradition <span class="dictionary-word" data-definition="Commemorates or remembers with respect; celebrates the memory of something.">commemorates</span> the failed <span class="dictionary-word" data-definition="The Gunpowder Plot‚Äîa failed attempt to blow up the Houses of Parliament in 1605.">Gunpowder Plot</span> of 1605, when a group of Catholic <span class="dictionary-word" data-definition="People who secretly plan or carry out illegal or harmful actions.">conspirators</span> attempted to blow up the Houses of Parliament and assassinate King James I. The plot's failure marked a significant moment in British history, intertwining themes of religious persecution, political rebellion, and the psychology of <span class="dictionary-word" data-definition="Acts of betrayal against one's country or government.">treason</span>.

                At the heart of the conspiracy was Guy Fawkes, a Catholic convert who had fought in the Spanish Netherlands and possessed military expertise in explosives. While Fawkes has become the face of the plot, he was not its <span class="dictionary-word" data-definition="The person who starts or creates something; the originator.">instigator</span>. That role belonged to Robert Catesby, a <span class="dictionary-word" data-definition="Having charm, confidence, and appeal that attracts followers.">charismatic</span> nobleman who <span class="dictionary-word" data-definition="Gathered together for a common purpose.">assembled</span> a group of thirteen men frustrated by the <span class="dictionary-word" data-definition="Continuous cruel or unfair treatment based on religion or beliefs.">persecution</span> of Catholics under Protestant rule. Their plan was audacious: to detonate 36 barrels of <span class="dictionary-word" data-definition="An explosive black powder used in early firearms and bombs.">gunpowder</span> beneath Parliament during the State Opening, hoping to restore Catholic leadership.

                The plot was ultimately <span class="dictionary-word" data-definition="Revealed or made known (especially secrets or hidden things).">uncovered</span> when an anonymous letter warned Lord Monteagle not to attend Parliament. On the night of November 4th, guards discovered Fawkes in the cellar beneath the House of Lords, guarding the explosives. He was arrested, tortured, and later executed. His co-conspirators faced similar <span class="dictionary-word" data-definition="Severe or tragic ends; fates or outcomes.">fates</span>.

                From a psychological perspective, the conspirators exhibited what modern scholars might call <span class="dictionary-word" data-definition="The belief in the need for extreme or fundamental change.">radicalization</span>; their sense of <span class="dictionary-word" data-definition="Being treated unfairly or without justice.">injustice</span> and marginalization drove them to violence. This phenomenon is not unique to history; understanding the social and psychological factors that lead individuals to extremism remains relevant today.

                Bonfire Night's modern celebration, however, has largely <span class="dictionary-word" data-definition="To move away from or get rid of its original meaning or purpose.">shed</span> its religious and political <span class="dictionary-word" data-definition="Indirect references or suggestions to something.">connotations</span>. Communities gather to watch firework displays, burn <span class="dictionary-word" data-definition="Dummy models or representations of people.">effigies</span> of "the Guy," and enjoy traditional foods like toffee apples and <span class="dictionary-word" data-definition="A traditional British cake made from oats, butter, and syrup; sticky and sweet.">parkin</span>. The night has evolved into a secular, family-friendly event‚Äîa <span class="dictionary-word" data-definition="A powerful reminder or memory of something from the past.">vestige</span> of history transformed into cultural <span class="dictionary-word" data-definition="Objects or events that show respect or honor for important people or events.">pageantry</span>.
            </div>
        </div>

        
        <div id="stage-1" class="content-card" data-section-id="1" data-total-items="1">
            <h2 class="mb-0 collapsible-header" onclick="this.removeAttribute('onclick'); this.textContent = '1 / 5: Main Purpose';">1 / 5: Main Purpose</h2>
            <p class="text-gray-600 mb-4 font-semibold">What is the primary purpose of Bonfire Night, according to the text? (Choose the best answer)</p>

            <div class="question-box" data-correct-value="To commemorate the failed Gunpowder Plot of 1605.">
                <div class="quiz-options space-y-2">
                    <div class="quiz-option" data-value="To celebrate Guy Fawkes as a national hero.">To celebrate Guy Fawkes as a national hero.</div>
                    
                    <div class="quiz-option" data-value="To protest against religious persecution in modern Britain.">To protest against religious persecution in modern Britain.</div>
                <div class="quiz-option" data-value="To commemorate the failed Gunpowder Plot of 1605.">To commemorate the failed Gunpowder Plot of 1605.</div>
                </div>
            </div>
            <button class="check-btn" onclick="checkRadioQuestion(document.querySelector('#stage-1 .question-box'))" id="check-btn-1">Check Answer</button>
            <button class="next-btn" onclick="nextStage(2)" style="display:none;">Continue to Stage 2 / 5 ‚Üí</button>
        </div>


        <div id="stage-2" class="content-card" data-section-id="2" data-total-items="6" style="display:none;">
            <h2 class="mb-0 collapsible-header" onclick="this.removeAttribute('onclick'); this.textContent = '2 / 5: Detail Check';">2 / 5: Detail Check</h2>
            <p class="text-gray-600 mb-4 font-semibold">What aspects are mentioned as relevant to the Gunpowder Plot? (Choose all correct answers in each set)</p>

            <p class="font-bold mt-4 mb-2">Set A: The conspirators' motivations included...</p>
            <div class="question-box" data-correct-values="A,C" data-type="checkbox">
                <div class="quiz-options space-y-2">
                    <div class="quiz-option" data-value="A">frustration with the persecution of Catholics.</div>
                    <div class="quiz-option" data-value="B">desire for personal wealth and fame.</div>
                    <div class="quiz-option" data-value="C">hope to restore Catholic leadership.</div>
                </div>
            </div>

            <p class="font-bold mt-4 mb-2">Set B: Modern Bonfire Night celebrations feature...</p>
            <div class="question-box" data-correct-values="E,F" data-type="checkbox">
                <div class="quiz-options space-y-2">
                    <div class="quiz-option" data-value="D">religious ceremonies and prayers.</div>
                    <div class="quiz-option" data-value="E">firework displays and bonfires.</div>
                    <div class="quiz-option" data-value="F">traditional foods like toffee apples and parkin.</div>
                </div>
            </div>
            <button class="check-btn" onclick="checkCheckboxQuestion(document.querySelectorAll('#stage-2 .question-box'))" id="check-btn-2">Check Answers</button>
            <button class="next-btn" onclick="nextStage(3)" style="display:none;">Continue to Stage 3 / 5 ‚Üí</button>
        </div>


        <div id="stage-3" class="content-card" data-section-id="3" data-total-items="6" style="display:none;">
            <h2 class="mb-0 collapsible-header" onclick="this.removeAttribute('onclick'); this.textContent = '3 / 5: Noun Builder';">3 / 5: Noun Builder</h2>
            
            <h4 class="text-xl font-bold mt-4">üî• Practice the Nouns!</h4>
            <div class="word-bank mb-4">
                <p class="font-bold mb-3 text-sm text-gray-700">Word Bank (Click a word, then click a gap):</p>
                <div class="word-options flex flex-wrap gap-2" id="noun-bank-gapfill">
                    <div class="word-option" data-word="conspirators">conspirators</div>
                    <div class="word-option" data-word="treason">treason</div>
                    <div class="word-option" data-word="persecution">persecution</div>
                    <div class="word-option" data-word="gunpowder">gunpowder</div>
                    <div class="word-option" data-word="effigies">effigies</div>
                    <div class="word-option" data-word="vestige">vestige</div>
                    <div class="word-option" data-word="pageantry">pageantry</div>
                </div>
            </div>
            <div class="gap-fill-text text-lg leading-loose space-y-3" id="gap-fill-nouns">
                <p>1. The Catholic <span class="gap-input" data-answer="conspirators" data-original-text="____" data-filled-word="">____</span> secretly planned to blow up Parliament.</p>
                <p>2. Guy Fawkes was charged with <span class="gap-input" data-answer="treason" data-original-text="____" data-filled-word="">____</span> and executed.</p>
                <p>3. Catholics faced severe <span class="gap-input" data-answer="persecution" data-original-text="____" data-filled-word="">____</span> under Protestant rule.</p>
                <p>4. They hid 36 barrels of <span class="gap-input" data-answer="gunpowder" data-original-text="____" data-filled-word="">____</span> beneath the House of Lords.</p>
                <p>5. Modern celebrations include burning <span class="gap-input" data-answer="effigies" data-original-text="____" data-filled-word="">____</span> of Guy Fawkes.</p>
                <p>6. Bonfire Night is a <span class="gap-input" data-answer="vestige" data-original-text="____" data-filled-word="">____</span> of history transformed into cultural <span class="gap-input" data-answer="pageantry" data-original-text="____" data-filled-word="">____</span>.</p>
            </div>

            <button type="button" class="check-btn" onclick="checkGapFillStage(3)">Check Noun Gaps</button>
            <button class="next-btn" onclick="nextStage(4)" style="display:none;">Continue to Stage 4 / 5 ‚Üí</button>
        </div>


        <div id="stage-4" class="content-card" data-section-id="4" data-total-items="6" style="display:none;">
            <h2 class="mb-0 collapsible-header" onclick="this.removeAttribute('onclick'); this.textContent = '4 / 5: Verb/Adjective Builder';">4 / 5: Verb/Adjective Builder</h2>
            
            <h4 class="text-xl font-bold mt-4">‚ö° Practice the Verbs/Adjectives!</h4>
            <div class="word-bank mb-4">
                <p class="font-bold mb-3 text-sm text-gray-700">Word Bank (Click a word, then click a gap):</p>
                <div class="word-options flex flex-wrap gap-2" id="prep-bank-gapfill">
                    <div class="word-option" data-word="commemorates">commemorates</div>
                    <div class="word-option" data-word="charismatic">charismatic</div>
                    <div class="word-option" data-word="assembled">assembled</div>
                    <div class="word-option" data-word="uncovered">uncovered</div>
                    <div class="word-option" data-word="radicalization">radicalization</div>
                    <div class="word-option" data-word="shed">shed</div>
                </div>
            </div>
            <div class="gap-fill-text text-lg leading-loose space-y-3" id="gap-fill-preps">
                <p>1. Bonfire Night <span class="gap-input" data-answer="commemorates" data-original-text="____" data-filled-word="">____</span> the failure of the Gunpowder Plot.</p>
                <p>2. Robert Catesby was a <span class="gap-input" data-answer="charismatic" data-original-text="____" data-filled-word="">____</span> leader who inspired the conspirators.</p>
                <p>3. He <span class="gap-input" data-answer="assembled" data-original-text="____" data-filled-word="">____</span> a group of thirteen men for the plot.</p>
                <p>4. An anonymous letter <span class="gap-input" data-answer="uncovered" data-original-text="____" data-filled-word="">____</span> the conspiracy before it succeeded.</p>
                <p>5. The conspirators experienced <span class="gap-input" data-answer="radicalization" data-original-text="____" data-filled-word="">____</span> due to feelings of injustice.</p>
                <p>6. Modern celebrations have <span class="gap-input" data-answer="shed" data-original-text="____" data-filled-word="">____</span> their religious and political meanings.</p>
            </div>

            <button type="button" class="check-btn" onclick="checkGapFillStage(4)">Check Verb/Adjective Gaps</button>
            <button class="next-btn" onclick="nextStage(5)" style="display:none;">Continue to Stage 5 / 5 ‚Üí</button>
        </div>

        <div id="stage-5" class="content-card" data-section-id="5" data-total-items="1" style="display:none;">
            <h2 class="mb-0 collapsible-header" onclick="this.removeAttribute('onclick'); this.textContent = '5 / 5: Inference & Meaning';">5 / 5: Inference & Meaning</h2>
            <p class="text-gray-600 mb-4 font-semibold">The text says modern Bonfire Night has "shed its religious and political connotations." What does this mean? (Choose the best answer)</p>

            <div class="question-box" data-correct-value="The original serious meanings are mostly gone, and it's now mainly a fun, cultural celebration.">
                <div class="quiz-options space-y-2">
                    <div class="quiz-option" data-value="It is now a more religious and political event.">It is now a more religious and political event.</div>
                    
                    <div class="quiz-option" data-value="People use the night to remember the original political injustices.">People use the night to remember the original political injustices.</div>
                <div class="quiz-option" data-value="The original serious meanings are mostly gone, and it's now mainly a fun, cultural celebration.">The original serious meanings are mostly gone, and it's now mainly a fun, cultural celebration.</div>
                </div>
            </div>
            <button class="check-btn" onclick="checkRadioQuestion(document.querySelector('#stage-5 .question-box'))" id="check-btn-5">Check Answer</button>
            <button class="next-btn" onclick="nextStage(6)" style="display:none;">Continue to Summary ‚Üí</button>
        </div>
        
        <div id="stage-6" class="content-card" data-section-id="6" style="display:none;">
            <h2 class="mb-4 text-center text-3xl font-extrabold" style="color: var(--color-secondary);">üéâ Lesson Complete! üéÜ</h2>
            <p class="text-center text-lg text-gray-700 mb-4">Great job, Cool Dude! You've learned all about Guy Fawkes and Bonfire Night.</p>
            <p class="text-center text-gray-600 mb-5">You practiced <strong id="final-score-words">13</strong> key words from the text.</p>

            <div class="bg-white p-5 rounded-lg border-2 border-gray-200 mb-6">
                <h3 class="font-bold text-xl text-gray-800 mb-3">Your New Vocabulary (Click for definition):</h3>
                <ul id="learned-words-list" class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-1">
                    <li data-word="commemorates"><strong>commemorates</strong> (v)</li>
                    <li data-word="conspirators"><strong>conspirators</strong> (n)</li>
                    <li data-word="treason"><strong>treason</strong> (n)</li>
                    <li data-word="persecution"><strong>persecution</strong> (n)</li>
                    <li data-word="charismatic"><strong>charismatic</strong> (adj)</li>
                    <li data-word="assembled"><strong>assembled</strong> (v)</li>
                    <li data-word="gunpowder"><strong>gunpowder</strong> (n)</li>
                    <li data-word="uncovered"><strong>uncovered</strong> (v)</li>
                    <li data-word="radicalization"><strong>radicalization</strong> (n)</li>
                    <li data-word="shed"><strong>shed</strong> (v)</li>
                    <li data-word="effigies"><strong>effigies</strong> (n)</li>
                    <li data-word="vestige"><strong>vestige</strong> (n)</li>
                    <li data-word="pageantry"><strong>pageantry</strong> (n)</li>
                </ul>
            </div>
            
            <div id="save-words-section">
                <h3 class="text-xl font-bold text-center mb-3" style="color: var(--color-new-feature);">Save Your Progress</h3>
                <p class="text-center text-gray-700 mb-4">Save these 13 words to your personal dashboard to practice them later.</p>


                
                <div id="save-feature-loggedin" style="display: none;">
                    <button id="save-words-btn" onclick="saveWordsToDashboard()">Save 13 Words to Dashboard</button>
                    <p id="save-status" class="text-center mt-3 font-semibold"></p>
                </div>

<div class="mt-5 pt-3 border-t border-gray-200">
                    <h4 class="font-bold text-lg text-center mb-3" style="color: var(--color-primary);">Further Resource: Watch the History</h4>
                    <a href="https://www.youtube.com/watch?v=6D3cQKeIHdM" target="_blank" 
                       class="header-button signup" 
                       style="background-color: var(--color-secondary); padding: 10px 20px; display: block; width: 100%; text-align: center; border: none;">
                        ‚ñ∂Ô∏è Watch: Guy Fawkes and the Tower of London
                    </a>
                </div>
                
                <div id="login-prompt" style="display: none;">
                    <p>You must be logged in to save words.</p>
                    <a href="/login?next=/lessons/guy-fawkes/" class="header-button signup" style="display: inline-block; padding: 10px 20px;">Login to Save</a>
                </div>
            </div>
        </div>

    </main>
   <footer class="footer">
    <p class="footer-text">¬© 2026 English For Cool Dudes - üòé</p>
    <div style="margin-top: 10px;">
        <a href="/impressum/" style="color: #667EEA; margin-right: 15px; text-decoration: none;">Impressum</a>
        <a href="/datenschutz/" style="color: #667EEA; text-decoration: none;">Datenschutzerkl√§rung</a>
    </div>
</footer>


    <div id="dictionary-popup"></div>
    
    <div id="feedback-popup"></div>

<script>
     // --- Supabase Client (Auth) - FIXED ---
    const SUPABASE_URL = 'https://knwgmrgwbpchqyqxbxea.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtud2dtcmd3YnBjaHF5cXhieGVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MDkyODgsImV4cCI6MjA3ODA4NTI4OH0.qnp2ScwSE77_idmPhpLE98sr46WvLpKtg6refFfC7s8';

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let currentUser = null;

    // --- Global Elements ---
    const dictionaryPopup = document.getElementById('dictionary-popup');
    const feedbackPopup = document.getElementById('feedback-popup');
    const progressStageSpan = document.getElementById('current-stage');
    
    // Lesson Data
    const lessonTitle = "Bonfire Night: Guy Fawkes and the Gunpowder Plot";
    const lessonLink = "/fawkes/";
    const lessonLevel = "Upper Intermediate";
    
    // Helper function to find word object
    function getWordDefinition(word) {
        return wordsToSave.find(w => w.word === word);
    }

    // --- KEY A2 VOCABULARY LIST ---
    const wordsToSave = [
        { word: 'commemorates', definition: 'Remembers with respect; celebrates the memory of something.', type: 'verb' },
        { word: 'conspirators', definition: 'People who secretly plan or carry out illegal or harmful actions.', type: 'noun' },
        { word: 'treason', definition: 'Acts of betrayal against one\'s country or government.', type: 'noun' },
        { word: 'persecution', definition: 'Continuous cruel or unfair treatment based on religion or beliefs.', type: 'noun' },
        { word: 'charismatic', definition: 'Having charm, confidence, and appeal that attracts followers.', type: 'adjective' },
        { word: 'assembled', definition: 'Gathered together for a common purpose.', type: 'verb' },
        { word: 'gunpowder', definition: 'An explosive black powder used in early firearms and bombs.', type: 'noun' },
        { word: 'uncovered', definition: 'Revealed or made known (especially secrets or hidden things).', type: 'verb' },
        { word: 'radicalization', definition: 'The belief in the need for extreme or fundamental change.', type: 'noun' },
        { word: 'shed', definition: 'To move away from or get rid of its original meaning or purpose.', type: 'verb' },
        { word: 'effigies', definition: 'Dummy models or representations of people.', type: 'noun' },
        { word: 'vestige', definition: 'A powerful reminder or memory of something from the past.', type: 'noun' },
        { word: 'pageantry', definition: 'Objects or events that show respect or honor for important people or events.', type: 'noun' },
    ];

    // --- Authentication ---
    async function checkUser() {
        try {
            const { data: { user }, error } = await sb.auth.getUser();

           if (user) {
                currentUser = user;
                console.log('User logged in:', user.email);
                
                document.getElementById('logged-in-buttons').style.display = 'flex';
                document.getElementById('logged-out-buttons').style.display = 'none';
                document.getElementById('save-feature-loggedin').style.display = 'block';
                document.getElementById('login-prompt').style.display = 'none';
                
                // --- Personalized Greeting Logic from your snippet ---
                let userName = 'Cool Dude';
                if (user.user_metadata && user.user_metadata.full_name) {
                    // Use first name if available in user metadata
                    userName = user.user_metadata.full_name.split(' ')[0];
                } else if (user.email) {
                    // Fallback to email pre-@ part
                    userName = user.email.split('@')[0];
                }
                
                const greeting = document.getElementById('user-greeting');
                greeting.textContent = `Hey ${userName}! üëã`;
                // ---------------------------------------------------
            } else {
                currentUser = null;
                document.getElementById('logged-in-buttons').style.display = 'none';
                document.getElementById('logged-out-buttons').style.display = 'flex';
                document.getElementById('save-feature-loggedin').style.display = 'none';
                document.getElementById('login-prompt').style.display = 'block';
            }
        } catch (err) {
            console.error('Error checking auth:', err);
            document.getElementById('logged-out-buttons').style.display = 'flex';
            document.getElementById('logged-in-buttons').style.display = 'none';
        }
    }

    async function handleLogout() {
        const { error } = await sb.auth.signOut();
        if (error) {
            console.error('Error logging out:', error.message);
        } else {
            currentUser = null;
            window.location.href = '/';
        }
    }

    // === SIMPLE MISTAKE TRACKING ===

// 1. FIXED: Save a mistake to the database
async function saveMistake(word) {
    if (!currentUser) return;
    
    try {
        const wordObj = getWordDefinition(word);
        
        const { error } = await sb.from('user_mistakes').upsert({
            user_id: currentUser.id,
            word: word,
            definition: wordObj ? wordObj.definition : '',
            word_type: wordObj ? wordObj.type : '',
            lesson: lessonTitle,
            lesson_link: lessonLink,
            last_made_at: new Date().toISOString()
        }, {
            onConflict: 'user_id,word'
        });
        
        if (error) {
            throw error;
        }
        
        console.log(`Saved/updated mistake: ${word}`);
    } catch (error) {
        console.error('Error saving mistake:', error);
    }
}




    // --- General UI Functions ---
    function toggleCollapse(contentId) {
        const content = document.getElementById(contentId);
        content.style.display = content.style.display === 'none' ? 'block' : 'none';
    }

    function showFeedback(message, type = 'correct') {
        feedbackPopup.textContent = message;
        feedbackPopup.style.background = type === 'correct' ? 'var(--color-correct)' : 'var(--color-incorrect)';
        feedbackPopup.style.display = 'block';
        
        setTimeout(() => {
            feedbackPopup.style.display = 'none';
        }, 1800);
    }
    
    function nextStage(stageNumber) {
        document.querySelectorAll('.content-card[data-section-id]').forEach(card => {
            if (card.dataset.sectionId != "0") {
                 card.style.display = 'none';
            }
        });

        const nextStageEl = document.getElementById(`stage-${stageNumber}`);
        if (nextStageEl) {
            nextStageEl.style.display = 'block';
            if (stageNumber <= 5) {
                 progressStageSpan.textContent = stageNumber;
            } else {
                progressStageSpan.textContent = '5';
                document.querySelector('.flex.justify-between.items-center').style.display = 'none';
                setupWordListInteraction();
            }
            window.scrollTo(0, nextStageEl.offsetTop - 100);
        }
    }

    // --- Word Bank Shuffler ---
    function shuffleWordBanks() {
        const banks = document.querySelectorAll('.word-options');
        banks.forEach(bank => {
            const words = Array.from(bank.children);
            for (let i = words.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [words[i], words[j]] = [words[j], words[i]];
            }
            while (bank.firstChild) {
                bank.removeChild(bank.firstChild);
            }
            words.forEach(word => bank.appendChild(word));
        });
    }

    // --- Dictionary Popup Logic ---
    function showDictionaryPopup(targetElement, definition) {
        if (!definition) return;
        
        dictionaryPopup.innerHTML = definition;
        dictionaryPopup.style.display = 'block';
        
        const rect = targetElement.getBoundingClientRect();
        const popupRect = dictionaryPopup.getBoundingClientRect(); 
        
        let topPos = rect.bottom + 5;
        let leftPos = rect.left + (rect.width / 2) - (popupRect.width / 2);

        if ((leftPos + popupRect.width) > window.innerWidth - 10) {
            leftPos = window.innerWidth - popupRect.width - 10;
        }
        if (leftPos < 10) { 
            leftPos = 10;
        }

        const popupHeight = popupRect.height;
        if ((rect.bottom + popupHeight + 10) > window.innerHeight) {
            topPos = rect.top - popupHeight - 5;
        }
        
        dictionaryPopup.style.left = `${leftPos}px`;
        dictionaryPopup.style.top = `${topPos}px`;
    }

    // --- Setup Click listeners for Reading Text ---
    function setupDictionary() {
        document.querySelectorAll('.dictionary-word').forEach(word => {
            word.addEventListener('click', (e) => {
                e.stopPropagation(); 
                const definition = e.target.dataset.definition;
                showDictionaryPopup(e.target, definition);
            });
        });

        dictionaryPopup.addEventListener('click', (e) => e.stopPropagation());
    }
    
    // --- Setup Click listeners for the Final Summary List ---
    function setupWordListInteraction() {
        document.querySelectorAll('#learned-words-list li').forEach(listItem => {
            listItem.addEventListener('click', (e) => {
                e.stopPropagation(); 
                const word = listItem.dataset.word;
                const wordObj = getWordDefinition(word);
                
                if (wordObj) {
                     const definition = `<strong>${wordObj.word} (${wordObj.type})</strong><br/>${wordObj.definition}`;
                     showDictionaryPopup(listItem, definition);
                }
            });
        });
    }

    // --- Quiz Logic: Radio (Stage 1 & 5) ---
    function setupRadioQuizzes() {
        document.querySelectorAll('.quiz-option[data-value]').forEach(option => {
            if (option.closest('[data-type="checkbox"]')) return;

            option.addEventListener('click', () => {
                const questionBox = option.closest('.question-box');
                if (questionBox.dataset.answered === 'true') return;

                questionBox.querySelectorAll('.quiz-option').forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
            });
        });
    }

    function checkRadioQuestion(questionBox) {
        if (questionBox.dataset.answered === 'true') return;

        const selectedOption = questionBox.querySelector('.quiz-option.selected');
        if (!selectedOption) {
            showFeedback('Failed Plan! Sorry! üëé', 'incorrect');
            return;
        }

        const correctAnswer = questionBox.dataset.correctValue;
        const selectedAnswer = selectedOption.dataset.value;
        const stageId = questionBox.closest('.content-card').id;

        if (selectedAnswer === correctAnswer) {
            selectedOption.classList.add('correct');
            showFeedback('Brilliant! A Great Plan! üéÜ', 'correct');
            
            questionBox.dataset.answered = 'true';
            questionBox.querySelectorAll('.quiz-option').forEach(opt => opt.classList.add('disabled'));
            document.querySelector(`#${stageId} .check-btn`).style.display = 'none';
            document.querySelector(`#${stageId} .next-btn`).style.display = 'inline-block';

        } else {
            selectedOption.classList.add('incorrect');
            showFeedback('Not quite. Try again! üß®', 'incorrect');
            
            setTimeout(() => {
                selectedOption.classList.remove('incorrect');
                selectedOption.classList.remove('selected'); 
            }, 1000); 
        }
    }

    // --- Quiz Logic: Checkbox (Stage 2) ---
    function setupCheckboxQuizzes() {
        document.querySelectorAll('.question-box[data-type="checkbox"] .quiz-option').forEach(option => {
            option.addEventListener('click', () => {
                if (option.closest('.content-card').dataset.answered === 'true') return;
                option.classList.toggle('selected');
            });
        });
    }

    function checkCheckboxQuestion(questionBoxes) {
        const stageId = questionBoxes[0].closest('.content-card').id;
        if (document.querySelector(`#${stageId}`).dataset.answered === 'true') return;
        
        let allSetsCorrect = true;
        let anyIncorrectSelected = false;
        let anyCorrectMissed = false;

        questionBoxes.forEach(box => {
            const correctValues = box.dataset.correctValues.split(',');
            
            box.querySelectorAll('.quiz-option').forEach(option => {
                const value = option.dataset.value;
                const isCorrect = correctValues.includes(value);
                const isSelected = option.classList.contains('selected');

                option.classList.remove('correct', 'incorrect');

                if (isCorrect && isSelected) {
                    option.classList.add('correct');
                } else if (!isCorrect && isSelected) {
                    option.classList.add('incorrect');
                    setTimeout(() => { 
                        option.classList.remove('incorrect');
                        option.classList.remove('selected'); 
                    }, 1000);
                    
                    allSetsCorrect = false;
                    anyIncorrectSelected = true;
                } else if (isCorrect && !isSelected) {
                    allSetsCorrect = false;
                    anyCorrectMissed = true;
                }
            });
        });
        
        if (allSetsCorrect) {
            showFeedback('Bang on! All correct! üî•', 'correct');
            document.querySelector(`#${stageId}`).dataset.answered = 'true';
            
            questionBoxes.forEach(box => {
                box.querySelectorAll('.quiz-option').forEach(opt => opt.classList.add('disabled'));
            });

            document.querySelector(`#${stageId} .check-btn`).style.display = 'none';
            document.querySelector(`#${stageId} .next-btn`).style.display = 'inline-block';
        } else {
            if (anyIncorrectSelected) {
                showFeedback('Your Plan Has Failed! Choose again! üß®', 'incorrect');
            } else if (anyCorrectMissed) {
                showFeedback('Getting Warm! You missed a correct answer. Try again. üí£', 'incorrect');
            }
        }
    }

    // --- Quiz Logic: Gap Fill (Stage 3 & 4) ---
    function setupGapFill() {
        let selectedWordEl = null;

        document.querySelectorAll('.word-option').forEach(word => {
            word.addEventListener('click', (e) => {
                if (word.classList.contains('used')) return;
                
                if (word === selectedWordEl) {
                    word.classList.remove('selected');
                    selectedWordEl = null;
                } else {
                    if (selectedWordEl) {
                        selectedWordEl.classList.remove('selected');
                    }
                    word.classList.add('selected');
                    selectedWordEl = word;
                }
            });
        });

        document.querySelectorAll('.gap-input').forEach(gap => {
            gap.addEventListener('click', (e) => {
                const gapEl = e.target;
                
                if (gapEl.classList.contains('filled') && !gapEl.classList.contains('correct')) {
                    const filledWord = gapEl.dataset.filledWord;
                    
                    const wordBank = gapEl.closest('.content-card').querySelector('.word-options');
                    const wordEl = wordBank.querySelector(`[data-word="${filledWord}"]`);
                    if (wordEl) {
                        wordEl.classList.remove('used');
                    }
                    
                    gapEl.textContent = gapEl.dataset.originalText;
                    gapEl.dataset.filledWord = "";
                    gapEl.classList.remove('filled', 'incorrect');
                    return; 
                }

                if (selectedWordEl && !gapEl.classList.contains('filled')) {
                    const wordToFill = selectedWordEl.dataset.word;
                    
                    gapEl.textContent = wordToFill;
                    gapEl.dataset.filledWord = wordToFill;
                    gapEl.classList.add('filled');
                    
                    selectedWordEl.classList.add('used');
                    selectedWordEl.classList.remove('selected');
                    selectedWordEl = null;
                }
            });
        });
    }

function checkGapFillStage(stageNum) {
    const stageEl = document.getElementById(`stage-${stageNum}`);
    if (stageEl.dataset.answered === 'true') return;
    
    const gaps = stageEl.querySelectorAll('.gap-input');
    let allCorrect = true;
    let correctCount = 0;
    let allFilled = true;
    
    gaps.forEach(gap => {
        gap.classList.remove('correct', 'incorrect');
        
        const filledWord = gap.dataset.filledWord;
        const isCorrect = filledWord === gap.dataset.answer;

        if (filledWord === "") {
            allFilled = false;
            allCorrect = false;
        } else if (isCorrect) {
            gap.classList.add('correct');
            correctCount++;
        } else {
            gap.classList.add('incorrect');
            allCorrect = false;
            
            // Save the mistake with the correct answer (not what they typed)
            saveMistake(gap.dataset.answer);
        }
    });

    if (allCorrect) {
        showFeedback('Fantastic! A perfect display! üí£üí•', 'correct');
        stageEl.dataset.answered = 'true';
        document.querySelector(`#stage-${stageNum} .check-btn`).style.display = 'none';
        document.querySelector(`#stage-${stageNum} .next-btn`).style.display = 'inline-block';
    } else if (!allFilled) {
         showFeedback('Not quite... your plan has failed! üß®', 'incorrect');
    } else {
        showFeedback(`Getting warmer... ${correctCount} are correct. The wrong ones flashed red. Try again! üî•`, 'incorrect');
    }
}

    
    // --- Save Words Logic ---
    async function saveWordsToDashboard() {
        if (!currentUser) {
            showFeedback('You must be logged in to save words! üîí', 'incorrect');
            return;
        }

        const saveButton = document.getElementById('save-words-btn');
        const saveStatus = document.getElementById('save-status');
        
        saveButton.disabled = true;
        saveStatus.textContent = 'Saving... ‚è≥';

        try {
            const { data, error } = await sb
                .from('lessons')
                .upsert([
                    { 
                        user_id: currentUser.id, 
                        lesson_title: lessonTitle,
                        lesson_link: lessonLink,
                        lesson_level: lessonLevel,
                        vocabulary: wordsToSave,
                        completed_at: new Date().toISOString()
                    }
                ], { 
                    onConflict: 'user_id,lesson_title'
                })
                .select();
            
            if (error) {
                throw error;
            }

            saveStatus.textContent = '‚úÖ Saved to your dashboard!';
            saveStatus.style.color = 'var(--color-correct)';
            saveButton.textContent = 'Words Saved!';
            
            setTimeout(() => {
                window.location.href = '/dashboard/';
            }, 1500);

        } catch (error) {
            console.error('Error saving words:', error.message);
            saveStatus.textContent = '‚ùå Error saving. Please try again.';
            saveStatus.style.color = 'var(--color-incorrect)';
            saveButton.disabled = false;
        }
    }

    // 5. Check for mistakes when page loads (add to your DOMContentLoaded)
document.addEventListener('DOMContentLoaded', async () => {
    await checkUser();
    
 
    
    shuffleWordBanks(); 
    setupDictionary(); 
    setupRadioQuizzes();
    setupCheckboxQuizzes();
    setupGapFill();

    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', handleLogout);
    }

    document.body.addEventListener('click', () => {
        if (dictionaryPopup.style.display === 'block') {
            dictionaryPopup.style.display = 'none';
        }
    });
});
    

</script>
</body>
</html>
