<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="icon" type="image/png" href="/favicon.png" sizes="32x32">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="manifest" href="/manifest.json">
    <title>Phrase Scramble - English For Cool Dudes</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: #F8F9FB; 
            color: #2C3E50; 
            margin: 0; 
            overflow-x: hidden; 
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 20px; 
            text-align: center; 
            min-height: 80vh; 
        }
        
        /* Game Controls */
        .controls {
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            align-items: center;
            border: 1px solid #E5E9F2;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
        }
        
        label {
            font-size: 12px;
            font-weight: 700;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select {
            padding: 12px 16px;
            border-radius: 8px;
            border: 2px solid #E2E8F0;
            font-size: 15px;
            background: #FFFFFF;
            color: #2C3E50;
            cursor: pointer;
            min-width: 200px;
            transition: border-color 0.2s;
        }
        select:hover, select:focus {
            border-color: #667EEA;
            outline: none;
        }

        .btn { 
            background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%); 
            color: white; 
            padding: 12px 30px; 
            border-radius: 8px; 
            text-decoration: none; 
            border: none; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: 700;
            transition: transform 0.2s, box-shadow 0.2s;
            height: 46px;
            margin-top: 19px;
        }
        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); 
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .btn-check { background: #10B981; margin-top: 0; }
        .btn-hint { background: #ED8936; margin-top: 0; }

        /* Game Area */
        #game-area {
            display: none; 
            max-width: 800px;
            margin: 0 auto;
        }

        .scramble-box {
            background: white;
            padding: 30px;
            border-radius: 12px;
            border: 2px solid #E2E8F0;
            margin-bottom: 20px;
            min-height: 150px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            align-items: center;
        }

        .word-tile {
            background: #EEF2FF;
            border: 2px solid #667EEA;
            color: #2C3E50;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: grab;
            user-select: none;
            transition: transform 0.2s, background-color 0.2s;
            font-size: 18px;
        }
        .word-tile:hover { transform: translateY(-2px); }
        .word-tile:active { cursor: grabbing; }
        .word-tile.placed { background: #C6F6D5; border-color: #48BB78; }

        /* Drop Zone */
        .drop-zone {
            background: #F7FAFC;
            border: 3px dashed #CBD5E0;
            border-radius: 12px;
            min-height: 80px;
            padding: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }
        .drop-zone.highlight { border-color: #667EEA; background: #EEF2FF; }

        /* Progress & Score */
        .stats-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-weight: 600;
            color: #4A5568;
            background: #EDF2F7;
            padding: 10px 20px;
            border-radius: 50px;
        }
        
        /* Hint Text Display */
        #hint-text {
            margin-bottom: 15px;
            font-style: italic;
            color: #718096;
            font-size: 14px;
            min-height: 20px;
        }

        /* Header/Footer match */
        .header { background: #FFFFFF; border-bottom: 1px solid #E2E8F0; padding: 20px 0; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.04); margin-bottom: 20px; }
        .header-content { max-width: 1000px; margin: 0 auto; padding: 0 20px; display: flex; align-items: center; gap: 15px; }
        .logo { width: 36px; height: 36px; background: linear-gradient(135deg, #0EA5E9 0%, #8B5CF6 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .site-title { font-size: 20px; font-weight: 600; color: #0F172A; letter-spacing: -0.02em; text-decoration: none; }
        footer { background: #FFFFFF; border-top: 1px solid #E5E9F2; padding: 32px 20px; margin-top: 60px; text-align: center; }
        footer p { font-size: 14px; color: #718096; }
        footer a { color: #8B5CF6; margin: 0 10px; text-decoration: none; }

        /* Win Modal */
        #win-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 6000; }
        .win-content { background: white; padding: 40px; border-radius: 20px; text-align: center; max-width: 500px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: pop 0.4s ease-out; }
        .win-title { font-size: 32px; font-weight: 800; color: #8B5CF6; margin-bottom: 10px; }
        .win-text { font-size: 18px; color: #4A5568; margin-bottom: 30px; }
        .win-buttons { display: flex; flex-direction: column; gap: 10px; }
        .win-btn { padding: 12px 20px; border-radius: 8px; font-weight: 700; cursor: pointer; border: none; font-size: 16px; transition: transform 0.2s; }
        .btn-primary { background: #10B981; color: white; }
        .btn-secondary { background: #EDF2F7; color: #4A5568; }
        .win-btn:hover { transform: scale(1.02); }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* Confetti */
        .confetti-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5000; overflow: hidden; display: none; }
        .confetti-piece { position: absolute; top: -50px; font-size: 2rem; animation: fall linear forwards; }
        @keyframes fall { 0% { transform: translateY(-50px) rotate(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotate(360deg); opacity: 0; } }
        
        /* Loading Overlay */
        #loading-overlay {
            position: fixed; top:0; left:0; right:0; bottom:0;
            background: rgba(255,255,255,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 50;
            font-weight: bold;
            color: #667EEA;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="header-left" style="display: flex; align-items: center; gap: 15px;">
                <span class="logo">ðŸ§©</span>
                <a href="/games/" class="site-title">English For Cool Dudes</a>
            </div>
        </div>
    </header>

    <div id="confettiContainer" class="confetti-container"></div>
    <div id="loading-overlay">Loading your personalized game...</div>

    <!-- Win Modal -->
    <div id="win-modal">
        <div class="win-content">
            <div class="win-title">ðŸŽ‰ Fantastic!</div>
            <div class="win-text" id="win-message">You unscrambled all phrases!</div>
            <div class="win-buttons">
                <button class="win-btn btn-primary" onclick="closeModalAndRestart()">ðŸ”„ Play Again</button>
                <button class="win-btn btn-secondary" onclick="closeModalAndNewTheme()">ðŸŽ¨ Try Another Theme</button>
                <button class="win-btn btn-secondary" onclick="closeModalAndNewLevel()">ðŸ“ˆ Try Another Level</button>
                <button class="win-btn btn-secondary" onclick="window.location.href='/games/'" style="border: 2px solid #E2E8F0; color: #2C3E50;">â˜• Back to The Break Room</button>
            </div>
        </div>
    </div>

    <div class="container">
        <h1 style="color:#1A202C; margin-bottom:10px;">ðŸ§© Phrase Scramble</h1>
        <p style="color:#718096; margin-bottom:20px;">Drag and drop the words to build the correct sentence!</p>
        
        <div class="controls" id="setup-panel">
            <div class="control-group">
                <label for="themeSelect">Choose Topic</label>
                <select id="themeSelect" onchange="handleThemeChange()">
                    <option value="business">Business Email</option>
                    <option value="meetings">Meetings & Calls</option>
                    <option value="social">Small Talk</option>
                    <option value="negotiation">Negotiation</option>
                    <option value="holidays">Holidays & Travel</option>
                    <option value="food">Ordering Food</option>
                    <option value="arguing">Arguing & Conflict</option>
                    <option value="opinions">Giving Opinions</option>
                    <option value="mistakes" style="font-weight:bold; color:#E53E3E;">ðŸš¨ My Personal Mistakes</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="levelSelect">Choose Level</label>
                <select id="levelSelect">
                    <option value="beginner">Beginner (A1-A2)</option>
                    <option value="intermediate">Intermediate (B1-B2)</option>
                    <option value="advanced">Advanced (C1-C2)</option>
                </select>
            </div>
            
            <button class="btn" id="startBtn" onclick="initGame()">Start Game</button>
        </div>

        <div id="game-area">
            <div class="stats-bar">
                <span>Round: <span id="currentRound">1</span>/<span id="totalRounds">5</span></span>
                <span>Score: <span id="score">0</span></span>
            </div>
            
            <!-- Context/Hint area mainly for Mistakes mode -->
            <div id="hint-text"></div>

            <div class="drop-zone" id="dropZone">
                <!-- Words dropped here -->
                <span style="color:#CBD5E0; font-weight:600; pointer-events:none;">Drop words here...</span>
            </div>

            <div class="scramble-box" id="sourceBox">
                <!-- Draggable words go here -->
            </div>

            <div style="display:flex; gap:10px; justify-content:center;">
                <button class="btn btn-hint" onclick="showHint()">ðŸ’¡ Hint</button>
                <button class="btn btn-check" onclick="checkAnswer()">âœ… Check Answer</button>
            </div>
        </div>
        
        <br><br>
        <a href="/games/" style="color: #8B5CF6; text-decoration: none; font-weight:600;">&larr; Back to Break Room â˜•</a>
    </div>

    <footer>
        <p>Â© 2026 English For Cool Dudes - ðŸ˜Ž</p>
        <div style="margin-top: 10px;">
            <a href="/impressum/">Impressum</a>
            <a href="/datenschutz/">DatenschutzerklÃ¤rung</a>
        </div>
    </footer>

    <script>
        // --- SUPABASE CONFIG ---
        const SUPABASE_URL = 'https://knwgmrgwbpchqyqxbxea.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtud2dtcmd3YnBjaHF5cXhieGVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MDkyODgsImV4cCI6MjA3ODA4NTI4OH0.qnp2ScwSE77_idmPhpLE98sr46WvLpKtg6refFfC7s8';
        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

       // --- MASSIVE PHRASE DATABASE ---
        const phrases = {
            business: {
                beginner: [
                    "Please send me the file.", "I look forward to hearing from you.", "Thank you for your email.",
                    "Can we meet on Monday?", "See you next week.", "Here is the report.",
                    "Please reply by Friday.", "I am out of the office.", "Call me if you need help.",
                    "The meeting is at two o'clock.", "Did you get my email?", "Please check the attachment.",
                    "I will finish it today.", "Let me know your thoughts.", "Best regards to the team.",
                    "Can you print this for me?", "We need to talk soon.", "The deadline is tomorrow.",
                    "I am working from home.", "Please sign the document."
                ],
                intermediate: [
                    "Could you please clarify this point?", "I apologize for the late reply.", "Please find the attached document.",
                    "Let me know if you have questions.", "We should reschedule our meeting.", "I am writing to enquire about the project.",
                    "Could you update me on the progress?", "We need to finalize the budget soon.", "I have copied my manager on this email.",
                    "Thank you for your prompt response.", "Unless I hear otherwise, I will proceed.", "Please ensure this is done by 5 PM.",
                    "We appreciate your business partnership.", "Could we arrange a quick call?", "I will get back to you shortly.",
                    "Let's discuss this in person.", "Please confirm receipt of this email.", "We are currently reviewing your application.",
                    "The invoice has been paid today.", "Please double-check the figures."
                ],
                advanced: [
                    "We anticipate a significant increase in revenue.", "Please ensure all stakeholders are informed.", "This proposal aligns with our strategic goals.",
                    "I would appreciate your prompt attention to this.", "Let's circle back to this issue later.", "We must prioritize actionable insights immediately.",
                    "Please expedite the shipping process.", "We regret to inform you of the delay.", "Should you require further assistance, contact us.",
                    "We need to mitigate the potential risks.", "This is strictly confidential information.", "We are implementing a new protocol.",
                    "Your feedback has been invaluable to us.", "We are streamlining our internal processes.", "Please disseminate this information to the team.",
                    "We need to leverage our core competencies.", "The quarterly results exceeded expectations.", "We are restructuring the department effectively.",
                    "Please address these concerns immediately.", "We aim to optimize our workflow efficiency."
                ]
            },
            meetings: {
                beginner: [
                    "Nice to meet you.", "Can you hear me?", "Let's start the meeting.",
                    "Who is taking notes?", "Do you agree?", "You are on mute.",
                    "Can you see my screen?", "Sorry I am late.", "That is a good idea.",
                    "Let's take a break.", "When is the next meeting?", "I have a question.",
                    "Please turn off your camera.", "The connection is bad.", "Can you repeat that?",
                    "Let's vote on this.", "Who wants to start?", "Thank you for coming.",
                    "Is everyone here?", "Let's finish on time."
                ],
                intermediate: [
                    "Shall we get down to business?", "I'd like to add something here.", "Does anyone have any questions?",
                    "Let's wrap this up for today.", "Could you speak up a little?", "Let's move to the next item.",
                    "We are running out of time.", "Could you elaborate on that?", "I think we are getting off track.",
                    "Let's put a pin in that.", "I will send out the minutes.", "Does that make sense to everyone?",
                    "I didn't catch the last part.", "Could you mute your microphone?", "We need to reach a consensus.",
                    "Let's review the action items.", "Can we keep this brief?", "I would like to propose a solution.",
                    "Let's table this discussion for now.", "Who is leading this project?"
                ],
                advanced: [
                    "Let's not get bogged down in details.", "I want to play devil's advocate here.", "We need to think outside the box.",
                    "Let's touch base again next week.", "The consensus is to move forward.", "We need to align on our objectives.",
                    "This requires a holistic approach.", "Let's drill down into the data.", "We need to facilitate better communication.",
                    "I want to solicit your feedback.", "Let's streamline the decision-making process.", "We must address the elephant in the room.",
                    "This creates a synergy between teams.", "Let's take this conversation offline.", "We need to benchmark against competitors.",
                    "Please keep your remarks concise.", "We need to foster a culture of innovation.", "Let's identifying the key deliverables.",
                    "We should leverage our collective expertise.", "This is a pivotal moment for us."
                ]
            },
            social: {
                beginner: [
                    "How was your weekend?", "What do you do?", "The weather is nice today.",
                    "Do you like coffee?", "Where are you from?", "I have two sisters.",
                    "My hobby is reading.", "Do you have pets?", "What is your name?",
                    "I live in London.", "Do you like sports?", "See you later.",
                    "Have a nice day.", "It is very cold.", "I like your shirt.",
                    "How old are you?", "What time is it?", "I am hungry.",
                    "Let's go for lunch.", "Are you busy?"
                ],
                intermediate: [
                    "Have you been here before?", "It's been ages since we met.", "What have you been up to?",
                    "I heard you got promoted.", "How is your project going?", "Do you have any holiday plans?",
                    "How do you know the host?", "It looks like it might rain.", "Have you seen any good movies?",
                    "I am thinking of moving house.", "How is your family doing?", "I really enjoyed the party.",
                    "We should catch up soon.", "What brings you here today?", "I have been very busy lately.",
                    "Did you watch the game last night?", "I love the food here.", "Nice to see you again.",
                    "How was your trip?", "That sounds absolutely wonderful."
                ],
                advanced: [
                    "It's a pleasure to finally meet you in person.", "I was wondering if you could help me.", "What's your take on the new policy?",
                    "Fancy grabbing a bite to eat?", "I've heard great things about your work.", "It is such a small world.",
                    "I am contemplating a career change.", "How are you finding the conference?", "I couldn't agree with you more.",
                    "That is a fascinating perspective.", "I would love to pick your brain.", "Please give my regards to your wife.",
                    "I was pleasantly surprised by the outcome.", "It is refreshing to hear that.", "I am really looking forward to it.",
                    "Whatever happened to your old boss?", "I am keeping my fingers crossed.", "It was a serendipitous encounter.",
                    "You must be exhausted after your flight.", "Let's not talk shop tonight."
                ]
            },
            negotiation: {
                beginner: [
                    "That is too expensive.", "Can you give a discount?", "We accept your offer.",
                    "I need time to think.", "Let's make a deal.", "The price is high.",
                    "Can you lower the price?", "We want to buy it.", "Is that your best price?",
                    "We agree to the terms.", "No deal today.", "We need more time.",
                    "That is a good offer.", "We cannot pay that.", "When can you deliver?",
                    "Is shipping free?", "We want a contract.", "Can we pay later?",
                    "This is our final offer.", "Do you accept cash?"
                ],
                intermediate: [
                    "We are looking for a better price.", "That sounds like a fair compromise.", "I'm afraid we can't agree to that.",
                    "Let's meet halfway on this.", "What is your bottom line?", "We are prepared to sign the contract.",
                    "Could you throw in free shipping?", "We need to discuss the warranty.", "This is slightly over our budget.",
                    "We are hoping for a long-term partnership.", "Let's review the terms and conditions.", "Can we pay in installments?",
                    "This offer is valid for one week.", "We need to consult with our legal team.", "That is a deal-breaker for us.",
                    "We can offer a five percent discount.", "Let's shake on it.", "We are close to an agreement.",
                    "We need to clarify this clause.", "I think we have a deal."
                ],
                advanced: [
                    "We need to leverage our position.", "This is a non-negotiable term for us.", "Let's try to find common ground.",
                    "We are prepared to walk away.", "This offer is contingent on approval.", "We need to mitigate our liability.",
                    "Let's look for a win-win situation.", "We propose a counter-offer.", "The terms are mutually beneficial.",
                    "We need exclusivity in this market.", "Let's iron out the final details.", "We are at an impasse.",
                    "This is our best and final offer.", "We require a robust service level agreement.", "We are banking on your support.",
                    "Let's not jeopardize the deal.", "We need to safeguard our interests.", "This creates a conflict of interest.",
                    "We reserve the right to withdraw.", "The ballpark figure is acceptable."
                ]
            },
            holidays: {
                beginner: [
                    "I want to book a room.", "Where is the beach?", "How much is the ticket?",
                    "I need a taxi please.", "The food was delicious.", "Is there a pool?",
                    "I lost my passport.", "Where is the station?", "A table for two please.",
                    "Can I have the menu?", "It is very sunny.", "I want to go swimming.",
                    "This hotel is nice.", "Where is the bathroom?", "Can you help me?",
                    "I like this city.", "We are on holiday.", "My bag is heavy.",
                    "Check please.", "Do you speak English?"
                ],
                intermediate: [
                    "I would like to make a reservation.", "Could I have a window seat please?", "What time do we have to check out?",
                    "Is breakfast included in the price?", "We had a delay at the airport.", "Could you take a photo of us?",
                    "We are looking for a pharmacy.", "Is there a guided tour available?", "How do I get to the city center?",
                    "The air conditioning is not working.", "I would like to wake up at seven.", "Can I pay by credit card?",
                    "We are staying for three nights.", "Could you recommend a restaurant?", "The view from the room is great.",
                    "We missed our connecting flight.", "I would like to rent a car.", "Is it safe to walk here at night?",
                    "Where can I buy a ticket?", "The service was excellent."
                ],
                advanced: [
                    "We thoroughly enjoyed the local cuisine.", "The accommodation exceeded our expectations.", "We embarked on a guided excursion.",
                    "My itinerary is quite flexible today.", "I experienced severe jet lag yesterday.", "We immersed ourselves in the culture.",
                    "The scenery was absolutely breathtaking.", "We ventured off the beaten track.", "I need to exchange some currency.",
                    "We would like to upgrade our room.", "The hospitality was outstanding.", "We encountered a slight hiccup.",
                    "Is there a complimentary shuttle?", "I need to claim my travel insurance.", "We visited a heritage site.",
                    "The journey was rather arduous.", "We are seeking an authentic experience.", "Please cancel my reservation.",
                    "We have a layover in Dubai.", "This is a bucket list destination."
                ]
            },
            food: {
                beginner: [
                    "I would like a menu.", "Can I have the bill?", "I am allergic to nuts.",
                    "Water with no ice please.", "This soup is very hot.", "I want the chicken.",
                    "Do you have pizza?", "A coke please.", "This tastes good.",
                    "I am vegetarian.", "Table for four please.", "Is it spicy?",
                    "I don't like onions.", "More bread please.", "What is this?",
                    "I am full.", "It was delicious.", "One coffee please.",
                    "Can I have a fork?", "Keep the change."
                ],
                intermediate: [
                    "Could we see the wine list?", "I think I will have the steak.", "Is there a service charge included?",
                    "Could you recommend a local dish?", "I'd like my steak medium rare.", "Does this come with fries?",
                    "Could we have some tap water?", "I am gluten intolerant.", "This is not what I ordered.",
                    "Could we have the dressing on the side?", "We are ready to order now.", "Could you bring more napkins?",
                    "Is the fish fresh today?", "I'm saving room for dessert.", "Let's split the appetizer.",
                    "The service is a bit slow.", "This meat is very tender.", "What is the soup of the day?",
                    "Could we separate the checks?", "I can't eat dairy products."
                ],
                advanced: [
                    "The tasting menu looks exquisite.", "I found the texture slightly rubbery.", "Does this dish contain any gluten?",
                    "We would like to split the bill.", "The ambiance here is delightful.", "The presentation is impeccable.",
                    "It has a very subtle flavor.", "I have a severe shellfish allergy.", "This pairs well with the red wine.",
                    "The chef has outdone himself.", "I found the dish underwhelming.", "Could you decant the wine?",
                    "It was a culinary masterpiece.", "The seasoning is a bit overpowering.", "I have a sophisticated palate.",
                    "We would like the sommelier's advice.", "This is a gastronomic delight.", "The ingredients are locally sourced.",
                    "I would like an aperitif first.", "Please compliments to the chef."
                ]
            },
            arguing: {
                beginner: [
                    "I do not agree.", "You are wrong.", "Please listen to me.",
                    "That is not fair.", "I am not happy.", "Stop doing that.",
                    "I am angry.", "You are shouting.", "That is not true.",
                    "I don't like your tone.", "Let me speak.", "You never listen.",
                    "I am right.", "Go away.", "This is bad.",
                    "Why did you do that?", "It is your fault.", "No way.",
                    "I refuse.", "Calm down."
                ],
                intermediate: [
                    "I see your point but I disagree.", "That is not exactly what I meant.", "We are going around in circles.",
                    "Let's agree to disagree.", "You are missing the point.", "I think you are overreacting.",
                    "Please let me finish my sentence.", "That is completely out of line.", "I expect an apology from you.",
                    "You are twisting my words.", "Let's try to be reasonable.", "I am disappointed in you.",
                    "That is simply not the case.", "You are making a mistake.", "I can't believe you said that.",
                    "Let's take a step back.", "You need to calm down.", "This is going nowhere.",
                    "I am not going to argue with you.", "That is a ridiculous accusation."
                ],
                advanced: [
                    "I take issue with that statement.", "With all due respect, you are mistaken.", "That argument is fundamentally flawed.",
                    "Let's not jump to conclusions.", "We need to find a middle ground.", "Your logic is unsound.",
                    "That is a complete fabrication.", "I strictly oppose that idea.", "Let's not get personal.",
                    "You are evading the question.", "That is a baseless allegation.", "I resent that implication.",
                    "We seem to be at an impasse.", "You are projecting your issues.", "Let's stick to the facts.",
                    "That is a moot point.", "You are barking up the wrong tree.", "I will not tolerate this behavior.",
                    "That is highly inappropriate.", "We have irreconcilable differences."
                ]
            },
            opinions: {
                beginner: [
                    "I think it is good.", "In my opinion it is bad.", "I like this idea.",
                    "I do not like it.", "Maybe you are right.", "It is okay.",
                    "I prefer the blue one.", "It is too hard.", "It is easy.",
                    "I agree with you.", "I don't know.", "What do you think?",
                    "It seems nice.", "That is true.", "I don't think so.",
                    "It is boring.", "It is fun.", "I love it.",
                    "I hate it.", "It is interesting."
                ],
                intermediate: [
                    "Personally I feel that it works.", "From my point of view it is risky.", "As far as I am concerned.",
                    "I am convinced that this is best.", "I tend to think that you are right.", "If you ask me, it's too expensive.",
                    "It seems to me that we are ready.", "I have mixed feelings about this.", "I firmly believe we can do it.",
                    "I suppose you have a point.", "To be honest, I don't like it.", "I would rather not say.",
                    "It looks like a good opportunity.", "My honest opinion is different.", "I am not sure about that.",
                    "I completely agree with you.", "I respectfully disagree.", "It is definitely worth a try.",
                    "I am 100% certain.", "There is no doubt about it."
                ],
                advanced: [
                    "It is my firm belief that we should proceed.", "I would argue that the opposite is true.", "To play devil's advocate for a moment.",
                    "I am inclined to agree with you.", "My impression is that we need more time.", "I have some reservations about this.",
                    "Without a doubt, this is the best option.", "I assume full responsibility for this.", "It is imperative that we act now.",
                    "I am of the opinion that it will fail.", "That is a valid point.", "I concur with your assessment.",
                    "I beg to differ.", "It is evident that mistakes were made.", "I am skeptical about the results.",
                    "From an objective standpoint.", "My perspective has changed.", "I wholeheartedly support this.",
                    "It is a controversial topic.", "I would hazard a guess that he is lying."
                ]
            }
        };

        // --- GAME STATE ---
        let currentPhrases = [];
        let currentRound = 0;
        let score = 0;
        let currentTargetPhrase = "";
        let draggedItem = null;
        let isMistakesMode = false;

        // --- UI HANDLERS ---
        function handleThemeChange() {
            const theme = document.getElementById('themeSelect').value;
            const levelSelect = document.getElementById('levelSelect');
            
            if (theme === 'mistakes') {
                levelSelect.disabled = true;
                levelSelect.innerHTML = '<option>Personalized</option>';
            } else {
                levelSelect.disabled = false;
                levelSelect.innerHTML = `
                    <option value="beginner">Beginner (A1-A2)</option>
                    <option value="intermediate">Intermediate (B1-B2)</option>
                    <option value="advanced">Advanced (C1-C2)</option>
                `;
            }
        }

        function closeModalAndNewLevel() {
            document.getElementById('win-modal').style.display = 'none';
            document.getElementById('confettiContainer').style.display = 'none';
            clearInterval(confettiInterval);
            
            // Focus level selector if applicable
            const levelSelect = document.getElementById('levelSelect');
            if (!levelSelect.disabled) {
                levelSelect.focus();
            } else {
                document.getElementById('themeSelect').focus();
            }
            
            document.getElementById('game-area').style.display = 'none';
            document.getElementById('setup-panel').style.display = 'flex';
        }

        // --- INIT ---
        async function initGame() {
            const theme = document.getElementById('themeSelect').value;
            const level = document.getElementById('levelSelect').value;
            
            isMistakesMode = (theme === 'mistakes');
            document.getElementById('hint-text').textContent = ""; // Clear hint area

            if (isMistakesMode) {
                document.getElementById('loading-overlay').style.display = 'flex';
                const { data: { user } } = await sb.auth.getUser();
                
                if (!user) {
                    document.getElementById('loading-overlay').style.display = 'none';
                    alert("ðŸ”’ You need to log in to play with your mistakes!");
                    window.location.href = '/login/'; 
                    return;
                }

                const { data: mistakes, error } = await sb
                    .from('user_mistakes')
                    .select('word, definition')
                    .eq('user_id', user.id);

                document.getElementById('loading-overlay').style.display = 'none';

                if (error || !mistakes || mistakes.length < 3) {
                    alert("âš ï¸ You don't have enough mistakes recorded yet! You need at least 3 to play. Go do some lessons first! ðŸ˜‰");
                    return;
                }

                // Create sentences from mistakes: "The definition of [WORD] is [DEF]"
                // Challenge: Scramble the definition. 
                // Hint: "Define: [WORD]"
                
                // We will structure 'currentPhrases' differently for mistakes mode
                // It will store objects: { phrase: "Definition Text", hint: "Define: Word" }
                currentPhrases = mistakes.map(m => ({
                    phrase: m.definition, // The text to scramble
                    hint: `Define: ${m.word}` // Context
                })).sort(() => 0.5 - Math.random()).slice(0, 5);

            } else {
                // Standard Mode
                let allPhrases = phrases[theme][level];
                // Standard phrases are just strings
                currentPhrases = [...allPhrases].sort(() => 0.5 - Math.random()).slice(0, 5);
            }
            
            currentRound = 0;
            score = 0;
            
            document.getElementById('setup-panel').style.display = 'none';
            document.getElementById('game-area').style.display = 'block';
            document.getElementById('totalRounds').textContent = currentPhrases.length;
            
            loadRound();
        }

        function loadRound() {
            if (currentRound >= currentPhrases.length) {
                triggerWin();
                return;
            }

            document.getElementById('currentRound').textContent = currentRound + 1;
            document.getElementById('score').textContent = score;
            
            // Handle data structure difference
            if (isMistakesMode) {
                currentTargetPhrase = currentPhrases[currentRound].phrase;
                document.getElementById('hint-text').innerHTML = `<strong>Challenge:</strong> ${currentPhrases[currentRound].hint}`;
            } else {
                currentTargetPhrase = currentPhrases[currentRound];
                document.getElementById('hint-text').textContent = ""; 
            }
            
            // Cleanup phrase (remove trailing period for scramble purposes if preferred, 
            // but here we keep punctuation to make it a grammar puzzle too)
            
            let words = currentTargetPhrase.split(' ');
            let shuffledWords = [...words].sort(() => 0.5 - Math.random());

            const sourceBox = document.getElementById('sourceBox');
            const dropZone = document.getElementById('dropZone');
            
            sourceBox.innerHTML = '';
            dropZone.innerHTML = '<span style="color:#CBD5E0; font-weight:600; pointer-events:none; width:100%; text-align:center;">Drop words here...</span>';

            shuffledWords.forEach((word, index) => {
                const tile = document.createElement('div');
                tile.classList.add('word-tile');
                tile.textContent = word;
                tile.draggable = true;
                tile.id = `word-${index}`;
                
                // Drag Events
                tile.addEventListener('dragstart', handleDragStart);
                tile.addEventListener('dragend', handleDragEnd);
                // Touch Events for Mobile
                tile.addEventListener('touchstart', handleTouchStart, {passive: false});
                tile.addEventListener('touchmove', handleTouchMove, {passive: false});
                tile.addEventListener('touchend', handleTouchEnd);
                
                // Click to move logic
                tile.addEventListener('click', () => moveTile(tile));

                sourceBox.appendChild(tile);
            });

            setupDropZone();
        }

        // --- DRAG & DROP LOGIC ---
        function handleDragStart(e) {
            draggedItem = this;
            setTimeout(() => this.style.opacity = '0.5', 0);
        }

        function handleDragEnd() {
            this.style.opacity = '1';
            draggedItem = null;
            checkPlaceholder();
        }

        function setupDropZone() {
            const dz = document.getElementById('dropZone');
            const sb = document.getElementById('sourceBox');

            [dz, sb].forEach(zone => {
                zone.addEventListener('dragover', e => {
                    e.preventDefault(); // Allow drop
                    zone.classList.add('highlight');
                });
                zone.addEventListener('dragleave', () => zone.classList.remove('highlight'));
                zone.addEventListener('drop', e => {
                    e.preventDefault();
                    zone.classList.remove('highlight');
                    if (draggedItem) {
                        zone.appendChild(draggedItem);
                        checkPlaceholder();
                    }
                });
            });
        }

        // --- TOUCH SUPPORT ---
        function handleTouchStart(e) {}
        function handleTouchMove(e) { e.preventDefault(); } 
        function handleTouchEnd(e) {} 

        // --- CLICK TO MOVE ---
        function moveTile(tile) {
            const parent = tile.parentElement;
            const dropZone = document.getElementById('dropZone');
            const sourceBox = document.getElementById('sourceBox');
            
            const placeholder = dropZone.querySelector('span');
            
            if (parent === sourceBox) {
                if(placeholder) placeholder.remove();
                dropZone.appendChild(tile);
            } else {
                sourceBox.appendChild(tile);
                checkPlaceholder();
            }
        }

        function checkPlaceholder() {
            const dz = document.getElementById('dropZone');
            const hasTiles = dz.querySelector('.word-tile');
            const hasPlaceholder = dz.querySelector('span');
            
            if (!hasTiles && !hasPlaceholder) {
                dz.innerHTML = '<span style="color:#CBD5E0; font-weight:600; pointer-events:none; width:100%; text-align:center;">Drop words here...</span>';
            } else if (hasTiles && hasPlaceholder) {
                hasPlaceholder.remove();
            }
        }

        // --- GAMEPLAY LOGIC ---
        function checkAnswer() {
            const dropZone = document.getElementById('dropZone');
            const tiles = dropZone.querySelectorAll('.word-tile');
            let userSentence = Array.from(tiles).map(t => t.textContent).join(' ');
            
            // Case insensitive check can be nicer, but for sentence building exact match is usually preferred
            if (userSentence === currentTargetPhrase) {
                // Correct
                tiles.forEach(t => t.classList.add('placed'));
                score += 10;
                document.getElementById('score').textContent = score;
                
                dropZone.style.borderColor = '#48BB78';
                dropZone.style.backgroundColor = '#F0FFF4';
                
                setTimeout(() => {
                    currentRound++;
                    dropZone.style.borderColor = '#CBD5E0';
                    dropZone.style.backgroundColor = '#F7FAFC';
                    loadRound();
                }, 1000);
            } else {
                // Incorrect
                dropZone.style.borderColor = '#F56565';
                dropZone.style.backgroundColor = '#FFF5F5';
                setTimeout(() => {
                    dropZone.style.borderColor = '#CBD5E0';
                    dropZone.style.backgroundColor = '#F7FAFC';
                }, 800);
            }
        }

        function showHint() {
            // Show first two words
            let firstTwo = currentTargetPhrase.split(' ').slice(0, 2).join(' ');
            alert(`Hint: The sentence starts with...\n"${firstTwo}..."`);
            score -= 2; 
            document.getElementById('score').textContent = score;
        }

        // --- WIN LOGIC ---
        const emojis = ['ðŸ¹', 'ðŸ‘‘', 'ðŸšŒ', 'ðŸ§©', 'ðŸ˜Ž', 'ðŸš€', 'ðŸŽ‰'];
        let confettiInterval;

        function triggerWin() {
            document.getElementById('win-message').textContent = `You completed the set with a score of ${score}!`;
            document.getElementById('confettiContainer').style.display = 'block';
            
            confettiInterval = setInterval(() => {
                const piece = document.createElement('div');
                piece.classList.add('confetti-piece');
                piece.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                piece.style.left = Math.random() * 100 + 'vw';
                piece.style.animationDuration = (Math.random() * 2 + 3) + 's';
                document.getElementById('confettiContainer').appendChild(piece);
                setTimeout(() => piece.remove(), 5000);
            }, 150);

            setTimeout(() => {
                document.getElementById('win-modal').style.display = 'flex';
            }, 500);
        }

        function closeModalAndRestart() {
            document.getElementById('win-modal').style.display = 'none';
            document.getElementById('confettiContainer').style.display = 'none';
            clearInterval(confettiInterval);
            initGame();
        }

        function closeModalAndNewTheme() {
            document.getElementById('win-modal').style.display = 'none';
            document.getElementById('confettiContainer').style.display = 'none';
            clearInterval(confettiInterval);
            document.getElementById('game-area').style.display = 'none';
            document.getElementById('setup-panel').style.display = 'flex';
        }
    </script>
</body>
</html>
