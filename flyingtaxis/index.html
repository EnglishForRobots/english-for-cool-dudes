<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title id="page-title">Loading...</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/init-auth.js"></script>

    <script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“ LESSON CONFIG â€” Flying Taxis Lesson
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const LESSON_CONFIG = {

    // â”€â”€â”€ BASIC INFO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    title:      "ğŸš Sky High: The Future of Flying Taxis",
    subtitle:   "Is the era of the flying car finally here?",
    level:      "Advanced",       // B2-C1 Upper Intermediate
    lessonId:   "flying-taxis",
    lessonLink: "/flyingtaxis/",
    logoEmoji:  "ğŸš",
    levelPage:  "/advanced/",

    // â”€â”€â”€ THEME COLOURS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    colors: {
        primary:    "#0369A1",   // Sky Blue
        secondary:  "#F97316",   // Aviation Orange
        background: "#F0F9FF"    // Light Sky Blue
    },

    // â”€â”€â”€ VOCABULARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    vocabulary: [
        { word: "Low-altitude", type: "noun", definition: "Aircraft flying below 1,000 meters." },
        { word: "Certified", type: "adjective", definition: "Officially recognized or endorsed by a certificate." },
        { word: "Commercial", type: "adjective", definition: "Related to business or profit-making activities." },
        { word: "Unnerving", type: "adjective", definition: "Making you feel nervous or worried." },
        { word: "Widespread", type: "adjective", definition: "Existing or happening in many places." },
        { word: "Infrastructure", type: "noun", definition: "Basic systems like roads, power lines, and charging stations." },
        { word: "Regulatory", type: "adjective", definition: "Relating to official rules and laws." }
    ],

    // â”€â”€â”€ SECTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    sections: [

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // VIDEO SECTION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        {
            type:  "video",
            title: "ğŸ“º 1. Watch & Analyze",
            intro: "Watch this report about China's flying taxi revolution.",
            youtubeUrl: "https://www.youtube-nocookie.com/embed/oBp96YGStIQ?si=kx6mYOeKHD6PbjW3",
            discussion: [
                "What advantages do flying taxis have over traditional cars?",
                "Would you feel comfortable in a pilotless aircraft? Why or why not?",
                "What challenges need to be solved before flying taxis become common?"
            ]
        },

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // READING SECTION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        {
            type:  "reading",
            title: "ğŸ“– 2. Context & Reading",
            
            facts: [
                "The E-Hung is the first flying taxi certified by a national aviation authority",
                "These vehicles can take off vertically â€” no runway needed",
                "China is heavily investing in the 'low-altitude economy'",
                "Current price: $300,000-$400,000 for a complete system"
            ],

            content: `
                <p class="mb-4">Is the era of the flying car finally here? In China, the government is heavily backing the <vocab>low-altitude</vocab> economy. This refers to aircraft flying below 1,000 meters. The E-Hung electric vehicle has become the first in the world to be <vocab>certified</vocab> for <vocab>commercial</vocab> use by a national aviation authority.</p>

                <p class="mb-4">These air taxis take off vertically, meaning no runway is required. While the experience can be slightly <vocab>unnerving</vocab> due to the lack of human controls, manufacturers argue that automation reduces accidents. However, the <vocab>widespread</vocab> adoption of this technology still depends on building the necessary <vocab>infrastructure</vocab>.</p>

                <p>Other companies are developing "land aircraft carriers"â€”vans that can transport and charge a flying vehicle. While current prices are high, experts believe that once they gain <vocab>regulatory</vocab> approval, the sky really is the limit.</p>
            `
        },

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MULTIPLE CHOICE SECTION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        {
            type:  "multipleChoice",
            title: "â“ 3. Flight Check: Comprehension",
            questions: [
                {
                    question: "What is the definition of the 'low-altitude economy'?",
                    options: [
                        "Aircraft flying at hypersonic speeds",
                        "Ground-based transportation in hilly areas",
                        "Flights occurring below 1,000 meters"
                    ],
                    correct: 2
                },
                {
                    question: "Why does the reporter describe the experience as 'unnerving'?",
                    options: [
                        "The aircraft was too loud to talk",
                        "The doors didn't close properly",
                        "There were no pilot controls inside the taxi"
                    ],
                    correct: 2
                },
                {
                    question: "How much does the 'land aircraft carrier' (van + flying unit) cost?",
                    options: [
                        "$90,000",
                        "$300,000 - $400,000",
                        "Over $1 million"
                    ],
                    correct: 1
                }
            ]
        },

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // GAP FILL SECTION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        {
            type:  "gapFill",
            title: "ğŸ“ 4. Contextual Gap Fill",
            wordBank: ["certified", "widespread", "infrastructure", "regulatory", "commercial", "unnerving"],
            sentences: [
                { text: "Flying in an automated aircraft can be quite ___ for first-time passengers.", answer: "unnerving" },
                { text: "The vehicle is the first in the world to be ___ for carrying passengers.", answer: "certified" },
                { text: "We need to build more charging stations and ___ before these fly everywhere.", answer: "infrastructure" },
                { text: "The company is currently waiting for ___ approval from the government.", answer: "regulatory" },
                { text: "Experts predict that air taxis will eventually become ___ in major cities.", answer: "widespread" },
                { text: "Most companies are targeting the ___ market, such as tourism and firefighting.", answer: "commercial" }
            ]
        },

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // GRAMMAR SECTION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        {
            type:  "grammar",
            title: "ğŸ“– 5. Grammar: Future Possibility",

            explanation: {
                heading: "ğŸ›°ï¸ May, Could & Will",
                text: "When discussing future technology, we use different modals to show how certain we are about a prediction.",
                examples: [
                    { label: "Will (Certainty):", sentence: "Flying taxis <em>will become</em> a daily mode of transport." },
                    { label: "May/Might (Possibility):", sentence: "That reality <em>may not be</em> so far away." },
                    { label: "Could (Theoretical):", sentence: "This <em>could</em> reduce traffic in big cities." }
                ]
            },

            questions: [
                {
                    sentence: "According to the company, these taxis ___ a lifestyle to enjoy in the future.",
                    hint:     "The company is very confident about this prediction",
                    options:  ["will become", "might become", "couldn't be"],
                    answer:   "will become"
                },
                {
                    sentence: "If you are afraid of heights, flying ___ be a scary experience for you.",
                    hint:     "This is a possibility, not a certainty",
                    options:  ["will", "might", "will not"],
                    answer:   "might"
                }
            ]
        }

    ],  // â† End of sections

    // â”€â”€â”€ GRAMMAR FOR DATABASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    grammar: [
        { question: 'Future certainty with "will"', answer: "will become", explanation: "Used when we're confident about a future prediction" },
        { question: 'Future possibility with "might"', answer: "might", explanation: "Used when something is possible but not certain" }
    ],

    // â”€â”€â”€ ACHIEVEMENT BADGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    badges: [
        { icon: "ğŸš", text: "Aviation Expert!" },
        { icon: "ğŸ›°ï¸", text: "Sky Navigator!" },
        { icon: "âœˆï¸", text: "Flight Approved!" },
        { icon: "ğŸŒ¤ï¸", text: "Clear Skies!" },
        { icon: "ğŸ¯", text: "On Target!" }
    ]

};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸš« STOP HERE â€” Template code below auto-generates everything
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    </script>

    <style>
        :root {
            --color-primary:    #FF9800;
            --color-secondary:  #5D4037;
            --color-background: #FFF9C4;
            --color-correct:    #689F38;
            --color-incorrect:  #D32F2F;
            --spacing-mobile:   16px;
            --spacing-desktop:  24px;
            --touch-min:        48px;
            --bottom-nav-height: 70px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: var(--color-background);
            color: #4E342E;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: var(--bottom-nav-height);
        }
        @media (min-width: 768px) { body { padding-bottom: 0; } }

        /* HEADER */
        .header {
            background: white;
            border-bottom: 1px solid #FFE082;
            padding: 12px var(--spacing-mobile);
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
            position: sticky; top: 0; z-index: 100;
        }
        @media (min-width: 768px) { .header { padding: 20px var(--spacing-desktop); } }

        .header-content { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
        .header-left { display: flex; align-items: center; gap: 10px; }
        @media (min-width: 768px) { .header-left { gap: 15px; } }

        .logo {
            width: 36px; height: 36px;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
            border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px;
        }
        @media (min-width: 768px) { .logo { width: 42px; height: 42px; font-size: 24px; } }

        .site-title { font-size: 16px; font-weight: 800; color: var(--color-secondary); text-decoration: none; display: none; }
        @media (min-width: 480px) { .site-title { display: inline; } }
        @media (min-width: 768px) { .site-title { font-size: 20px; } }

        .streak-display { display: flex; align-items: center; gap: 8px; background: linear-gradient(135deg, #FFF7ED, #FFEDD5); padding: 6px 12px; border-radius: 50px; border: 2px solid #FED7AA; }
        @media (min-width: 768px) { .streak-display { gap: 15px; padding: 10px 20px; } }
        .streak-item { display: flex; align-items: center; gap: 4px; }
        @media (min-width: 768px) { .streak-item { gap: 8px; } }
        .streak-icon { font-size: 18px; }
        @media (min-width: 768px) { .streak-icon { font-size: 24px; } }
        .streak-number { font-size: 16px; font-weight: 900; color: var(--color-primary); }
        @media (min-width: 768px) { .streak-number { font-size: 20px; } }
        .streak-label { font-size: 10px; color: #92400E; font-weight: 700; text-transform: uppercase; display: none; }
        @media (min-width: 480px) { .streak-label { display: block; font-size: 12px; } }

        /* MAIN CONTAINER */
        .container-main {
            max-width: 1000px; margin: 20px auto;
            padding: 20px var(--spacing-mobile);
            background: white; border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.06); border: 1px solid #FFE082;
        }
        @media (min-width: 768px) { .container-main { margin: 30px auto; padding: 30px var(--spacing-desktop); } }

        .lesson-main-title { font-size: 1.8em; font-weight: 800; color: var(--color-secondary); margin-bottom: 6px; }
        @media (min-width: 768px) { .lesson-main-title { font-size: 2.5em; } }
        .lesson-subtitle { font-size: 1em; color: #888; margin-bottom: 16px; }

        /* PROGRESS BAR */
        .progress-container { background: #FFE082; height: 8px; border-radius: 99px; margin-bottom: 20px; overflow: hidden; }
        @media (min-width: 768px) { .progress-container { height: 12px; margin-bottom: 30px; } }
        .progress-bar { height: 100%; background: linear-gradient(90deg, var(--color-primary), var(--color-secondary)); width: 0%; transition: width 0.6s cubic-bezier(0.4,0,0.2,1); box-shadow: 0 0 10px rgba(255,152,0,0.5); }

        /* SECTIONS */
        .lesson-section {
            background: #FFFDE7; padding: 20px; border-radius: 10px;
            border: 1px solid #FFF59D; margin-bottom: 20px;
            opacity: 0; transform: translateY(20px); transition: opacity 0.5s, transform 0.5s;
        }
        .lesson-section.visible { opacity: 1; transform: translateY(0); }
        @media (min-width: 768px) { .lesson-section { padding: 30px; margin-bottom: 30px; } }

        .section-title { color: var(--color-secondary); font-size: 1.3em; font-weight: 800; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 2px dashed #FFCC80; }
        @media (min-width: 768px) { .section-title { font-size: 1.8em; margin-bottom: 20px; } }

        /* VIDEO */
        .video-intro { color: #78716C; margin-bottom: 14px; font-size: 1em; }
        .video-wrapper { width: 100%; margin: 0 auto 16px auto; }
        @media (min-width: 768px) { .video-wrapper { max-width: 800px; margin: 0 auto 20px auto; } }
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); background: #000; border: 3px solid var(--color-secondary); }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        .discussion-box { background: white; border: 2px solid #FFE082; border-left: 5px solid var(--color-primary); padding: 14px; border-radius: 0 8px 8px 0; margin-top: 14px; }
        @media (min-width: 768px) { .discussion-box { padding: 20px; margin-top: 20px; } }
        .discussion-box h3 { color: var(--color-secondary); font-size: 1em; font-weight: 800; margin-bottom: 10px; }
        .discussion-box li { list-style: none; padding: 8px 0 8px 28px; position: relative; color: #555; border-bottom: 1px dashed #FFE082; font-size: 0.95em; }
        .discussion-box li:last-child { border-bottom: none; }
        .discussion-box li::before { content: 'ğŸ¤”'; position: absolute; left: 0; }

        /* READING */
        .fact-box { background: linear-gradient(135deg, #1C1917, #292524); border: 2px solid var(--color-primary); border-radius: 8px; padding: 16px; margin-bottom: 16px; }
        @media (min-width: 768px) { .fact-box { padding: 20px; margin-bottom: 20px; } }
        .fact-box h4 { color: var(--color-primary); font-size: 0.95em; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
        .fact-box li { list-style: none; padding: 5px 0 5px 22px; position: relative; color: #F59E0B; border-bottom: 1px solid #44403C; font-size: 0.9em; }
        .fact-box li:last-child { border-bottom: none; }
        .fact-box li::before { content: 'âš¡'; position: absolute; left: 0; }

        .reading-text { background: white; border-left: 4px solid var(--color-primary); padding: 16px; border-radius: 0 8px 8px 0; font-size: 1.05em; color: #3E2723; line-height: 1.7; }
        @media (min-width: 768px) { .reading-text { border-left-width: 5px; padding: 20px; font-size: 1.2em; line-height: 1.8; } }
        .reading-text .mb-4 { margin-bottom: 1rem; }

        .highlight-word { color: #E65100; font-weight: 700; cursor: pointer; border-bottom: 2px dotted #FFB74D; display: inline-block; padding: 2px 4px; transition: all 0.2s; }
        .highlight-word:active { background: var(--color-primary); color: white; border-radius: 4px; border-bottom-color: transparent; }
        @media (min-width: 768px) { .highlight-word:hover { background: var(--color-primary); color: white; border-radius: 4px; border-bottom-color: transparent; } }

        /* QUESTIONS (shared by trueFalse and multipleChoice) */
        .question-box { background: white; border: 1px solid #FFE082; border-radius: 8px; padding: 14px; margin-bottom: 12px; }
        @media (min-width: 768px) { .question-box { padding: 16px; margin-bottom: 14px; } }
        .question-text { font-size: 1em; font-weight: 700; margin-bottom: 10px; color: var(--color-secondary); }

        .option-button {
            display: block; width: 100%; text-align: left;
            padding: 14px 16px; min-height: var(--touch-min); margin-top: 8px;
            background: white; border: 2px solid #FFE082; border-radius: 8px;
            font-weight: 700; cursor: pointer; transition: all 0.2s;
            color: var(--color-secondary); font-size: 1em; -webkit-appearance: none;
        }
        .option-button:active { transform: scale(0.98); }
        @media (min-width: 768px) { .option-button:hover { background: #FFF8E1; border-color: var(--color-primary); } }
        .option-button.selected   { background: #FFE082; border-color: var(--color-secondary); }
        .option-button.correct    { background: #8BC34A !important; color: white !important; border-color: #689F38 !important; }
        .option-button.incorrect  { background: #EF5350 !important; color: white !important; border-color: #D32F2F !important; }

        /* GAP FILL */
        .word-bank { background: #FFF9C4; border: 2px solid var(--color-secondary); border-radius: 10px; padding: 12px; margin-bottom: 16px; }
        @media (min-width: 768px) { .word-bank { padding: 15px; margin-bottom: 20px; } }
        .word-bank-label { font-weight: 800; color: var(--color-secondary); margin-bottom: 10px; font-size: 0.95em; }
        .word-options { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        @media (min-width: 768px) { .word-options { gap: 10px; } }

        .word-option { background: var(--color-secondary); color: white; padding: 10px 16px; min-height: var(--touch-min); display: inline-flex; align-items: center; border-radius: 6px; cursor: pointer; transition: 0.2s; font-weight: 700; font-size: 1em; -webkit-appearance: none; border: none; }
        .word-option.selected { background: var(--color-primary); transform: scale(1.05); }
        .word-option.used { opacity: 0.3; pointer-events: none; background: #A1887F; }

        .gap-sentences { font-size: 1.05em; line-height: 2.8; }
        @media (min-width: 768px) { .gap-sentences { font-size: 1.1em; } }

        .gap-input { display: inline-block; text-align: center; padding: 4px 8px; min-width: 100px; min-height: 36px; background: white; border: 3px dashed var(--color-primary); border-radius: 4px; font-weight: 800; cursor: pointer; margin: 0 4px; font-size: 1em; line-height: 28px; transition: all 0.2s; }
        @media (min-width: 768px) { .gap-input { min-width: 120px; border-width: 2px; } }
        .gap-input.correct   { background: #C5E1A5 !important; border-color: #689F38 !important; border-style: solid; pointer-events: none; }
        .gap-input.incorrect { background: #EF9A9A !important; border-color: #D32F2F !important; border-style: solid; }

        /* WORD FORMS */
        .word-form-item { margin-bottom: 16px; }
        .word-form-prompt { font-weight: 700; color: var(--color-secondary); margin-bottom: 8px; font-size: 1em; }
        .word-form-input { width: 100%; padding: 14px; min-height: var(--touch-min); border: 2px solid #D1D5DB; border-radius: 8px; transition: 0.3s; font-size: 1em; }
        .word-form-input:focus { outline: none; border-color: var(--color-primary); }
        @media (min-width: 768px) { .word-form-input { padding: 12px; } }
        .word-form-input.revealed { background: #E8F5E9 !important; font-weight: bold; color: #2E7D32; border-color: #A5D6A7; }

        /* GRAMMAR */
        .grammar-explanation { background: linear-gradient(135deg, #1C1917, #292524); color: #FEF2F2; padding: 16px; border-radius: 8px; border: 2px solid var(--color-primary); margin-bottom: 16px; }
        @media (min-width: 768px) { .grammar-explanation { padding: 22px; margin-bottom: 20px; } }
        .grammar-explanation h4 { color: var(--color-primary); font-size: 1em; font-weight: 800; margin-bottom: 10px; }
        .grammar-explanation p { color: #E5E7EB; font-size: 0.95em; margin-bottom: 10px; }
        .grammar-example { background: #292524; padding: 10px 14px; border-left: 4px solid var(--color-primary); border-radius: 0 6px 6px 0; margin: 6px 0; font-size: 0.9em; }
        .grammar-example strong { color: var(--color-primary); }
        .grammar-example span { color: #E5E7EB; }

        .grammar-card { background: white; border-left: 4px solid var(--color-primary); padding: 14px; margin-bottom: 12px; border-radius: 0 8px 8px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        @media (min-width: 768px) { .grammar-card { display: flex; justify-content: space-between; align-items: center; padding: 18px; gap: 20px; } }
        .grammar-card-text { margin-bottom: 10px; }
        @media (min-width: 768px) { .grammar-card-text { margin-bottom: 0; flex: 1; } }
        .grammar-card-sentence { font-weight: 700; color: var(--color-secondary); font-size: 1em; margin-bottom: 4px; }
        .grammar-card-hint { font-size: 0.85em; color: #9CA3AF; }

        .grammar-select { width: 100%; padding: 12px 14px; min-height: var(--touch-min); border: 2px solid #FFE082; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 1em; -webkit-appearance: none; background: white; color: var(--color-secondary); }
        @media (min-width: 768px) { .grammar-select { width: auto; min-width: 160px; } }
        .grammar-select.correct   { background: #DCFCE7; border-color: #16A34A; color: #166534; }
        .grammar-select.incorrect { background: #FEE2E2; border-color: #EF4444; color: #991B1B; }

        /* BUTTONS */
        .button-group { margin-top: 16px; display: flex; flex-direction: column; gap: 10px; }
        @media (min-width: 768px) { .button-group { flex-direction: row; justify-content: center; margin-top: 20px; } }

        .btn-continue, .btn-check, .btn-reveal, .btn-reset {
            padding: 14px 24px; min-height: var(--touch-min); border: none; border-radius: 9999px;
            cursor: pointer; font-weight: 700; transition: 0.3s; width: 100%; font-size: 1em; -webkit-appearance: none;
        }
        @media (min-width: 768px) { .btn-continue, .btn-check, .btn-reveal, .btn-reset { width: auto; padding: 12px 28px; } }

        .btn-continue, .btn-check { background: var(--color-secondary); color: white; box-shadow: 0 4px #3E2723; }
        .btn-continue:active, .btn-check:active { transform: translateY(2px); box-shadow: 0 2px #3E2723; }
        @media (min-width: 768px) { .btn-continue:hover, .btn-check:hover { background: #3E2723; } }

        .btn-reveal { background: #FFB300; color: #4E342E; box-shadow: 0 4px #F57C00; }
        .btn-reset  { background: #A1887F; color: white; box-shadow: 0 4px #8D6E63; }

        /* RESULT MESSAGES */
        .result-message { margin-top: 12px; padding: 12px; border-radius: 8px; font-weight: 700; display: none; text-align: center; font-size: 1em; }
        @media (min-width: 768px) { .result-message { margin-top: 15px; padding: 15px; } }
        .result-message.correct   { background: #DCEDC8; color: #33691E; border: 1px solid #8BC34A; }
        .result-message.incorrect { background: #FFCDD2; color: #B71C1C; border: 1px solid #E57373; }

        /* BOTTOM NAV (mobile only) */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 2px solid #FFE082; padding: 10px 16px; padding-bottom: calc(10px + env(safe-area-inset-bottom)); display: flex; align-items: center; gap: 10px; z-index: 200; box-shadow: 0 -4px 12px rgba(0,0,0,0.08); }
        @media (min-width: 768px) { .bottom-nav { display: none; } }
        .bottom-nav-btn { flex: 1; background: #F3F4F6; color: #4B5563; border: none; padding: 12px; border-radius: 8px; font-weight: 700; font-size: 14px; min-height: var(--touch-min); cursor: pointer; transition: all 0.2s; -webkit-appearance: none; }
        .bottom-nav-btn:active { transform: scale(0.95); }
        .bottom-nav-btn.primary { flex: 2; background: linear-gradient(135deg, var(--color-primary), var(--color-secondary)); color: white; font-weight: 800; }
        .bottom-nav-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .section-indicator { font-size: 11px; font-weight: 700; color: #6B7280; white-space: nowrap; }

        /* DICTIONARY POPUP */
        #dictionary-popup { position: fixed; bottom: var(--bottom-nav-height); left: 16px; right: 16px; background: white; border-top: 5px solid var(--color-primary); padding: 20px; border-radius: 16px 16px 0 0; z-index: 2000; display: none; box-shadow: 0 -10px 40px rgba(0,0,0,0.2); animation: slideUp 0.3s; max-height: 50vh; overflow-y: auto; }
        @media (min-width: 768px) { #dictionary-popup { position: fixed; bottom: auto; left: auto; right: auto; max-width: 300px; border-radius: 8px; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .popup-close { position: absolute; top: 10px; right: 10px; width: 32px; height: 32px; border-radius: 50%; background: #F3F4F6; border: none; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* BADGES */
        .badge-container { position: fixed; top: 80px; right: 10px; display: flex; flex-direction: column; gap: 8px; z-index: 999; }
        @media (min-width: 768px) { .badge-container { top: 100px; right: 20px; gap: 10px; } }
        .badge { background: white; padding: 10px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 8px; transform: translateX(300px); opacity: 0; transition: all 0.5s; border-left: 4px solid var(--color-primary); }
        @media (min-width: 768px) { .badge { padding: 15px; gap: 10px; border-radius: 12px; } }
        .badge.show { transform: translateX(0); opacity: 1; }
        .badge-icon { font-size: 24px; }
        @media (min-width: 768px) { .badge-icon { font-size: 32px; } }
        .badge-text { font-weight: 700; color: #92400E; font-size: 13px; }

        /* CELEBRATION FLASH */
        .celebration { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%) scale(0); background: linear-gradient(135deg, #16A34A, #059669); color: white; padding: 30px 40px; border-radius: 20px; font-size: 1.5em; font-weight: 900; box-shadow: 0 20px 60px rgba(0,0,0,0.3); z-index: 1000; opacity: 0; transition: all 0.4s; }
        @media (min-width: 768px) { .celebration { padding: 40px 60px; font-size: 2em; } }
        .celebration.show { opacity: 1; transform: translate(-50%,-50%) scale(1); }
    </style>
</head>
<body>

    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <a href="#" id="logo-link" style="text-decoration:none;">
                    <span class="logo" id="logo-emoji">ğŸš</span>
                </a>
                <a href="/advanced/" class="site-title">English For Cool Dudes</a>
            </div>
            <div class="streak-display">
                <div class="streak-item">
                    <span class="streak-icon">ğŸ”¥</span>
                    <div>
                        <div class="streak-number" id="streak-count">0</div>
                        <div class="streak-label">Streak</div>
                    </div>
                </div>
                <div class="streak-item">
                    <span class="streak-icon">ğŸ¯</span>
                    <div>
                        <div class="streak-number" id="total-lessons">0</div>
                        <div class="streak-label">Lessons</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="badge-container" id="badge-container"></div>
    <div class="celebration" id="celebration"></div>

    <div class="container-main">
        <h1 class="lesson-main-title" id="lesson-title">Loading...</h1>
        <p class="lesson-subtitle" id="lesson-subtitle"></p>
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div id="daily-challenge-widget"></div>
        <div id="lesson-sections"></div>
    </div>

    <nav class="bottom-nav">
        <button class="bottom-nav-btn" onclick="previousSection()" id="btn-prev" disabled>â† Back</button>
        <span class="section-indicator" id="section-indicator">1/1</span>
        <button class="bottom-nav-btn primary" onclick="nextSection()" id="btn-next">Next â†’</button>
    </nav>

    <div id="dictionary-popup">
        <button class="popup-close" onclick="closePopup()">Ã—</button>
        <div id="popup-content"></div>
    </div>

    <script src="/supabase-auth-gamified.js"></script>
    <script src="/daily-challenges-system.js"></script>
    <script src="/word-match-game.js"></script>

    <script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¨ LESSON GENERATOR â€” reads your config and builds everything automatically
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let currentSection    = 1;
let completedSections = 0;
let selectedGapWord   = null;

(function buildLesson() {
    // Apply custom colours
    if (LESSON_CONFIG.colors) {
        const r = document.documentElement;
        if (LESSON_CONFIG.colors.primary)    r.style.setProperty('--color-primary',    LESSON_CONFIG.colors.primary);
        if (LESSON_CONFIG.colors.secondary)  r.style.setProperty('--color-secondary',  LESSON_CONFIG.colors.secondary);
        if (LESSON_CONFIG.colors.background) {
            r.style.setProperty('--color-background', LESSON_CONFIG.colors.background);
            document.body.style.background = LESSON_CONFIG.colors.background;
        }
    }

    // Set page text
    document.getElementById('page-title').textContent     = LESSON_CONFIG.title + ' - English For Cool Dudes';
    document.getElementById('lesson-title').textContent   = LESSON_CONFIG.title;
    document.getElementById('lesson-subtitle').textContent = LESSON_CONFIG.level + ' | ' + LESSON_CONFIG.subtitle;
    document.getElementById('logo-emoji').textContent     = LESSON_CONFIG.logoEmoji;
    document.getElementById('logo-link').href             = LESSON_CONFIG.levelPage;

    // Build each section
    const container = document.getElementById('lesson-sections');
    let html = '';
    let num  = 0;

    LESSON_CONFIG.sections.forEach((sec, i) => {
        num++;
        const vis = i === 0 ? ' visible' : '';
        const attr = `class="lesson-section${vis}" data-section="${num}"`;

        // â”€â”€ VIDEO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if (sec.type === 'video') {
            const discussHTML = sec.discussion && sec.discussion.length
                ? `<div class="discussion-box"><h3>ğŸ’¬ Discussion Questions</h3><ul>${sec.discussion.map(q=>`<li>${q}</li>`).join('')}</ul></div>`
                : '';
            html += `<section ${attr}>
                <h2 class="section-title">${sec.title}</h2>
                ${sec.intro ? `<p class="video-intro">${sec.intro}</p>` : ''}
                <div class="video-wrapper"><div class="video-container">
                    <iframe src="${sec.youtubeUrl}" title="Video" frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div></div>
                ${discussHTML}
                <div class="button-group" style="margin-top:16px;">
                    <button class="btn-continue" onclick="completeSection(${num})">Continue â†’</button>
                </div>
            </section>`;
        }

        // â”€â”€ READING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        else if (sec.type === 'reading') {
            const content = sec.content.replace(/<vocab>(.*?)<\/vocab>/gi, (m, w) =>
                `<span class="highlight-word" onclick="showPopup(this,'${w}')">${w}</span>`);
            const factsHTML = sec.facts && sec.facts.length
                ? `<div class="fact-box"><h4>âš¡ Quick Facts</h4><ul>${sec.facts.map(f=>`<li>${f}</li>`).join('')}</ul></div>`
                : '';
            html += `<section ${attr}>
                <h2 class="section-title">${sec.title}</h2>
                ${factsHTML}
                <div class="reading-text">${content}</div>
                <div class="button-group" style="margin-top:16px;">
                    <button class="btn-continue" onclick="completeSection(${num})">Continue â†’</button>
                </div>
            </section>`;
        }

        // â”€â”€ TRUE / FALSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        else if (sec.type === 'trueFalse') {
            const qHTML = sec.questions.map((q, qi) => `
                <div class="question-box">
                    <p class="question-text">${qi+1}. ${q.question}</p>
                    <div class="comp-btn-group">
                        <button class="option-button" data-correct="${q.answer === true}">True</button>
                        <button class="option-button" data-correct="${q.answer === false}">False</button>
                    </div>
                </div>`).join('');
            html += `<section ${attr}>
                <h2 class="section-title">${sec.title}</h2>
                ${qHTML}
                <div class="button-group">
                    <button class="btn-check" onclick="checkTrueFalse(${num})">Check Answers</button>
                    <button class="btn-reset" onclick="resetTrueFalse(${num})">Reset</button>
                </div>
                <div id="result-${num}" class="result-message"></div>
            </section>`;
        }

        // â”€â”€ MULTIPLE CHOICE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        else if (sec.type === 'multipleChoice') {
            const qHTML = sec.questions.map((q, qi) => {
                const opts = q.options.map((o, oi) =>
                    `<button class="option-button" data-correct="${oi === q.correct}">${o}</button>`).join('');
                return `<div class="question-box">
                    <p class="question-text">${qi+1}. ${q.question}</p>
                    <div class="comp-btn-group">${opts}</div>
                </div>`;
            }).join('');
            html += `<section ${attr}>
                <h2 class="section-title">${sec.title}</h2>
                ${qHTML}
                <div class="button-group">
                    <button class="btn-check" onclick="checkMultiChoice(${num})">Check Answers</button>
                    <button class="btn-reset" onclick="resetMultiChoice(${num})">Reset</button>
                </div>
                <div id="result-${num}" class="result-message"></div>
            </section>`;
        }

        // â”€â”€ GAP FILL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        else if (sec.type === 'gapFill') {
            const bankHTML = sec.wordBank.map(w =>
                `<button class="word-option" data-word="${w}">${w}</button>`).join('');
            const sentHTML = sec.sentences.map((s, si) => {
                const parts = s.text.split('___');
                return `<p class="mb-4">${si+1}. ${parts[0]}<span class="gap-input" data-answer="${s.answer}"></span>${parts[1]||''}</p>`;
            }).join('');
            html += `<section ${attr}>
                <h2 class="section-title">${sec.title}</h2>
                <p style="color:#888;margin-bottom:12px;">Click a word from the box, then click a gap to fill it.</p>
                <div class="word-bank">
                    <p class="word-bank-label">ğŸ“¦ Word Bank:</p>
                    <div class="word-options">${bankHTML}</div>
                </div>
                <div class="gap-sentences">${sentHTML}</div>
                <div class="button-group">
                    <button class="btn-check" onclick="checkGapFill(${num})">Check Answers</button>
                    <button class="btn-reset" onclick="resetGapFill(${num})">Reset</button>
                </div>
                <div id="result-${num}" class="result-message"></div>
            </section>`;
        }

        // â”€â”€ WORD FORMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        else if (sec.type === 'wordForms') {
            const items = sec.questions.map((q, qi) => `
                <div class="word-form-item">
                    <p class="word-form-prompt">${qi+1}. ${q.prompt}</p>
                    <input type="text" class="word-form-input" data-answer="${q.answer}" placeholder="Type your answer here...">
                </div>`).join('');
            html += `<section ${attr}>
                <h2 class="section-title">${sec.title}</h2>
                ${items}
                <div class="button-group">
                    <button class="btn-check"  onclick="checkWordForms(${num})">Check Answers</button>
                    <button class="btn-reveal" onclick="revealWordForms(${num})">Reveal Answers</button>
                    <button class="btn-reset"  onclick="resetWordForms(${num})">Reset</button>
                </div>
                <div id="result-${num}" class="result-message"></div>
            </section>`;
        }

        // â”€â”€ GRAMMAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        else if (sec.type === 'grammar') {
            let explHTML = '';
            if (sec.explanation) {
                const ex = sec.explanation;
                const examplesHTML = (ex.examples||[]).map(e =>
                    `<div class="grammar-example"><strong>${e.label}</strong> <span>${e.sentence}</span></div>`).join('');
                explHTML = `<div class="grammar-explanation">
                    <h4>${ex.heading}</h4><p>${ex.text}</p>${examplesHTML}
                </div>`;
            }
            const cards = sec.questions.map((q, qi) => {
                const opts = q.options.map(o => `<option value="${o}">${o}</option>`).join('');
                return `<div class="grammar-card">
                    <div class="grammar-card-text">
                        <p class="grammar-card-sentence">${qi+1}. ${q.sentence}</p>
                        <p class="grammar-card-hint">${q.hint}</p>
                    </div>
                    <select class="grammar-select" data-answer="${q.answer}">
                        <option value="">Choose...</option>${opts}
                    </select>
                </div>`;
            }).join('');
            html += `<section ${attr}>
                <h2 class="section-title">${sec.title}</h2>
                ${explHTML}
                ${cards}
                <div class="button-group">
                    <button class="btn-check" onclick="checkGrammar(${num})">Check Grammar</button>
                    <button class="btn-reset" onclick="resetGrammar(${num})">Reset</button>
                </div>
                <div id="result-${num}" class="result-message"></div>
            </section>`;
        }

    });

    container.innerHTML = html;
    window.totalSections = LESSON_CONFIG.sections.length;
    updateNav();
    updateProgress();
    setTimeout(wireEvents, 50);

})(); // end buildLesson()


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ® ALL INTERACTIVE FUNCTIONALITY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ USER STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function initStats() {
    if (typeof window.efcdReady !== 'undefined') await window.efcdReady;
    if (typeof window.EFCD_Auth === 'undefined') return;
    await window.EFCD_Auth.initAuth();
    const user = window.EFCD_Auth.getCurrentUser();
    if (user) {
        const s = window.EFCD_Auth.getUserStats();
        document.getElementById('streak-count').textContent  = s.streak;
        document.getElementById('total-lessons').textContent = s.lessonsCompleted;
    }
}
if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initStats);
else initStats();

if (window.DailyChallenges) {
    document.getElementById('daily-challenge-widget').innerHTML =
        window.DailyChallenges.renderDailyChallengeWidget();
}

// â”€â”€ NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function nextSection() {
    if (currentSection < window.totalSections) {
        currentSection++;
        showSection(currentSection);
    } else {
        completeLessonAndSave();
    }
}

function previousSection() {
    if (currentSection > 1) { currentSection--; showSection(currentSection); }
}

function showSection(num) {
    const sec = document.querySelector(`.lesson-section[data-section="${num}"]`);
    if (sec) { sec.classList.add('visible'); sec.scrollIntoView({ behavior:'smooth', block:'start' }); }
    updateNav();
}

function updateNav() {
    document.getElementById('btn-prev').disabled = (currentSection === 1);
    document.getElementById('btn-next').textContent = currentSection === window.totalSections ? 'Finish âœ“' : 'Next â†’';
    document.getElementById('section-indicator').textContent = currentSection + '/' + window.totalSections;
}

function updateProgress() {
    const pct = ((completedSections) / (window.totalSections || 1)) * 100;
    document.getElementById('progress-bar').style.width = pct + '%';
}

// Called whenever a section is completed
function completeSection(sectionNum) {
    completedSections = Math.max(completedSections, sectionNum);
    updateProgress();

    // If this was the last section, trigger lesson save
    if (sectionNum >= window.totalSections) {
        completeLessonAndSave();
        return;
    }

    // Reveal next section and scroll to it
    const next = document.querySelector(`.lesson-section[data-section="${sectionNum + 1}"]`);
    if (next) { next.classList.add('visible'); next.scrollIntoView({ behavior:'smooth', block:'center' }); }
    if (Math.random() < 0.3) showBadge(getRandomBadge());
    currentSection = sectionNum + 1;
    updateNav();
}

// â”€â”€ HELPER: show result message + optional auto-advance â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showResult(num, correct, total, goodMsg, badMsg) {
    const el = document.getElementById('result-' + num);
    if (!el) return;
    const perfect = correct === total;
    el.style.display = 'block';
    el.className = 'result-message ' + (perfect ? 'correct' : 'incorrect');
    el.textContent = perfect ? goodMsg : correct + '/' + total + ' correct. ' + badMsg;
    if (perfect) {
        celebrate('ğŸ‰ Perfect!');
        showBadge(getRandomBadge());
        setTimeout(() => completeSection(num), 1600);
    }
}

function hideResult(num) {
    const el = document.getElementById('result-' + num);
    if (el) { el.style.display = 'none'; el.className = 'result-message'; }
}

// â”€â”€ TRUE / FALSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkTrueFalse(num) {
    const sec = document.querySelector(`.lesson-section[data-section="${num}"]`);
    const groups = sec.querySelectorAll('.comp-btn-group');
    let correct = 0;
    let unanswered = 0;
    groups.forEach(g => {
        const sel = g.querySelector('.option-button.selected');
        if (!sel) { unanswered++; return; }
        g.querySelectorAll('.option-button').forEach(b => b.classList.remove('correct','incorrect'));
        if (sel.dataset.correct === 'true') { sel.classList.add('correct'); correct++; }
        else { sel.classList.add('incorrect'); }
    });
    if (unanswered > 0) {
        const res = document.getElementById('result-' + num);
        res.style.display = 'block';
        res.className = 'result-message incorrect';
        res.textContent = 'Please answer all questions before checking!';
        return;
    }
    showResult(num, correct, groups.length, 'ğŸ‰ All correct!', 'Wrong answers are in red â€” try again!');
}

function resetTrueFalse(num) {
    const sec = document.querySelector(`.lesson-section[data-section="${num}"]`);
    sec.querySelectorAll('.option-button').forEach(b => b.classList.remove('selected','correct','incorrect'));
    hideResult(num);
}

// â”€â”€ MULTIPLE CHOICE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkMultiChoice(num) {
    const sec = document.querySelector(`.lesson-section[data-section="${num}"]`);
    const groups = sec.querySelectorAll('.comp-btn-group');
    let correct = 0;
    let unanswered = 0;
    groups.forEach(g => {
        const sel = g.querySelector('.option-button.selected');
        if (!sel) { unanswered++; return; }
        g.querySelectorAll('.option-button').forEach(b => b.classList.remove('correct','incorrect'));
        if (sel.dataset.correct === 'true') { sel.classList.add('correct'); correct++; }
        else { sel.classList.add('incorrect'); }
    });
    if (unanswered > 0) {
        const res = document.getElementById('result-' + num);
        res.style.display = 'block';
        res.className = 'result-message incorrect';
        res.textContent = 'Please answer all questions before checking!';
        return;
    }
    showResult(num, correct, groups.length, 'ğŸ’¯ Perfect!', 'Wrong answers are in red â€” try again!');
}

function resetMultiChoice(num) {
    const sec = document.querySelector(`.lesson-section[data-section="${num}"]`);
    sec.querySelectorAll('.option-button').forEach(b => b.classList.remove('selected','correct','incorrect'));
    hideResult(num);
}

// â”€â”€ GAP FILL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleGapClick(blank) {
    if (blank.classList.contains('correct')) return;
    if (blank.textContent.trim()) {
        const sec = blank.closest('.lesson-section');
        const opt = Array.from(sec.querySelectorAll('.word-option')).find(o => o.dataset.word === blank.textContent.trim());
        if (opt) opt.classList.remove('used');
        blank.textContent = '';
        blank.classList.remove('incorrect');
    } else if (selectedGapWord) {
        blank.textContent = selectedGapWord.dataset.word;
        selectedGapWord.classList.add('used');
        selectedGapWord.classList.remove('selected');
        selectedGapWord = null;
    }
}

function checkGapFill(num) {
    const sec = document.querySelector(`.lesson-section[data-section="${num}"]`);
    const blanks = sec.querySelectorAll('.gap-input');
    let correct = 0;
    blanks.forEach(b => {
        b.classList.remove('correct','incorrect');
        if ((b.textContent||'').trim().toLowerCase() === b.dataset.answer.toLowerCase()) {
            b.classList.add('correct'); correct++;
        } else if (b.textContent.trim()) {
            b.classList.add('incorrect');
        }
    });
    showResult(num, correct, blanks.length, 'âœ¨ All gaps correct!', 'Click a red gap to remove it and try again.');
}

function resetGapFill(num) {
    const sec = document.querySelector(`.lesson-section[data-section="${num}"]`);
    sec.querySelectorAll('.gap-input').forEach(b => { b.textContent=''; b.classList.remove('correct','incorrect'); });
    sec.querySelectorAll('.word-option').forEach(o => o.classList.remove('used','selected'));
    selectedGapWord = null;
    hideResult(num);
}

// â”€â”€ WORD FORMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkWordForms(num) {
    const sec = document.querySelector(`.lesson-section[data-section="${num}"]`);
    const inputs = sec.querySelectorAll('.word-form-input');
    let correct = 0;
    inputs.forEach(inp => {
        inp.style.background = ''; inp.style.borderColor = '';
        if (inp.value.trim().toLowerCase() === inp.dataset.answer.toLowerCase()) {
            inp.style.background = '#DCEDC8'; inp.style.borderColor = '#689F38'; correct++;
        } else if (inp.value.trim()) {
            inp.style.background = '#FFCDD2'; inp.style.borderColor = '#D32F2F';
        }
    });
    showResult(num, correct, inputs.length, 'ğŸ¯ Word Forms Champion!', 'Red boxes are wrong â€” check your spelling!');
}

function revealWordForms(num) {
    const sec = document.querySelector(`.lesson-section[data-section="${num}"]`);
    sec.querySelectorAll('.word-form-input').forEach(inp => {
        inp.value = inp.dataset.answer; inp.classList.add('revealed');
        inp.style.background=''; inp.style.borderColor='';
    });
    hideResult(num);
}

function resetWordForms(num) {
    const sec = document.querySelector(`.lesson-section[data-section="${num}"]`);
    sec.querySelectorAll('.word-form-input').forEach(inp => {
        inp.value=''; inp.style.background='white'; inp.style.borderColor=''; inp.classList.remove('revealed');
    });
    hideResult(num);
}

// â”€â”€ GRAMMAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkGrammar(num) {
    const sec = document.querySelector(`.lesson-section[data-section="${num}"]`);
    const selects = sec.querySelectorAll('.grammar-select');
    let correct = 0;
    selects.forEach(sel => {
        sel.classList.remove('correct','incorrect');
        if (!sel.value) return;
        if (sel.value === sel.dataset.answer) { sel.classList.add('correct'); correct++; }
        else sel.classList.add('incorrect');
    });
    showResult(num, correct, selects.length, 'ğŸ“– Grammar Ace!', 'Red dropdowns are wrong â€” try again!');
}

function resetGrammar(num) {
    const sec = document.querySelector(`.lesson-section[data-section="${num}"]`);
    sec.querySelectorAll('.grammar-select').forEach(sel => { sel.value=''; sel.classList.remove('correct','incorrect'); });
    hideResult(num);
}

// â”€â”€ CELEBRATIONS & BADGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function celebrate(msg) {
    const el = document.getElementById('celebration');
    el.textContent = msg || 'ğŸ‰ Excellent!';
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 2000);
}

function getRandomBadge() {
    const list = (LESSON_CONFIG.badges && LESSON_CONFIG.badges.length) ? LESSON_CONFIG.badges : [{icon:'â­',text:'Great!'}];
    return list[Math.floor(Math.random() * list.length)];
}

function showBadge(badge) {
    const el = document.createElement('div');
    el.className = 'badge';
    el.innerHTML = `<span class="badge-icon">${badge.icon}</span><span class="badge-text">${badge.text}</span>`;
    document.getElementById('badge-container').appendChild(el);
    setTimeout(() => el.classList.add('show'), 100);
    setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 500); }, 3000);
}

// â”€â”€ VOCABULARY POPUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPopup(target, word) {
    const w = LESSON_CONFIG.vocabulary.find(v => v.word.toLowerCase() === word.toLowerCase());
    if (!w) return;
    const popup   = document.getElementById('dictionary-popup');
    const content = document.getElementById('popup-content');
    content.innerHTML = `
        <div style="margin-bottom:10px;">
            <strong style="color:var(--color-primary);font-size:1.3em;">${w.word}</strong>
            <span style="font-size:0.85em;color:#888;margin-left:6px;">(${w.type||''})</span>
        </div>
        <p style="color:#5D4037;line-height:1.6;margin-bottom:14px;">${w.definition}</p>
        <button onclick="playAudio('${w.word}')"
            style="width:100%;background:var(--color-primary);color:white;border:none;padding:14px;border-radius:8px;font-weight:700;font-size:1em;cursor:pointer;">
            ğŸ”Š Hear it
        </button>`;
    popup.style.display = 'block';
    if (window.innerWidth >= 768) {
        const rect = target.getBoundingClientRect();
        popup.style.top  = (rect.bottom + 8) + 'px';
        popup.style.left = rect.left + 'px';
        setTimeout(() => {
            const pr = popup.getBoundingClientRect();
            if (pr.right > window.innerWidth - 10) popup.style.left = (window.innerWidth - pr.width - 10) + 'px';
        }, 10);
    }
}

function closePopup() { document.getElementById('dictionary-popup').style.display = 'none'; }

function playAudio(word) {
    const u = new SpeechSynthesisUtterance(word);
    u.lang = 'en-GB'; u.rate = 0.9;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
}

// â”€â”€ WIRE UP ALL EVENT LISTENERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function wireEvents() {
    document.querySelectorAll('.comp-btn-group').forEach(group => {
        group.addEventListener('click', e => {
            const btn = e.target.closest('.option-button');
            if (!btn) return;
            if (group.querySelector('.option-button.correct')) return;
            group.querySelectorAll('.option-button').forEach(b => b.classList.remove('selected','incorrect'));
            btn.classList.add('selected');
        });
    });

    document.querySelectorAll('.word-option').forEach(opt => {
        opt.addEventListener('click', () => {
            if (opt.classList.contains('used')) return;
            if (opt.classList.contains('selected')) {
                opt.classList.remove('selected'); selectedGapWord = null;
            } else {
                document.querySelectorAll('.word-option').forEach(o => o.classList.remove('selected'));
                opt.classList.add('selected'); selectedGapWord = opt;
            }
        });
    });

    document.querySelectorAll('.gap-input').forEach(b => b.addEventListener('click', () => handleGapClick(b)));

    document.addEventListener('click', e => {
        if (!e.target.closest('#dictionary-popup') && !e.target.classList.contains('highlight-word')) closePopup();
    });
}

// â”€â”€ LESSON COMPLETION & SAVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function completeLessonAndSave() {
    completedSections = window.totalSections;
    updateProgress();

    if (typeof window.EFCD_Auth === 'undefined' || !window.EFCD_Auth.getCurrentUser()) {
        const signup = confirm(
            'ğŸ“ You completed the lesson!\n\n' +
            'âœ¨ Sign up free to:\nâ€¢ Save your progress & earn XP\nâ€¢ Unlock achievements\nâ€¢ Track your streak\n\n' +
            'Click OK to sign up | Click Cancel to continue without saving'
        );
        if (signup) { window.location.href = '/signup/'; }
        else if (typeof showWordMatchGame === 'function') {
            showWordMatchGame(LESSON_CONFIG.vocabulary, () => { window.location.href = LESSON_CONFIG.levelPage; });
        } else { window.location.href = LESSON_CONFIG.levelPage; }
        return;
    }

    const result = await window.EFCD_Auth.completeLesson({
        lessonId:       LESSON_CONFIG.lessonId,
        lessonTitle:    LESSON_CONFIG.title,
        lessonLevel:    LESSON_CONFIG.level,
        lessonLink:     LESSON_CONFIG.lessonLink,
        vocabulary:     LESSON_CONFIG.vocabulary,
        grammar:        LESSON_CONFIG.grammar || [],
        perfectScore:   true,
        completionTime: Math.floor((Date.now() - performance.timing.navigationStart) / 1000)
    });

    if (window.DailyChallenges && result.success) {
        const cr = await window.DailyChallenges.updateChallengeProgress({
            perfectScore: true, vocabCount: LESSON_CONFIG.vocabulary.length,
            completionTime: Math.floor((Date.now() - performance.timing.navigationStart) / 1000), grammarPerfect: true
        });
        if (cr.justCompleted) {
            window.DailyChallenges.showChallengeCompletionCelebration(cr.challenge);
            setTimeout(() => {
                if (typeof showWordMatchGame === 'function')
                    showWordMatchGame(LESSON_CONFIG.vocabulary, gr => showCelebrationScreen(result, gr));
            }, 2500);
            return;
        }
    }

    if (result.success) {
        if (typeof showWordMatchGame === 'function')
            showWordMatchGame(LESSON_CONFIG.vocabulary, gr => showCelebrationScreen(result, gr));
        else showCelebrationScreen(result, null);
    }
}

function showCelebrationScreen(result, gameResult) {
    const totalXP = result.xpEarned + ((gameResult && gameResult.bonusXP) || 0);
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;animation:fadeIn 0.3s;';
    let h = `<div style="background:white;padding:40px 30px;border-radius:20px;text-align:center;max-width:500px;width:100%;animation:scaleIn 0.4s;position:relative;">
        <button id="close-cel" style="position:absolute;top:15px;right:15px;background:#F3F4F6;border:none;border-radius:50%;width:36px;height:36px;cursor:pointer;font-size:20px;">Ã—</button>
        <div style="font-size:80px;margin-bottom:20px;">ğŸ‰</div>
        <h2 style="font-size:28px;margin-bottom:20px;color:#1A202C;font-weight:900;">Lesson Complete!</h2>
        <div style="background:linear-gradient(135deg,#FFF7ED,#FFEDD5);padding:25px;border-radius:16px;margin-bottom:25px;border:2px solid #FED7AA;">
            <div style="font-size:48px;font-weight:900;color:var(--color-primary);">+${totalXP} XP</div>
            ${gameResult && gameResult.bonusXP ? `<div style="font-size:13px;color:#92400E;margin-top:6px;font-weight:700;">ğŸ® Includes +${gameResult.bonusXP} XP game bonus!</div>` : ''}
            ${result.leveledUp ? `<div style="font-size:22px;color:#D97706;margin-top:12px;">ğŸŠ Level Up! Now Level ${result.newLevel}!</div>` : ''}
            ${result.newStreak > 0 ? `<div style="font-size:18px;margin-top:12px;color:#DC2626;">ğŸ”¥ ${result.newStreak} day streak!</div>` : ''}
        </div>`;
    if (result.newAchievements && result.newAchievements.length) {
        h += `<div style="background:linear-gradient(135deg,#DBEAFE,#BFDBFE);padding:18px;border-radius:12px;margin-bottom:25px;">
            <div style="font-weight:800;font-size:16px;margin-bottom:12px;">ğŸ† New Achievements!</div>
            ${result.newAchievements.map(id => { const a=window.EFCD_Auth.ACHIEVEMENTS[id]; return `<div style="background:white;padding:12px;border-radius:8px;margin:8px 0;"><span style="font-size:28px;">${a.icon}</span> ${a.name}</div>`; }).join('')}
        </div>`;
    }
    h += `<div style="display:flex;flex-direction:column;gap:10px;">
        <a href="/dashboard-gamified/" style="background:linear-gradient(135deg,#667EEA,#764BA2);color:white;padding:14px;border-radius:8px;text-decoration:none;font-weight:700;">View Dashboard</a>
        <a href="${LESSON_CONFIG.levelPage}" style="background:var(--color-primary);color:white;padding:14px;border-radius:8px;text-decoration:none;font-weight:700;">Next Lesson â†’</a>
        <button id="btn-retry" style="background:#F1F5F9;color:#475569;padding:14px;border-radius:8px;border:none;font-weight:700;cursor:pointer;">Try Again</button>
    </div></div>`;
    overlay.innerHTML = h;
    document.body.appendChild(overlay);
    setTimeout(() => {
        document.getElementById('close-cel')?.addEventListener('click', () => overlay.remove());
        document.getElementById('btn-retry')?.addEventListener('click', () => location.reload());
        document.addEventListener('keydown', function esc(e) { if(e.key==='Escape'){overlay.remove();document.removeEventListener('keydown',esc);} });
    }, 100);
}

const s = document.createElement('style');
s.textContent = '@keyframes fadeIn{from{opacity:0}to{opacity:1}}@keyframes scaleIn{from{transform:scale(0.8);opacity:0}to{transform:scale(1);opacity:1}}';
document.head.appendChild(s);
    </script>
</body>
</html>
