<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <link rel="icon" type="image/png" href="/favicon.png">
    <title>AI on Patrol: When Algorithms Lie - English For Cool Dudes</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- BRANDING & LAYOUT STYLES --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: #F8FAFC; /* Slate 50 - Cool Professional Background */
            color: #1E293B; /* Slate 800 */
            line-height: 1.6;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
        }

        /* --- THEME: POLICE & AI SECURITY (Intermediate) üëÆ‚Äç‚ôÇÔ∏èü§ñ --- */
        :root {
            --color-primary: #1E40AF; /* Police Blue (Blue 800) */
            --color-secondary: #DC2626; /* Error Red (Red 600) */
            --color-accent: #FACC15; /* Caution Yellow */
            --color-white: #FFFFFF;
            
            /* Feedback Colors */
            --color-correct: #15803D; /* Green 700 */
            --color-incorrect: #B91C1C; /* Red 700 */
            
            --color-save-btn: #1E40AF; 
        }

        /* Header */
        .header {
            background: var(--color-white);
            border-bottom: 4px solid var(--color-primary);
            padding: 20px 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: sticky; top: 0; z-index: 100;
        }
        .header-content {
            max-width: 1200px; margin: 0 auto; padding: 0 20px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .header-left { display: flex; align-items: center; gap: 15px; }

        .logo {
            width: 38px; height: 38px;
            background: linear-gradient(135deg, #1E40AF 0%, #172554 100%); 
            border-radius: 6px; display: flex; align-items: center; justify-content: center;
            font-size: 20px; color: white; border: 2px solid #FACC15;
        }
        .site-title { font-size: 20px; font-weight: 800; color: #0F172A; text-decoration: none; letter-spacing: -0.02em; }

        /* Buttons */
        .header-buttons { display: flex; align-items: center; gap: 8px; }
        .header-button {
            text-decoration: none; padding: 7px 14px; border-radius: 6px;
            font-size: 14px; font-weight: 700; transition: all 0.2s;
            white-space: nowrap; cursor: pointer; border: 1px solid #E2E8F0;
            background: transparent;
        }
        .header-button.login { background: #F1F5F9; color: var(--color-primary); }
        .header-button.login:hover { background: #FFFFFF; color: var(--color-secondary); border-color: var(--color-secondary); }
        
        .header-button.signup { background: var(--color-secondary); color: white; border-color: var(--color-secondary); }
        .header-button.signup:hover { background: #991B1B; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.2); }
        
        .header-button.dashboard { background: #EFF6FF; color: #1D4ED8; border-color: #BFDBFE; }
        .header-button.logout { background: #FEF2F2; color: #DC2626; border-color: #FECACA; }
        
        .user-greeting { font-size: 14px; color: #1E40AF; font-weight: 700; margin-right: 5px; display: block; }

        /* Container */
        .container-main {
            max-width: 900px; margin: 30px auto; padding: 30px 20px;
            background-color: var(--color-white); border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05); border: 1px solid #E2E8F0;
        }

        .lesson-main-title {
            font-size: 2.2em; font-weight: 900; color: #1E293B;
            margin-bottom: 10px; letter-spacing: -0.03em;
            background: -webkit-linear-gradient(45deg, #1E40AF, #DC2626);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .lesson-section {
            background-color: #F8FAFC; padding: 30px; border-radius: 12px;
            border: 1px solid #E2E8F0; margin-bottom: 30px;
        }

        .section-title {
            color: var(--color-primary); font-size: 1.6em; font-weight: 800;
            margin-bottom: 20px; padding-bottom: 5px; border-bottom: 2px dashed var(--color-secondary);
        }

        /* --- ARTICLE STYLE (No Video) --- */
        .news-article-box {
            background: white;
            border: 1px solid #CBD5E1;
            border-top: 5px solid var(--color-secondary);
            border-radius: 8px;
            padding: 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }
        .news-header {
            background: #F1F5F9; padding: 15px 25px; border-bottom: 1px solid #E2E8F0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .news-tag {
            background: var(--color-secondary); color: white; padding: 4px 10px; 
            font-size: 0.75em; font-weight: 800; text-transform: uppercase; border-radius: 4px;
        }
        .reading-content {
            padding: 30px; font-size: 1.15em; color: #334155; line-height: 1.8;
        }
        
        .highlight-word {
            color: var(--color-secondary); font-weight: 700; cursor: help;
            border-bottom: 2px dotted var(--color-secondary); transition: all 0.2s;
            background-color: #FEF2F2; padding: 0 4px; border-radius: 4px;
        }
        .highlight-word:hover { background-color: var(--color-secondary); color: white; border-bottom: none; }
        
        /* Match Cards */
        .match-card {
            border: 2px solid transparent; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer; user-select: none; border-radius: 8px; 
            padding: 1rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); font-weight: 600;
            opacity: 1; transform: scale(1); min-height: 80px; display: flex; align-items: center; justify-content: center;
        }
        .match-card.term {
            background-color: #EFF6FF; border: 2px solid var(--color-primary); 
            text-align: center; color: var(--color-primary);
        }
        .match-card.definition {
            background-color: #FFFFFF; text-align: left; border: 2px solid #E2E8F0; color: #475569; font-size: 0.9em;
        }
        .match-card.selected {
            border-color: var(--color-accent); background-color: #FEF9C3; 
            box-shadow: 0 0 0 4px #FEF08A; transform: scale(1.02); color: #854D0E;
        }
        .match-card.matched { 
            pointer-events: none; opacity: 0; transform: scale(0.9); transition: all 0.5s;
        }
        .match-card.temp-matched {
            background-color: #DCFCE7 !important; border-color: #16A34A !important; 
            box-shadow: 0 0 0 4px #86EFAC !important; color: #166534 !important;
        }

        /* Quiz Buttons */
        .comp-btn-group .option-button {
            transition: all 0.2s; background-color: #FFFFFF; color: #334155;
            font-weight: 600; padding: 16px 20px; border-radius: 8px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); border: 1px solid #CBD5E1;
            text-align: left; width: 100%; cursor: pointer; margin-bottom: 12px;
        }
        .comp-btn-group .option-button:hover { border-color: var(--color-primary); background-color: #EFF6FF; }
        .comp-btn-group .option-button.selected { background-color: #DBEAFE; color: #1E40AF !important; border-color: #3B82F6; box-shadow: 0 0 0 3px #BFDBFE; }
        .comp-btn-group .option-button.correct { background-color: #DCFCE7 !important; color: #166534 !important; border-color: #15803D !important; }
        .comp-btn-group .option-button.incorrect { background-color: #FEE2E2 !important; color: #991B1B !important; border-color: #DC2626 !important; }

        .result-message { margin-top: 15px; padding: 15px; border-radius: 8px; font-weight: 700; display: none; text-align: center; }
        .result-message.correct { background-color: #DCFCE7; color: #166534; border: 1px solid #86EFAC; }
        .result-message.incorrect { background-color: #FEE2E2; color: #991B1B; border: 1px solid #FCA5A5; }
        
        /* Gap-Fill */
        .word-bank { background: #1E293B; border: 2px solid #0F172A; border-radius: 12px; }
        .word-options { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .word-option {
            background-color: #FFFFFF; color: #1E293B; padding: 8px 16px;
            border-radius: 6px; cursor: pointer; transition: all 0.2s; font-weight: 700;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); border: 1px solid #94A3B8; font-size: 0.9em;
        }
        .word-option:hover { background-color: var(--color-accent); color: #000; transform: translateY(-2px); }
        .word-option.selected { background-color: var(--color-secondary) !important; color: white !important; transform: scale(1.05); border-color: var(--color-secondary) !important; }
        .word-option.used { opacity: 0.3; pointer-events: none; background-color: #64748B; color: #F1F5F9; transform: none; box-shadow: none; border-color: transparent; }

        .gap-input {
            display: inline-block; text-align: center; padding: 0 8px; min-width: 100px; 
            height: 30px; line-height: 28px; background-color: #FFFFFF; border-bottom: 3px solid var(--color-primary); 
            border-radius: 4px; color: var(--color-primary); font-weight: 700; cursor: pointer; margin: 0 4px; transition: all 0.2s;
        }
        .gap-input:empty { background-color: #F1F5F9; border-bottom-style: dashed; }
        .gap-input.filled { background-color: #DBEAFE; border-bottom-style: solid; }
        .gap-input.correct { background-color: #DCFCE7 !important; border-color: #15803D !important; color: #166534 !important; pointer-events: none; }
        .gap-input.incorrect { background-color: #FEE2E2 !important; border-color: #DC2626 !important; color: #991B1B !important; }

        /* Grammar Box */
        .grammar-box {
            background: #EFF6FF;
            border-left: 6px solid var(--color-primary);
            border-radius: 6px;
            padding: 25px;
            margin: 25px 0;
        }
        .grammar-title {
            color: #1E40AF; font-size: 1.4em; font-weight: 800;
            margin-bottom: 15px; display: flex; align-items: center; gap: 10px;
        }
        .grammar-example {
            background: white; padding: 15px; border: 1px solid #BFDBFE;
            margin: 10px 0; border-radius: 6px; font-size: 0.95em;
        }
        .grammar-highlight { color: var(--color-secondary); font-weight: 800; }
        .arrow-right { color: #94A3B8; margin: 0 10px; }

        /* Buttons & Save */
        .button-group { margin-top: 25px; display: flex; gap: 15px; justify-content: center; }
        .check-button {
            background: var(--color-primary); color: white; border: none; padding: 12px 28px;
            border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 700;
            transition: all 0.3s; box-shadow: 0 4px 6px -1px rgba(30, 64, 175, 0.3);
        }
        .check-button:hover { background: #1E3A8A; transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(30, 64, 175, 0.4); }
        .reset-button { background: #64748B; box-shadow: none; }
        .reset-button:hover { background: #475569; }

        #save-words-section { background: #F8FAFC; border: 2px dashed #94A3B8; padding: 30px; border-radius: 16px; margin-top: 50px; text-align: center; }
        #save-words-btn {
            background-color: var(--color-secondary); color: white; padding: 16px 30px;
            border-radius: 8px; font-weight: 700; cursor: pointer; transition: background-color 0.2s;
            display: block; width: 100%; border: none; box-shadow: 0 4px #991B1B;
            text-transform: uppercase; font-size: 1.1em; letter-spacing: 0.05em;
        }
        #save-words-btn:hover:not(:disabled) { background-color: #B91C1C; }
        #save-words-btn:active:not(:disabled) { box-shadow: 0 1px #991B1B; transform: translateY(3px); }
        #save-words-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        #learned-words-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; margin-bottom: 25px; text-align: center; list-style: none; }
        #learned-words-list li {
            background: white; padding: 10px; border-radius: 6px; border: 1px solid #CBD5E1;
            font-size: 0.9em; cursor: pointer; transition: all 0.2s; font-weight: 700; color: #334155;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px;
        }
        #learned-words-list li:hover { transform: translateY(-3px); border-color: var(--color-secondary); color: var(--color-secondary); box-shadow: 0 5px 10px rgba(0,0,0,0.1); }
        #learned-words-list li::after { content: 'üîä'; font-size: 1.1em; opacity: 0.5; margin-top: 2px;}
        #learned-words-list li:hover::after { opacity: 1; }

        /* Popups */
        #feedback-popup {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            padding: 30px 50px; border-radius: 12px; font-weight: 800; color: white;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3); z-index: 2000; display: none;
            text-align: center; font-size: 1.5em; border: 4px solid white; min-width: 300px;
        }
        #dictionary-popup {
            position: fixed; max-width: 280px; padding: 15px; background: #FFFFFF;
            border-top: 5px solid var(--color-primary); border-radius: 8px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.15); 
            z-index: 2001; display: none; font-size: 0.95em; color: #1F2937; line-height: 1.5;
        }
        @media (max-width: 768px) { .user-greeting { display: none; } }
        
        .footer {
            background: #F1F5F9;
            border-top: 1px solid #E2E8F0;
            padding: 40px 20px;
            margin-top: 80px;
            text-align: center;
        }
        .footer-text { font-size: 14px; color: #64748B; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <span class="logo">üö®</span>
                <a href="/intermediate/" class="site-title">English For Cool Dudes</a>
            </div>
            <div id="logged-out-buttons" class="header-buttons" style="display: none;">
                <a href="/login/" class="header-button login">Login</a>
                <a href="/signup/" class="header-button signup">Sign Up</a>
            </div>
            <div id="logged-in-buttons" class="header-buttons" style="display: none;">
                <span class="user-greeting" id="user-greeting">Welcome, Officer! üëÆ</span>
                <a href="/dashboard-gamified/" class="header-button dashboard">My Dashboard</a>
                <button id="logout-btn" class="header-button logout">Sign Out</button>
            </div>
        </div>
    </header>

    <div class="container-main">
        <h1 class="lesson-main-title">AI on Patrol: When Algorithms Lie</h1>
        <p class="text-lg text-slate-500 mb-8 font-medium">Intermediate (B1-B2) | Topic: Technology & Law</p>

        <main class="space-y-8">
            
            <section class="lesson-section shadow-sm">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                    <h2 class="section-title" style="border: none; margin: 0;">üì∞ 1. Read the Report</h2>
                    <span class="text-sm bg-blue-100 text-blue-800 py-1 px-3 rounded-full font-bold mt-2 md:mt-0">Read Time: 4 mins</span>
                </div>

                <div class="news-article-box">
                    <div class="news-header">
                        <div class="flex items-center gap-2">
                            <span class="news-tag">BREAKING</span>
                            <span class="text-sm text-gray-500 font-semibold">UK NEWS</span>
                        </div>
                        <span class="text-xs text-gray-400">West Midlands Police</span>
                    </div>
                    
                    <div class="reading-content">
                        <h3 class="font-bold text-2xl mb-4 text-slate-800">Police Chief Retires Over "AI Hallucination" Scandal</h3>
                        
                        <p class="mb-4">The Chief Constable of West Midlands Police, Craig Guildford, has <span class="highlight-word" onclick="showDictionaryPopup(this, 'Resigned')">resigned</span> following a major controversy involving Artificial Intelligence. His departure comes after he faced <span class="highlight-word" onclick="showDictionaryPopup(this, 'Damning')">damning</span> criticism for banning football fans based on false information.</p>

                        <p class="mb-4">The problem started when the police decided to ban Israeli fans from a football <span class="highlight-word" onclick="showDictionaryPopup(this, 'Fixture')">fixture</span> against Aston Villa. The decision was based on a security report that claimed there was a high risk of violence. However, it was later revealed that this report contained <span class="highlight-word" onclick="showDictionaryPopup(this, 'Erroneous')">erroneous</span> facts.</p>

                        <p class="mb-4">Specifically, the report mentioned a match between Maccabi Tel Aviv and West Ham‚Äîa game that never actually happened. When questioned by the government, Mr. Guildford initially denied using AI. Later, he admitted the false information came from using <strong>Microsoft Copilot</strong>, an AI tool.</p>

                        <p class="mb-4">Experts call this an "AI <span class="highlight-word" onclick="showDictionaryPopup(this, 'Hallucination')">hallucination</span>," where a computer invents facts. The Home Secretary said she had lost confidence in the Chief, stating that the mistakes had caused a "political and media <span class="highlight-word" onclick="showDictionaryPopup(this, 'Frenzy')">frenzy</span>."</p>

                        <p>Mr. Guildford said it was an honour to serve, but critics argue he <span class="highlight-word" onclick="showDictionaryPopup(this, 'Obfuscated')">obfuscated</span> the truth to protect his reputation.</p>
                    </div>
                </div>
            </section>

            <section id="exercise-1" class="lesson-section shadow-sm">
                <h2 class="section-title">üîó 2. Vocabulary Investigation</h2>
                <p class="text-slate-600 mb-6 font-medium">Match the police/tech terms to their definitions. Correct pairs will turn green.</p>

                <div id="vocab-match-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </section>
        
            <section id="exercise-2" class="lesson-section shadow-sm">
                <h2 class="section-title">‚ùì 3. Evidence Check</h2>
                <p class="text-slate-600 mb-4 font-medium">Based on the text, what really happened?</p>
                
                <div class="question" data-question="1">
                    <p class="font-semibold text-lg text-slate-800 mb-3">1. Why did the Chief Constable retire?</p>
                    <ul class="options-list space-y-3 comp-btn-group" data-question="1">
                        <li class="option-button" data-correct="false">Because he reached the age of 60.</li>
                        <li class="option-button" data-correct="true">Because of errors in a report generated by AI.</li>
                        <li class="option-button" data-correct="false">Because Aston Villa lost the match.</li>
                    </ul>
                </div>
                
                <div class="question" data-question="2">
                    <p class="font-semibold text-lg text-slate-800 mb-3">2. What was the "hallucination" in the report?</p>
                    <ul class="options-list space-y-3 comp-btn-group" data-question="2">
                        <li class="option-button" data-correct="true">It mentioned a football match that never existed.</li>
                        <li class="option-button" data-correct="false">It said the fans were from Germany, not Israel.</li>
                        <li class="option-button" data-correct="false">It listed the wrong date for the game.</li>
                    </ul>
                </div>
                
                <div class="question" data-question="3">
                    <p class="font-semibold text-lg text-slate-800 mb-3">3. How did Mr. Guildford react initially?</p>
                    <ul class="options-list space-y-3 comp-btn-group" data-question="3">
                        <li class="option-button" data-correct="false">He immediately admitted using Microsoft Copilot.</li>
                        <li class="option-button" data-correct="false">He blamed his deputy officers.</li>
                        <li class="option-button" data-correct="true">He denied that AI was used in the report.</li>
                    </ul>
                </div>

                <div class="button-group">
                    <button class="check-button" onclick="checkComprehension()">Submit Evidence</button>
                    <button class="check-button reset-button" onclick="resetComprehension()">Clear</button>
                </div>
                <div id="comprehension-result" class="result-message"></div>
            </section>

            <section id="exercise-3" class="lesson-section shadow-sm">
                <h2 class="section-title">üìù 4. Officer's Report (Gap Fill)</h2>
                <p class="text-slate-600 mb-6 font-medium">Complete the sentences using the vocabulary from the article.</p>
                
                <div class="word-bank p-4 mb-6">
                    <h4 class="font-bold text-gray-400 mb-3 w-full text-center text-xs uppercase">WORD BANK</h4>
                    <div class="word-options" id="gap-fill-options">
                        <span class="word-option" data-word="resigned">resigned</span>
                        <span class="word-option" data-word="erroneous">erroneous</span>
                        <span class="word-option" data-word="frenzy">frenzy</span>
                        <span class="word-option" data-word="hallucination">hallucination</span>
                        <span class="word-option" data-word="damning">damning</span>
                        <span class="word-option" data-word="fixture">fixture</span>
                    </div>
                </div>

                <div class="gap-fill-text text-lg leading-loose space-y-4">
                    <p>1. The next <span class="gap-input" data-answer="fixture">____</span> is scheduled for Saturday at 3 PM.</p>
                    <p>2. The CEO <span class="gap-input" data-answer="resigned">____</span> after the scandal was published in the newspapers.</p>
                    <p>3. AI is dangerous because an <span class="gap-input" data-answer="hallucination">____</span> can look like a real fact.</p>
                    <p>4. The judge said the evidence was <span class="gap-input" data-answer="damning">____</span> and proved the man was guilty.</p>
                    <p>5. Please correct the <span class="gap-input" data-answer="erroneous">____</span> data in the spreadsheet immediately.</p>
                    <p>6. The arrival of the famous singer caused a media <span class="gap-input" data-answer="frenzy">____</span> outside the hotel.</p>
                </div>
                <div class="button-group">
                    <button class="check-button" onclick="checkGaps()">Verify Report</button>
                    <button class="check-button reset-button" onclick="resetGaps()">Reset</button>
                </div>
                <div id="gap-result" class="result-message"></div>
            </section>

            <section id="exercise-4" class="lesson-section shadow-sm">
                <h2 class="section-title">‚öñÔ∏è 5. Grammar: Reported Speech</h2>
                
                <div class="grammar-box">
                    <div class="grammar-title">
                        <span>üéôÔ∏è</span>
                        <span>Reporting what people said</span>
                    </div>
                    <p class="text-slate-700 mb-4">In news reports, we often report what someone said in the past. When we do this, the verb usually moves <strong>one step back</strong> into the past.</p>
                    
                    <div class="grammar-example">
                        <strong>Direct:</strong> "I <span class="grammar-highlight">am</span> innocent." (Present)<br>
                        <strong>Reported:</strong> He said he <span class="grammar-highlight">was</span> innocent. (Past)
                    </div>
                    
                    <div class="grammar-example">
                        <strong>Direct:</strong> "We <span class="grammar-highlight">have lost</span> confidence." (Present Perfect)<br>
                        <strong>Reported:</strong> They said they <span class="grammar-highlight">had lost</span> confidence. (Past Perfect)
                    </div>
                    
                    <div class="grammar-example">
                        <strong>Direct:</strong> "I <span class="grammar-highlight">will</span> resign." (Future)<br>
                        <strong>Reported:</strong> He said he <span class="grammar-highlight">would</span> resign. (Conditional)
                    </div>
                </div>

                <h3 class="font-bold text-xl text-slate-800 mt-6 mb-3">üéØ Practice: Transform the sentence</h3>
                <p class="text-slate-600 mb-4 font-medium">Choose the correct reported form.</p>
                
                <div class="question" data-question="4">
                    <p class="font-semibold text-lg text-slate-600 mb-3">1. Guildford: "I <span class="text-blue-600">am</span> sorry." <br>He said he _______ sorry.</p>
                    <ul class="options-list space-y-3 comp-btn-group" data-question="4">
                        <li class="option-button" data-correct="true">was</li>
                        <li class="option-button" data-correct="false">is</li>
                    </ul>
                </div>
                
                <div class="question" data-question="5">
                    <p class="font-semibold text-lg text-slate-600 mb-3">2. Police: "We <span class="text-blue-600">used</span> AI." <br>They admitted they _______ AI.</p>
                    <ul class="options-list space-y-3 comp-btn-group" data-question="5">
                        <li class="option-button" data-correct="false">used</li>
                        <li class="option-button" data-correct="true">had used</li>
                    </ul>
                </div>
                
                <div class="question" data-question="6">
                    <p class="font-semibold text-lg text-slate-600 mb-3">3. MP: "He <span class="text-blue-600">can</span> not stay." <br>The MP said he _______ not stay.</p>
                    <ul class="options-list space-y-3 comp-btn-group" data-question="6">
                        <li class="option-button" data-correct="true">could</li>
                        <li class="option-button" data-correct="false">can</li>
                    </ul>
                </div>

                <div class="button-group">
                    <button class="check-button" onclick="checkGrammar()">Check Grammar</button>
                    <button class="check-button reset-button" onclick="resetGrammar()">Reset</button>
                </div>
                <div id="grammar-result" class="result-message"></div>
            </section>

            <section class="lesson-section shadow-sm border-t-4 border-blue-900">
                <h2 class="section-title">üéâ Case Closed</h2>
                <p class="mb-4 text-slate-600">Well done, Detective. Review the key terms from this case.</p>
                
                <ul id="learned-words-list">
                    <li data-word="Resigned">Resigned</li>
                    <li data-word="Fixture">Fixture</li>
                    <li data-word="Erroneous">Erroneous</li>
                    <li data-word="Hallucination">Hallucination</li>
                    <li data-word="Frenzy">Frenzy</li>
                    <li data-word="Damning">Damning</li>
                    <li data-word="Obfuscated">Obfuscated</li>
                </ul>

                <div id="save-words-section">
                    <h3 class="text-xl font-bold mb-3" style="color: var(--color-secondary);">üíæ File this Report</h3>
                    
                    <div id="save-feature-loggedin" style="display: none;">
                        <p class="text-slate-700 mb-4">Save these words to your permanent record.</p>
                        <button id="save-words-btn" onclick="saveWordsToDashboard()">Save to Database</button>
                        <p id="save-status" class="text-center mt-3 font-semibold"></p>
                    </div>
                    
                    <div id="login-prompt" style="display: none;">
                        <p class="text-red-600 font-bold mb-2">üîí Restricted Area</p>
                        <a href="/login/" class="inline-block bg-slate-800 text-white font-bold py-2 px-4 rounded hover:bg-black transition">Log In to Save</a>
                    </div>
                </div>
            </section>

        </main>
        <footer class="footer">
            <p class="footer-text">¬© 2026 English For Cool Dudes - Law & Order Division</p>
            <div style="margin-top: 10px;">
                <a href="/impressum/" style="color: #1E40AF; margin-right: 15px; text-decoration: none;">Impressum</a>
                <a href="/datenschutz/" style="color: #1E40AF; text-decoration: none;">Datenschutzerkl√§rung</a>
            </div>
        </footer>
    </div>
    
    <div id="feedback-popup"></div>
    <div id="dictionary-popup"></div>

    <script>
        // --- CONFIG ---
        const SUPABASE_URL = 'https://knwgmrgwbpchqyqxbxea.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtud2dtcmd3YnBjaHF5cXhieGVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MDkyODgsImV4cCI6MjA3ODA4NTI4OH0.qnp2ScwSE77_idmPhpLE98sr46WvLpKtg6refFfC7s8';
        
        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentUser = null;

        const lessonTitle = "AI on Patrol: When Algorithms Lie";
        const lessonLink = "/aipolicing/";
        const lessonLevel = "B1-B2";

        const wordsToSave = [
            { word: "Resign", type: "verb", definition: "To officially leave a job (German: k√ºndigen/zur√ºcktreten)." },
            { word: "Fixture", type: "noun", definition: "A sports match that is scheduled (German: Spielbegegnung)." },
            { word: "Erroneous", type: "adjective", definition: "Incorrect or containing errors (Formal)." },
            { word: "Hallucination", type: "noun", definition: "When AI confidently generates false information." },
            { word: "Damning", type: "adjective", definition: "Very critical; suggesting guilt (German: vernichtend)." },
            { word: "Frenzy", type: "noun", definition: "Uncontrolled excitement or wild behavior." },
            { word: "Obfuscated", type: "verb", definition: "Made something unclear or confusing intentionally." },
            { word: "Bias", type: "noun", definition: "Prejudice in favor of or against one thing/person." }
        ];

        // --- AUTH ---
        async function checkUser() {
            try {
                const { data: { user } } = await sb.auth.getUser();
                if (user) {
                    currentUser = user;
                    document.getElementById('logged-in-buttons').style.display = 'flex';
                    document.getElementById('logged-out-buttons').style.display = 'none';
                    document.getElementById('save-feature-loggedin').style.display = 'block';
                    document.getElementById('login-prompt').style.display = 'none';
                    const name = user.user_metadata.full_name ? user.user_metadata.full_name.split(' ')[0] : 'Officer';
                    document.getElementById('user-greeting').textContent = `Hello ${name}! üëÆ`;
                } else {
                    document.getElementById('logged-in-buttons').style.display = 'none';
                    document.getElementById('logged-out-buttons').style.display = 'flex';
                    document.getElementById('save-feature-loggedin').style.display = 'none';
                    document.getElementById('login-prompt').style.display = 'block';
                }
            } catch (err) { console.error(err); }
        }

        async function saveWordsToDashboard() {
            if (!currentUser) return;
            const btn = document.getElementById('save-words-btn');
            const status = document.getElementById('save-status');
            btn.disabled = true; btn.textContent = "Processing...";

            const { error } = await sb.from('lessons').upsert([{
                user_id: currentUser.id, lesson_title: lessonTitle, lesson_link: lessonLink,
                lesson_level: lessonLevel, vocabulary: wordsToSave, completed_at: new Date().toISOString()
            }], { onConflict: 'user_id,lesson_title' });

            if (!error) {
                btn.textContent = "‚úÖ Saved!"; btn.style.backgroundColor = "#15803D";
                status.textContent = "Data uploaded securely.";
                setTimeout(() => window.location.href = '/dashboard/', 1500);
            } else {
                btn.textContent = "‚ùå Error"; btn.disabled = false;
                status.textContent = "Connection failed. Retry.";
            }
        }
        
        async function saveMistake(word) {
            if(!currentUser) return;
            const wObj = wordsToSave.find(w=>w.word.toLowerCase()===word.toLowerCase()) || {word: word, definition:'Review this term', type:'word'};
            await sb.from('user_mistakes').upsert({
                user_id: currentUser.id, word: wObj.word, definition: wObj.definition, word_type: wObj.type,
                lesson: lessonTitle, lesson_link: lessonLink, last_made_at: new Date().toISOString()
            }, {onConflict: 'user_id,word'});
        }

        document.getElementById('logout-btn').addEventListener('click', async () => {
            await sb.auth.signOut(); window.location.href = '/';
        });

        // --- UTILS ---
        function playAudio(word) {
            const utterance = new SpeechSynthesisUtterance(word);
            utterance.lang = 'en-GB'; 
            utterance.rate = 0.9;
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utterance);
        }

        function showFeedback(msg, type) {
            const el = document.getElementById('feedback-popup');
            el.textContent = msg; el.style.display = 'block';
            el.style.backgroundColor = type === 'correct' ? '#15803D' : '#DC2626';
            el.style.borderColor = type === 'correct' ? '#86EFAC' : '#FCA5A5';
            setTimeout(() => { el.style.display = 'none'; }, 1800);
        }

        function showDictionaryPopup(target, word) {
            const searchWord = word.toLowerCase();
            // Allow matching "Resigned" to "Resign" etc.
            let wordObj = wordsToSave.find(w => w.word.toLowerCase() === searchWord);
            if (!wordObj) {
                // simple stemming check for this lesson
                if(searchWord.includes('resign')) wordObj = wordsToSave.find(w => w.word === 'Resign');
                if(searchWord.includes('obfuscate')) wordObj = wordsToSave.find(w => w.word === 'Obfuscated');
            }
            
            const popup = document.getElementById('dictionary-popup');
            if(wordObj) {
                popup.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                        <div>
                            <strong>${wordObj.word}</strong> 
                            <span style="font-size:0.85em; color:#1E40AF;">(${wordObj.type})</span>
                        </div>
                        <button onclick="playAudio('${wordObj.word}')" style="background: none; border: none; cursor: pointer; font-size: 1.3em; padding: 0; margin-left: 10px;" title="Listen">üîä</button>
                    </div>
                    ${wordObj.definition}
                `;
            } else {
                popup.innerHTML = `<strong>${word}</strong><br>Definition not found.`;
            }
            
            popup.style.display = 'block';
            const rect = target.getBoundingClientRect();
            let topPos = rect.top - popup.offsetHeight - 10;
            if (topPos < 10) topPos = rect.bottom + 10;
            
            let leftPos = (rect.left + (rect.width/2) - (popup.offsetWidth/2));
            if (leftPos < 10) leftPos = 10;
            if (leftPos + popup.offsetWidth > window.innerWidth) leftPos = window.innerWidth - popup.offsetWidth - 10;

            popup.style.top = topPos + 'px';
            popup.style.left = leftPos + 'px';
        }
        
        document.body.addEventListener('click', (e) => {
            if (!e.target.closest('#dictionary-popup') && !e.target.closest('#learned-words-list li') && !e.target.closest('.highlight-word')) {
                document.getElementById('dictionary-popup').style.display = 'none';
            }
        });

        // --- EXERCISES ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        function cleanText(text) { return text ? text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z]/g, '').toLowerCase() : ''; }

        /* MATCHING GAME */
        const newVocabData = [
            { type: 'term', content: "Erroneous", key: 'A' }, { type: 'definition', content: "Wrong; incorrect.", key: 'A' },
            { type: 'term', content: "Fixture", key: 'B' }, { type: 'definition', content: "A scheduled sports match.", key: 'B' },
            { type: 'term', content: "Hallucination", key: 'C' }, { type: 'definition', content: "AI inventing false facts.", key: 'C' },
            { type: 'term', content: "Resign", key: 'D' }, { type: 'definition', content: "To quit a job voluntarily.", key: 'D' },
            { type: 'term', content: "Damning", key: 'E' }, { type: 'definition', content: "Critical; suggesting guilt.", key: 'E' },
            { type: 'term', content: "Frenzy", key: 'F' }, { type: 'definition', content: "Wild, uncontrolled behavior.", key: 'F' },
            { type: 'term', content: "Obfuscate", key: 'G' }, { type: 'definition', content: "To make something unclear.", key: 'G' },
            { type: 'term', content: "Bias", key: 'H' }, { type: 'definition', content: "Unfair prejudice.", key: 'H' }
        ];
        let selectedTermCard = null, selectedDefinitionCard = null, matchedPairs = 0;

        function initVocab() {
            const matchContainer = document.getElementById('vocab-match-container');
            matchContainer.innerHTML = ''; shuffleArray(newVocabData);
            newVocabData.forEach(item => {
                const card = document.createElement('div'); 
                card.className = `match-card interactive-element ${item.type}`;
                card.innerHTML = item.type === 'term' ? `<span class="font-bold">${item.content}</span>` : `<span>${item.content}</span>`; 
                card.dataset.key = item.key; card.dataset.type = item.type;
                card.addEventListener('click', () => handleMatchClick(card));
                matchContainer.appendChild(card);
            });
            selectedTermCard = null; selectedDefinitionCard = null; matchedPairs = 0;
        }

        function handleMatchClick(card) {
            if (card.classList.contains('matched')) return;
            const type = card.dataset.type;
            let currentSelection = type === 'term' ? selectedTermCard : selectedDefinitionCard;
            if (currentSelection) currentSelection.classList.remove('selected');
            if (currentSelection === card) {
                if (type === 'term') selectedTermCard = null; else selectedDefinitionCard = null;
                return;
            }
            if (type === 'term') selectedTermCard = card; else selectedDefinitionCard = card;
            card.classList.add('selected');

            if (selectedTermCard && selectedDefinitionCard) {
                if (selectedTermCard.dataset.key === selectedDefinitionCard.dataset.key) {
                    [selectedTermCard, selectedDefinitionCard].forEach(el => { el.classList.remove('selected'); el.classList.add('temp-matched'); });
                    showFeedback("Match Confirmed! ‚úÖ", 'correct');
                    
                    const t = selectedTermCard; const d = selectedDefinitionCard;
                    setTimeout(() => {
                        t.classList.remove('temp-matched'); t.classList.add('matched');
                        d.classList.remove('temp-matched'); d.classList.add('matched');
                    }, 800);

                    matchedPairs++;
                    if (matchedPairs === newVocabData.length / 2) {
                        setTimeout(() => {
                            showFeedback("Investigation Complete! üïµÔ∏è‚Äç‚ôÇÔ∏è", 'correct');
                            setTimeout(() => initVocab(), 1500);
                        }, 1000);
                    }
                    selectedTermCard = null; selectedDefinitionCard = null;
                } else {
                    showFeedback("Mismatch! ‚ùå", 'incorrect');
                    setTimeout(() => {
                        if(selectedTermCard) selectedTermCard.classList.remove('selected'); 
                        if(selectedDefinitionCard) selectedDefinitionCard.classList.remove('selected');
                        selectedTermCard = null; selectedDefinitionCard = null;
                    }, 800);
                }
            }
        }

        /* COMPREHENSION */
        function checkComprehension() {
            const questions = document.querySelectorAll('.question[data-question="1"], .question[data-question="2"], .question[data-question="3"]'); 
            let correctAnswers = 0;
            questions.forEach(q => {
                const selected = q.querySelector('.option-button.selected');
                q.querySelectorAll('.option-button').forEach(opt => {
                    opt.classList.remove('correct', 'incorrect');
                    if (opt.dataset.correct === 'true') opt.classList.add('correct');
                });
                if (selected) {
                    if (selected.dataset.correct === 'true') correctAnswers++; 
                    else {
                        selected.classList.add('incorrect');
                        saveMistake('comprehension_' + q.dataset.question);
                    }
                }
            });
            const resultDiv = document.getElementById('comprehension-result'); resultDiv.style.display = 'block';
            if (correctAnswers === questions.length) { resultDiv.textContent = 'üéâ Excellent Detective Work!'; resultDiv.className = 'result-message correct'; }
            else { resultDiv.textContent = `Evidence Incomplete: ${correctAnswers}/${questions.length} correct.`; resultDiv.className = 'result-message incorrect'; }
        }
        
        function resetComprehension() {
            document.querySelectorAll('.question[data-question="1"] .option-button, .question[data-question="2"] .option-button, .question[data-question="3"] .option-button').forEach(item => item.classList.remove('selected', 'correct', 'incorrect'));
            document.getElementById('comprehension-result').style.display = 'none';
        }

        /* GAP FILL */
        let selectedGapWord = null; 
        
        function initGaps() {
            const wordOptionsContainer = document.getElementById('gap-fill-options');
            const options = Array.from(wordOptionsContainer.children);
            shuffleArray(options);
            options.forEach(option => { wordOptionsContainer.appendChild(option); option.classList.remove('used', 'selected'); });
            document.querySelectorAll('.gap-input').forEach(blank => { blank.textContent = ''; blank.classList.remove('correct', 'incorrect', 'selected'); });
            selectedGapWord = null; document.getElementById('gap-result').style.display = 'none';
        }
        
        function handleGapBlankClick(blank) {
            if (blank.textContent.trim() === '') {
                 if (selectedGapWord) {
                    blank.textContent = selectedGapWord.textContent.trim();
                    selectedGapWord.classList.remove('selected'); 
                    selectedGapWord.classList.add('used');
                    selectedGapWord = null;
                }
                return;
            }
            const currentText = cleanText(blank.textContent); 
            const allOptions = Array.from(document.querySelectorAll('.word-option'));
            const matchingBtn = allOptions.find(btn => cleanText(btn.textContent) === currentText);
            if (matchingBtn) matchingBtn.classList.remove('used');
            blank.textContent = ''; 
            blank.classList.remove('correct', 'incorrect', 'filled'); 
        }

        function checkGaps() {
            let correctCount = 0; 
            const blanks = document.querySelectorAll('.gap-input'); 
            blanks.forEach(blank => { 
                const answerWord = blank.dataset.answer;
                const extractedWord = blank.textContent.trim();
                const cleanExtracted = cleanText(extractedWord);
                const cleanAnswer = cleanText(answerWord);
                blank.classList.remove('selected', 'incorrect', 'correct');
                
                if (extractedWord === '') {
                } else if (cleanExtracted === cleanAnswer) { 
                    blank.classList.add('correct'); 
                    correctCount++; 
                } else { 
                    blank.classList.add('incorrect');
                    saveMistake(answerWord); 
                }
            });

            const resultDiv = document.getElementById('gap-result'); 
            resultDiv.style.display = 'block';
            if (correctCount === blanks.length) { 
                resultDiv.textContent = 'üéâ Report Verified!'; 
                resultDiv.className = 'result-message correct'; 
            } else { 
                resultDiv.textContent = `Errors Found: ${correctCount}/${blanks.length} correct.`; 
                resultDiv.className = 'result-message incorrect'; 
            }
        }

        function resetGaps() {
            selectedGapWord = null;
            document.getElementById('gap-result').style.display = 'none';
            document.querySelectorAll('.word-option').forEach(opt => opt.classList.remove('used', 'selected'));
            document.querySelectorAll('.gap-input').forEach(blank => {
                blank.textContent = '';
                blank.classList.remove('correct', 'incorrect', 'selected', 'filled');
            });
        }

        /* GRAMMAR */
        function checkGrammar() {
            const questions = document.querySelectorAll('.question[data-question="4"], .question[data-question="5"], .question[data-question="6"]'); 
            let correctAnswers = 0;
            questions.forEach(q => {
                const selected = q.querySelector('.option-button.selected');
                q.querySelectorAll('.option-button').forEach(opt => {
                    opt.classList.remove('correct', 'incorrect');
                    if (opt.dataset.correct === 'true') opt.classList.add('correct');
                });
                if (selected && selected.dataset.correct === 'true') correctAnswers++;
                else if(selected) selected.classList.add('incorrect');
            });
            const resultDiv = document.getElementById('grammar-result'); resultDiv.style.display = 'block';
            if (correctAnswers === questions.length) { resultDiv.textContent = 'üéâ Grammar Correct!'; resultDiv.className = 'result-message correct'; }
            else { resultDiv.textContent = `You got ${correctAnswers}/${questions.length} correct.`; resultDiv.className = 'result-message incorrect'; }
        }
        
        function resetGrammar() {
            document.querySelectorAll('.question[data-question="4"] .option-button, .question[data-question="5"] .option-button, .question[data-question="6"] .option-button').forEach(item => item.classList.remove('selected', 'correct', 'incorrect'));
            document.getElementById('grammar-result').style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', () => {
            checkUser(); initVocab(); initGaps();
            document.querySelectorAll('#learned-words-list li').forEach(li => li.addEventListener('click', (e) => { 
                e.stopPropagation(); 
                const word = li.dataset.word;
                showDictionaryPopup(li, word);
                playAudio(word);
            }));
            
            document.querySelectorAll('.option-button').forEach(item => item.addEventListener('click', () => {
                item.closest('.question').querySelectorAll('.option-button').forEach(opt => opt.classList.remove('selected', 'correct', 'incorrect'));
                item.classList.add('selected'); 
                const qNum = item.closest('.question').dataset.question;
                if(qNum <= 3) document.getElementById('comprehension-result').style.display = 'none';
                else document.getElementById('grammar-result').style.display = 'none';
            }));
            
            document.querySelectorAll('.word-option').forEach(option => option.addEventListener('click', () => {
                if (option.classList.contains('used')) return;
                if (selectedGapWord) selectedGapWord.classList.remove('selected');
                if (selectedGapWord === option) selectedGapWord = null;
                else { selectedGapWord = option; selectedGapWord.classList.add('selected'); }
            }));
            
            document.querySelectorAll('.gap-input').forEach(blank => blank.addEventListener('click', () => handleGapBlankClick(blank)));
        });
    </script>
</body>
</html>
