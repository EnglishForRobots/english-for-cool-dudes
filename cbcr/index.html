
<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="/favicon.png" sizes="32x32">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tax English: CbCR - English For Cool Dudes</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- BASE & LAYOUT STYLES (Matching New Site) --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: #F8F9FB; /* Light background */
            color: #2C3E50;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* Header (Global Nav Bar) */
        .header {
            background: #FFFFFF;
            border-bottom: 1px solid #E5E9F2;
            padding: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }

        /* UPDATED: .header-content now handles the link styling */
.header-content {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    text-decoration: none; /* Removes default link underline */
    color: #2C3E50; /* Ensures text color remains dark */
}

.header-content:hover {
     opacity: 0.9; /* Subtle visual feedback on hover */
}

        .logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%); 
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .site-title {
            font-size: 20px;
            font-weight: 800;
            color: #1A202C;
            letter-spacing: -0.02em;
        }


        /* Main Container for Lesson */
        .container-main {
            max-width: 900px;
            margin: 30px auto;
            padding: 30px 20px;
            background-color: #FFFFFF; /* White card background */
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #E5E9F2;
        }

        /* Lesson Specific Styles */
        .lesson-main-title {
            font-size: 2.5em;
            font-weight: 800;
            color: #2980B9; /* Theme Color: Bright Blue */
            margin-bottom: 10px;
            letter-spacing: -0.02em;
        }

        .lesson-section {
            background-color: #F8F9FB; /* Very light background for content */
            padding: 30px;
            border-radius: 10px;
            border: 1px solid #E5E9F2;
        }

        .section-title {
            color: #2980B9; /* Primary Blue for headers */
            font-size: 1.8em;
            font-weight: 800;
            margin-bottom: 20px;
            padding-bottom: 5px;
            border-bottom: 2px dashed #E5E9F2;
        }
        
        /* Progress Bar */
        .progress-bar-container {
            width: 100%;
            background: #E5E9F2;
            border-radius: 9999px; /* Full rounded */
            height: 10px;
            margin-top: 10px;
        }

        .progress-bar-fill {
            background: linear-gradient(90deg, #2980B9 0%, #3498DB 100%); /* Blue Gradient */
            height: 10px;
            border-radius: 9999px;
            transition: width 0.5s ease;
        }

        /* --- INTERACTIVE ELEMENT STYLES --- */
        .interactive-element {
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid #E5E9F2;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            background-color: #FFFFFF;
            color: #2C3E50;
            font-weight: 600;
            padding: 12px 18px;
            border-radius: 8px;
            text-align: center;
        }

        .interactive-element:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
            border-color: #2980B9; /* Blue hover outline */
        }
        
        /* Quiz/Matching Options */
        .quiz-option, .term-btn, .meaning-btn {
            background-color: #FFFFFF;
            color: #2C3E50;
            font-weight: 600;
        }

        /* Match/Term Selection (Temporary) */
        .selected { background-color: #F39C12 !important; color: white !important; border-color: #F39C12 !important; } 

        /* Match Colors (for permanent matches) */
        .match-color-1 { background-color: #2ECC71 !important; border-color: #2ECC71 !important; color: white !important; } /* Emerald */
        .match-color-2 { background-color: #9B59B6 !important; border-color: #9B59B6 !important; color: white !important; } /* Amethyst */
        .match-color-3 { background-color: #3498DB !important; border-color: #3498DB !important; color: white !important; } /* Peter River */

        /* Gap Fill Word Bank Items */
        .fill-in-box {
            background-color: #F0F3F7;
            border: 2px solid #E5E9F2;
            color: #2C3E50;
            font-weight: 600;
            padding: 10px 15px;
            min-width: 140px;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        /* Gap Fill Word Bank Selection */
        .fill-in-box.selected-word {
            background-color: #2980B9; /* Primary Blue */
            color: white;
            border-color: #2980B9;
        }
        
        /* Gap Fill Blanks */
        .conversation-fill-box {
            display: inline-block;
            text-align: center;
            padding: 6px 10px;
            min-width: 120px; 
            height: 38px;
            background-color: #E5E9F2; /* Light background for the gap */
            border: 1px dashed #AAB8C2; /* Dashed border for visual gap */
            border-radius: 4px;
            color: #2C3E50;
            font-style: italic;
            cursor: pointer;
            line-height: 24px; 
            vertical-align: middle;
            font-weight: 600;
        }

        .conversation-fill-box.correct-answer {
            background-color: #D4EDDA; /* Light green */
            border-color: #4CAF50; /* Darker green */
            color: #155724;
            pointer-events: none; /* Lock once correct */
        }

        .conversation-fill-box.incorrect-answer {
            background-color: #FADBD8; /* Light red */
            border-color: #E74C3C; /* Darker red */
            color: #721C24;
            animation: shake 0.5s;
        }

        /* General Feedback/Result Box */
        .result {
            padding: 15px;
            margin-top: 15px;
            border-radius: 8px;
            font-weight: 700;
        }

        .result.correct {
            background-color: #D4EDDA;
            color: #155724;
            border: 1px solid #C3E6CB;
        }

        .result.incorrect {
            background-color: #FADBD8;
            color: #721C24;
            border: 1px solid #F5C6CB;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }

        /* Vocab section reveal */
        .vocab-definition {
            transition: all 0.3s ease-in-out;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            padding-top: 0;
        }
        .vocab-card.revealed .vocab-definition {
            max-height: 200px;
            opacity: 1;
            padding-top: 10px;
        }
    </style>
</head>
<body>
    <header class="header"> 
        <a href="/tax/" class="header-content"> 
            <div class="logo">üòé</div> 
            <span class="site-title">English For Cool Dudes</span> 
        </a> 
    </header>

    <div class="container-main">

        <h1 class="lesson-main-title">üìä Tax English: Decoding CbCR</h1>
        <p class="text-lg text-gray-500 mb-8">Master the key terminology of Country-by-Country Reporting.</p>

        <div class="bg-gray-100 rounded-lg p-5 mb-8 border border-E5E9F2 shadow-sm">
            <div class="flex justify-between items-center mb-2">
                <span class="text-xl font-bold text-gray-700">Score: <span id="score">0</span></span>
                <span id="feedback-message" class="text-lg font-medium text-green-600 hidden"></span>
                <span class="text-sm text-gray-500" id="progress-text">0/3 activities complete</span>
            </div>
            <div class="progress-bar-container">
                <div id="progress-fill" class="progress-bar-fill" style="width: 0%;"></div>
            </div>
        </div>
        
        <main class="space-y-8">
            
            <section id="vocab-section" class="lesson-section shadow-lg">
                <h2 class="section-title">üìö Key Vocabulary</h2>
                <p class="text-gray-600 mb-6">Click on each term to reveal its definition.</p>
                
                <div id="vocab-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="vocab-card interactive-element text-left p-4" onclick="revealDefinition(this)">
                        <div class="font-bold text-lg">Country-by-Country Report (CbCR)</div>
                        <div class="vocab-definition text-sm text-gray-700">
                             An annual report for multinational enterprises (MNEs) detailing global allocation of income, taxes paid, and other economic activity on a country-by-country basis. MNEs with consolidated revenues over **‚Ç¨750 million** are generally required to file CbCR. 
                        </div>
                    </div>
                    <div class="vocab-card interactive-element text-left p-4" onclick="revealDefinition(this)">
                        <div class="font-bold text-lg">Master File</div>
                        <div class="vocab-definition text-sm text-gray-700">
                            A standardized document providing a high-level overview of a multinational group's business, including its organizational structure and transfer pricing policies.
                        </div>
                    </div>
                    <div class="vocab-card interactive-element text-left p-4" onclick="revealDefinition(this)">
                        <div class="font-bold text-lg">Local File</div>
                        <div class="vocab-definition text-sm text-gray-700">
                            A detailed document providing specific information on local intercompany transactions, prepared for each country where a multinational group operates.
                        </div>
                    </div>
                    <div class="vocab-card interactive-element text-left p-4" onclick="revealDefinition(this)">
                        <div class="font-bold text-lg">Ultimate Parent Entity (UPE)</div>
                        <div class="vocab-definition text-sm text-gray-700">
                            The entity at the top of a multinational group's ownership structure that is not controlled by any other entity. It is typically the entity responsible for filing the CbCR.
                        </div>
                    </div>
                    <div class="vocab-card interactive-element text-left p-4" onclick="revealDefinition(this)">
                        <div class="font-bold text-lg">Surrogate Parent Entity</div>
                        <div class="vocab-definition text-sm text-gray-700">
                            A substitute entity designated by a multinational group to file the CbCR in certain circumstances, such as when the UPE is not required to file.
                        </div>
                    </div>
                </div>
            </section>

            <section id="quiz-section" class="lesson-section shadow-lg">
                <h2 class="section-title">‚ùì Quiz: CbCR Fundamentals</h2>
                <div class="space-y-6">
                    
                    <div id="quiz-q1-container">
                        <p class="text-lg font-medium mb-3">1. What is the primary purpose of the Country-by-Country Report?</p>
                        <div id="quiz-1-options" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <button onclick="checkQuizAnswer('Q1', 'A', this)" class="quiz-option interactive-element" data-option="A">A) To calculate the final tax due for each subsidiary.</button>
                            <button onclick="checkQuizAnswer('Q1', 'B', this)" class="quiz-option interactive-element" data-option="B">B) To provide tax authorities with an overview of global business activities and tax payments.</button>
                            <button onclick="checkQuizAnswer('Q1', 'C', this)" class="quiz-option interactive-element" data-option="C">C) To determine the arm's length price of intercompany transactions.</button>
                            <button onclick="checkQuizAnswer('Q1', 'D', this)" class="quiz-option interactive-element" data-option="D">D) To report the total revenue of the entire multinational group.</button>
                        </div>
                        <p id="quiz-q1-feedback" class="mt-2 text-sm font-medium"></p>
                    </div>

                    <div id="quiz-q2-container">
                        <p class="text-lg font-medium mb-3">2. What is the typical consolidated group revenue threshold for CbCR filing?</p>
                        <div id="quiz-2-options" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <button onclick="checkQuizAnswer('Q2', 'A', this)" class="quiz-option interactive-element" data-option="A">A) ‚Ç¨500 million</button>
                            <button onclick="checkQuizAnswer('Q2', 'B', this)" class="quiz-option interactive-element" data-option="B">B) ‚Ç¨250 million</button>
                            <button onclick="checkQuizAnswer('Q2', 'C', this)" class="quiz-option interactive-element" data-option="C">C) ‚Ç¨1 billion</button>
                            <button onclick="checkQuizAnswer('Q2', 'D', this)" class="quiz-option interactive-element" data-option="D">D) ‚Ç¨750 million</button>
                        </div>
                        <p id="quiz-q2-feedback" class="mt-2 text-sm font-medium"></p>
                    </div>

                    <div id="quiz-q3-container">
                        <p class="text-lg font-medium mb-3">3. Which entity is generally responsible for filing the CbCR?</p>
                        <div id="quiz-3-options" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <button onclick="checkQuizAnswer('Q3', 'A', this)" class="quiz-option interactive-element" data-option="A">A) The largest subsidiary in the group.</button>
                            <button onclick="checkQuizAnswer('Q3', 'B', this)" class="quiz-option interactive-element" data-option="B">B) The local entity in each country.</button>
                            <button onclick="checkQuizAnswer('Q3', 'C', this)" class="quiz-option interactive-element" data-option="C">C) The Ultimate Parent Entity (UPE).</button>
                            <button onclick="checkQuizAnswer('Q3', 'D', this)" class="quiz-option interactive-element" data-option="D">D) An external tax consultant.</button>
                        </div>
                        <p id="quiz-q3-feedback" class="mt-2 text-sm font-medium"></p>
                    </div>

                </div>
            </section>
            
            <section id="matching-section" class="lesson-section shadow-lg">
                <h2 class="section-title">üîó Match the Term to its Definition</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div id="terms-column" class="flex flex-col gap-3">
                        <h3 class="font-bold text-gray-700 mb-2">Terms</h3>
                        </div>
                    
                    <div id="meanings-column" class="flex flex-col gap-3">
                        <h3 class="font-bold text-gray-700 mb-2">Definition</h3>
                        </div>
                </div>
                <p id="matching-feedback" class="mt-4 text-sm font-medium"></p>
            </section>


            <section id="gap-fill-section" class="lesson-section shadow-lg">
                <h2 class="section-title">üìù Scenario: Fill in the Blanks</h2>
                <p class="text-gray-600 mb-4">Click a word from the bank and then click a gap. **To deselect, click the filled gap to return the word.**</p>
                
                <div id="scenario-word-bank" class="flex flex-wrap gap-2 justify-center p-3 bg-white border border-E5E9F2 rounded-lg mb-6">
                    </div>
                
                <div id="scenario-text" class="text-base text-gray-700 space-y-4">
                    <p>1. The CbCR data allows tax authorities to conduct a high-level <span class="conversation-fill-box" data-answer="risk assessment">...</span> before launching a full audit.</p>
                    <p>2. The report promotes global tax <span class="conversation-fill-box" data-answer="transparency">...</span> by exposing where MNE profits are booked.</p>
                    <p>3. Data is presented on a per-country basis, meaning each <span class="conversation-fill-box" data-answer="tax jurisdiction">...</span> is analyzed separately.</p>
                    <p>4. The primary concern is ensuring that profit aligns with genuine <span class="conversation-fill-box" data-answer="economic activity">...</span>.</p>
                    <p>5. Only MNEs with a large <span class="conversation-fill-box" data-answer="consolidated">...</span> group revenue are required to file the CbCR.</p>
                </div>

                <button onclick="checkScenarioBlanks()" class="interactive-element mt-6 px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-bold">Check Scenario</button>
                <p id="scenario-feedback" class="result hidden"></p>
            </section>
            
        </main>
    </div>

    <script>
        // --- DATA SECTION ---
        let score = 0;
        let activityCount = 0;
        const totalActivities = 3; // Quiz, Matching, Gap-Fill (Vocabulary is informational)
        let quizDone = false;
        let matchingDone = false;
        let scenarioDone = false;
        let selectedWordBankItem = null;
        let selectedTerm = null;
        let selectedMeaning = null;

        // Quiz Answers (UPDATED for 3 questions)
        const quizAnswers = { 
            'Q1': 'B', // To provide tax authorities with an overview...
            'Q2': 'D', // ‚Ç¨750 million
            'Q3': 'C'  // The Ultimate Parent Entity (UPE).
        };
        // Tracking state for the multiple-question quiz
        let correctQuizQuestions = { 'Q1': false, 'Q2': false, 'Q3': false };


        // Matching
        const matches = [
            { term: "Transfer Pricing", meaning: "The process of setting prices for goods, services, and intangibles exchanged between related entities.", correct: false, matched: false, color: 'match-color-1' },
            { term: "Permanent Establishment", meaning: "An arrangement where a company has a fixed place of business in another jurisdiction.", correct: false, matched: false, color: 'match-color-2' },
            { term: "Intragroup Transactions", meaning: "Commercial or financial relations between companies of the same MNE group.", correct: false, matched: false, color: 'match-color-3' }
        ];

        // Scenario Gap Fill
        const scenarioWords = ["economic activity", "transparency", "risk assessment", "tax jurisdiction", "consolidated"];
        const scenarioOrder = ["risk assessment", "transparency", "tax jurisdiction", "economic activity", "consolidated"];
        let userScenarioWords = new Array(scenarioOrder.length).fill(null);
        
        // --- UTILITY FUNCTIONS ---
        function updateScore(points) {
            score += points;
            document.getElementById('score').textContent = score;
            const message = points > 0 ? `+${points} Points!` : `${points} Points.`;
            showTemporaryFeedback(message, points > 0 ? 'correct' : 'incorrect');
        }

        function updateProgress() {
            activityCount = [quizDone, matchingDone, scenarioDone].filter(Boolean).length;
            const percentage = (activityCount / totalActivities) * 100;
            document.getElementById('progress-fill').style.width = `${percentage}%`;
            document.getElementById('progress-text').textContent = `${activityCount}/${totalActivities} activities complete`;

            if (activityCount === totalActivities) {
                setTimeout(() => {
                    alert(`Lesson Complete! Final Score: ${score}. Great work, you've decoded CbCR!`);
                }, 500);
            }
        }

        function showTemporaryFeedback(message, type) {
            const feedbackEl = document.getElementById('feedback-message');
            feedbackEl.textContent = message;
            feedbackEl.className = `text-lg font-medium mt-4 ${type === 'correct' ? 'text-green-600' : 'text-red-600'}`;
            feedbackEl.style.display = 'block';
            setTimeout(() => {
                feedbackEl.style.display = 'none';
            }, 1500);
        }

        // --- ACTIVITY 1: VOCABULARY ---
        function revealDefinition(card) {
            card.classList.toggle('revealed');
        }


        // --- ACTIVITY 2: QUIZ (UPDATED LOGIC) ---
        function checkQuizAnswer(questionId, answer, button) {
            // Do nothing if the quiz is already fully completed OR this specific question is already correct
            if (quizDone || correctQuizQuestions[questionId]) return;
            
            const feedbackEl = document.getElementById(`quiz-${questionId.toLowerCase()}-feedback`);
            const quizOptionsContainer = button.closest('.grid');
            const quizOptions = quizOptionsContainer.querySelectorAll('.quiz-option');

            // Clear previous feedback for the clicked question
            quizOptions.forEach(btn => btn.classList.remove('match-color-1', 'incorrect-answer'));
            feedbackEl.textContent = '';
            feedbackEl.className = '';

            if (answer === quizAnswers[questionId]) {
                // Correct Answer Logic
                feedbackEl.textContent = "Correct!";
                feedbackEl.className = 'result correct';
                button.classList.add('match-color-1');
                
                correctQuizQuestions[questionId] = true;
                updateScore(15); // Award points per correct question
                
                // Lock only the buttons for this specific correct question
                quizOptions.forEach(btn => btn.style.pointerEvents = 'none');
                
                // Check if all questions are now correct
                if (Object.values(correctQuizQuestions).every(val => val === true)) {
                    feedbackEl.textContent = "üéâ All Quiz questions correct! (+20 Bonus Points)";
                    updateScore(20);
                    quizDone = true;
                    updateProgress();
                }

            } else {
                // Incorrect Answer Logic
                feedbackEl.textContent = "Incorrect. Try again!";
                feedbackEl.className = 'result incorrect';
                button.classList.add('incorrect-answer');
                updateScore(-5);
                
                // Remove the visual incorrect state after 1s, but the button remains clickable
                setTimeout(() => {
                    button.classList.remove('incorrect-answer');
                    feedbackEl.textContent = "";
                    feedbackEl.className = '';
                }, 1000);
            }
        }

        // --- ACTIVITY 3: MATCHING ---
        function setupMatching() {
            const termsColumn = document.getElementById('terms-column');
            const meaningsColumn = document.getElementById('meanings-column');
            
            const shuffledTerms = [...matches];
            const shuffledMeanings = [...matches].sort(() => 0.5 - Math.random());

            shuffledTerms.forEach((item, index) => {
                const termBtn = document.createElement('button');
                termBtn.textContent = item.term;
                termBtn.className = 'term-btn interactive-element text-left';
                termBtn.dataset.term = item.term;
                termBtn.onclick = () => selectTerm(termBtn, item.term, item.meaning);
                termsColumn.appendChild(termBtn);
            });

            shuffledMeanings.forEach((item, index) => {
                const meaningBtn = document.createElement('button');
                meaningBtn.textContent = item.meaning;
                meaningBtn.className = 'meaning-btn interactive-element text-left';
                meaningBtn.dataset.meaning = item.meaning;
                meaningBtn.dataset.correctTerm = matches.find(i => i.meaning === item.meaning).term;
                meaningBtn.onclick = () => selectMeaning(meaningBtn, item.meaning, meaningBtn.dataset.correctTerm);
                meaningsColumn.appendChild(meaningBtn);
            });
        }

        function selectTerm(button, termText, correctMeaning) {
            if (matchingDone || button.classList.contains('matched')) return;
            document.querySelectorAll('.term-btn').forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');
            selectedTerm = { button, text: termText, correctMeaning };
            checkMatch();
        }

        function selectMeaning(button, meaningText, correctTerm) {
            if (matchingDone || button.classList.contains('matched')) return;
            document.querySelectorAll('.meaning-btn').forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');
            selectedMeaning = { button, text: meaningText, correctTerm };
            checkMatch();
        }

        function checkMatch() {
            const feedbackEl = document.getElementById('matching-feedback');
            
            if (selectedTerm && selectedMeaning) {
                if (selectedTerm.text === selectedMeaning.correctTerm && selectedMeaning.text === selectedTerm.correctMeaning) {
                    
                    const matchedItem = matches.find(i => i.term === selectedTerm.text);
                    const matchClass = matchedItem.color;

                    selectedTerm.button.classList.remove('selected');
                    selectedTerm.button.classList.add('matched', matchClass);
                    selectedTerm.button.disabled = true;

                    selectedMeaning.button.classList.remove('selected');
                    selectedMeaning.button.classList.add('matched', matchClass);
                    selectedMeaning.button.disabled = true;

                    matchedItem.matched = true;
                    
                    feedbackEl.textContent = "Match found! (+10 Points)";
                    feedbackEl.className = 'result correct';
                    updateScore(10);

                    selectedTerm = null;
                    selectedMeaning = null;

                    if (matches.every(i => i.matched)) {
                        feedbackEl.textContent = "üéâ All terms matched correctly! (+30 Points)";
                        feedbackEl.className = 'result correct';
                        if (!matchingDone) {
                            updateScore(30);
                            matchingDone = true;
                            updateProgress();
                        }
                    }
                } else {
                    feedbackEl.textContent = "Oops, that's not a match. Try again!";
                    feedbackEl.className = 'result incorrect';
                    
                    // Shake and deselect the buttons for visual feedback
                    selectedTerm.button.classList.add('incorrect-answer');
                    selectedMeaning.button.classList.add('incorrect-answer');
                    
                    setTimeout(() => {
                        selectedTerm.button.classList.remove('selected', 'incorrect-answer');
                        selectedMeaning.button.classList.remove('selected', 'incorrect-answer');
                        selectedTerm = null;
                        selectedMeaning = null;
                        feedbackEl.textContent = "";
                        feedbackEl.className = '';
                    }, 500);

                    updateScore(-5);
                }
            } 
        }

        // --- ACTIVITY 4: SCENARIO GAP FILL ---

        function setupScenarioGapFill() {
            const scenarioBank = document.getElementById('scenario-word-bank');
            const shuffledScenarioWords = [...scenarioWords].sort(() => 0.5 - Math.random());
            
            // 1. Create word bank buttons
            shuffledScenarioWords.forEach(word => {
                const btn = createWordBankButton(word);
                scenarioBank.appendChild(btn);
            });

            // 2. Set up blanks
            document.querySelectorAll('#scenario-text .conversation-fill-box').forEach((blank, index) => {
                blank.dataset.index = index;
                blank.onclick = () => fillBlank(blank, index);
                blank.dataset.selectedWord = ''; // Initialize tracker
            });
        }
        
        function createWordBankButton(word) {
            const btn = document.createElement('button');
            btn.textContent = word;
            btn.className = 'fill-in-box interactive-element';
            btn.dataset.word = word;
            btn.onclick = () => selectWord(btn, word);
            return btn;
        }

        function selectWord(button, word) {
            // Clear any previously selected word
            document.querySelectorAll('.fill-in-box.selected-word').forEach(btn => {
                btn.classList.remove('selected-word');
            });

            // Toggle selection
            if (selectedWordBankItem && selectedWordBankItem.word === word) {
                selectedWordBankItem = null;
            } else {
                button.classList.add('selected-word');
                selectedWordBankItem = { button, word };
            }
        }
        
        function fillBlank(blank, index) {
            if (blank.classList.contains('correct-answer')) return;

            const bankId = 'scenario-word-bank';
            
            // Helper function to return word to bank and clear blank
            const returnWordToBank = () => {
                if (blank.textContent) {
                    const wordToReturn = blank.textContent;
                    const correspondingButton = document.querySelector(`#${bankId} .fill-in-box[data-word="${wordToReturn}"]`);
                    if (correspondingButton) {
                        correspondingButton.style.display = 'block'; // Un-hide
                    }
                    blank.textContent = '';
                    blank.dataset.selectedWord = '';
                    blank.classList.remove('incorrect-answer'); 
                    userScenarioWords[index] = null;
                }
            };
            
            // Case 1: Word bank item is selected -> fill the blank (or swap words)
            if (selectedWordBankItem) {
                
                // If the blank is already filled, return its current word to the bank first (swap)
                if (blank.textContent) {
                    returnWordToBank();
                }
                
                // Place the new selected word
                blank.textContent = selectedWordBankItem.word;
                blank.dataset.selectedWord = selectedWordBankItem.word;
                userScenarioWords[index] = selectedWordBankItem.word;
                
                selectedWordBankItem.button.style.display = 'none'; // Hide word bank button
                selectedWordBankItem.button.classList.remove('selected-word');
                selectedWordBankItem = null;
                
            } 
            // Case 2: Blank is clicked and NO word is selected -> clear the blank (the desired deselect/clear functionality)
            else if (!selectedWordBankItem && blank.textContent) {
                returnWordToBank();
            }
        }

        function checkScenarioBlanks() {
            if (scenarioDone) return;

            const blanks = document.querySelectorAll(`#scenario-text .conversation-fill-box`);
            const feedbackEl = document.getElementById(`scenario-feedback`);

            let correctCount = 0;
            let allCorrect = true;
            const totalGaps = blanks.length;

            blanks.forEach((blank, index) => {
                const selectedWord = blank.dataset.selectedWord ? blank.dataset.selectedWord.toLowerCase() : '';
                const answer = scenarioOrder[index].toLowerCase();
                
                blank.classList.remove('correct-answer', 'incorrect-answer');

                if (selectedWord === answer) {
                    correctCount++;
                    blank.classList.add('correct-answer');
                } else if (selectedWord !== '') {
                    blank.classList.add('incorrect-answer');
                    allCorrect = false;
                } else {
                    allCorrect = false;
                }
            });

            if (allCorrect) {
                feedbackEl.textContent = `üéâ Spot On! You got all ${totalGaps} correct! (+40 Points)`;
                feedbackEl.classList.add('result', 'correct');
                feedbackEl.classList.remove('hidden', 'incorrect');
                if (!scenarioDone) {
                    scenarioDone = true;
                    updateScore(40);
                    updateProgress();
                }
            } else {
                feedbackEl.textContent = `You got ${correctCount} out of ${totalGaps} correct. Review the words highlighted in red and click the incorrect word to remove it.`;
                feedbackEl.classList.add('result', 'incorrect');
                feedbackEl.classList.remove('hidden', 'correct');
                updateScore(-10);
            }
        }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            setupMatching();
            setupScenarioGapFill();
        });

    </script>
</body>
</html>
