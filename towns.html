<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="/favicon.png" sizes="32x32">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beginner Towns Lesson: What's in Your Town? - English For Cool Dudes</title> 
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- BRANDING & LAYOUT STYLES (From fintech2.html) --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: #F8F9FB; /* Light background */
            color: #2C3E50;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* Define the new Blue Theme Colors */
        :root {
            --color-primary-blue: #3498DB; /* Peter River (Main Theme Color) */
            --color-secondary-blue: #2980B9; /* Belize Hole (Darker for contrast) */
            --color-light-blue: #D6EAF8; /* Light Blue for backgrounds */
            --color-light-green: #D4EDDA; /* Light Green for Correct Feedback */
            --color-dark-green: #155724; /* Dark Green for Correct Text */
            --color-light-red: #FADBD8; /* Light Red for Incorrect Feedback */
            --color-dark-red: #721C24; /* Dark Red for Incorrect Text */
            --color-default-bg: #FFFFFF;
            --color-panel-bg: #F8F9FB;
        }

        /* Header (Global Nav Bar) */
        .header {
            background: var(--color-default-bg);
            border-bottom: 1px solid #E5E9F2;
            padding: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            text-decoration: none;
            color: #2C3E50;
        }
        .header-content:hover { opacity: 0.9; }
        .logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%); 
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        .site-title {
            font-size: 20px;
            font-weight: 800;
            color: #1A202C;
            letter-spacing: -0.02em;
        }


        /* Main Container for Lesson */
        .container-main {
            max-width: 1000px; 
            margin: 30px auto;
            padding: 30px 20px;
            background-color: var(--color-default-bg);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #E5E9F2;
        }

        /* Lesson Specific Styles */
        .lesson-main-title {
            font-size: 2.5em;
            font-weight: 800;
            color: var(--color-primary-blue);
            margin-bottom: 10px;
            letter-spacing: -0.02em;
        }

        .lesson-section {
            background-color: var(--color-panel-bg); 
            padding: 30px;
            border-radius: 10px;
            border: 1px solid #E5E9F2;
        }

        .section-title {
            color: var(--color-primary-blue);
            font-size: 1.8em;
            font-weight: 800;
            margin-bottom: 20px;
            padding-bottom: 5px;
            border-bottom: 2px dashed #E5E9F2;
        }
        
        /* --- INTERACTIVE ELEMENT STYLES (Base Style for all buttons/cards) --- */
        .interactive-element {
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            background-color: var(--color-default-bg);
            color: #2C3E50;
            font-weight: 600;
            padding: 12px 18px;
            border-radius: 8px;
            text-align: center;
        }

        .interactive-element:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
        }

        /* --- BUTTON STYLES (Mapping old .btn classes) --- */
        .btn.check-btn {
            background-color: var(--color-secondary-blue);
            color: white;
            padding: 15px 30px;
            border-radius: 9999px;
            font-size: 16px;
        }
        .btn.check-btn:hover:not(:disabled) {
            background-color: var(--color-primary-blue);
        }
        .btn.next-activity-btn {
            background-color: #2ECC71; /* Green */
            color: white;
            padding: 15px 30px;
            border-radius: 9999px;
        }
        .btn.try-again-btn {
            background-color: #FF9800; /* Orange */
            color: white;
            padding: 15px 30px;
            border-radius: 9999px;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* --- MATCHING CARD STYLES (Replacing .match-item) --- */
        .match-card {
            border: 2px solid transparent; 
            transition: all 0.2s ease;
            cursor: pointer;
            user-select: none;
            border-radius: 0.75rem; 
            padding: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            font-weight: 600;
            margin: 10px 0;
            text-align: center;
        }
        /* Group 1: Places (Mapping to uk-term style) - BLUE BORDER */
        .match-card.uk-term {
            background-color: #EAF2F8; 
            border: 2px solid var(--color-secondary-blue); 
            font-size: 1.125rem;
        }
        /* Group 2: Descriptions (Mapping to english style) - GRAY BORDER */
        .match-card.english {
            background-color: #F8F9FB; 
            border: 2px solid #AAB8C2; 
        }

        /* Selection State */
        .match-card.selected, .interactive-element.selected {
            border-color: var(--color-primary-blue) !important;
            background-color: var(--color-light-blue) !important;
            box-shadow: 0 0 0 4px var(--color-primary-blue) !important;
        }
        /* Correct State */
        .match-card.correct, .interactive-element.correct {
            background-color: var(--color-light-green) !important; 
            border-color: #2ECC71 !important; 
            color: var(--color-dark-green) !important;
            pointer-events: none;
        }
        /* Incorrect State */
        .match-card.incorrect, .interactive-element.incorrect {
            background-color: var(--color-light-red) !important;
            border-color: #E74C3C !important;
            color: var(--color-dark-red) !important;
        }


        /* --- READING/ACTIVITY TEXT BOX STYLES (Replacing .reading-text / .conversation-container) --- */
        .styled-text-block {
            background: var(--color-default-bg);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin: 20px 0;
            border-left: 5px solid var(--color-primary-blue);
        }

        /* --- FEEDBACK STYLES (Replacing .feedback-message and .match-score) --- */
        .result {
            padding: 15px;
            margin-top: 15px;
            border-radius: 8px;
            font-weight: 700;
            text-align: center;
        }
        .result.correct {
            background-color: var(--color-light-green);
            color: var(--color-dark-green);
            border: 1px solid #C3E6CB;
        }
        .result.incorrect {
            background-color: var(--color-light-red);
            color: var(--color-dark-red);
            border: 1px solid #F5C6CB;
        }

        /* --- GAP FILL STYLES (Replacing .word-item-drag / .gap-fill-drop-zone) --- */
        .word-option {
            background-color: var(--color-secondary-blue); 
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: grab;
            transition: background-color 0.2s, opacity 0.3s;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .word-option:hover:not(.used) {
            background-color: var(--color-primary-blue); 
            transform: scale(1.05);
        }
        .word-option.used {
            opacity: 0.4;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
            background-color: #ccc;
        }
        
        .gap-input {
            display: inline-block;
            text-align: center;
            padding: 8px 15px;
            min-width: 100px; 
            height: 38px;
            background-color: #E5E9F2; 
            border: 3px solid var(--color-secondary-blue); /* Stronger border for visibility */
            border-radius: 4px;
            color: #2C3E50;
            font-style: italic;
            cursor: pointer;
            line-height: 24px; 
            vertical-align: middle;
            font-weight: 700;
            margin: 0 4px;
            transition: all 0.3s ease;
        }
        .gap-input.filled {
             background-color: var(--color-light-blue);
             border-color: var(--color-primary-blue);
             font-style: normal;
        }

        .gap-input.correct-answer {
            background-color: var(--color-light-green) !important;
            border-color: #4CAF50 !important;
            color: var(--color-dark-green) !important;
            font-style: normal;
        }

        .gap-input.incorrect-answer {
            background-color: var(--color-light-red) !important;
            border-color: #E74C3C !important;
            color: var(--color-dark-red) !important;
            font-style: normal;
        }

        /* Global Utility Classes (Preserving animations and timers) */
        .hidden { display: none !important; }
        .timer {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #E74C3C;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            display: none;
            animation: pulse 1s infinite;
            z-index: 1000;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .points-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #E74C3C;
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 24px;
            font-weight: bold;
            z-index: 1000;
            animation: pointsFloat 2s ease-out forwards;
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
        }
        @keyframes pointsFloat {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            30% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -80px) scale(1); }
        }
        .matching-column h4 {
            text-align: center;
            color: var(--color-secondary-blue);
            margin-bottom: 15px;
            padding: 15px;
            background: var(--color-panel-bg);
            border-radius: 10px;
            font-weight: bold;
            border-bottom: 2px solid var(--color-light-blue);
        }
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%;
            margin: 20px 0;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 10px;
        }
        .video-link {
            text-align: center;
            margin-top: 20px;
        }
        .video-link a {
            display: inline-block;
            background: #E74C3C;
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: bold;
            transition: transform 0.3s ease;
        }
        .video-link a:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }
        .completion-card {
            background-color: var(--color-default-bg);
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #E5E9F2;
            text-align: center;
        }
        .completion-card h2 {
            color: var(--color-primary-blue);
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <header class="header">
        <a href="beginner-landing-page-new.html" class="header-content">
            <div class="logo">üòé</div>
            <span class="site-title">English For Cool Dudes</span>
        </a>
    </header>

    <div class="container-main"> 
        <h1 class="lesson-main-title">üèôÔ∏è Beginner Towns Lesson: What's in Your Town?</h1>
        <p class="text-lg text-gray-500 mb-8">How to describe where you live<span id="currentLevel">1</span></p>

        <div class="flex justify-between items-center bg-gray-100 p-4 rounded-lg shadow-inner mb-6">
            <div class="stat-item text-center">
                <div class="text-2xl font-extrabold text-blue-600" id="totalPoints">0</div>
                <div class="text-sm text-gray-600">Points</div>
            </div>
            <div class="progress-bar w-1/2 h-4 bg-gray-300 rounded-full overflow-hidden mx-4">
                <div class="progress-fill h-full bg-blue-500 transition-width duration-500 rounded-full" id="progressFill" style="width: 0%"></div>
            </div>
            <div class="stat-item text-center">
                <div class="text-2xl font-extrabold text-blue-600" id="streak">0</div>
                <div class="text-sm text-gray-600">Streak</div>
            </div>
            <div class="stat-item text-center ml-4">
                <div class="text-2xl font-extrabold text-blue-600" id="timeLeft">--</div>
                <div class="text-sm text-gray-600">Time</div>
            </div>
        </div>

        <div class="timer" id="timer">‚è∞ 30s</div>
        <div class="points-animation hidden" id="pointsAnimation">+50!</div>
        <div class="achievement hidden" id="achievement"></div> 
        
        <section id="activity1" class="lesson-section shadow-lg">
            <h2 class="section-title">üè¢ Activity 1: Match Places with Descriptions</h2>
            <div class="bg-blue-50 p-4 rounded-lg mb-6 border-l-4 border-blue-500 text-gray-700 font-semibold"> 
                 Match each place in a town with its correct description. Click on a place, then click on the matching description! 
            </div>
            
            <div class="matching-container grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="matching-column">
                    <h4>üè™ Places</h4>
                    <div class="match-card uk-term" data-match="1">Train station</div>
                    <div class="match-card uk-term" data-match="2">Cinema</div>
                    <div class="match-card uk-term" data-match="3">University</div>
                    <div class="match-card uk-term" data-match="4">Beach</div>
                    <div class="match-card uk-term" data-match="5">Market</div>
                    <div class="match-card uk-term" data-match="6">Football stadium</div>
                </div>
                <div class="matching-column">
                    <h4>üìù Descriptions</h4>
                    <div class="match-card english" data-match="4">Where people swim and relax by the sea</div>
                    <div class="match-card english" data-match="1">Where trains arrive and depart</div>
                    <div class="match-card english" data-match="3">Where students study for degrees</div>
                    <div class="match-card english" data-match="2">Where people watch movies</div>
                    <div class="match-card english" data-match="6">Where football matches are played</div>
                    <div class="match-card english" data-match="5">Where people buy fresh food and goods</div>
                </div>
            </div>
            
            <div class="result mt-8 font-semibold p-4 rounded-lg border bg-gray-100 text-gray-800" id="matching-score">
                 Matches: 0/6 
            </div>

            <div class="result" id="matching-feedback"></div>

            <button class="btn next-activity-btn" id="matching-next" onclick="nextActivity()">Continue to Next Activity ‚û°Ô∏è</button>
        </section>


        <section id="activity2" class="lesson-section shadow-lg hidden">
            <h2 class="section-title">üìñ Activity 2: Reading - Talking About Towns</h2>
            <div class="bg-blue-50 p-4 rounded-lg mb-6 border-l-4 border-blue-500 text-gray-700 font-semibold"> 
                 Read the conversation between three people talking about their towns, then answer the questions. 
            </div>
            
            <div class="styled-text-block"> 
                <h3 class="font-bold text-xl mb-3 text-gray-700">Three Friends Discuss Their Towns</h3><br>
                **Sarah:** Hi everyone! So, where do you all live?<br>
                **Mike:** I live in Brighton. It's a lovely seaside town in England.<br>
                **Sarah:** That sounds nice! What is there in Brighton?<br>
                **Mike:** Well, there's a beautiful beach where I swim every morning. There's also a university, a train station, and a football stadium. Oh, and there are lots of shops and restaurants too.<br>
                **Lisa:** That's great! I'm from a small town called Petworth. It's much smaller than Brighton.<br>
                **Sarah:** What is there in Petworth?<br>
                **Lisa:** There's a school, a lovely park, and a market that opens on Saturdays. There are some nice restaurants and shops, and there are lots of beautiful houses. But there isn't a train station, which can be inconvenient.<br>
                **Sarah:** Both your towns sound interesting. I live in London, so there's everything you can imagine - museums, theatres, the London Eye, Buckingham Palace... The list goes on!<br>
                **Mike:** Is there anything you don't like about living in such a big city?<br>
                **Sarah:** Sometimes I miss the quiet atmosphere of smaller towns. But I love all the opportunities London offers!
            </div>

            <div class="question-container mb-8" id="reading-q1">
                <h3 class="font-semibold text-lg text-gray-700 mb-4">1. What does Mike do at the beach every morning?</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4" onclick="handleMultipleChoice(this)">
                    <div class="interactive-element match-card english text-center" data-answer="correct">He swims</div>
                    <div class="interactive-element match-card english text-center" data-answer="wrong">He runs</div>
                    <div class="interactive-element match-card english text-center" data-answer="wrong">He walks</div>
                </div>
            </div>

            <div class="question-container mb-8" id="reading-q2">
                <h3 class="font-semibold text-lg text-gray-700 mb-4">2. What doesn't Petworth have?</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4" onclick="handleMultipleChoice(this)">
                    <div class="interactive-element match-card english text-center" data-answer="wrong">A market</div>
                    <div class="interactive-element match-card english text-center" data-answer="correct">A train station</div>
                    <div class="interactive-element match-card english text-center" data-answer="wrong">Restaurants</div>
                </div>
            </div>

            <div class="question-container mb-8" id="reading-q3">
                <h3 class="font-semibold text-lg text-gray-700 mb-4">3. What does Sarah miss about smaller towns?</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4" onclick="handleMultipleChoice(this)">
                    <div class="interactive-element match-card english text-center" data-answer="correct">The quiet atmosphere</div>
                    <div class="interactive-element match-card english text-center" data-answer="wrong">The large shops</div>
                    <div class="interactive-element match-card english text-center" data-answer="wrong">The theatres</div>
                </div>
            </div>
            
            <div class="result hidden" id="mcq-feedback"></div>
            <button class="btn next-activity-btn" id="mcq-next" onclick="nextActivity()">Continue to Next Activity ‚û°Ô∏è</button>
        </section>

        <section id="activity3" class="lesson-section shadow-lg hidden">
            <h2 class="section-title">üó£Ô∏è Activity 3: Conversation Gap Fill</h2>
            <div class="bg-blue-50 p-4 rounded-lg mb-6 border-l-4 border-blue-500 text-gray-700 font-semibold">
                 Drag the words from the bank into the correct gaps to complete the conversation about a town. 
            </div>

            <div class="flex flex-wrap gap-4 p-4 rounded-lg bg-gray-100 border border-dashed border-blue-400 mb-6" id="wordBank">
                <div class="text-sm font-bold text-blue-700 w-full mb-2">Word Bank: (Drag & Drop)</div>
                <span class="word-option interactive-element" data-word="there's" draggable="true">there's</span>
                <span class="word-option interactive-element" data-word="there are" draggable="true">there are</span>
                <span class="word-option interactive-element" data-word="isn't" draggable="true">isn't</span>
                <span class="word-option interactive-element" data-word="else" draggable="true">else</span>
                <span class="word-option interactive-element" data-word="lots of" draggable="true">lots of</span>
            </div>
            
            <div class="styled-text-block">
                <div class="gap-sentence">**A:** What is there in your town?</div>
                <div class="gap-sentence">**B:** Well, <span class="gap-input" data-correct="there's"></span> a cinema and a university.</div>
                <div class="gap-sentence">**A:** What <span class="gap-input" data-correct="else"></span> is there?</div>
                <div class="gap-sentence">**B:** <span class="gap-input" data-correct="there are"></span> <span class="gap-input" data-correct="lots of"></span> shops and restaurants too.</div>
                <div class="gap-sentence">**A:** Is there an airport? **B:** No, there <span class="gap-input" data-correct="isn't"></span>.</div>
            </div>
            
            <button class="btn check-btn" id="conversation-check-btn" onclick="checkConversationFill()">Check Answers ‚úì</button>
            
            <div class="result hidden" id="conversation-feedback"></div>
            <button class="btn next-activity-btn" id="conversation-next" onclick="nextActivity()">Continue to Next Activity ‚û°Ô∏è</button>
        </section>

        <div id="completion-card" class="completion-card hidden">
            <h2>‚ú® Lesson Complete! ‚ú®</h2>
            <p class="text-xl text-gray-600 mb-6">You've successfully mastered the vocabulary and grammar for describing a town. Great job!</p>
            <div class="text-2xl font-bold text-green-600 mb-4">Total Points: <span id="finalPoints">0</span></div>
            <p class="text-sm text-gray-500 mb-8">Ready for the next adventure?</p>
            <button class="btn next-activity-btn" onclick="resetGame()">Start Over</button>
        </div>


    </div> <script>
        let currentActivity = 1;
        let totalPoints = 0;
        let streak = 0;
        let readingQuestionsAnswered = 0;
        const totalReadingQuestions = 3;
        const totalActivities = 3; 

        // Achievement data
        const achievements = {
            'firstMatch': { message: "First Match! +10 points!", points: 10, shown: false },
            'perfectMatching': { message: "Perfect Matcher! +100 points!", points: 100, shown: false },
            'mcqMaster': { message: "Reading Master! +50 points!", points: 50, shown: false },
            'gapFillGenius': { message: "Conversation Genius! +50 points!", points: 50, shown: false }
        };

        function updateStats(pointsToAdd = 0) {
            if (pointsToAdd > 0) {
                totalPoints += pointsToAdd;
                showPointsAnimation(pointsToAdd);
            }
            document.getElementById('totalPoints').textContent = totalPoints;
            document.getElementById('streak').textContent = streak;

            const progress = (currentActivity - 1) / totalActivities * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
        }

        function showPointsAnimation(points) {
            const animDiv = document.getElementById('pointsAnimation');
            animDiv.textContent = `+${points}!`;
            animDiv.classList.remove('hidden');
            setTimeout(() => {
                animDiv.classList.add('hidden');
            }, 1800);
        }

        function showAchievement(key) {
            if (achievements[key] && !achievements[key].shown) {
                const ach = achievements[key];
                const achDiv = document.getElementById('achievement');
                achDiv.textContent = `üèÜ ${ach.message}`;
                achDiv.style.display = 'block';
                ach.shown = true;
                updateStats(ach.points);
                setTimeout(() => {
                    achDiv.style.display = 'none';
                }, 3000);
            }
        }

        function nextActivity() {
            document.getElementById(`activity${currentActivity}`).classList.add('hidden');
            currentActivity++;
            
            if (currentActivity > totalActivities) {
                document.getElementById('completion-card').classList.remove('hidden');
                document.getElementById('finalPoints').textContent = totalPoints;
                document.getElementById('progressFill').style.width = `100%`;

            } else {
                document.getElementById(`activity${currentActivity}`).classList.remove('hidden');
                updateStats();
                document.getElementById('progressFill').style.width = `${(currentActivity - 1) / totalActivities * 100}%`;
            }
            
            // Re-hide next/try again buttons
            const nextBtns = document.querySelectorAll('.next-activity-btn, .try-again-btn, .result');
            nextBtns.forEach(btn => btn.classList.add('hidden'));

        }

        function resetGame() {
            totalPoints = 0;
            streak = 0;
            currentActivity = 1;
            readingQuestionsAnswered = 0;
            Object.values(achievements).forEach(ach => ach.shown = false);
            document.getElementById('completion-card').classList.add('hidden');
            document.getElementById('activity1').classList.remove('hidden');
            document.getElementById('progressFill').style.width = `0%`;
            updateStats();

            // Reset matching
            document.querySelectorAll('.match-card').forEach(item => {
                item.classList.remove('selected', 'correct', 'incorrect', 'disabled');
                item.style.backgroundColor = '';
                item.style.color = '';
            });
            document.getElementById('matching-score').textContent = 'Matches: 0/6';
            
            // Reset MCQ
            document.querySelectorAll('.question-container').forEach(q => {
                q.querySelectorAll('.interactive-element').forEach(opt => {
                    opt.classList.remove('selected', 'correct', 'incorrect', 'disabled');
                });
            });

            // Reset Gap Fill (This needs the same JS logic for drag and drop, ensuring words return to the bank)
            document.querySelectorAll('.gap-input').forEach(gap => {
                gap.textContent = '';
                gap.removeAttribute('data-selected-word');
                gap.classList.remove('filled', 'correct-answer', 'incorrect-answer');
            });
            document.querySelectorAll('.word-option').forEach(word => {
                word.classList.remove('used');
                word.draggable = true;
            });
        }

        // --- ACTIVITY 1: MATCHING LOGIC ---
        let selectedItem = null;
        let matchesFound = 0;
        const totalMatches = 6;
        const matchingItems = document.querySelectorAll('#activity1 .match-card');

        matchingItems.forEach(item => {
            item.addEventListener('click', () => handleMatch(item));
        });

        function handleMatch(item) {
            if (item.classList.contains('correct') || item.classList.contains('disabled')) return;

            if (selectedItem === item) {
                // Deselect the current item
                item.classList.remove('selected');
                selectedItem = null;
                return;
            }

            // A different item of the same type (vocabulary/definition) is selected
            if (selectedItem && selectedItem.parentElement === item.parentElement) {
                selectedItem.classList.remove('selected');
                selectedItem = item;
                item.classList.add('selected');
                return;
            }
            
            // First item selected in a pair
            if (!selectedItem) {
                selectedItem = item;
                item.classList.add('selected');
                return;
            }

            // Second item selected, check for match
            if (selectedItem && selectedItem.parentElement !== item.parentElement) {
                // Check if they match
                if (selectedItem.dataset.match === item.dataset.match) {
                    // Match found!
                    [selectedItem, item].forEach(el => {
                        el.classList.remove('selected');
                        el.classList.add('correct', 'disabled');
                        // Use original item data to apply color for visual flair, preserving functionality
                        el.style.backgroundColor = '#d4edda'; // Light green
                        el.style.borderColor = '#51cf66';
                        el.style.color = '#155724';
                    });
                    matchesFound++;
                    streak++;
                    updateStats(20);
                    showPointsAnimation(20);
                    selectedItem = null;

                    document.getElementById('matching-score').textContent = `Matches: ${matchesFound}/${totalMatches}`;

                    if (matchesFound === totalMatches) {
                        showAchievement('perfectMatching');
                        document.getElementById('matching-feedback').classList.remove('hidden');
                        document.getElementById('matching-feedback').classList.add('correct');
                        document.getElementById('matching-feedback').innerHTML = "üéâ **All matched!** Excellent work on the vocabulary!";
                        document.getElementById('matching-next').classList.remove('hidden');
                    } else if (matchesFound === 1) {
                        showAchievement('firstMatch');
                    }

                } else {
                    // Incorrect match
                    streak = 0;
                    document.getElementById('streak').textContent = streak;
                    
                    [selectedItem, item].forEach(el => {
                        el.classList.remove('selected');
                        el.classList.add('incorrect');
                        // Force shake animation for incorrect feedback
                        el.style.animation = 'shake 0.5s';
                    });

                    setTimeout(() => {
                        [selectedItem, item].forEach(el => {
                            el.classList.remove('incorrect');
                            el.style.animation = ''; // Remove animation style
                        });
                        selectedItem = null;
                    }, 500);

                    // Provide feedback without a check button
                    const feedback = document.getElementById('matching-feedback');
                    feedback.classList.remove('hidden', 'correct');
                    feedback.classList.add('incorrect');
                    feedback.innerHTML = "‚ùå **Oops!** That was incorrect. Try again.";
                    setTimeout(() => feedback.classList.add('hidden'), 2000);
                }
            }
        }

        // --- ACTIVITY 2: MULTIPLE CHOICE LOGIC ---
        function handleMultipleChoice(container) {
            const options = container.querySelectorAll('.interactive-element');
            
            // Check if already answered
            if (container.classList.contains('answered')) return;

            options.forEach(opt => {
                opt.addEventListener('click', function() {
                    if (container.classList.contains('answered')) return;

                    // Clear previous selection
                    options.forEach(o => o.classList.remove('selected'));
                    
                    // Select current option
                    this.classList.add('selected');

                    // Check answer immediately after selection
                    container.classList.add('answered');
                    readingQuestionsAnswered++;

                    if (this.dataset.answer === 'correct') {
                        this.classList.remove('selected');
                        this.classList.add('correct', 'disabled');
                        streak++;
                        updateStats(25);
                        showPointsAnimation(25);
                    } else {
                        this.classList.remove('selected');
                        this.classList.add('incorrect', 'disabled');
                        // Highlight the correct answer
                        container.querySelector('[data-answer="correct"]').classList.add('correct', 'disabled');
                        streak = 0;
                        document.getElementById('streak').textContent = streak;
                    }
                    
                    options.forEach(o => o.classList.add('disabled'));

                    if (readingQuestionsAnswered === totalReadingQuestions) {
                        showAchievement('mcqMaster');
                        document.getElementById('mcq-feedback').classList.remove('hidden');
                        document.getElementById('mcq-feedback').classList.add('correct');
                        document.getElementById('mcq-feedback').innerHTML = "üéâ **Quiz Complete!** You answered all reading comprehension questions.";
                        document.getElementById('mcq-next').classList.remove('hidden');
                    }
                });
            });
        }
        
        // Initialize MCQ logic on load for existing elements
        document.querySelectorAll('.question-container').forEach(handleMultipleChoice);


        // --- ACTIVITY 3: DRAG AND DROP GAP FILL LOGIC ---

        const wordBank = document.getElementById('wordBank');
        const gapInputs = document.querySelectorAll('.gap-input');

        // Drag handlers
        wordBank.addEventListener('dragstart', (e) => {
            if (e.target.classList.contains('word-option')) {
                e.dataTransfer.setData('text/plain', e.target.dataset.word);
                setTimeout(() => e.target.classList.add('hidden'), 0); // Hide the original element being dragged
            }
        });

        wordBank.addEventListener('dragend', (e) => {
             if (e.target.classList.contains('word-option') && !e.target.classList.contains('used')) {
                // If not used (i.e., not dropped correctly), make it visible again
                e.target.classList.remove('hidden');
            }
        });

        // Drop handlers
        gapInputs.forEach(gap => {
            gap.addEventListener('dragover', (e) => {
                e.preventDefault(); // Allows drop
                gap.style.opacity = '0.7'; // Visual feedback for drop zone
            });

            gap.addEventListener('dragleave', () => {
                gap.style.opacity = '1';
            });

            gap.addEventListener('drop', (e) => {
                e.preventDefault();
                gap.style.opacity = '1';

                const word = e.dataTransfer.getData('text/plain');
                const draggedWordElement = document.querySelector(`.word-option[data-word="${word}"]`);

                // Check if the gap is already filled
                if (gap.textContent) {
                    // Find the word that was previously in this gap and return it to the bank
                    const previousWord = gap.dataset.selectedWord;
                    const previousWordElement = document.querySelector(`.word-option[data-word="${previousWord}"]`);
                    if (previousWordElement) {
                        previousWordElement.classList.remove('used', 'hidden');
                        previousWordElement.draggable = true;
                    }
                }

                // Fill the gap
                gap.textContent = word;
                gap.dataset.selectedWord = word;
                gap.classList.add('filled');
                
                // Mark the new word as used
                draggedWordElement.classList.add('used');
                draggedWordElement.classList.remove('hidden');
                draggedWordElement.draggable = false;
            });

            // Click to clear for mobile/accessibility
            gap.addEventListener('click', () => {
                if (gap.textContent) {
                    const wordToReturn = gap.dataset.selectedWord;
                    const wordElement = document.querySelector(`.word-option[data-word="${wordToReturn}"]`);
                    
                    if (wordElement) {
                         wordElement.classList.remove('used', 'hidden');
                         wordElement.draggable = true;
                    }
                    
                    gap.textContent = '';
                    gap.removeAttribute('data-selected-word');
                    gap.classList.remove('filled', 'correct-answer', 'incorrect-answer');
                }
            });
        });

        function checkConversationFill() {
            let correctCount = 0;
            const feedback = document.getElementById('conversation-feedback');

            gapInputs.forEach(gap => {
                gap.classList.remove('correct-answer', 'incorrect-answer');
                const selectedWord = gap.dataset.selectedWord;
                const correctAnswer = gap.dataset.correct;

                if (selectedWord === correctAnswer) {
                    correctCount++;
                    gap.classList.add('correct-answer');
                } else if (selectedWord) {
                    gap.classList.add('incorrect-answer');
                }
            });

            if (correctCount === gapInputs.length) {
                showAchievement('gapFillGenius');
                streak++;
                updateStats(50);
                document.getElementById('streak').textContent = streak; // Update streak explicitly before feedback
                feedback.classList.remove('hidden', 'incorrect');
                feedback.classList.add('correct');
                feedback.innerHTML = "üéâ **All Correct!** You nailed the conversation and grammar!";
                document.getElementById('conversation-next').classList.remove('hidden');
            } else {
                streak = 0;
                document.getElementById('streak').textContent = streak;
                feedback.classList.remove('hidden', 'correct');
                feedback.classList.add('incorrect');
                feedback.innerHTML = `‚ùå **Incorrect.** You got ${correctCount} out of ${gapInputs.length} correct. Try again!`;
                // Add try again button if needed, but for simplicity, we'll just show the incorrect markers.
            }
        }

        // Initial setup
        document.addEventListener('DOMContentLoaded', updateStats);
    </script>
</body>
</html>
