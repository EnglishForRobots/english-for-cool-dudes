<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>What Am I? Game</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
    :root {
        --primary: #0EA5E9;
        --secondary: #8B5CF6;
        --accent: #F472B6;
        --surface: #FFFFFF;
        --background: #F0F9FF;
        --text: #0F172A;
        --text-light: #64748B;
    }
    
    * { box-sizing: border-box; }
    
    body { 
        font-family: system-ui, -apple-system, sans-serif; 
        background: var(--background); 
        margin: 0; 
        color: var(--text); 
        min-height: 100vh;
    }
    .navbar {
        background: white;
        border-bottom: 1px solid #E2E8F0;
        padding: 15px 0;
        position: sticky;
        top: 0;
        z-index: 1000;
    }
    .header-content {
        max-width: 1000px;
        margin: 0 auto;
        padding: 0 20px;
        display: flex;
        align-items: center;
    }
    .nav-brand {
        font-size: 20px;
        font-weight: 800;
        color: var(--primary);
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .game-header {
        background: white;
        border-bottom: 1px solid #E2E8F0;
        padding: 30px 20px;
        text-align: center;
        margin-bottom: 30px;
        border-radius: 0 0 16px 16px;
    }
    .container { max-width: 800px; margin: 0 auto; padding: 20px; }
    .controls, .game-card { background: white; border-radius: 16px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 20px; }
    label { display: block; font-size: 12px; font-weight: 700; color: #718096; text-transform: uppercase; margin-bottom: 8px; }
    select, input { width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #E2E8F0; font-size: 15px; margin-bottom: 15px; }
    
    .btn { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 14px 30px; border-radius: 8px; border: none; cursor: pointer; font-size: 16px; font-weight: 700; width: 100%; transition: transform 0.2s; }
    .btn:hover { transform: translateY(-2px); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-secondary { background: white; border: 2px solid #E2E8F0; color: #64748B; }
    
    #game-area { display: none; }
    .score-bar { display: flex; justify-content: space-around; padding: 20px; background: #F8FAFC; border-radius: 8px; margin-bottom: 20px; }
    .score-item { text-align: center; }
    .score-label { font-size: 12px; color: #64748B; text-transform: uppercase; font-weight: 700; }
    .score-value { font-size: 24px; font-weight: 800; color: var(--secondary); margin-top: 5px; }
    
    .clue-box { background: #F0F9FF; border: 2px solid #BAE6FD; border-radius: 12px; padding: 20px; margin-bottom: 15px; }
    .clue-box.locked { background: #E2E8F0; border-color: #CBD5E1; filter: grayscale(1); }
    .clue-text-locked { font-style: italic; color: #94A3B8; filter: blur(4px); pointer-events: none; }
    .clue-difficulty { font-size: 11px; font-weight: 800; text-transform: uppercase; margin-bottom: 8px; }
    .very-hard { color: #DC2626; }
    .hard { color: #EA580C; }
    .medium { color: #CA8A04; }
    .easy { color: #16A34A; }
    
    .answer-section { display: flex; gap: 10px; margin-top: 20px; }
    .answer-prefix { background: #F1F5F9; padding: 12px 16px; border-radius: 8px; font-weight: 600; color: #64748B; border: 2px solid #E2E8F0; display: flex; align-items: center; flex-shrink: 0; white-space: nowrap; }
    
    .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background: white; width: 90%; max-width: 450px; border-radius: 16px; padding: 40px; text-align: center; }
    .player-list { background: #F8FAFC; border-radius: 8px; padding: 10px; margin-top: 10px; }
    .player-tag { display: inline-block; background: var(--primary); color: white; padding: 5px 12px; border-radius: 20px; margin: 3px; font-size: 14px; }
    #multiplayerSetup { display: none; margin-top: 15px; padding-top: 15px; border-top: 2px solid #E2E8F0; }
    .loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 50; }
</style>
</head>
<body>
<nav class="navbar">
    <div class="header-content">
        <a href="/games/" class="nav-brand"><span>ü§î</span> English For Cool Dudes</a>
    </div>
</nav>

<div class="game-header">
    <h1 style="margin: 0;">ü§î What Am I?</h1>
    <p style="color: var(--text-light);">Get clues one by one and guess the mystery object!</p>
</div>

<div class="loading" id="loading">
    <div style="font-size: 40px;">ü§î</div>
    <div>Loading riddle...</div>
</div>

<div class="container">
    <div class="controls" id="setup">
        <label>Category</label>
        <select id="category">
            <option value="random">üé≤ Random</option>
            <option value="business">üíº Business & Office</option>
            <option value="tax">üìä Tax & Finance</option>
            <option value="legal">‚öñÔ∏è Legal</option>
            <option value="everyday">üè† Everyday Objects</option>
            <option value="animals">ü¶Å Animals</option>
            <option value="food">üçï Food & Drink</option>
            <option value="places">üåç Places</option>
            <option value="jobs">üíº Jobs</option>
        </select>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
                <label>Level</label>
                <select id="level">
                    <option value="beginner">Beginner</option>
                    <option value="intermediate">Intermediate</option>
                    <option value="advanced">Advanced</option>
                </select>
            </div>
            <div>
                <label>Points to Win</label>
                <select id="points">
                    <option value="50">50</option>
                    <option value="100" selected>100</option>
                    <option value="150">150</option>
                </select>
            </div>
        </div>

        <label>Game Mode</label>
        <select id="mode" onchange="toggleMultiplayer()">
            <option value="single">üë§ Single Player</option>
            <option value="multi">üë• Multiplayer</option>
        </select>

        <div id="multiplayerSetup">
            <label>Add Players (min 2)</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="playerName" placeholder="Player name">
                <button class="btn btn-secondary" onclick="addPlayer()" style="width: auto;">Add</button>
            </div>
            <div class="player-list" id="playerList"></div>
        </div>

        <button class="btn" onclick="startGame()">Start Game</button>
    </div>

    <div id="game-area">
        <div class="game-card">
            <div class="score-bar">
                <div class="score-item">
                    <div class="score-label">Player</div>
                    <div id="currentPlayer" class="score-value">You</div>
                </div>
                <div class="score-item">
                    <div class="score-label">Round</div>
                    <div id="round" class="score-value">1</div>
                </div>
                <div class="score-item">
                    <div class="score-label">Score</div>
                    <div class="score-value"><span id="score">0</span>/<span id="target">100</span></div>
                </div>
            </div>

            <div id="clue1" class="clue-box">
                <div class="clue-difficulty very-hard">üî• Very Hard (+40 pts)</div>
                <div id="clue1Text"></div>
            </div>
            <div id="clue2" class="clue-box locked">
                <div class="clue-difficulty hard">üü† Hard (+30 pts)</div>
                <div id="clue2Text">Locked</div>
            </div>
            <div id="clue3" class="clue-box locked">
                <div class="clue-difficulty medium">üü° Medium (+20 pts)</div>
                <div id="clue3Text">Locked</div>
            </div>
            <div id="clue4" class="clue-box locked">
                <div class="clue-difficulty easy">üü¢ Easy (+10 pts)</div>
                <div id="clue4Text">Locked</div>
            </div>

            <div class="answer-section">
                <div class="answer-prefix">I am</div>
                <input type="text" id="answer" placeholder="Type answer..." onkeypress="if(event.key==='Enter') checkAnswer()">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 10px; margin-top: 15px;">
                <button class="btn btn-secondary" id="clueBtn" onclick="nextClue()">üí° Next Clue</button>
                <button class="btn" onclick="checkAnswer()">‚úì Submit</button>
            </div>
        </div>
        <button class="btn btn-secondary" onclick="showSetup()" style="width: auto; margin: 20px auto; display: block;">‚öôÔ∏è Main Menu</button>
    </div>
</div>

<div class="modal" id="modal">
    <div class="modal-content">
        <div id="icon" style="font-size: 80px;">üéâ</div>
        <h2 id="title">Correct!</h2>
        <p id="message"></p>
        <div id="answerText" style="background: #F0F9FF; padding: 15px; border-radius: 8px; font-size: 20px; font-weight: 700; color: var(--secondary); margin: 20px 0;"></div>
        <div id="scores" style="display: none; background: #F8FAFC; border-radius: 8px; padding: 15px; margin-bottom: 20px; text-align: left;"></div>
        <button class="btn" onclick="nextRound()">Next Round</button>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://knwgmrgwbpchqyqxbxea.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtud2dtcmd3YnBjaHF5cXhieGVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MDkyODgsImV4cCI6MjA3ODA4NTI4OH0.qnp2ScwSE77_idmPhpLE98sr46WvLpKtg6refFfC7s8';
    const sb = window.supabase?.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    const POINTS = { 1: 40, 2: 30, 3: 20, 4: 10 };
    
    const game = {
        players: [],
        playerIdx: 0,
        round: 1,
        target: 100,
        clue: 1,
        riddle: null,
        isMulti: false,
        usedIds: []
    };

    function setMode(isMulti) {
        document.getElementById('mode').value = isMulti ? 'multi' : 'single';
        toggleMultiplayer();
    }

    function toggleMultiplayer() {
        const isMulti = document.getElementById('mode').value === 'multi';
        document.getElementById('multiplayerSetup').style.display = isMulti ? 'block' : 'none';
        game.isMulti = isMulti;
        if (!isMulti) game.players = [];
    }

    function addPlayer() {
        const name = document.getElementById('playerName').value.trim();
        if (name && game.players.length < 6) {
            game.players.push({ name, score: 0 });
            document.getElementById('playerName').value = '';
            updatePlayerListUI();
        }
    }

    function updatePlayerListUI() {
        document.getElementById('playerList').innerHTML = game.players.map(p => 
            `<span class="player-tag">${p.name}</span>`
        ).join('');
    }

    function showSetup() {
        game.players = []; 
        game.usedIds = []; 
        document.getElementById('setup').style.display = 'block';
        document.getElementById('game-area').style.display = 'none';
        document.getElementById('modal').style.display = 'none';
        document.getElementById('playerList').innerHTML = '';
        setMode(false);
    }

    async function startGame() {
        if (game.isMulti && game.players.length < 2) {
            alert('Add at least 2 players!');
            return;
        }
        game.target = parseInt(document.getElementById('points').value);
        game.playerIdx = 0;
        game.round = 1;
        if (!game.isMulti) game.players = [{ name: 'You', score: 0 }];
        else game.players.forEach(p => p.score = 0);
        
        document.getElementById('loading').style.display = 'flex';
        await loadRiddle();
        document.getElementById('loading').style.display = 'none';
        document.getElementById('setup').style.display = 'none';
        document.getElementById('game-area').style.display = 'block';
        updateUI();
    }

    async function loadRiddle() {
        const cat = document.getElementById('category').value;
        const lvl = document.getElementById('level').value;
        let query = sb.from('riddles').select('*').eq('level', lvl);
        if (cat !== 'random') query = query.eq('category', cat);
        if (game.usedIds.length > 0) query = query.not('id', 'in', `(${game.usedIds.join(',')})`);

        const { data, error } = await query;
        if (error || !data || data.length === 0) {
            if (game.usedIds.length > 0) {
                game.usedIds = [];
                return loadRiddle();
            }
            alert("No more riddles available for this selection.");
            showSetup();
            return;
        }

        game.riddle = data[Math.floor(Math.random() * data.length)];
        game.usedIds.push(game.riddle.id);
        game.clue = 1;

        for (let i = 1; i <= 4; i++) {
            const box = document.getElementById(`clue${i}`);
            const txt = document.getElementById(`clue${i}Text`);
            if (i === 1) {
                box.className = 'clue-box revealed';
                txt.textContent = game.riddle.clue1;
                txt.classList.remove('clue-text-locked');
            } else {
                box.className = 'clue-box locked';
                txt.textContent = "Locked";
                txt.classList.add('clue-text-locked');
            }
        }
        document.getElementById('answer').value = '';
        updateClueBtn();
    }

    function nextClue() {
        if (game.clue < 4) {
            game.clue++;
            const box = document.getElementById(`clue${game.clue}`);
            const txt = document.getElementById(`clue${game.clue}Text`);
            box.classList.remove('locked');
            txt.classList.remove('clue-text-locked');
            txt.textContent = game.riddle[`clue${game.clue}`];
            updateClueBtn();
        }
    }

    function updateClueBtn() {
        const btn = document.getElementById('clueBtn');
        if (game.clue >= 4) {
            btn.textContent = 'üîì Reveal Answer';
            btn.onclick = revealAnswer;
        } else {
            btn.textContent = 'üí° Next Clue';
            btn.onclick = nextClue;
        }
    }

    function revealAnswer() { showModal(true, 0, true); }

    function checkAnswer() {
        const ans = document.getElementById('answer').value.trim().toLowerCase();
        if (!ans) return;
        const correct = game.riddle.answer.toLowerCase();
        const isRight = correct.includes(ans) || ans.includes(correct.replace(/^(a|an|the) /,''));
        
        if (isRight) {
            const pts = POINTS[game.clue];
            game.players[game.playerIdx].score += pts;
            showModal(true, pts);
        } else {
            showModal(false, 0);
        }
    }

    function showModal(correct, pts, isReveal = false) {
        const modal = document.getElementById('modal');
        const btn = modal.querySelector('.btn');
        const answerText = document.getElementById('answerText');
        modal.style.display = 'flex';
        
        btn.style.display = (correct || isReveal) ? 'block' : 'none';
        btn.textContent = 'Next Round';
        btn.onclick = nextRound;

        if (isReveal) {
            document.getElementById('icon').textContent = 'üîç';
            document.getElementById('title').textContent = 'The answer was...';
            document.getElementById('message').textContent = 'No points this round.';
        } else {
            document.getElementById('icon').textContent = correct ? 'üéâ' : '‚ùå';
            document.getElementById('title').textContent = correct ? 'Correct!' : 'Not Quite!';
            document.getElementById('message').textContent = correct ? `You earned ${pts} points!` : 'Keep thinking!';
        }

        answerText.textContent = (correct || isReveal) ? `Answer: ${game.riddle.answer}` : '';
        answerText.style.display = (correct || isReveal) ? 'block' : 'none';
        
        if (!correct && !isReveal) {
            setTimeout(() => { modal.style.display = 'none'; }, 1500);
            return;
        }

        if (game.isMulti) {
            const div = document.getElementById('scores');
            div.style.display = 'block';
            div.innerHTML = '<div style="font-weight:700;margin-bottom:10px;color:#64748B">SCORES</div>' +
                game.players.map(p => `<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #E2E8F0"><span>${p.name}</span><span style="font-weight:700;color:var(--secondary)">${p.score}</span></div>`).join('');
        }
    }

    async function nextRound() {
        document.getElementById('modal').style.display = 'none';
        const winner = game.players.find(p => p.score >= game.target);
        if (winner) {
            showWinner(winner);
            return;
        }
        if (game.isMulti) {
            game.playerIdx = (game.playerIdx + 1) % game.players.length;
            if (game.playerIdx === 0) game.round++;
        } else {
            game.round++;
        }
        document.getElementById('loading').style.display = 'flex';
        await loadRiddle();
        document.getElementById('loading').style.display = 'none';
        updateUI();
    }

    function showWinner(winner) {
        const modal = document.getElementById('modal');
        document.getElementById('icon').textContent = 'üèÜ';
        document.getElementById('title').textContent = 'Game Over!';
        const isFirstPerson = winner.name.toLowerCase() === 'you';
        document.getElementById('message').textContent = `${winner.name} ${isFirstPerson ? 'win' : 'wins'} with ${winner.score} points!`;
        document.getElementById('answerText').style.display = 'none';
        
        const btn = modal.querySelector('.btn');
        btn.textContent = 'üéÆ New Game';
        btn.onclick = showSetup;
        modal.style.display = 'flex';
    }

    function updateUI() {
        const p = game.players[game.playerIdx] || { name: 'You', score: 0 };
        document.getElementById('currentPlayer').textContent = p.name;
        document.getElementById('round').textContent = game.round;
        document.getElementById('score').textContent = p.score;
        document.getElementById('target').textContent = game.target;
    }
</script>
</body>
</html>
