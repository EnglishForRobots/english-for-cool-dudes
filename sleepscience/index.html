<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="icon" type="image/png" href="/favicon.png" sizes="32x32">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="manifest" href="/manifest.json">
    
    <title>The Science of Sleep: Why We Dream - English For Cool Dudes</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- BASE & BRANDING STYLES --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: #E8EAF6; /* Light Indigo Background */
            color: #1A237E; /* Deep Indigo Text */
            line-height: 1.6;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
        }

        /* --- THEME: SLEEP & DREAMS PALETTE üåô --- */
        :root {
            --color-primary: #5E35B1; /* Deep Purple */
            --color-secondary: #1A237E; /* Deep Indigo */
            --color-accent: #7E57C2; /* Light Purple */
            --color-white: #FFFFFF;
            
            /* Feedback Colors */
            --color-correct: #2E7D32; 
            --color-incorrect: #C62828; 
            
            --color-save-btn: #5E35B1; 
        }

        /* Header */
        .header {
            background: var(--color-white);
            border-bottom: 2px solid var(--color-primary);
            padding: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
            position: sticky; top: 0; z-index: 100;
        }
        .header-content {
            max-width: 1200px; margin: 0 auto; padding: 0 20px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .header-left { display: flex; align-items: center; gap: 15px; }

        .logo {
            width: 36px; height: 36px;
            background: linear-gradient(135deg, #5E35B1 0%, #311B92 100%); 
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
            font-size: 20px; color: white;
        }
        .site-title { font-size: 20px; font-weight: 800; color: var(--color-primary); text-decoration: none; letter-spacing: -0.02em; }

        /* Buttons */
        .header-buttons { display: flex; align-items: center; gap: 8px; }
        .header-button {
            text-decoration: none; padding: 7px 14px; border-radius: 6px;
            font-size: 14px; font-weight: 600; transition: all 0.2s;
            white-space: nowrap; cursor: pointer; border: 1px solid #D1C4E9;
            background: transparent;
        }
        .header-button.login { background: #EDE7F6; color: var(--color-primary); }
        .header-button.login:hover { background: #FFFFFF; color: var(--color-secondary); border-color: var(--color-secondary); }
        
        .header-button.signup { background: var(--color-secondary); color: white; border-color: var(--color-secondary); }
        .header-button.signup:hover { background: #311B92; box-shadow: 0 2px 5px rgba(94, 53, 177, 0.4); }
        
        .header-button.dashboard { background: #FFF8E1; color: #F57F17; border-color: #FFD54F; }
        .header-button.logout { background: #FFEBEE; color: #C62828; border-color: #EF9A9A; }
        
        .user-greeting { font-size: 14px; color: var(--color-primary); font-weight: 600; margin-right: 5px; display: block; }

        /* Container */
        .container-main {
            max-width: 1000px; margin: 30px auto; padding: 30px 20px;
            background-color: var(--color-white); border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.06); border: 2px solid #D1C4E9;
        }

        .lesson-main-title {
            font-size: 2.5em; font-weight: 800; color: var(--color-primary); 
            margin-bottom: 10px; letter-spacing: -0.02em;
        }

        .lesson-section {
            background-color: #F3E5F5; padding: 30px; border-radius: 10px;
            border: 1px solid #E1BEE7; margin-bottom: 30px;
        }

        .section-title {
            color: var(--color-secondary); font-size: 1.8em; font-weight: 800;
            margin-bottom: 20px; padding-bottom: 5px; border-bottom: 2px dashed var(--color-primary);
        }

        /* Reading Text */
        .reading-text {
            background: #FFFFFF; border-left: 5px solid var(--color-primary);
            padding: 20px; border-radius: 0 8px 8px 0; font-size: 1.1em;
            color: #1A237E; line-height: 1.8; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .highlight-word {
            color: var(--color-primary); font-weight: 700; cursor: help;
            border-bottom: 2px dotted var(--color-primary); transition: all 0.2s;
        }
        .highlight-word:hover { background-color: #EDE7F6; color: var(--color-secondary); border-radius: 4px; }
        
        /* Match Cards */
        .match-card {
            border: 2px solid transparent; transition: all 0.5s ease;
            cursor: pointer; user-select: none; border-radius: 0.75rem; 
            padding: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.04); font-weight: 600;
            opacity: 1; transform: scale(1); min-height: 80px; display: flex; align-items: center; justify-content: center;
        }
        .match-card.term {
            background-color: #EDE7F6; border: 2px solid var(--color-primary); 
            text-align: center; color: var(--color-primary);
        }
        .match-card.definition {
            background-color: #FFFFFF; text-align: left; border: 2px solid #CFD8DC; color: #37474F;
        }
        .match-card.selected {
            border-color: var(--color-accent); background-color: #F3E5F5; 
            box-shadow: 0 0 0 4px #CE93D8; transform: scale(1.02);
        }
        .match-card.matched { 
            pointer-events: none; opacity: 0; transform: scale(0.9); 
        }
        .match-card.temp-matched {
            background-color: #C8E6C9 !important; border-color: #2E7D32 !important; 
            box-shadow: 0 0 0 4px #2E7D32 !important; color: #1B5E20 !important;
        }

        /* Quiz Buttons */
        .comp-btn-group .option-button {
            transition: all 0.2s; background-color: #FFFFFF; color: #1A237E;
            font-weight: 600; padding: 10px 15px; border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); border: 1px solid #D1C4E9;
            text-align: left; width: 100%; cursor: pointer; margin-bottom: 10px;
        }
        .comp-btn-group .option-button:hover { border-color: var(--color-primary); background-color: #EDE7F6; }
        .comp-btn-group .option-button.selected { background-color: #D1C4E9; color: var(--color-primary) !important; border-color: var(--color-primary); box-shadow: 0 0 0 4px #D1C4E9; }
        .comp-btn-group .option-button.correct { background-color: #4CAF50 !important; color: white !important; border-color: #2E7D32 !important; box-shadow: 0 0 0 4px #2E7D32 !important; }
        .comp-btn-group .option-button.incorrect { background-color: #EF5350 !important; color: white !important; border-color: #C62828 !important; box-shadow: 0 0 0 4px #C62828 !important; }

        .result-message { margin-top: 15px; padding: 15px; border-radius: 8px; font-weight: 700; display: none; text-align: center; }
        .result-message.correct { background-color: #C8E6C9; color: #1B5E20; border: 1px solid #81C784; }
        .result-message.incorrect { background-color: #FFCDD2; color: #B71C1C; border: 1px solid #E57373; }
        
        /* Gap-Fill */
        .word-bank { background: #E8EAF6; border: 2px solid var(--color-secondary); border-radius: 10px; }
        .word-options { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .word-option {
            background-color: var(--color-secondary); color: white; padding: 10px 15px;
            border-radius: 6px; cursor: pointer; transition: all 0.2s; font-weight: 600;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); border: none;
        }
        .word-option:hover { background-color: #311B92; transform: translateY(-2px); }
        .word-option.selected { background-color: var(--color-primary) !important; transform: scale(1.05); box-shadow: 0 0 0 4px #D1C4E9 !important; }
        .word-option.used { opacity: 0.4; pointer-events: none; background-color: #78909C; transform: none; }

        .gap-input {
            display: inline-block; text-align: center; padding: 0 10px; min-width: 100px; 
            height: 32px; line-height: 30px; background-color: #FFFFFF; border-bottom: 3px solid var(--color-primary); 
            border-radius: 4px; color: var(--color-primary); font-weight: 700; cursor: pointer; margin: 0 4px; transition: all 0.2s;
        }
        .gap-input:empty { background-color: #EDE7F6; }
        .gap-input.filled { background-color: #D1C4E9; border-bottom-color: var(--color-primary); }
        .gap-input.correct { background-color: #A9DFBF !important; border-color: #2E7D32 !important; color: #1B5E20 !important; font-style: normal; pointer-events: none; }
        .gap-input.incorrect { background-color: #EF9A9A !important; border-color: #C62828 !important; color: #B71C1C !important; font-style: normal; }

        /* Buttons & Save */
        .button-group { margin-top: 20px; display: flex; gap: 15px; justify-content: center; }
        .check-button {
            background: var(--color-primary); color: white; border: none; padding: 12px 25px;
            border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600;
            transition: all 0.3s; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .check-button:hover { background: #7E57C2; transform: translateY(-1px); }
        .reset-button { background: #78909C; }
        .reset-button:hover { background: #546E7A; }

        #save-words-section { background: #EDE7F6; border: 2px solid #D1C4E9; padding: 25px; border-radius: 12px; margin-top: 40px; text-align: center; }
        #save-words-btn {
            background-color: var(--color-save-btn); color: white; padding: 14px 30px;
            border-radius: 8px; font-weight: 600; cursor: pointer; transition: background-color 0.2s;
            display: block; width: 100%; border: none; box-shadow: 0 4px #311B92;
            text-transform: uppercase; font-size: 1.1em;
        }
        #save-words-btn:hover:not(:disabled) { background-color: #7E57C2; }
        #save-words-btn:active:not(:disabled) { box-shadow: 0 1px #311B92; transform: translateY(3px); }
        #save-words-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        #learned-words-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px; text-align: center; list-style: none; }
        #learned-words-list li {
            background: white; padding: 10px 15px; border-radius: 8px; border: 2px solid var(--color-primary);
            font-size: 0.95em; cursor: pointer; transition: all 0.2s; font-weight: 600; color: var(--color-primary);
        }
        #learned-words-list li:hover { transform: translateY(-2px); border-color: var(--color-secondary); color: var(--color-secondary); box-shadow: 0 4px 10px rgba(0,0,0,0.05); background-color: #F3E5F5; }

        /* Popups */
        #feedback-popup {
            position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%);
            padding: 25px 40px; border-radius: 16px; font-weight: 700; color: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 2000; display: none;
            text-align: center; font-size: 1.3em; border: 4px solid white; min-width: 300px;
        }
        #dictionary-popup {
            position: fixed; max-width: 280px; padding: 16px; background: #FFFFFF;
            border: 3px solid var(--color-primary); border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15); z-index: 2001; display: none;
            font-size: 0.95em; color: #1A237E; line-height: 1.5;
        }
        @media (max-width: 768px) { .user-greeting { display: none; } }
        
        .footer {
            background: #FFFFFF;
            border-top: 1px solid #E5E9F2;
            padding: 32px 20px;
            margin-top: 60px;
            text-align: center;
        }

        .footer-text {
            font-size: 14px;
            color: #718096;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <span class="logo">üåô</span>
                <a href="/intermediate/" class="site-title">English For Cool Dudes</a>
            </div>
            <div id="logged-out-buttons" class="header-buttons" style="display: none;">
                <a href="/login/" class="header-button login">Login</a>
                <a href="/signup/" class="header-button signup">Sign Up</a>
            </div>
            <div id="logged-in-buttons" class="header-buttons" style="display: none;">
                <span class="user-greeting" id="user-greeting">Hey Sleepy Dude! üëã</span>
                <a href="/dashboard-gamified/" class="header-button dashboard">My Dashboard</a>
                <button id="logout-btn" class="header-button logout">Sign Out</button>
            </div>
        </div>
    </header>

    <div class="container-main">
        <h1 class="lesson-main-title">üåô The Science of Sleep: Why We Dream</h1>
        <p class="text-lg text-gray-500 mb-8">Intermediate (B1-B2) | Topic: Science & Psychology</p>

        <main class="space-y-8">
            
            <section class="lesson-section shadow-lg">
                <h2 class="section-title">üìñ 1. Reading: The Mystery of Dreams</h2>
                <div class="reading-text">
                    <p class="mb-4">Every night, we enter a <span class="highlight-word" onclick="showDictionaryPopup(this, 'Mysterious')">mysterious</span> world where the impossible becomes possible. We fly through the sky, meet people from our past, and experience vivid adventures‚Äîall while lying still in our beds. This is the world of dreams, and scientists are still trying to understand why we dream at all.</p>

                    <p class="mb-4">Sleep is not just rest; it is a complex biological process that our bodies <span class="highlight-word" onclick="showDictionaryPopup(this, 'Undergo')">undergo</span> in several stages. During REM (Rapid Eye Movement) sleep, our brain activity <span class="highlight-word" onclick="showDictionaryPopup(this, 'Intensifies')">intensifies</span>, and this is when most dreaming occurs. Researchers believe dreams may help us <span class="highlight-word" onclick="showDictionaryPopup(this, 'Process')">process</span> emotions, consolidate memories, and prepare for future challenges.</p>

                    <p class="mb-4">One popular theory suggests that dreams act as a kind of mental <span class="highlight-word" onclick="showDictionaryPopup(this, 'Rehearsal')">rehearsal</span>. By simulating threatening situations in our dreams, our brains help us develop survival skills. Another theory <span class="highlight-word" onclick="showDictionaryPopup(this, 'Proposes')">proposes</span> that dreams are simply the brain's way of organizing information, like a computer <span class="highlight-word" onclick="showDictionaryPopup(this, 'Sorting')">sorting</span> files.</p>

                    <p class="mb-4">Interestingly, not everyone dreams in the same way. Some people have <span class="highlight-word" onclick="showDictionaryPopup(this, 'Lucid')">lucid</span> dreams, where they are aware they are dreaming and can even control the dream's narrative. Others experience <span class="highlight-word" onclick="showDictionaryPopup(this, 'Recurring')">recurring</span> dreams‚Äîthe same dream repeated over weeks, months, or even years.</p>

                    <p>While we still don't have all the answers, one thing is certain: sleep and dreams are <span class="highlight-word" onclick="showDictionaryPopup(this, 'Essential')">essential</span> to our physical and mental health. Without adequate sleep, our ability to think clearly, regulate emotions, and maintain our <span class="highlight-word" onclick="showDictionaryPopup(this, 'Immune')">immune</span> system becomes severely <span class="highlight-word" onclick="showDictionaryPopup(this, 'Impaired')">impaired</span>.</p>
                </div>
            </section>

            <section id="exercise-1" class="lesson-section shadow-lg">
                <h2 class="section-title">üîó 2. Vocabulary Memory Match</h2>
                <p class="text-gray-600 mb-6 font-medium">Match the word to its definition. Correct pairs will disappear!</p>

                <div id="vocab-match-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </section>
        
            <section id="exercise-2" class="lesson-section shadow-lg">
                <h2 class="section-title">‚ùì 3. Comprehension Check</h2>
                <p class="text-gray-600 mb-4 font-medium">Answer the questions based on the reading.</p>
                
                <div class="question" data-question="1">
                    <p class="font-semibold text-lg text-gray-600 mb-3">1. When does most dreaming occur?</p>
                    <ul class="options-list space-y-3 comp-btn-group" data-question="1">
                        <li class="option-button" data-correct="false">During deep sleep.</li>
                        <li class="option-button" data-correct="true">During REM sleep.</li>
                        <li class="option-button" data-correct="false">During the first hour of sleep.</li>
                    </ul>
                </div>
                
                <div class="question" data-question="2">
                    <p class="font-semibold text-lg text-gray-600 mb-3">2. What is a lucid dream?</p>
                    <ul class="options-list space-y-3 comp-btn-group" data-question="2">
                        <li class="option-button" data-correct="false">A nightmare that repeats frequently.</li>
                        <li class="option-button" data-correct="true">A dream where you know you are dreaming.</li>
                        <li class="option-button" data-correct="false">A dream about flying.</li>
                    </ul>
                </div>
                
                <div class="question" data-question="3">
                    <p class="font-semibold text-lg text-gray-600 mb-3">3. According to the text, what can happen without adequate sleep?</p>
                    <ul class="options-list space-y-3 comp-btn-group" data-question="3">
                        <li class="option-button" data-correct="false">You will have more dreams.</li>
                        <li class="option-button" data-correct="false">You will sleep better the next night.</li>
                        <li class="option-button" data-correct="true">Your thinking and immune system can be impaired.</li>
                    </ul>
                </div>

                <div class="button-group">
                    <button class="check-button" onclick="checkComprehension()">Check Answers</button>
                    <button class="check-button reset-button" onclick="resetComprehension()">Reset Exercise</button>
                </div>
                <div id="comprehension-result" class="result-message"></div>
            </section>

            <section id="exercise-3" class="lesson-section shadow-lg">
                <h2 class="section-title">üìù 4. Complete the Sentences</h2>
                <p class="text-gray-600 mb-6 font-medium">Use the words from the word bank to complete the sentences.</p>
                
                <div class="word-bank p-4 mb-6">
                    <h4 class="font-bold text-gray-600 mb-3 w-full text-center text-xs uppercase">Word Bank</h4>
                    <div class="word-options" id="gap-fill-options">
                        <span class="word-option" data-word="undergo">undergo</span>
                        <span class="word-option" data-word="process">process</span>
                        <span class="word-option" data-word="essential">essential</span>
                        <span class="word-option" data-word="recurring">recurring</span>
                        <span class="word-option" data-word="proposes">proposes</span>
                        <span class="word-option" data-word="impaired">impaired</span>
                    </div>
                </div>

                <div class="gap-fill-text text-lg leading-loose space-y-4">
                    <p>1. Sleep is <span class="gap-input" data-answer="essential">____</span> for good health and mental performance.</p>
                    <p>2. The new theory <span class="gap-input" data-answer="proposes">____</span> that dreams help us solve problems.</p>
                    <p>3. It takes time to <span class="gap-input" data-answer="process">____</span> difficult emotions after a stressful event.</p>
                    <p>4. I keep having a <span class="gap-input" data-answer="recurring">____</span> dream about being back in school.</p>
                    <p>5. Patients must <span class="gap-input" data-answer="undergo">____</span> several tests before the surgery.</p>
                    <p>6. Lack of sleep left his judgment severely <span class="gap-input" data-answer="impaired">____</span>.</p>
                </div>
                <div class="button-group">
                    <button class="check-button" onclick="checkGaps()">Check Answers</button>
                    <button class="check-button reset-button" onclick="resetGaps()">Reset Exercise</button>
                </div>
                <div id="gap-result" class="result-message"></div>
            </section>

            <section class="lesson-section shadow-lg border-t-4 border-purple-800">
                <h2 class="section-title">üéâ Lesson Complete!</h2>
                <p class="mb-4 text-gray-600">Great job! Here are the words you learned today:</p>
                
                <ul id="learned-words-list">
                    <li data-word="Mysterious">Mysterious</li>
                    <li data-word="Undergo">Undergo</li>
                    <li data-word="Intensifies">Intensifies</li>
                    <li data-word="Process">Process</li>
                    <li data-word="Rehearsal">Rehearsal</li>
                    <li data-word="Proposes">Proposes</li>
                    <li data-word="Sorting">Sorting</li>
                    <li data-word="Lucid">Lucid</li>
                    <li data-word="Recurring">Recurring</li>
                    <li data-word="Essential">Essential</li>
                    <li data-word="Immune">Immune</li>
                    <li data-word="Impaired">Impaired</li>
                </ul>

                <div id="save-words-section">
                    <h3 class="text-xl font-bold mb-3" style="color: var(--color-save-btn);">üíæ Save Your Progress</h3>
                    
                    <div id="save-feature-loggedin" style="display: none;">
                        <p class="text-gray-700 mb-4">Save these words to your dashboard to practice later!</p>
                        <button id="save-words-btn" onclick="saveWordsToDashboard()">Save Words to Dashboard</button>
                        <p id="save-status" class="text-center mt-3 font-semibold"></p>
                    </div>
                    
                    <div id="login-prompt" style="display: none;">
                        <p class="text-red-600 font-bold mb-2">üîí Login to save your progress!</p>
                        <a href="/login/" class="inline-block bg-gray-800 text-white font-bold py-2 px-4 rounded hover:bg-black transition">Log In / Sign Up</a>
                    </div>
                </div>
            </section>

        </main>
        <footer class="footer">
            <p class="footer-text">¬© 2026 English For Cool Dudes - üòé</p>
            <div style="margin-top: 10px;">
                <a href="/impressum/" style="color: #667EEA; margin-right: 15px; text-decoration: none;">Impressum</a>
                <a href="/datenschutz/" style="color: #667EEA; text-decoration: none;">Datenschutzerkl√§rung</a>
            </div>
        </footer>
    </div>
    
    <div id="feedback-popup"></div>
    <div id="dictionary-popup"></div>

    <script>
        // --- CONFIG ---
        const SUPABASE_URL = 'https://knwgmrgwbpchqyqxbxea.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtud2dtcmd3YnBjaHF5cXhieGVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MDkyODgsImV4cCI6MjA3ODA4NTI4OH0.qnp2ScwSE77_idmPhpLE98sr46WvLpKtg6refFfC7s8';
        
        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentUser = null;

        const lessonTitle = "The Science of Sleep: Why We Dream";
        const lessonLink = "/sleepscience/";
        const lessonLevel = "B1-B2";

        const wordsToSave = [
            { word: "Mysterious", type: "adjective", definition: "Difficult to understand or explain; strange." },
            { word: "Undergo", type: "verb", definition: "To experience or go through something, especially a change or medical treatment." },
            { word: "Intensifies", type: "verb", definition: "Becomes stronger or more extreme." },
            { word: "Process", type: "verb", definition: "To deal with or work through information, emotions, or experiences mentally." },
            { word: "Rehearsal", type: "noun", definition: "Practice or preparation for a future event." },
            { word: "Proposes", type: "verb", definition: "Suggests an idea or theory for consideration." },
            { word: "Sorting", type: "verb", definition: "Organizing or arranging things into categories." },
            { word: "Lucid", type: "adjective", definition: "Clear and easy to understand; in dreams, being aware you are dreaming." },
            { word: "Recurring", type: "adjective", definition: "Happening repeatedly over time." },
            { word: "Essential", type: "adjective", definition: "Absolutely necessary; extremely important." },
            { word: "Immune", type: "adjective", definition: "Protected against disease; relating to the body's defense system." },
            { word: "Impaired", type: "adjective", definition: "Weakened, damaged, or made less effective." }
        ];

        // --- AUTH ---
        async function checkUser() {
            try {
                const { data: { user } } = await sb.auth.getUser();
                if (user) {
                    currentUser = user;
                    document.getElementById('logged-in-buttons').style.display = 'flex';
                    document.getElementById('logged-out-buttons').style.display = 'none';
                    document.getElementById('save-feature-loggedin').style.display = 'block';
                    document.getElementById('login-prompt').style.display = 'none';
                    const name = user.user_metadata.full_name ? user.user_metadata.full_name.split(' ')[0] : 'Cool Dude';
                    document.getElementById('user-greeting').textContent = `Hey ${name}! üëã`;
                } else {
                    document.getElementById('logged-in-buttons').style.display = 'none';
                    document.getElementById('logged-out-buttons').style.display = 'flex';
                    document.getElementById('save-feature-loggedin').style.display = 'none';
                    document.getElementById('login-prompt').style.display = 'block';
                }
            } catch (err) { console.error(err); }
        }

        async function saveWordsToDashboard() {
            if (!currentUser) return;
            const btn = document.getElementById('save-words-btn');
            const status = document.getElementById('save-status');
            btn.disabled = true; btn.textContent = "Saving...";

            const { error } = await sb.from('lessons').upsert([{
                user_id: currentUser.id, lesson_title: lessonTitle, lesson_link: lessonLink,
                lesson_level: lessonLevel, vocabulary: wordsToSave, completed_at: new Date().toISOString()
            }], { onConflict: 'user_id,lesson_title' });

            if (!error) {
                btn.textContent = "‚úÖ Saved!"; btn.style.backgroundColor = "#2E7D32";
                status.textContent = "Words saved! Check your dashboard.";
                setTimeout(() => window.location.href = '/dashboard/', 1500);
            } else {
                btn.textContent = "‚ùå Error"; btn.disabled = false;
                status.textContent = "Error saving. Please try again.";
            }
        }
        
        async function saveMistake(word) {
            if(!currentUser) return;
            const wObj = wordsToSave.find(w=>w.word.toLowerCase()===word.toLowerCase()) || {word: word, definition:'Review this word', type:'word'};
            await sb.from('user_mistakes').upsert({
                user_id: currentUser.id, word: wObj.word, definition: wObj.definition, word_type: wObj.type,
                lesson: lessonTitle, lesson_link: lessonLink, last_made_at: new Date().toISOString()
            }, {onConflict: 'user_id,word'});
        }

        document.getElementById('logout-btn').addEventListener('click', async () => {
            await sb.auth.signOut(); window.location.href = '/';
        });

        // --- UTILS ---
        function showFeedback(msg, type) {
            const el = document.getElementById('feedback-popup');
            el.textContent = msg; el.style.display = 'block';
            el.style.backgroundColor = type === 'correct' ? '#2E7D32' : '#D32F2F';
            el.style.borderColor = type === 'correct' ? '#1B5E20' : '#B71C1C';
            setTimeout(() => { el.style.display = 'none'; }, 1800);
        }

        function showDictionaryPopup(target, word) {
            const searchWord = word.toLowerCase();
            const wordObj = wordsToSave.find(w => w.word.toLowerCase() === searchWord);
            
            const popup = document.getElementById('dictionary-popup');
            if(wordObj) popup.innerHTML = `<strong>${wordObj.word}</strong> <span style="font-size:0.85em; color:#5E35B1;">(${wordObj.type})</span><br>${wordObj.definition}`;
            else popup.innerHTML = `<strong>${word}</strong><br>Click to see meaning.`;
            
            popup.style.display = 'block';
            const rect = target.getBoundingClientRect();
            let topPos = rect.top - popup.offsetHeight - 10;
            if (topPos < 10) topPos = rect.bottom + 10;
            popup.style.top = topPos + 'px';
            popup.style.left = (rect.left + (rect.width/2) - (popup.offsetWidth/2)) + 'px';
        }
        document.body.addEventListener('click', (e) => {
            if (!e.target.closest('#dictionary-popup') && !e.target.closest('#learned-words-list li') && !e.target.closest('.highlight-word')) {
                document.getElementById('dictionary-popup').style.display = 'none';
            }
        });

        // --- EXERCISES ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        function cleanText(text) { return text ? text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z]/g, '').toLowerCase() : ''; }

        /* MATCHING */
        const newVocabData = [
            { type: 'term', content: "Mysterious", key: 'A' }, { type: 'definition', content: "Strange and difficult to explain.", key: 'A' },
            { type: 'term', content: "Undergo", key: 'B' }, { type: 'definition', content: "To experience or go through.", key: 'B' },
            { type: 'term', content: "Process", key: 'C' }, { type: 'definition', content: "To mentally work through information.", key: 'C' },
            { type: 'term', content: "Lucid", key: 'D' }, { type: 'definition', content: "Clear; aware in a dream.", key: 'D' },
            { type: 'term', content: "Essential", key: 'E' }, { type: 'definition', content: "Absolutely necessary.", key: 'E' },
            { type: 'term', content: "Impaired", key: 'F' }, { type: 'definition', content: "Weakened or damaged.", key: 'F' }
        ];
        let selectedTermCard = null, selectedDefinitionCard = null, matchedPairs = 0;

        const funCorrect = [
            "Dream team! üåô", 
            "Perfect match! ‚ú®", 
            "Nailed it! üí´", 
            "Brilliant! üß†"
        ];
        const funIncorrect = [
            "Not quite! üí≠", 
            "Try again! üåü", 
            "Keep going! üîÑ", 
            "Almost! üí™"
        ];

        function initVocab() {
            const matchContainer = document.getElementById('vocab-match-container');
            matchContainer.innerHTML = ''; shuffleArray(newVocabData);
            newVocabData.forEach(item => {
                const card = document.createElement('div'); 
                card.className = `match-card interactive-element ${item.type}`;
                card.innerHTML = item.type === 'term' ? `<span class="font-extrabold">${item.content}</span>` : `<span>${item.content}</span>`; 
                card.dataset.key = item.key; card.dataset.type = item.type;
                card.addEventListener('click', () => handleMatchClick(card));
                matchContainer.appendChild(card);
            });
            selectedTermCard = null; selectedDefinitionCard = null; matchedPairs = 0;
        }

        function handleMatchClick(card) {
            if (card.classList.contains('matched')) return;
            const type = card.dataset.type;
            let currentSelection = type === 'term' ? selectedTermCard : selectedDefinitionCard;
            if (currentSelection) currentSelection.classList.remove('selected');
            if (currentSelection === card) {
                if (type === 'term') selectedTermCard = null; else selectedDefinitionCard = null;
                return;
            }
            if (type === 'term') selectedTermCard = card; else selectedDefinitionCard = card;
            card.classList.add('selected');

            if (selectedTermCard && selectedDefinitionCard) {
                if (selectedTermCard.dataset.key === selectedDefinitionCard.dataset.key) {
                    [selectedTermCard, selectedDefinitionCard].forEach(el => { el.classList.remove('selected'); el.classList.add('temp-matched'); });
                    showFeedback(funCorrect[Math.floor(Math.random() * funCorrect.length)], 'correct');
                    
                    const t = selectedTermCard; const d = selectedDefinitionCard;
                    setTimeout(() => {
                        t.classList.remove('temp-matched'); t.classList.add('matched');
                        d.classList.remove('temp-matched'); d.classList.add('matched');
                    }, 800);

                    matchedPairs++;
                    if(matchedPairs === newVocabData.length / 2) {
                        setTimeout(() => {
                            showFeedback("üéâ All matched! Excellent work!", 'correct');
                            setTimeout(() => {
                                document.querySelectorAll('.match-card').forEach((card, index) => {
                                    setTimeout(() => {
                                        card.classList.remove('matched');
                                    }, index * 100);
                                });
                                matchedPairs = 0;
                            }, 1000);
                        }, 1000);
                    }
                    selectedTermCard = null; selectedDefinitionCard = null;
                } else {
                    showFeedback(funIncorrect[Math.floor(Math.random() * funIncorrect.length)], 'incorrect');
                    const w = selectedTermCard; const d = selectedDefinitionCard;
                    setTimeout(() => { w.classList.remove('selected'); d.classList.remove('selected'); }, 500);
                    selectedTermCard = null; selectedDefinitionCard = null;
                }
            }
        }

        /* COMPREHENSION */
        function checkComprehension() {
            const questions = document.querySelectorAll('.question[data-question="1"], .question[data-question="2"], .question[data-question="3"]'); 
            let correctAnswers = 0;
            questions.forEach(q => {
                const selected = q.querySelector('.option-button.selected');
                q.querySelectorAll('.option-button').forEach(opt => {
                    opt.classList.remove('correct', 'incorrect');
                    if (opt.dataset.correct === 'true') opt.classList.add('correct');
                });
                if (selected) {
                    if (selected.dataset.correct === 'true') correctAnswers++; 
                    else {
                        selected.classList.add('incorrect');
                        const qNum = q.dataset.question;
                        if(qNum === '1') saveMistake('intensifies');
                        else if(qNum === '2') saveMistake('lucid');
                        else if(qNum === '3') saveMistake('impaired');
                    }
                }
            });
            const resultDiv = document.getElementById('comprehension-result'); resultDiv.style.display = 'block';
            if (correctAnswers === questions.length) { resultDiv.textContent = 'üéâ Perfect! All correct!'; resultDiv.className = 'result-message correct'; }
            else { resultDiv.textContent = `You got ${correctAnswers}/${questions.length} correct.`; resultDiv.className = 'result-message incorrect'; }
        }
        
        function resetComprehension() {
            document.querySelectorAll('.question[data-question="1"] .option-button, .question[data-question="2"] .option-button, .question[data-question="3"] .option-button').forEach(item => item.classList.remove('selected', 'correct', 'incorrect'));
            document.getElementById('comprehension-result').style.display = 'none';
        }

        /* GAP FILL */
        let selectedGapWord = null; 
        
        function initGaps() {
            const wordOptionsContainer = document.getElementById('gap-fill-options');
            const options = Array.from(wordOptionsContainer.children);
            shuffleArray(options);
            options.forEach(option => { wordOptionsContainer.appendChild(option); option.classList.remove('used', 'selected'); });
            document.querySelectorAll('.gap-input').forEach(blank => { blank.textContent = ''; blank.classList.remove('correct', 'incorrect', 'selected'); });
            selectedGapWord = null; document.getElementById('gap-result').style.display = 'none';
        }
        
        function handleGapBlankClick(blank) {
            if (blank.textContent.trim() === '') {
                 if (selectedGapWord) {
                    blank.textContent = selectedGapWord.textContent.trim();
                    selectedGapWord.classList.remove('selected'); 
                    selectedGapWord.classList.add('used');
                    selectedGapWord = null;
                }
                return;
            }

            const currentText = cleanText(blank.textContent); 
            const allOptions = Array.from(document.querySelectorAll('.word-option'));
            const matchingBtn = allOptions.find(btn => cleanText(btn.textContent) === currentText);
            
            if (matchingBtn) {
                matchingBtn.classList.remove('used');
            }

            blank.textContent = ''; 
            blank.classList.remove('correct', 'incorrect', 'filled'); 
        }

        function checkGaps() {
            let correctCount = 0; 
            const blanks = document.querySelectorAll('.gap-input'); 
            
            blanks.forEach(blank => { 
                const answerWord = blank.dataset.answer;
                const extractedWord = blank.textContent.trim();
                
                const cleanExtracted = cleanText(extractedWord);
                const cleanAnswer = cleanText(answerWord);

                blank.classList.remove('selected', 'incorrect', 'correct');
                
                if (extractedWord === '') {
                } else if (cleanExtracted === cleanAnswer) { 
                    blank.classList.add('correct'); 
                    correctCount++; 
                } else { 
                    blank.classList.add('incorrect');
                    saveMistake(answerWord); 
                }
            });

            const resultDiv = document.getElementById('gap-result'); 
            resultDiv.style.display = 'block';
            
            if (correctCount === blanks.length) { 
                resultDiv.textContent = 'üéâ Perfect! All correct!'; 
                resultDiv.className = 'result-message correct'; 
            } else { 
                resultDiv.textContent = `You got ${correctCount}/${blanks.length} correct.`; 
                resultDiv.className = 'result-message incorrect'; 
            }
        }

        function resetGaps() {
            selectedGapWord = null;
            document.getElementById('gap-result').style.display = 'none';
            const wordOptions = document.querySelectorAll('.word-option');
            wordOptions.forEach(opt => {
                opt.classList.remove('used', 'selected');
            });
            const blanks = document.querySelectorAll('.gap-input');
            blanks.forEach(blank => {
                blank.textContent = '';
                blank.classList.remove('correct', 'incorrect', 'selected', 'filled');
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            checkUser(); initVocab(); initGaps();
            document.querySelectorAll('#learned-words-list li').forEach(li => li.addEventListener('click', (e) => { e.stopPropagation(); showDictionaryPopup(li, li.dataset.word); }));
            
            document.querySelectorAll('.option-button').forEach(item => item.addEventListener('click', () => {
                item.closest('.question').querySelectorAll('.option-button').forEach(opt => opt.classList.remove('selected', 'correct', 'incorrect'));
                item.classList.add('selected'); 
                const questionNum = item.closest('.question').dataset.question;
                if(questionNum <= 3) document.getElementById('comprehension-result').style.display = 'none';
            }));
            
            document.querySelectorAll('.word-option').forEach(option => option.addEventListener('click', () => {
                if (option.classList.contains('used')) return;
                if (selectedGapWord) selectedGapWord.classList.remove('selected');
                if (selectedGapWord === option) selectedGapWord = null;
                else { selectedGapWord = option; selectedGapWord.classList.add('selected'); }
            }));
            
            document.querySelectorAll('.gap-input').forEach(blank => blank.addEventListener('click', () => handleGapBlankClick(blank)));
        });
    </script>
</body>
</html>
