<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Taste of Britain: An Advanced English Lesson (Cool Dudes Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- BRANDING & LAYOUT STYLES (Cleaned for V2) --- */
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap');
        :root {
            /* Cool Dudes Palette */
            --color-primary: #1A5E7F; /* Deep Blue */
            --color-secondary: #28A745; /* Success Green/Teal */
            --color-accent: #FFC107; /* Amber/Highlight (for selection) */
            --color-background: #F8F9FB; /* Light Gray-Blue */
            --color-text: #2C3E50; /* Dark Blue-Gray */
        }
        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
            line-height: 1.6;
        }
        /* --- BRANDED HEADER (English For Cool Dudes) --- */
        .header {
            background: #FFFFFF;
            border-bottom: 1px solid #E5E9F2;
            padding: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            text-decoration: none;
            color: #2C3E50;
        }
        .logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #FFC107 0%, #FF9800 100%); 
            color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 900;
        }
        .site-title {
            font-size: 20px;
            font-weight: 900;
            color: #1A202C;
            letter-spacing: -0.02em;
        }
        .container-main {
            max-width: 900px;
            margin: 30px auto;
            padding: 30px 20px;
            background-color: #FFFFFF;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #E5E9F2;
        }
        /* SECTION STYLING: Removed sidebar colors */
        .lesson-section {
            background-color: #F8F9FB;
            padding: 30px;
            border-radius: 10px;
            border: 1px solid #E5E9F2;
            margin-bottom: 2rem;
            position: relative; /* Needed for match-success-badge positioning */
        }
        .section-title {
            color: var(--color-primary);
            font-size: 1.8em;
            font-weight: 800;
            margin-bottom: 20px;
            padding-bottom: 5px;
            border-bottom: 2px dashed #E5E9F2;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .section-number {
            background: var(--color-primary);
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            font-weight: 900;
        }

        /* --- Content/Activity Styles --- */
        .reading-passage, .grammar-box {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #E5E9F2;
        }
        .reading-passage p {
            margin-bottom: 15px;
            text-align: justify;
        }
        .discussion-questions li {
            margin: 10px 0;
            font-size: 1.1em;
            line-height: 1.6;
            padding-left: 10px;
            list-style: disc;
            color: var(--color-primary);
        }
        .discussion-questions {
            padding-left: 20px;
        }
        /* General Question/Option Box for Multiple Choice */
        .question-box {
            background: #ffffff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #E5E9F2; /* Clean border, removed left color */
            transition: all 0.2s;
        }
        .question-box p {
             font-weight: 700;
        }
        .options-list { 
            list-style: none; 
            display: flex; 
            flex-direction: column; 
            gap: 5px;
            font-weight: 600;
        }
        .option-item {
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #E0E0E0;
            background-color: #f0f8ff;
        }
        .option-item:hover:not(.correct):not(.incorrect) {
            background-color: #e0f0ff;
        }
        .option-item.selected { 
            box-shadow: 0 0 0 3px var(--color-accent); 
            transform: translateY(-1px); 
            border-color: var(--color-accent) !important; 
        }
        .option-item.correct {
            background-color: #e6ffe6;
            color: var(--color-secondary);
            border: 1px solid var(--color-secondary);
        }
        .option-item.incorrect {
            background-color: #ffe6e6;
            color: #E74C3C;
            border: 1px solid #E74C3C;
        }
        
        /* Matching Styles */
        .matching-section {
            display: flex;
            flex-direction: column; 
            gap: 20px;
        }
        @media (min-width: 640px) { 
            .matching-section {
                flex-direction: row;
            }
        }
        .matching-list {
            flex: 1;
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .matching-item, .matching-target {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-radius: 0.375rem;
            transition: all 0.2s;
            border: 2px solid #E0E0E0;
            font-weight: 600;
            user-select: none;
            text-align: left;
        }
        .matching-item { background-color: #f0f8ff; }
        .matching-target { background-color: #f7fff5; }
        .selected-item, .selected-target { 
            box-shadow: 0 0 0 3px var(--color-accent); 
            transform: translateY(-2px); 
            border-color: var(--color-accent) !important; 
        }

        /* Custom Colors for Matched Pairs */
        .matched { pointer-events: none; opacity: 0.8; }
        .matched-color-0 { background-color: #e9d5ff !important; color: #5B21B6 !important; border-color: #a855f7 !important; }
        .matched-color-1 { background-color: #ccfbf1 !important; color: #0f766e !important; border-color: #14b8a6 !important; }
        .matched-color-2 { background-color: #e0e7ff !important; color: #3730a3 !important; border-color: #4f46e5 !important; }
        .matched-color-3 { background-color: #fce7f3 !important; color: #9d174d !important; border-color: #ec4899 !important; }

        /* --- Feedback Animations/Styles --- */
        
        /* 1. Flash Red for Incorrect Match */
        @keyframes flash-red {
            0% { background-color: #ffe6e6; border-color: #E74C3C; transform: scale(1.02); }
            50% { background-color: #fff; border-color: #E0E0E0; }
            100% { background-color: #ffe6e6; border-color: #E74C3C; }
        }
        .flash-incorrect {
            animation: flash-red 0.5s ease-in-out;
            border: 2px solid #E74C3C !important;
        }

        /* 2. Correct Match Pop-up/Animation (Mobile-friendly ephemeral badge) */
        @keyframes pop-success {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            30% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(0.9); opacity: 0; }
        }
        .match-success-badge {
            position: absolute;
            top: 50%;
            left: 50%;
            background: var(--color-secondary);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 1.1em;
            font-weight: 900;
            pointer-events: none;
            animation: pop-success 1s forwards;
            z-index: 10;
        }

        /* --- NEW: Responsive Video Embed Fix (16:9 Aspect Ratio) --- */
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio (9 / 16 = 0.5625) */
            height: 0;
            overflow: hidden;
            max-width: 100%;
            margin-bottom: 15px;
            border-radius: 8px; /* Optional: Looks good */
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); /* Optional: Looks good */
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%; 
            height: 100%; 
            border: 0;
        }
        /* --- End Responsive Video Fix --- */


        /* True/False Styles */
        .true-false-item {
            background: #ffffff;
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            border: 2px solid #E5E9F2;
        }
        .tf-buttons { display: flex; gap: 10px; margin-top: 10px; }
        .tf-btn { 
            flex: 1; padding: 10px; border: none; border-radius: 6px; 
            font-size: 1em; cursor: pointer; transition: all 0.2s; 
            font-weight: 700;
        }
        .tf-btn.true-btn { background: #e6ffe6; color: var(--color-secondary); border: 1px solid #d1ffd1; }
        .tf-btn.false-btn { background: #ffe6e6; color: #E74C3C; border: 1px solid #ffd1d1; }
        .tf-btn.selected { box-shadow: 0 0 0 3px var(--color-accent); }
        .true-false-item.correct { background: #f0fff0; border: 4px solid var(--color-secondary); }
        .true-false-item.incorrect { background: #fff0f0; border: 4px solid #E74C3C; }

        /* Gap-Fill Styles */
        .wordbank { 
            display: flex; flex-wrap: wrap; gap: 10px; margin: 20px 0; 
            padding: 15px; background: #eef2f5; border-radius: 8px; 
            border: 1px dashed #ced4da; 
        }
        .word-chip { 
            padding: 8px 15px; background: var(--color-primary); color: white; 
            border-radius: 20px; cursor: pointer; transition: all 0.2s; 
            font-weight: 600; user-select: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .word-chip.used { background: #ccc; cursor: not-allowed; opacity: 0.5; }
        .word-chip.selected-word { 
            background: var(--color-accent) !important; color: var(--color-text) !important; 
            box-shadow: 0 0 0 3px var(--color-primary); transform: scale(1.1); 
        }
        .gap-fill-text { line-height: 2.2; font-size: 1.1em; }
        .gap { 
            display: inline-block; min-width: 120px; padding: 5px 10px; 
            border: 2px dashed #999; border-radius: 4px; cursor: pointer; 
            font-weight: 700; text-align: center; color: #555;
            transition: all 0.2s;
        }
        .gap.filled { 
            border-style: solid; color: var(--color-primary); 
            background: #f0f8ff; border-color: var(--color-primary); 
            cursor: pointer; /* Changed to pointer so user can click to unfill */
        }
        .gap.correct { background: #e6ffe6; border-color: var(--color-secondary); color: var(--color-secondary);}
        .gap.incorrect { background: #ffe6e6; border-color: #E74C3C; color: #E74C3C; }

        /* General UI/Button Styles */
        .button {
            background-color: var(--color-primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 700;
            transition: background-color 0.2s, transform 0.1s;
            display: block;
            width: 100%;
            margin-top: 20px;
            box-shadow: 0 3px #104358;
        }
        .button:hover {
            background-color: #104358;
        }
        .button:active {
            box-shadow: 0 1px #104358;
            transform: translateY(2px);
        }
        .button.secondary {
            background-color: #B0BEC5;
            box-shadow: 0 3px #607D8B;
            margin-bottom: 20px;
        }
        .button.secondary:hover {
            background-color: #607D8B;
        }
        .button.secondary:active {
             box-shadow: 0 1px #607D8B;
        }
        .result-message {
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-weight: 700;
            display: none;
        }
        .result-message.success {
            background-color: #e6ffe6;
            color: var(--color-secondary);
            border: 1px solid var(--color-secondary);
        }
        .result-message.error {
            background-color: #ffe6e6;
            color: #E74C3C;
            border: 1px solid #E74C3C;
        }
    </style>
</head>
<body>
    <header class="header">
        <a href="advanced.html" class="header-content">
            <div class="logo">😎</div>
            <div class="site-title">English For Cool Dudes</div>
        </a>
    </header>

    <main class="container-main">
        <h1 class="text-3xl sm:text-4xl font-black text-gray-800 mb-6 text-center text-red-500">A Taste of Britain: An Advanced English Lesson</h1>

        <div class="lesson-section" id="vocab-exercise">
            <h2 class="section-title"><span class="section-number">1</span> Vocabulary Matching</h2>
            <p>Match the word or phrase to its correct definition.</p>
            
            <div class="matching-section">
                <ul class="matching-list vocab-terms" data-list-type="term">
                    <li class="matching-item" data-term="culinary_heritage">Culinary Heritage</li>
                    <li class="matching-item" data-term="fry_up">Fry-up</li>
                    <li class="matching-item" data-term="caramelised">Caramelised</li>
                    <li class="matching-item" data-term="shortcrust_pastry">Shortcrust Pastry</li>
                </ul>
                <ul class="matching-list vocab-definitions" data-list-type="definition">
                    <li class="matching-target" data-target="shortcrust_pastry">A type of dough made from flour, butter, and eggs.</li>
                    <li class="matching-target" data-target="culinary_heritage">The cooking traditions of a country handed down over time.</li>
                    <li class="matching-target" data-target="fry_up">A casual, slang term for a Full English Breakfast.</li>
                    <li class="matching-target" data-target="caramelised">A cooking process that makes vegetables or sugars brown and sweet.</li>
                </ul>
            </div>
            <div id="vocab-result" class="result-message"></div>
        </div>

        <div class="lesson-section" id="reading-exercise">
            <h2 class="section-title"><span class="section-number">2</span> Reading Comprehension</h2>
            
            <div class="reading-passage mb-6">
                <h3 class="text-xl font-bold text-gray-700 mb-3">Before you watch the video, read this summary of what you're about to learn.</h3>
                <p>British cuisine has a rich and varied culinary heritage that goes far beyond just fish and chips. A traditional Full English Breakfast, often called a "fry-up," is a hearty dish that includes sausages, bacon, eggs, and more. It's often celebrated for the quality of its ingredients. The sandwich, a British invention, is famous around the world and was supposedly created by a man who wanted to eat without leaving the gambling table. Another classic is the Sunday Roast, which features meat, roasted vegetables, and a delicious side dish known as Yorkshire pudding. British food also includes unique dishes like "bubble and squeak," made from leftover vegetables.</p>
            </div>

            <div class="question-box" data-correct-value="B" data-id="mc-q1">
                <p>1. What is another name for a Full English Breakfast?</p>
                <ul class="options-list">
                    <li class="option-item" data-value="A">A. A Sunday Roast.</li>
                    <li class="option-item" data-value="B">B. A fry-up.</li>
                    <li class="option-item" data-value="C">C. Bubble and squeak.</li>
                </ul>
            </div>
            <div class="question-box" data-correct-value="A" data-id="mc-q2">
                <p>2. What is the sandwich named after?</p>
                <ul class="options-list">
                    <li class="option-item" data-value="A">A. A man who wanted to eat while gambling.</li>
                    <li class="option-item" data-value="B">B. A popular type of bread.</li>
                    <li class="option-item" data-value="C">C. A small village in Britain.</li>
                </ul>
            </div>
            <div class="question-box" data-correct-value="B" data-id="mc-q3">
                <p>3. What is considered a classic side dish for a Sunday Roast?</p>
                <ul class="options-list">
                    <li class="option-item" data-value="A">A. Chips not crisps.</li>
                    <li class="option-item" data-value="B">B. Yorkshire pudding.</li>
                    <li class="option-item" data-value="C">C. Custard.</li>
                </ul>
            </div>
            
            <div id="reading-result" class="result-message"></div>
            <button class="button" onclick="checkMultipleChoice('reading-exercise')">Check Answers</button>
            <button class="button secondary" onclick="resetMultipleChoice('reading-exercise')">Reset</button>
        </div>

        <div class="lesson-section" id="video-intro-section">
            <h2 class="section-title"><span class="section-number">3</span> Video: The British Food Story</h2>
            
            <div class="video-container">
                <iframe src="https://www.youtube.com/embed/zaEvM3BPfFU?si=XPLY0E2-CDBJl3dn" 
                        title="YouTube video player" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                        allowfullscreen></iframe>
            </div>
            <p>This lesson is designed to improve your vocabulary, listening skills, and understanding of British culture. Watch the video above about the British love for food, and then complete the exercises below.</p>
        </div>

        <div class="lesson-section" id="true-false-exercise">
            <h2 class="section-title"><span class="section-number">4</span> True or False (Listening)</h2>
            <p>Based on the video, decide if the following statements are true or false.</p>
            
            <div class="true-false-item" data-correct-value="true" data-id="tf-q1">
                <p>1. Black pudding is a dish enjoyed for centuries, made from pig's blood.</p>
                <div class="tf-buttons">
                    <button class="tf-btn true-btn" data-value="true">True</button>
                    <button class="tf-btn false-btn" data-value="false">False</button>
                </div>
            </div>
            <div class="true-false-item" data-correct-value="true" data-id="tf-q2">
                <p>2. The Sunday Roast tradition started with the king providing his guards with beef.</p>
                <div class="tf-buttons">
                    <button class="tf-btn true-btn" data-value="true">True</button>
                    <button class="tf-btn false-btn" data-value="false">False</button>
                </div>
            </div>
            <div class="true-false-item" data-correct-value="false" data-id="tf-q3">
                <p>3. Max Halley's rule for a delicious sandwich is to eat it with cutlery.</p>
                <div class="tf-buttons">
                    <button class="tf-btn true-btn" data-value="true">True</button>
                    <button class="tf-btn false-btn" data-value="false">False</button>
                </div>
            </div>
            
            <div id="true-false-result" class="result-message"></div>
            <button class="button" onclick="checkTrueFalse()">Check Answers</button>
            <button class="button secondary" onclick="resetTrueFalse()">Reset</button>
        </div>
        
        <div class="lesson-section" id="gap-fill-exercise">
            <h2 class="section-title"><span class="section-number">5</span> Gap-Fill</h2>
            <p>Click the words in the box to fill the gaps in the sentences below, or click a filled gap to change your answer.</p>
            
            <div class="wordbank" id="word-bank">
                <div class="word-chip" data-word="caramelised">caramelised</div>
                <div class="word-chip" data-word="Beefeaters">Beefeaters</div>
                <div class="word-chip" data-word="squeaks">squeaks</div>
                <div class="word-chip" data-word="ingredients">ingredients</div>
                <div class="word-chip" data-word="fry-up">fry-up</div>
            </div>
            
            <div class="gap-fill-text">
                <p>1. The name "bubble and squeak" comes from the sounds it makes while frying, as it bubbles and <span class="gap" id="gap1" data-correct-word="squeaks"></span>.</p>
                <p>2. The Full English Breakfast is also known as a <span class="gap" id="gap2" data-correct-word="fry-up"></span>.</p>
                <p>3. One of the main <span class="gap" id="gap3" data-correct-word="ingredients"></span> in the pie is <span class="gap" id="gap4" data-correct-word="caramelised"></span> onions.</p>
                <p>4. The British royal guards were nicknamed "<span class="gap" id="gap5" data-correct-word="Beefeaters"></span>" because they were supplied with weekly rations of beef.</p>
            </div>
            
            <div id="gap-result" class="result-message"></div>
            <button class="button" onclick="checkGaps()">Check Answers</button>
            <button class="button secondary" onclick="resetGaps()">Reset</button>
        </div>

        <div class="lesson-section" id="grammar-exercise">
            <h2 class="section-title"><span class="section-number">6</span> Grammar Focus: Passive Voice</h2>
            <p>Complete the sentences by clicking the correct passive voice verb option.</p>
            
            <div class="question-box mb-6" data-correct-value="were nicknamed" data-id="g-q1">
                <p class="grammar-question">
                    1. It is believed that the king's guards <span class="font-bold text-gray-500">...</span> "Beefeaters".
                </p>
                <ul class="options-list">
                    <li class="option-item" data-value="were nicknamed">A. were nicknamed</li>
                    <li class="option-item" data-value="were nicknaming">B. were nicknaming</li>
                </ul>
            </div>
            
            <div class="question-box mb-6" data-correct-value="is prepared" data-id="g-q2">
                <p class="grammar-question">
                    2. The meat for the Sunday Roast <span class="font-bold text-gray-500">...</span> with rosemary, thyme, and garlic.
                </p>
                <ul class="options-list">
                    <li class="option-item" data-value="is preparing">A. is preparing</li>
                    <li class="option-item" data-value="is prepared">B. is prepared</li>
                </ul>
            </div>
            
            <div class="question-box mb-6" data-correct-value="is stuffed" data-id="g-q3">
                <p class="grammar-question">
                    3. Black pudding <span class="font-bold text-gray-500">...</span> by hand into natural casings.
                </p>
                <ul class="options-list">
                    <li class="option-item" data-value="is stuffed">A. is stuffed</li>
                    <li class="option-item" data-value="has stuffed">B. has stuffed</li>
                </ul>
            </div>
            
            <div id="grammar-result" class="result-message"></div>
            <button class="button" onclick="checkGrammar()">Check Answers</button>
            <button class="button secondary" onclick="resetGrammar()">Reset</button>
        </div>
        
        <div class="lesson-section" id="idiom-exercise">
            <h2 class="section-title"><span class="section-number">7</span> Food Idioms</h2>
            <p>Match the idiom with its correct meaning.</p>
            
            <div class="matching-section">
                <ul class="matching-list idiom-terms" data-list-type="term">
                    <li class="matching-item" data-term="spill_the_beans">Spill the beans</li>
                    <li class="matching-item" data-term="have_egg_on_your_face">Have egg on your face</li>
                    <li class="matching-item" data-term="as_easy_as_pie">As easy as pie</li>
                    <li class="matching-item" data-term="bring_home_the_bacon">Bring home the bacon</li>
                </ul>
                <ul class="matching-list idiom-definitions" data-list-type="definition">
                    <li class="matching-target" data-target="have_egg_on_your_face">To be embarrassed by something you've said or done.</li>
                    <li class="matching-target" data-target="as_easy_as_pie">Very easy to do.</li>
                    <li class="matching-target" data-target="bring_home_the_bacon">To earn money for your family.</li>
                    <li class="matching-target" data-target="spill_the_beans">To reveal a secret.</li>
                </ul>
            </div>
            <div id="idiom-result" class="result-message"></div>
        </div>

        <div class="lesson-section" id="discussion-section">
            <h2 class="section-title"><span class="section-number">8</span> Discussion</h2>
            <p>Ready to put your knowledge to the test? Use these questions to start a discussion with a partner or classmate.</p>
            <ul class="discussion-questions">
                <li>What is your favourite type of British food, and why?</li>
                <li>How do food traditions in your country compare to those in the UK?</li>
                <li>What are some food idioms in your language, and what do they mean?</li>
            </ul>
        </div>
        
    </main>

    <script>
        // --- DATA OBJECTS ---
        const vocabPairs = {
            'culinary_heritage': 'The cooking traditions of a country handed down over time.',
            'fry_up': 'A casual, slang term for a Full English Breakfast.',
            'caramelised': 'A cooking process that makes vegetables or sugars brown and sweet.',
            'shortcrust_pastry': 'A type of dough made from flour, butter, and eggs.'
        };
        const idiomPairs = {
            'spill_the_beans': 'To reveal a secret.',
            'have_egg_on_your_face': 'To be embarrassed by something you\'ve said or done.',
            'as_easy_as_pie': 'Very easy to do.',
            'bring_home_the_bacon': 'To earn money for your family.'
        };
        const gapFillAnswers = {
            'gap1': 'squeaks',
            'gap2': 'fry-up',
            'gap3': 'ingredients',
            'gap4': 'caramelised',
            'gap5': 'Beefeaters'
        };
        const matchingColors = [0, 1, 2, 3]; // Color set indices

        // --- CORE UTILITY FUNCTIONS ---
        
        function displayResultMessage(id, message, isSuccess) {
            const resultEl = document.getElementById(id);
            resultEl.textContent = message;
            resultEl.classList.remove('success', 'error');
            resultEl.classList.add(isSuccess ? 'success' : 'error');
            resultEl.style.display = 'block';
        }
        
        // --- MATCHING LOGIC (Implemented: Correct Pop-up, Incorrect Flash/Deselect) ---
        
        let selectedTerm = null;
        let selectedDefinition = null;
        let matchedCount = 0;
        let totalPairs = 0;

        function checkMatch(term, definition, pairs, resultId) {
            const isCorrect = pairs[term.dataset.term] === definition.textContent.trim();
            const colorIndex = matchedCount % matchingColors.length;

            if (isCorrect) {
                term.classList.remove('selected-item');
                definition.classList.remove('selected-target');

                const colorClass = `matched-color-${colorIndex}`;
                term.classList.add('matched', colorClass);
                definition.classList.add('matched', colorClass);

                matchedCount++;
                
                // NEW: Correct Match Visual Feedback Pop-up
                const successBadge = document.createElement('div');
                successBadge.className = 'match-success-badge';
                successBadge.textContent = 'Correct! 👍';
                
                // Append to the section container
                const parentSection = term.closest('.lesson-section');
                parentSection.appendChild(successBadge); 

                // Positioning logic (Center the badge on the page)
                setTimeout(() => {
                    successBadge.remove();
                }, 1000); // Remove after 1 second
                
            } else {
                // NEW: Incorrect Flash and Deselect Logic
                
                term.classList.add('flash-incorrect');
                definition.classList.add('flash-incorrect');
                
                setTimeout(() => {
                    term.classList.remove('flash-incorrect');
                    definition.classList.remove('flash-incorrect');
                    
                    // Crucial: remove selected classes after the flash to deselect
                    term.classList.remove('selected-item'); 
                    definition.classList.remove('selected-target');
                }, 500);
            }
            
            // Clear selections after check attempt, regardless of outcome
            selectedTerm = null;
            selectedDefinition = null;
        }

        function handleMatchingClick(e, pairs, resultId) {
            const item = e.target.closest('.matching-item, .matching-target');
            if (!item || item.classList.contains('matched')) return;

            const listType = item.parentElement.dataset.listType;

            if (listType === 'term') {
                // Check for deselection
                if (item.classList.contains('selected-item')) {
                    item.classList.remove('selected-item');
                    selectedTerm = null;
                    return;
                }
                
                // Clear existing selection for this list type
                document.querySelectorAll('.vocab-terms .selected-item, .idiom-terms .selected-item').forEach(el => el.classList.remove('selected-item'));
                item.classList.add('selected-item');
                selectedTerm = item;
            } else {
                // Check for deselection
                if (item.classList.contains('selected-target')) {
                    item.classList.remove('selected-target');
                    selectedDefinition = null;
                    return;
                }
                
                // Clear existing selection for this list type
                document.querySelectorAll('.vocab-definitions .selected-target, .idiom-definitions .selected-target').forEach(el => el.classList.remove('selected-target'));
                item.classList.add('selected-target');
                selectedDefinition = item;
            }

            // Check for a complete pair
            if (selectedTerm && selectedDefinition) {
                checkMatch(selectedTerm, selectedDefinition, pairs, resultId);
            }
        }

        function addMatchingListeners(exerciseId, pairs) {
            const section = document.getElementById(`${exerciseId}-exercise`);
            if (!section) return;

            const termsList = section.querySelector(`.${exerciseId}-terms`);
            const definitionsList = section.querySelector(`.${exerciseId}-definitions`);

            if (!termsList || !definitionsList) return;

            totalPairs = Object.keys(pairs).length;
            
            termsList.addEventListener('click', (e) => handleMatchingClick(e, pairs, `${exerciseId}-result`));
            definitionsList.addEventListener('click', (e) => handleMatchingClick(e, pairs, `${exerciseId}-result`));
        }

        // --- MULTIPLE CHOICE/GRAMMAR LOGIC (Fixes Grammar Interactivity) ---

        function checkMultipleChoice(sectionId) {
            const section = document.getElementById(sectionId);
            const questions = section.querySelectorAll('.question-box');
            let correctCount = 0;
            let totalQuestions = questions.length;

            questions.forEach(qBox => {
                const qId = qBox.dataset.id;
                const options = qBox.querySelectorAll('.option-item');
                let selected = null;

                options.forEach(option => {
                    option.classList.remove('correct', 'incorrect');
                    if (option.classList.contains('selected')) {
                        selected = option;
                    }
                });

                if (selected) {
                    // For Reading Comp, the correct answer is the data-correct-value attribute (A, B, C).
                    // For Grammar (Passive Voice), the correct answer is the data-correct-value attribute (the verb string).
                    const selectedValue = selected.dataset.value;
                    const correctAnswer = qBox.dataset.correctValue;

                    if (selectedValue === correctAnswer) {
                        selected.classList.add('correct');
                        correctCount++;
                    } else {
                        selected.classList.add('incorrect');
                    }
                }
            });

            const message = `You got ${correctCount} out of ${totalQuestions} correct!`;
            displayResultMessage(`${sectionId.split('-')[0]}-result`, message, correctCount === totalQuestions);
        }

        function resetMultipleChoice(sectionId) {
            document.getElementById(sectionId).querySelectorAll('.option-item').forEach(option => {
                option.classList.remove('selected', 'correct', 'incorrect');
            });
            document.getElementById(`${sectionId.split('-')[0]}-result`).style.display = 'none';
        }

        function addMultipleChoiceListeners() {
            document.querySelectorAll('.question-box').forEach(qBox => {
                qBox.querySelectorAll('.option-item').forEach(option => {
                    option.addEventListener('click', () => {
                        // Clear selected from all options in this question
                        qBox.querySelectorAll('.option-item').forEach(o => o.classList.remove('selected'));
                        option.classList.add('selected');
                        // Clear result classes on selection change
                        option.classList.remove('correct', 'incorrect');
                    });
                });
            });
        }
        
        window.checkGrammar = () => checkMultipleChoice('grammar-exercise');
        window.resetGrammar = () => resetMultipleChoice('grammar-exercise');
        
        // --- TRUE/FALSE LOGIC ---

        function checkTrueFalse() {
            const section = document.getElementById('true-false-exercise');
            const items = section.querySelectorAll('.true-false-item');
            let correctCount = 0;
            let totalQuestions = items.length;
            
            items.forEach(item => {
                const correctAnswer = item.dataset.correctValue;
                const selectedButton = item.querySelector('.tf-btn.selected');
                
                item.classList.remove('correct', 'incorrect');
                
                if (selectedButton) {
                    const selectedValue = selectedButton.dataset.value;
                    if (selectedValue === correctAnswer) {
                        item.classList.add('correct');
                        correctCount++;
                    } else {
                        item.classList.add('incorrect');
                    }
                } else {
                     item.classList.add('incorrect');
                }
            });

            const message = `You got ${correctCount} out of ${totalQuestions} correct!`;
            displayResultMessage('true-false-result', message, correctCount === totalQuestions);
        }

        function resetTrueFalse() {
            document.querySelectorAll('.true-false-item').forEach(item => {
                item.classList.remove('correct', 'incorrect');
                item.querySelectorAll('.tf-btn').forEach(btn => btn.classList.remove('selected'));
            });
            document.getElementById('true-false-result').style.display = 'none';
        }
        
        function addTrueFalseListeners() {
            document.querySelectorAll('.true-false-item').forEach(item => {
                item.querySelectorAll('.tf-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        // Clear selected from all buttons in the same item
                        item.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('selected'));
                        e.target.classList.add('selected');
                        // Clear result classes on selection change
                        item.classList.remove('correct', 'incorrect');
                    });
                });
            });
        }
        
        // --- GAP FILL LOGIC (Implemented: Deselection & Unfilling) ---
        
        let selectedWordChip = null;

        function handleWordSelection(e) {
            const chip = e.target.closest('.word-chip');
            if (!chip || chip.classList.contains('used')) return;

            // NEW: Deselect if the same chip is clicked
            if (selectedWordChip === chip) {
                chip.classList.remove('selected-word');
                selectedWordChip = null;
                return;
            }

            // Deselect previous word
            if (selectedWordChip) {
                selectedWordChip.classList.remove('selected-word');
            }

            // Select new word
            chip.classList.add('selected-word');
            selectedWordChip = chip;
        }

        function handleGapClick(e) {
            const gap = e.target.closest('.gap');
            if (!gap) return;

            // NEW: If the gap is filled, allow clicking to empty it and return the word to the bank
            if (gap.classList.contains('filled')) {
                const word = gap.dataset.filledWith;
                document.querySelector(`.word-chip[data-word="${word}"]`).classList.remove('used');
                gap.textContent = '';
                gap.dataset.filledWith = '';
                gap.classList.remove('filled', 'correct', 'incorrect');
                document.getElementById('gap-result').style.display = 'none'; // Clear feedback
                return;
            }

            // Original logic for filling the gap
            if (!selectedWordChip) return; // No word selected to place

            const word = selectedWordChip.dataset.word;
            
            // Place the word
            gap.textContent = word;
            gap.dataset.filledWith = word;
            gap.classList.add('filled');
            
            // Mark the chip as used and clear selection
            selectedWordChip.classList.add('used');
            selectedWordChip.classList.remove('selected-word');
            selectedWordChip = null;
        }

        function checkGaps() {
            const gaps = document.querySelectorAll('.gap');
            let correctCount = 0;
            let totalQuestions = gaps.length;

            gaps.forEach(gap => {
                const filledWord = gap.dataset.filledWith;
                const correctWord = gapFillAnswers[gap.id];

                gap.classList.remove('correct', 'incorrect');

                if (filledWord && filledWord.toLowerCase() === correctWord.toLowerCase()) {
                    gap.classList.add('correct');
                    correctCount++;
                } else {
                    gap.classList.add('incorrect');
                }
            });

            const message = `You got ${correctCount} out of ${totalQuestions} correct!`;
            displayResultMessage('gap-result', message, correctCount === totalQuestions);
        }

        function resetGaps() {
            document.querySelectorAll('.gap').forEach(gap => {
                gap.textContent = '';
                gap.dataset.filledWith = '';
                gap.classList.remove('filled', 'correct', 'incorrect');
            });
            document.querySelectorAll('.word-chip').forEach(chip => {
                chip.classList.remove('used', 'selected-word');
            });
            selectedWordChip = null;
            document.getElementById('gap-result').style.display = 'none';
        }
        
        // --- INITIALIZATION ---
        
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Matching (Activity 1 & 7)
            addMatchingListeners('vocab', vocabPairs);
            addMatchingListeners('idiom', idiomPairs);
            
            // Initialize Multiple Choice/Grammar (Activity 2 & 6)
            addMultipleChoiceListeners();
            
            // Initialize True/False (Activity 4)
            addTrueFalseListeners();

            // Initialize Gap Fill (Activity 5)
            document.getElementById('word-bank').addEventListener('click', handleWordSelection);
            document.querySelectorAll('.gap').forEach(gap => {
                gap.addEventListener('click', handleGapClick);
            });
        });

    </script>
</body>
</html>
