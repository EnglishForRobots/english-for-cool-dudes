<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
    <link rel="apple-touch-icon" href="/images/icon-180.png" sizes="180x180">
    <link rel="icon" type="image/png" href="/images/icon-192.png" sizes="192x192">

    <link rel="manifest" href="/manifest.json">
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Communication: Culture Quest - English For Cool Dudes</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- BASE & LAYOUT STYLES (Matching New Site) --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: #F8F9FB; /* Light background */
            color: #2C3E50;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* Header (Global Nav Bar) - ENSURING CONSISTENCY */
        .header {
            background: #FFFFFF;
            border-bottom: 1px solid #E5E9F2;
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }

      .header-wrapper {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
}

.header-link {
    display: flex;
    align-items: center;
    gap: 15px;
    text-decoration: none;
    color: #2C3E50;
}

.header-link:hover {
    opacity: 0.9;
}

.header-content:hover {
     opacity: 0.9; /* Subtle visual feedback on hover */
}

        .logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%); /* Consistent Gradient */
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .site-title {
            font-size: 20px;
            font-weight: 800;
            color: #1A202C;
            letter-spacing: -0.02em;
        }


        /* Main Container for Lesson */
        .container-main {
            max-width: 900px;
            margin: 30px auto;
            padding: 30px 20px;
            background-color: #FFFFFF; /* White card background */
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #E5E9F2;
        }

        /* Lesson Specific Styles */
        .lesson-main-title {
            font-size: 2.5em;
            font-weight: 800;
            color: #2980B9; /* Theme Color: Bright Blue */
            margin-bottom: 10px;
            letter-spacing: -0.02em;
        }

        .lesson-section {
            background-color: #F8F9FB; /* Very light background for content */
            padding: 30px;
            border-radius: 10px;
            border: 1px solid #E5E9F2;
        }

        .section-title {
            color: #2980B9; /* Primary Blue for headers */
            font-size: 1.8em;
            font-weight: 800;
            margin-bottom: 20px;
            padding-bottom: 5px;
            border-bottom: 2px dashed #E5E9F2;
        }
        
        /* Progress Bar */
        .progress-bar-container {
            width: 100%;
            background: #E5E9F2;
            border-radius: 9999px; /* Full rounded */
            height: 10px;
            margin-top: 10px;
        }

        .progress-bar-fill {
            background: linear-gradient(90deg, #2980B9 0%, #3498DB 100%); /* Blue Gradient */
            height: 10px;
            border-radius: 9999px;
            transition: width 0.5s ease;
        }

        /* --- INTERACTIVE ELEMENT STYLES --- */
        .interactive-element {
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid #E5E9F2;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            background-color: #FFFFFF;
            color: #2C3E50;
            font-weight: 600;
            padding: 12px 18px;
            border-radius: 8px;
            text-align: center;
        }

        .interactive-element:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
            border-color: #2980B9; /* Blue hover outline */
        }
        
        /* Quiz/Matching Options */
        .quiz-option, .term-btn, .meaning-btn {
            background-color: #FFFFFF;
            color: #2C3E50;
            font-weight: 600;
        }

        /* True/False Buttons */
        .tf-btn {
            background: #FFFFFF !important;
            color: #2C3E50 !important;
            border: 2px solid #E5E9F2;
            font-weight: 700;
            padding: 12px 25px;
            border-radius: 25px;
        }
        .tf-btn:hover {
            border-color: #2980B9;
        }

        /* Matching Specific Colors */
        .match-color-1 { background-color: #2ECC71 !important; border-color: #2ECC71 !important; color: white !important; } /* Emerald */
        .match-color-2 { background-color: #9B59B6 !important; border-color: #9B59B6 !important; color: white !important; } /* Amethyst */
        .match-color-3 { background-color: #F1C40F !important; border-color: #F1C40F !important; color: white !important; } /* Sun Flower */
        .match-color-4 { background-color: #3498DB !important; border-color: #3498DB !important; color: white !important; } /* Peter River */
        .match-color-5 { background-color: #E74C3C !important; border-color: #E74C3C !important; color: white !important; } /* Alizarin */

        /* Match/Term Selection (Temporary) */
        .selected { background-color: #F39C12 !important; color: white !important; border-color: #F39C12 !important; } 

        /* Conversation Word Bank Items (fill-in-box) */
        .fill-in-box {
            background-color: #F0F3F7;
            border: 2px solid #E5E9F2;
            color: #2C3E50;
            font-weight: 600;
            padding: 10px 15px;
            min-width: 140px;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        /* Conversation Word Bank Selection */
        .fill-in-box.selected-word {
            background-color: #2980B9; /* Primary Blue */
            color: white;
            border-color: #2980B9;
        }
        
        /* Conversation Blanks (conversation-fill-box) */
        .conversation-fill-box {
            display: inline-block;
            text-align: center;
            padding: 6px 10px;
            min-width: 120px; /* Smaller width for inline flow */
            height: 38px;
            background-color: #E5E9F2; /* Light background for the gap */
            border: 1px dashed #AAB8C2; /* Dashed border for visual gap */
            border-radius: 4px;
            color: #2C3E50;
            font-style: italic;
            cursor: pointer;
            line-height: 24px; /* Center text vertically */
            vertical-align: middle;
            font-weight: 600;
        }

        .conversation-fill-box.correct-answer {
            background-color: #D4EDDA; /* Light green */
            border-color: #4CAF50; /* Darker green */
            color: #155724;
            pointer-events: none; /* Lock once correct */
        }

        .conversation-fill-box.incorrect-answer {
            background-color: #FADBD8; /* Light red */
            border-color: #E74C3C; /* Darker red */
            color: #721C24;
            animation: shake 0.5s;
        }

        /* General Feedback/Result Box */
        .result {
            padding: 15px;
            margin-top: 15px;
            border-radius: 8px;
            font-weight: 700;
        }

        .result.correct {
            background-color: #D4EDDA;
            color: #155724;
            border: 1px solid #C3E6CB;
        }

        .result.incorrect {
            background-color: #FADBD8;
            color: #721C24;
            border: 1px solid #F5C6CB;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }

    </style>
</head>
<body>
  <header class="header">
    <div class="header-wrapper">
        <a href="/business/" class="header-link">
            <div class="logo">üòé</div> 
            <span class="site-title">English For Cool Dudes</span> 
        </a>
    </div>
</header>
    <div class="container-main">

        <h1 class="lesson-main-title">Business Communication: Culture Quest</h1>
        <p class="text-lg text-gray-500 mb-8">Mastering High- and Low-Context Communication Styles</p>

        <div class="bg-gray-100 rounded-lg p-5 mb-8 border border-E5E9F2 shadow-sm">
            <div class="flex justify-between items-center mb-2">
                <span class="text-xl font-bold text-gray-700">Score: <span id="score">0</span></span>
                <span id="feedback-message" class="text-lg font-medium text-green-600 hidden"></span>
                <span class="text-sm text-gray-500" id="progress-text">0/5 activities complete</span>
            </div>
            <div class="progress-bar-container">
                <div id="progress-fill" class="progress-bar-fill" style="width: 0%;"></div>
            </div>
        </div>
        
        <main class="space-y-8">
            
            <section id="reading-section" class="lesson-section shadow-lg">
                <h2 class="section-title">üìñ Reading: Communication Across Cultures</h2>
                <div class="text-base space-y-4">
                    <p>When working with international colleagues, understanding their communication style is key. Anthropologist Edward T. Hall coined the terms **"high-context"** and **"low-context"** cultures to describe this difference. In a high-context culture, like Japan or China, much of the communication is implicit‚Äîmeaning is conveyed through non-verbal cues, shared history, and the surrounding context. A simple "yes" might not mean agreement, and a direct "no" is often avoided to preserve harmony. Therefore, it's crucial to read between the lines and pay attention to body language.</p>
                    <p>In contrast, a low-context culture, like Germany or the United States, relies on explicit communication. Information is conveyed primarily through direct language. Messages are clear, detailed, and to the point. What you say is what you mean. In these settings, being too indirect can be seen as evasive or confusing. As a business professional, adapting your style is essential for building trust and avoiding misinterpretations. For example, a project manager from a low-context culture might provide a detailed written plan, while their counterpart from a high-context culture might prefer a verbal discussion to build consensus.</p>
                </div>
                
                <div class="mt-6">
                    <h3 class="text-xl font-bold text-gray-700 mb-4">Quiz: Reading Check</h3>
                    <p class="text-gray-600 mb-4">According to the text, in which type of culture is a simple "yes" less likely to mean "agreement"?</p>
                    <div id="reading-quiz" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button onclick="checkReadingQuiz('A')" class="quiz-option interactive-element">A) A low-context culture</button>
                        <button onclick="checkReadingQuiz('B')" class="quiz-option interactive-element">B) A high-context culture</button>
                    </div>
                    <p id="reading-feedback" class="mt-4 text-sm font-medium"></p>
                </div>
            </section>

            <section id="true-false-section" class="lesson-section shadow-lg">
                <h2 class="section-title">‚öñÔ∏è True or False?</h2>
                <div class="space-y-4">
                    <p class="text-lg font-medium" id="tf-question">1. A high-context culture relies heavily on clear, explicit written communication.</p>
                    <div class="flex gap-4">
                        <button onclick="checkTrueFalse(true)" class="tf-btn interactive-element">True</button>
                        <button onclick="checkTrueFalse(false)" class="tf-btn interactive-element">False</button>
                    </div>
                    <p id="tf-feedback" class="text-sm italic text-gray-500"></p>
                </div>
            </section>
            
            <section id="idioms-section" class="lesson-section shadow-lg">
                <h2 class="section-title">üîó Match the Idiom to its Meaning</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div id="terms-column" class="flex flex-col gap-3">
                        <h3 class="font-bold text-gray-700 mb-2">Idioms</h3>
                        </div>
                    
                    <div id="meanings-column" class="flex flex-col gap-3">
                        <h3 class="font-bold text-gray-700 mb-2">Meaning</h3>
                        </div>
                </div>
                <p id="idioms-feedback" class="mt-4 text-sm font-medium"></p>
            </section>

            <section id="conversation-section" class="lesson-section shadow-lg">
                <h2 class="section-title">üí¨ Conversation: Fill in the Gaps</h2>
                <p class="text-gray-600 mb-4">Click a word from the bank and then click a gap. **To deselect a word, click the filled gap to return it.**</p>
                
                <div id="conversation-word-bank" class="flex flex-wrap gap-2 justify-center p-3 bg-white border border-E5E9F2 rounded-lg mb-6">
                    </div>
                
                <div id="conversation-text" class="text-base text-gray-700 space-y-3">
                    <p><strong>Alex (Low-Context):</strong> Okay, so let's finalize the <span class="conversation-fill-box" data-answer="detailed plan">...</span> before we leave the room. I need everything laid out clearly.</p>
                    <p><strong>Mei (High-Context):</strong> I hear you, Alex. However, the true path forward will be decided <span class="conversation-fill-box" data-answer="implicitly">...</span> after we've had more time to build trust. My culture views a very direct approach as too harsh.</p>
                    <p><strong>Alex:</strong> I see. I don't want any <span class="conversation-fill-box" data-answer="misinterpretation">...</span>, so I prefer clarity. But I respect your approach.</p>
                    <p><strong>Mei:</strong> Thank you. I offer my <span class="conversation-fill-box" data-answer="apologies">...</span> if my indirectness caused any confusion. Once we reach a mutual <span class="conversation-fill-box" data-answer="consensus">...</span>, you will see faster results.</p>
                </div>

                <button onclick="checkConversationBlanks()" class="interactive-element mt-6 px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-bold">Check Conversation</button>
                <p id="conversation-feedback" class="result hidden"></p>
            </section>

            <section id="fill-in-blanks-section" class="lesson-section shadow-lg">
                <h2 class="section-title">üìù Vocabulary: Complete the Sentences</h2>
                <p class="text-gray-600 mb-4">Place the correct word in each blank. **To deselect a word, click the filled gap to return it.**</p>
                
                <div id="fill-in-word-bank" class="flex flex-wrap gap-2 justify-center p-3 bg-white border border-E5E9F2 rounded-lg mb-6">
                    </div>

                <div id="fill-in-text" class="text-base text-gray-700 space-y-4">
                    <p>1. In high-context cultures, meaning is often conveyed through <span class="conversation-fill-box" data-answer="non-verbal cues">...</span> like body language and silence.</p>
                    <p>2. Communication that is not directly stated, but understood through context, is called <span class="conversation-fill-box" data-answer="implicit">...</span> communication.</p>
                    <p>3. Low-context communicators prefer <span class="conversation-fill-box" data-answer="explicit">...</span> language where every detail is clearly stated.</p>
                    <p>4. Being too indirect in a low-context setting might be interpreted as being <span class="conversation-fill-box" data-answer="evasive">...</span> or avoiding the topic.</p>
                    <p>5. A primary goal in many high-context interactions is maintaining social <span class="conversation-fill-box" data-answer="harmony">...</span>, often by avoiding confrontation.</p>
                </div>
                
                <button onclick="checkFillInBlanks()" class="interactive-element mt-6 px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-bold">Check Sentences</button>
                <p id="fill-in-feedback" class="result hidden"></p>
            </section>
            
        </main>
    </div>

    <script>
        // --- DATA SECTION ---
        let score = 0;
        let activityCount = 0;
        const totalActivities = 5;
        let readingDone = false;
        let tfDone = false;
        let idiomsDone = false;
        let conversationDone = false;
        let fillInDone = false;
        let selectedWordBankItem = null;
        let selectedTerm = null;
        let selectedMeaning = null;

        // Reading Quiz
        const readingCorrectAnswer = 'B';

        // True/False
        const tfCorrectAnswer = false; // False: High-context is implicit, not explicit written.

        // Idioms Matching
        const idioms = [
            { term: "Read between the lines", meaning: "Understand the hidden or implied meaning.", correct: false, matched: false, color: 'match-color-1' },
            { term: "Get down to business", meaning: "Start discussing the main or serious issues.", correct: false, matched: false, color: 'match-color-2' },
            { term: "Touch base", meaning: "Briefly make contact or check in with someone.", correct: false, matched: false, color: 'match-color-3' },
            { term: "On the same page", meaning: "Have a shared understanding of a situation.", correct: false, matched: false, color: 'match-color-4' },
            { term: "In the loop", meaning: "Kept informed about what is happening.", correct: false, matched: false, color: 'match-color-5' }
        ];

        // Conversation Fill-in
        const conversationWords = ["apologies", "misinterpretation", "consensus", "detailed plan", "implicitly"];
        const conversationOrder = ["detailed plan", "implicitly", "misinterpretation", "apologies", "consensus"];
        let userConversationWords = new Array(conversationOrder.length).fill(null);
        
        // Fill-in-blanks
        const fillInWords = ["explicit", "implicit", "non-verbal cues", "evasive", "harmony"];
        const fillInOrder = ["non-verbal cues", "implicit", "explicit", "evasive", "harmony"];
        let userFillInWords = new Array(fillInOrder.length).fill(null);
        
        // --- UTILITY FUNCTIONS ---
        function updateScore(points) {
            score += points;
            document.getElementById('score').textContent = score;
            const message = points > 0 ? `+${points} Points!` : `${points} Points.`;
            showTemporaryFeedback(message, points > 0 ? 'correct' : 'incorrect');
        }

        function updateProgress() {
            activityCount = [readingDone, tfDone, idiomsDone, conversationDone, fillInDone].filter(Boolean).length;
            const percentage = (activityCount / totalActivities) * 100;
            document.getElementById('progress-fill').style.width = `${percentage}%`;
            document.getElementById('progress-text').textContent = `${activityCount}/${totalActivities} activities complete`;

            if (activityCount === totalActivities) {
                setTimeout(() => {
                    alert(`Lesson Complete! Final Score: ${score}. Great work, you're officially a Business Communication Master!`);
                }, 500);
            }
        }

        function showTemporaryFeedback(message, type) {
            const feedbackEl = document.getElementById('feedback-message');
            feedbackEl.textContent = message;
            feedbackEl.className = `text-lg font-medium mt-4 ${type === 'correct' ? 'text-green-600' : 'text-red-600'}`;
            feedbackEl.style.display = 'block';
            setTimeout(() => {
                feedbackEl.style.display = 'none';
            }, 1500);
        }

        // --- ACTIVITY 1: READING QUIZ ---
        function checkReadingQuiz(answer) {
            if (readingDone) return;
            const feedbackEl = document.getElementById('reading-feedback');
            const quizOptions = document.querySelectorAll('#reading-quiz .quiz-option');

            quizOptions.forEach(btn => btn.classList.remove('correct-answer', 'incorrect-answer', 'bg-red-500', 'bg-green-500', 'text-white'));

            if (answer === readingCorrectAnswer) {
                feedbackEl.textContent = "Correct! High-context cultures often use indirect language.";
                feedbackEl.className = 'result correct';
                quizOptions[answer === 'A' ? 0 : 1].classList.add('correct-answer', 'match-color-1');
                if (!readingDone) {
                    updateScore(20);
                    readingDone = true;
                    updateProgress();
                }
            } else {
                feedbackEl.textContent = "Incorrect. Review the definition of high-context cultures.";
                feedbackEl.className = 'result incorrect';
                updateScore(-5);
            }
        }

        // --- ACTIVITY 2: TRUE/FALSE ---
        function checkTrueFalse(answer) {
            if (tfDone) return;
            const feedbackEl = document.getElementById('tf-feedback');
            
            if (answer === tfCorrectAnswer) {
                feedbackEl.textContent = "Correct! High-context relies on *implicit* context, not explicit written communication.";
                feedbackEl.className = 'result correct';
                if (!tfDone) {
                    updateScore(20);
                    tfDone = true;
                    updateProgress();
                }
            } else {
                feedbackEl.textContent = "Incorrect. High-context communication is subtle, not explicit.";
                feedbackEl.className = 'result incorrect';
                updateScore(-5);
            }
        }

        // --- ACTIVITY 3: IDIOMS MATCHING ---
        function setupIdioms() {
            const termsColumn = document.getElementById('terms-column');
            const meaningsColumn = document.getElementById('meanings-column');
            
            // Randomize terms and meanings independently
            const shuffledTerms = [...idioms];
            const shuffledMeanings = [...idioms].sort(() => 0.5 - Math.random());

            shuffledTerms.forEach((idiom, index) => {
                const termBtn = document.createElement('button');
                termBtn.textContent = idiom.term;
                termBtn.className = 'term-btn interactive-element text-left';
                termBtn.dataset.term = idiom.term;
                termBtn.onclick = () => selectTerm(termBtn, idiom.term, idiom.meaning);
                termsColumn.appendChild(termBtn);
            });

            shuffledMeanings.forEach((idiom, index) => {
                const meaningBtn = document.createElement('button');
                meaningBtn.textContent = idiom.meaning;
                meaningBtn.className = 'meaning-btn interactive-element text-left';
                meaningBtn.dataset.meaning = idiom.meaning;
                meaningBtn.dataset.correctTerm = idioms.find(i => i.meaning === idiom.meaning).term;
                meaningBtn.onclick = () => selectMeaning(meaningBtn, idiom.meaning, meaningBtn.dataset.correctTerm);
                meaningsColumn.appendChild(meaningBtn);
            });
        }

        function selectTerm(button, termText, correctMeaning) {
            if (idiomsDone || button.classList.contains('matched')) return;

            document.querySelectorAll('.term-btn').forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');
            selectedTerm = { button, text: termText, correctMeaning };
            
            checkMatch();
        }

        function selectMeaning(button, meaningText, correctTerm) {
            if (idiomsDone || button.classList.contains('matched')) return;

            document.querySelectorAll('.meaning-btn').forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');
            selectedMeaning = { button, text: meaningText, correctTerm };
            
            checkMatch();
        }

        function checkMatch() {
            const feedbackEl = document.getElementById('idioms-feedback');
            
            if (selectedTerm && selectedMeaning) {
                // Check if they match
                if (selectedTerm.text === selectedMeaning.correctTerm && selectedMeaning.text === selectedTerm.correctMeaning) {
                    
                    const matchedIdiom = idioms.find(i => i.term === selectedTerm.text);
                    const matchClass = matchedIdiom.color;

                    // Apply styles and classes to both buttons
                    selectedTerm.button.classList.remove('selected');
                    selectedTerm.button.classList.add('matched', matchClass);
                    selectedTerm.button.disabled = true;

                    selectedMeaning.button.classList.remove('selected');
                    selectedMeaning.button.classList.add('matched', matchClass);
                    selectedMeaning.button.disabled = true;

                    matchedIdiom.matched = true;
                    
                    feedbackEl.textContent = "Match found! Nicely done.";
                    feedbackEl.className = 'result correct';
                    updateScore(15);

                    // Clear selections for the next match
                    selectedTerm = null;
                    selectedMeaning = null;

                    // Check if all are done
                    if (idioms.every(i => i.matched)) {
                        feedbackEl.textContent = "üéâ All idioms matched correctly! (+30 Points)";
                        feedbackEl.className = 'result correct';
                        if (!idiomsDone) {
                            updateScore(30);
                            idiomsDone = true;
                            updateProgress();
                        }
                    }
                } else {
                    // INCORRECT MATCH: Clear both selections immediately
                    feedbackEl.textContent = "Oops, that's not a match. Try again!";
                    feedbackEl.className = 'result incorrect';
                    
                    // Shake and deselect the buttons for visual feedback
                    selectedTerm.button.classList.add('incorrect-answer');
                    selectedMeaning.button.classList.add('incorrect-answer');
                    
                    setTimeout(() => {
                        selectedTerm.button.classList.remove('selected', 'incorrect-answer');
                        selectedMeaning.button.classList.remove('selected', 'incorrect-answer');
                        selectedTerm = null;
                        selectedMeaning = null;
                        feedbackEl.textContent = "";
                        feedbackEl.className = '';
                    }, 500);

                    updateScore(-5);
                }
            } else {
                // Not enough selected to check
                feedbackEl.textContent = "Select one idiom and one meaning to match.";
                feedbackEl.className = 'result hidden';
            }
        }
        
        // --- ACTIVITY 4 & 5: GAP FILL (Conversation and Vocabulary) ---

        function setupGapFill() {
            // Setup Conversation Word Bank (Activity 4)
            const conversationBank = document.getElementById('conversation-word-bank');
            const shuffledConversationWords = [...conversationWords].sort(() => 0.5 - Math.random());
            shuffledConversationWords.forEach(word => {
                const btn = createWordBankButton(word, 'conversation');
                conversationBank.appendChild(btn);
            });

            // Setup Fill-in Word Bank (Activity 5)
            const fillInBank = document.getElementById('fill-in-word-bank');
            const shuffledFillInWords = [...fillInWords].sort(() => 0.5 - Math.random());
            shuffledFillInWords.forEach(word => {
                const btn = createWordBankButton(word, 'fill-in');
                fillInBank.appendChild(btn);
            });

            // Setup Conversation Blanks (Activity 4)
            document.querySelectorAll('#conversation-text .conversation-fill-box').forEach((blank, index) => {
                blank.dataset.index = index;
                blank.dataset.type = 'conversation';
                blank.onclick = () => fillBlank(blank, index, 'conversation');
            });
            
            // Setup Fill-in Blanks (Activity 5)
            document.querySelectorAll('#fill-in-text .conversation-fill-box').forEach((blank, index) => {
                blank.dataset.index = index;
                blank.dataset.type = 'fill-in';
                blank.onclick = () => fillBlank(blank, index, 'fill-in');
            });
        }
        
        function createWordBankButton(word, type) {
            const btn = document.createElement('button');
            btn.textContent = word;
            btn.className = 'fill-in-box interactive-element';
            btn.dataset.word = word;
            btn.dataset.type = type;
            btn.onclick = () => selectWord(btn, word);
            return btn;
        }

        // IMPROVED LOGIC: Ensure only one word can be selected at a time across both banks
        function selectWord(button, word) {
            
            // Clear any previously selected word in ANY bank
            document.querySelectorAll('.fill-in-box.selected-word').forEach(btn => {
                btn.classList.remove('selected-word');
            });

            // Toggle selection
            if (selectedWordBankItem && selectedWordBankItem.word === word) {
                // Deselect if clicking the already selected word
                selectedWordBankItem = null;
            } else {
                // Select the new word
                button.classList.add('selected-word');
                selectedWordBankItem = { button, word, type: button.dataset.type };
            }
        }
        
        // REVISED LOGIC FOR DESELECTION/CLEARING
        function fillBlank(blank, index, type) {
            // Do nothing if the answer is already marked correct (locked)
            if (blank.classList.contains('correct-answer')) return;

            const userArray = type === 'conversation' ? userConversationWords : userFillInWords;
            const bankId = type === 'conversation' ? 'conversation-word-bank' : 'fill-in-word-bank';
            
            // Helper function to return word to bank and clear blank
            const returnWordToBank = () => {
                if (blank.textContent) {
                    const wordToReturn = blank.textContent;
                    const correspondingButton = document.querySelector(`#${bankId} .fill-in-box[data-word="${wordToReturn}"]`);
                    if (correspondingButton) {
                        correspondingButton.style.display = 'block'; // Un-hide
                    }
                    blank.textContent = '';
                    blank.dataset.selectedWord = '';
                    blank.classList.remove('incorrect-answer'); // Clear any feedback classes
                    userArray[index] = null;
                }
            };
            
            // Case 1: Word bank item is selected AND it belongs to this activity's bank -> fill the blank (or swap words)
            if (selectedWordBankItem && selectedWordBankItem.type === type) {
                
                // If the blank is already filled, return its current word to the bank first (swap)
                if (blank.textContent) {
                    returnWordToBank();
                }
                
                // Place the new selected word
                blank.textContent = selectedWordBankItem.word;
                blank.dataset.selectedWord = selectedWordBankItem.word;
                userArray[index] = selectedWordBankItem.word;
                
                selectedWordBankItem.button.style.display = 'none'; // Hide word bank button
                selectedWordBankItem.button.classList.remove('selected-word');
                selectedWordBankItem = null;
                
            } 
            // Case 2: Blank is clicked and NO word is selected -> clear the blank (the desired deselect/clear functionality)
            else if (!selectedWordBankItem && blank.textContent) {
                returnWordToBank();
            }
        }

        function checkGapFill(type) {
            if ((type === 'conversation' && conversationDone) || (type === 'fill-in' && fillInDone)) return;

            const blanks = document.querySelectorAll(`#${type === 'conversation' ? 'conversation-text' : 'fill-in-text'} .conversation-fill-box`);
            const correctOrder = type === 'conversation' ? conversationOrder : fillInOrder;
            const feedbackEl = document.getElementById(`${type === 'conversation' ? 'conversation' : 'fill-in'}-feedback`);

            let correctCount = 0;
            let allCorrect = true;
            const totalGaps = blanks.length;

            blanks.forEach((blank, index) => {
                const selectedWord = blank.dataset.selectedWord ? blank.dataset.selectedWord.toLowerCase() : '';
                const answer = correctOrder[index].toLowerCase();
                
                // Remove existing result classes
                blank.classList.remove('correct-answer', 'incorrect-answer');

                if (selectedWord === answer) {
                    correctCount++;
                    blank.classList.add('correct-answer');
                } else if (selectedWord !== '') {
                    blank.classList.add('incorrect-answer');
                    allCorrect = false;
                } else {
                    allCorrect = false;
                }
            });

            if (allCorrect) {
                feedbackEl.textContent = `üéâ Spot On! You got all ${totalGaps} correct! (+30 Points)`;
                feedbackEl.classList.add('result', 'correct');
                feedbackEl.classList.remove('hidden', 'incorrect');
                if (type === 'conversation') {
                    conversationDone = true;
                } else {
                    fillInDone = true;
                }
                updateScore(30);
                updateProgress();
            } else {
                feedbackEl.textContent = `You got ${correctCount} out of ${totalGaps} correct. Review the words highlighted in red and click the incorrect word to remove it.`;
                feedbackEl.classList.add('result', 'incorrect');
                feedbackEl.classList.remove('hidden', 'correct');
                updateScore(-10);
            }
        }

        function checkConversationBlanks() {
            checkGapFill('conversation');
        }

        function checkFillInBlanks() {
            checkGapFill('fill-in');
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            setupIdioms();
            setupGapFill();
        });

    </script>
</body>
</html>
