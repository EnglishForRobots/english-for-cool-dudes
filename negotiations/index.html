
<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="/favicon.png" sizes="32x32">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">

    <link rel="manifest" href="/manifest.json">
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Negotiations: Getting to Yes - English For Cool Dudes</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- BASE & LAYOUT STYLES (Matching New Site) --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: #F8F9FB; /* Light background */
            color: #2C3E50;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* Header (Global Nav Bar) - Copied from Agile template */
        .header {
            background: #FFFFFF;
            border-bottom: 1px solid #E5E9F2;
            padding: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }

        /* UPDATED: .header-content now handles the link styling */
.header-content {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    text-decoration: none; /* Removes default link underline */
    color: #2C3E50; /* Ensures text color remains dark */
}

.header-content:hover {
     opacity: 0.9; /* Subtle visual feedback on hover */
}
        .logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .site-title {
            font-size: 20px;
            font-weight: 800;
            color: #1A202C;
            letter-spacing: -0.02em;
        }


        /* Main Container for Lesson */
        .container-main {
            max-width: 900px;
            margin: 30px auto;
            padding: 30px 20px;
            background-color: #FFFFFF; /* White card background */
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #E5E9F2;
        }

        /* Lesson Specific Styles */
        .lesson-main-title {
            font-size: 2.5em;
            font-weight: 800;
            color: #2980B9; /* Negotiations Theme Color: Bright Blue */
            margin-bottom: 10px;
            letter-spacing: -0.02em;
        }

        .lesson-section {
            background-color: #F8F9FB; /* Very light background for content */
            padding: 30px;
            border-radius: 10px;
            border: 1px solid #E5E9F2;
        }

        .section-title {
            color: #2980B9; /* Primary Blue for Negotiations headers */
            font-size: 1.8em;
            font-weight: 800;
            margin-bottom: 20px;
            padding-bottom: 5px;
            border-bottom: 2px dashed #E5E9F2;
        }
        
        /* Progress Bar */
        .progress-bar-container {
            width: 100%;
            background: #E5E9F2;
            border-radius: 9999px; /* Full rounded */
            height: 10px;
            margin-top: 10px;
        }

        .progress-bar-fill {
            background: linear-gradient(90deg, #2980B9 0%, #3498DB 100%); /* Blue Gradient */
            height: 10px;
            border-radius: 9999px;
            transition: width 0.5s ease;
        }

        /* --- INTERACTIVE ELEMENT STYLES --- */
        .interactive-element {
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid #E5E9F2;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            background-color: #FFFFFF;
            color: #2C3E50;
            font-weight: 600;
            padding: 12px 18px;
            border-radius: 8px;
        }

        .interactive-element:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
            border-color: #2980B9; /* Blue hover outline */
        }
        
        /* Quiz/Matching Options */
        .quiz-option, .term-btn, .meaning-btn, .idiom-btn {
            background-color: #FFFFFF;
            color: #2C3E50;
            font-weight: 600;
        }

        /* True/False Buttons */
        .tf-btn {
            background: #FFFFFF !important; /* Override inline style */
            color: #2C3E50 !important;
            border: 2px solid #E5E9F2;
            font-weight: 700;
            padding: 12px 25px;
            border-radius: 25px;
        }
        .tf-btn:hover {
            border-color: #2980B9;
        }
        
        /* New: Custom Classes for Cycling Colors (Light Theme Palette) */
        .match-color-1 { background-color: #2ECC71 !important; border-color: #2ECC71 !important; color: white !important; } /* Emerald */
        .match-color-2 { background-color: #9B59B6 !important; border-color: #9B59B6 !important; color: white !important; } /* Amethyst */
        .match-color-3 { background-color: #F1C40F !important; border-color: #F1C40F !important; color: white !important; } /* Sun Flower */
        .match-color-4 { background-color: #3498DB !important; border-color: #3498DB !important; color: white !important; } /* Peter River */
        
        /* Match/Term Selection (Temporary) */
        .selected { 
            background-color: #F39C12 !important; /* Orange/Sun Flower for selection */
            color: white !important;
            border-color: #F39C12 !important;
        }
        
        /* Conversation Word Bank Items (fill-in-box) */
        .fill-in-box {
            background-color: #F0F3F7;
            border: 2px solid #E5E9F2;
            color: #2C3E50;
            font-weight: 600;
            padding: 10px 15px; 
            min-width: 140px;
            border-radius: 6px;
            text-align: center;
        }
        
        /* Conversation Word Bank Selection */
        .fill-in-box.selected-word {
            background-color: #2980B9; /* Primary Blue */
            color: white;
            border-color: #2980B9;
        }

        /* Conversation Blanks (conversation-fill-box) */
        .conversation-fill-box {
            /* BIGGER GAPS */
            display: inline-block;
            min-width: 180px; /* Increased minimum width */
            padding: 8px 10px; 
            border-bottom: 2px dashed #2980B9; /* Blue Dash */
            color: #2980B9;
            font-weight: 700;
            background-color: #F0F3F7;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
        }

        /* Correct/Incorrect Answers */
        .correct-answer {
            background-color: #27AE60 !important; /* Green */
            color: white !important;
            border-color: #27AE60 !important;
            pointer-events: none;
            cursor: default;
        }
        .incorrect-answer {
            background-color: #E74C3C !important; /* Red */
            color: white !important;
            border-color: #E74C3C !important;
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        
        /* Check Answer Button (Conversation) */
        .check-button {
            background: linear-gradient(45deg, #2980B9 0%, #3498DB 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            margin-top: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(41, 128, 185, 0.4);
        }
        .check-button:hover {
            box-shadow: 0 6px 15px rgba(41, 128, 185, 0.5);
            transform: translateY(-1px);
        }
        /* Footer */
        .footer {
            background: #FFFFFF;
            border-top: 1px solid #E5E9F2;
            padding: 32px 20px;
            margin-top: 40px;
            text-align: center;
        }
        
    </style>
</head>
<body>

    <header class="header"> 
        <a href="/business/" class="header-content"> 
            <div class="logo">üòé</div> 
            <span class="site-title">English For Cool Dudes</span> 
        </a> 
    </header>

    <div class="container-main mx-auto max-w-6xl overflow-hidden my-10">

        <header class="text-center pb-8 mb-8 border-b border-gray-200">
            <p class="text-lg font-medium text-gray-500 mb-1">Essential Business English for Key Skills</p>
            <h1 class="lesson-main-title">ü§ù The Art of Negotiation</h1>
            <p class="text-xl text-gray-500">Mastering the vocabulary for getting to "Yes."</p>

            <div class="mt-6 flex justify-between text-sm font-semibold text-gray-600">
                <span id="progress-text">Progress: 0/4 activities complete</span>
                <span id="score-display">Score: 0</span>
            </div>
            <div class="progress-bar-container">
                <div id="progress-bar" class="progress-bar-fill" style="width: 0%"></div>
            </div>
             <span id="feedback-message" class="text-lg font-medium text-green-600 hidden"></span>
        </header>

        <main class="p-4 sm:p-6 md:p-10">
            
            <section id="reading-section" class="lesson-section shadow-lg mb-8">
                <h2 class="section-title">üìñ Reading: Strategies for Successful Negotiation</h2>
                <div class="text-gray-600 space-y-4 text-sm md:text-base">
                    <p>Successful negotiation is more than just haggling over price; it's about finding a mutually beneficial solution. One of the most effective strategies is to focus on **interests**, not just **positions**. A "**position**" is what you want (e.g., "I want to pay $50"), while an "**interest**" is why you want it (e.g., "I need to stay within a strict budget"). By understanding the underlying interests of the other party, you can brainstorm creative solutions that might satisfy both sides and lead to a **win-win** outcome.</p>
                    <p>Another key principle is to prepare a **BATNA**, or "Best Alternative To a Negotiated Agreement." Your BATNA is your plan B‚Äîwhat you will do if the negotiation fails. Having a strong BATNA gives you power and confidence. It allows you to **walk away** from a deal that is not in your best interest. Always enter a negotiation with a clear understanding of your own interests and a well-defined BATNA. Remember, a good deal for you is better than a perfect deal for them, but a good deal for both of you is a great outcome.</p>
                </div>
                <div class="mt-6 border-t border-gray-200 pt-4">
                    <h3 class="text-xl font-bold text-gray-600 mb-4">Quiz: Reading Check</h3>
                    <p class="text-gray-600 mb-4">According to the text, what is a "position" in negotiation?</p>
                    <div id="reading-quiz" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button onclick="checkReadingQuiz('A')" class="quiz-option interactive-element text-left">A) Your underlying reason for a request.</button>
                        <button onclick="checkReadingQuiz('B')" class="quiz-option interactive-element text-left">B) The specific request or demand you make.</button>
                    </div>
                    <p id="reading-feedback" class="mt-4 text-sm font-medium"></p>
                </div>
            </section>
            
            <section id="true-false-section" class="lesson-section shadow-lg mb-8">
                <h2 class="section-title">‚öñÔ∏è True or False?</h2>
                <div class="space-y-4">
                    <p class="text-lg font-medium text-gray-700" id="tf-question">1. A strong BATNA makes you less powerful in a negotiation.</p>
                    <div class="flex gap-4">
                        <button onclick="checkTrueFalse(true)" class="tf-btn interactive-element">True</button>
                        <button onclick="checkTrueFalse(false)" class="tf-btn interactive-element">False</button>
                    </div>
                    <p id="tf-feedback" class="text-sm italic text-gray-500"></p>
                </div>
            </section>

            <section id="idioms-section" class="lesson-section shadow-lg mb-8">
                <h2 class="section-title">üîó Exercise C: Negotiation Idioms Matching</h2>
                <p class="text-gray-600 text-center mb-6">Click an idiom, then click its meaning to make a match!</p>
                <div class="flex flex-col md:flex-row justify-center items-center gap-6">
                    <div id="idioms-list" class="grid grid-cols-1 md:grid-cols-1 gap-4 w-full md:w-1/2">
                        <button class="idiom-btn interactive-element" data-term="Haggling">Haggling</button>
                        <button class="idiom-btn interactive-element" data-term="To give ground">To give ground</button>
                        <button class="idiom-btn interactive-element" data-term="The bottom line">The bottom line</button>
                        <button class="idiom-btn interactive-element" data-term="To table a motion">To table a motion</button>
                    </div>
                    <div id="idiom-meanings-list" class="grid grid-cols-1 md:grid-cols-1 gap-4 w-full md:w-1/2">
                        <button class="meaning-btn interactive-element text-left" data-answer="The bottom line">The absolute minimum price or maximum concession you are willing to accept.</button>
                        <button class="meaning-btn interactive-element text-left" data-answer="Haggling">To dispute or bargain persistently over the cost of something.</button>
                        <button class="meaning-btn interactive-element text-left" data-answer="To table a motion">To postpone discussion or decision on an issue until a later date.</button>
                        <button class="meaning-btn interactive-element text-left" data-answer="To give ground">To make concessions or back down from an original demand or position.</button>
                    </div>
                </div>
                <div id="idiom-feedback" class="mt-4 p-3 rounded-lg text-center font-semibold hidden"></div>
            </section>
            
            <section id="conversation-section" class="lesson-section shadow-lg mb-8">
                <h2 class="section-title">üó£Ô∏è Exercise D: Conversation Practice</h2>
                <p class="text-gray-600 mb-4">Click a word from the bank, then click the blank to fill it. Click a filled blank to clear it.</p>
                
                <div id="conversation-options" class="flex flex-wrap gap-2 justify-center bg-gray-100 p-4 rounded-lg mb-6">
                    <button class="fill-in-box interactive-element" data-word="concession">concession</button>
                    <button class="fill-in-box interactive-element" data-word="walk-away">walk-away</button>
                    <button class="fill-in-box interactive-element" data-word="leverage">leverage</button>
                    <button class="fill-in-box interactive-element" data-word="mandate">mandate</button>
                    <button class="fill-in-box interactive-element" data-word="win-win">win-win</button>
                    <button class="fill-in-box interactive-element" data-word="counter-offer">counter-offer</button>
                    <button class="fill-in-box interactive-element" data-word="mutual">mutual</button>
                </div>

                <div id="conversation-text" class="text-lg text-gray-700 leading-relaxed space-y-4">
                    <p class="mb-4"><strong class="text-blue-600">PM:</strong> We need a solution that offers a <span class="conversation-fill-box interactive-element" data-answer="win-win" data-word-index="0"></span> result, but my <span class="conversation-fill-box interactive-element" data-answer="mandate" data-word-index="1"></span> prevents any more spending.</p>
                    <p class="mb-4"><strong class="text-red-600">Client:</strong> I can appreciate the constraint. If you can't increase the budget, what kind of **<span class="conversation-fill-box interactive-element" data-answer="concession" data-word-index="2"></span>** can you make on the timeline?</p>
                    <p class="mb-4"><strong class="text-blue-600">PM:</strong> We can expedite Phase 1. As a **<span class="conversation-fill-box interactive-element" data-answer="counter-offer" data-word-index="3"></span>**, could you offer faster payment terms? That would give us immediate <span class="conversation-fill-box interactive-element" data-answer="leverage" data-word-index="4"></span> with our suppliers.</p>
                    <p class="mb-4"><strong class="text-red-600">Client:</strong> I think that's a basis for **<span class="conversation-fill-box interactive-element" data-answer="mutual" data-word-index="5"></span>** agreement. I'm glad we didn't have to **<span class="conversation-fill-box interactive-element" data-answer="walk-away" data-word-index="6"></span>** from the deal.</p>
                </div>
                <button onclick="checkGaps()" class="check-button">Check Conversation</button>
                <div id="conversation-feedback" class="mt-4 p-3 rounded-lg text-center font-semibold hidden"></div>
            </section>

        </main>
        
        <footer class="footer">
            <p class="footer-text">&copy; 2025 English For Cool Dudes - Learn British English effectively</p>
        </footer>
    </div>

    <script>
        let score = 0;
        let totalActivities = 4; 
        let readingQuizDone = false;
        let trueFalseDone = false;
        let idiomsMatchingDone = false;
        let conversationDone = false;

        // --- GENERAL GAME STATE & FUNCTIONS ---
        let matchColorIndex = 0;
        const MATCH_COLORS = ['match-color-1', 'match-color-2', 'match-color-3', 'match-color-4']; 
        
        function updateScore(points) {
            score += points;
            document.getElementById('score-display').textContent = `Score: ${score}`;
        }

        function updateProgress() {
            const activitiesCompleted = (readingQuizDone ? 1 : 0) + (trueFalseDone ? 1 : 0) + (idiomsMatchingDone ? 1 : 0) + (conversationDone ? 1 : 0);
            const percent = Math.round((activitiesCompleted / totalActivities) * 100);
            document.getElementById('progress-bar').style.width = `${percent}%`;
            document.getElementById('progress-text').textContent = `Progress: ${activitiesCompleted}/${totalActivities} activities complete`;

            if (percent === 100) {
                const feedbackEl = document.getElementById('feedback-message');
                feedbackEl.textContent = 'üéâ All activities completed! You are a master negotiator! ü§ù';
                feedbackEl.classList.remove('hidden', 'text-red-600');
                feedbackEl.classList.add('text-green-600');
            }
        }

        // --- QUIZ A: Reading Check ---
        function checkReadingQuiz(answer) {
            if (readingQuizDone) return;
            const feedbackEl = document.getElementById('reading-feedback');
            const buttons = document.querySelectorAll('#reading-quiz .quiz-option');

            buttons.forEach(btn => btn.disabled = true);
            
            if (answer === 'B') {
                feedbackEl.textContent = "‚úÖ Correct! A position is your specific demand.";
                feedbackEl.classList.add('text-green-600');
                buttons[1].classList.add('correct-answer');
                updateScore(15);
                readingQuizDone = true;
                updateProgress();
            } else {
                feedbackEl.textContent = "‚ùå Incorrect. Try again! (Hint: It's what you want, not why you want it.)";
                feedbackEl.classList.add('text-red-600');
                const incorrectButton = Array.from(buttons).find(btn => btn.textContent.startsWith(answer));
                if (incorrectButton) {
                    incorrectButton.classList.add('incorrect-answer');
                }
                updateScore(-5);
                setTimeout(() => {
                    buttons.forEach(btn => {
                        btn.disabled = false;
                        btn.classList.remove('incorrect-answer');
                    });
                    feedbackEl.textContent = '';
                    feedbackEl.classList.remove('text-red-600');
                }, 1500);
            }
        }
        
        // --- QUIZ B: True or False ---
        const tfAnswer = false;
        function checkTrueFalse(selectedAnswer) {
            if (trueFalseDone) return;
            const feedbackEl = document.getElementById('tf-feedback');
            const buttons = document.querySelectorAll('.tf-btn');

            buttons.forEach(btn => btn.disabled = true);
            
            if (selectedAnswer === tfAnswer) {
                feedbackEl.textContent = "‚úÖ Correct! A strong BATNA makes you MORE powerful because you can walk away from a bad deal.";
                feedbackEl.classList.add('text-green-600');
                buttons[1].classList.add('correct-answer'); // False button is the second one
                updateScore(15);
                trueFalseDone = true;
                updateProgress();
            } else {
                feedbackEl.textContent = "‚ùå Incorrect. Your BATNA is your plan B. Think about what a good plan B does for your confidence.";
                feedbackEl.classList.add('text-red-600');
                buttons[0].classList.add('incorrect-answer'); // True button
                updateScore(-5);
                setTimeout(() => {
                    buttons.forEach(btn => {
                        btn.disabled = false;
                        btn.classList.remove('incorrect-answer');
                    });
                    feedbackEl.textContent = '';
                    feedbackEl.classList.remove('text-red-600');
                }, 1500);
            }
        }

        // --- EXERCISE C: IDIOMS MATCHING LOGIC ---
        let selectedTerm = null;
        let selectedMeaning = null;

        function setupIdioms() {
            const terms = document.querySelectorAll('#idioms-list .idiom-btn');
            const definitions = document.querySelectorAll('#idiom-meanings-list .meaning-btn');

            terms.forEach(item => item.addEventListener('click', () => selectIdiomTerm(item)));
            definitions.forEach(item => item.addEventListener('click', () => selectIdiomMeaning(item)));
        }

        function selectIdiomTerm(button) {
            // New logic: Only allow selection if we are not currently trying to process a match
            if (button.disabled || idiomsMatchingDone) return; 
            
            // If the user clicks a selected button on the same side, unselect it
            if (button === selectedTerm) {
                button.classList.remove('selected');
                selectedTerm = null;
                return;
            }

            // Otherwise, set new selection
            document.querySelectorAll('#idioms-list .idiom-btn').forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');
            selectedTerm = button;
            checkIdiomMatch();
        }

        function selectIdiomMeaning(button) {
            if (button.disabled || idiomsMatchingDone) return;
            
            // If the user clicks a selected button on the same side, unselect it
            if (button === selectedMeaning) {
                button.classList.remove('selected');
                selectedMeaning = null;
                return;
            }

            // Otherwise, set new selection
            document.querySelectorAll('#idiom-meanings-list .meaning-btn').forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');
            selectedMeaning = button;
            checkIdiomMatch();
        }

        function checkIdiomMatch() {
            if (selectedTerm && selectedMeaning) {
                if (selectedTerm.dataset.term === selectedMeaning.dataset.answer) {
                    
                    const colorClass = MATCH_COLORS[matchColorIndex % MATCH_COLORS.length];
                    matchColorIndex++; 
                    
                    selectedTerm.classList.add(colorClass);
                    selectedMeaning.classList.add(colorClass);
                    
                    selectedTerm.classList.remove('selected', 'interactive-element');
                    selectedMeaning.classList.remove('selected', 'interactive-element');
                    selectedTerm.disabled = true;
                    selectedMeaning.disabled = true;

                    selectedTerm = null;
                    selectedMeaning = null;
                    
                    const feedbackEl = document.getElementById('idiom-feedback');
                    feedbackEl.textContent = "üî® Correct Match! (+15 Points)";
                    feedbackEl.classList.remove('hidden', 'bg-red-700');
                    feedbackEl.classList.add('bg-green-600', 'text-white');
                    setTimeout(() => { feedbackEl.classList.add('hidden'); }, 1500);

                    updateScore(15);
                    checkAllIdiomsMatched();
                } else {
                    // Incorrect Match - Flash Red
                    
                    // 1. Capture references before resetting global state
                    const termToReset = selectedTerm;
                    const meaningToReset = selectedMeaning;

                    termToReset.classList.add('incorrect-answer');
                    meaningToReset.classList.add('incorrect-answer');

                    // 2. ***FIXED BUG***: Clear the selection state immediately so new clicks work
                    termToReset.classList.remove('selected'); 
                    meaningToReset.classList.remove('selected'); 
                    selectedTerm = null;
                    selectedMeaning = null;

                    // 3. Remove the red flash after delay
                    setTimeout(() => {
                        // Check if the element hasn't been re-used in a new match before removing the class
                        if(termToReset) termToReset.classList.remove('incorrect-answer');
                        if(meaningToReset) meaningToReset.classList.remove('incorrect-answer');
                    }, 1000); 

                    updateScore(-5);
                }
            }
        }

        function checkAllIdiomsMatched() {
            const unmatchedTerms = document.querySelectorAll('#idioms-list .idiom-btn:not([disabled])').length;
            if (unmatchedTerms === 0 && !idiomsMatchingDone) {
                idiomsMatchingDone = true;
                const feedbackEl = document.getElementById('idiom-feedback');
                feedbackEl.textContent = "‚úÖ All idioms matched correctly! (+50 Bonus)";
                feedbackEl.classList.remove('hidden', 'bg-red-700');
                feedbackEl.classList.add('bg-green-600', 'text-white');
                updateScore(50);
                updateProgress();
            }
        }

        // --- EXERCISE D: CONVERSATION GAP-FILL LOGIC ---
        let selectedWordBankWord = null;
        let userConversationWords = new Array(7).fill(null); // 7 blanks

        const correctOrder = ['win-win', 'mandate', 'concession', 'counter-offer', 'leverage', 'mutual', 'walk-away'];


        function setupGapFill() {
            const options = document.querySelectorAll('#conversation-options .fill-in-box');
            options.forEach(option => option.addEventListener('click', () => handleWordBankClick(option)));

            const blanks = document.querySelectorAll('.conversation-fill-box');
            blanks.forEach((blank, index) => {
                blank.dataset.wordIndex = index; // Store index in HTML
                blank.addEventListener('click', () => handleBlankClick(blank));
            });
        }
        
        function handleWordBankClick(button) {
            if (conversationDone) return;
            
            // Deselect previous word
            document.querySelectorAll('.fill-in-box').forEach(btn => btn.classList.remove('selected-word'));
            
            // Select new word
            button.classList.add('selected-word');
            selectedWordBankWord = button.dataset.word;
        }

        function handleBlankClick(blank) {
            if (conversationDone) return;
            
            const blankIndex = parseInt(blank.dataset.wordIndex);
            
            // Scenario 1: Blank already has a word and is clicked to clear it
            if (blank.textContent) {
                const oldWord = blank.textContent;
                
                // Remove word from blank
                blank.textContent = '';
                userConversationWords[blankIndex] = null;
                
                // Re-enable word bank button and reset its opacity
                const oldButton = document.querySelector(`.fill-in-box[data-word="${oldWord}"]`);
                if (oldButton) {
                    oldButton.disabled = false;
                    oldButton.style.opacity = '1.0';
                    oldButton.classList.remove('selected-word');
                }
                
                // Reset styling
                blank.classList.remove('correct-answer', 'incorrect-answer');
                selectedWordBankWord = null; // Clear selected word
            }

            // Scenario 2: A word is selected in the word bank and the blank is clicked to fill it
            else if (selectedWordBankWord) {
                
                // 1. Fill the blank
                blank.textContent = selectedWordBankWord;
                userConversationWords[blankIndex] = selectedWordBankWord;
                
                // 2. Disable the word bank button and deselect the word
                const selectedWordButton = document.querySelector(`.fill-in-box[data-word="${selectedWordBankWord}"]`);
                if (selectedWordButton) {
                    selectedWordButton.disabled = true;
                    selectedWordButton.style.opacity = '0.5';
                    selectedWordButton.classList.remove('selected-word');
                }
                
                // 3. Clear selected word state
                selectedWordBankWord = null;
                
                // 4. Update blank state visually
                blank.classList.remove('incorrect-answer'); 
            }
        }


        function checkGaps() {
            if (conversationDone) return;
            let correctCount = 0;
            let allCorrect = true;
            const gaps = document.querySelectorAll('.conversation-fill-box');
            const feedbackEl = document.getElementById('conversation-feedback');

            gaps.forEach((blank, index) => {
                const selectedWord = blank.textContent ? blank.textContent.toLowerCase() : '';
                const answer = correctOrder[index].toLowerCase();
                
                // Remove existing result classes
                blank.classList.remove('correct-answer', 'incorrect-answer');

                if (selectedWord === answer) {
                    correctCount++;
                    blank.classList.add('correct-answer');
                } else if (selectedWord !== '') {
                    blank.classList.add('incorrect-answer');
                    allCorrect = false;
                } else {
                    allCorrect = false;
                }
            });

            if (allCorrect) {
                feedbackEl.textContent = "üéâ Spot On! You've used all the negotiation phrases correctly! (+30 Points)";
                feedbackEl.classList.add('bg-green-600', 'text-white');
                feedbackEl.classList.remove('bg-red-700', 'hidden');
                conversationDone = true;
                updateScore(30);
                updateProgress();
            } else {
                feedbackEl.textContent = `You got ${correctCount} out of ${gaps.length} correct. Review the words highlighted in red and try again by clicking on the incorrect word to remove it.`;
                feedbackEl.classList.add('bg-red-700', 'text-white');
                feedbackEl.classList.remove('bg-green-600', 'hidden');
                updateScore(-10);
            }
        }
        
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            setupIdioms();
            setupGapFill();
        });

    </script>
</body>
</html>
