<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="/favicon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Permanent Establishment: A Global Tax Presence</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #FF6F61 0%, #E83F6F 50%, #88398A 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #FF6F61, #E83F6F);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        .header::before {
            content: 'üè¢';
            position: absolute;
            top: 20px;
            left: 30px;
            font-size: 3em;
            animation: bounce 2s infinite;
        }
        .header::after {
            content: 'üìú';
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 3em;
            animation: bounce 2s infinite 1s;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }
        .game-stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 15px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            display: block;
        }
        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
        }
        .progress-bar {
            width: 100%;
            height: 15px;
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            overflow: hidden;
        }
        .progress {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #FFD700);
            border-radius: 10px;
            width: 0%;
            transition: width 0.8s ease;
            position: relative;
        }
        .progress::after {
            content: 'üéØ';
            position: absolute;
            right: -10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2em;
            animation: bounce 2s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(-50%) scale(1); }
            50% { transform: translateY(-60%) scale(1.2); }
        }
        .lesson-content {
            padding: 30px;
        }
        .section {
            margin-bottom: 40px;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .section:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }
        .warmup { background: linear-gradient(135deg, #FFE0B2, #FFAB40); }
        .listening { background: linear-gradient(135deg, #E8F5E8, #66BB6A); }
        .vocab { background: linear-gradient(135deg, #F3E5F5, #AB47BC); }
        .gapfill { background: linear-gradient(135deg, #FFF3E0, #FFA726); }
        .quiz { background: linear-gradient(135deg, #FFEBEE, #EF5350); }
        .challenge { background: linear-gradient(135deg, #FFF8E1, #FFCA28); }
        .comprehension { background: linear-gradient(135deg, #E3F2FD, #42A5F5); }
        .analysis { background: linear-gradient(135deg, #F1F8E9, #8BC34A); }
        .grammar { background: linear-gradient(135deg, #FFD1E3, #F48FB1); }
        .new-vocab { background: linear-gradient(135deg, #C5CAE9, #7986CB); }
        .reported-speech { background: linear-gradient(135deg, #E0F7FA, #4DD0E1); }

        .section-title {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }
        .level-badge {
            background: #FF6F61;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.7em;
            position: absolute;
            right: 0;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 111, 97, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 111, 97, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 111, 97, 0); }
        }
        .story-box {
            background: white;
            padding: 25px;
            border-radius: 15px;
            border-left: 5px solid #66BB6A;
            font-size: 1.1em;
            line-height: 1.8;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .quiz-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .question-counter {
            background: #EF5350;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        .quiz-question {
            font-size: 1.2em;
            margin-bottom: 20px;
            color: #333;
            font-weight: 500;
        }
        .quiz-options {
            display: grid;
            gap: 12px;
        }
        .quiz-option {
            background: #f8f9fa;
            border: 2px solid #ddd;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1em;
        }
        .quiz-option:hover {
            background: #e3f2fd;
            border-color: #42A5F5;
            transform: translateX(5px);
        }
        .quiz-option.correct {
            background: #66BB6A !important;
            color: white !important;
            border-color: #4CAF50 !important;
        }
        .quiz-option.incorrect {
            background: #EF5350 !important;
            color: white !important;
            border-color: #f44336 !important;
        }
        .explanation {
            background: #f0f8ff;
            padding: 10px 15px;
            border-radius: 8px;
            border-left: 4px solid #42A5F5;
            margin-top: 10px;
            font-style: italic;
        }
        .number-input {
            display: inline-block;
            width: 100px;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 0 5px;
            text-align: center;
            font-weight: bold;
            transition: border-color 0.3s ease;
            font-size: 1.1em;
        }
        .number-input:focus {
            outline: none;
            border-color: #42A5F5;
        }
        .number-input.correct {
            border-color: #66BB6A;
            background: #E8F5E8;
        }
        .number-input.incorrect {
            border-color: #EF5350;
            background: #FFEBEE;
        }
        .true-false-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 20px 0;
        }
        .tf-button {
            background: white;
            border: 3px solid #ddd;
            padding: 20px 40px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        .tf-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        .tf-button.true {
            color: #66BB6A;
            border-color: #66BB6A;
        }
        .tf-button.false {
            color: #EF5350;
            border-color: #EF5350;
        }
        .tf-button.selected.true {
            background: #66BB6A;
            color: white;
        }
        .tf-button.selected.false {
            background: #EF5350;
            color: white;
        }
        .btn {
            background: linear-gradient(135deg, #FF6F61, #E83F6F);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1.1em;
            margin: 15px 10px;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(255, 111, 97, 0.3);
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 111, 97, 0.4);
        }
        .achievement {
            background: linear-gradient(135deg, #FFD700, #FFA000);
            color: white;
            padding: 15px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
            animation: achievementPop 0.6s ease;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            min-width: 300px;
            display: none;
        }
        @keyframes achievementPop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .highlight {
            background: linear-gradient(120deg, #FFEB3B 0%, #FFE082 100%);
            padding: 3px 6px;
            border-radius: 5px;
            font-weight: 500;
        }
        .feedback-box {
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            font-size: 1.1em;
            animation: slideIn 0.5s ease;
        }
        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .feedback-box.excellent {
            background: linear-gradient(135deg, #E8F5E8, #C8E6C9);
            border-left: 5px solid #66BB6A;
            color: #2E7D32;
        }
        .feedback-box.needs-improvement {
            background: linear-gradient(135deg, #FFEBEE, #FFCDD2);
            border-left: 5px solid #EF5350;
            color: #C62828;
        }
        .timer {
            background: #FF5722;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            animation: timerPulse 1s infinite;
            margin: 10px 0;
        }
        @keyframes timerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Gap Fill Styles */
        .gap-fill-text {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 5px solid #FFA726;
            font-size: 1.1em;
            line-height: 1.8;
        }
        .gap-input {
            display: inline-block;
            width: 120px;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 0 5px;
            text-align: center;
            font-weight: bold;
            transition: border-color 0.3s ease;
            background: #FFF8E1;
            cursor: pointer;
        }
        .gap-input:focus {
            outline: none;
            border-color: #FFA726;
        }
        .gap-input.correct {
            border-color: #66BB6A;
            background: #E8F5E8;
        }
        .gap-input.incorrect {
            border-color: #EF5350;
            background: #FFEBEE;
        }
        .word-bank {
            background: #FFF8E1;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border: 2px dashed #FFA726;
        }
        .word-option {
            display: inline-block;
            background: #FFA726;
            color: white;
            padding: 8px 15px;
            margin: 5px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }
        .word-option:hover {
            background: #FF8F00;
            transform: scale(1.05);
        }
        .word-option.used {
            background: #ccc;
            color: #666;
            cursor: not-allowed;
        }
        .word-option.selected {
            background: #FF8F00;
            box-shadow: 0 0 0 3px #FFA726;
        }

        /* Collocations Matching */
        .matching-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 20px 0;
        }
        .matching-column {
            background: white;
            padding: 20px;
            border-radius: 15px;
            border: 3px solid #8BC34A;
        }
        .matching-item {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .matching-item:hover {
            background: #E8F5E8;
            border-color: #8BC34A;
        }
        .matching-item.selected {
            background: #8BC34A;
            color: white;
        }
        .matching-item.matched {
            background: #C8E6C9;
            border-color: #66BB6A;
            cursor: default;
        }
        
        .did-you-know {
            background: linear-gradient(135deg, #E0F7FA, #80DEEA);
            border-left: 5px solid #00ACC1;
            color: #006064;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            font-size: 1.1em;
            line-height: 1.6;
        }
        .did-you-know h3 {
            color: #004D40;
            margin-bottom: 15px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .did-you-know ul {
            list-style-type: none;
            padding-left: 20px;
        }
        .did-you-know li {
            margin-bottom: 10px;
            position: relative;
        }
        .did-you-know li::before {
            content: 'üí°';
            position: absolute;
            left: -20px;
            font-size: 1.2em;
        }
        .dictionary {
            background: #F3E5F5;
            padding: 20px;
            border-radius: 15px;
            border-left: 5px solid #AB47BC;
            margin-top: 20px;
        }
        .dictionary h3 {
            margin-bottom: 15px;
            color: #7B1FA2;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .dictionary dt {
            font-weight: bold;
            color: #4A148C;
            margin-top: 10px;
        }
        .dictionary dd {
            margin-left: 20px;
            font-style: italic;
        }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 2em; }
            .section { margin-bottom: 20px; padding: 20px; }
            .game-stats { flex-direction: column; gap: 15px; }
            .true-false-container { flex-direction: column; align-items: center; }
            .achievement { 
                position: static; 
                margin: 20px auto; 
                min-width: auto; 
                width: 90%; 
            }
            .matching-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body onload="setupUI();">
    <div class="container">
        <div class="header">
            <h1>üè¢ Permanent Establishment & Withholding Tax</h1>
            <p class="subtitle">Upper Intermediate Business English for International Tax</p>
            
            <div class="game-stats">
                <div class="stat-item">
                    <span class="stat-number" id="score">0</span>
                    <span class="stat-label">POINTS</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="level">1</span>
                    <span class="stat-label">LEVEL</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="streak">0</span>
                    <span class="stat-label">STREAK</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="achievements">0</span>
                    <span class="stat-label">üèÜ BADGES</span>
                </div>
            </div>
            
            <div class="progress-bar">
                <div class="progress" id="progressBar"></div>
            </div>
        </div>
        
        <div id="achievementPopup" class="achievement" style="display: none;">
            <span>üéâ Achievement Unlocked! üéâ</span>
            <span id="achievementText"></span>
        </div>

        <div class="lesson-content">
            <div class="section warmup">
                <h2 class="section-title">
                    <span class="emoji">‚ö°</span>Speed Challenge: Tax Terms
                    <span class="level-badge">LEVEL 1</span>
                </h2>
                
                <div class="timer" id="speedTimer" style="display:none;">
                    <span>‚è∞</span>
                    <span id="timeLeft">30</span> seconds
                </div>
                
                <div class="quiz-container" id="speedQuiz" style="display:none;">
                    <div class="question-counter">Speed Round 1/5</div>
                    <div class="quiz-question"></div>
                    <div class="quiz-options"></div>
                </div>

                <button class="btn" onclick="startSpeedRound()">üèÉ‚Äç‚ôÇÔ∏è Start 30-Second Challenge</button>
            </div>

            <hr>

            <div class="did-you-know">
                <h3>üí° Did you know?</h3>
                <ul>
                    <li>The **OECD Model Tax Convention** is a template used by countries to negotiate bilateral tax treaties, including definitions of a Permanent Establishment (PE).</li>
                    <li>A **"service PE"** can be created when an enterprise provides services in another country for a specified period, even without a fixed physical place of business.</li>
                    <li>The **anti-fragmentation rule** from BEPS Action 7 prevents companies from artificially breaking up their activities to avoid creating a PE.</li>
                </ul>
            </div>

            <hr>

            <div class="section listening">
                <h2 class="section-title">
                    <span class="emoji">üìä</span>Reading Comprehension: PE & Withholding Tax
                    <span class="level-badge">LEVEL 2</span>
                </h2>

                <div class="story-box">
                    <p><strong>üè¢ Understanding PE and Withholding Tax Interconnections</strong></p>
                    <p>When TechGlobal Inc., a US software company, established operations in Germany, they faced complex tax obligations. Their <span class="highlight">permanent establishment (PE)</span> in Munich meant they were subject to German corporate income tax on profits attributable to that PE. However, the company also made payments to independent German consultants for marketing services.</p>
                    
                    <p>Under German tax law, TechGlobal was required to apply <span class="highlight">withholding tax</span> at a rate of <span class="highlight">19%</span> on these consultant payments, as the recipients were German tax residents providing services. This withholding tax serves as an advance payment of the consultants' income tax obligations. The company must <span class="highlight">remit</span> this withheld amount to the German tax authorities within one month of payment.</p>
                    
                    <p>Importantly, the PE's existence doesn't eliminate withholding tax obligations on payments to third parties. Even though TechGlobal pays German corporate tax through their PE, they still act as a <span class="highlight">withholding agent</span> when making payments to German service providers, effectively collecting tax on behalf of the German tax administration.</p>
                </div>
                
                <div id="comprehensionQuizContainer">
                    </div>
                <button class="btn" id="nextCompBtn" style="display:none;">‚û°Ô∏è Next Question</button>
                <div id="comprehensionFeedback" style="display:none;" class="feedback-box"></div>
            </div>

            <hr>
            
            <div class="section analysis">
                <h2 class="section-title">
                    <span class="emoji">üìù</span>Reading Analysis: Anti-Avoidance Rules
                    <span class="level-badge">LEVEL 3</span>
                </h2>
                
                <div class="story-box">
                    <p><strong>Tax Avoidance and General Anti-Avoidance Rules (GAAR)</strong></p>
                    <p>Tax authorities worldwide are concerned with preventing companies from artificially reducing their tax burdens. To combat this, many countries have introduced **General Anti-Avoidance Rules (GAAR)**, which are broad provisions designed to prevent tax planning that, while technically legal, is considered abusive. For an arrangement to be subject to GAAR, it must typically lack a **bona fide** commercial purpose and exist primarily to obtain a tax benefit. The rules aim to allow authorities to disregard or re-characterize such transactions.</p>
                    <p>GAAR is distinct from **specific anti-avoidance rules (SAAR)**, which target particular tax-avoidance schemes. SAARs are often narrowly focused on a single type of transaction or arrangement. GAAR, on the other hand, provides a wider safety net for tax administrations. Implementing GAAR provisions can be challenging, as it requires a balance between protecting the tax base and providing certainty for taxpayers. The legal precedent and interpretation of what constitutes a **"primary purpose"** of obtaining a tax benefit can vary significantly between jurisdictions.</p>
                </div>
                
                <div id="readingAnalysisQuizContainer">
                    </div>
                <button class="btn" id="nextAnalysisBtn" style="display:none;">‚û°Ô∏è Next Question</button>
            </div>

            <hr>

            <div class="section grammar">
                <h2 class="section-title">
                    <span class="emoji">üìù</span>Grammar Challenge: Complex Conditionals
                    <span class="level-badge">UPPER-INT</span>
                </h2>
                <div class="quiz-container" id="grammarQuiz">
                </div>
                <button class="btn" onclick="checkGrammar()">‚úÖ Check My Answers</button>
                <div id="grammarFeedback" style="display:none;" class="feedback-box"></div>
            </div>

            <hr>

            <div class="section reported-speech">
                <h2 class="section-title">
                    <span class="emoji">üíº</span>Advanced Grammar: Business Scenarios
                    <span class="level-badge">UPPER-INT</span>
                </h2>
                <div class="quiz-container" id="advancedGrammarQuiz">
                </div>
                <button class="btn" onclick="checkAdvancedGrammar()">‚úÖ Check My Answers</button>
                <div id="advancedGrammarFeedback" style="display:none;" class="feedback-box"></div>
            </div>
            
            <hr>

            <div class="section gapfill">
                <h2 class="section-title">
                    <span class="emoji">üìù</span>Gap Fill: The Agent PE
                    <span class="level-badge">LEVEL 5</span>
                </h2>
                
                <div class="word-bank">
                    <strong>Word Bank:</strong>
                    <span class="word-option" data-word="conclude">conclude</span>
                    <span class="word-option" data-word="dependent">dependent</span>
                    <span class="word-option" data-word="negotiate">negotiate</span>
                    <span class="word-option" data-word="independent">independent</span>
                    <span class="word-option" data-word="contracts">contracts</span>
                    <span class="word-option" data-word="presence">presence</span>
                    <span class="word-option" data-word="principal">principal</span>
                    <span class="word-option" data-word="authority">authority</span>
                </div>

                <div class="gap-fill-text">
                    <p>A <input type="text" class="gap-input" data-answer="dependent"> agent can create a PE for its <input type="text" class="gap-input" data-answer="principal"> if they have the <input type="text" class="gap-input" data-answer="authority"> to conclude <input type="text" class="gap-input" data-answer="contracts"> in the name of the foreign company.</p>
                    
                    <p>The key factor is the agent's ability to <input type="text" class="gap-input" data-answer="negotiate"> and <input type="text" class="gap-input" data-answer="conclude"> contracts without needing the <input type="text" class="gap-input" data-answer="principal">'s approval, creating a taxable <input type="text" class="gap-input" data-answer="presence">.</p>
                    
                    <p>In contrast, an <input type="text" class="gap-input" data-answer="independent"> agent typically does not create a PE, as they are not subject to detailed instructions from the foreign enterprise.</p>
                </div>

                <button class="btn" onclick="checkGapFill()">‚úÖ Check Gap Fill</button>
                <div id="gapFillFeedback" style="display:none;" class="feedback-box"></div>
            </div>
            
            <hr>

            <div class="section new-vocab">
                <h2 class="section-title">
                    <span class="emoji">üí¨</span>Contextual Vocabulary Quiz
                    <span class="level-badge">UPPER-INT</span>
                </h2>
                <div id="vocabQuizContainer">
                    </div>
                <div id="vocabFeedback" style="display:none;" class="feedback-box"></div>
                <button class="btn" id="nextVocabBtn" style="display:none;">‚û°Ô∏è Next Question</button>
            </div>
        </div>
    </div>
    
    <script>
        // Game state variables
        let score = 0;
        let streak = 0;
        let level = 1;
        let achievements = 0;
        let totalQuestions = 0;
        let questionsCompleted = 0;

        // --- Core UI & Game Functions ---
        function updateStats() {
            document.getElementById('score').textContent = score;
            document.getElementById('streak').textContent = streak;
            document.getElementById('level').textContent = level;
            document.getElementById('achievements').textContent = achievements;
            document.getElementById('progressBar').style.width = ((questionsCompleted / totalQuestions) * 100) + '%';
        }

        function showAchievement(text) {
            const popup = document.getElementById('achievementPopup');
            document.getElementById('achievementText').textContent = text;
            popup.style.display = 'block';
            achievements++;
            updateStats();
            setTimeout(() => {
                popup.style.display = 'none';
            }, 5000);
        }

        function showFeedback(elementId, isCorrect, explanationText = '') {
            const feedbackBox = document.getElementById(elementId);
            if (isCorrect) {
                feedbackBox.textContent = '‚úÖ Excellent! Your answer is correct.';
                feedbackBox.className = 'feedback-box excellent';
            } else {
                feedbackBox.textContent = '‚ùå Not quite. Please review the explanation and try again.';
                feedbackBox.className = 'feedback-box needs-improvement';
            }
            if (explanationText) {
                feedbackBox.innerHTML = `<strong>${isCorrect ? '‚úÖ Excellent!' : '‚ùå Not quite.'}</strong> ${isCorrect ? 'Your answer is correct.' : 'The correct answer is not what you selected.'} <em>${explanationText}</em>`;
            }
            feedbackBox.style.display = 'block';
        }

        // --- Speed Challenge Functions ---
        const speedQuestions = [
            { question: "A fixed place of business that gives rise to tax liability is a...", options: ["Permanent Establishment", "Withholding Agent", "Transfer Pricing", "Tax Haven"], answer: "Permanent Establishment" },
            { question: "Tax deducted at source from a payment to a non-resident is known as...", options: ["Value Added Tax", "Withholding Tax", "Corporate Tax", "Sales Tax"], answer: "Withholding Tax" },
            { question: "The OECD is a global organization that provides models for...", options: ["Trade Agreements", "Tax Treaties", "Financial Audits", "Investment Banking"], answer: "Tax Treaties" },
            { question: "BEPS Action 7 is related to preventing artificial avoidance of...", options: ["Transfer Pricing", "VAT", "Permanent Establishment status", "Audits"], answer: "Permanent Establishment status" },
            { question: "To 'remit' tax means to...", options: ["Receive a refund", "Calculate the amount", "Pay or send money", "Claim an exemption"], answer: "Pay or send money" },
        ];
        let speedQuestionIndex = 0;
        let speedTimer;
        let timeLeft = 30;

        function startSpeedRound() {
            document.querySelector('.warmup .btn').style.display = 'none';
            document.getElementById('speedQuiz').style.display = 'block';
            document.getElementById('speedTimer').style.display = 'flex';
            score = 0;
            streak = 0;
            speedQuestionIndex = 0;
            questionsCompleted = 0;
            updateStats();
            displaySpeedQuestion();
            speedTimer = setInterval(updateSpeedTimer, 1000);
        }

        function displaySpeedQuestion() {
            if (speedQuestionIndex >= speedQuestions.length || timeLeft <= 0) {
                endSpeedRound();
                return;
            }
            const q = speedQuestions[speedQuestionIndex];
            const container = document.getElementById('speedQuiz');
            container.querySelector('.question-counter').textContent = `Speed Round ${speedQuestionIndex + 1}/${speedQuestions.length}`;
            container.querySelector('.quiz-question').textContent = q.question;
            const optionsContainer = container.querySelector('.quiz-options');
            optionsContainer.innerHTML = '';
            q.options.sort(() => Math.random() - 0.5).forEach(option => {
                const optionDiv = document.createElement('div');
                optionDiv.classList.add('quiz-option');
                optionDiv.textContent = option;
                optionDiv.onclick = () => checkSpeedAnswer(option, q.answer, optionDiv);
                optionsContainer.appendChild(optionDiv);
            });
        }

        function checkSpeedAnswer(selected, correct, element) {
            const options = document.querySelectorAll('#speedQuiz .quiz-option');
            options.forEach(opt => opt.style.pointerEvents = 'none');
            
            const isCorrect = selected === correct;
            
            options.forEach(opt => opt.classList.remove('correct', 'incorrect'));
            element.classList.add(isCorrect ? 'correct' : 'incorrect');
            if (!isCorrect) {
                const correctElement = Array.from(options).find(el => el.textContent === correct);
                if (correctElement) correctElement.classList.add('correct');
            }

            if (isCorrect) {
                score += 10;
                streak++;
                if (streak === 5) showAchievement('5-question streak!');
            } else {
                streak = 0;
            }
            
            questionsCompleted++;
            updateStats();
            speedQuestionIndex++;
            
            setTimeout(() => {
                displaySpeedQuestion();
            }, 1000);
        }

        function updateSpeedTimer() {
            timeLeft--;
            document.getElementById('timeLeft').textContent = timeLeft;
            if (timeLeft <= 0) {
                endSpeedRound();
            }
        }

        function endSpeedRound() {
            clearInterval(speedTimer);
            document.getElementById('speedTimer').textContent = 'Time Up!';
            document.querySelector('.warmup .btn').style.display = 'block';
            document.getElementById('speedQuiz').style.display = 'none';
            timeLeft = 30;
        }

        // --- Reading Comprehension Functions ---
        const comprehensionQuestions = [
            {
                question: "What is the primary purpose of withholding tax in this scenario?",
                options: ["To reduce TechGlobal's corporate tax burden", "To collect advance income tax from the German consultants", "To penalize foreign companies operating in Germany", "To fund the German PE registration process"],
                answer: "To collect advance income tax from the German consultants",
                explanation: "Withholding tax is a mechanism for the government to collect income tax on behalf of the recipient. The consultant will then get credit for this payment when they file their tax return."
            },
            {
                question: "At what rate must TechGlobal withhold tax on consultant payments?",
                options: ["15%", "19%", "25%", "30%"],
                answer: "19%",
                explanation: "The text explicitly states the rate is 19%."
            },
            {
                question: "When must TechGlobal remit the withheld tax to German authorities?",
                options: ["Within one week of payment", "Within one month of payment", "At the end of the tax year", "Only when requested by authorities"],
                answer: "Within one month of payment",
                explanation: "The text states 'within one month of payment'."
            },
            {
                question: "What role does TechGlobal play regarding withholding tax?",
                options: ["Tax advisor", "Withholding agent", "Tax exemption recipient", "Tax treaty negotiator"],
                answer: "Withholding agent",
                explanation: "The text defines a withholding agent as a company that collects tax on behalf of the tax administration."
            }
        ];
        let compQuestionIndex = 0;

        function displayComprehensionQuestion() {
            const container = document.getElementById('comprehensionQuizContainer');
            if (compQuestionIndex >= comprehensionQuestions.length) {
                container.innerHTML = '<div class="feedback-box excellent">You have successfully completed the reading comprehension quiz!</div>';
                document.getElementById('nextCompBtn').style.display = 'none';
                return;
            }

            const q = comprehensionQuestions[compQuestionIndex];
            container.innerHTML = `
                <div class="quiz-container">
                    <div class="question-counter">Comprehension Challenge ${compQuestionIndex + 1}/${comprehensionQuestions.length}</div>
                    <div class="quiz-question">${q.question}</div>
                    <div class="quiz-options">
                        ${q.options.map(opt => `<div class="quiz-option" data-answer="${opt}">${opt}</div>`).join('')}
                    </div>
                    <div class="explanation" style="display:none;">üí° <em>${q.explanation}</em></div>
                </div>`;
            document.querySelectorAll('#comprehensionQuizContainer .quiz-option').forEach(option => {
                option.onclick = () => checkComprehensionAnswer(option, q.answer);
            });
            document.getElementById('nextCompBtn').onclick = nextComprehensionQuestion;
        }

        function checkComprehensionAnswer(element, correctAnswer) {
            const selectedAnswer = element.textContent;
            const container = element.closest('.quiz-container');
            const options = container.querySelectorAll('.quiz-option');
            options.forEach(opt => opt.style.pointerEvents = 'none');
            
            const isCorrect = selectedAnswer === correctAnswer;

            element.classList.add(isCorrect ? 'correct' : 'incorrect');
            if (!isCorrect) {
                const correctElement = Array.from(options).find(el => el.textContent === correctAnswer);
                if (correctElement) correctElement.classList.add('correct');
            }
            
            const explanationBox = container.querySelector('.explanation');
            explanationBox.style.display = 'block';

            if (isCorrect) {
                score += 15;
                streak++;
            } else {
                streak = 0;
            }
            
            questionsCompleted++;
            updateStats();
            document.getElementById('nextCompBtn').style.display = 'block';
        }

        function nextComprehensionQuestion() {
            compQuestionIndex++;
            displayComprehensionQuestion();
            document.getElementById('nextCompBtn').style.display = 'none';
        }
        
        // --- NEW Reading Analysis Functions ---
        const readingAnalysisQuestions = [
            { question: "General Anti-Avoidance Rules (GAAR) are used to combat all forms of tax avoidance.", answer: "No", explanation: "The text states that GAAR applies to arrangements that 'lack a bona fide commercial purpose' and are 'primarily' for a tax benefit, not to 'all forms' of avoidance." },
            { question: "SAAR is a broader provision than GAAR.", answer: "No", explanation: "The text says GAAR 'provides a wider safety net' and SAARs are 'narrowly focused'." },
            { question: "The primary purpose of GAAR is to provide legal certainty for taxpayers.", answer: "No", explanation: "The text says GAAR 'can be challenging' because it requires a 'balance between protecting the tax base and providing certainty'. Certainty is a challenge, not the primary purpose." },
            { question: "An arrangement must have a tax-related primary purpose to be considered for GAAR.", answer: "Yes", explanation: "The text states an arrangement must 'exist primarily to obtain a tax benefit' to be subject to GAAR." },
            { question: "GAAR was first introduced in Germany.", answer: "Not Given", explanation: "The text does not mention which country first introduced GAAR." },
            { question: "All countries have introduced GAAR.", answer: "No", explanation: "The text only says 'many countries have introduced' GAAR, not all of them." }
        ];

        let analysisQuestionIndex = 0;

        function displayReadingAnalysisQuestion() {
            const container = document.getElementById('readingAnalysisQuizContainer');
            if (analysisQuestionIndex >= readingAnalysisQuestions.length) {
                container.innerHTML = '<div class="feedback-box excellent">You have completed the reading analysis quiz!</div>';
                document.getElementById('nextAnalysisBtn').style.display = 'none';
                return;
            }

            const q = readingAnalysisQuestions[analysisQuestionIndex];
            container.innerHTML = `
                <div class="quiz-container">
                    <div class="question-counter">Question ${analysisQuestionIndex + 1}/${readingAnalysisQuestions.length}</div>
                    <div class="quiz-question">${q.question}</div>
                    <div class="quiz-options">
                        <div class="quiz-option" data-answer="Yes">Yes</div>
                        <div class="quiz-option" data-answer="No">No</div>
                        <div class="quiz-option" data-answer="Not Given">Not Given</div>
                    </div>
                </div>`;
            
            document.querySelectorAll('#readingAnalysisQuizContainer .quiz-option').forEach(option => {
                option.onclick = () => checkReadingAnalysisAnswer(option, q.answer, q.explanation);
            });
            document.getElementById('nextAnalysisBtn').onclick = nextReadingAnalysisQuestion;
        }

        function checkReadingAnalysisAnswer(element, correctAnswer, explanation) {
            const selectedAnswer = element.dataset.answer;
            const container = element.closest('.quiz-container');
            const options = container.querySelectorAll('.quiz-option');
            options.forEach(opt => opt.style.pointerEvents = 'none');
            
            const isCorrect = selectedAnswer === correctAnswer;

            options.forEach(opt => opt.classList.remove('correct', 'incorrect'));
            element.classList.add(isCorrect ? 'correct' : 'incorrect');
            if (!isCorrect) {
                const correctElement = Array.from(options).find(el => el.dataset.answer === correctAnswer);
                if (correctElement) correctElement.classList.add('correct');
            }
            
            const feedbackBox = document.createElement('div');
            feedbackBox.className = isCorrect ? 'feedback-box excellent' : 'feedback-box needs-improvement';
            feedbackBox.innerHTML = `<strong>${isCorrect ? '‚úÖ Excellent!' : '‚ùå Not quite.'}</strong> ${isCorrect ? '' : 'The correct answer is not what you selected.'} <em>${explanation}</em>`;
            container.appendChild(feedbackBox);

            if (isCorrect) {
                score += 15;
                streak++;
            } else {
                streak = 0;
            }
            
            questionsCompleted++;
            updateStats();
            document.getElementById('nextAnalysisBtn').style.display = 'block';
        }

        function nextReadingAnalysisQuestion() {
            analysisQuestionIndex++;
            displayReadingAnalysisQuestion();
            document.getElementById('nextAnalysisBtn').style.display = 'none';
        }


        // --- Gap Fill Functions ---
        let selectedWord = null;
        let selectedInput = null;

        function setupGapFill() {
            document.querySelectorAll('.word-option').forEach(word => {
                word.onclick = () => selectWord(word);
            });
            document.querySelectorAll('.gap-input').forEach(input => {
                input.onclick = () => fillGap(input);
            });
        }

        function selectWord(element) {
            if (element.classList.contains('used')) return;

            if (selectedWord && document.querySelector(`.word-option[data-word="${selectedWord}"]`) === element) {
                element.classList.remove('selected');
                selectedWord = null;
                return;
            }

            document.querySelectorAll('.word-option').forEach(word => word.classList.remove('selected'));
            element.classList.add('selected');
            selectedWord = element.dataset.word;
        }

        function fillGap(element) {
            if (!selectedWord) {
                if (element.value !== '') {
                    const wordElement = document.querySelector(`.word-option.used[data-word="${element.value}"]`);
                    if (wordElement) {
                        wordElement.classList.remove('used');
                        element.value = '';
                    }
                }
                return;
            }
            
            if (element.value !== '') {
                const oldWordElement = document.querySelector(`.word-option.used[data-word="${element.value}"]`);
                if (oldWordElement) {
                    oldWordElement.classList.remove('used');
                }
            }
            
            element.value = selectedWord;
            const wordElement = document.querySelector(`.word-option[data-word="${selectedWord}"]`);
            wordElement.classList.add('used');
            wordElement.classList.remove('selected');
            selectedWord = null;
        }

        function checkGapFill() {
            let correctCount = 0;
            const gaps = document.querySelectorAll('.gap-input');
            gaps.forEach(gap => {
                if (gap.value.toLowerCase() === gap.dataset.answer.toLowerCase()) {
                    gap.classList.add('correct');
                    correctCount++;
                } else {
                    gap.classList.add('incorrect');
                }
            });
            showFeedback('gapFillFeedback', correctCount === gaps.length);
            if (correctCount === gaps.length) {
                score += 20;
                streak++;
            } else {
                streak = 0;
            }

            questionsCompleted++;
            updateStats();
        }

        // --- Vocabulary Quiz Functions ---
        const vocabQuestions = [
            {
                question: "Which term describes a company's financial records being reviewed to ensure compliance?",
                options: ["Remittance", "Attributable", "Withholding", "Audited"],
                answer: "Audited"
            },
            {
                question: "If a payment is 'attributable' to a PE, it means it is...",
                options: ["Subject to a lower tax rate", "Transferred to a different account", "Connected to and earned by the PE", "Exempt from tax"],
                answer: "Connected to and earned by the PE"
            },
            {
                question: "A company that is legally required to collect and pay tax on behalf of another party is a...",
                options: ["Taxpayer", "Tax advisor", "Withholding agent", "Tax authority"],
                answer: "Withholding agent"
            }
        ];
        let vocabQuestionIndex = 0;

        function displayVocabQuestion() {
            const container = document.getElementById('vocabQuizContainer');
            if (vocabQuestionIndex >= vocabQuestions.length) {
                container.innerHTML = '<div class="feedback-box excellent">You have completed the vocabulary quiz!</div>';
                document.getElementById('nextVocabBtn').style.display = 'none';
                return;
            }
            const q = vocabQuestions[vocabQuestionIndex];
            container.innerHTML = `
                <div class="quiz-container">
                    <div class="question-counter">Question ${vocabQuestionIndex + 1}/${vocabQuestions.length}</div>
                    <div class="quiz-question">${q.question}</div>
                    <div class="quiz-options">
                        ${q.options.map(opt => `<div class="quiz-option">${opt}</div>`).join('')}
                    </div>
                </div>`;
            document.querySelectorAll('#vocabQuizContainer .quiz-option').forEach(option => {
                option.onclick = () => checkVocabAnswer(option, q.answer);
            });
            document.getElementById('nextVocabBtn').onclick = nextVocabQuestion;
        }

        function checkVocabAnswer(element, correctAnswer) {
            const isCorrect = element.textContent === correctAnswer;
            const options = element.closest('.quiz-options').querySelectorAll('.quiz-option');
            options.forEach(opt => opt.style.pointerEvents = 'none');
            element.classList.add(isCorrect ? 'correct' : 'incorrect');
            if (!isCorrect) {
                const correctEl = Array.from(options).find(opt => opt.textContent === correctAnswer);
                if (correctEl) correctEl.classList.add('correct');
            }
            if (isCorrect) {
                score += 10;
                streak++;
            } else {
                streak = 0;
            }

            questionsCompleted++;
            updateStats();
            document.getElementById('nextVocabBtn').style.display = 'block';
        }

        function nextVocabQuestion() {
            vocabQuestionIndex++;
            displayVocabQuestion();
            document.getElementById('nextVocabBtn').style.display = 'none';
        }

        // --- Grammar Challenges ---
        const grammarQuestions = [
            { question: "If the company had disclosed the PE, they <span class='gap'></span> a different tax strategy. (would have needed / needed)", answer: "would have needed" },
            { question: "Unless a tax treaty applies, a foreign company <span class='gap'></span> corporate tax on its local profits. (will pay / would pay)", answer: "will pay" }
        ];

        const advancedGrammarQuestions = [
            { question: "The tax advisor said, 'The new treaty will change our tax strategy.'", answer: "The tax advisor said that the new treaty would change their tax strategy." },
            { question: "The CFO stated, 'We should not create a PE in that country.'", answer: "The CFO stated that they should not create a PE in that country." }
        ];

        function setupGrammar() {
            const container = document.getElementById('grammarQuiz');
            container.innerHTML = grammarQuestions.map((q, i) => `
                <div class="quiz-container">
                    <div class="quiz-question">${q.question}</div>
                    <input type="text" class="number-input" id="grammar-q${i}" placeholder="Type your answer...">
                </div>`).join('');
        }

        function checkGrammar() {
            let correctCount = 0;
            grammarQuestions.forEach((q, i) => {
                const input = document.getElementById(`grammar-q${i}`);
                if (input.value.toLowerCase().trim() === q.answer.toLowerCase().trim()) {
                    input.classList.add('correct');
                    correctCount++;
                } else {
                    input.classList.add('incorrect');
                }
            });
            showFeedback('grammarFeedback', correctCount === grammarQuestions.length);
            if (correctCount === grammarQuestions.length) {
                score += 20;
                streak++;
            } else {
                streak = 0;
            }
            questionsCompleted++;
            updateStats();
        }

        function setupAdvancedGrammar() {
            const container = document.getElementById('advancedGrammarQuiz');
            container.innerHTML = advancedGrammarQuestions.map((q, i) => `
                <div class="quiz-container">
                    <div class="quiz-question"><strong>Direct Speech:</strong> ${q.question}</div>
                    <div style="margin-top:10px;"><strong>Reported Speech:</strong> <input type="text" class="number-input" style="width:100%;" id="adv-grammar-q${i}" placeholder="Type your reported speech answer..."></div>
                </div>`).join('');
        }

        function checkAdvancedGrammar() {
            let correctCount = 0;
            advancedGrammarQuestions.forEach((q, i) => {
                const input = document.getElementById(`adv-grammar-q${i}`);
                if (input.value.toLowerCase().trim() === q.answer.toLowerCase().trim()) {
                    input.classList.add('correct');
                    correctCount++;
                } else {
                    input.classList.add('incorrect');
                }
            });
            showFeedback('advancedGrammarFeedback', correctCount === advancedGrammarQuestions.length);
            if (correctCount === advancedGrammarQuestions.length) {
                score += 25;
                streak++;
            } else {
                streak = 0;
            }
            questionsCompleted++;
            updateStats();
        }

        // --- Initial setup function to call everything ---
        function setupUI() {
            totalQuestions = speedQuestions.length + comprehensionQuestions.length + readingAnalysisQuestions.length + grammarQuestions.length + advancedGrammarQuestions.length + vocabQuestions.length + 1;
            displayComprehensionQuestion();
            displayReadingAnalysisQuestion();
            setupGapFill();
            displayVocabQuestion();
            setupGrammar();
            setupAdvancedGrammar();
            updateStats();
        }
    </script>
</body>
</html>
