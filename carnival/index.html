<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title id="page-title">Loading...</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/init-auth.js"></script>

    <script>
const LESSON_CONFIG = {

    title:      "üé≠ Satire in the Spotlight",
    subtitle:   "Art, power, and papier-m√¢ch√© ‚Äî a German artist on trial in Moscow!",
    level:      "Intermediate",
    lessonId:   "carnival-satire",
    lessonLink: "/carnival-satire/",
    logoEmoji:  "üé≠",
    levelPage:  "/intermediate/",

    colors: {
        primary:    "#C0392B",
        secondary:  "#1A1A2E",
        background: "#F5F0E8"
    },

    vocabulary: [
        { word: "Satirist",     type: "noun",      definition: "A person who uses humour, irony, or exaggeration to criticise people or ideas." },
        { word: "Sculptor",     type: "noun",      definition: "An artist who makes three-dimensional works of art by carving or shaping materials." },
        { word: "Discrediting", type: "verb",      definition: "Damaging the reputation or good opinion of someone or something." },
        { word: "Extradition",  type: "noun",      definition: "The process of sending a person accused of a crime back to the country where the crime was committed." },
        { word: "Unprecedented", type: "adjective", definition: "Never having happened or existed before." },
        { word: "In absentia",  type: "phrase",    definition: "Latin phrase meaning 'while absent' ‚Äî a trial held without the accused being present." },
        { word: "Satirical",    type: "adjective", definition: "Using satire; using humour and criticism to expose problems or foolishness." },
        { word: "Dismantles",   type: "verb",      definition: "Takes something apart, piece by piece." },
        { word: "Extremists",   type: "noun",      definition: "People who hold views far outside what is normally accepted, often dangerously so." },
        { word: "Recurring",    type: "adjective", definition: "Happening again and again, repeatedly." }
    ],

    sections: [

        {
            type:  "video",
            title: "üé¨ 1. Watch: The German Satirist Challenging Putin",
            intro: "Watch this DW documentary about Jacques Tilly, the German sculptor whose carnival floats have landed him in serious trouble with Russia. Pay attention to the key events and people mentioned.",
            youtubeUrl: "https://www.youtube-nocookie.com/embed/quBjeKV4vWI?si=82BmlJymBH6jUjfC",
            discussion: [
                "Have you ever seen political cartoons or satire in your country? What do you think of them?",
                "Should artists be allowed to mock political leaders? Where is the limit?",
                "Why do you think Russia is putting a German artist on trial?"
            ]
        },

        {
            type:  "reading",
            title: "üì∞ 2. Reading: The Story of Jacques Tilly",

            facts: [
                "D√ºsseldorf's Rose Monday parade is one of the largest carnival events in Germany",
                "Jacques Tilly has been building satirical floats since the 1980s",
                "Russia charged Tilly in December ‚Äî the trial has been postponed multiple times",
                "The tradition of political satire at carnival dates back to the 19th century"
            ],

            content: `
                <p class="mb-4">Jacques Tilly is a German <vocab>sculptor</vocab> based in D√ºsseldorf. For decades, he has been one of Germany's most famous <vocab>satirist</vocab>s, creating giant papier-m√¢ch√© figures that mock politicians, <vocab>extremists</vocab>, and powerful people around the world.</p>
                <p class="mb-4">Every year, his <vocab>satirical</vocab> floats appear in the Rose Monday parade ‚Äî the highlight of the Rhineland carnival season. The tradition dates to the 19th century, when carnival's so-called "fools' freedom" allowed people to challenge those in power more openly than usual.</p>
                <p class="mb-4">This year, however, Tilly's art has had real-world consequences. Russian authorities have accused him of <vocab>discrediting</vocab> the Russian army and spreading false information. He is now on trial in Moscow ‚Äî <vocab>in absentia</vocab>, meaning without being present in the courtroom.</p>
                <p class="mb-4">This is an <vocab>unprecedented</vocab> case: Russia is putting a German citizen on trial for artwork created on German soil. Because Tilly lives in Germany, he would only face arrest if he travels to countries with <vocab>extradition</vocab> agreements with Russia.</p>
                <p class="mb-4">Putin has been a <vocab>recurring</vocab> target of Tilly's work ‚Äî from the relationship between the Kremlin and the Russian Orthodox Church, to Russia's war in Ukraine. The day after each Rose Monday parade, Tilly's team <vocab>dismantles</vocab> the floats ‚Äî but the debate over artistic freedom continues long after.</p>
            `
        },

        {
            type:  "trueFalse",
            title: "‚úÖ 3. True or False?",
            questions: [
                { question: "Jacques Tilly is a French sculptor living in Paris.",                             answer: false },
                { question: "The Rose Monday parade takes place in Germany's Rhineland region.",               answer: true  },
                { question: "Tilly was arrested in Germany after the charges were filed.",                     answer: false },
                { question: "The tradition of political satire at carnival dates back to the 19th century.",   answer: true  },
                { question: "The floats are kept on display in a museum after the parade.",                    answer: false }
            ]
        },

        {
            type:  "multipleChoice",
            title: "üéØ 4. Comprehension Check",
            questions: [
                {
                    question: "Why is the case against Jacques Tilly described as 'unprecedented'?",
                    options: [
                        "Because it is the first time an artist has been arrested at a carnival parade",
                        "Because Russia is putting a German citizen on trial for artwork made in Germany",
                        "Because Tilly refused to appear in a Russian court in person"
                    ],
                    correct: 1
                },
                {
                    question: "What does 'in absentia' mean in the context of Tilly's trial?",
                    options: [
                        "The trial is happening without Tilly being present",
                        "The trial has been cancelled permanently",
                        "Tilly has been found not guilty"
                    ],
                    correct: 0
                },
                {
                    question: "What is the 'fools' freedom' mentioned in the video?",
                    options: [
                        "A law that allows carnival performers to break traffic rules",
                        "A tradition where satire was used to challenge authority more freely",
                        "A prize given to the best carnival float each year"
                    ],
                    correct: 1
                },
                {
                    question: "When would Tilly actually be at risk of arrest?",
                    options: [
                        "If he publishes more satirical artwork online",
                        "If he travels to a country that has an extradition agreement with Russia",
                        "If Russia sends police to Germany"
                    ],
                    correct: 1
                }
            ]
        },

        {
            type:  "gapFill",
            title: "üß© 5. Fill the Gaps",
            wordBank: ["dismantles", "recurring", "satirical", "unprecedented", "extradition", "discrediting"],
            sentences: [
                { text: "Russia accused Tilly of ___ the Russian army.",                              answer: "discrediting"  },
                { text: "Tilly would only be arrested in countries with ___ agreements with Russia.", answer: "extradition"   },
                { text: "Putting a German citizen on trial for German artwork is ___.",                answer: "unprecedented" },
                { text: "Putin has been a ___ target in Tilly's work.",                               answer: "recurring"     },
                { text: "After Rose Monday, Tilly's team ___ the floats.",                            answer: "dismantles"    },
                { text: "The ___ motto floats are built in secret in the weeks before the parade.",   answer: "satirical"     }
            ]
        },

        {
            type:  "wordForms",
            title: "üî§ 6. Word Forms",
            questions: [
                { prompt: "The artist creates works of ___. (satirist ‚Üí the art form itself)",                     answer: "satire"       },
                { prompt: "His sculptures are full of ___. (creative ‚Üí the noun form)",                            answer: "creativity"   },
                { prompt: "Russia has ___ him of spreading false information. (accusation ‚Üí past tense verb)",     answer: "accused"      },
                { prompt: "The floats were built with ___. (secret ‚Üí the noun: done in ___)",                      answer: "secrecy"      }
            ]
        },

        {
            type:  "grammar",
            title: "üìñ 7. Grammar: Present Perfect vs Past Simple",

            explanation: {
                heading: "üìå Present Perfect vs Past Simple",
                text: "Use <strong>Past Simple</strong> for finished actions at a specific time. Use <strong>Present Perfect</strong> for actions connected to the present, or when no specific time is given.",
                examples: [
                    { label: "‚úÖ Past Simple:",       sentence: "Tilly <em>built</em> the floats last month. (specific time)" },
                    { label: "‚úÖ Present Perfect:",   sentence: "Russia <em>has charged</em> Tilly with spreading false information. (still relevant now)" }
                ]
            },

            questions: [
                {
                    sentence: "Jacques Tilly ___ satirical floats since the 1980s.",
                    hint:     "Ongoing action from the past to now ‚Üí Present Perfect",
                    options:  ["made", "has made", "makes"],
                    answer:   "has made"
                },
                {
                    sentence: "The trial ___ several times since December.",
                    hint:     "Repeated action with a result in the present ‚Üí Present Perfect",
                    options:  ["postponed", "has been postponed", "is postponed"],
                    answer:   "has been postponed"
                },
                {
                    sentence: "The team ___ the floats the day after the parade.",
                    hint:     "Specific time in the past ‚Üí Past Simple",
                    options:  ["has dismantled", "dismantles", "dismantled"],
                    answer:   "dismantled"
                },
                {
                    sentence: "The tradition of carnival satire ___ in the 19th century.",
                    hint:     "A finished event at a specific time in the past ‚Üí Past Simple",
                    options:  ["begins", "began", "has begun"],
                    answer:   "began"
                }
            ]
        }

    ],

    grammar: [
        { question: 'Present Perfect: Tilly + build + floats since 1980s',      answer: "has made",           explanation: "Ongoing action uses present perfect" },
        { question: 'Present Perfect Passive: trial + postpone + since December', answer: "has been postponed", explanation: "Passive present perfect for result in present" },
        { question: 'Past Simple: team + dismantle + floats (the day after)',    answer: "dismantled",         explanation: "Specific past time uses past simple" },
        { question: 'Past Simple: tradition + begin + 19th century',             answer: "began",              explanation: "Completed past event uses past simple" }
    ],

    badges: [
        { icon: "üé≠", text: "Satire Scholar!"       },
        { icon: "üóûÔ∏è", text: "News Detective!"       },
        { icon: "üéØ", text: "Perfect Score!"        },
        { icon: "üìö", text: "Word Power!"           },
        { icon: "üåç", text: "Global Thinker!"       },
        { icon: "‚úä", text: "Free Speech Hero!"     }
    ]

};
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Source+Serif+4:ital,wght@0,300;0,400;0,600;1,400&display=swap');

        :root {
            --color-primary:    #C0392B;
            --color-secondary:  #1A1A2E;
            --color-background: #F5F0E8;
            --color-correct:    #27AE60;
            --color-incorrect:  #C0392B;
            --color-ink:        #1A1A2E;
            --color-cream:      #F5F0E8;
            --color-paper:      #FDF8F0;
            --color-rule:       #D4C5A9;
            --spacing-mobile:   16px;
            --spacing-desktop:  24px;
            --touch-min:        48px;
            --bottom-nav-height: 70px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Source Serif 4', Georgia, serif;
            background: var(--color-background);
            background-image:
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 27px,
                    rgba(180, 160, 120, 0.15) 27px,
                    rgba(180, 160, 120, 0.15) 28px
                );
            color: var(--color-ink);
            line-height: 1.7;
            -webkit-font-smoothing: antialiased;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: var(--bottom-nav-height);
        }
        @media (min-width: 768px) { body { padding-bottom: 0; } }

        /* HEADER */
        .header {
            background: var(--color-secondary);
            border-bottom: 4px solid var(--color-primary);
            padding: 12px var(--spacing-mobile);
            position: sticky; top: 0; z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        @media (min-width: 768px) { .header { padding: 16px var(--spacing-desktop); } }

        .header-content { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
        .header-left { display: flex; align-items: center; gap: 12px; }

        .logo {
            width: 38px; height: 38px;
            background: var(--color-primary);
            border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px;
            box-shadow: 2px 2px 0 rgba(255,255,255,0.1);
        }

        .site-title {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 16px; font-weight: 900;
            color: #F5F0E8;
            text-decoration: none;
            letter-spacing: 0.5px;
            display: none;
        }
        @media (min-width: 480px) { .site-title { display: inline; } }
        @media (min-width: 768px) { .site-title { font-size: 20px; } }

        .streak-display {
            display: flex; align-items: center; gap: 8px;
            background: rgba(255,255,255,0.07);
            padding: 6px 12px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.15);
        }
        .streak-item { display: flex; align-items: center; gap: 6px; }
        .streak-icon { font-size: 16px; }
        .streak-number { font-family: 'Playfair Display', serif; font-size: 18px; font-weight: 900; color: var(--color-primary); }
        .streak-label { font-size: 10px; color: #A0AEC0; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; display: none; }
        @media (min-width: 480px) { .streak-label { display: block; } }

        /* MAIN CONTAINER */
        .container-main {
            max-width: 900px; margin: 30px auto;
            padding: 32px var(--spacing-mobile);
            background: var(--color-paper);
            border-radius: 2px;
            box-shadow: 0 8px 40px rgba(0,0,0,0.12), 4px 4px 0 var(--color-rule);
            border: 1px solid var(--color-rule);
            position: relative;
        }
        .container-main::before {
            content: '';
            position: absolute;
            top: 0; left: 60px;
            width: 2px; height: 100%;
            background: rgba(192, 57, 43, 0.15);
        }
        @media (min-width: 768px) { .container-main { margin: 40px auto; padding: 48px var(--spacing-desktop) 48px 80px; } }

        .lesson-main-title {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 2em; font-weight: 900;
            color: var(--color-secondary);
            margin-bottom: 4px;
            line-height: 1.2;
            border-bottom: 3px double var(--color-primary);
            padding-bottom: 12px;
        }
        @media (min-width: 768px) { .lesson-main-title { font-size: 3em; } }

        .lesson-subtitle {
            font-size: 0.95em;
            color: #6B5B45;
            margin: 10px 0 20px;
            font-style: italic;
            padding-left: 2px;
        }

        /* PROGRESS BAR */
        .progress-container {
            background: var(--color-rule);
            height: 6px; border-radius: 0;
            margin-bottom: 32px; overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: var(--color-primary);
            width: 0%; transition: width 0.6s cubic-bezier(0.4,0,0.2,1);
        }

        /* SECTIONS */
        .lesson-section {
            background: transparent;
            padding: 24px 0;
            border-bottom: 2px dashed var(--color-rule);
            margin-bottom: 32px;
            opacity: 0; transform: translateY(16px); transition: opacity 0.5s, transform 0.5s;
        }
        .lesson-section.visible { opacity: 1; transform: translateY(0); }

        .section-title {
            font-family: 'Playfair Display', Georgia, serif;
            color: var(--color-secondary);
            font-size: 1.3em; font-weight: 900;
            margin-bottom: 18px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--color-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        @media (min-width: 768px) { .section-title { font-size: 1.5em; } }

        /* VIDEO */
        .video-intro { color: #5A4A38; margin-bottom: 14px; font-size: 1em; font-style: italic; }
        .video-wrapper { width: 100%; margin: 0 auto 16px; }
        @media (min-width: 768px) { .video-wrapper { max-width: 800px; margin: 0 auto 20px; } }
        .video-container {
            position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;
            border-radius: 2px;
            box-shadow: 6px 6px 0 var(--color-secondary);
            background: #000;
            border: 3px solid var(--color-secondary);
        }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        .discussion-box {
            background: var(--color-secondary);
            border-left: 5px solid var(--color-primary);
            padding: 16px 20px;
            border-radius: 2px;
            margin-top: 16px;
        }
        .discussion-box h3 { color: var(--color-primary); font-family: 'Playfair Display', serif; font-size: 1em; font-weight: 900; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        .discussion-box li { list-style: none; padding: 8px 0 8px 28px; position: relative; color: #D4C5A9; border-bottom: 1px solid rgba(255,255,255,0.08); font-size: 0.95em; font-style: italic; }
        .discussion-box li:last-child { border-bottom: none; }
        .discussion-box li::before { content: 'üí¨'; position: absolute; left: 0; }

        /* READING */
        .fact-box {
            background: var(--color-secondary);
            border: 2px solid var(--color-primary);
            border-radius: 2px;
            padding: 16px 20px;
            margin-bottom: 20px;
        }
        .fact-box h4 { color: var(--color-primary); font-family: 'Playfair Display', serif; font-size: 0.9em; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
        .fact-box li { list-style: none; padding: 6px 0 6px 24px; position: relative; color: #D4C5A9; border-bottom: 1px solid rgba(255,255,255,0.08); font-size: 0.9em; }
        .fact-box li:last-child { border-bottom: none; }
        .fact-box li::before { content: '‚ñ†'; position: absolute; left: 0; color: var(--color-primary); font-size: 0.7em; top: 10px; }

        .reading-text {
            background: white;
            border-left: 5px solid var(--color-primary);
            padding: 20px 24px;
            border-radius: 0 2px 2px 0;
            font-size: 1.05em;
            color: var(--color-secondary);
            line-height: 1.8;
            box-shadow: inset 0 0 0 1px rgba(0,0,0,0.05);
        }
        @media (min-width: 768px) { .reading-text { font-size: 1.1em; } }
        .reading-text .mb-4 { margin-bottom: 1.2rem; }

        .highlight-word {
            color: var(--color-primary);
            font-weight: 700;
            cursor: pointer;
            border-bottom: 2px dotted var(--color-primary);
            display: inline-block;
            padding: 1px 3px;
            transition: all 0.2s;
        }
        .highlight-word:active { background: var(--color-primary); color: white; border-radius: 2px; border-bottom-color: transparent; }
        @media (min-width: 768px) { .highlight-word:hover { background: var(--color-primary); color: white; border-radius: 2px; border-bottom-color: transparent; } }

        /* QUESTIONS */
        .question-box {
            background: white;
            border: 1px solid var(--color-rule);
            border-left: 4px solid var(--color-secondary);
            border-radius: 2px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 2px 2px 0 var(--color-rule);
        }
        .question-text { font-size: 1em; font-weight: 600; margin-bottom: 10px; color: var(--color-secondary); font-family: 'Source Serif 4', serif; }

        .option-button {
            display: block; width: 100%; text-align: left;
            padding: 12px 16px; min-height: var(--touch-min); margin-top: 8px;
            background: var(--color-cream);
            border: 2px solid var(--color-rule);
            border-radius: 2px;
            font-weight: 600; cursor: pointer; transition: all 0.2s;
            color: var(--color-secondary); font-size: 0.95em;
            font-family: 'Source Serif 4', serif;
            -webkit-appearance: none;
        }
        .option-button:active { transform: scale(0.98); }
        @media (min-width: 768px) { .option-button:hover { background: #EDE8DF; border-color: var(--color-secondary); } }
        .option-button.selected   { background: #EDE8DF; border-color: var(--color-secondary); }
        .option-button.correct    { background: #D5EFDC !important; color: #1A4A2A !important; border-color: var(--color-correct) !important; }
        .option-button.incorrect  { background: #F9D5D3 !important; color: #7A1A1A !important; border-color: var(--color-primary) !important; }

        /* GAP FILL */
        .word-bank {
            background: var(--color-secondary);
            border: 2px solid var(--color-primary);
            border-radius: 2px;
            padding: 14px 18px;
            margin-bottom: 18px;
        }
        .word-bank-label { font-weight: 700; color: var(--color-primary); margin-bottom: 10px; font-size: 0.85em; text-transform: uppercase; letter-spacing: 1px; font-family: 'Playfair Display', serif; }
        .word-options { display: flex; flex-wrap: wrap; gap: 8px; }

        .word-option {
            background: var(--color-primary); color: white;
            padding: 8px 14px; min-height: 40px;
            display: inline-flex; align-items: center;
            border-radius: 2px; cursor: pointer; transition: 0.2s;
            font-weight: 600; font-size: 0.9em; -webkit-appearance: none; border: none;
            font-family: 'Source Serif 4', serif;
        }
        .word-option.selected { background: #8B1A10; transform: scale(1.05); box-shadow: 0 0 0 2px white; }
        .word-option.used { opacity: 0.25; pointer-events: none; }

        .gap-sentences { font-size: 1.05em; line-height: 3; }

        .gap-input {
            display: inline-block; text-align: center;
            padding: 4px 8px; min-width: 120px; min-height: 34px;
            background: white;
            border: 3px dashed var(--color-primary);
            border-radius: 2px;
            font-weight: 700; cursor: pointer; margin: 0 4px;
            font-size: 0.95em; line-height: 26px; transition: all 0.2s;
            font-family: 'Source Serif 4', serif;
        }
        .gap-input.correct   { background: #D5EFDC !important; border-color: var(--color-correct) !important; border-style: solid; pointer-events: none; }
        .gap-input.incorrect { background: #F9D5D3 !important; border-color: var(--color-primary) !important; border-style: solid; }

        /* WORD FORMS */
        .word-form-item { margin-bottom: 18px; }
        .word-form-prompt { font-weight: 600; color: var(--color-secondary); margin-bottom: 8px; font-size: 1em; font-style: italic; }
        .word-form-input {
            width: 100%; padding: 12px 16px; min-height: var(--touch-min);
            border: 2px solid var(--color-rule); border-radius: 2px;
            transition: 0.3s; font-size: 1em;
            font-family: 'Source Serif 4', serif;
            background: white; color: var(--color-secondary);
        }
        .word-form-input:focus { outline: none; border-color: var(--color-primary); }
        .word-form-input.revealed { background: #D5EFDC !important; font-weight: 700; color: #1A4A2A; border-color: var(--color-correct); }

        /* GRAMMAR */
        .grammar-explanation {
            background: var(--color-secondary);
            color: #F5F0E8;
            padding: 20px; border-radius: 2px;
            border-left: 5px solid var(--color-primary);
            margin-bottom: 20px;
        }
        .grammar-explanation h4 { color: var(--color-primary); font-family: 'Playfair Display', serif; font-size: 1em; font-weight: 900; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .grammar-explanation p { color: #D4C5A9; font-size: 0.95em; margin-bottom: 10px; }
        .grammar-example { background: rgba(255,255,255,0.06); padding: 10px 14px; border-left: 3px solid var(--color-primary); border-radius: 0 2px 2px 0; margin: 6px 0; font-size: 0.9em; }
        .grammar-example strong { color: var(--color-primary); }
        .grammar-example span { color: #D4C5A9; }

        .grammar-card {
            background: white;
            border-left: 4px solid var(--color-primary);
            padding: 14px 18px;
            margin-bottom: 12px;
            border-radius: 0 2px 2px 0;
            box-shadow: 2px 2px 0 var(--color-rule);
        }
        @media (min-width: 768px) { .grammar-card { display: flex; justify-content: space-between; align-items: center; gap: 20px; } }
        .grammar-card-text { margin-bottom: 10px; }
        @media (min-width: 768px) { .grammar-card-text { margin-bottom: 0; flex: 1; } }
        .grammar-card-sentence { font-weight: 700; color: var(--color-secondary); font-size: 1em; margin-bottom: 4px; }
        .grammar-card-hint { font-size: 0.85em; color: #9CA3AF; font-style: italic; }

        .grammar-select {
            width: 100%; padding: 12px 14px; min-height: var(--touch-min);
            border: 2px solid var(--color-rule); border-radius: 2px;
            font-weight: 700; cursor: pointer; font-size: 0.95em;
            -webkit-appearance: none; background: var(--color-cream);
            color: var(--color-secondary); font-family: 'Source Serif 4', serif;
        }
        @media (min-width: 768px) { .grammar-select { width: auto; min-width: 200px; } }
        .grammar-select.correct   { background: #D5EFDC; border-color: var(--color-correct); color: #1A4A2A; }
        .grammar-select.incorrect { background: #F9D5D3; border-color: var(--color-primary); color: #7A1A1A; }

        /* BUTTONS */
        .button-group { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
        @media (min-width: 768px) { .button-group { flex-direction: row; margin-top: 24px; } }

        .btn-continue, .btn-check, .btn-reveal, .btn-reset {
            padding: 14px 24px; min-height: var(--touch-min); border: none; border-radius: 2px;
            cursor: pointer; font-weight: 700; transition: 0.2s; width: 100%; font-size: 0.95em;
            -webkit-appearance: none; font-family: 'Playfair Display', serif;
            text-transform: uppercase; letter-spacing: 1px;
        }
        @media (min-width: 768px) { .btn-continue, .btn-check, .btn-reveal, .btn-reset { width: auto; padding: 12px 28px; } }

        .btn-continue, .btn-check { background: var(--color-primary); color: white; box-shadow: 3px 3px 0 #8B1A10; }
        .btn-continue:active, .btn-check:active { transform: translate(2px, 2px); box-shadow: 1px 1px 0 #8B1A10; }
        @media (min-width: 768px) { .btn-continue:hover, .btn-check:hover { background: #A93226; } }

        .btn-reveal { background: var(--color-secondary); color: #F5F0E8; box-shadow: 3px 3px 0 #0D0D1A; }
        .btn-reset  { background: #8B7355; color: white; box-shadow: 3px 3px 0 #5A4A38; }

        /* RESULT MESSAGES */
        .result-message { margin-top: 14px; padding: 14px 18px; border-radius: 2px; font-weight: 700; display: none; font-size: 1em; border-left: 5px solid; }
        .result-message.correct   { background: #D5EFDC; color: #1A4A2A; border-color: var(--color-correct); }
        .result-message.incorrect { background: #F9D5D3; color: #7A1A1A; border-color: var(--color-primary); }

        /* BOTTOM NAV */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--color-secondary);
            border-top: 3px solid var(--color-primary);
            padding: 10px 16px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            display: flex; align-items: center; gap: 10px;
            z-index: 200;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
        }
        @media (min-width: 768px) { .bottom-nav { display: none; } }
        .bottom-nav-btn {
            flex: 1; background: rgba(255,255,255,0.08); color: #D4C5A9;
            border: 1px solid rgba(255,255,255,0.15);
            padding: 12px; border-radius: 2px;
            font-weight: 700; font-size: 13px; min-height: var(--touch-min);
            cursor: pointer; transition: all 0.2s;
            font-family: 'Playfair Display', serif;
            -webkit-appearance: none;
        }
        .bottom-nav-btn.primary { flex: 2; background: var(--color-primary); color: white; border-color: var(--color-primary); }
        .bottom-nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .section-indicator { font-size: 11px; font-weight: 700; color: #A0AEC0; white-space: nowrap; font-family: 'Playfair Display', serif; }

        /* DICTIONARY POPUP */
        #dictionary-popup {
            position: fixed; bottom: var(--bottom-nav-height); left: 16px; right: 16px;
            background: var(--color-secondary);
            border-top: 4px solid var(--color-primary);
            padding: 20px; border-radius: 4px 4px 0 0;
            z-index: 2000; display: none;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.4);
            animation: slideUp 0.3s;
            max-height: 50vh; overflow-y: auto;
        }
        @media (min-width: 768px) {
            #dictionary-popup {
                position: fixed; bottom: auto; left: auto; right: auto;
                max-width: 320px; border-radius: 4px;
            }
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .popup-close {
            position: absolute; top: 12px; right: 12px;
            width: 32px; height: 32px; border-radius: 2px;
            background: rgba(255,255,255,0.1); border: none;
            font-size: 18px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; color: white;
        }

        /* BADGES */
        .badge-container { position: fixed; top: 80px; right: 10px; display: flex; flex-direction: column; gap: 8px; z-index: 999; }
        @media (min-width: 768px) { .badge-container { top: 100px; right: 20px; } }
        .badge {
            background: var(--color-secondary);
            padding: 12px 16px; border-radius: 2px;
            box-shadow: 4px 4px 0 var(--color-primary);
            display: flex; align-items: center; gap: 10px;
            transform: translateX(300px); opacity: 0; transition: all 0.5s;
            border-left: 4px solid var(--color-primary);
        }
        .badge.show { transform: translateX(0); opacity: 1; }
        .badge-icon { font-size: 22px; }
        .badge-text { font-weight: 700; color: #F5F0E8; font-size: 13px; font-family: 'Playfair Display', serif; }

        /* CELEBRATION */
        .celebration {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%,-50%) scale(0);
            background: var(--color-primary);
            color: white; padding: 28px 40px;
            border-radius: 4px;
            font-family: 'Playfair Display', serif;
            font-size: 1.5em; font-weight: 900;
            box-shadow: 8px 8px 0 var(--color-secondary);
            z-index: 1000; opacity: 0; transition: all 0.4s;
            text-align: center;
        }
        @media (min-width: 768px) { .celebration { padding: 40px 60px; font-size: 2em; } }
        .celebration.show { opacity: 1; transform: translate(-50%,-50%) scale(1); }
    </style>
</head>
<body>

    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <a href="#" id="logo-link" style="text-decoration:none;">
                    <span class="logo" id="logo-emoji">üòé</span>
                </a>
                <a href="/advanced/" class="site-title">English For Cool Dudes</a>
            </div>
            <div class="streak-display">
                <div class="streak-item">
                    <span class="streak-icon">üî•</span>
                    <div>
                        <div class="streak-number" id="streak-count">0</div>
                        <div class="streak-label">Streak</div>
                    </div>
                </div>
                <div class="streak-item">
                    <span class="streak-icon">üéØ</span>
                    <div>
                        <div class="streak-number" id="total-lessons">0</div>
                        <div class="streak-label">Lessons</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="badge-container" id="badge-container"></div>
    <div class="celebration" id="celebration"></div>

    <div class="container-main">
        <h1 class="lesson-main-title" id="lesson-title">Loading...</h1>
        <p class="lesson-subtitle" id="lesson-subtitle"></p>
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div id="daily-challenge-widget"></div>
        <div id="lesson-sections"></div>
    </div>

    <nav class="bottom-nav">
        <button class="bottom-nav-btn" onclick="previousSection()" id="btn-prev" disabled>‚Üê Back</button>
        <span class="section-indicator" id="section-indicator">1/1</span>
        <button class="bottom-nav-btn primary" onclick="nextSection()" id="btn-next">Next ‚Üí</button>
    </nav>

    <div id="dictionary-popup">
        <button class="popup-close" onclick="closePopup()">√ó</button>
        <div id="popup-content"></div>
    </div>

    <script src="/supabase-auth-gamified.js"></script>
    <script src="/daily-challenges-system.js"></script>
    <script src="/word-match-game.js"></script>

    <script>
let currentSection    = 1;
let completedSections = 0;
let selectedGapWord   = null;

(function buildLesson() {
    if (LESSON_CONFIG.colors) {
        const r = document.documentElement;
        if (LESSON_CONFIG.colors.primary)    r.style.setProperty('--color-primary',    LESSON_CONFIG.colors.primary);
        if (LESSON_CONFIG.colors.secondary)  r.style.setProperty('--color-secondary',  LESSON_CONFIG.colors.secondary);
        if (LESSON_CONFIG.colors.background) {
            r.style.setProperty('--color-background', LESSON_CONFIG.colors.background);
            document.body.style.background = LESSON_CONFIG.colors.background;
        }
    }

    document.getElementById('page-title').textContent     = LESSON_CONFIG.title + ' - English For Cool Dudes';
    document.getElementById('lesson-title').textContent   = LESSON_CONFIG.title;
    document.getElementById('lesson-subtitle').textContent = LESSON_CONFIG.level + ' | ' + LESSON_CONFIG.subtitle;
    document.getElementById('logo-emoji').textContent     = LESSON_CONFIG.logoEmoji;
    document.getElementById('logo-link').href             = LESSON_CONFIG.levelPage;

    const container = document.getElementById('lesson-sections');
    let html = '';
    let num  = 0;

    LESSON_CONFIG.sections.forEach((sec, i) => {
        num++;
        const vis = i === 0 ? ' visible' : '';
        const attr = `class="lesson-section${vis}" data-section="${num}"`;

        if (sec.type === 'video') {
            const discussHTML = sec.discussion && sec.discussion.length
                ? `<div class="discussion-box"><h3>üí¨ Discussion Questions</h3><ul>${sec.discussion.map(q=>`<li>${q}</li>`).join('')}</ul></div>`
                : '';
            html += `<section ${attr}>
                <h2 class="section-title">${sec.title}</h2>
                ${sec.intro ? `<p class="video-intro">${sec.intro}</p>` : ''}
                <div class="video-wrapper"><div class="video-container">
                    <iframe src="${sec.youtubeUrl}" title="Video" frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
                </div></div>
                ${discussHTML}
                <div class="button-group" style="margin-top:16px;">
                    <button class="btn-continue" onclick="completeSection(${num})">Continue ‚Üí</button>
                </div>
            </section>`;
        }

        else if (sec.type === 'reading') {
            const content = sec.content.replace(/<vocab>(.*?)<\/vocab>/gi, (m, w) =>
                `<span class="highlight-word" onclick="showPopup(this,'${w}')">${w}</span>`);
            const factsHTML = sec.facts && sec.facts.length
                ? `<div class="fact-box"><h4>‚ñ† Key Facts</h4><ul>${sec.facts.map(f=>`<li>${f}</li>`).join('')}</ul></div>`
                : '';
            html += `<section ${attr}>
                <h2 class="section-title">${sec.title}</h2>
                ${factsHTML}
                <div class="reading-text">${content}</div>
                <div class="button-group" style="margin-top:16px;">
                    <button class="btn-continue" onclick="completeSection(${num})">Continue ‚Üí</button>
                </div>
            </section>`;
        }

        else if (sec.type === 'trueFalse') {
            const qHTML = sec.questions.map((q, qi) => `
                <div class="question-box">
                    <p class="question-text">${qi+1}. ${q.question}</p>
                    <div class="comp-btn-group">
                        <button class="option-button" data-correct="${q.answer === true}">True</button>
                        <button class="option-button" data-correct="${q.answer === false}">False</button>
                    </div>
                </div>`).join('');
            html += `<section ${attr}>
                <h2 class="section-title">${sec.title}</h2>
                ${qHTML}
                <div class="button-group">
                    <button class="btn-check" onclick="checkTrueFalse(${num})">Check Answers</button>
                    <button class="btn-reset" onclick="resetTrueFalse(${num})">Reset</button>
                </div>
                <div id="result-${num}" class="result-message"></div>
            </section>`;
        }

        else if (sec.type === 'multipleChoice') {
            const qHTML = sec.questions.map((q, qi) => {
                const opts = q.options.map((o, oi) =>
                    `<button class="option-button" data-correct="${oi === q.correct}">${o}</button>`).join('');
                return `<div class="question-box">
                    <p class="question-text">${qi+1}. ${q.question}</p>
                    <div class="comp-btn-group">${opts}</div>
                </div>`;
            }).join('');
            html += `<section ${attr}>
                <h2 class="section-title">${sec.title}</h2>
                ${qHTML}
                <div class="button-group">
                    <button class="btn-check" onclick="checkMultiChoice(${num})">Check Answers</button>
                    <button class="btn-reset" onclick="resetMultiChoice(${num})">Reset</button>
                </div>
                <div id="result-${num}" class="result-message"></div>
            </section>`;
        }

        else if (sec.type === 'gapFill') {
            const bankHTML = sec.wordBank.map(w =>
                `<button class="word-option" data-word="${w}">${w}</button>`).join('');
            const sentHTML = sec.sentences.map((s, si) => {
                const parts = s.text.split('___');
                return `<p class="mb-4">${si+1}. ${parts[0]}<span class="gap-input" data-answer="${s.answer}"></span>${parts[1]||''}</p>`;
            }).join('');
            html += `<section ${attr}>
                <h2 class="section-title">${sec.title}</h2>
                <p style="color:#6B5B45;margin-bottom:12px;font-style:italic;">Click a word from the box, then click a gap to fill it.</p>
                <div class="word-bank">
                    <p class="word-bank-label">Word Bank:</p>
                    <div class="word-options">${bankHTML}</div>
                </div>
                <div class="gap-sentences">${sentHTML}</div>
                <div class="button-group">
                    <button class="btn-check" onclick="checkGapFill(${num})">Check Answers</button>
                    <button class="btn-reset" onclick="resetGapFill(${num})">Reset</button>
                </div>
                <div id="result-${num}" class="result-message"></div>
            </section>`;
        }

        else if (sec.type === 'wordForms') {
            const items = sec.questions.map((q, qi) => `
                <div class="word-form-item">
                    <p class="word-form-prompt">${qi+1}. ${q.prompt}</p>
                    <input type="text" class="word-form-input" data-answer="${q.answer}" placeholder="Type your answer here...">
                </div>`).join('');
            html += `<section ${attr}>
                <h2 class="section-title">${sec.title}</h2>
                ${items}
                <div class="button-group">
                    <button class="btn-check"  onclick="checkWordForms(${num})">Check Answers</button>
                    <button class="btn-reveal" onclick="revealWordForms(${num})">Reveal Answers</button>
                    <button class="btn-reset"  onclick="resetWordForms(${num})">Reset</button>
                </div>
                <div id="result-${num}" class="result-message"></div>
            </section>`;
        }

        else if (sec.type === 'grammar') {
            let explHTML = '';
            if (sec.explanation) {
                const ex = sec.explanation;
                const examplesHTML = (ex.examples||[]).map(e =>
                    `<div class="grammar-example"><strong>${e.label}</strong> <span>${e.sentence}</span></div>`).join('');
                explHTML = `<div class="grammar-explanation">
                    <h4>${ex.heading}</h4><p>${ex.text}</p>${examplesHTML}
                </div>`;
            }
            const cards = sec.questions.map((q, qi) => {
                const opts = q.options.map(o => `<option value="${o}">${o}</option>`).join('');
                return `<div class="grammar-card">
                    <div class="grammar-card-text">
                        <p class="grammar-card-sentence">${qi+1}. ${q.sentence}</p>
                        <p class="grammar-card-hint">${q.hint}</p>
                    </div>
                    <select class="grammar-select" data-answer="${q.answer}">
                        <option value="">Choose...</option>${opts}
                    </select>
                </div>`;
            }).join('');
            html += `<section ${attr}>
                <h2 class="section-title">${sec.title}</h2>
                ${explHTML}
                ${cards}
                <div class="button-group">
                    <button class="btn-check" onclick="checkGrammar(${num})">Check Grammar</button>
                    <button class="btn-reset" onclick="resetGrammar(${num})">Reset</button>
                </div>
                <div id="result-${num}" class="result-message"></div>
            </section>`;
        }
    });

    container.innerHTML = html;
    window.totalSections = LESSON_CONFIG.sections.length;
    updateNav();
    updateProgress();
    setTimeout(wireEvents, 50);
})();

async function initStats() {
    if (typeof window.efcdReady !== 'undefined') await window.efcdReady;
    if (typeof window.EFCD_Auth === 'undefined') return;
    await window.EFCD_Auth.initAuth();
    const user = window.EFCD_Auth.getCurrentUser();
    if (user) {
        const s = window.EFCD_Auth.getUserStats();
        document.getElementById('streak-count').textContent  = s.streak;
        document.getElementById('total-lessons').textContent = s.lessonsCompleted;
    }
}
if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initStats);
else initStats();

if (window.DailyChallenges) {
    document.getElementById('daily-challenge-widget').innerHTML =
        window.DailyChallenges.renderDailyChallengeWidget();
}

function nextSection() {
    if (currentSection < window.totalSections) { currentSection++; showSection(currentSection); }
    else completeLessonAndSave();
}
function previousSection() {
    if (currentSection > 1) { currentSection--; showSection(currentSection); }
}
function showSection(num) {
    const sec = document.querySelector(`.lesson-section[data-section="${num}"]`);
    if (sec) { sec.classList.add('visible'); sec.scrollIntoView({ behavior:'smooth', block:'start' }); }
    updateNav();
}
function updateNav() {
    document.getElementById('btn-prev').disabled = (currentSection === 1);
    document.getElementById('btn-next').textContent = currentSection === window.totalSections ? 'Finish ‚úì' : 'Next ‚Üí';
    document.getElementById('section-indicator').textContent = currentSection + '/' + window.totalSections;
}
function updateProgress() {
    const pct = ((completedSections) / (window.totalSections || 1)) * 100;
    document.getElementById('progress-bar').style.width = pct + '%';
}
function completeSection(sectionNum) {
    completedSections = Math.max(completedSections, sectionNum);
    updateProgress();
    if (sectionNum >= window.totalSections) { completeLessonAndSave(); return; }
    const next = document.querySelector(`.lesson-section[data-section="${sectionNum + 1}"]`);
    if (next) { next.classList.add('visible'); next.scrollIntoView({ behavior:'smooth', block:'center' }); }
    if (Math.random() < 0.3) showBadge(getRandomBadge());
    currentSection = sectionNum + 1;
    updateNav();
}
function showResult(num, correct, total, goodMsg, badMsg) {
    const el = document.getElementById('result-' + num);
    if (!el) return;
    const perfect = correct === total;
    el.style.display = 'block';
    el.className = 'result-message ' + (perfect ? 'correct' : 'incorrect');
    el.textContent = perfect ? goodMsg : correct + '/' + total + ' correct. ' + badMsg;
    if (perfect) { celebrate('üéâ Perfect!'); showBadge(getRandomBadge()); setTimeout(() => completeSection(num), 1600); }
}
function hideResult(num) {
    const el = document.getElementById('result-' + num);
    if (el) { el.style.display = 'none'; el.className = 'result-message'; }
}
function checkTrueFalse(num) {
    const sec = document.querySelector(`.lesson-section[data-section="${num}"]`);
    const groups = sec.querySelectorAll('.comp-btn-group');
    let correct = 0, unanswered = 0;
    groups.forEach(g => {
        const sel = g.querySelector('.option-button.selected');
        if (!sel) { unanswered++; return; }
        g.querySelectorAll('.option-button').forEach(b => b.classList.remove('correct','incorrect'));
        if (sel.dataset.correct === 'true') { sel.classList.add('correct'); correct++; }
        else sel.classList.add('incorrect');
    });
    if (unanswered > 0) {
        const res = document.getElementById('result-' + num);
        res.style.display = 'block'; res.className = 'result-message incorrect';
        res.textContent = 'Please answer all questions before checking!'; return;
    }
    showResult(num, correct, groups.length, 'üéâ All correct!', 'Wrong answers are in red ‚Äî try again!');
}
function resetTrueFalse(num) {
    const sec = document.querySelector(`.lesson-section[data-section="${num}"]`);
    sec.querySelectorAll('.option-button').forEach(b => b.classList.remove('selected','correct','incorrect'));
    hideResult(num);
}
function checkMultiChoice(num) {
    const sec = document.querySelector(`.lesson-section[data-section="${num}"]`);
    const groups = sec.querySelectorAll('.comp-btn-group');
    let correct = 0, unanswered = 0;
    groups.forEach(g => {
        const sel = g.querySelector('.option-button.selected');
        if (!sel) { unanswered++; return; }
        g.querySelectorAll('.option-button').forEach(b => b.classList.remove('correct','incorrect'));
        if (sel.dataset.correct === 'true') { sel.classList.add('correct'); correct++; }
        else sel.classList.add('incorrect');
    });
    if (unanswered > 0) {
        const res = document.getElementById('result-' + num);
        res.style.display = 'block'; res.className = 'result-message incorrect';
        res.textContent = 'Please answer all questions before checking!'; return;
    }
    showResult(num, correct, groups.length, 'üíØ Perfect!', 'Wrong answers are in red ‚Äî try again!');
}
function resetMultiChoice(num) {
    const sec = document.querySelector(`.lesson-section[data-section="${num}"]`);
    sec.querySelectorAll('.option-button').forEach(b => b.classList.remove('selected','correct','incorrect'));
    hideResult(num);
}
function handleGapClick(blank) {
    if (blank.classList.contains('correct')) return;
    if (blank.textContent.trim()) {
        const sec = blank.closest('.lesson-section');
        const opt = Array.from(sec.querySelectorAll('.word-option')).find(o => o.dataset.word === blank.textContent.trim());
        if (opt) opt.classList.remove('used');
        blank.textContent = ''; blank.classList.remove('incorrect');
    } else if (selectedGapWord) {
        blank.textContent = selectedGapWord.dataset.word;
        selectedGapWord.classList.add('used'); selectedGapWord.classList.remove('selected');
        selectedGapWord = null;
    }
}
function checkGapFill(num) {
    const sec = document.querySelector(`.lesson-section[data-section="${num}"]`);
    const blanks = sec.querySelectorAll('.gap-input');
    let correct = 0;
    blanks.forEach(b => {
        b.classList.remove('correct','incorrect');
        if ((b.textContent||'').trim().toLowerCase() === b.dataset.answer.toLowerCase()) { b.classList.add('correct'); correct++; }
        else if (b.textContent.trim()) b.classList.add('incorrect');
    });
    showResult(num, correct, blanks.length, '‚ú® All gaps correct!', 'Click a red gap to remove it and try again.');
}
function resetGapFill(num) {
    const sec = document.querySelector(`.lesson-section[data-section="${num}"]`);
    sec.querySelectorAll('.gap-input').forEach(b => { b.textContent=''; b.classList.remove('correct','incorrect'); });
    sec.querySelectorAll('.word-option').forEach(o => o.classList.remove('used','selected'));
    selectedGapWord = null; hideResult(num);
}
function checkWordForms(num) {
    const sec = document.querySelector(`.lesson-section[data-section="${num}"]`);
    const inputs = sec.querySelectorAll('.word-form-input');
    let correct = 0;
    inputs.forEach(inp => {
        inp.style.background = ''; inp.style.borderColor = '';
        if (inp.value.trim().toLowerCase() === inp.dataset.answer.toLowerCase()) { inp.style.background = '#D5EFDC'; inp.style.borderColor = '#27AE60'; correct++; }
        else if (inp.value.trim()) { inp.style.background = '#F9D5D3'; inp.style.borderColor = '#C0392B'; }
    });
    showResult(num, correct, inputs.length, 'üéØ Word Forms Champion!', 'Red boxes are wrong ‚Äî check your spelling!');
}
function revealWordForms(num) {
    const sec = document.querySelector(`.lesson-section[data-section="${num}"]`);
    sec.querySelectorAll('.word-form-input').forEach(inp => {
        inp.value = inp.dataset.answer; inp.classList.add('revealed');
        inp.style.background=''; inp.style.borderColor='';
    });
    hideResult(num);
}
function resetWordForms(num) {
    const sec = document.querySelector(`.lesson-section[data-section="${num}"]`);
    sec.querySelectorAll('.word-form-input').forEach(inp => { inp.value=''; inp.style.background='white'; inp.style.borderColor=''; inp.classList.remove('revealed'); });
    hideResult(num);
}
function checkGrammar(num) {
    const sec = document.querySelector(`.lesson-section[data-section="${num}"]`);
    const selects = sec.querySelectorAll('.grammar-select');
    let correct = 0;
    selects.forEach(sel => {
        sel.classList.remove('correct','incorrect');
        if (!sel.value) return;
        if (sel.value === sel.dataset.answer) { sel.classList.add('correct'); correct++; }
        else sel.classList.add('incorrect');
    });
    showResult(num, correct, selects.length, 'üìñ Grammar Ace!', 'Red dropdowns are wrong ‚Äî try again!');
}
function resetGrammar(num) {
    const sec = document.querySelector(`.lesson-section[data-section="${num}"]`);
    sec.querySelectorAll('.grammar-select').forEach(sel => { sel.value=''; sel.classList.remove('correct','incorrect'); });
    hideResult(num);
}
function celebrate(msg) {
    const el = document.getElementById('celebration');
    el.textContent = msg || 'üéâ Excellent!';
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 2000);
}
function getRandomBadge() {
    const list = (LESSON_CONFIG.badges && LESSON_CONFIG.badges.length) ? LESSON_CONFIG.badges : [{icon:'‚≠ê',text:'Great!'}];
    return list[Math.floor(Math.random() * list.length)];
}
function showBadge(badge) {
    const el = document.createElement('div');
    el.className = 'badge';
    el.innerHTML = `<span class="badge-icon">${badge.icon}</span><span class="badge-text">${badge.text}</span>`;
    document.getElementById('badge-container').appendChild(el);
    setTimeout(() => el.classList.add('show'), 100);
    setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 500); }, 3000);
}
function showPopup(target, word) {
    const w = LESSON_CONFIG.vocabulary.find(v => v.word.toLowerCase() === word.toLowerCase());
    if (!w) return;
    const popup   = document.getElementById('dictionary-popup');
    const content = document.getElementById('popup-content');
    content.innerHTML = `
        <div style="margin-bottom:10px;">
            <strong style="color:var(--color-primary);font-family:'Playfair Display',serif;font-size:1.3em;">${w.word}</strong>
            <span style="font-size:0.85em;color:#A0AEC0;margin-left:8px;font-style:italic;">(${w.type||''})</span>
        </div>
        <p style="color:#D4C5A9;line-height:1.7;margin-bottom:16px;font-size:0.95em;">${w.definition}</p>
        <button onclick="playAudio('${w.word}')"
            style="width:100%;background:var(--color-primary);color:white;border:none;padding:14px;border-radius:2px;font-weight:700;font-size:1em;cursor:pointer;font-family:'Playfair Display',serif;text-transform:uppercase;letter-spacing:1px;">
            üîä Hear it
        </button>`;
    popup.style.display = 'block';
    if (window.innerWidth >= 768) {
        const rect = target.getBoundingClientRect();
        popup.style.top  = (rect.bottom + 8) + 'px';
        popup.style.left = rect.left + 'px';
        setTimeout(() => {
            const pr = popup.getBoundingClientRect();
            if (pr.right > window.innerWidth - 10) popup.style.left = (window.innerWidth - pr.width - 10) + 'px';
        }, 10);
    }
}
function closePopup() { document.getElementById('dictionary-popup').style.display = 'none'; }
function playAudio(word) {
    const u = new SpeechSynthesisUtterance(word);
    u.lang = 'en-GB'; u.rate = 0.9;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
}
function wireEvents() {
    document.querySelectorAll('.comp-btn-group').forEach(group => {
        group.addEventListener('click', e => {
            const btn = e.target.closest('.option-button');
            if (!btn) return;
            if (group.querySelector('.option-button.correct')) return;
            group.querySelectorAll('.option-button').forEach(b => b.classList.remove('selected','incorrect'));
            btn.classList.add('selected');
        });
    });
    document.querySelectorAll('.word-option').forEach(opt => {
        opt.addEventListener('click', () => {
            if (opt.classList.contains('used')) return;
            if (opt.classList.contains('selected')) { opt.classList.remove('selected'); selectedGapWord = null; }
            else { document.querySelectorAll('.word-option').forEach(o => o.classList.remove('selected')); opt.classList.add('selected'); selectedGapWord = opt; }
        });
    });
    document.querySelectorAll('.gap-input').forEach(b => b.addEventListener('click', () => handleGapClick(b)));
    document.addEventListener('click', e => {
        if (!e.target.closest('#dictionary-popup') && !e.target.classList.contains('highlight-word')) closePopup();
    });
}
async function completeLessonAndSave() {
    completedSections = window.totalSections;
    updateProgress();
    if (typeof window.EFCD_Auth === 'undefined' || !window.EFCD_Auth.getCurrentUser()) {
        const signup = confirm(
            'üé≠ You completed the lesson!\n\n‚ú® Sign up free to:\n‚Ä¢ Save your progress & earn XP\n‚Ä¢ Unlock achievements\n‚Ä¢ Track your streak\n\nClick OK to sign up | Click Cancel to continue without saving'
        );
        if (signup) { window.location.href = '/signup/'; }
        else if (typeof showWordMatchGame === 'function') {
            showWordMatchGame(LESSON_CONFIG.vocabulary, () => { window.location.href = LESSON_CONFIG.levelPage; });
        } else { window.location.href = LESSON_CONFIG.levelPage; }
        return;
    }
    const result = await window.EFCD_Auth.completeLesson({
        lessonId:       LESSON_CONFIG.lessonId,
        lessonTitle:    LESSON_CONFIG.title,
        lessonLevel:    LESSON_CONFIG.level,
        lessonLink:     LESSON_CONFIG.lessonLink,
        vocabulary:     LESSON_CONFIG.vocabulary,
        grammar:        LESSON_CONFIG.grammar || [],
        perfectScore:   true,
        completionTime: Math.floor((Date.now() - performance.timing.navigationStart) / 1000)
    });
    if (window.DailyChallenges && result.success) {
        const cr = await window.DailyChallenges.updateChallengeProgress({
            perfectScore: true, vocabCount: LESSON_CONFIG.vocabulary.length,
            completionTime: Math.floor((Date.now() - performance.timing.navigationStart) / 1000), grammarPerfect: true
        });
        if (cr.justCompleted) {
            window.DailyChallenges.showChallengeCompletionCelebration(cr.challenge);
            setTimeout(() => {
                if (typeof showWordMatchGame === 'function')
                    showWordMatchGame(LESSON_CONFIG.vocabulary, gr => showCelebrationScreen(result, gr));
            }, 2500);
            return;
        }
    }
    if (result.success) {
        if (typeof showWordMatchGame === 'function')
            showWordMatchGame(LESSON_CONFIG.vocabulary, gr => showCelebrationScreen(result, gr));
        else showCelebrationScreen(result, null);
    }
}
function showCelebrationScreen(result, gameResult) {
    const totalXP = result.xpEarned + ((gameResult && gameResult.bonusXP) || 0);
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(26,26,46,0.97);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;animation:fadeIn 0.3s;';
    let h = `<div style="background:var(--color-paper);padding:40px 30px;border-radius:2px;text-align:center;max-width:500px;width:100%;animation:scaleIn 0.4s;position:relative;border-top:6px solid var(--color-primary);box-shadow:8px 8px 0 var(--color-secondary);">
        <button id="close-cel" style="position:absolute;top:15px;right:15px;background:transparent;border:2px solid var(--color-rule);border-radius:2px;width:36px;height:36px;cursor:pointer;font-size:20px;color:var(--color-secondary);">√ó</button>
        <div style="font-size:72px;margin-bottom:16px;">üé≠</div>
        <h2 style="font-size:28px;margin-bottom:16px;color:var(--color-secondary);font-family:'Playfair Display',serif;font-weight:900;">Lesson Complete!</h2>
        <div style="background:var(--color-secondary);padding:24px;border-radius:2px;margin-bottom:24px;border:2px solid var(--color-primary);">
            <div style="font-size:48px;font-weight:900;color:var(--color-primary);font-family:'Playfair Display',serif;">+${totalXP} XP</div>
            ${gameResult && gameResult.bonusXP ? `<div style="font-size:13px;color:#D4C5A9;margin-top:6px;font-weight:700;">üéÆ Includes +${gameResult.bonusXP} XP game bonus!</div>` : ''}
            ${result.leveledUp ? `<div style="font-size:20px;color:var(--color-primary);margin-top:12px;font-family:'Playfair Display',serif;">üéä Level Up! Now Level ${result.newLevel}!</div>` : ''}
            ${result.newStreak > 0 ? `<div style="font-size:18px;margin-top:12px;color:#D4C5A9;">üî• ${result.newStreak} day streak!</div>` : ''}
        </div>`;
    if (result.newAchievements && result.newAchievements.length) {
        h += `<div style="background:#EDE8DF;padding:18px;border-radius:2px;margin-bottom:24px;border:1px solid var(--color-rule);">
            <div style="font-weight:900;font-size:16px;margin-bottom:12px;font-family:'Playfair Display',serif;">üèÜ New Achievements!</div>
            ${result.newAchievements.map(id => { const a=window.EFCD_Auth.ACHIEVEMENTS[id]; return `<div style="background:white;padding:12px;border-radius:2px;margin:8px 0;border-left:4px solid var(--color-primary);"><span style="font-size:26px;">${a.icon}</span> ${a.name}</div>`; }).join('')}
        </div>`;
    }
    h += `<div style="display:flex;flex-direction:column;gap:10px;">
        <a href="/dashboard-gamified/" style="background:var(--color-secondary);color:white;padding:14px;border-radius:2px;text-decoration:none;font-weight:700;font-family:'Playfair Display',serif;text-transform:uppercase;letter-spacing:1px;">View Dashboard</a>
        <a href="${LESSON_CONFIG.levelPage}" style="background:var(--color-primary);color:white;padding:14px;border-radius:2px;text-decoration:none;font-weight:700;font-family:'Playfair Display',serif;text-transform:uppercase;letter-spacing:1px;">Next Lesson ‚Üí</a>
        <button id="btn-retry" style="background:transparent;color:var(--color-secondary);padding:14px;border-radius:2px;border:2px solid var(--color-rule);font-weight:700;cursor:pointer;font-family:'Playfair Display',serif;text-transform:uppercase;letter-spacing:1px;">Try Again</button>
    </div></div>`;
    overlay.innerHTML = h;
    document.body.appendChild(overlay);
    setTimeout(() => {
        document.getElementById('close-cel')?.addEventListener('click', () => overlay.remove());
        document.getElementById('btn-retry')?.addEventListener('click', () => location.reload());
        document.addEventListener('keydown', function esc(e) { if(e.key==='Escape'){overlay.remove();document.removeEventListener('keydown',esc);} });
    }, 100);
}
const s = document.createElement('style');
s.textContent = '@keyframes fadeIn{from{opacity:0}to{opacity:1}}@keyframes scaleIn{from{transform:scale(0.8);opacity:0}to{transform:scale(1);opacity:1}}';
document.head.appendChild(s);
    </script>
</body>
</html>
