<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The History of Pancake Day - English For Cool Dudes</title>
    <link rel="preconnect" href="https://fonts.bunny.net">
    <link href="https://fonts.bunny.net/css2?family=Nunito:wght@400;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            /* ‚îÄ‚îÄ EFCD brand tokens ‚îÄ‚îÄ */
            --blue:          #1CB0F6;
            --blue-shadow:   #1899D6;
            --yellow:        #FFC800;
            --yellow-shadow: #E5B400;
            --green:         #58CC02;
            --green-shadow:  #58A700;
            --punch:         #FF4B4B;
            --punch-shadow:  #EA2B2B;
            --bg:            #F7F9FA;
            --ink:           #4B4B4B;
            --ink-bold:      #111827;
            --ink-3:         #AFAFAF;
            --white:         #FFFFFF;
            --border:        #E5E5E5;
            --border-heavy:  #CECECE;
            --r:             24px;
            --rsm:           16px;

            /* ‚îÄ‚îÄ Intermediate track = blue ‚îÄ‚îÄ */
            --accent:        #1CB0F6;
            --accent-shadow: #1899D6;
            --accent-light:  rgba(28,176,246,.12);
            --accent-border: rgba(28,176,246,.28);
            --accent-text:   #0e7ab0;
            --accent-deep:   #0e7ab0;

            /* ‚îÄ‚îÄ Lesson content warmth (pancake) ‚îÄ‚îÄ */
            --warm:          #F59E0B;
            --warm-deep:     #D97706;
            --warm-light:    #FEF3C7;
            --warm-pale:     #FFFBEB;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg);
            color: var(--ink);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        /* ‚îÄ‚îÄ KEYFRAMES ‚îÄ‚îÄ */
        @keyframes pop     { 0%{transform:scale(.8);opacity:0} 70%{transform:scale(1.08)} 100%{transform:scale(1);opacity:1} }
        @keyframes shake   { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-8px)} 75%{transform:translateX(8px)} }
        @keyframes wobble  { 0%,100%{transform:rotate(0)} 25%{transform:rotate(-4deg)} 75%{transform:rotate(4deg)} }
        @keyframes float   { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }
        @keyframes slideUp { from{opacity:0;transform:translateY(30px)} to{opacity:1;transform:translateY(0)} }
        @keyframes slideIn { from{opacity:0;transform:translateX(40px)} to{opacity:1;transform:translateX(0)} }
        @keyframes xpFly   { 0%{opacity:1;transform:translateY(0) scale(1)} 100%{opacity:0;transform:translateY(-80px) scale(1.4)} }
        @keyframes sparkle { 0%{transform:scale(0) rotate(0deg);opacity:1} 100%{transform:scale(1.5) rotate(180deg);opacity:0} }
        @keyframes comboIn { 0%{transform:scale(0) rotate(-12deg);opacity:0} 60%{transform:scale(1.15) rotate(3deg)} 100%{transform:scale(1) rotate(0deg);opacity:1} }
        @keyframes progressPulse { 0%,100%{box-shadow:0 0 0 0 rgba(28,176,246,.4)} 50%{box-shadow:0 0 0 8px rgba(28,176,246,0)} }
        @keyframes flick   { 0%,100%{transform:rotate(-3deg) scale(1)} 50%{transform:rotate(3deg) scale(1.1)} }
        @keyframes revealWord { from{background:var(--blue);color:var(--blue);border-radius:4px} to{background:transparent;color:inherit} }
        @keyframes sectionIn { from{opacity:0;transform:translateY(24px)} to{opacity:1;transform:translateY(0)} }
        @keyframes tapHint { 0%,100%{transform:scale(1);box-shadow:0 0 0 0 rgba(245,158,11,.5)} 50%{transform:scale(1.04);box-shadow:0 0 0 8px rgba(245,158,11,0)} }
        @keyframes confettiFall { 0%{opacity:1;transform:translateY(0) rotate(0deg) scale(1)} 100%{opacity:0;transform:translateY(200px) rotate(720deg) scale(0.5)} }
        @keyframes streakFire  { 0%,100%{transform:scaleY(1)} 50%{transform:scaleY(1.15)} }
        @keyframes fadeIn  { from{opacity:0} to{opacity:1} }

        /* ‚ïê‚ïê HEADER ‚ïê‚ïê */
        .header {
            background: var(--white);
            border-bottom: 3px solid var(--blue);
            padding: 0 20px;
            height: 60px;
            position: sticky;
            top: 0;
            z-index: 300;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 12px rgba(28,176,246,.12);
        }
        .header-inner {
            max-width: 860px;
            width: 100%;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .logo-link {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }
        .logo-box {
            width: 38px;
            height: 38px;
            background: var(--yellow);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            border: 2px solid var(--yellow-shadow);
            box-shadow: 0 3px 0 var(--yellow-shadow);
        }
        .site-name {
            font-size: 15px;
            font-weight: 900;
            color: var(--ink-bold);
            letter-spacing: -.3px;
        }
        @media(max-width:420px){.site-name{display:none}}

        /* XP counter in header */
        .header-xp {
            display: flex;
            align-items: center;
            gap: 14px;
        }
        .xp-pill {
            background: var(--accent-light);
            border: 2px solid var(--accent-border);
            border-radius: 99px;
            padding: 6px 14px;
            font-size: 14px;
            font-weight: 900;
            color: var(--accent-text);
            display: flex;
            align-items: center;
            gap: 6px;
            position: relative;
            overflow: visible;
        }
        .xp-num { transition: all .3s; }
        .streak-mini {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
            font-weight: 900;
            color: var(--punch);
        }
        .streak-mini span { animation: flick 2s ease-in-out infinite; display: inline-block; }

        /* ‚ïê‚ïê PROGRESS TRACK ‚ïê‚ïê */
        .progress-track {
            background: var(--accent-light);
            height: 10px;
            position: sticky;
            top: 60px;
            z-index: 200;
            border-bottom: 2px solid var(--accent-border);
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--blue), var(--blue-shadow));
            width: 0%;
            transition: width .8s cubic-bezier(.4,0,.2,1);
            border-right: 3px solid var(--accent-shadow);
        }
        .progress-fill.pulsing { animation: progressPulse 1s ease-out; }

        /* ‚ïê‚ïê STAGE PILLS ‚ïê‚ïê */
        .stage-nav {
            max-width: 860px;
            margin: 20px auto 0;
            padding: 0 16px;
            display: flex;
            gap: 8px;
            overflow-x: auto;
            scrollbar-width: none;
        }
        .stage-nav::-webkit-scrollbar { display: none; }
        .stage-pill {
            flex-shrink: 0;
            padding: 8px 16px;
            border-radius: 99px;
            border: 2px solid var(--accent-border);
            background: var(--white);
            font-size: 12px;
            font-weight: 900;
            color: var(--accent-text);
            cursor: default;
            transition: all .2s;
            opacity: .4;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .stage-pill.active  { opacity: 1; background: var(--blue); color: var(--white); border-color: var(--blue-shadow); }
        .stage-pill.done    { opacity: .8; background: var(--green); color: var(--white); border-color: var(--green-shadow); }

        /* ‚ïê‚ïê MAIN ‚ïê‚ïê */
        .main {
            max-width: 860px;
            margin: 0 auto;
            padding: 20px 16px 120px;
        }

        /* ‚ïê‚ïê SECTION ‚ïê‚ïê */
        .quest-section {
            display: none;
            animation: sectionIn .4s ease both;
        }
        .quest-section.active { display: block; }

        /* ‚ïê‚ïê LESSON HERO ‚ïê‚ïê */
        .lesson-hero {
            background: var(--blue);
            border: 2px solid var(--blue-shadow);
            border-bottom: 6px solid var(--blue-shadow);
            border-radius: 20px;
            padding: 28px 24px;
            text-align: center;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        .lesson-hero::before {
            content: 'ü•û';
            position: absolute;
            font-size: 120px;
            opacity: .1;
            bottom: -20px;
            right: -10px;
            pointer-events: none;
        }
        .hero-eyebrow {
            font-size: 11px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: rgba(255,255,255,.8);
            margin-bottom: 6px;
        }
        .hero-title {
            font-weight: 900;
            font-size: clamp(24px,6vw,38px);
            font-weight: 900;
            color: var(--white);
            line-height: 1.1;
            letter-spacing: -1px;
            margin-bottom: 10px;
            text-shadow: 0 2px 0 var(--blue-shadow);
            position: relative;
            z-index: 1;
        }
        .hero-meta {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,.25);
            border: 2px solid rgba(255,255,255,.4);
            border-radius: 99px;
            padding: 6px 16px;
            font-size: 13px;
            font-weight: 800;
            color: var(--white);
            position: relative;
            z-index: 1;
        }

        /* ‚ïê‚ïê QUEST CARD ‚ïê‚ïê */
        .quest-card {
            background: var(--white);
            border: 2px solid #FDE68A;
            border-bottom: 6px solid #FCD34D;
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 16px;
        }
        .quest-header {
            background: linear-gradient(135deg, var(--accent-light) 0%, #FDE68A 100%);
            padding: 14px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 2px solid #FCD34D;
        }
        .quest-stage-icon {
            width: 42px;
            height: 42px;
            background: var(--blue);
            border: 2px solid var(--blue-shadow);
            border-bottom: 4px solid var(--blue-shadow);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }
        .quest-header-text { flex: 1; }
        .quest-stage-num {
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--blue-shadow);
            margin-bottom: 1px;
        }
        .quest-stage-title {
            font-weight: 900;
            font-size: 17px;
            font-weight: 900;
            color: var(--accent-text);
            letter-spacing: -.3px;
        }
        .quest-xp-badge {
            background: var(--blue);
            color: var(--white);
            font-size: 12px;
            font-weight: 900;
            padding: 6px 12px;
            border-radius: 99px;
            border: 2px solid var(--blue-shadow);
            border-bottom: 4px solid var(--blue-shadow);
            flex-shrink: 0;
        }
        .quest-body { padding: 20px; }

        /* ‚ïê‚ïê READING ‚Äî TAP TO REVEAL ‚ïê‚ïê */
        .reading-intro {
            background: var(--accent-light);
            border: 2px solid #FCD34D;
            border-radius: var(--r);
            padding: 14px 18px;
            font-size: 13px;
            font-weight: 800;
            color: var(--accent-text);
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .reading-intro .tap-icon { font-size: 24px; animation: tapHint 2s ease-in-out infinite; }

        .para-block {
            background: var(--warm-pale);
            border: 2px solid #FDE68A;
            border-radius: var(--r);
            padding: 16px 18px;
            margin-bottom: 10px;
            font-size: 15px;
            line-height: 1.8;
            color: var(--ink);
            opacity: 0;
            transform: translateY(12px);
            transition: opacity .4s, transform .4s;
            position: relative;
        }
        .para-block::before {
            content: attr(data-num);
            position: absolute;
            top: -10px;
            left: 18px;
            background: var(--blue);
            color: var(--white);
            font-size: 10px;
            font-weight: 900;
            padding: 2px 8px;
            border-radius: 99px;
            border: 2px solid var(--blue-shadow);
        }
        .para-block.revealed { opacity: 1; transform: translateY(0); }

        /* vocab tap targets inside reading */
        .v-tap {
            background: var(--accent-light);
            color: var(--accent-text);
            font-weight: 900;
            padding: 2px 8px;
            border-radius: 6px;
            border-bottom: 2px dashed var(--blue);
            cursor: pointer;
            display: inline-block;
            transition: all .15s;
            position: relative;
        }
        .v-tap:active, .v-tap.tapped {
            background: var(--blue);
            color: var(--white);
            border-bottom-style: solid;
            transform: scale(1.06);
        }
        .v-tap.tapped { border-bottom-style: solid; }

        /* reveal button per paragraph */
        .para-reveal-btn {
            width: 100%;
            padding: 12px;
            background: var(--accent-light);
            border: 2px solid var(--blue);
            border-bottom: 4px solid var(--blue-shadow);
            border-radius: var(--r);
            font-size: 14px;
            font-weight: 900;
            color: var(--accent-text);
            font-family: inherit;
            cursor: pointer;
            transition: all .15s;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .para-reveal-btn:active { border-bottom-width: 2px; transform: translateY(2px); }
        .para-reveal-btn.done { background: rgba(88,204,2,.1); border-color: var(--green); color: var(--green); pointer-events: none; }

        /* ‚ïê‚ïê VOCAB POPUP (bottom sheet) ‚ïê‚ïê */
        #vocab-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-top: 5px solid var(--blue);
            border-radius: 24px 24px 0 0;
            padding: 24px 20px 32px;
            z-index: 9000;
            display: none;
            box-shadow: 0 -20px 60px rgba(0,0,0,.2);
            animation: slideUp .3s ease both;
            max-height: 55vh;
            overflow-y: auto;
        }
        #vocab-sheet.open { display: block; }
        .vs-word {
            font-weight: 900;
            font-size: 28px;
            font-weight: 900;
            color: var(--accent-text);
            margin-bottom: 4px;
        }
        .vs-def {
            font-size: 15px;
            font-weight: 700;
            color: var(--ink);
            line-height: 1.6;
            margin-bottom: 16px;
        }
        .vs-example {
            background: var(--warm-light);
            border-left: 4px solid var(--warm);
            padding: 10px 14px;
            border-radius: 0 8px 8px 0;
            font-size: 13px;
            font-weight: 700;
            color: var(--accent-text);
            font-style: italic;
            margin-bottom: 16px;
        }
        .vs-btns { display: flex; gap: 10px; }
        .vs-btn {
            flex: 1;
            padding: 12px;
            border-radius: var(--r);
            border: 2px solid;
            font-size: 14px;
            font-weight: 900;
            font-family: inherit;
            cursor: pointer;
            transition: all .15s;
        }
        .vs-btn:active { transform: translateY(2px); }
        .vs-btn.primary { background: var(--blue); color: var(--white); border-color: var(--blue-shadow); border-bottom-width: 4px; }
        .vs-btn.secondary { background: var(--white); color: var(--ink); border-color: #E5E5E5; border-bottom-width: 4px; }
        .vs-close {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 30px;
            height: 30px;
            background: var(--accent-light);
            border: 2px solid var(--blue);
            border-radius: 50%;
            font-size: 16px;
            font-weight: 900;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: inherit;
        }
        #sheet-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.4);
            z-index: 8999;
            display: none;
        }
        #sheet-overlay.open { display: block; }

        /* ‚ïê‚ïê TRUE/FALSE ‚ïê‚ïê */
        .tf-question {
            background: var(--bg);
            border: 2px solid #FDE68A;
            border-radius: var(--r);
            padding: 16px;
            margin-bottom: 12px;
            transition: all .2s;
        }
        .tf-q-text {
            font-size: 15px;
            font-weight: 800;
            color: var(--ink);
            margin-bottom: 12px;
            line-height: 1.4;
        }
        .tf-btns { display: flex; gap: 10px; }
        .tf-btn {
            flex: 1;
            padding: 14px;
            border-radius: var(--rsm);
            border: 2px solid;
            border-bottom: 5px solid;
            font-size: 15px;
            font-weight: 900;
            font-family: inherit;
            cursor: pointer;
            transition: all .15s;
        }
        .tf-btn:active { border-bottom-width: 2px; transform: translateY(3px); }
        .tf-btn.t-btn { background: #F0FDF4; color: var(--green); border-color: #86EFAC; }
        .tf-btn.f-btn { background: #FFF1F2; color: var(--punch); border-color: #FCA5A5; }
        .tf-btn.selected { opacity: 1; }
        .tf-btn.correct { background: var(--green) !important; color: var(--white) !important; border-color: #15803D !important; animation: pop .4s ease both; }
        .tf-btn.wrong   { background: var(--punch)   !important; color: var(--white) !important; border-color: #B91C1C !important; animation: shake .4s ease both; }
        .tf-btn:disabled { cursor: default; }
        .tf-feedback {
            margin-top: 10px;
            font-size: 13px;
            font-weight: 800;
            padding: 10px 14px;
            border-radius: var(--rsm);
            display: none;
            animation: slideIn .3s ease both;
        }
        .tf-feedback.ok  { background: rgba(88,204,2,.1); color: var(--green); display: block; }
        .tf-feedback.bad { background: rgba(255,75,75,.1);   color: var(--punch);   display: block; }

        /* ‚ïê‚ïê GAP FILL ‚ïê‚ïê */
        .word-bank {
            background: var(--accent-light);
            border: 2px solid #FCD34D;
            border-radius: var(--r);
            padding: 14px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .bank-chip {
            background: var(--white);
            border: 2px solid var(--blue);
            border-bottom: 4px solid var(--blue-shadow);
            border-radius: 99px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 900;
            color: var(--accent-text);
            cursor: pointer;
            font-family: inherit;
            transition: all .15s;
        }
        .bank-chip:active { border-bottom-width: 2px; transform: translateY(2px); }
        .bank-chip.selected {
            background: var(--blue);
            color: var(--white);
            border-color: var(--blue-shadow);
            animation: wobble .3s ease;
        }
        .bank-chip.used {
            opacity: .3;
            pointer-events: none;
            background: #E5E5E5;
            border-color: #D1D5DB;
            color: #9CA3AF;
        }
        .gap-sentence {
            font-size: 16px;
            font-weight: 800;
            color: var(--ink);
            line-height: 2.8;
            margin-bottom: 8px;
        }
        .gap-slot {
            display: inline-block;
            min-width: 110px;
            padding: 4px 12px;
            border-bottom: 3px dashed var(--blue);
            border-radius: 6px 6px 0 0;
            text-align: center;
            font-size: 15px;
            font-weight: 900;
            color: var(--blue);
            cursor: pointer;
            margin: 0 4px;
            transition: all .2s;
            background: transparent;
        }
        .gap-slot.has-word { background: var(--accent-light); color: var(--accent-text); border-bottom-style: solid; }
        .gap-slot.correct  { background: rgba(88,204,2,.1) !important; color: var(--green) !important; border-color: var(--green-shadow) !important; pointer-events: none; animation: pop .3s ease; }
        .gap-slot.wrong    { background: rgba(255,75,75,.1)   !important; color: var(--punch)   !important; border-color: var(--punch)   !important; animation: shake .3s ease; }

        /* ‚ïê‚ïê GRAMMAR SELECTS ‚ïê‚ïê */
        .grammar-q {
            background: var(--bg);
            border: 2px solid #FDE68A;
            border-bottom: 5px solid #FCD34D;
            border-radius: var(--r);
            padding: 18px;
            margin-bottom: 12px;
            transition: all .2s;
        }
        .grammar-q.correct { border-color: var(--green-shadow) !important; background: rgba(88,204,2,.1); }
        .grammar-q.wrong   { border-color: var(--punch)   !important; background: rgba(255,75,75,.1);   animation: shake .4s ease; }
        .gq-text { font-size: 16px; font-weight: 800; color: var(--ink); margin-bottom: 4px; line-height: 1.4; }
        .gq-hint { font-size: 12px; font-weight: 700; color: var(--blue-shadow); margin-bottom: 12px; font-style: italic; }
        .gq-select {
            width: 100%;
            padding: 12px 14px;
            background: var(--white);
            border: 2px solid var(--blue);
            border-bottom: 4px solid var(--blue-shadow);
            border-radius: var(--rsm);
            font-size: 15px;
            font-weight: 800;
            color: var(--accent-text);
            font-family: inherit;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23D97706' stroke-width='3'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 40px;
        }
        .gq-select.correct { background-color: rgba(88,204,2,.1); border-color: var(--green); color: var(--green); }
        .gq-select.wrong   { background-color: rgba(255,75,75,.1);   border-color: var(--punch);   color: var(--punch);   }

        /* ‚ïê‚ïê COMBO STREAK DISPLAY ‚ïê‚ïê */
        #combo-display {
            position: fixed;
            top: 80px;
            right: 16px;
            z-index: 500;
            display: none;
        }
        .combo-card {
            background: var(--blue);
            border: 2px solid var(--blue-shadow);
            border-bottom: 4px solid var(--accent-shadow);
            border-radius: 14px;
            padding: 10px 16px;
            text-align: center;
            animation: comboIn .4s cubic-bezier(.175,.885,.32,1.275) both;
        }
        .combo-num  { font-weight: 900; font-size: 32px; font-weight: 900; color: var(--white); line-height: 1; }
        .combo-word { font-size: 11px; font-weight: 900; color: rgba(255,255,255,.8); text-transform: uppercase; letter-spacing: 1px; }

        /* ‚ïê‚ïê XP FLOATER ‚ïê‚ïê */
        .xp-floater {
            position: fixed;
            font-size: 20px;
            font-weight: 900;
            color: var(--blue-shadow);
            pointer-events: none;
            z-index: 9999;
            animation: xpFly .9s ease-out forwards;
        }

        /* ‚ïê‚ïê ACTION BUTTON ‚ïê‚ïê */
        .action-btn {
            width: 100%;
            padding: 16px;
            background: var(--blue);
            color: var(--white);
            font-size: 16px;
            font-weight: 900;
            font-family: inherit;
            border: 2px solid var(--blue-shadow);
            border-bottom: 6px solid var(--accent-shadow);
            border-radius: var(--r);
            cursor: pointer;
            transition: all .15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 16px;
            letter-spacing: -.2px;
        }
        .action-btn:active { border-bottom-width: 2px; transform: translateY(4px); }
        .action-btn:disabled { opacity: .5; cursor: not-allowed; }
        .action-btn.secondary {
            background: var(--white);
            color: var(--blue-shadow);
            border-color: var(--blue);
        }
        .action-btn.green { background: var(--green); border-color: #15803D; border-bottom-color: #166534; }

        /* ‚ïê‚ïê RESULT BAR ‚ïê‚ïê */
        .result-bar {
            margin-top: 14px;
            padding: 14px 16px;
            border-radius: var(--r);
            font-size: 15px;
            font-weight: 900;
            text-align: center;
            display: none;
            animation: pop .4s ease both;
        }
        .result-bar.ok  { background: rgba(88,204,2,.1); color: var(--green); border: 2px solid #86EFAC; }
        .result-bar.bad { background: rgba(255,75,75,.1);   color: var(--punch);   border: 2px solid #FCA5A5; }
        .result-bar.show { display: block; }

        /* ‚ïê‚ïê CONFETTI DOT ‚ïê‚ïê */
        .confetti-dot {
            position: fixed;
            width: 10px;
            height: 10px;
            border-radius: 3px;
            pointer-events: none;
            z-index: 9999;
            animation: confettiFall 1s ease-out forwards;
        }

        /* ‚ïê‚ïê COMPLETION SCREEN ‚ïê‚ïê */
        #completion-screen {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        #completion-screen.open { display: flex; animation: fadeIn .4s ease both; }
        .completion-card {
            background: var(--white);
            border: 2px solid #FDE68A;
            border-bottom: 8px solid var(--blue-shadow);
            border-radius: 24px;
            padding: 36px 28px;
            max-width: 480px;
            width: 100%;
            text-align: center;
        }
        .cc-icon { font-size: 80px; display: block; margin-bottom: 12px; animation: float 3s ease-in-out infinite; }
        .cc-title {
            font-weight: 900;
            font-size: 32px;
            font-weight: 900;
            color: var(--accent-text);
            margin-bottom: 6px;
            letter-spacing: -1px;
        }
        .cc-sub { font-size: 15px; font-weight: 700; color: var(--blue-shadow); margin-bottom: 24px; }
        .cc-xp-box {
            background: var(--blue);
            border: 2px solid var(--blue-shadow);
            border-bottom: 6px solid var(--accent-shadow);
            border-radius: var(--r);
            padding: 20px;
            margin-bottom: 20px;
        }
        .cc-xp-num {
            font-weight: 900;
            font-size: 52px;
            font-weight: 900;
            color: var(--white);
            line-height: 1;
        }
        .cc-xp-label { font-size: 13px; font-weight: 900; color: rgba(255,255,255,.85); text-transform: uppercase; letter-spacing: 1px; margin-top: 4px; }
        .cc-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        .cc-stat {
            background: var(--accent-light);
            border: 2px solid #FCD34D;
            border-radius: var(--rsm);
            padding: 12px 8px;
        }
        .cc-stat-n { font-size: 22px; font-weight: 900; color: var(--accent-text); }
        .cc-stat-l { font-size: 10px; font-weight: 900; text-transform: uppercase; letter-spacing: .5px; color: var(--blue-shadow); margin-top: 2px; }
        .cc-btns { display: flex; flex-direction: column; gap: 10px; }
        .cc-btn {
            width: 100%;
            padding: 14px;
            border-radius: var(--r);
            font-size: 15px;
            font-weight: 900;
            font-family: inherit;
            cursor: pointer;
            border: 2px solid;
            border-bottom: 5px solid;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all .15s;
        }
        .cc-btn:active { border-bottom-width: 2px; transform: translateY(3px); }
        .cc-btn.amber  { background: var(--blue); color: var(--white); border-color: var(--blue-shadow); border-bottom-color: var(--accent-shadow); }
        .cc-btn.white  { background: var(--white); color: var(--accent-text); border-color: var(--blue); }

        /* ‚ïê‚ïê RESPONSIVE ‚ïê‚ïê */
        @media(max-width:480px) {
            .quest-body { padding: 14px; }
            .gap-sentence { font-size: 15px; }
            .gq-text { font-size: 15px; }
        }

        /* ‚ïê‚ïê DAILY CHALLENGE WIDGET ‚ïê‚ïê */
        #daily-challenge-widget { margin-bottom: 16px; }
    </style>
</head>
<body>

<!-- ‚ïê‚ïê HEADER ‚ïê‚ïê -->
<header class="header">
    <div class="header-inner">
        <a href="/intermediate/" class="logo-link">
            <div class="logo-box">ü•û</div>
            <span class="site-name">English For Cool Dudes</span>
        </a>
        <div class="header-xp">
            <div class="streak-mini">
                <span>üî•</span>
                <span id="hdr-streak">0</span>
            </div>
            <div class="xp-pill">
                ‚ö° <span class="xp-num" id="hdr-xp">0</span> XP
            </div>
        </div>
    </div>
</header>

<!-- ‚ïê‚ïê PROGRESS TRACK ‚ïê‚ïê -->
<div class="progress-track">
    <div class="progress-fill" id="progress-fill"></div>
</div>

<!-- ‚ïê‚ïê STAGE PILLS ‚ïê‚ïê -->
<div class="stage-nav" id="stage-nav">
    <div class="stage-pill active" data-stage="0">üìñ Reading</div>
    <div class="stage-pill" data-stage="1">‚úÖ True / False</div>
    <div class="stage-pill" data-stage="2">üß© Gap Fill</div>
    <div class="stage-pill" data-stage="3">üìù Grammar</div>
</div>

<!-- ‚ïê‚ïê MAIN ‚ïê‚ïê -->
<main class="main">

    <!-- DAILY CHALLENGE -->
    <div id="daily-challenge-widget"></div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         STAGE 0 ‚Äî READING
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="quest-section active" id="stage-0">

        <div class="lesson-hero">
            <div class="hero-eyebrow">ü•û British Culture ¬∑ Intermediate B1‚ÄìB2</div>
            <h1 class="hero-title">The History of<br>Pancake Day</h1>
            <div class="hero-meta">
                <span>üìñ 5 paragraphs</span>
                <span>¬∑</span>
                <span>üî§ 11 vocab words</span>
                <span>¬∑</span>
                <span>‚ö° Up to 120 XP</span>
            </div>
        </div>

        <div class="quest-card">
            <div class="quest-header">
                <div class="quest-stage-icon">üìñ</div>
                <div class="quest-header-text">
                    <div class="quest-stage-num">Stage 1 of 4</div>
                    <div class="quest-stage-title">Reading: Shrove Tuesday</div>
                </div>
                <div class="quest-xp-badge">+30 XP</div>
            </div>
            <div class="quest-body">

                <div class="reading-intro">
                    <span class="tap-icon">üëÜ</span>
                    <span>Tap the <strong>bold words</strong> to see their meanings. Unlock all 5 paragraphs to continue.</span>
                </div>

                <!-- Para 1 -->
                <button class="para-reveal-btn" id="reveal-btn-0" onclick="revealPara(0)">
                    <span>üëÅÔ∏è</span> Reveal Paragraph 1
                </button>
                <div class="para-block" id="para-0" data-num="¬∂1">
                    Every year on Shrove Tuesday, people across Britain
                    <span class="v-tap" data-word="celebrate" onclick="showVocab('celebrate',this)">celebrate</span>
                    Pancake Day. This
                    <span class="v-tap" data-word="tradition" onclick="showVocab('tradition',this)">tradition</span>
                    dates back hundreds of years and marks the day before Lent begins in the Christian calendar.
                </div>

                <!-- Para 2 -->
                <button class="para-reveal-btn" id="reveal-btn-1" onclick="revealPara(1)" style="display:none;">
                    <span>üëÅÔ∏è</span> Reveal Paragraph 2
                </button>
                <div class="para-block" id="para-1" data-num="¬∂2">
                    The word "Shrove" comes from the old English word "shrive," which means to
                    <span class="v-tap" data-word="confess" onclick="showVocab('confess',this)">confess</span>
                    your sins. In the past, people would go to church to confess before the
                    <span class="v-tap" data-word="fasting" onclick="showVocab('fasting',this)">fasting</span>
                    period of Lent. During Lent, Christians traditionally gave up rich foods like eggs, milk, and butter.
                </div>

                <!-- Para 3 -->
                <button class="para-reveal-btn" id="reveal-btn-2" onclick="revealPara(2)" style="display:none;">
                    <span>üëÅÔ∏è</span> Reveal Paragraph 3
                </button>
                <div class="para-block" id="para-2" data-num="¬∂3">
                    Making pancakes became a clever way to use up all these
                    <span class="v-tap" data-word="ingredients" onclick="showVocab('ingredients',this)">ingredients</span>
                    before Lent started. Families would gather in their kitchens and
                    <span class="v-tap" data-word="toss" onclick="showVocab('toss',this)">toss</span>
                    pancakes in the air. The tradition of pancake
                    <span class="v-tap" data-word="races" onclick="showVocab('races',this)">races</span>
                    also began in the medieval period, when a woman supposedly ran to church still holding her frying pan.
                </div>

                <!-- Para 4 -->
                <button class="para-reveal-btn" id="reveal-btn-3" onclick="revealPara(3)" style="display:none;">
                    <span>üëÅÔ∏è</span> Reveal Paragraph 4
                </button>
                <div class="para-block" id="para-3" data-num="¬∂4">
                    Today, Pancake Day is less about religion and more about having fun. Schools often hold pancake-making competitions, and many towns organize pancake races. The most famous race takes place in Olney, Buckinghamshire, where participants must
                    <span class="v-tap" data-word="flip" onclick="showVocab('flip',this)">flip</span>
                    their pancake three times while running!
                </div>

                <!-- Para 5 -->
                <button class="para-reveal-btn" id="reveal-btn-4" onclick="revealPara(4)" style="display:none;">
                    <span>üëÅÔ∏è</span> Reveal Paragraph 5
                </button>
                <div class="para-block" id="para-4" data-num="¬∂5">
                    British pancakes are
                    <span class="v-tap" data-word="thinner" onclick="showVocab('thinner',this)">thinner</span>
                    than American ones and are usually served with lemon juice and sugar. Some people prefer
                    <span class="v-tap" data-word="savoury" onclick="showVocab('savoury',this)">savoury</span>
                    toppings instead. Whatever your preference, Pancake Day remains a beloved
                    <span class="v-tap" data-word="annual" onclick="showVocab('annual',this)">annual</span>
                    event that brings communities together.
                </div>

                <button class="action-btn" id="reading-done-btn" onclick="completeReading()" disabled>
                    üéâ Reading Complete ‚Äî Next Stage ‚Üí
                </button>

            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         STAGE 1 ‚Äî TRUE / FALSE
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="quest-section" id="stage-1">
        <div class="quest-card">
            <div class="quest-header">
                <div class="quest-stage-icon">‚úÖ</div>
                <div class="quest-header-text">
                    <div class="quest-stage-num">Stage 2 of 4</div>
                    <div class="quest-stage-title">True or False?</div>
                </div>
                <div class="quest-xp-badge">+30 XP</div>
            </div>
            <div class="quest-body">

                <div id="tf-questions">
                    <!-- Q1 -->
                    <div class="tf-question" id="tf-0">
                        <div class="tf-q-text">1. Pancake Day is always on the same date every year.</div>
                        <div class="tf-btns">
                            <button class="tf-btn t-btn" data-q="0" data-val="true"  onclick="answerTF(0,'true')">üëç True</button>
                            <button class="tf-btn f-btn" data-q="0" data-val="false" onclick="answerTF(0,'false')">üëé False</button>
                        </div>
                        <div class="tf-feedback" id="tf-fb-0"></div>
                    </div>
                    <!-- Q2 -->
                    <div class="tf-question" id="tf-1">
                        <div class="tf-q-text">2. People made pancakes to use up rich foods before Lent.</div>
                        <div class="tf-btns">
                            <button class="tf-btn t-btn" data-q="1" data-val="true"  onclick="answerTF(1,'true')">üëç True</button>
                            <button class="tf-btn f-btn" data-q="1" data-val="false" onclick="answerTF(1,'false')">üëé False</button>
                        </div>
                        <div class="tf-feedback" id="tf-fb-1"></div>
                    </div>
                    <!-- Q3 -->
                    <div class="tf-question" id="tf-2">
                        <div class="tf-q-text">3. British pancakes are thicker than American pancakes.</div>
                        <div class="tf-btns">
                            <button class="tf-btn t-btn" data-q="2" data-val="true"  onclick="answerTF(2,'true')">üëç True</button>
                            <button class="tf-btn f-btn" data-q="2" data-val="false" onclick="answerTF(2,'false')">üëé False</button>
                        </div>
                        <div class="tf-feedback" id="tf-fb-2"></div>
                    </div>
                </div>

                <div class="result-bar" id="tf-result"></div>

                <button class="action-btn" id="tf-next-btn" onclick="completeTF()" disabled>
                    üí™ Stage Complete ‚Äî Next ‚Üí
                </button>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         STAGE 2 ‚Äî GAP FILL
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="quest-section" id="stage-2">
        <div class="quest-card">
            <div class="quest-header">
                <div class="quest-stage-icon">üß©</div>
                <div class="quest-header-text">
                    <div class="quest-stage-num">Stage 3 of 4</div>
                    <div class="quest-stage-title">Vocabulary: Fill the Gaps</div>
                </div>
                <div class="quest-xp-badge">+30 XP</div>
            </div>
            <div class="quest-body">

                <div class="word-bank" id="word-bank">
                    <button class="bank-chip" data-word="celebrate" onclick="selectChip(this)">celebrate</button>
                    <button class="bank-chip" data-word="tradition" onclick="selectChip(this)">tradition</button>
                    <button class="bank-chip" data-word="ingredients" onclick="selectChip(this)">ingredients</button>
                    <button class="bank-chip" data-word="races" onclick="selectChip(this)">races</button>
                    <button class="bank-chip" data-word="annual" onclick="selectChip(this)">annual</button>
                    <button class="bank-chip" data-word="flip" onclick="selectChip(this)">flip</button>
                </div>

                <div id="gap-sentences">
                    <div class="gap-sentence">1. Every year, British people <span class="gap-slot" data-answer="celebrate" onclick="fillSlot(this)">_______</span> Pancake Day.</div>
                    <div class="gap-sentence">2. Making pancakes on Shrove Tuesday is an old <span class="gap-slot" data-answer="tradition" onclick="fillSlot(this)">_______</span>.</div>
                    <div class="gap-sentence">3. You need eggs, flour, and milk as the main <span class="gap-slot" data-answer="ingredients" onclick="fillSlot(this)">_______</span>.</div>
                    <div class="gap-sentence">4. Many towns organize pancake <span class="gap-slot" data-answer="races" onclick="fillSlot(this)">_______</span> on this day.</div>
                    <div class="gap-sentence">5. Pancake Day is an <span class="gap-slot" data-answer="annual" onclick="fillSlot(this)">_______</span> event in Britain.</div>
                    <div class="gap-sentence">6. You must <span class="gap-slot" data-answer="flip" onclick="fillSlot(this)">_______</span> your pancake three times in the Olney race.</div>
                </div>

                <div class="result-bar" id="gap-result"></div>

                <div style="display:flex;gap:10px;margin-top:16px;">
                    <button class="action-btn secondary" onclick="resetGaps()" style="flex:1;">üîÑ Reset</button>
                    <button class="action-btn" onclick="checkGaps()" style="flex:2;">üéØ Check Answers</button>
                </div>
                <button class="action-btn green" id="gap-next-btn" onclick="completeGaps()" style="display:none;">
                    üèÜ Perfect! Next Stage ‚Üí
                </button>

            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         STAGE 3 ‚Äî GRAMMAR
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="quest-section" id="stage-3">
        <div class="quest-card">
            <div class="quest-header">
                <div class="quest-stage-icon">üìù</div>
                <div class="quest-header-text">
                    <div class="quest-stage-num">Stage 4 of 4</div>
                    <div class="quest-stage-title">Grammar: Past Simple</div>
                </div>
                <div class="quest-xp-badge">+30 XP</div>
            </div>
            <div class="quest-body">

                <div class="grammar-q" id="gq-0">
                    <div class="gq-text">1. The tradition ________ hundreds of years ago.</div>
                    <div class="gq-hint">üí° Past simple of <strong>begin</strong></div>
                    <select class="gq-select" id="gs-0" onchange="checkGrammarQ(0)">
                        <option value="">Choose the right form‚Ä¶</option>
                        <option value="begin">begin</option>
                        <option value="began">began</option>
                        <option value="begun">begun</option>
                    </select>
                </div>

                <div class="grammar-q" id="gq-1">
                    <div class="gq-text">2. People ________ up rich foods before Lent.</div>
                    <div class="gq-hint">üí° Past simple of <strong>give</strong></div>
                    <select class="gq-select" id="gs-1" onchange="checkGrammarQ(1)">
                        <option value="">Choose the right form‚Ä¶</option>
                        <option value="give">give</option>
                        <option value="gave">gave</option>
                        <option value="given">given</option>
                    </select>
                </div>

                <div class="grammar-q" id="gq-2">
                    <div class="gq-text">3. A woman ________ to church with her frying pan.</div>
                    <div class="gq-hint">üí° Past simple of <strong>run</strong></div>
                    <select class="gq-select" id="gs-2" onchange="checkGrammarQ(2)">
                        <option value="">Choose the right form‚Ä¶</option>
                        <option value="run">run</option>
                        <option value="ran">ran</option>
                        <option value="runned">runned</option>
                    </select>
                </div>

                <div class="result-bar" id="grammar-result"></div>

                <button class="action-btn" onclick="checkAllGrammar()">
                    üéì Check Grammar
                </button>
                <button class="action-btn green" id="grammar-finish-btn" onclick="finishLesson()" style="display:none;">
                    ü•û Complete Lesson!
                </button>

            </div>
        </div>
    </div>

</main>

<!-- ‚ïê‚ïê VOCAB BOTTOM SHEET ‚ïê‚ïê -->
<div id="sheet-overlay" onclick="closeVocab()"></div>
<div id="vocab-sheet">
    <button class="vs-close" onclick="closeVocab()">√ó</button>
    <div id="vs-word" class="vs-word"></div>
    <div id="vs-def" class="vs-def"></div>
    <div id="vs-example" class="vs-example"></div>
    <div class="vs-btns">
        <button class="vs-btn secondary" onclick="closeVocab()">Got it ‚úì</button>
        <button class="vs-btn primary" id="vs-speak-btn" onclick="speakCurrent()">üîä Listen</button>
    </div>
</div>

<!-- ‚ïê‚ïê COMBO DISPLAY ‚ïê‚ïê -->
<div id="combo-display">
    <div class="combo-card">
        <div class="combo-num" id="combo-num">2</div>
        <div class="combo-word">Combo! üî•</div>
    </div>
</div>

<!-- ‚ïê‚ïê COMPLETION SCREEN ‚ïê‚ïê -->
<div id="completion-screen">
    <div class="completion-card">
        <span class="cc-icon">ü•û</span>
        <div class="cc-title">Lesson Complete!</div>
        <div class="cc-sub">You flipped through every stage. Brilliant!</div>
        <div class="cc-xp-box">
            <div class="cc-xp-num" id="cc-xp">+120</div>
            <div class="cc-xp-label">XP Earned</div>
        </div>
        <div class="cc-stats">
            <div class="cc-stat">
                <div class="cc-stat-n" id="cc-vocab">0</div>
                <div class="cc-stat-l">Vocab</div>
            </div>
            <div class="cc-stat">
                <div class="cc-stat-n" id="cc-combo">0</div>
                <div class="cc-stat-l">Best Combo</div>
            </div>
            <div class="cc-stat">
                <div class="cc-stat-n" id="cc-accuracy">0%</div>
                <div class="cc-stat-l">Accuracy</div>
            </div>
        </div>
        <div class="cc-btns">
            <a href="/dashboard-gamified/" class="cc-btn amber">üìä View Dashboard</a>
            <a href="/intermediate/" class="cc-btn white">üöÄ Next Lesson ‚Üí</a>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="/init-auth.js"></script>
<script src="/supabase-auth-gamified.js"></script>
<script src="/daily-challenges-system.js"></script>
<script src="/word-match-game.js"></script>

<script>
'use strict';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const VOCAB = {
    celebrate:   { def: 'To do something enjoyable for a special occasion.',           ex: '"We celebrate Christmas every year."' },
    tradition:   { def: 'A custom or belief passed down through generations.',          ex: '"Afternoon tea is a British tradition."' },
    confess:     { def: 'To admit that you have done something wrong.',                 ex: '"He confessed to eating the last pancake."' },
    fasting:     { def: 'Not eating food for a period of time, often for religion.',    ex: '"Fasting during Lent meant no meat or dairy."' },
    ingredients: { def: 'The foods you need to make a dish.',                           ex: '"The ingredients for pancakes are simple."' },
    toss:        { def: 'To throw something lightly into the air.',                     ex: '"Can you toss a pancake without dropping it?"' },
    races:       { def: 'Competitions to see who can run the fastest.',                 ex: '"The town organizes pancake races every year."' },
    flip:        { def: 'To turn something over quickly, like a pancake in a pan.',     ex: '"You must flip the pancake at least once."' },
    thinner:     { def: 'Less thick; more flat.',                                       ex: '"British pancakes are thinner than American ones."' },
    savoury:     { def: 'Not sweet; salty or spicy in taste.',                          ex: '"I prefer savoury toppings like cheese."' },
    annual:      { def: 'Happening once every year.',                                   ex: '"Pancake Day is an annual British tradition."' },
};

const TF_ANSWERS = { 0: 'false', 1: 'true', 2: 'false' };
const TF_EXPLAIN = {
    0: 'False ‚Äî the date changes every year because it depends on Easter.',
    1: 'True ‚Äî eggs, milk and butter were used up before Lent began.',
    2: 'False ‚Äî British pancakes are thinner than American ones.',
};
const GRAMMAR_ANSWERS = ['began', 'gave', 'ran'];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let sessionXP        = 0;
let combo            = 0;
let bestCombo        = 0;
let totalAnswers     = 0;
let correctAnswers   = 0;
let vocabTapped      = new Set();
let parasRevealed    = 0;
let currentStage     = 0;
let tfAnswered       = [false, false, false];
let tfCorrect        = [false, false, false];
let gapCorrect       = [false, false, false, false, false, false];
let grammarCorrect   = [false, false, false];
let selectedChip     = null;
let currentVocabWord = null;
const TOTAL_STAGES   = 4;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function init() {
    if (window.efcdReady) await window.efcdReady;
    if (window.EFCD_Auth) {
        await window.EFCD_Auth.initAuth();
        const user = window.EFCD_Auth.getCurrentUser();
        if (user) {
            const s = window.EFCD_Auth.getUserStats();
            document.getElementById('hdr-streak').textContent = s.streak;
            document.getElementById('hdr-xp').textContent     = s.xp.toLocaleString();
        }
    }
    if (window.DailyChallenges) {
        document.getElementById('daily-challenge-widget').innerHTML =
            window.DailyChallenges.renderDailyChallengeWidget();
    }
    // Para 1 is auto-revealed on load ‚Äî hide its button, count it, show para 2 button
    setTimeout(() => {
        document.getElementById('para-0').classList.add('revealed');
        document.getElementById('reveal-btn-0').style.display = 'none';
        parasRevealed = 1;
        document.getElementById('reveal-btn-1').style.display = 'flex';
    }, 200);
}

document.addEventListener('DOMContentLoaded', init);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  XP + COMBO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addXP(amount, el) {
    sessionXP += amount;
    // Update header (animate the number)
    const xpEl = document.getElementById('hdr-xp');
    const current = parseInt(xpEl.textContent.replace(/,/g,'')) || 0;
    xpEl.textContent = (current + amount).toLocaleString();
    xpEl.style.transform = 'scale(1.3)';
    setTimeout(() => xpEl.style.transform = 'scale(1)', 300);

    // XP floater
    if (el) {
        const r = el.getBoundingClientRect();
        const f = document.createElement('div');
        f.className = 'xp-floater';
        f.textContent = `+${amount} XP`;
        f.style.cssText = `left:${r.left + r.width/2 - 30}px;top:${r.top + window.scrollY - 10}px`;
        document.body.appendChild(f);
        setTimeout(() => f.remove(), 900);
    }
}

function hitCombo(el) {
    combo++;
    if (combo > bestCombo) bestCombo = combo;
    if (combo >= 2) showCombo(combo, el);
}

function breakCombo() {
    combo = 0;
    document.getElementById('combo-display').style.display = 'none';
}

function showCombo(n, el) {
    const cd = document.getElementById('combo-display');
    document.getElementById('combo-num').textContent = n;
    cd.style.display = 'block';
    cd.querySelector('.combo-card').style.animation = 'none';
    requestAnimationFrame(() => {
        cd.querySelector('.combo-card').style.animation = 'comboIn .4s cubic-bezier(.175,.885,.32,1.275) both';
    });
    clearTimeout(cd._timer);
    cd._timer = setTimeout(() => { cd.style.display = 'none'; }, 2500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFETTI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CONFETTI_COLS = ['#1CB0F6','#1899D6','#FFC800','#58CC02','#5ecff8','#FFFFFF'];
function burst(count = 18) {
    for (let i = 0; i < count; i++) {
        const d = document.createElement('div');
        d.className = 'confetti-dot';
        const col = CONFETTI_COLS[Math.floor(Math.random() * CONFETTI_COLS.length)];
        d.style.cssText = `left:${10+Math.random()*80}vw;top:${10+Math.random()*40}vh;background:${col};animation-delay:${Math.random()*.4}s;animation-duration:${.8+Math.random()*.6}s;border-radius:${Math.random()>.5?'50%':'3px'}`;
        document.body.appendChild(d);
        setTimeout(() => d.remove(), 1600);
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PROGRESS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setProgress(pct) {
    const fill = document.getElementById('progress-fill');
    fill.style.width = pct + '%';
    fill.classList.add('pulsing');
    setTimeout(() => fill.classList.remove('pulsing'), 1000);
}

function activateStage(n) {
    currentStage = n;
    // Hide all sections
    document.querySelectorAll('.quest-section').forEach(s => s.classList.remove('active'));
    document.getElementById('stage-' + n).classList.add('active');
    // Scroll to top of main
    window.scrollTo({ top: 60, behavior: 'smooth' });
    // Update pills
    document.querySelectorAll('.stage-pill').forEach((p, i) => {
        p.classList.remove('active','done');
        if (i < n) p.classList.add('done');
        else if (i === n) p.classList.add('active');
    });
    setProgress(Math.round((n / TOTAL_STAGES) * 100));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STAGE 0 ‚Äî READING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function revealPara(idx) {
    const btn = document.getElementById('reveal-btn-' + idx);
    const para = document.getElementById('para-' + idx);
    btn.classList.add('done');
    btn.innerHTML = '‚úÖ Paragraph ' + (idx+1) + ' ‚Äî tap the golden words!';
    para.classList.add('revealed');
    parasRevealed++;
    addXP(3, btn);

    // Show next reveal button
    if (idx < 4) {
        const nextBtn = document.getElementById('reveal-btn-' + (idx+1));
        if (nextBtn) {
            nextBtn.style.display = 'flex';
            setTimeout(() => nextBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 300);
        }
    }

    if (parasRevealed === 5) {
        const doneBtn = document.getElementById('reading-done-btn');
        doneBtn.disabled = false;
        doneBtn.style.animation = 'tapHint 2s ease-in-out infinite';
    }
}

function completeReading() {
    addXP(15, document.getElementById('reading-done-btn'));
    burst(14);
    activateStage(1);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  VOCAB SHEET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showVocab(word, el) {
    const v = VOCAB[word];
    if (!v) return;
    currentVocabWord = word;
    document.getElementById('vs-word').textContent    = word.charAt(0).toUpperCase() + word.slice(1);
    document.getElementById('vs-def').textContent     = v.def;
    document.getElementById('vs-example').textContent = v.ex;
    document.getElementById('vocab-sheet').classList.add('open');
    document.getElementById('sheet-overlay').classList.add('open');
    document.body.style.overflow = 'hidden';
    if (el) el.classList.add('tapped');
    if (!vocabTapped.has(word)) {
        vocabTapped.add(word);
        addXP(2, el || document.getElementById('vocab-sheet'));
    }
}

function closeVocab() {
    document.getElementById('vocab-sheet').classList.remove('open');
    document.getElementById('sheet-overlay').classList.remove('open');
    document.body.style.overflow = '';
    currentVocabWord = null;
}

function speakCurrent() {
    if (!currentVocabWord) return;
    const u = new SpeechSynthesisUtterance(currentVocabWord);
    u.lang = 'en-GB'; u.rate = 0.85;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STAGE 1 ‚Äî TRUE / FALSE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function answerTF(q, val) {
    if (tfAnswered[q]) return;
    tfAnswered[q] = true;
    totalAnswers++;

    const correct = val === TF_ANSWERS[q];
    tfCorrect[q] = correct;
    const btns = document.querySelectorAll(`[data-q="${q}"]`);
    btns.forEach(b => {
        b.disabled = true;
        if (b.dataset.val === TF_ANSWERS[q]) b.classList.add('correct');
        else if (b.dataset.val === val && !correct) b.classList.add('wrong');
    });

    const fb = document.getElementById('tf-fb-' + q);
    fb.className = 'tf-feedback ' + (correct ? 'ok' : 'bad');
    fb.textContent = (correct ? '‚úÖ ' : '‚ùå ') + TF_EXPLAIN[q];

    if (correct) {
        correctAnswers++;
        hitCombo(btns[0]);
        addXP(10, btns[0]);
    } else {
        breakCombo();
    }

    // Check if all answered
    if (tfAnswered.every(Boolean)) {
        const allRight = tfCorrect.every(Boolean);
        const result = document.getElementById('tf-result');
        const score = tfCorrect.filter(Boolean).length;
        result.textContent = allRight ? `üéâ Perfect! ${score}/3 correct!` : `${score}/3 correct ‚Äî check the explanations above.`;
        result.className = 'result-bar ' + (allRight ? 'ok' : 'bad') + ' show';
        if (allRight) burst(12);
        document.getElementById('tf-next-btn').disabled = false;
        if (!allRight) document.getElementById('tf-next-btn').textContent = '‚Üí Continue Anyway';
    }
}

function completeTF() {
    addXP(10, document.getElementById('tf-next-btn'));
    activateStage(2);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STAGE 2 ‚Äî GAP FILL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function selectChip(el) {
    if (el.classList.contains('used')) return;
    document.querySelectorAll('.bank-chip').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    selectedChip = el;
}

function fillSlot(el) {
    if (el.classList.contains('correct')) return;

    // If slot already has a word, return it to bank
    if (el.dataset.current) {
        const oldChip = document.querySelector(`.bank-chip[data-word="${el.dataset.current}"]`);
        if (oldChip) { oldChip.classList.remove('used'); }
        el.dataset.current = '';
        el.textContent = '_______';
        el.classList.remove('has-word','wrong');
    }

    if (!selectedChip) return;

    el.textContent = selectedChip.dataset.word;
    el.dataset.current = selectedChip.dataset.word;
    el.classList.add('has-word');
    el.classList.remove('wrong');
    selectedChip.classList.add('used');
    selectedChip.classList.remove('selected');
    selectedChip = null;
}

function checkGaps() {
    const slots = document.querySelectorAll('.gap-slot');
    let correct = 0;
    slots.forEach((s, i) => {
        const word = s.dataset.current || '';
        if (!word) return;
        totalAnswers++;
        if (word === s.dataset.answer) {
            s.classList.add('correct');
            s.classList.remove('wrong');
            gapCorrect[i] = true;
            correct++;
            correctAnswers++;
            hitCombo(s);
            addXP(5, s);
        } else {
            s.classList.add('wrong');
            gapCorrect[i] = false;
            breakCombo();
        }
    });

    const all = slots.length;
    const res = document.getElementById('gap-result');
    const allFilled = Array.from(slots).every(s => s.dataset.current);
    if (!allFilled) {
        res.textContent = '‚ö†Ô∏è Fill all the gaps first!';
        res.className = 'result-bar bad show';
        return;
    }

    res.textContent = correct === all ? `üéâ Perfect! All ${all} correct!` : `${correct}/${all} correct ‚Äî try the wrong ones again.`;
    res.className = 'result-bar ' + (correct === all ? 'ok' : 'bad') + ' show';

    if (correct === all) {
        burst(14);
        document.getElementById('gap-next-btn').style.display = 'flex';
        document.querySelector('[onclick="checkGaps()"]').style.display = 'none';
    }
}

function resetGaps() {
    document.querySelectorAll('.gap-slot').forEach(s => {
        s.textContent = '_______';
        s.dataset.current = '';
        s.classList.remove('has-word','correct','wrong');
    });
    document.querySelectorAll('.bank-chip').forEach(c => c.classList.remove('used','selected'));
    document.getElementById('gap-result').classList.remove('show');
    selectedChip = null;
    gapCorrect.fill(false);
}

function completeGaps() {
    addXP(10, document.getElementById('gap-next-btn'));
    activateStage(3);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STAGE 3 ‚Äî GRAMMAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkGrammarQ(idx) {
    const sel = document.getElementById('gs-' + idx);
    const val = sel.value;
    if (!val) return;
    const correct = val === GRAMMAR_ANSWERS[idx];
    const card = document.getElementById('gq-' + idx);

    sel.className = 'gq-select ' + (correct ? 'correct' : 'wrong');
    card.className = 'grammar-q ' + (correct ? 'correct' : 'wrong');
    sel.disabled = correct; // lock if correct

    if (correct) {
        grammarCorrect[idx] = true;
        totalAnswers++;
        correctAnswers++;
        hitCombo(sel);
        addXP(5, sel);
    } else {
        breakCombo();
        // Re-enable to try again
        setTimeout(() => {
            sel.className = 'gq-select';
            card.className = 'grammar-q';
        }, 1000);
    }
}

function checkAllGrammar() {
    const allCorrect = grammarCorrect.every(Boolean);
    const score = grammarCorrect.filter(Boolean).length;
    const res = document.getElementById('grammar-result');

    if (!allCorrect) {
        // Auto-check all selects
        [0,1,2].forEach(i => {
            const sel = document.getElementById('gs-' + i);
            if (!grammarCorrect[i] && sel.value) checkGrammarQ(i);
        });
        res.textContent = `${score}/3 correct ‚Äî keep trying!`;
        res.className = 'result-bar bad show';
        return;
    }

    res.textContent = `üéì Grammar Champion! All 3 correct!`;
    res.className = 'result-bar ok show';
    burst(20);
    document.getElementById('grammar-finish-btn').style.display = 'flex';
    document.querySelector('[onclick="checkAllGrammar()"]').style.display = 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FINISH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function finishLesson() {
    const bonusXP = 30; // completion bonus
    addXP(bonusXP, document.getElementById('grammar-finish-btn'));
    burst(28);
    setProgress(100);

    // Mark all stage pills done
    document.querySelectorAll('.stage-pill').forEach(p => { p.classList.remove('active'); p.classList.add('done'); });

    const accuracy = totalAnswers > 0 ? Math.round((correctAnswers / totalAnswers) * 100) : 100;

    // Save to DB
    let xpEarned = sessionXP;
    if (window.EFCD_Auth?.getCurrentUser()) {
        try {
            const result = await window.EFCD_Auth.completeLesson({
                lessonId:       'pancake-day',
                lessonTitle:    'The History of Pancake Day',
                lessonLevel:    'Intermediate',
                lessonLink:     '/pancakeday/',
                vocabulary:     Object.keys(VOCAB).map(w => ({ word:w, definition:VOCAB[w].def })),
                grammar:        [
                    { question:'The tradition ________ hundreds of years ago.', answer:'began', explanation:'Past simple of irregular verb begin.' },
                    { question:'People ________ up rich foods before Lent.',     answer:'gave',  explanation:'Past simple of irregular verb give.' },
                    { question:'A woman ________ to church with her frying pan.',answer:'ran',   explanation:'Past simple of irregular verb run.' },
                ],
                perfectScore:   accuracy === 100,
                completionTime: Math.floor((Date.now() - performance.timing.navigationStart) / 1000),
            });
            if (result?.xpEarned) xpEarned = result.xpEarned;

            if (window.DailyChallenges && result?.success) {
                await window.DailyChallenges.updateChallengeProgress({
                    perfectScore:   accuracy === 100,
                    vocabCount:     Object.keys(VOCAB).length,
                    completionTime: Math.floor((Date.now() - performance.timing.navigationStart) / 1000),
                    grammarPerfect: grammarCorrect.every(Boolean),
                });
            }
        } catch(e) { console.warn('Save error:', e); }
    }

    // Show completion screen
    const totalVocab = Object.keys(VOCAB).length;
    document.getElementById('cc-xp').textContent       = '+' + xpEarned + ' XP';
    document.getElementById('cc-vocab').textContent    = vocabTapped.size + '/' + totalVocab;
    document.getElementById('cc-combo').textContent    = bestCombo;
    document.getElementById('cc-accuracy').textContent = accuracy + '%';
    setTimeout(() => {
        document.getElementById('completion-screen').classList.add('open');
        burst(30);
        setTimeout(() => burst(20), 500);
    }, 600);
}
</script>
</body>
</html>
