<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <link rel="icon" type="image/png" href="/favicon.png" sizes="32x32">
    <title>üìÑ The Redline Room ‚Äî English For Cool Dudes</title>

    <link rel="preconnect" href="https://fonts.bunny.net">
    <link href="https://fonts.bunny.net/css2?family=Nunito:wght@400;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/init-auth.js"></script>

    <style>
    :root {
        --blue:         #1CB0F6;
        --blue-shadow:  #1899D6;
        --yellow:       #FFC800;
        --yellow-shadow:#E5B400;
        --green:        #58CC02;
        --green-shadow: #58A700;
        --punch:        #FF4B4B;
        --punch-shadow: #EA2B2B;
        --purple:       #CE82FF;
        --purple-shadow:#A559D9;
        --teal:         #2BDECC;
        --teal-shadow:  #1FB8A8;
        --bg:           #F7F9FA;
        --white:        #FFFFFF;
        --ink:          #4B4B4B;
        --ink-bold:     #111827;
        --ink-3:        #AFAFAF;
        --border:       #E5E5E5;
        --border-heavy: #CECECE;
        --r:            24px;
        --rsm:          16px;
        --rxs:          10px;

        /* Legal / teal accent */
        --accent:        var(--teal);
        --accent-shadow: var(--teal-shadow);
        --accent-light:  rgba(43,222,204,.1);
        --accent-border: rgba(43,222,204,.32);
        --accent-text:   #0E8A80;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { -webkit-text-size-adjust: 100%; scroll-behavior: smooth; }
    body {
        background: var(--bg);
        color: var(--ink);
        font-family: 'Nunito', -apple-system, system-ui, sans-serif;
        line-height: 1.5;
        overflow-x: hidden;
        padding-bottom: 84px;
        -webkit-font-smoothing: antialiased;
    }
    @media(min-width:768px){ body { padding-bottom: 0; } }
    a { color: inherit; text-decoration: none; }
    button { font-family: inherit; cursor: pointer; }

    @keyframes up      { from{opacity:0;transform:translateY(22px)} to{opacity:1;transform:translateY(0)} }
    @keyframes popin   { 0%{opacity:0;transform:scale(.88)} 70%{transform:scale(1.03)} 100%{opacity:1;transform:scale(1)} }
    @keyframes shim    { 0%{background-position:-400px 0} 100%{background-position:400px 0} }
    @keyframes nudge   { 0%,100%{transform:translateX(0)} 30%{transform:translateX(5px)} }
    @keyframes float   { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }
    @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
    @keyframes confetti{ 0%{opacity:1;transform:translateY(0) rotate(0deg)} 100%{opacity:0;transform:translateY(130px) rotate(400deg)} }
    @keyframes flick   { 0%,100%{transform:rotate(-4deg) scale(1)} 50%{transform:rotate(4deg) scale(1.12)} }
    @keyframes stampIn { 0%{transform:scale(2.5) rotate(-12deg);opacity:0} 60%{transform:scale(.9) rotate(2deg);opacity:1} 100%{transform:scale(1) rotate(-1deg);opacity:1} }
    @keyframes redlinePulse { 0%,100%{opacity:.7} 50%{opacity:1} }

    .u1{animation:up .44s ease both .04s} .u2{animation:up .44s ease both .14s}
    .u3{animation:up .44s ease both .24s} .u4{animation:up .44s ease both .34s}

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    .header {
        background: var(--white); border-bottom: 2px solid var(--border);
        position: sticky; top: 0; z-index: 200;
        padding: 0 20px; height: 60px; display: flex; align-items: center;
    }
    .hc { max-width: 900px; width: 100%; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
    .hl { display: flex; align-items: center; gap: 10px; }
    .logo {
        width: 40px; height: 40px; border-radius: 12px;
        background: var(--yellow); border: 2px solid var(--border-heavy);
        display: flex; align-items: center; justify-content: center;
        font-size: 22px; flex-shrink: 0; box-shadow: 0 3px 0 var(--border-heavy);
    }
    .site-title { font-size: 18px; font-weight: 900; color: var(--ink-bold); letter-spacing: -.4px; }
    @media(max-width:380px){ .site-title{display:none} }
    .hdr-stats { display: flex; align-items: center; gap: 8px; }
    .hdr-pill {
        display: flex; align-items: center; gap: 5px;
        background: var(--bg); border: 2px solid var(--border-heavy);
        border-bottom: 4px solid var(--border-heavy);
        padding: 5px 12px; border-radius: var(--rxs);
        font-size: 14px; font-weight: 900; color: var(--ink-bold);
    }

    /* ‚îÄ‚îÄ PAGE ‚îÄ‚îÄ */
    .page { max-width: 900px; margin: 0 auto; padding: 24px 16px 24px; display: flex; flex-direction: column; gap: 16px; }

    /* ‚îÄ‚îÄ LESSON BANNER ‚Äî teal accent ‚îÄ‚îÄ */
    .lesson-banner {
        background: var(--blue); border: 2px solid var(--blue-shadow);
        border-bottom: 6px solid var(--blue-shadow);
        border-radius: var(--r); padding: 24px 20px 20px;
        position: relative; overflow: hidden;
    }
    .lesson-banner::after {
        content: 'üìÑ'; position: absolute; bottom: -16px; right: 8px;
        font-size: 120px; opacity: .1; pointer-events: none; transform: rotate(-8deg);
    }
    .lesson-eyebrow {
        display: inline-block; background: var(--teal); color: var(--ink-bold);
        font-size: 12px; font-weight: 900; text-transform: uppercase; letter-spacing: 1.5px;
        padding: 4px 12px; border-radius: 8px; border: 2px solid var(--teal-shadow);
        margin-bottom: 12px;
    }
    .lesson-title {
        font-size: clamp(24px,6vw,38px); font-weight: 900; color: var(--white);
        letter-spacing: -1px; line-height: 1.1; margin-bottom: 6px;
        position: relative; z-index: 1; text-shadow: 0 2px 0 var(--blue-shadow);
    }
    .lesson-sub { font-size: 15px; font-weight: 700; color: rgba(255,255,255,.9); position: relative; z-index: 1; }
    .prog-wrap  { margin-top: 18px; position: relative; z-index: 1; background: rgba(255,255,255,.2); padding: 12px; border-radius: var(--rsm); }
    .prog-row   { display: flex; justify-content: space-between; font-size: 13px; font-weight: 800; color: var(--white); margin-bottom: 8px; }
    .prog-track { height: 16px; background: rgba(0,0,0,.15); border-radius: 99px; overflow: hidden; border: 2px solid rgba(0,0,0,.1); }
    .prog-fill  { height: 100%; width: 0%; border-radius: 99px; background: var(--teal); border-top: 4px solid rgba(255,255,255,.4); transition: width .7s cubic-bezier(.4,0,.2,1); }

    /* ‚îÄ‚îÄ SECTION CARD ‚îÄ‚îÄ */
    .sec-card {
        background: var(--white); border: 2px solid var(--border-heavy);
        border-bottom: 6px solid var(--border-heavy); border-radius: var(--r);
        overflow: hidden; opacity: 0; transform: translateY(16px);
        transition: opacity .4s ease, transform .4s ease; scroll-margin-top: 72px;
    }
    .sec-card.visible { opacity: 1; transform: translateY(0); }
    .sec-card::before { content: ''; display: block; height: 7px; }
    .strip-teal::before   { background: linear-gradient(90deg, var(--teal) 0%, #7AEEEA 100%); }
    .strip-blue::before   { background: var(--blue); }
    .strip-green::before  { background: var(--green); }
    .strip-purple::before { background: var(--purple); }
    .strip-punch::before  { background: var(--punch); }
    .strip-yellow::before { background: var(--yellow); }

    .sec-head {
        padding: 14px 20px 12px; border-bottom: 2px solid var(--border);
        display: flex; align-items: center; justify-content: space-between; gap: 10px;
    }
    .sec-head-left { display: flex; align-items: center; gap: 10px; }
    .sec-head-icon {
        width: 40px; height: 40px; border-radius: 12px;
        display: flex; align-items: center; justify-content: center;
        font-size: 20px; flex-shrink: 0;
        background: var(--bg); border: 2px solid var(--border-heavy); border-bottom: 3px solid var(--border-heavy);
    }
    .sec-head-title { font-size: 16px; font-weight: 900; color: var(--ink-bold); letter-spacing: -.3px; }
    .sec-head-sub   { font-size: 12px; font-weight: 700; color: var(--ink-3); margin-top: 1px; }
    .sec-body { padding: 20px; }
    @media(min-width:768px){ .sec-body { padding: 24px; } }

    .sec-label {
        font-size: 13px; font-weight: 900; color: var(--ink-3);
        text-transform: uppercase; letter-spacing: 1.5px;
        display: flex; align-items: center; gap: 12px;
    }
    .sec-label::after { content: ''; flex: 1; height: 2px; background: var(--border); border-radius: 2px; }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       REDLINE MECHANIC
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    /* The "contract document" look */
    .contract-doc {
        background: #FEFEFE;
        border: 2px solid var(--border-heavy);
        border-radius: var(--rsm);
        overflow: hidden;
        margin-bottom: 14px;
        box-shadow: 0 2px 12px rgba(0,0,0,.06);
    }
    .contract-header {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        padding: 14px 20px;
        display: flex; align-items: center; justify-content: space-between;
    }
    .contract-title { font-size: 13px; font-weight: 900; color: rgba(255,255,255,.9); letter-spacing: 1px; text-transform: uppercase; }
    .contract-ref   { font-size: 11px; font-weight: 800; color: rgba(255,255,255,.5); }
    .contract-body  { padding: 20px; font-size: 14px; line-height: 2; color: var(--ink-bold); font-weight: 700; }
    @media(min-width:640px){ .contract-body { padding: 24px; font-size: 15px; } }

    /* Individual clause ‚Äî tappable */
    .clause {
        display: block;
        padding: 10px 14px;
        margin-bottom: 10px;
        border-radius: var(--rsm);
        border: 2px solid var(--border);
        background: var(--bg);
        cursor: pointer;
        transition: border-color .15s, background .15s, transform .1s;
        position: relative;
        line-height: 1.7;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
    }
    .clause:active { transform: scale(.99); }
    .clause.active  { border-color: var(--teal); background: var(--accent-light); }

    /* The three stamp states */
    .clause.stamped-accept  { border-color: var(--green-shadow); background: rgba(88,204,2,.08); cursor: default; }
    .clause.stamped-flag    { border-color: var(--yellow-shadow); background: rgba(255,200,0,.08); cursor: default; }
    .clause.stamped-reject  { border-color: var(--punch-shadow); background: rgba(255,75,75,.08); cursor: default; }

    /* Redline strikethrough on rejected clauses */
    .clause.stamped-reject .clause-text { text-decoration: line-through; text-decoration-color: var(--punch); text-decoration-thickness: 2px; opacity: .65; }

    /* Stamp badge on clause */
    .clause-stamp {
        display: none;
        position: absolute; top: 8px; right: 10px;
        font-size: 11px; font-weight: 900;
        padding: 3px 8px; border-radius: 6px; border: 1.5px solid;
        animation: stampIn .35s cubic-bezier(.175,.885,.32,1.275) both;
    }
    .clause.stamped-accept .clause-stamp { display: inline-block; background: rgba(88,204,2,.15); color: var(--green-shadow); border-color: var(--green-shadow); }
    .clause.stamped-flag   .clause-stamp { display: inline-block; background: rgba(255,200,0,.2); color: #8A6400; border-color: var(--yellow-shadow); }
    .clause.stamped-reject .clause-stamp { display: inline-block; background: rgba(255,75,75,.12); color: var(--punch-shadow); border-color: var(--punch-shadow); }

    .clause-num { font-size: 11px; font-weight: 900; color: var(--ink-3); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
    .clause-text { display: block; }
    .clause-kw { color: var(--accent-text); font-weight: 900; border-bottom: 2px solid var(--accent-border); cursor: pointer; }

    /* Verdict sheet overlay */
    .verdict-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,.5);
        z-index: 400; display: none; align-items: flex-end; justify-content: center;
    }
    .verdict-overlay.open { display: flex; }
    .verdict-sheet {
        background: var(--white); width: 100%; max-width: 600px;
        border-radius: var(--r) var(--r) 0 0; border: 2px solid var(--border-heavy);
        border-bottom: none; max-height: 88vh; overflow-y: auto;
        animation: slideUp .3s cubic-bezier(.175,.885,.32,1.275) both;
    }
    .vs-handle { width: 36px; height: 4px; background: var(--border-heavy); border-radius: 4px; margin: 12px auto 0; }
    .vs-head {
        padding: 14px 20px; border-bottom: 2px solid var(--border);
        display: flex; align-items: center; justify-content: space-between;
    }
    .vs-title { font-size: 17px; font-weight: 900; color: var(--ink-bold); }
    .vs-close {
        width: 34px; height: 34px; background: var(--bg); border: 2px solid var(--border-heavy);
        border-radius: var(--rxs); font-size: 18px; font-weight: 900; color: var(--ink-3);
        display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0;
    }
    .vs-body { padding: 18px 20px; }

    /* The three stamp buttons */
    .stamp-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 18px; }
    .stamp-btn {
        display: flex; flex-direction: column; align-items: center; gap: 5px;
        padding: 14px 8px; border-radius: var(--rsm);
        border: 2px solid; border-bottom-width: 5px;
        font-family: inherit; font-size: 12px; font-weight: 900; letter-spacing: .3px;
        cursor: pointer; touch-action: manipulation;
        transition: transform .1s, border-bottom-width .1s;
    }
    .stamp-btn:active { border-bottom-width: 2px; transform: translateY(3px); }
    .stamp-btn .sb-icon { font-size: 24px; }
    .stamp-btn.accept { background: rgba(88,204,2,.08);  border-color: var(--green-shadow); color: var(--green-shadow); }
    .stamp-btn.flag   { background: rgba(255,200,0,.12); border-color: var(--yellow-shadow); color: #8A6400; }
    .stamp-btn.reject { background: rgba(255,75,75,.08); border-color: var(--punch-shadow);  color: var(--punch-shadow); }
    .stamp-btn.chosen-correct   { background: var(--green) !important;  color: var(--white) !important; border-color: var(--green-shadow) !important; }
    .stamp-btn.chosen-incorrect { background: var(--punch) !important;  color: var(--white) !important; border-color: var(--punch-shadow) !important; }
    .stamp-btn.chosen-dim       { opacity: .35; cursor: default; }
    .stamp-btn:disabled { cursor: default; }

    /* Verdict box */
    .vs-verdict { border: 2px solid var(--border-heavy); border-radius: var(--rsm); overflow: hidden; margin-top: 4px; animation: up .2s ease both; }
    .vs-verd-banner { padding: 12px 16px; font-size: 15px; font-weight: 900; }
    .vs-verd-banner.correct   { background: var(--green); color: var(--white); }
    .vs-verd-banner.incorrect { background: var(--punch); color: var(--white); }
    .vs-verd-explain { padding: 14px 16px; font-size: 14px; font-weight: 700; line-height: 1.65; color: var(--ink-bold); border-top: 2px solid var(--border); }
    .ev-voc { color: var(--accent-text); font-weight: 900; border-bottom: 2.5px solid var(--accent-border); cursor: pointer; }

    .vs-next {
        display: flex; align-items: center; justify-content: center; gap: 8px;
        width: 100%; padding: 15px; margin-top: 14px;
        background: var(--teal); color: var(--ink-bold);
        font-size: 15px; font-weight: 900; font-family: inherit;
        border: 2px solid var(--teal-shadow); border-bottom: 5px solid var(--teal-shadow);
        border-radius: var(--rsm); transition: transform .1s, border-bottom-width .1s;
    }
    .vs-next:active { border-bottom-width: 2px; transform: translateY(3px); }

    /* Counter row */
    .redline-counter {
        display: flex; justify-content: center; align-items: center; gap: 8px;
        margin-bottom: 14px; flex-wrap: wrap;
    }
    .rc-label { font-size: 13px; font-weight: 900; color: var(--ink-3); text-transform: uppercase; letter-spacing: 1.5px; }
    .rc-chips { display: flex; gap: 6px; }
    .rc-chip {
        width: 30px; height: 30px; border-radius: 8px;
        border: 2px solid var(--border-heavy); background: var(--bg);
        display: flex; align-items: center; justify-content: center; font-size: 14px;
        transition: all .3s;
    }
    .rc-chip.done-accept { background: var(--green); border-color: var(--green-shadow); }
    .rc-chip.done-flag   { background: var(--yellow); border-color: var(--yellow-shadow); }
    .rc-chip.done-reject { background: var(--punch); border-color: var(--punch-shadow); }

    /* Redline done panel */
    .redline-done {
        text-align: center; padding: 28px 20px 24px;
        animation: popin .4s cubic-bezier(.175,.885,.32,1.275) both;
    }
    .rd-icon  { font-size: 56px; display: block; margin-bottom: 10px; }
    .rd-title { font-size: 22px; font-weight: 900; color: var(--ink-bold); margin-bottom: 8px; }
    .rd-sub   { font-size: 14px; font-weight: 700; color: var(--ink-3); margin-bottom: 20px; }
    .rd-score { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
    .rd-chip  { padding: 7px 14px; border-radius: 10px; font-size: 13px; font-weight: 900; border: 2px solid; }
    .rd-chip.accept { background: rgba(88,204,2,.1); color: var(--green-shadow); border-color: var(--green-shadow); }
    .rd-chip.flag   { background: rgba(255,200,0,.12); color: #8A6400; border-color: var(--yellow-shadow); }
    .rd-chip.reject { background: rgba(255,75,75,.1); color: var(--punch-shadow); border-color: var(--punch-shadow); }
    .rd-btn {
        display: flex; align-items: center; justify-content: center; gap: 8px;
        width: 100%; padding: 15px; background: var(--teal); color: var(--ink-bold);
        font-size: 16px; font-weight: 900; font-family: inherit;
        border: 2px solid var(--teal-shadow); border-bottom: 5px solid var(--teal-shadow);
        border-radius: var(--rsm); transition: transform .1s, border-bottom-width .1s;
    }
    .rd-btn:active { border-bottom-width: 2px; transform: translateY(3px); }

    /* ‚îÄ‚îÄ BRIEFING ‚îÄ‚îÄ */
    .briefing-skip {
        font-size: 12px; font-weight: 900; color: var(--ink-3);
        background: var(--bg); border: 2px solid var(--border);
        padding: 5px 12px; border-radius: var(--rxs);
    }
    .b-block {
        background: var(--bg); border: 2px solid var(--border); border-left-width: 5px;
        border-radius: 0 var(--rsm) var(--rsm) 0; padding: 14px 16px; margin-bottom: 12px;
        animation: up .35s ease both;
    }
    .b-block[data-heat="1"] { border-left-color: var(--teal); }
    .b-block[data-heat="2"] { border-left-color: var(--yellow-shadow); }
    .b-block[data-heat="3"] { border-left-color: var(--punch); }
    .b-label { font-size: 11px; font-weight: 900; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 10px; }
    .b-block[data-heat="1"] .b-label { color: var(--accent-text); }
    .b-block[data-heat="2"] .b-label { color: #8A6400; }
    .b-block[data-heat="3"] .b-label { color: var(--punch-shadow); }
    .b-rows { display: flex; flex-direction: column; gap: 7px; }
    .b-row  { display: flex; align-items: baseline; gap: 10px; font-size: 14px; }
    .b-key  { font-size: 11px; font-weight: 900; color: var(--ink-3); text-transform: uppercase; letter-spacing: .8px; min-width: 130px; flex-shrink: 0; }
    .b-val      { font-weight: 800; color: var(--ink-bold); }
    .b-val.hot  { color: var(--punch-shadow); }
    .b-val.warm { color: #8A6400; }
    .b-val.cool { color: var(--accent-text); }
    .b-voc { color: var(--accent-text); font-weight: 900; border-bottom: 2px solid var(--accent-border); cursor: pointer; }
    .b-alert { margin-top: 12px; padding: 12px 14px; background: rgba(255,75,75,.07); border: 2px solid rgba(255,75,75,.25); border-radius: var(--rsm); font-size: 14px; font-weight: 700; color: var(--punch-shadow); line-height: 1.5; }
    .b-alert strong { font-weight: 900; }
    .briefing-go {
        display: flex; align-items: center; justify-content: center; gap: 8px;
        width: 100%; margin-top: 18px; padding: 16px;
        background: var(--green); color: var(--white);
        font-size: 16px; font-weight: 900; font-family: inherit;
        border: 2px solid var(--green-shadow); border-bottom: 5px solid var(--green-shadow);
        border-radius: var(--rsm); transition: transform .1s, border-bottom-width .1s;
    }
    .briefing-go:active { border-bottom-width: 2px; transform: translateY(3px); }

    /* ‚îÄ‚îÄ EXERCISES ‚Äî shared ‚îÄ‚îÄ */
    .q-box { background: var(--bg); border: 2px solid var(--border); border-radius: var(--rsm); padding: 15px; margin-bottom: 10px; }
    .q-text { font-size: 15px; font-weight: 800; color: var(--ink-bold); margin-bottom: 10px; line-height: 1.4; }

    .opt-btn {
        display: block; width: 100%; text-align: left; padding: 13px 15px; min-height: 50px;
        margin-top: 7px; background: var(--white);
        border: 2px solid var(--border-heavy); border-bottom: 5px solid var(--border-heavy);
        border-radius: var(--rsm); font-size: 14px; font-weight: 800; color: var(--ink);
        font-family: inherit; transition: transform .1s, border-bottom-width .1s, border-color .15s;
        cursor: pointer; touch-action: manipulation;
    }
    .opt-btn:active    { border-bottom-width: 2px; transform: translateY(3px); }
    .opt-btn.selected  { border-color: var(--teal-shadow); color: var(--accent-text); background: var(--accent-light); }
    .opt-btn.correct   { background: var(--green)  !important; color: var(--white) !important; border-color: var(--green-shadow) !important; }
    .opt-btn.incorrect { background: var(--punch)  !important; color: var(--white) !important; border-color: var(--punch-shadow) !important; }

    /* word bank / gap fill */
    .word-bank { background: var(--bg); border: 2px solid var(--border); border-radius: var(--rsm); padding: 14px; margin-bottom: 14px; }
    .wb-label  { font-size: 11px; font-weight: 900; color: var(--ink-3); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 10px; }
    .wb-words  { display: flex; flex-wrap: wrap; gap: 8px; }
    .wb-word {
        background: var(--white); color: var(--accent-text);
        padding: 8px 14px; border-radius: var(--rsm);
        border: 2px solid var(--accent-border); border-bottom: 4px solid var(--teal-shadow);
        font-weight: 900; font-size: 13px; font-family: inherit;
        transition: transform .1s, border-bottom-width .1s; touch-action: manipulation;
    }
    .wb-word:active { border-bottom-width: 2px; transform: translateY(2px); }
    .wb-word.sel    { background: var(--teal); color: var(--ink-bold); }
    .wb-word.used   { opacity: .22; pointer-events: none; }

    .gap-sents { font-size: 15px; font-weight: 700; line-height: 3.6; color: var(--ink); }
    .gap {
        display: inline-block; text-align: center; min-width: 140px;
        background: var(--white); border: 2px dashed var(--teal-shadow);
        border-radius: var(--rsm); padding: 4px 10px; margin: 0 3px;
        font-weight: 900; color: var(--accent-text); font-size: 13px;
        cursor: pointer; min-height: 34px; transition: background .15s;
    }
    .gap.correct   { background: var(--green)  !important; border-color: var(--green-shadow) !important; border-style: solid; color: var(--white); pointer-events: none; }
    .gap.incorrect { background: var(--punch)  !important; border-color: var(--punch-shadow) !important; border-style: solid; color: var(--white); }

    /* word forms */
    .wf-item   { margin-bottom: 16px; }
    .wf-prompt { font-weight: 800; color: var(--ink-bold); margin-bottom: 7px; font-size: 14px; font-style: italic; line-height: 1.4; }
    .wf-input {
        width: 100%; padding: 13px 15px; min-height: 50px;
        background: var(--white); border: 2px solid var(--border-heavy); border-bottom: 4px solid var(--border-heavy);
        border-radius: var(--rsm); font-size: 15px; font-weight: 800; color: var(--ink-bold);
        font-family: inherit; transition: border-color .2s;
    }
    .wf-input:focus { outline: none; border-color: var(--teal-shadow); }
    .wf-input::placeholder { color: var(--ink-3); font-weight: 700; }
    .wf-input.ok  { border-color: var(--green-shadow) !important; background: rgba(88,204,2,.06); color: var(--green-shadow); }
    .wf-input.bad { border-color: var(--punch-shadow) !important; background: rgba(255,75,75,.06); color: var(--punch-shadow); }

    /* grammar select */
    .gram-expl {
        background: var(--bg); border: 2px solid var(--border);
        border-left: 5px solid var(--teal);
        border-radius: 0 var(--rsm) var(--rsm) 0; padding: 16px; margin-bottom: 16px;
    }
    .gram-expl h4 { font-size: 11px; font-weight: 900; color: var(--accent-text); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 8px; }
    .gram-expl p  { font-size: 14px; font-weight: 700; color: var(--ink); margin-bottom: 8px; line-height: 1.5; }
    .gram-ex { padding: 8px 12px; margin: 5px 0; background: var(--accent-light); border-left: 3px solid var(--teal); border-radius: 0 8px 8px 0; font-size: 13px; font-weight: 700; line-height: 1.5; }
    .gram-ex strong { color: var(--accent-text); font-weight: 900; }
    .gram-card { background: var(--bg); border: 2px solid var(--border); border-radius: var(--rsm); padding: 15px; margin-bottom: 10px; }
    @media(min-width:640px){ .gram-card { display: flex; align-items: center; gap: 16px; } }
    .gc-body { margin-bottom: 10px; flex: 1; }
    @media(min-width:640px){ .gc-body { margin-bottom: 0; } }
    .gc-sent { font-weight: 800; color: var(--ink-bold); font-size: 15px; margin-bottom: 4px; line-height: 1.4; }
    .gc-hint { font-size: 12px; font-weight: 700; color: var(--ink-3); font-style: italic; }
    .gram-sel {
        width: 100%; padding: 12px 14px; min-height: 48px;
        background: var(--white); border: 2px solid var(--border-heavy); border-bottom: 4px solid var(--border-heavy);
        border-radius: var(--rsm); font-size: 14px; font-weight: 800;
        color: var(--ink); font-family: inherit; transition: border-color .15s;
    }
    @media(min-width:640px){ .gram-sel { width: auto; min-width: 240px; } }
    .gram-sel.correct   { background: var(--green); color: var(--white); border-color: var(--green-shadow); }
    .gram-sel.incorrect { background: var(--punch); color: var(--white); border-color: var(--punch-shadow); }

    /* buttons */
    .btn-row { margin-top: 18px; display: flex; flex-direction: column; gap: 10px; }
    @media(min-width:640px){ .btn-row { flex-direction: row; justify-content: center; } }
    .btn-check, .btn-reveal, .btn-reset {
        padding: 13px 24px; min-height: 50px; font-size: 15px; font-weight: 900;
        font-family: inherit; border-radius: var(--rsm); border: 2px solid; border-bottom-width: 5px;
        transition: transform .1s, border-bottom-width .1s; touch-action: manipulation;
    }
    .btn-check:active, .btn-reveal:active, .btn-reset:active { border-bottom-width: 2px; transform: translateY(3px); }
    .btn-check  { background: var(--teal); color: var(--ink-bold); border-color: var(--teal-shadow); }
    .btn-reveal { background: var(--accent-light); color: var(--accent-text); border-color: var(--teal); }
    .btn-reset  { background: var(--bg); color: var(--ink-3); border-color: var(--border-heavy); }

    .result { margin-top: 12px; padding: 13px 16px; border-radius: var(--rsm); font-weight: 800; font-size: 15px; border: 2px solid; display: none; }
    .result.ok  { background: rgba(88,204,2,.09);  color: var(--green-shadow); border-color: var(--green-shadow); }
    .result.bad { background: rgba(255,75,75,.09); color: var(--punch-shadow); border-color: var(--punch-shadow); }

    .hint-btn  { display: inline-flex; align-items: center; gap: 4px; font-size: 12px; font-weight: 900; color: var(--ink-3); background: none; border: none; padding: 4px 0; cursor: pointer; }
    .hint-text { font-size: 12px; font-weight: 700; color: var(--accent-text); background: var(--accent-light); border: 1px solid var(--accent-border); border-radius: 8px; padding: 6px 10px; margin-top: 6px; display: none; line-height: 1.4; }
    .hint-text.show { display: block; }

    /* vocab glossary */
    .voc-grid { display: grid; grid-template-columns: 1fr; gap: 8px; }
    @media(min-width:600px){ .voc-grid { grid-template-columns: 1fr 1fr; } }
    .voc-item {
        background: var(--bg); border: 2px solid var(--border); border-radius: var(--rsm);
        padding: 12px 14px; display: flex; flex-direction: column; gap: 3px;
        cursor: pointer; transition: border-color .15s;
    }
    .voc-item:hover { border-color: var(--teal-shadow); }
    .voc-item-word { font-size: 15px; font-weight: 900; color: var(--accent-text); letter-spacing: -.2px; }
    .voc-item-type { font-size: 10px; font-weight: 900; color: var(--ink-3); text-transform: uppercase; letter-spacing: 1px; }
    .voc-item-def  { font-size: 13px; font-weight: 700; color: var(--ink); line-height: 1.45; margin-top: 2px; }

    /* bottom nav */
    .bot-nav {
        position: fixed; bottom: 0; left: 0; right: 0;
        background: var(--white); border-top: 2px solid var(--border);
        padding: 10px 16px; padding-bottom: calc(10px + env(safe-area-inset-bottom));
        display: flex; align-items: center; gap: 10px; z-index: 200;
    }
    @media(min-width:768px){ .bot-nav { display: none; } }
    .bn-btn {
        flex: 1; background: var(--bg); color: var(--ink-bold);
        border: 2px solid var(--border-heavy); border-bottom: 4px solid var(--border-heavy);
        padding: 12px; border-radius: var(--rsm); font-weight: 900; font-size: 15px;
        min-height: 50px; font-family: inherit; transition: transform .1s, border-bottom-width .1s;
    }
    .bn-btn:active { border-bottom-width: 2px; transform: translateY(2px); }
    .bn-btn.primary { flex: 2; background: var(--teal); color: var(--ink-bold); border-color: var(--teal-shadow); }
    .bn-btn:disabled { opacity: .35; cursor: not-allowed; }
    .bn-ind { font-size: 12px; font-weight: 900; color: var(--ink-3); white-space: nowrap; text-align: center; min-width: 40px; }

    /* vocab popup */
    #voc-popup {
        position: fixed; bottom: 76px; left: 12px; right: 12px;
        background: var(--white); border: 2px solid var(--border-heavy);
        border-bottom: 6px solid var(--border-heavy); border-top: 4px solid var(--teal-shadow);
        padding: 18px 18px 20px; border-radius: var(--r) var(--r) var(--rsm) var(--rsm);
        z-index: 500; display: none; box-shadow: 0 -8px 32px rgba(0,0,0,.12);
        animation: up .22s ease both; max-height: 46vh; overflow-y: auto;
    }
    @media(min-width:768px){ #voc-popup { position: fixed; bottom: 24px; right: 24px; left: auto; max-width: 310px; border-radius: var(--r); } }
    .vp-close { position: absolute; top: 10px; right: 10px; width: 32px; height: 32px; border-radius: var(--rxs); background: var(--bg); border: 2px solid var(--border-heavy); font-size: 18px; font-weight: 900; color: var(--ink-3); display: flex; align-items: center; justify-content: center; cursor: pointer; }
    .voc-word { font-size: 22px; font-weight: 900; color: var(--accent-text); letter-spacing: -.4px; margin-bottom: 2px; }
    .voc-type { font-size: 11px; font-weight: 900; color: var(--ink-3); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
    .voc-def  { font-size: 14px; font-weight: 700; color: var(--ink); line-height: 1.65; margin-bottom: 14px; }
    .voc-hear {
        width: 100%; padding: 13px; background: var(--teal); color: var(--ink-bold);
        border: 2px solid var(--teal-shadow); border-bottom: 5px solid var(--teal-shadow);
        border-radius: var(--rsm); font-size: 15px; font-weight: 900; font-family: inherit;
        transition: transform .1s, border-bottom-width .1s;
    }
    .voc-hear:active { border-bottom-width: 2px; transform: translateY(3px); }

    /* badges */
    .badge-wrap { position: fixed; top: 70px; right: 12px; display: flex; flex-direction: column; gap: 8px; z-index: 999; }
    .badge { background: var(--white); border: 2px solid var(--border-heavy); border-bottom: 4px solid var(--border-heavy); border-left: 4px solid var(--teal); padding: 10px 14px; border-radius: var(--rsm); display: flex; align-items: center; gap: 8px; transform: translateX(240px); opacity: 0; transition: transform .4s, opacity .4s; box-shadow: 0 4px 14px rgba(0,0,0,.1); }
    .badge.show { transform: translateX(0); opacity: 1; }
    .badge-icon { font-size: 22px; }
    .badge-text { font-size: 13px; font-weight: 900; color: var(--ink-bold); }
    .confetti-dot { position: fixed; width: 10px; height: 10px; border-radius: 3px; pointer-events: none; z-index: 9999; animation: confetti .9s ease-out both; }

    @media(max-width:768px){ .wf-input:focus, .gram-sel:focus { font-size: 16px; } }
    </style>
</head>
<body>

<header class="header">
    <div class="hc">
        <div class="hl">
            <a href="/legal/" class="logo">‚öñÔ∏è</a>
            <a href="/" class="site-title">English For Cool Dudes</a>
        </div>
        <div class="hdr-stats">
            <div class="hdr-pill">üî• <span id="hdr-streak">0</span></div>
            <div class="hdr-pill">‚ö° <span id="hdr-xp">0</span> XP</div>
        </div>
    </div>
</header>

<div class="badge-wrap" id="badge-wrap"></div>

<!-- Verdict sheet overlay -->
<div class="verdict-overlay" id="verdict-overlay" onclick="handleOverlayClick(event)">
    <div class="verdict-sheet" id="vs-sheet">
        <div id="vs-content"></div>
    </div>
</div>

<div id="voc-popup">
    <button class="vp-close" onclick="closeVoc()">√ó</button>
    <div id="vp-body"></div>
</div>

<div class="page">
    <div class="lesson-banner u1">
        <div class="lesson-eyebrow">‚öñÔ∏è Legal English ¬∑ Upper-Intermediate</div>
        <div class="lesson-title">The Redline Room</div>
        <div class="lesson-sub">Contract clauses, negotiation language &amp; the art of saying no in silk gloves</div>
        <div class="prog-wrap">
            <div class="prog-row">
                <span id="prog-label">0 / 7 sections</span>
                <span id="prog-pct">0%</span>
            </div>
            <div class="prog-track"><div class="prog-fill" id="prog-fill"></div></div>
        </div>
    </div>

    <div id="daily-challenge-widget"></div>
    <div id="sections"></div>
</div>

<nav class="bot-nav">
    <button class="bn-btn" id="bn-prev" onclick="prevSec()" disabled>‚Üê Back</button>
    <span class="bn-ind" id="bn-ind">1/7</span>
    <button class="bn-btn primary" id="bn-next" onclick="nextSec()">Next ‚Üí</button>
</nav>

<script src="/supabase-auth-gamified.js"></script>
<script src="/daily-challenges-system.js"></script>
<script src="/word-match-game.js"></script>

<script>
'use strict';

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LESSON DATA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const L = {
    title:      "The Redline Room",
    lessonId:   "redlineroom",
    lessonLink: "/redlineroom/",
    levelPage:  "/legal/",
    level:      "Legal English",

    vocabulary: [
        { word: "Indemnification",   type: "noun",
          definition: "A contractual obligation by one party to compensate the other for specific losses, damages, or liabilities arising from the agreement or related events." },
        { word: "Limitation of Liability", type: "clause",
          definition: "A contract provision that caps the maximum amount one party can claim from the other in the event of a breach ‚Äî often linked to the contract value or annual fees." },
        { word: "Boilerplate",       type: "noun",
          definition: "Standard, non-negotiated contract language that appears in most commercial agreements ‚Äî governing law, entire agreement, notices. Often glossed over, but genuinely important." },
        { word: "Warranty",          type: "noun",
          definition: "A binding contractual promise that a specific statement is true. Breaching a warranty gives the injured party the right to claim damages." },
        { word: "Representation",    type: "noun",
          definition: "A statement of fact made by one party to induce the other to enter the contract. Misrepresentation can give rise to rescission or damages." },
        { word: "Force Majeure",     type: "clause",
          definition: "A clause excusing a party from performance if extraordinary events beyond their control ‚Äî wars, pandemics, natural disasters ‚Äî make performance impossible or impractical." },
        { word: "Material Breach",   type: "noun",
          definition: "A serious failure to perform a contractual obligation that gives the innocent party the right to treat the contract as terminated and claim damages." },
        { word: "Without Prejudice", type: "phrase",
          definition: "A legal designation protecting settlement negotiations from being used as evidence in court. Allows parties to explore compromise freely." },
        { word: "Counterpart",       type: "noun",
          definition: "Each copy of a contract signed by one party. Together, all counterparts form a single binding agreement ‚Äî relevant when parties sign in different locations." },
        { word: "Entire Agreement",  type: "clause",
          definition: "A boilerplate clause confirming that the written contract represents the complete agreement between the parties, superseding all prior negotiations and representations." }
    ],

    /* REDLINE MECHANIC ‚Äî 5 clauses from a fictional SaaS agreement */
    redlineClauses: [
        {
            id: 'liability-cap',
            ref: 'Clause 8.2',
            text: `The aggregate liability of the Supplier under or in connection with this Agreement, whether arising in contract, tort (including negligence) or otherwise, shall not exceed the total fees paid by the Client in the twelve (12) months immediately preceding the event giving rise to the claim.`,
            correctStamp: 'accept',
            question: 'How should your client respond to this limitation of liability clause?',
            verdict: {
                accept: { correct: true,  banner: '‚úÖ Correct ‚Äî standard and fair',   explain: `A liability cap linked to 12 months' fees is the market standard for commercial SaaS agreements. The <span data-voc="Limitation of Liability" class="ev-voc">limitation of liability</span> protects the supplier from catastrophic exposure while giving the client a meaningful remedy. Worth accepting unless your client has unusually high dependency on this software.` },
                flag:   { correct: false, banner: '‚ö†Ô∏è Close ‚Äî but this is actually clean', explain: `This clause is market standard. A <span data-voc="Limitation of Liability" class="ev-voc">limitation of liability</span> capped at 12 months' fees is what most experienced clients expect and accept. Only flag if your client's losses could foreseeably exceed that cap substantially.` },
                reject: { correct: false, banner: '‚ùå Too aggressive ‚Äî this is standard', explain: `Rejecting a standard 12-month fee cap would stall most negotiations. The <span data-voc="Limitation of Liability" class="ev-voc">limitation of liability</span> here is proportionate and reasonable. Save your rejections for genuinely one-sided clauses.` }
            }
        },
        {
            id: 'indemnity-broad',
            ref: 'Clause 9.1',
            text: `The Client shall indemnify, defend and hold harmless the Supplier and its officers, directors, employees and agents from and against any and all claims, damages, losses, costs and expenses (including reasonable legal fees) arising out of or relating to the Client's use of the Services or any breach of this Agreement by the Client or its representatives.`,
            correctStamp: 'flag',
            question: 'Your client is the buyer (Client). What is your position on this indemnity clause?',
            verdict: {
                accept: { correct: false, banner: '‚ùå This needs work ‚Äî don\'t let it through', explain: `"Any and all claims‚Ä¶ arising out of or relating to" is extremely broad <span data-voc="Indemnification" class="ev-voc">indemnification</span> language. It could expose your client to liability for matters only loosely connected to the contract. You should flag this and negotiate mutual indemnification or at least a tighter causal link.` },
                flag:   { correct: true,  banner: '‚ö†Ô∏è Flagged ‚Äî exactly right', explain: `Smart move. The <span data-voc="Indemnification" class="ev-voc">indemnification</span> here is one-sided and uses dangerously broad language ‚Äî "any and all‚Ä¶ arising out of or relating to." You should negotiate: (1) mutual indemnification, (2) narrower causation ("directly caused by"), and (3) a cap aligned with the liability limit in Clause 8.2.` },
                reject: { correct: false, banner: '‚ö†Ô∏è You\'re right to be concerned, but flag don\'t reject', explain: `The instinct is correct ‚Äî this <span data-voc="Indemnification" class="ev-voc">indemnification</span> clause is one-sided and broadly drafted. But outright rejection would stall the deal. The professional move is to flag and negotiate ‚Äî seek mutual indemnity and tighter causation language.` }
            }
        },
        {
            id: 'force-majeure',
            ref: 'Clause 12.1',
            text: `Neither party shall be liable for any delay or failure to perform its obligations under this Agreement to the extent that such delay or failure results from circumstances beyond that party's reasonable control, including but not limited to acts of God, war, terrorism, pandemic, government action, or failure of third-party infrastructure. The affected party shall notify the other party promptly and use reasonable endeavours to resume performance.`,
            correctStamp: 'accept',
            question: 'Your client is concerned about this force majeure clause. What is your advice?',
            verdict: {
                accept: { correct: true,  banner: '‚úÖ Accept ‚Äî this is balanced and mutual', explain: `This <span data-voc="Force Majeure" class="ev-voc">force majeure</span> clause is mutual (neither party), includes a notification obligation, and requires reasonable endeavours to resume. Including "pandemic" post-COVID is entirely normal. This is good boilerplate ‚Äî advise your client to accept it.` },
                flag:   { correct: false, banner: '‚úÖ Actually, this is fine as drafted', explain: `This is a well-drafted, mutual <span data-voc="Force Majeure" class="ev-voc">force majeure</span> clause. Both parties are covered, notification is required, and there's a duty to resume performance. Unless your client has a specific concern about a particular risk, this doesn't need negotiation.` },
                reject: { correct: false, banner: '‚ùå Don\'t reject ‚Äî this protects your client too', explain: `Rejecting the <span data-voc="Force Majeure" class="ev-voc">force majeure</span> clause would actually harm your client. If a pandemic, war, or infrastructure failure prevents your client from performing, this clause protects them. It's mutual and balanced ‚Äî rejection would leave your client exposed.` }
            }
        },
        {
            id: 'entire-agreement',
            ref: 'Clause 18.3',
            text: `This Agreement constitutes the entire agreement between the parties with respect to its subject matter and supersedes all prior negotiations, representations, warranties, understandings and agreements, whether written or oral, relating to such subject matter.`,
            correctStamp: 'flag',
            question: 'During negotiations, the Supplier made several verbal promises about future product features. Does this clause affect those promises?',
            verdict: {
                accept: { correct: false, banner: '‚ùå Be very careful here', explain: `This <span data-voc="Entire Agreement" class="ev-voc">entire agreement</span> clause expressly overrides all prior representations and promises. If the Supplier made verbal commitments during negotiations about product features, signing without qualification could extinguish your client's ability to rely on them. Flag this and consider adding a schedule capturing those commitments.` },
                flag:   { correct: true,  banner: '‚ö†Ô∏è Flagged ‚Äî exactly right', explain: `Excellent. The <span data-voc="Entire Agreement" class="ev-voc">entire agreement</span> clause wipes out all prior <span data-voc="Representation" class="ev-voc">representations</span> ‚Äî including those verbal feature promises. The commercial solution: either (1) attach a Schedule listing specific commitments that survive, or (2) add a <span data-voc="Warranty" class="ev-voc">warranty</span> clause requiring the Supplier to warrant those specific promises.` },
                reject: { correct: false, banner: '‚ö†Ô∏è Right concern, wrong tool', explain: `You're right that this <span data-voc="Entire Agreement" class="ev-voc">entire agreement</span> clause is problematic given the verbal promises. But outright rejection is unusual ‚Äî entire agreement clauses are standard <span data-voc="Boilerplate" class="ev-voc">boilerplate</span>. The solution is to flag it and add a schedule or warranty clause capturing the specific commitments you need to preserve.` }
            }
        },
        {
            id: 'material-breach',
            ref: 'Clause 14.2',
            text: `Either party may terminate this Agreement immediately upon written notice if the other party commits a material breach of this Agreement and (where such breach is capable of remedy) fails to remedy the breach within thirty (30) days of receipt of written notice specifying the breach.`,
            correctStamp: 'accept',
            question: 'Is this material breach and termination clause acceptable for your client?',
            verdict: {
                accept: { correct: true,  banner: '‚úÖ Accept ‚Äî this is fair and mutual', explain: `This is a well-constructed <span data-voc="Material Breach" class="ev-voc">material breach</span> clause. It's mutual, provides a 30-day cure period for remediable breaches, and requires written notice specifying the breach ‚Äî giving both sides clarity and a fair opportunity to fix problems before termination. Standard and acceptable.` },
                flag:   { correct: false, banner: '‚úÖ This clause is actually balanced', explain: `The <span data-voc="Material Breach" class="ev-voc">material breach</span> provision here is fair. It's mutual, includes a 30-day cure window where the breach is capable of remedy, and requires a written notice specifying the issue. There's nothing unusual here ‚Äî no need to negotiate.` },
                reject: { correct: false, banner: '‚ùå Rejecting this would harm your client', explain: `This <span data-voc="Material Breach" class="ev-voc">material breach</span> clause actually benefits your client as much as the Supplier. The 30-day cure period means if your client makes a mistake, they get a chance to fix it before the contract is terminated. Rejecting it removes that protection.` }
            }
        }
    ],

    briefing: [
        {
            heat: 1, label: 'üìÑ  The Contract Review Framework',
            rows: [
                { key: 'Your three tools', val: 'Accept ¬∑ Flag ¬∑ Reject',                              style: '' },
                { key: 'Accept',           val: 'Standard clause ‚Äî commercial, balanced, fine as-is',  style: 'cool' },
                { key: 'Flag',             val: 'Needs negotiation ‚Äî one-sided, ambiguous or risky',   style: 'warm' },
                { key: 'Reject',           val: 'Non-starter ‚Äî unacceptable, dangerous, or abusive',   style: 'hot'  },
                { key: 'Golden rule',      val: 'Save rejections for battles worth fighting',           style: '' }
            ]
        },
        {
            heat: 2, label: '‚ö†Ô∏è  The Clauses That Kill Deals',
            rows: [
                { key: 'Unlimited liability',  val: 'No cap = catastrophic exposure risk',                 style: 'hot'  },
                { key: 'One-sided indemnity',  val: 'You bear all risk ‚Äî they bear none',                  style: 'hot'  },
                { key: 'Entire agreement',     val: 'Wipes out all prior verbal promises',                  style: 'warm' },
                { key: 'Broad IP assignment',  val: '"All work product" can include pre-existing IP',       style: 'warm' },
                { key: 'Auto-renewal traps',   val: 'Termination window missed = another year locked in',  style: 'warm' }
            ]
        },
        {
            heat: 3, label: 'üó£Ô∏è  Negotiation Language',
            rows: [
                { key: 'Opening position',    val: '"We\'d like to propose a mutual arrangement‚Ä¶"',        style: '' },
                { key: 'Flagging concern',    val: '"We have some reservations about Clause 9‚Ä¶"',          style: '' },
                { key: 'Counter-proposal',    val: '"Would you be open to capping this at‚Ä¶?"',             style: '' },
                { key: 'Protecting the deal', val: '"We can work with this if you\'re able to‚Ä¶"',          style: '' }
            ],
            alert: `The phrase <strong>"without prejudice"</strong> before a settlement proposal means it cannot be used against you in court. Use it when exploring compromise ‚Äî it creates a safe space to negotiate freely.`
        }
    ],

    exercises: [
        {
            type: 'trueFalse', col: 'green',
            icon: '‚úÖ', title: 'True or False?',
            sub: 'Tap True or False for each statement',
            questions: [
                { q: 'A limitation of liability clause always benefits the supplier, never the client.',                                   a: false },
                { q: 'An "entire agreement" clause can override verbal promises made during negotiations.',                                 a: true  },
                { q: 'A force majeure clause typically covers events within a party\'s reasonable control.',                               a: false },
                { q: 'A material breach gives the innocent party the right to terminate the contract and claim damages.',                  a: true  },
                { q: '"Without prejudice" communications can generally be used as evidence in subsequent court proceedings.',              a: false }
            ]
        },
        {
            type: 'multipleChoice', col: 'blue',
            icon: 'üéØ', title: 'Comprehension Check',
            sub: 'Choose the best answer for each question',
            questions: [
                { q: 'Your client received a contract with an indemnification clause covering "any and all losses arising out of or relating to" the agreement. What is the main risk?',
                  opts: [
                      'The clause is invalid because indemnification must be mutual',
                      'The broad language could expose your client to liability for events only loosely connected to the contract',
                      'The clause creates a limitation of liability cap that is too low'
                  ], correct: 1 },
                { q: 'During negotiations, the other side promised certain product features verbally. The final contract contains an entire agreement clause. What should you do?',
                  opts: [
                      'Sign the contract ‚Äî verbal promises are binding regardless of entire agreement clauses',
                      'Reject the entire agreement clause outright',
                      'Flag the clause and negotiate to add a schedule or warranty capturing those specific promises'
                  ], correct: 2 },
                { q: 'A client asks whether they should accept a 30-day cure period in a material breach clause. What is your advice?',
                  opts: [
                      'Reject it ‚Äî cure periods weaken the right to terminate',
                      'Accept it ‚Äî a cure period protects both sides and is commercially standard',
                      'Flag it ‚Äî 30 days is too long for a material breach'
                  ], correct: 1 }
            ]
        },
        {
            type: 'gapFill', col: 'purple',
            icon: 'üß©', title: 'Fill the Gaps',
            sub: 'Select a word from the bank, then tap a blank to fill it',
            wordBank: ['boilerplate', 'without prejudice', 'warranty', 'counterpart', 'force majeure', 'material breach'],
            sentences: [
                { t: 'The supplier failed to deliver the software for six months ‚Äî this constitutes a ___ of the agreement.', a: 'material breach' },
                { t: 'Governing law, notices and entire agreement are standard ___ provisions found in most commercial contracts.', a: 'boilerplate' },
                { t: 'The client wrote a ___ letter proposing a financial settlement to avoid litigation.', a: 'without prejudice' },
                { t: 'The pandemic was cited as a ___ event excusing the delayed performance.', a: 'force majeure' },
                { t: 'The supplier gave a ___ that the software would be fit for its stated commercial purpose.', a: 'warranty' },
                { t: 'Each party signed a separate ___ of the agreement, both forming one binding contract.', a: 'counterpart' }
            ]
        },
        {
            type: 'wordForms', col: 'punch',
            icon: 'üî§', title: 'Word Forms',
            sub: 'Complete each sentence with the correct word form',
            questions: [
                { p: `The contract contained a broad ___ clause requiring the client to cover all losses. (indemnify ‚Üí noun)`,                              a: 'indemnification' },
                { p: `The supplier's failure to deliver was ___ ‚Äî it justified termination. (materially ‚Üí adjective of "material")`,                       a: 'material' },
                { p: `The parties agreed to ___ the dispute through mediation. (resolution ‚Üí verb)`,                                                        a: 'resolve' },
                { p: `The force majeure clause ___ the supplier from liability for the pandemic delay. (excuse ‚Üí past tense)`,                             a: 'excused' }
            ]
        },
        {
            type: 'grammar', col: 'teal',
            icon: 'üìñ', title: 'Modal Verbs in Contract Language',
            sub: 'Choose the correct modal for each contract sentence',
            explanation: {
                heading: 'Modals in Legal Drafting',
                text: 'Modal verbs carry precise legal weight in contracts. Getting them wrong changes meaning ‚Äî and obligations.',
                examples: [
                    { label: 'shall ‚Äî creates a binding obligation:',  text: `The Supplier <strong>shall</strong> deliver the software by 1 March.` },
                    { label: 'may ‚Äî grants a discretionary right:',    text: `Either party <strong>may</strong> terminate on 30 days\' written notice.` },
                    { label: 'must ‚Äî obligation (common in US law):',  text: `All notices <strong>must</strong> be delivered in writing.` },
                    { label: 'should ‚Äî recommendation, not binding:',  text: `Disputes <strong>should</strong> be escalated to senior management first.` }
                ]
            },
            questions: [
                { s: 'The Client ___ pay all invoices within 30 days of the invoice date.',
                  hint: 'Binding payment obligation ‚Üí shall',
                  opts: ['shall', 'may', 'should'], a: 'shall' },
                { s: 'Either party ___ request an extension of the performance deadline by written notice.',
                  hint: 'Discretionary right to request ‚Üí may',
                  opts: ['shall', 'may', 'must'], a: 'may' },
                { s: 'The Supplier ___ not assign this Agreement without the prior written consent of the Client.',
                  hint: 'Prohibition on assignment ‚Üí shall not',
                  opts: ['shall', 'may', 'should'], a: 'shall' },
                { s: 'Disputes ___ be referred to senior management before formal legal proceedings are commenced.',
                  hint: 'Recommended first step, not absolute obligation ‚Üí should',
                  opts: ['shall', 'should', 'may'], a: 'should' }
            ]
        }
    ],

    badges: [
        { icon: 'üìÑ', text: 'Contract Hawk!'   },
        { icon: 'üñäÔ∏è', text: 'Redliner!'        },
        { icon: '‚öñÔ∏è', text: 'Risk Spotter!'    },
        { icon: 'ü§ù', text: 'Deal Maker!'      },
        { icon: 'üîç', text: 'Clause Hunter!'   },
        { icon: 'üíº', text: 'Commercial Pro!'  },
        { icon: 'üèÜ', text: 'Silk Gloves!'     }
    ],

    grammar: [
        { question: 'Modal verbs in contract language', answer: 'shall / may / must / should',
          explanation: 'Shall creates binding obligations; may grants discretionary rights; must is obligatory (US); should is recommendatory only' }
    ]
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STATE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let curSec   = 0;
let doneSecs = 0;
let selWord  = null;
let clauseVoted = {};
const TOTAL  = 2 + L.exercises.length;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BUILD
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function build() {
    const wrap = document.getElementById('sections');
    let html = '';
    html += secCard(0, true,  'strip-teal',   buildRedlines());
    html += secCard(1, false, 'strip-blue',   buildBriefing());
    html += `<div class="sec-label">üìù Practice Exercises</div>`;
    L.exercises.forEach((ex, i) => {
        const n    = i + 2;
        const body = buildExercise(ex, n);
        html += secCard(n, false, `strip-${ex.col}`,
            head(ex.icon, ex.title, ex.sub, n) +
            `<div class="sec-body">${body}</div>`);
    });
    html += `<div class="sec-label">üìñ Vocabulary Glossary</div>`;
    html += buildGlossary();
    wrap.innerHTML = html;
    updateNav(); updateProg();
    setTimeout(wireAll, 60);
}

function secCard(n, visible, strip, inner) {
    return `<div class="sec-card${visible ? ' visible' : ''} ${strip}" data-sec="${n}">${inner}</div>`;
}
function head(icon, title, sub, n, extra = '') {
    return `<div class="sec-head">
        <div class="sec-head-left">
            <div class="sec-head-icon">${icon}</div>
            <div><div class="sec-head-title">${title}</div><div class="sec-head-sub">${sub}</div></div>
        </div>${extra}
    </div>`;
}

/* ‚îÄ‚îÄ REDLINE MECHANIC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function buildRedlines() {
    const chips = L.redlineClauses.map(c =>
        `<div class="rc-chip" id="chip-${c.id}">üìÑ</div>`).join('');

    const clauses = L.redlineClauses.map(c => `
        <button class="clause" id="clause-${c.id}" onclick="openVerdict('${c.id}')">
            <div class="clause-num">${c.ref}</div>
            <span class="clause-text">${c.text}</span>
            <span class="clause-stamp" id="stamp-${c.id}"></span>
        </button>`).join('');

    return head('üìÑ', 'The Redline Room', 'Read each clause ‚Äî stamp it Accept, Flag, or Reject', 0) +
        `<div class="sec-body">
            <div class="redline-counter">
                <span class="rc-label" id="rc-label">Tap a clause to review</span>
                <div class="rc-chips">${chips}</div>
            </div>
            <div class="contract-doc">
                <div class="contract-header">
                    <span class="contract-title">Software Services Agreement</span>
                    <span class="contract-ref">Ref: SSA-2025-0047</span>
                </div>
                <div class="contract-body">${clauses}</div>
            </div>
            <div id="redline-done-wrap"></div>
        </div>`;
}

function openVerdict(id) {
    const c = L.redlineClauses.find(x => x.id === id);
    if (!c) return;
    const already = clauseVoted[id];

    let stampBtnsHTML;
    if (already) {
        // Already voted ‚Äî show what they chose
        stampBtnsHTML = ['accept','flag','reject'].map(s => {
            let cls = 'stamp-btn ' + s;
            if (s === already) {
                cls += s === c.correctStamp ? ' chosen-correct' : ' chosen-incorrect';
            } else {
                cls += ' chosen-dim';
            }
            const icons = { accept: '‚úÖ', flag: '‚ö†Ô∏è', reject: '‚ùå' };
            const labels = { accept: 'Accept', flag: 'Flag', reject: 'Reject' };
            return `<button class="${cls}" disabled><span class="sb-icon">${icons[s]}</span>${labels[s]}</button>`;
        }).join('');
    } else {
        stampBtnsHTML = `
            <button class="stamp-btn accept" onclick="castVerdict('${id}','accept')"><span class="sb-icon">‚úÖ</span>Accept</button>
            <button class="stamp-btn flag"   onclick="castVerdict('${id}','flag')"><span class="sb-icon">‚ö†Ô∏è</span>Flag It</button>
            <button class="stamp-btn reject" onclick="castVerdict('${id}','reject')"><span class="sb-icon">‚ùå</span>Reject</button>`;
    }

    const verdictHTML = already ? buildVerdictHTML(id, already) : '';

    document.getElementById('vs-content').innerHTML = `
        <div class="vs-handle"></div>
        <div class="vs-head">
            <div class="vs-title">‚öñÔ∏è ${c.ref}</div>
            <button class="vs-close" onclick="closeVerdict()">√ó</button>
        </div>
        <div class="vs-body">
            <div class="q-box" style="margin-bottom:14px;">
                <div class="q-text" style="font-style:italic;font-size:13px;color:var(--ink-3);">${c.text}</div>
            </div>
            <p style="font-size:15px;font-weight:900;color:var(--ink-bold);margin-bottom:14px;text-align:center;">${c.question}</p>
            <div class="stamp-row">${stampBtnsHTML}</div>
            <div id="vs-verd-wrap">${verdictHTML}</div>
        </div>`;

    document.getElementById('verdict-overlay').classList.add('open');
    document.body.style.overflow = 'hidden';
}

function castVerdict(id, stamp) {
    const c = L.redlineClauses.find(x => x.id === id);
    if (!c || clauseVoted[id]) return;
    clauseVoted[id] = stamp;

    // Stamp the buttons
    const btns = document.querySelectorAll('.stamp-btn');
    btns.forEach(b => {
        b.disabled = true;
        b.classList.add('chosen-dim');
    });
    const stampMap = { accept: 0, flag: 1, reject: 2 };
    const chosenBtn = btns[stampMap[stamp]];
    chosenBtn.classList.remove('chosen-dim');
    chosenBtn.classList.add(stamp === c.correctStamp ? 'chosen-correct' : 'chosen-incorrect');

    // Show verdict
    document.getElementById('vs-verd-wrap').innerHTML = buildVerdictHTML(id, stamp);

    // Update clause card
    const el = document.getElementById(`clause-${id}`);
    if (el) {
        el.classList.remove('active');
        el.classList.add(`stamped-${stamp}`);
        const stampEl = document.getElementById(`stamp-${id}`);
        if (stampEl) {
            const stampLabels = { accept: '‚úÖ Accepted', flag: '‚ö†Ô∏è Flagged', reject: '‚ùå Rejected' };
            stampEl.textContent = stampLabels[stamp];
        }
    }

    // Update chip
    const chip = document.getElementById(`chip-${id}`);
    if (chip) chip.classList.add(`done-${stamp}`);

    // Update counter label
    const done = Object.keys(clauseVoted).length;
    const lbl = document.getElementById('rc-label');
    if (lbl) lbl.textContent = `${done} / ${L.redlineClauses.length} clauses reviewed`;
}

function buildVerdictHTML(id, stamp) {
    const c = L.redlineClauses.find(x => x.id === id);
    const v = c.verdict[stamp];
    const correct = stamp === c.correctStamp;
    const idx = L.redlineClauses.findIndex(x => x.id === id);
    const next = L.redlineClauses[idx + 1];
    const nextBtn = next
        ? `<button class="vs-next" onclick="closeVerdict();setTimeout(()=>openVerdict('${next.id}'),200)">Next: ${next.ref} ‚Üí</button>`
        : `<button class="vs-next" onclick="closeVerdict();checkRedlineDone()">See Your Review Summary üìã</button>`;
    return `<div class="vs-verdict">
        <div class="vs-verd-banner ${correct ? 'correct' : 'incorrect'}">${v.banner}</div>
        <div class="vs-verd-explain">${v.explain}${nextBtn}</div>
    </div>`;
}

function handleOverlayClick(e) {
    if (e.target === document.getElementById('verdict-overlay')) closeVerdict();
}
function closeVerdict() {
    document.getElementById('verdict-overlay').classList.remove('open');
    document.body.style.overflow = '';
}

function checkRedlineDone() {
    const done = Object.keys(clauseVoted).length;
    if (done < L.redlineClauses.length) { closeVerdict(); return; }
    closeVerdict();
    doneSecs = Math.max(doneSecs, 1); updateProg(); burst(); showBadge(rndBadge());

    const correct = L.redlineClauses.filter(c => clauseVoted[c.id] === c.correctStamp).length;
    const accepted = Object.values(clauseVoted).filter(v => v === 'accept').length;
    const flagged  = Object.values(clauseVoted).filter(v => v === 'flag').length;
    const rejected = Object.values(clauseVoted).filter(v => v === 'reject').length;

    document.getElementById('redline-done-wrap').innerHTML = `
        <div class="redline-done">
            <span class="rd-icon">üìã</span>
            <div class="rd-title">Contract Review Complete!</div>
            <div class="rd-sub">${correct}/${L.redlineClauses.length} correct decisions ‚Äî ${correct >= 4 ? 'sharp commercial instincts!' : 'the briefing will sharpen your eye.'}</div>
            <div class="rd-score">
                <div class="rd-chip accept">‚úÖ ${accepted} accepted</div>
                <div class="rd-chip flag">‚ö†Ô∏è ${flagged} flagged</div>
                <div class="rd-chip reject">‚ùå ${rejected} rejected</div>
            </div>
            <button class="rd-btn" onclick="goTo(1)">üìã Get The Full Legal Briefing ‚Üí</button>
        </div>`;
}

/* ‚îÄ‚îÄ BRIEFING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function buildBriefing() {
    const skipBtn = `<button class="briefing-skip" onclick="goTo(2)">Skip ‚Üí</button>`;
    const blocks  = L.briefing.map((b, bi) => {
        const rows  = b.rows.map(r =>
            `<div class="b-row"><span class="b-key">${r.key}</span><span class="b-val${r.style ? ' ' + r.style : ''}">${r.val}</span></div>`).join('');
        const alert = b.alert ? `<div class="b-alert">${b.alert}</div>` : '';
        return `<div class="b-block" data-heat="${b.heat}" style="animation-delay:${bi * .08}s">
            <div class="b-label">${b.label}</div>
            <div class="b-rows">${rows}</div>${alert}
        </div>`;
    }).join('');
    return head('üìã', 'The Briefing', 'Contract review framework ‚Äî read before the exercises', 1, skipBtn) +
        `<div class="sec-body">${blocks}
            <button class="briefing-go" onclick="completeSec(1)">Got It ‚Äî Let's Draft ‚ö°</button>
        </div>`;
}

/* ‚îÄ‚îÄ EXERCISE DISPATCHER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function buildExercise(ex, n) {
    if (ex.type === 'trueFalse')      return buildTF(ex, n);
    if (ex.type === 'multipleChoice') return buildMC(ex, n);
    if (ex.type === 'gapFill')        return buildGF(ex, n);
    if (ex.type === 'wordForms')      return buildWF(ex, n);
    if (ex.type === 'grammar')        return buildGR(ex, n);
    return '';
}

function buildTF(ex, n) {
    const qs = ex.questions.map((q, qi) => `
        <div class="q-box">
            <p class="q-text">${qi + 1}. ${q.q}</p>
            <div class="opt-grp">
                <button class="opt-btn" data-correct="${q.a === true}">üëç True</button>
                <button class="opt-btn" data-correct="${q.a === false}">üëé False</button>
            </div>
        </div>`).join('');
    return qs + btnRow(n, false);
}

function buildMC(ex, n) {
    const qs = ex.questions.map((q, qi) => {
        const opts = q.opts.map((o, oi) =>
            `<button class="opt-btn" data-correct="${oi === q.correct}">${o}</button>`).join('');
        return `<div class="q-box"><p class="q-text">${qi + 1}. ${q.q}</p><div class="opt-grp">${opts}</div></div>`;
    }).join('');
    return qs + btnRow(n, false);
}

function buildGF(ex, n) {
    const bank  = ex.wordBank.map(w =>
        `<button class="wb-word" data-word="${w}">${w}</button>`).join('');
    const sents = ex.sentences.map((s, si) => {
        const pts = s.t.split('___');
        return `<p style="margin-bottom:.3em">${si + 1}. ${pts[0]}<span class="gap" data-answer="${s.a}"></span>${pts[1] || ''}</p>`;
    }).join('');
    return `<p style="font-size:13px;font-weight:800;color:var(--ink-3);margin-bottom:12px;">Select a word from the bank, then tap a blank</p>
        <div class="word-bank"><div class="wb-label">Word Bank</div><div class="wb-words">${bank}</div></div>
        <div class="gap-sents">${sents}</div>` + btnRow(n, false);
}

function buildWF(ex, n) {
    const items = ex.questions.map((q, qi) => {
        const hint = q.a[0] + '_'.repeat(Math.max(0, q.a.length - 1));
        return `<div class="wf-item">
            <p class="wf-prompt">${qi + 1}. ${q.p}</p>
            <input type="text" class="wf-input" data-answer="${q.a}" placeholder="Type your answer‚Ä¶">
            <button class="hint-btn" onclick="toggleHint(this)">üí° Hint</button>
            <div class="hint-text">${hint} (${q.a.length} letters)</div>
        </div>`;
    }).join('');
    return items + btnRow(n, true);
}

function buildGR(ex, n) {
    const ex2  = ex.explanation;
    const egs  = (ex2.examples || []).map(e =>
        `<div class="gram-ex"><strong>${e.label}</strong> ${e.text}</div>`).join('');
    const expl = `<div class="gram-expl"><h4>${ex2.heading}</h4><p>${ex2.text}</p>${egs}</div>`;
    const cards = ex.questions.map((q, qi) => {
        const opts = q.opts.map(o => `<option value="${o}">${o}</option>`).join('');
        return `<div class="gram-card">
            <div class="gc-body">
                <p class="gc-sent">${qi + 1}. ${q.s}</p>
                <p class="gc-hint">üí° ${q.hint}</p>
            </div>
            <select class="gram-sel" data-answer="${q.a}"><option value="">Choose‚Ä¶</option>${opts}</select>
        </div>`;
    }).join('');
    return expl + cards + btnRow(n, false);
}

function buildGlossary() {
    const items = L.vocabulary.map(w => `
        <div class="voc-item" onclick="showVoc('${w.word.replace(/'/g, "\\'")}')">
            <div class="voc-item-word">${w.word}</div>
            <div class="voc-item-type">${w.type}</div>
            <div class="voc-item-def">${w.definition}</div>
        </div>`).join('');
    return `<div class="sec-card visible strip-teal">
        <div class="sec-head">
            <div class="sec-head-left">
                <div class="sec-head-icon">üìö</div>
                <div><div class="sec-head-title">All 10 Vocab Words</div><div class="sec-head-sub">Tap any word to hear it pronounced</div></div>
            </div>
        </div>
        <div class="sec-body"><div class="voc-grid">${items}</div></div>
    </div>`;
}

function btnRow(n, hasReveal) {
    return `<div class="btn-row">
        <button class="btn-check" onclick="checkSec(${n})">Check Answers</button>
        ${hasReveal ? `<button class="btn-reveal" onclick="revealWF(${n})">Reveal All</button>` : ''}
        <button class="btn-reset" onclick="resetSec(${n})">Reset</button>
    </div>
    <div id="res-${n}" class="result"></div>`;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   NAVIGATION
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function goTo(n) {
    curSec = n;
    const el = document.querySelector(`.sec-card[data-sec="${n}"]`);
    if (el) { el.classList.add('visible'); el.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
    updateNav();
}
function nextSec() { if (curSec < TOTAL - 1) { curSec++; goTo(curSec); } else finishLesson(); }
function prevSec() { if (curSec > 0) { curSec--; goTo(curSec); } }

function completeSec(n) {
    doneSecs = Math.max(doneSecs, n);
    updateProg();
    if (n >= TOTAL - 1) { finishLesson(); return; }
    const next = document.querySelector(`.sec-card[data-sec="${n + 1}"]`);
    if (next) { next.classList.add('visible'); next.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
    if (Math.random() < .3) showBadge(rndBadge());
    curSec = n + 1; updateNav();
}

function updateNav() {
    document.getElementById('bn-prev').disabled = curSec === 0;
    document.getElementById('bn-next').textContent = curSec >= TOTAL - 1 ? 'üèÅ Finish' : 'Next ‚Üí';
    document.getElementById('bn-ind').textContent  = `${curSec + 1}/${TOTAL}`;
}
function updateProg() {
    const pct = Math.round((doneSecs / TOTAL) * 100);
    document.getElementById('prog-fill').style.width  = pct + '%';
    document.getElementById('prog-label').textContent = `${doneSecs} / ${TOTAL} sections`;
    document.getElementById('prog-pct').textContent   = pct + '%';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CHECKERS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function checkSec(n) {
    const type = L.exercises[n - 2]?.type;
    if (type === 'trueFalse' || type === 'multipleChoice') checkOpts(n);
    else if (type === 'gapFill')   checkGF(n);
    else if (type === 'wordForms') checkWF(n);
    else if (type === 'grammar')   checkGR(n);
}

function checkOpts(n) {
    const groups = secEl(n).querySelectorAll('.opt-grp');
    let ok = 0, blank = 0;
    groups.forEach(g => {
        const sel = g.querySelector('.opt-btn.selected');
        if (!sel) { blank++; return; }
        g.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('correct', 'incorrect'));
        sel.dataset.correct === 'true' ? (sel.classList.add('correct'), ok++) : sel.classList.add('incorrect');
    });
    if (blank) return showErr(n, 'Please answer all questions first!');
    showRes(n, ok, groups.length, 'üéâ All correct!', 'wrong answers in red ‚Äî try again!');
}

function checkGF(n) {
    const gaps = secEl(n).querySelectorAll('.gap'); let ok = 0;
    gaps.forEach(g => {
        g.classList.remove('correct', 'incorrect');
        const v = (g.textContent || '').trim().toLowerCase();
        if (v === g.dataset.answer.toLowerCase()) { g.classList.add('correct'); ok++; }
        else if (v) g.classList.add('incorrect');
    });
    showRes(n, ok, gaps.length, '‚ú® All gaps correct!', 'red gaps are wrong ‚Äî click to clear and retry');
}

function checkWF(n) {
    const inputs = secEl(n).querySelectorAll('.wf-input'); let ok = 0;
    inputs.forEach(i => {
        i.classList.remove('ok', 'bad');
        if (!i.value.trim()) return;
        i.value.trim().toLowerCase() === i.dataset.answer.toLowerCase()
            ? (i.classList.add('ok'), ok++) : i.classList.add('bad');
    });
    showRes(n, ok, inputs.length, 'üéØ Word Forms Champion!', 'red boxes are wrong ‚Äî check spelling!');
}

function checkGR(n) {
    const sels = secEl(n).querySelectorAll('.gram-sel'); let ok = 0;
    sels.forEach(s => {
        s.classList.remove('correct', 'incorrect');
        if (!s.value) return;
        s.value === s.dataset.answer ? (s.classList.add('correct'), ok++) : s.classList.add('incorrect');
    });
    showRes(n, ok, sels.length, '‚öñÔ∏è Legal Grammar Ace!', 'red dropdowns are wrong ‚Äî try again!');
}

function revealWF(n) {
    secEl(n).querySelectorAll('.wf-input').forEach(i => {
        i.value = i.dataset.answer; i.classList.add('ok'); i.classList.remove('bad');
    });
    hideRes(n);
}

function resetSec(n) {
    const ex = L.exercises[n - 2];
    if (!ex) return;
    if (ex.type === 'trueFalse' || ex.type === 'multipleChoice')
        secEl(n).querySelectorAll('.opt-btn').forEach(b => b.classList.remove('selected', 'correct', 'incorrect'));
    if (ex.type === 'gapFill') {
        secEl(n).querySelectorAll('.gap').forEach(g => { g.textContent = ''; g.classList.remove('correct', 'incorrect'); });
        secEl(n).querySelectorAll('.wb-word').forEach(w => w.classList.remove('sel', 'used'));
        selWord = null;
    }
    if (ex.type === 'wordForms') secEl(n).querySelectorAll('.wf-input').forEach(i => { i.value = ''; i.classList.remove('ok', 'bad'); });
    if (ex.type === 'grammar')   secEl(n).querySelectorAll('.gram-sel').forEach(s => { s.value = ''; s.classList.remove('correct', 'incorrect'); });
    hideRes(n);
}

function showRes(n, ok, total, yep, nope) {
    const el = document.getElementById(`res-${n}`); if (!el) return;
    const perfect = ok === total;
    el.style.display = 'block';
    el.className     = `result ${perfect ? 'ok' : 'bad'}`;
    el.textContent   = perfect ? yep : `${ok}/${total} correct ‚Äî ${nope}`;
    if (perfect) { burst(); if (Math.random() < .5) showBadge(rndBadge()); setTimeout(() => completeSec(n), 1400); }
}
function showErr(n, msg) { const e = document.getElementById(`res-${n}`); if (e) { e.style.display = 'block'; e.className = 'result bad'; e.textContent = msg; } }
function hideRes(n)      { const e = document.getElementById(`res-${n}`); if (e) e.style.display = 'none'; }
function secEl(n)        { return document.querySelector(`.sec-card[data-sec="${n}"]`); }

/* ‚îÄ‚îÄ GAP CLICK ‚îÄ‚îÄ */
function gapClick(gap) {
    if (gap.classList.contains('correct')) return;
    if (gap.textContent.trim()) {
        const w = Array.from(gap.closest('.sec-card').querySelectorAll('.wb-word'))
            .find(b => b.dataset.word === gap.textContent.trim());
        if (w) w.classList.remove('used');
        gap.textContent = ''; gap.classList.remove('incorrect');
    } else if (selWord) {
        gap.textContent = selWord.dataset.word;
        selWord.classList.add('used'); selWord.classList.remove('sel');
        selWord = null;
    }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   WIRE ALL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function wireAll() {
    document.querySelectorAll('.opt-grp').forEach(g => {
        g.addEventListener('click', e => {
            const btn = e.target.closest('.opt-btn');
            if (!btn || g.querySelector('.opt-btn.correct')) return;
            g.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('selected', 'incorrect'));
            btn.classList.add('selected');
        });
    });
    document.querySelectorAll('.wb-word').forEach(w => {
        w.addEventListener('click', () => {
            if (w.classList.contains('used')) return;
            if (w.classList.contains('sel')) { w.classList.remove('sel'); selWord = null; }
            else { document.querySelectorAll('.wb-word').forEach(b => b.classList.remove('sel')); w.classList.add('sel'); selWord = w; }
        });
    });
    document.querySelectorAll('.gap').forEach(g => g.addEventListener('click', () => gapClick(g)));
    document.addEventListener('click', e => {
        const voc = e.target.closest('[data-voc]');
        if (voc) { e.stopPropagation(); showVoc(voc.dataset.voc); return; }
        if (!e.target.closest('#voc-popup')) closeVoc();
    });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   VOCAB POPUP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showVoc(word) {
    const w = L.vocabulary.find(v => v.word.toLowerCase() === word.toLowerCase());
    if (!w) return;
    document.getElementById('vp-body').innerHTML = `
        <div class="voc-word">${w.word}</div>
        <div class="voc-type">${w.type}</div>
        <div class="voc-def">${w.definition}</div>
        <button class="voc-hear" onclick="speak('${w.word.replace(/'/g, "\\'")}')">üîä Hear It (British English)</button>`;
    document.getElementById('voc-popup').style.display = 'block';
}
function closeVoc() { document.getElementById('voc-popup').style.display = 'none'; }
function speak(word) {
    const u = new SpeechSynthesisUtterance(word);
    u.lang = 'en-GB'; u.rate = .85;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CELEBRATIONS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const COLOURS = ['#2BDECC', '#58CC02', '#1CB0F6', '#FFC800', '#CE82FF', '#FF4B4B'];
function burst() {
    for (let i = 0; i < 18; i++) {
        const d = document.createElement('div');
        d.className = 'confetti-dot';
        d.style.cssText = `left:${25 + Math.random() * 50}vw;top:${15 + Math.random() * 35}vh;background:${COLOURS[Math.floor(Math.random() * COLOURS.length)]};animation-delay:${Math.random() * .35}s;animation-duration:${.65 + Math.random() * .6}s;transform:rotate(${Math.random() * 360}deg)`;
        document.body.appendChild(d);
        setTimeout(() => d.remove(), 1300);
    }
}
function showBadge(b) {
    const el = document.createElement('div');
    el.className = 'badge';
    el.innerHTML = `<span class="badge-icon">${b.icon}</span><span class="badge-text">${b.text}</span>`;
    document.getElementById('badge-wrap').appendChild(el);
    setTimeout(() => el.classList.add('show'), 80);
    setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 400); }, 2800);
}
function rndBadge() { return L.badges[Math.floor(Math.random() * L.badges.length)]; }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FINISH LESSON
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function finishLesson() {
    doneSecs = TOTAL; updateProg();
    if (!window.EFCD_Auth?.getCurrentUser()) {
        localStorage.setItem('efcd_last_lesson_done', 'true');
        if (confirm('‚öñÔ∏è Lesson complete!\n\nSign up free to save your XP, streaks and badges.\n\nOK = Sign up | Cancel = Keep browsing'))
            window.location.href = '/signup/';
        else if (typeof showWordMatchGame === 'function')
            showWordMatchGame(L.vocabulary, () => window.location.href = L.levelPage);
        else window.location.href = L.levelPage;
        return;
    }
    localStorage.setItem('efcd_last_lesson_done', 'true');
    const completionTime = Math.floor((Date.now() - performance.timing.navigationStart) / 1000);
    const result = await window.EFCD_Auth.completeLesson({
        lessonId:       L.lessonId,
        lessonTitle:    L.title,
        lessonLevel:    L.level,
        lessonLink:     L.lessonLink,
        vocabulary:     L.vocabulary,
        grammar:        L.grammar,
        perfectScore:   true,
        completionTime: completionTime
    });

    if (window.DailyChallenges && result?.success) {
        const cr = await window.DailyChallenges.updateChallengeProgress({
            perfectScore:   true,
            vocabCount:     L.vocabulary.length,
            completionTime: completionTime,
            grammarPerfect: true
        });
        if (cr?.justCompleted) {
            setTimeout(() => window.DailyChallenges.showChallengeCompletionCelebration?.(cr.challenge), 900);
        }
    }

    if (typeof showWordMatchGame === 'function')
        showWordMatchGame(L.vocabulary, gr => showEndScreen(result, gr));
    else showEndScreen(result, null);
}

function showEndScreen(res, game) {
    const xp = (res?.xpEarned || 0) + (game?.bonusXP || 0);
    const ov = document.createElement('div');
    ov.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;animation:up .3s ease both;';
    ov.innerHTML = `
        <div style="background:var(--white);border:2px solid var(--border-heavy);border-bottom:8px solid var(--border-heavy);border-radius:var(--r);max-width:420px;width:100%;overflow:hidden;animation:popin .4s cubic-bezier(.175,.885,.32,1.275) both;">
            <div style="background:linear-gradient(135deg,var(--teal) 0%,#7AEEEA 100%);padding:28px 20px 24px;text-align:center;position:relative;">
                <button onclick="this.closest('div').parentElement.parentElement.remove()" style="position:absolute;top:10px;right:10px;background:rgba(0,0,0,.1);border:2px solid rgba(0,0,0,.15);border-radius:var(--rxs);color:var(--ink-bold);font-size:20px;font-weight:900;width:34px;height:34px;cursor:pointer;font-family:inherit;display:flex;align-items:center;justify-content:center;">√ó</button>
                <div style="font-size:68px;margin-bottom:8px;">üìÑ</div>
                <div style="font-size:13px;font-weight:900;color:var(--accent-text);text-transform:uppercase;letter-spacing:2px;margin-bottom:4px;">Contract Reviewed</div>
                <div style="font-size:28px;font-weight:900;color:var(--ink-bold);letter-spacing:-1px;">Silk Gloves achieved!</div>
            </div>
            <div style="padding:20px;display:flex;flex-direction:column;gap:14px;">
                <div style="background:var(--bg);border:2px solid var(--border-heavy);border-bottom:4px solid var(--border-heavy);border-radius:var(--rsm);padding:18px;text-align:center;">
                    <div style="font-size:48px;font-weight:900;color:var(--accent-text);">+${xp} XP</div>
                    ${res?.leveledUp ? `<div style="color:var(--green-shadow);font-weight:900;font-size:16px;margin-top:6px;">üéä LEVEL UP ‚Üí Level ${res.newLevel}!</div>` : ''}
                    ${res?.newStreak > 0 ? `<div style="color:var(--ink-3);font-weight:800;font-size:14px;margin-top:4px;">üî• ${res.newStreak}-day streak!</div>` : ''}
                </div>
                <a href="${L.levelPage}" style="display:flex;align-items:center;justify-content:center;gap:8px;padding:15px;background:var(--teal);color:var(--ink-bold);font-size:16px;font-weight:900;border-radius:var(--rsm);border:2px solid var(--teal-shadow);border-bottom:5px solid var(--teal-shadow);">More Legal Lessons ‚Üí</a>
                <a href="/dashboard-gamified/" style="display:flex;align-items:center;justify-content:center;padding:13px;background:var(--bg);color:var(--ink-3);font-size:14px;font-weight:800;border-radius:var(--rsm);border:2px solid var(--border-heavy);border-bottom:3px solid var(--border-heavy);">View Dashboard</a>
            </div>
        </div>`;
    document.body.appendChild(ov);
    burst(); setTimeout(burst, 300);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HINTS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function toggleHint(btn) {
    const hint = btn.nextElementSibling;
    if (!hint) return;
    hint.classList.toggle('show');
    btn.textContent = hint.classList.contains('show') ? 'üôà Hide hint' : 'üí° Hint';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STATS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function initStats() {
    localStorage.setItem('efcd_last_lesson_url',  window.location.pathname);
    localStorage.setItem('efcd_last_lesson_name', 'The Redline Room');
    localStorage.setItem('efcd_last_lesson_done', 'false');

    function tryInit() {
        if (typeof window.efcdReady === 'undefined') { setTimeout(tryInit, 50); return; }
        window.efcdReady.then(async () => {
            if (!window.EFCD_Auth) return;
            await window.EFCD_Auth.initAuth();
            const user = window.EFCD_Auth.getCurrentUser();
            if (user) {
                const s = window.EFCD_Auth.getUserStats();
                document.getElementById('hdr-streak').textContent = s?.streak || 0;
                document.getElementById('hdr-xp').textContent     = (s?.xp || 0).toLocaleString();
            }
        }).catch(() => {});
    }
    tryInit();
}

build();
initStats();
if (window.DailyChallenges) {
    const w = document.getElementById('daily-challenge-widget');
    if (w) w.innerHTML = window.DailyChallenges.renderDailyChallengeWidget();
}
</script>
</body>
</html>
