<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="icon" type="image/png" href="/favicon.png" sizes="32x32">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
    <link rel="manifest" href="/manifest.json">
    <title>My Dashboard - English For Cool Dudes</title>

    <link rel="preconnect" href="https://fonts.bunny.net">
    <link href="https://fonts.bunny.net/css2?family=Nunito:wght@400;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        const SUPABASE_URL = 'https://knwgmrgwbpchqyqxbxea.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtud2dtcmd3YnBjaHF5cXhieGVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MDkyODgsImV4cCI6MjA3ODA4NTI4OH0.qnp2ScwSE77_idmPhpLE98sr46WvLpKtg6refFfC7s8';
        window.efcdSupabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    </script>

    <script src="/supabase-auth-gamified.js"></script>
    <script src="/badge-system.js"></script>
    <script src="/track-mastery.js"></script>
    <script src="/tickerData.js"></script>
    <script src="/daily-challenges-system.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        :root {
            --blue:         #1CB0F6;
            --blue-shadow:  #1899D6;
            --yellow:       #FFC800;
            --yellow-shadow:#E5B400;
            --green:        #58CC02;
            --green-shadow: #58A700;
            --punch:        #FF4B4B;
            --punch-shadow: #EA2B2B;
            --purple:       #CE82FF;
            --purple-shadow:#A559D9;
            --teal:         #2BDECC;
            --teal-shadow:  #1FBFAF;
            --bg:           #F7F9FA;
            --ink:          #4B4B4B;
            --ink-bold:     #111827;
            --ink-3:        #AFAFAF;
            --white:        #FFFFFF;
            --border:       #E5E5E5;
            --border-heavy: #CECECE;
            --r:            24px;
            --rsm:          16px;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { -webkit-text-size-adjust: 100%; scroll-behavior: smooth; }
        body { background: var(--bg); color: var(--ink); font-family: 'Nunito', -apple-system, system-ui, sans-serif; line-height: 1.5; overflow-x: hidden; -webkit-font-smoothing: antialiased; }
        a { color: inherit; text-decoration: none; }

        @keyframes up      { from{opacity:0;transform:translateY(22px)} to{opacity:1;transform:translateY(0)} }
        @keyframes shim    { 0%{background-position:-400px 0} 100%{background-position:400px 0} }
        @keyframes flick   { 0%,100%{transform:rotate(-4deg) scale(1)} 50%{transform:rotate(4deg) scale(1.12)} }
        @keyframes float   { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }
        @keyframes popin   { 0%{opacity:0;transform:scale(.88)} 70%{transform:scale(1.04)} 100%{opacity:1;transform:scale(1)} }
        @keyframes slideUp { from{opacity:0;transform:translateY(40px)} to{opacity:1;transform:translateY(0)} }
        @keyframes confetti{ 0%{opacity:1;transform:translateY(0) rotate(0deg)} 100%{opacity:0;transform:translateY(140px) rotate(420deg)} }

        .u1{animation:up .44s ease both .04s} .u2{animation:up .44s ease both .14s}
        .u3{animation:up .44s ease both .24s} .u4{animation:up .44s ease both .34s}
        .u5{animation:up .44s ease both .44s}

        /* â”€â”€ HEADER â”€â”€ */
        .header { background: var(--white); border-bottom: 2px solid var(--border); position: sticky; top: 0; z-index: 200; padding: 0 20px; height: 60px; display: flex; align-items: center; }
        .hc { max-width: 900px; width: 100%; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
        .hl { display: flex; align-items: center; gap: 10px; }
        .logo { width: 40px; height: 40px; border-radius: 12px; background: var(--yellow); border: 2px solid var(--border-heavy); display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0; box-shadow: 0 3px 0 var(--border-heavy); }
        .site-title { font-size: 18px; font-weight: 900; color: var(--ink-bold); letter-spacing: -.4px; }
        @media(max-width:380px){ .site-title{display:none} }
        .btn-signout { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; background: var(--white); color: var(--ink-bold); font-size: 14px; font-weight: 900; font-family: inherit; border-radius: var(--rsm); border: 2px solid var(--border-heavy); border-bottom: 4px solid var(--border-heavy); cursor: pointer; letter-spacing: -.2px; transition: transform .1s, border-bottom-width .1s; }
        .btn-signout:active { border-bottom-width: 2px; transform: translateY(2px); }

        /* â”€â”€ PAGE â”€â”€ */
        .page { max-width: 900px; margin: 0 auto; padding: 24px 16px 96px; display: flex; flex-direction: column; gap: 20px; }

        /* â”€â”€ SKELETON â”€â”€ */
        .sk { background: linear-gradient(90deg,#EBEBEB 25%,#F5F5F5 50%,#EBEBEB 75%); background-size: 400px 100%; animation: shim 1.4s infinite; border-radius: var(--rsm); }

        /* â”€â”€ SECTION LABELS â”€â”€ */
        .sec-label { font-size: 13px; font-weight: 900; color: var(--ink-3); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 12px; display: flex; align-items: center; gap: 12px; }
        .sec-label::after { content: ''; flex: 1; height: 2px; background: var(--border); border-radius: 2px; }

        /* â”€â”€ CHUNKY CARD â”€â”€ */
        .chunky-card { background: var(--white); border: 2px solid var(--border-heavy); border-bottom: 6px solid var(--border-heavy); border-radius: var(--r); padding: 20px; }

        /* â”€â”€ DASHBOARD HERO â”€â”€ */
        .dash-hero { background: var(--blue); border: 2px solid var(--blue-shadow); border-bottom: 6px solid var(--blue-shadow); border-radius: var(--r); padding: 24px 20px; position: relative; overflow: hidden; }
        .dash-hero::after { content: 'ğŸ“Š'; position: absolute; bottom: -14px; right: 10px; font-size: 110px; opacity: .12; pointer-events: none; transform: rotate(-10deg); }
        .dh-top   { display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; margin-bottom: 20px; position: relative; z-index: 1; }
        .dh-greet { font-size: 13px; font-weight: 800; color: rgba(255,255,255,.8); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 2px; }
        .dh-name  { font-size: clamp(22px,5vw,32px); font-weight: 900; color: var(--white); letter-spacing: -1px; line-height: 1.1; text-shadow: 0 2px 0 var(--blue-shadow); }
        .dh-sub   { font-size: 13px; font-weight: 800; color: rgba(255,255,255,.75); margin-top: 4px; }
        .dh-streak { text-align: center; flex-shrink: 0; background: var(--white); border: 2px solid var(--border-heavy); border-bottom: 4px solid var(--border-heavy); border-radius: var(--rsm); padding: 10px 16px; min-width: 80px; }
        .dh-sfire { font-size: 32px; display: block; line-height: 1; animation: flick 1.8s ease-in-out infinite; }
        .dh-snum  { font-size: 24px; font-weight: 900; color: var(--punch); display: block; line-height: 1.1; margin-top: 4px; }
        .dh-sword { font-size: 10px; font-weight: 900; color: var(--ink-3); text-transform: uppercase; letter-spacing: 1px; }
        .dh-stats { display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; position: relative; z-index: 1; margin-bottom: 18px; }
        .dh-stat  { background: rgba(255,255,255,.2); border: 2px solid rgba(255,255,255,.3); border-radius: var(--rsm); padding: 12px 8px; text-align: center; }
        .dh-stat-n { display: block; font-size: 22px; font-weight: 900; color: var(--white); line-height: 1; }
        .dh-stat-l { font-size: 10px; font-weight: 900; color: rgba(255,255,255,.8); text-transform: uppercase; letter-spacing: 1px; margin-top: 4px; display: block; }
        .dh-xp     { position: relative; z-index: 1; background: rgba(255,255,255,.2); padding: 12px; border-radius: var(--rsm); }
        .dh-xp-row   { display: flex; justify-content: space-between; font-size: 13px; font-weight: 800; margin-bottom: 8px; color: var(--white); }
        .dh-xp-track { height: 16px; background: rgba(0,0,0,.15); border-radius: 99px; overflow: hidden; border: 2px solid rgba(0,0,0,.1); }
        .dh-xp-fill  { height: 100%; width: 0%; border-radius: 99px; background: var(--yellow); border-top: 4px solid rgba(255,255,255,.4); transition: width 1.3s cubic-bezier(.4,0,.2,1); }

        /* â”€â”€ STAT CARDS â”€â”€ */
        .stat-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap: 14px; }
        .stat-card  { background: var(--white); border: 2px solid var(--border-heavy); border-bottom: 6px solid var(--border-heavy); border-radius: var(--r); padding: 20px; position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: -2px; left: -2px; right: -2px; height: 8px; border-radius: 24px 24px 0 0; }
        .stat-card.c-yellow::before { background: var(--yellow); }
        .stat-card.c-punch::before  { background: var(--punch); }
        .stat-card.c-blue::before   { background: var(--blue); }
        .stat-card-label { font-size: 11px; font-weight: 900; text-transform: uppercase; letter-spacing: 1.5px; color: var(--ink-3); margin-bottom: 8px; margin-top: 6px; }
        .stat-card-value { font-size: 36px; font-weight: 900; color: var(--ink-bold); line-height: 1; margin-bottom: 4px; }
        .stat-card-sub   { font-size: 13px; font-weight: 800; color: var(--ink-3); }
        .stat-card-bar   { margin-top: 12px; height: 8px; background: var(--border); border-radius: 99px; overflow: hidden; }
        .stat-card-fill  { height: 100%; border-radius: 99px; transition: width 1s ease; }
        .stat-card-link  { display: inline-block; margin-top: 12px; font-size: 12px; font-weight: 900; color: var(--blue); text-transform: uppercase; letter-spacing: .5px; border-bottom: 2px solid rgba(28,176,246,.3); }

        /* â”€â”€ DAILY CHALLENGE FALLBACK (when dc.js hasn't loaded) â”€â”€ */
        .dc-card { background: linear-gradient(135deg,var(--blue) 0%,#0d8fd4 100%); border: 2px solid var(--blue-shadow); border-bottom: 6px solid var(--blue-shadow); border-radius: var(--r); padding: 20px; display: flex; flex-direction: column; gap: 14px; position: relative; overflow: hidden; }
        .dc-card::after { content: 'ğŸ†'; position: absolute; right: -8px; bottom: -14px; font-size: 90px; opacity: .15; pointer-events: none; }
        .dc-eyebrow { font-size: 11px; font-weight: 900; text-transform: uppercase; letter-spacing: 1.5px; color: rgba(255,255,255,.8); }
        .dc-title   { font-size: 20px; font-weight: 900; color: var(--white); letter-spacing: -.3px; }
        .dc-desc    { font-size: 13px; font-weight: 700; color: rgba(255,255,255,.9); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           GRAMMAR SPRINT MODAL
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #sprint-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,.65);
            z-index: 9000; display: none;
            align-items: flex-end; justify-content: center;
        }
        #sprint-overlay.open { display: flex; }
        @media(min-width:580px) { #sprint-overlay { align-items: center; padding: 20px; } }

        .sprint-sheet {
            background: var(--white);
            border-radius: var(--r) var(--r) 0 0;
            width: 100%; max-width: 540px; max-height: 92vh;
            overflow-y: auto; display: flex; flex-direction: column;
            animation: slideUp .3s cubic-bezier(.4,0,.2,1) both;
        }
        @media(min-width:580px) { .sprint-sheet { border-radius: var(--r); max-height: 86vh; } }
        .sprint-sheet::before { content: ''; display: block; height: 8px; background: var(--purple); border-radius: var(--r) var(--r) 0 0; flex-shrink: 0; }

        .sprint-hd { padding: 16px 20px 14px; border-bottom: 2px solid var(--border); display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
        .sprint-hd-icon { width: 44px; height: 44px; border-radius: 14px; background: rgba(206,130,255,.15); border: 2px solid rgba(206,130,255,.4); display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0; }
        .sprint-hd-title { font-size: 18px; font-weight: 900; color: var(--ink-bold); letter-spacing: -.4px; }
        .sprint-hd-sub   { font-size: 12px; font-weight: 800; color: var(--ink-3); margin-top: 1px; }
        .sprint-close { margin-left: auto; width: 34px; height: 34px; border-radius: 10px; background: var(--bg); border: 2px solid var(--border-heavy); font-size: 18px; font-weight: 900; color: var(--ink-3); display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; font-family: inherit; transition: background .15s, color .15s; }
        .sprint-close:hover { background: var(--punch); color: var(--white); border-color: var(--punch-shadow); }

        .sprint-prog-wrap { padding: 10px 20px; border-bottom: 2px solid var(--border); flex-shrink: 0; }
        .sprint-prog-row  { display: flex; justify-content: space-between; font-size: 12px; font-weight: 800; color: var(--ink-3); margin-bottom: 6px; }
        .sprint-prog-track{ height: 8px; background: var(--border); border-radius: 99px; overflow: hidden; }
        .sprint-prog-fill { height: 100%; background: var(--purple); border-radius: 99px; transition: width .5s ease; }

        .sprint-body { padding: 20px; flex: 1; }

        .sq-num  { font-size: 11px; font-weight: 900; color: var(--ink-3); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; }
        .sq-sent { font-size: clamp(18px,4.5vw,23px); font-weight: 900; color: var(--ink-bold); line-height: 1.3; margin-bottom: 5px; letter-spacing: -.3px; }
        .sq-hint { font-size: 13px; font-weight: 700; color: var(--ink-3); font-style: italic; margin-bottom: 20px; line-height: 1.4; }
        .sq-opts { display: flex; flex-direction: column; gap: 10px; margin-bottom: 16px; }

        .sq-opt {
            display: flex; align-items: center; gap: 12px;
            padding: 14px 16px; min-height: 52px;
            background: var(--white); border: 2px solid var(--border-heavy); border-bottom: 5px solid var(--border-heavy);
            border-radius: var(--rsm); font-size: 15px; font-weight: 800; color: var(--ink);
            font-family: inherit; cursor: pointer; text-align: left;
            transition: transform .1s, border-bottom-width .1s, border-color .15s, background .15s;
            -webkit-appearance: none; touch-action: manipulation;
        }
        .sq-opt:active:not(:disabled)  { border-bottom-width: 2px; transform: translateY(3px); }
        .sq-opt:hover:not(:disabled)   { border-color: var(--purple); color: var(--purple-shadow); }
        .sq-opt.correct  { background: var(--green)  !important; color: var(--white) !important; border-color: var(--green-shadow)  !important; border-bottom-color: var(--green-shadow)  !important; }
        .sq-opt.wrong    { background: var(--punch)  !important; color: var(--white) !important; border-color: var(--punch-shadow)  !important; border-bottom-color: var(--punch-shadow)  !important; }
        .sq-opt.reveal   { background: rgba(88,204,2,.1) !important; color: var(--green-shadow) !important; border-color: var(--green-shadow) !important; }
        .sq-opt:disabled { cursor: default; }

        .sq-fb { font-size: 14px; font-weight: 800; padding: 12px 14px; border-radius: var(--rsm); margin-bottom: 14px; display: none; animation: up .22s ease both; line-height: 1.5; }
        .sq-fb.ok  { background: rgba(88,204,2,.1); color: var(--green-shadow); border: 2px solid rgba(88,204,2,.3); display: block; }
        .sq-fb.bad { background: rgba(255,75,75,.1); color: var(--punch-shadow); border: 2px solid rgba(255,75,75,.3); display: block; }

        .sq-next { width: 100%; padding: 15px; background: var(--purple); color: var(--white); font-size: 16px; font-weight: 900; font-family: inherit; border: 2px solid var(--purple-shadow); border-bottom: 5px solid var(--purple-shadow); border-radius: var(--rsm); cursor: pointer; transition: transform .1s, border-bottom-width .1s; display: none; touch-action: manipulation; }
        .sq-next:active { border-bottom-width: 2px; transform: translateY(3px); }

        /* results */
        .sprint-results { padding: 28px 20px 24px; text-align: center; animation: popin .4s cubic-bezier(.175,.885,.32,1.275) both; }
        .sr-icon  { font-size: 72px; margin-bottom: 8px; display: block; }
        .sr-title { font-size: 26px; font-weight: 900; color: var(--ink-bold); margin-bottom: 6px; letter-spacing: -.5px; }
        .sr-sub   { font-size: 15px; font-weight: 700; color: var(--ink-3); margin-bottom: 24px; line-height: 1.5; }
        .sr-score-box { background: var(--bg); border: 2px solid var(--border-heavy); border-bottom: 4px solid var(--border-heavy); border-radius: var(--rsm); padding: 20px; margin-bottom: 16px; }
        .sr-score-num   { font-size: 54px; font-weight: 900; line-height: 1; }
        .sr-score-label { font-size: 14px; font-weight: 800; color: var(--ink-3); margin-top: 4px; }
        .sr-badge-box { border: 2px solid var(--purple); border-radius: var(--r); padding: 16px; margin-bottom: 20px; background: linear-gradient(135deg,rgba(206,130,255,.12),rgba(206,130,255,.04)); animation: popin .5s cubic-bezier(.175,.885,.32,1.275) .25s both; }
        .sr-badge-icon { font-size: 48px; display: block; margin-bottom: 6px; }
        .sr-badge-name { font-size: 16px; font-weight: 900; color: var(--purple-shadow); }
        .sr-badge-desc { font-size: 13px; font-weight: 700; color: var(--ink-3); margin-top: 2px; }
        .sr-btn-retry { display: block; width: 100%; margin-bottom: 10px; padding: 14px; background: var(--purple); color: var(--white); border: 2px solid var(--purple-shadow); border-bottom: 5px solid var(--purple-shadow); border-radius: var(--rsm); font-size: 15px; font-weight: 900; font-family: inherit; cursor: pointer; transition: transform .1s, border-bottom-width .1s; }
        .sr-btn-retry:active { border-bottom-width: 2px; transform: translateY(3px); }
        .sr-btn-close { display: block; width: 100%; padding: 13px; background: var(--bg); color: var(--ink-3); border: 2px solid var(--border-heavy); border-bottom: 4px solid var(--border-heavy); border-radius: var(--rsm); font-size: 15px; font-weight: 900; font-family: inherit; cursor: pointer; transition: transform .1s, border-bottom-width .1s; }
        .sr-btn-close:active { border-bottom-width: 2px; transform: translateY(3px); }

        .confetti-dot { position: fixed; width: 10px; height: 10px; border-radius: 3px; pointer-events: none; z-index: 9999; animation: confetti .9s ease-out both; }

        /* â”€â”€ LEADERBOARD â”€â”€ */
        .lb-row { display: flex; align-items: center; gap: 14px; padding: 13px 20px; border-bottom: 2px solid var(--border); }
        .lb-row:last-child { border-bottom: none; }
        .lb-row.you { background: rgba(28,176,246,.07); }
        .lb-rank { font-size: 18px; font-weight: 900; width: 32px; text-align: center; flex-shrink: 0; color: var(--ink-3); }
        .lb-av   { width: 40px; height: 40px; border-radius: 12px; background: var(--yellow); border: 2px solid var(--border-heavy); color: var(--ink-bold); display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 900; flex-shrink: 0; }
        .lb-name { flex: 1; font-size: 15px; font-weight: 800; color: var(--ink-bold); }
        .lb-xp   { font-size: 15px; font-weight: 900; color: var(--blue); }

        /* â”€â”€ ACHIEVEMENTS â”€â”€ */
        .ach-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px,1fr)); gap: 12px; }
        .ach-badge { background: var(--white); border: 2px solid var(--border-heavy); border-bottom: 5px solid var(--border-heavy); border-radius: var(--r); padding: 18px 12px; text-align: center; transition: transform .15s, box-shadow .15s; }
        .ach-badge.unlocked { border-color: var(--green-shadow); background: linear-gradient(135deg,#F0FFF4,#DCFCE7); }
        .ach-badge.locked   { opacity: .4; filter: grayscale(1); }
        .ach-badge.unlocked:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(88,204,2,.2); }
        .ach-icon { font-size: 44px; margin-bottom: 8px; display: block; }
        .ach-name { font-size: 13px; font-weight: 900; color: var(--ink-bold); margin-bottom: 4px; }
        .ach-desc { font-size: 11px; font-weight: 700; color: var(--ink-3); line-height: 1.4; }
        .ach-tick { margin-top: 8px; font-size: 11px; font-weight: 900; color: var(--green-shadow); background: rgba(88,204,2,.12); padding: 3px 8px; border-radius: 6px; display: inline-block; }

        /* â”€â”€ CHARTS â”€â”€ */
        .charts-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px,1fr)); gap: 14px; }
        .chart-card { background: var(--white); border: 2px solid var(--border-heavy); border-bottom: 6px solid var(--border-heavy); border-radius: var(--r); padding: 20px; }
        .chart-title { font-size: 15px; font-weight: 900; color: var(--ink-bold); margin-bottom: 16px; }
        .streak-cal { display: grid; grid-template-columns: repeat(auto-fill, minmax(28px,1fr)); gap: 5px; }
        .cal-day { aspect-ratio: 1; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 900; }
        .cal-day.done  { background: var(--green); color: var(--white); }
        .cal-day.empty { background: var(--border); color: var(--ink-3); }
        .cal-day.today { outline: 3px solid var(--punch); outline-offset: 2px; }

        /* â”€â”€ LESSONS â”€â”€ */
        .danger-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap; }
        .btn-clear { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; background: var(--white); color: var(--punch); font-size: 13px; font-weight: 900; font-family: inherit; border-radius: var(--rsm); border: 2px solid #FECACA; border-bottom: 4px solid #FECACA; cursor: pointer; transition: transform .1s, border-bottom-width .1s, background .15s; }
        .btn-clear:hover { background: var(--punch); color: var(--white); border-color: var(--punch-shadow); }
        .btn-clear:active { border-bottom-width: 2px; transform: translateY(2px); }
        .lesson-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px,1fr)); gap: 16px; }
        .lesson-card { background: var(--white); border: 2px solid var(--border-heavy); border-bottom: 6px solid var(--border-heavy); border-radius: var(--r); padding: 20px; transition: transform .15s; }
        .lesson-card:hover { transform: translateY(-3px); }
        .lc-head  { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; margin-bottom: 4px; }
        .lc-title { font-size: 17px; font-weight: 900; color: var(--blue); line-height: 1.3; }
        .lc-title a:hover { text-decoration: underline; }
        .btn-del  { width: 30px; height: 30px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; background: var(--bg); color: var(--ink-3); border: 2px solid var(--border); border-bottom: 4px solid var(--border); border-radius: 10px; font-size: 14px; font-weight: 900; cursor: pointer; font-family: inherit; transition: background .15s, color .15s, border-color .15s; }
        .btn-del:hover { background: var(--punch); color: var(--white); border-color: var(--punch-shadow); }
        .lc-meta { font-size: 12px; font-weight: 800; color: var(--ink-3); margin-bottom: 14px; }
        .vocab-section { padding-top: 14px; border-top: 2px dashed var(--border); }
        .vocab-section h4 { font-size: 13px; font-weight: 900; color: var(--ink-bold); margin-bottom: 10px; text-transform: uppercase; letter-spacing: .5px; }
        .vocab-list { display: flex; flex-wrap: wrap; gap: 7px; }
        .vocab-word { background: rgba(255,200,0,.15); color: var(--ink-bold); padding: 4px 12px; border-radius: 99px; font-size: 13px; font-weight: 800; cursor: pointer; border: 2px solid var(--yellow-shadow); transition: background .15s, transform .1s; }
        .vocab-word:hover { background: var(--yellow); transform: translateY(-2px); }
        .grammar-section { background: rgba(88,204,2,.06); border-left: 4px solid var(--green); padding: 16px; border-radius: 0 var(--rsm) var(--rsm) 0; margin-top: 14px; }
        .grammar-section h4 { font-size: 13px; font-weight: 900; color: var(--green-shadow); margin-bottom: 12px; text-transform: uppercase; letter-spacing: .5px; }
        .grammar-item { background: var(--white); padding: 12px; border-radius: var(--rsm); margin-bottom: 8px; border: 2px solid var(--border); }
        .grammar-item:last-child { margin-bottom: 0; }

        /* â”€â”€ EMPTY STATE â”€â”€ */
        .empty-state { text-align: center; padding: 48px 20px; background: var(--white); border: 2px dashed var(--border-heavy); border-radius: var(--r); }
        .empty-state h3 { font-size: 22px; font-weight: 900; color: var(--ink-bold); margin-bottom: 8px; }
        .empty-state p  { font-size: 15px; font-weight: 700; color: var(--ink-3); margin-bottom: 24px; }
        .btn-yellow { display: inline-flex; align-items: center; gap: 6px; padding: 14px 24px; background: var(--yellow); color: var(--ink-bold); font-size: 16px; font-weight: 900; font-family: inherit; border-radius: var(--rsm); border: 2px solid var(--yellow-shadow); border-bottom: 4px solid var(--yellow-shadow); cursor: pointer; letter-spacing: -.3px; transition: transform .1s, border-bottom-width .1s; text-decoration: none; }
        .btn-yellow:active { border-bottom-width: 2px; transform: translateY(2px); }

        /* â”€â”€ LOADING â”€â”€ */
        .loading { text-align: center; padding: 60px 20px; font-size: 16px; font-weight: 800; color: var(--ink-3); }
        .loading-emoji { font-size: 48px; display: block; margin-bottom: 12px; animation: float 2s ease-in-out infinite; }

        /* â”€â”€ VOCAB POPUP â”€â”€ */
        #vocab-popup { position: fixed; max-width: 340px; background: var(--white); border: 2px solid var(--border-heavy); border-bottom: 6px solid var(--border-heavy); border-top: 6px solid var(--blue); padding: 20px; border-radius: var(--r); z-index: 2000; display: none; box-shadow: 0 20px 60px rgba(0,0,0,.2); }

        /* â”€â”€ CONFIRM OVERLAY â”€â”€ */
        .confirm-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.6); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .confirm-box { background: var(--white); padding: 32px; border-radius: var(--r); border: 2px solid var(--border-heavy); border-bottom: 6px solid var(--border-heavy); text-align: center; max-width: 380px; width: 100%; }
        .confirm-box h3 { font-size: 20px; font-weight: 900; margin-bottom: 8px; color: var(--ink-bold); }
        .confirm-box p  { font-size: 14px; font-weight: 700; color: var(--ink-3); margin-bottom: 24px; }
        .confirm-btns { display: flex; gap: 10px; justify-content: center; }
        .btn-confirm-yes { padding: 12px 24px; background: var(--punch); color: var(--white); border: 2px solid var(--punch-shadow); border-bottom: 4px solid var(--punch-shadow); border-radius: var(--rsm); font-size: 14px; font-weight: 900; font-family: inherit; cursor: pointer; transition: transform .1s, border-bottom-width .1s; }
        .btn-confirm-yes:active { border-bottom-width: 2px; transform: translateY(2px); }
        .btn-confirm-no  { padding: 12px 24px; background: var(--bg); color: var(--ink-bold); border: 2px solid var(--border-heavy); border-bottom: 4px solid var(--border-heavy); border-radius: var(--rsm); font-size: 14px; font-weight: 900; font-family: inherit; cursor: pointer; transition: transform .1s, border-bottom-width .1s; }
        .btn-confirm-no:active { border-bottom-width: 2px; transform: translateY(2px); }

        /* â”€â”€ TOAST â”€â”€ */
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--ink-bold); color: var(--white); padding: 14px 24px; border-radius: var(--rsm); font-weight: 900; font-size: 15px; z-index: 9998; transition: transform .4s cubic-bezier(.4,0,.2,1); box-shadow: 0 8px 24px rgba(0,0,0,.3); border-bottom: 4px solid rgba(0,0,0,.4); }
        .toast.show    { transform: translateX(-50%) translateY(0); }
        .toast.success { border-left: 5px solid var(--green); }
        .toast.error   { border-left: 5px solid var(--punch); }

        /* â”€â”€ FOOTER â”€â”€ */
        .footer { padding: 32px 20px; text-align: center; }
        .footer-text { font-size: 14px; font-weight: 800; color: var(--ink-3); margin-bottom: 10px; }
        .footer a { color: var(--ink-3); font-size: 13px; font-weight: 800; margin: 0 12px; text-decoration: underline; }

        @media(max-width:600px) {
            .stat-cards  { grid-template-columns: 1fr 1fr; }
            .lesson-grid { grid-template-columns: 1fr; }
            .charts-row  { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <header class="header">
        <div class="hc">
            <div class="hl">
                <a href="/" class="logo">ğŸ˜</a>
                <a href="/" class="site-title">English For Cool Dudes</a>
            </div>
            <button class="btn-signout" onclick="logout()">Sign Out</button>
        </div>
    </header>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         GRAMMAR SPRINT MODAL (bottom sheet on mobile, centred on desktop)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="sprint-overlay" role="dialog" aria-modal="true" aria-label="Grammar Sprint">
        <div class="sprint-sheet">
            <!-- purple strip via ::before -->
            <div class="sprint-hd">
                <div class="sprint-hd-icon">ğŸ§ </div>
                <div>
                    <div class="sprint-hd-title">Grammar Sprint</div>
                    <div class="sprint-hd-sub">8 questions Â· ~5 minutes Â· earn +60 XP</div>
                </div>
                <button class="sprint-close" onclick="closeSprint()">Ã—</button>
            </div>
            <div class="sprint-prog-wrap">
                <div class="sprint-prog-row">
                    <span id="sprint-q-label">Question 1 of 8</span>
                    <span id="sprint-score-live">âœ… 0 correct</span>
                </div>
                <div class="sprint-prog-track">
                    <div class="sprint-prog-fill" id="sprint-prog-fill" style="width:0%"></div>
                </div>
            </div>
            <div class="sprint-body" id="sprint-body"></div>
        </div>
    </div>

    <div class="page">

        <div id="loading-state">
            <div class="loading">
                <span class="loading-emoji">âš¡</span>
                Loading your dashboard...
            </div>
        </div>

        <div id="dash" style="display:none; display:flex; flex-direction:column; gap:20px;">

            <div class="u1 dash-hero" id="dash-hero">
                <div class="sk" style="height:14px;width:38%;margin-bottom:10px;"></div>
            </div>

            <div class="u2 stat-cards" id="stat-cards"></div>

            <div class="u3">
                <div class="sec-label">ğŸ¯ Today's Challenge</div>
                <div id="dc-slot"></div>
            </div>

            <div class="u3">
                <div class="sec-label">ğŸ† Top Cool Dudes This Week</div>
                <div class="chunky-card" style="padding:0;overflow:hidden;">
                    <div id="lb-rows"></div>
                </div>
            </div>

            <div class="u4" id="track-mastery-wrap"></div>
            <div class="u4" id="badge-collection-wrap"></div>

            <div class="u4" id="achievements">
                <div class="sec-label">ğŸ† Your Achievements</div>
                <div class="ach-grid" id="ach-grid"></div>
            </div>

            <div class="u5">
                <div class="sec-label">ğŸ“Š Your Learning Journey</div>
                <div class="charts-row">
                    <div class="chart-card">
                        <div class="chart-title">ğŸ“š Vocabulary Growth</div>
                        <canvas id="vocabChart" style="max-height:200px;"></canvas>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">ğŸ“… Weekly Activity</div>
                        <canvas id="activityChart" style="max-height:200px;"></canvas>
                    </div>
                </div>
                <div class="chunky-card" style="margin-top:14px;">
                    <div class="chart-title" style="margin-bottom:16px;">ğŸ”¥ 30-Day Streak History</div>
                    <div class="streak-cal" id="streak-cal"></div>
                </div>
            </div>

            <div class="u5">
                <div class="danger-row" style="margin-bottom:12px;">
                    <div class="sec-label" style="margin-bottom:0;">ğŸ“š Recent Lessons & Vocabulary</div>
                    <button class="btn-clear" onclick="confirmClearAll()">ğŸ—‘ï¸ Clear All</button>
                </div>
                <div class="lesson-grid" id="lesson-list"></div>
                <div id="no-lessons" class="empty-state" style="display:none;">
                    <h3>ğŸ¯ Start Your Cool Dude Journey!</h3>
                    <p>Complete lessons to earn XP, build streaks, and unlock achievements!</p>
                    <a href="/" class="btn-yellow">ğŸš€ Browse Lessons</a>
                </div>
            </div>

        </div>
    </div>

    <footer class="footer">
        <p class="footer-text">Â© 2026 English For Cool Dudes ğŸ˜</p>
        <div>
            <a href="/impressum/">Impressum</a>
            <a href="/datenschutz/">Privacy</a>
        </div>
    </footer>

    <div id="vocab-popup"></div>
    <div class="toast" id="toast"></div>

    <script>
    'use strict';

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  GRAMMAR SPRINT
    //  8 questions covering Present Perfect, Past Simple, Future forms
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const SPRINT_QS = [
        {
            sent: 'She ___ in London for five years now.',
            hint: 'ğŸ’¡ An ongoing situation that started in the past â†’ Present Perfect',
            opts: ['lived', 'has lived', 'is living'],
            ans:  'has lived',
            exp:  'has lived â€” Present Perfect for situations that started in the past and continue now.'
        },
        {
            sent: 'He ___ the report yesterday morning.',
            hint: 'ğŸ’¡ Specific past time "yesterday" always signals â†’ Past Simple',
            opts: ['finished', 'has finished', 'was finishing'],
            ans:  'finished',
            exp:  'finished â€” Past Simple for completed actions at a specific past time.'
        },
        {
            sent: 'I ___ never ___ sushi before. This is my first time!',
            hint: 'ğŸ’¡ Life experience with no specific time â†’ Present Perfect',
            opts: ['never ate', 'have never eaten', 'never eat'],
            ans:  'have never eaten',
            exp:  'have never eaten â€” Present Perfect for life experiences when no specific time is mentioned.'
        },
        {
            sent: 'The company ___ its profits three times since 2020.',
            hint: 'ğŸ’¡ "Since" is a classic Present Perfect trigger word',
            opts: ['doubled', 'has doubled', 'doubles'],
            ans:  'has doubled',
            exp:  'has doubled â€” since always triggers Present Perfect. The result is visible now.'
        },
        {
            sent: 'When ___ you ___ your first job?',
            hint: 'ğŸ’¡ "When" + a completed event â†’ always Past Simple, never Present Perfect',
            opts: ['did â€¦ get', 'have â€¦ got', 'do â€¦ get'],
            ans:  'did â€¦ get',
            exp:  'did â€¦ get â€” When always requires Past Simple. Never use Present Perfect with when.'
        },
        {
            sent: 'Look at those dark clouds â€” it ___ rain any minute!',
            hint: 'ğŸ’¡ You have visible evidence right now â†’ going to prediction',
            opts: ['will', 'is going to', 'is raining'],
            ans:  'is going to',
            exp:  'is going to â€” use this for predictions based on present evidence you can actually see.'
        },
        {
            sent: 'We are out of coffee. No problem â€” I ___ get some.',
            hint: 'ğŸ’¡ A spontaneous decision made at the moment of speaking â†’ will',
            opts: ['am going to', 'will', 'am getting'],
            ans:  'will',
            exp:  'will â€” for decisions made on the spot, not planned in advance.'
        },
        {
            sent: 'She ___ the new CEO next month â€” her contract is already signed.',
            hint: 'ğŸ’¡ A fixed future arrangement already confirmed â†’ Present Continuous',
            opts: ['will become', 'is going to become', 'is becoming'],
            ans:  'is becoming',
            exp:  'is becoming â€” Present Continuous for definite future arrangements that are already set.'
        }
    ];

    let sprintIdx      = 0;
    let sprintScore    = 0;
    let sprintAnswered = false;
    const TOTAL        = SPRINT_QS.length;

    // â”€â”€ Open / close â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function openSprint() {
        sprintIdx = sprintScore = 0;
        sprintAnswered = false;
        document.getElementById('sprint-overlay').classList.add('open');
        document.body.style.overflow = 'hidden';
        renderSQ();
    }
    function closeSprint() {
        document.getElementById('sprint-overlay').classList.remove('open');
        document.body.style.overflow = '';
    }
    document.getElementById('sprint-overlay').addEventListener('click', function(e) {
        if (e.target === this) closeSprint();
    });

    // â”€â”€ Render one question â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Uses data-attributes instead of inline onclick strings to avoid
    // quote-escaping bugs (explanation text contains quotes that break onclick="...")
    function renderSQ() {
        const q = SPRINT_QS[sprintIdx];
        sprintAnswered = false;

        const pct = Math.round((sprintIdx / TOTAL) * 100);
        document.getElementById('sprint-prog-fill').style.width  = pct + '%';
        document.getElementById('sprint-q-label').textContent   = `Question ${sprintIdx + 1} of ${TOTAL}`;
        document.getElementById('sprint-score-live').textContent = `âœ… ${sprintScore} correct`;

        // Build option buttons â€” store answer data in data-attributes, not onclick
        const optsHTML = q.opts.map(opt =>
            `<button class="sq-opt" data-opt="${opt.replace(/"/g,'&quot;')}">${opt}</button>`
        ).join('');

        document.getElementById('sprint-body').innerHTML = `
            <div class="sq-num">Question ${sprintIdx + 1} of ${TOTAL}</div>
            <div class="sq-sent">${q.sent}</div>
            <div class="sq-hint">${q.hint}</div>
            <div class="sq-opts" id="sq-opts">${optsHTML}</div>
            <div class="sq-fb" id="sq-fb"></div>
            <button class="sq-next" id="sq-next">
                ${sprintIdx < TOTAL - 1 ? 'Next Question â†’' : 'See My Results ğŸ‰'}
            </button>`;

        // Wire clicks via JS â€” no inline handlers, no escaping issues
        document.querySelectorAll('.sq-opt').forEach(btn => {
            btn.addEventListener('click', () => answerSQ(btn, btn.dataset.opt, q.ans, q.exp));
        });
        document.getElementById('sq-next').addEventListener('click', nextSQ);
    }

    // â”€â”€ Answer a question â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function answerSQ(btn, chosen, correct, explanation) {
        if (sprintAnswered) return;
        sprintAnswered = true;

        document.querySelectorAll('.sq-opt').forEach(b => b.disabled = true);

        const right = chosen === correct;
        if (right) sprintScore++;

        btn.classList.add(right ? 'correct' : 'wrong');
        if (!right) {
            document.querySelectorAll('.sq-opt').forEach(b => {
                if (b.dataset.opt === correct) b.classList.add('reveal');
            });
        }

        const fb = document.getElementById('sq-fb');
        fb.className = 'sq-fb ' + (right ? 'ok' : 'bad');
        fb.textContent = (right ? 'âœ… ' : 'âŒ ') + explanation;

        document.getElementById('sq-next').style.display = 'block';
        document.getElementById('sprint-score-live').textContent = `âœ… ${sprintScore} correct`;
    }

    // â”€â”€ Advance to next question or results â”€â”€â”€â”€â”€â”€â”€
    function nextSQ() {
        sprintIdx++;
        if (sprintIdx < TOTAL) {
            renderSQ();
        } else {
            showSprintResults();
        }
    }

    // â”€â”€ Results screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function showSprintResults() {
        const passed  = sprintScore >= 6;
        const perfect = sprintScore === TOTAL;

        document.getElementById('sprint-prog-fill').style.width  = '100%';
        document.getElementById('sprint-q-label').textContent   = 'Sprint complete!';
        document.getElementById('sprint-score-live').textContent = `âœ… ${sprintScore}/${TOTAL}`;

        const meta = perfect
            ? { icon:'ğŸ†', title:'Grammar Master!',  sub:`Perfect score â€” you know your tenses cold.`, colour:'var(--green)' }
            : passed
            ? { icon:'ğŸ‰', title:'Grammar Guru!',     sub:`${sprintScore}/${TOTAL} â€” solid work! Review the red answers above.`, colour:'var(--blue)' }
            : { icon:'ğŸ“š', title:'Good Effort!',      sub:`${sprintScore}/${TOTAL} â€” need 6/8 to complete the challenge. Try again!`, colour:'var(--punch)' };

        const badgeHTML = passed ? `
            <div class="sr-badge-box">
                <span class="sr-badge-icon">ğŸ“</span>
                <div class="sr-badge-name">Grammar Guru Badge</div>
                <div class="sr-badge-desc">Completed today's Grammar Sprint${perfect ? ' with a perfect score! ğŸ†' : '!'}</div>
            </div>` : '';

        document.getElementById('sprint-body').innerHTML = `
            <div class="sprint-results">
                <span class="sr-icon">${meta.icon}</span>
                <div class="sr-title">${meta.title}</div>
                <div class="sr-sub">${meta.sub}</div>
                <div class="sr-score-box">
                    <div class="sr-score-num" style="color:${meta.colour}">${sprintScore}/${TOTAL}</div>
                    <div class="sr-score-label">${passed ? 'ğŸ¯ Challenge complete! +60 XP earned' : 'Score 6/8 or more to complete the challenge'}</div>
                </div>
                ${badgeHTML}
                ${!passed ? `<button class="sr-btn-retry" onclick="openSprint()">ğŸ”„ Try Again</button>` : ''}
                <button class="sr-btn-close" onclick="closeSprint()">âœ“ Close</button>
            </div>`;

        if (passed) {
            burst();
            if (perfect) setTimeout(burst, 380);

            // â”€â”€ Complete the daily challenge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (window.DailyChallenges) {
                const result = await window.DailyChallenges.updateChallengeProgress({
                    grammarPerfect: true,
                    perfectScore:   perfect,
                    completionTime: 270,   // under 8 min â†’ also satisfies speed_run
                    vocabCount:     0,
                });
                if (result?.justCompleted) {
                    // Refresh the dc-slot card to show green "Quest Complete" state
                    renderDCWidget();
                    // Trigger the system's own celebration after a short delay
                    setTimeout(() => {
                        window.DailyChallenges.showChallengeCompletionCelebration?.(result.challenge);
                    }, 900);
                }
            }
        }
    }

    // â”€â”€ Confetti â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const BURST_COLS = ['#FFC800','#58CC02','#1CB0F6','#FF4B4B','#CE82FF','#2BDECC'];
    function burst() {
        for (let i = 0; i < 22; i++) {
            const d = document.createElement('div');
            d.className = 'confetti-dot';
            d.style.cssText = `left:${15+Math.random()*70}vw;top:${8+Math.random()*45}vh;background:${BURST_COLS[Math.floor(Math.random()*BURST_COLS.length)]};animation-delay:${Math.random()*.5}s;animation-duration:${.7+Math.random()*.7}s;transform:rotate(${Math.random()*360}deg)`;
            document.body.appendChild(d);
            setTimeout(() => d.remove(), 1600);
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  DAILY CHALLENGE WIDGET WRAPPER
    //  Wraps DailyChallenges.renderDailyChallengeWidget and intercepts
    //  any dead href="#" button to open the sprint instead.
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function renderDCWidget() {
        const slot = document.getElementById('dc-slot');
        if (!slot) return;

        if (window.DailyChallenges) {
            // â”€â”€ BUG FIX 1: correct call â€” no stray semicolon, context passed properly
            slot.innerHTML = window.DailyChallenges.renderDailyChallengeWidget('dashboard');
        } else {
            // Fallback card with direct sprint button
            slot.innerHTML = `
                <div class="dc-card">
                    <div class="dc-eyebrow">âš”ï¸ Daily Quest</div>
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:4px;">
                        <span style="font-size:44px;animation:float 3s ease-in-out infinite;display:block;">ğŸ“</span>
                        <div>
                            <div class="dc-title">Grammar Guru</div>
                            <div class="dc-desc">Ace 8 grammar questions Â· earn +60 XP</div>
                        </div>
                    </div>
                    <button onclick="openSprint()" style="display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:14px 20px;background:var(--yellow);color:var(--ink-bold);font-size:16px;font-weight:900;border-radius:var(--rsm);border:2px solid var(--yellow-shadow);border-bottom:5px solid var(--yellow-shadow);cursor:pointer;font-family:inherit;transition:transform .1s,border-bottom-width .1s;">
                        âœï¸ Start Grammar Sprint â†’
                    </button>
                </div>`;
            return;
        }

        // â”€â”€ BUG FIX 2: intercept the button rendered by DailyChallenges
        // It uses a random id and wires click â†’ openPicker() which doesn't exist here.
        // We scan for any button/link pointing nowhere and re-wire to openSprint().
        setTimeout(() => {
            slot.querySelectorAll('button, a').forEach(el => {
                const href = el.getAttribute('href');
                if (!href || href === '#' || href === '') {
                    el.removeAttribute('href');
                    // Clone to nuke any existing listeners from the injected <script>
                    const fresh = el.cloneNode(true);
                    el.parentNode.replaceChild(fresh, el);
                    fresh.addEventListener('click', e => {
                        e.preventDefault();
                        e.stopPropagation();
                        openSprint();
                    });
                }
            });
        }, 120);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  TOAST
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function showToast(msg, type = 'success') {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.className = `toast ${type} show`;
        setTimeout(() => t.classList.remove('show'), 3000);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  CONFIRM DIALOG
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function showConfirm({ title, message, onConfirm }) {
        const overlay = document.createElement('div');
        overlay.className = 'confirm-overlay';
        overlay.innerHTML = `
            <div class="confirm-box">
                <div style="font-size:48px;margin-bottom:12px;">âš ï¸</div>
                <h3>${title}</h3>
                <p>${message}</p>
                <div class="confirm-btns">
                    <button class="btn-confirm-yes" id="c-yes">Yes, delete</button>
                    <button class="btn-confirm-no"  id="c-no">Cancel</button>
                </div>
            </div>`;
        document.body.appendChild(overlay);
        document.getElementById('c-yes').onclick = () => { overlay.remove(); onConfirm(); };
        document.getElementById('c-no').onclick  = () => overlay.remove();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  AUTH
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function logout() {
        if (window.EFCD_Auth) await window.EFCD_Auth.logout();
        else window.location.href = '/login/';
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  LOAD DASHBOARD
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadDashboard() {
        try {
            if (!window.EFCD_Auth) { window.location.href = '/login/'; return; }
            await window.EFCD_Auth.initAuth();
            const user = window.EFCD_Auth.getCurrentUser();
            if (!user) { window.location.href = '/login/'; return; }

            const stats    = window.EFCD_Auth.getUserStats();
            const progress = window.EFCD_Auth.getProgressToNextLevel(stats.xp);
            const lvInfo   = window.EFCD_Auth.getLevelInfo(stats.level);

            renderHero(user, stats, lvInfo, progress);
            renderStatCards(stats, progress);

            // Use our wrapper â€” not the raw DailyChallenges call (fixes bugs 1 + 2)
            renderDCWidget();

            await loadLeaderboard(user.id);
            await renderBadgeCollection(user.id);
            await renderTrackMasterySection(user.id);
            renderAchievements(stats.achievements);
            await loadLessons(user.id);
            await renderProgressCharts(user.id);

            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('dash').style.display = 'flex';

        } catch (err) {
            console.error('Dashboard error:', err);
            document.getElementById('loading-state').innerHTML = `
                <div class="loading" style="color:var(--punch);">
                    Error loading dashboard. <a href="/login/" style="color:var(--blue);">Log in again â†’</a>
                </div>`;
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  HERO
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderHero(user, stats, lvInfo, progress) {
        const xpIn  = stats.xp % 500;
        const xpPct = Math.min(100, Math.round((xpIn / 500) * 100));
        const xpLeft = 500 - xpIn;
        document.getElementById('dash-hero').innerHTML = `
            <div class="dh-top">
                <div>
                    <div class="dh-greet">Your Dashboard</div>
                    <div class="dh-name">${user.name}</div>
                    <div class="dh-sub">${lvInfo.name} Â· ${stats.lessonsCompleted} lessons</div>
                </div>
                <div class="dh-streak">
                    <span class="dh-sfire">ğŸ”¥</span>
                    <span class="dh-snum">${stats.streak}</span>
                    <span class="dh-sword">Day Streak</span>
                </div>
            </div>
            <div class="dh-stats">
                <div class="dh-stat"><span class="dh-stat-n">${stats.lessonsCompleted}</span><span class="dh-stat-l">Lessons</span></div>
                <div class="dh-stat"><span class="dh-stat-n">${stats.xp.toLocaleString()}</span><span class="dh-stat-l">Total XP</span></div>
                <div class="dh-stat"><span class="dh-stat-n">${stats.achievementCount}</span><span class="dh-stat-l">Achievements</span></div>
            </div>
            <div class="dh-xp">
                <div class="dh-xp-row"><span>Level ${stats.level}</span><span>${xpLeft} XP to Level ${stats.level + 1}</span></div>
                <div class="dh-xp-track"><div class="dh-xp-fill" id="xp-fill"></div></div>
            </div>`;
        requestAnimationFrame(() => setTimeout(() => {
            const f = document.getElementById('xp-fill');
            if (f) f.style.width = xpPct + '%';
        }, 80));
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  STAT CARDS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderStatCards(stats, progress) {
        document.getElementById('stat-cards').innerHTML = `
            <div class="stat-card c-yellow">
                <div class="stat-card-label">Level & XP</div>
                <div class="stat-card-value">Lv ${stats.level}</div>
                <div class="stat-card-sub">${stats.xp.toLocaleString()} XP total</div>
                <div class="stat-card-bar"><div class="stat-card-fill" style="width:${progress.percent}%;background:var(--yellow);"></div></div>
                <div style="font-size:11px;font-weight:800;color:var(--ink-3);margin-top:6px;">${progress.remaining} XP to Level ${stats.level + 1}</div>
            </div>
            <div class="stat-card c-punch">
                <div class="stat-card-label">Streak</div>
                <div class="stat-card-value" style="font-size:44px;line-height:1;">ğŸ”¥</div>
                <div class="stat-card-sub">${stats.streak} days in a row</div>
                <div style="font-size:11px;font-weight:800;color:var(--ink-3);margin-top:6px;">${stats.streakMessage}</div>
            </div>
            <div class="stat-card c-blue">
                <div class="stat-card-label">Achievements</div>
                <div class="stat-card-value">${stats.achievementCount}</div>
                <div class="stat-card-sub">Unlocked</div>
                <a class="stat-card-link" href="#achievements">View all â†’</a>
            </div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  BADGE COLLECTION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function renderBadgeCollection(userId) {
        if (!window.EFCD_Badges || !window.EFCD_Auth) return;
        const profile = window.EFCD_Auth.getCurrentUser();
        if (!profile) return;
        try {
            const { data: lessons } = await window.efcdSupabaseClient
                .from('lessons').select('vocabulary, lesson_level').eq('user_id', userId);
            const wrap = document.getElementById('badge-collection-wrap');
            if (wrap) wrap.innerHTML = `<div class="sec-label">ğŸ… Badge Collection</div>${window.EFCD_Badges.renderGrid(profile, lessons || [])}`;
        } catch (err) { console.warn('Badge grid error:', err); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  TRACK MASTERY
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function renderTrackMasterySection(userId) {
        if (!window.EFCD_TrackMastery) return;
        try {
            const { data: lessons } = await window.efcdSupabaseClient
                .from('lessons').select('lesson_link').eq('user_id', userId);
            const wrap = document.getElementById('track-mastery-wrap');
            if (wrap) wrap.innerHTML = `<div class="sec-label">ğŸ—ºï¸ Track Mastery</div>${window.EFCD_TrackMastery.render(lessons || [])}`;
        } catch (err) { console.warn('Track mastery error:', err); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  LEGACY ACHIEVEMENTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderAchievements(unlocked) {
        const grid = document.getElementById('ach-grid');
        if (!grid || !window.EFCD_Auth?.ACHIEVEMENTS) return;
        grid.innerHTML = Object.entries(window.EFCD_Auth.ACHIEVEMENTS).map(([id, ach]) => {
            const on = unlocked.includes(id);
            return `<div class="ach-badge ${on ? 'unlocked' : 'locked'}">
                <span class="ach-icon">${ach.icon}</span>
                <div class="ach-name">${ach.name}</div>
                <div class="ach-desc">${ach.description}</div>
                ${on ? '<span class="ach-tick">âœ“ Unlocked</span>' : ''}
            </div>`;
        }).join('');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  LEADERBOARD
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadLeaderboard(currentUserId) {
        try {
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const { data: users, error } = await window.efcdSupabaseClient
                .from('profiles').select('id, full_name, xp, streak, level')
                .gte('last_lesson_date', weekAgo.toISOString().split('T')[0])
                .order('xp', { ascending: false }).limit(10);
            const lbRows = document.getElementById('lb-rows');
            if (!lbRows) return;
            if (error || !users?.length) {
                lbRows.innerHTML = `<div style="padding:32px;text-align:center;color:var(--ink-3);font-weight:800;">No active learners yet â€” complete a lesson to appear here! ğŸ†</div>`;
                return;
            }
            const em = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
            lbRows.innerHTML = users.map((u, i) => {
                const you = u.id === currentUserId;
                return `<div class="lb-row${you ? ' you' : ''}">
                    <span class="lb-rank">${em[i] || i + 1}</span>
                    <div class="lb-av">${(u.full_name||'C')[0].toUpperCase()}</div>
                    <span class="lb-name">${u.full_name || 'Cool Dude'}${you ? ' <span style="color:var(--blue);font-size:12px;">(you)</span>' : ''}</span>
                    <span class="lb-xp">${(u.xp||0).toLocaleString()} XP</span>
                </div>`;
            }).join('');
        } catch(err) { console.error('LB error:', err); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  LESSONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadLessons(userId) {
        try {
            const { data: lessons, error } = await window.efcdSupabaseClient
                .from('lessons').select('*').eq('user_id', userId)
                .order('completed_at', { ascending: false }).limit(20);
            if (error) { console.error('Lessons error:', error); return; }
            if (!lessons?.length) {
                document.getElementById('lesson-list').style.display = 'none';
                document.getElementById('no-lessons').style.display = 'block';
                return;
            }
            renderLessons(lessons);
        } catch(err) { console.error('Load lessons error:', err); }
    }

    function renderLessons(lessons) {
        const list = document.getElementById('lesson-list');
        const none = document.getElementById('no-lessons');
        if (!lessons?.length) { list.style.display = 'none'; list.innerHTML = ''; none.style.display = 'block'; return; }
        none.style.display = 'none';
        list.style.display = 'grid';
        list.innerHTML = lessons.map(lesson => {
            const date = new Date(lesson.completed_at).toLocaleDateString('en-GB', { day:'numeric', month:'short', year:'numeric' });
            let vocabHTML = '';
            if (lesson.vocabulary?.length) {
                const words = lesson.vocabulary.map(item =>
                    `<span class="vocab-word" onclick="showVocabPopup(event,'${ea(item.word||'')}','${ea(item.definition||'')}')">${item.word||''}</span>`
                ).join('');
                vocabHTML = `<div class="vocab-section"><h4>ğŸ“š Saved words (${lesson.vocabulary.length}) â€” click to review</h4><div class="vocab-list">${words}</div></div>`;
            }
            let grammarHTML = '';
            if (lesson.grammar?.length) {
                const items = lesson.grammar.map((item, idx) => `
                    <div class="grammar-item">
                        <div style="font-weight:800;margin-bottom:5px;">${idx+1}. ${item.question||''}</div>
                        <div style="color:var(--green-shadow);font-weight:800;">âœ“ ${item.answer||''}</div>
                        <div style="color:var(--ink-3);font-size:.9em;margin-top:3px;">${item.explanation||''}</div>
                    </div>`).join('');
                grammarHTML = `<div class="grammar-section"><h4>âœï¸ Grammar (${lesson.grammar.length} exercises)</h4>${items}</div>`;
            }
            return `
                <div class="lesson-card" id="lc-${lesson.id}">
                    <div class="lc-head">
                        <div class="lc-title"><a href="${lesson.lesson_link||'#'}">${lesson.lesson_title}</a></div>
                        <button class="btn-del" onclick="confirmDel('${lesson.id}','${ea(lesson.lesson_title)}')" title="Remove">âœ•</button>
                    </div>
                    <div class="lc-meta">${lesson.lesson_level||'Lesson'} Â· Completed ${date}</div>
                    ${vocabHTML}${grammarHTML}
                </div>`;
        }).join('');
    }

    function ea(s) { return String(s).replace(/'/g,"\\'").replace(/"/g,'&quot;'); }

    function confirmDel(id, title) {
        showConfirm({ title:'Remove this lesson?', message:`"${title}" will be removed. Your XP and streak are safe!`, onConfirm: () => delLesson(id) });
    }
    async function delLesson(id) {
        try {
            const { error } = await window.efcdSupabaseClient.from('lessons').delete().eq('id', id);
            if (error) throw error;
            const card = document.getElementById(`lc-${id}`);
            if (card) {
                card.style.transition = 'all .3s'; card.style.opacity = '0'; card.style.transform = 'scale(.92)';
                setTimeout(() => {
                    card.remove();
                    if (!document.querySelectorAll('.lesson-card').length) {
                        document.getElementById('lesson-list').style.display = 'none';
                        document.getElementById('no-lessons').style.display = 'block';
                    }
                }, 320);
            }
            showToast('âœ… Lesson removed â€” XP is safe!', 'success');
        } catch(err) { showToast('âŒ Could not delete. Try again.', 'error'); }
    }

    function confirmClearAll() {
        showConfirm({ title:'Clear all lessons?', message:'All lessons removed. XP, streak & achievements are safe!', onConfirm: clearAll });
    }
    async function clearAll() {
        try {
            const user = window.EFCD_Auth.getCurrentUser();
            if (!user) return;
            const { error } = await window.efcdSupabaseClient.from('lessons').delete().eq('user_id', user.id);
            if (error) throw error;
            const cards = document.querySelectorAll('.lesson-card');
            cards.forEach((c, i) => setTimeout(() => { c.style.transition='all .25s'; c.style.opacity='0'; c.style.transform='scale(.9)'; }, i * 50));
            setTimeout(() => {
                document.getElementById('lesson-list').style.display = 'none';
                document.getElementById('lesson-list').innerHTML = '';
                document.getElementById('no-lessons').style.display = 'block';
            }, cards.length * 50 + 300);
            showToast('âœ… Dashboard cleared! XP & streak are safe ğŸ”¥', 'success');
        } catch(err) { showToast('âŒ Could not clear. Try again.', 'error'); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  VOCAB POPUP
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function showVocabPopup(event, word, definition) {
        event.stopPropagation();
        const popup = document.getElementById('vocab-popup');
        popup.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <strong style="font-size:18px;color:var(--blue);">${word}</strong>
                <button onclick="speakWord('${word.replace(/'/g,"\\'")}');this.textContent='ğŸ”Š â–¶'" style="background:var(--bg);border:2px solid var(--border);border-bottom:3px solid var(--border-heavy);width:36px;height:36px;border-radius:10px;cursor:pointer;font-size:16px;">ğŸ”Š</button>
            </div>
            <div style="color:var(--ink);font-weight:700;line-height:1.6;">${definition}</div>
            <button onclick="document.getElementById('vocab-popup').style.display='none'" style="margin-top:14px;background:var(--bg);color:var(--ink-3);border:2px solid var(--border);border-bottom:3px solid var(--border-heavy);padding:8px;border-radius:var(--rsm);width:100%;font-size:13px;font-weight:900;cursor:pointer;font-family:inherit;">Close</button>`;
        popup.style.display = 'block';
        popup.style.top  = (event.clientY + 10) + 'px';
        popup.style.left = (event.clientX + 10) + 'px';
        setTimeout(() => {
            const r = popup.getBoundingClientRect();
            if (r.right  > window.innerWidth)  popup.style.left = (window.innerWidth  - r.width  - 20) + 'px';
            if (r.bottom > window.innerHeight)  popup.style.top  = (event.clientY - r.height - 10) + 'px';
        }, 10);
    }
    function speakWord(word) {
        const u = new SpeechSynthesisUtterance(word);
        u.lang = 'en-GB'; u.rate = 0.9;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
    }
    document.addEventListener('click', e => {
        const p = document.getElementById('vocab-popup');
        if (p && !p.contains(e.target) && !e.target.classList.contains('vocab-word')) p.style.display = 'none';
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  CHARTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function renderProgressCharts(userId) {
        const { data: lessons } = await window.efcdSupabaseClient
            .from('lessons').select('*').eq('user_id', userId)
            .order('completed_at', { ascending: true });
        if (!lessons?.length) return;
        renderVocabChart(lessons);
        renderActivityChart(lessons);
        await renderStreakCalendar();
    }

    function renderVocabChart(lessons) {
        let total = 0;
        const data = lessons.map(l => {
            total += l.vocabulary?.length || 0;
            return { date: new Date(l.completed_at).toLocaleDateString('en-GB',{month:'short',day:'numeric'}), total };
        });
        const ctx = document.getElementById('vocabChart');
        if (!ctx) return;
        new Chart(ctx, {
            type: 'line',
            data: { labels: data.map(d => d.date), datasets: [{ label:'Total Words', data: data.map(d => d.total), borderColor:'#FFC800', backgroundColor:'rgba(255,200,0,.1)', fill:true, tension:.4, borderWidth:3, pointBackgroundColor:'#FFC800' }] },
            options: { responsive:true, maintainAspectRatio:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true,ticks:{color:'#AFAFAF'},grid:{color:'#F0F0F0'}},x:{ticks:{color:'#AFAFAF',maxRotation:45},grid:{display:false}}} }
        });
    }

    function renderActivityChart(lessons) {
        const today = new Date();
        const days = Array.from({length:7},(_,i) => {
            const d = new Date(today); d.setDate(d.getDate() - (6 - i));
            return { day: d.toLocaleDateString('en-GB',{weekday:'short'}), count: lessons.filter(l => new Date(l.completed_at).toDateString() === d.toDateString()).length };
        });
        const ctx = document.getElementById('activityChart');
        if (!ctx) return;
        new Chart(ctx, {
            type: 'bar',
            data: { labels: days.map(d => d.day), datasets: [{ label:'Lessons', data: days.map(d => d.count), backgroundColor:'#1CB0F6', borderRadius:8 }] },
            options: { responsive:true, maintainAspectRatio:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true,ticks:{stepSize:1,color:'#AFAFAF'},grid:{color:'#F0F0F0'}},x:{ticks:{color:'#AFAFAF'},grid:{display:false}}} }
        });
    }

    async function renderStreakCalendar() {
        const cal  = document.getElementById('streak-cal');
        if (!cal) return;
        const user = window.EFCD_Auth.getCurrentUser();
        if (!user) return;
        const { data: lessons } = await window.efcdSupabaseClient
            .from('lessons').select('completed_at').eq('user_id', user.id);
        const done  = new Set((lessons||[]).map(l => new Date(l.completed_at).toDateString()));
        const today = new Date();
        cal.innerHTML = Array.from({length:30},(_,i) => {
            const d = new Date(today); d.setDate(d.getDate() - (29 - i));
            const isToday = i === 29, hasDone = done.has(d.toDateString());
            return `<div class="cal-day ${hasDone?'done':'empty'} ${isToday?'today':''}" title="${d.toLocaleDateString('en-GB')}${hasDone?' âœ“':''}">${hasDone ? 'ğŸ”¥' : d.getDate()}</div>`;
        }).join('');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  BOOT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</body>
</html>
