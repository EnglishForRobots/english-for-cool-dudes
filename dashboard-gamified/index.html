<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="icon" type="image/png" href="/favicon.png" sizes="32x32">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
    <link rel="manifest" href="/manifest.json">
    <title>My Dashboard - English For Cool Dudes</title>

    <link rel="preconnect" href="https://fonts.bunny.net">
    <link href="https://fonts.bunny.net/css2?family=Nunito:wght@400;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        const SUPABASE_URL = 'https://knwgmrgwbpchqyqxbxea.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtud2dtcmd3YnBjaHF5cXhieGVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MDkyODgsImV4cCI6MjA3ODA4NTI4OH0.qnp2ScwSE77_idmPhpLE98sr46WvLpKtg6refFfC7s8';
        window.efcdSupabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    </script>

    <script src="/supabase-auth-gamified.js"></script>
    <script src="/badge-system.js"></script>
    <script src="/track-mastery.js"></script>
    <script src="/tickerData.js"></script>
    <script src="/daily-challenges-system.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        :root {
            --blue:         #1CB0F6;
            --blue-shadow:  #1899D6;
            --yellow:       #FFC800;
            --yellow-shadow:#E5B400;
            --green:        #58CC02;
            --green-shadow: #58A700;
            --punch:        #FF4B4B;
            --punch-shadow: #EA2B2B;
            --purple:       #CE82FF;
            --purple-shadow:#A559D9;
            --teal:         #2BDECC;
            --teal-shadow:  #1FBFAF;
            --bg:           #F7F9FA;
            --ink:          #4B4B4B;
            --ink-bold:     #111827;
            --ink-3:        #AFAFAF;
            --white:        #FFFFFF;
            --border:       #E5E5E5;
            --border-heavy: #CECECE;
            --r:            24px;
            --rsm:          16px;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { -webkit-text-size-adjust: 100%; scroll-behavior: smooth; }
        body {
            background: var(--bg);
            color: var(--ink);
            font-family: 'Nunito', -apple-system, system-ui, sans-serif;
            line-height: 1.5;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }
        a { color: inherit; text-decoration: none; }

        @keyframes up    { from{opacity:0;transform:translateY(22px)} to{opacity:1;transform:translateY(0)} }
        @keyframes shim  { 0%{background-position:-400px 0} 100%{background-position:400px 0} }
        @keyframes flick { 0%,100%{transform:rotate(-4deg) scale(1)} 50%{transform:rotate(4deg) scale(1.12)} }
        @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }
        @keyframes popin { 0%{opacity:0;transform:scale(.9) rotate(-8deg)} 70%{transform:scale(1.06) rotate(3deg)} 100%{opacity:1;transform:scale(1) rotate(0deg)} }

        .u1{animation:up .44s ease both .04s}
        .u2{animation:up .44s ease both .14s}
        .u3{animation:up .44s ease both .24s}
        .u4{animation:up .44s ease both .34s}
        .u5{animation:up .44s ease both .44s}

        /* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .header {
            background: var(--white);
            border-bottom: 2px solid var(--border);
            position: sticky; top: 0; z-index: 200;
            padding: 0 20px; height: 60px;
            display: flex; align-items: center;
        }
        .hc {
            max-width: 900px; width: 100%; margin: 0 auto;
            display: flex; align-items: center; justify-content: space-between;
        }
        .hl { display: flex; align-items: center; gap: 10px; }
        .logo {
            width: 40px; height: 40px; border-radius: 12px;
            background: var(--yellow); border: 2px solid var(--border-heavy);
            display: flex; align-items: center; justify-content: center;
            font-size: 22px; flex-shrink: 0; box-shadow: 0 3px 0 var(--border-heavy);
        }
        .site-title { font-size: 18px; font-weight: 900; color: var(--ink-bold); letter-spacing: -.4px; }
        @media(max-width:380px){ .site-title{display:none} }
        .btn-signout {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 8px 16px; background: var(--white); color: var(--ink-bold);
            font-size: 14px; font-weight: 900; font-family: inherit;
            border-radius: var(--rsm); border: 2px solid var(--border-heavy);
            border-bottom: 4px solid var(--border-heavy); cursor: pointer;
            letter-spacing: -.2px; transition: transform .1s, border-bottom-width .1s;
        }
        .btn-signout:active { border-bottom-width: 2px; transform: translateY(2px); }

        /* â”€â”€ PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .page {
            max-width: 900px; margin: 0 auto;
            padding: 24px 16px 96px;
            display: flex; flex-direction: column; gap: 20px;
        }

        /* â”€â”€ SKELETON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .sk {
            background: linear-gradient(90deg,#EBEBEB 25%,#F5F5F5 50%,#EBEBEB 75%);
            background-size: 400px 100%; animation: shim 1.4s infinite;
            border-radius: var(--rsm);
        }

        /* â”€â”€ SECTION LABELS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .sec-label {
            font-size: 13px; font-weight: 900; color: var(--ink-3);
            text-transform: uppercase; letter-spacing: 1.5px;
            margin-bottom: 12px;
            display: flex; align-items: center; gap: 12px;
        }
        .sec-label::after {
            content: ''; flex: 1; height: 2px;
            background: var(--border); border-radius: 2px;
        }

        /* â”€â”€ CHUNKY CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .chunky-card {
            background: var(--white);
            border: 2px solid var(--border-heavy);
            border-bottom: 6px solid var(--border-heavy);
            border-radius: var(--r);
            padding: 20px;
        }

        /* â”€â”€ DASHBOARD HERO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .dash-hero {
            background: var(--blue);
            border: 2px solid var(--blue-shadow);
            border-bottom: 6px solid var(--blue-shadow);
            border-radius: var(--r);
            padding: 24px 20px;
            position: relative; overflow: hidden;
        }
        .dash-hero::after {
            content: 'ğŸ“Š'; position: absolute;
            bottom: -14px; right: 10px;
            font-size: 110px; opacity: .12;
            pointer-events: none; transform: rotate(-10deg);
        }
        .dh-top {
            display: flex; align-items: flex-start;
            justify-content: space-between; gap: 12px;
            margin-bottom: 20px; position: relative; z-index: 1;
        }
        .dh-greet { font-size: 13px; font-weight: 800; color: rgba(255,255,255,.8); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 2px; }
        .dh-name  { font-size: clamp(22px,5vw,32px); font-weight: 900; color: var(--white); letter-spacing: -1px; line-height: 1.1; text-shadow: 0 2px 0 var(--blue-shadow); }
        .dh-sub   { font-size: 13px; font-weight: 800; color: rgba(255,255,255,.75); margin-top: 4px; }

        .dh-streak {
            text-align: center; flex-shrink: 0;
            background: var(--white); border: 2px solid var(--border-heavy);
            border-bottom: 4px solid var(--border-heavy);
            border-radius: var(--rsm); padding: 10px 16px; min-width: 80px;
        }
        .dh-sfire { font-size: 32px; display: block; line-height: 1; animation: flick 1.8s ease-in-out infinite; }
        .dh-snum  { font-size: 24px; font-weight: 900; color: var(--punch); display: block; line-height: 1.1; margin-top: 4px; }
        .dh-sword { font-size: 10px; font-weight: 900; color: var(--ink-3); text-transform: uppercase; letter-spacing: 1px; }

        .dh-stats {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
            position: relative; z-index: 1; margin-bottom: 18px;
        }
        .dh-stat {
            background: rgba(255,255,255,.2); border: 2px solid rgba(255,255,255,.3);
            border-radius: var(--rsm); padding: 12px 8px; text-align: center;
        }
        .dh-stat-n { display: block; font-size: 22px; font-weight: 900; color: var(--white); line-height: 1; }
        .dh-stat-l { font-size: 10px; font-weight: 900; color: rgba(255,255,255,.8); text-transform: uppercase; letter-spacing: 1px; margin-top: 4px; display: block; }

        .dh-xp {
            position: relative; z-index: 1;
            background: rgba(255,255,255,.2); padding: 12px; border-radius: var(--rsm);
        }
        .dh-xp-row   { display: flex; justify-content: space-between; font-size: 13px; font-weight: 800; margin-bottom: 8px; color: var(--white); }
        .dh-xp-track { height: 16px; background: rgba(0,0,0,.15); border-radius: 99px; overflow: hidden; border: 2px solid rgba(0,0,0,.1); }
        .dh-xp-fill  { height: 100%; width: 0%; border-radius: 99px; background: var(--yellow); border-top: 4px solid rgba(255,255,255,.4); transition: width 1.3s cubic-bezier(.4,0,.2,1); }

        /* â”€â”€ STAT CARDS ROW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .stat-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 14px;
        }
        .stat-card {
            background: var(--white);
            border: 2px solid var(--border-heavy);
            border-bottom: 6px solid var(--border-heavy);
            border-radius: var(--r);
            padding: 20px;
            position: relative; overflow: hidden;
        }
        .stat-card::before {
            content: ''; position: absolute;
            top: -2px; left: -2px; right: -2px; height: 8px;
            border-radius: 24px 24px 0 0;
        }
        .stat-card.c-yellow::before { background: var(--yellow); }
        .stat-card.c-punch::before  { background: var(--punch); }
        .stat-card.c-blue::before   { background: var(--blue); }
        .stat-card-label { font-size: 11px; font-weight: 900; text-transform: uppercase; letter-spacing: 1.5px; color: var(--ink-3); margin-bottom: 8px; margin-top: 6px; }
        .stat-card-value { font-size: 36px; font-weight: 900; color: var(--ink-bold); line-height: 1; margin-bottom: 4px; }
        .stat-card-sub   { font-size: 13px; font-weight: 800; color: var(--ink-3); }
        .stat-card-bar   { margin-top: 12px; height: 8px; background: var(--border); border-radius: 99px; overflow: hidden; }
        .stat-card-fill  { height: 100%; background: var(--yellow); border-radius: 99px; transition: width 1s ease; }
        .stat-card-link  { display: inline-block; margin-top: 12px; font-size: 12px; font-weight: 900; color: var(--blue); text-transform: uppercase; letter-spacing: .5px; border-bottom: 2px solid rgba(28,176,246,.3); }

        /* â”€â”€ DAILY CHALLENGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .dc-card {
            background: linear-gradient(135deg, var(--blue) 0%, #0d8fd4 100%);
            border: 2px solid var(--blue-shadow); border-bottom: 6px solid var(--blue-shadow);
            border-radius: var(--r); padding: 20px;
            display: flex; flex-direction: column; gap: 14px;
            position: relative; overflow: hidden;
        }
        .dc-card::after { content: 'ğŸ†'; position: absolute; right: -8px; bottom: -14px; font-size: 90px; opacity: .15; pointer-events: none; }
        .dc-eyebrow { font-size: 11px; font-weight: 900; text-transform: uppercase; letter-spacing: 1.5px; color: rgba(255,255,255,.8); }
        .dc-title   { font-size: 20px; font-weight: 900; color: var(--white); letter-spacing: -.3px; }
        .dc-desc    { font-size: 13px; font-weight: 700; color: rgba(255,255,255,.9); }
        .dc-xp      { font-size: 14px; font-weight: 900; color: var(--yellow); }
        .dc-bar-wrap{ background: rgba(255,255,255,.25); border-radius: 99px; height: 10px; overflow: hidden; }
        .dc-bar     { height: 100%; background: var(--yellow); border-radius: 99px; transition: width .8s ease; }
        .dc-complete-badge { position: absolute; top: 12px; right: 12px; background: var(--green); color: var(--white); font-size: 11px; font-weight: 900; padding: 4px 10px; border-radius: 8px; border: 2px solid var(--green-shadow); }

        /* â”€â”€ LEADERBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .lb-row { display: flex; align-items: center; gap: 14px; padding: 13px 20px; border-bottom: 2px solid var(--border); }
        .lb-row:last-child { border-bottom: none; }
        .lb-row.you { background: rgba(28,176,246,.07); }
        .lb-rank { font-size: 18px; font-weight: 900; width: 32px; text-align: center; flex-shrink: 0; color: var(--ink-3); }
        .lb-av   { width: 40px; height: 40px; border-radius: 12px; background: var(--yellow); border: 2px solid var(--border-heavy); color: var(--ink-bold); display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 900; flex-shrink: 0; }
        .lb-name { flex: 1; font-size: 15px; font-weight: 800; color: var(--ink-bold); }
        .lb-xp   { font-size: 15px; font-weight: 900; color: var(--blue); }

        /* â”€â”€ ACHIEVEMENTS GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .ach-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
        }
        .ach-badge {
            background: var(--white); border: 2px solid var(--border-heavy);
            border-bottom: 5px solid var(--border-heavy);
            border-radius: var(--r); padding: 18px 12px;
            text-align: center; transition: transform .15s, box-shadow .15s;
        }
        .ach-badge.unlocked {
            border-color: var(--green-shadow);
            background: linear-gradient(135deg, #F0FFF4 0%, #DCFCE7 100%);
        }
        .ach-badge.locked { opacity: .4; filter: grayscale(1); }
        .ach-badge.unlocked:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(88,204,2,.2); }
        .ach-icon { font-size: 44px; margin-bottom: 8px; display: block; }
        .ach-name { font-size: 13px; font-weight: 900; color: var(--ink-bold); margin-bottom: 4px; }
        .ach-desc { font-size: 11px; font-weight: 700; color: var(--ink-3); line-height: 1.4; }
        .ach-tick { margin-top: 8px; font-size: 11px; font-weight: 900; color: var(--green-shadow); background: rgba(88,204,2,.12); padding: 3px 8px; border-radius: 6px; display: inline-block; }

        /* â”€â”€ CHARTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .charts-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 14px;
        }
        .chart-card {
            background: var(--white); border: 2px solid var(--border-heavy);
            border-bottom: 6px solid var(--border-heavy);
            border-radius: var(--r); padding: 20px;
        }
        .chart-title { font-size: 15px; font-weight: 900; color: var(--ink-bold); margin-bottom: 16px; }

        /* Streak calendar */
        .streak-cal {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(28px, 1fr));
            gap: 5px;
        }
        .cal-day {
            aspect-ratio: 1; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 11px; font-weight: 900; cursor: default;
        }
        .cal-day.done  { background: var(--green); color: var(--white); }
        .cal-day.empty { background: var(--border); color: var(--ink-3); }
        .cal-day.today { outline: 3px solid var(--punch); outline-offset: 2px; }

        /* â”€â”€ LESSONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .danger-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap; }
        .btn-clear {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 8px 16px; background: var(--white); color: var(--punch);
            font-size: 13px; font-weight: 900; font-family: inherit;
            border-radius: var(--rsm); border: 2px solid #FECACA;
            border-bottom: 4px solid #FECACA; cursor: pointer;
            transition: transform .1s, border-bottom-width .1s, background .15s;
        }
        .btn-clear:hover { background: var(--punch); color: var(--white); border-color: var(--punch-shadow); }
        .btn-clear:active { border-bottom-width: 2px; transform: translateY(2px); }

        .lesson-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
            gap: 16px;
        }
        .lesson-card {
            background: var(--white); border: 2px solid var(--border-heavy);
            border-bottom: 6px solid var(--border-heavy);
            border-radius: var(--r); padding: 20px;
            transition: transform .15s;
        }
        .lesson-card:hover { transform: translateY(-3px); }
        .lc-head { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; margin-bottom: 4px; }
        .lc-title { font-size: 17px; font-weight: 900; color: var(--blue); line-height: 1.3; }
        .lc-title a { color: inherit; }
        .lc-title a:hover { text-decoration: underline; }
        .btn-del {
            width: 30px; height: 30px; flex-shrink: 0; display: flex;
            align-items: center; justify-content: center;
            background: var(--bg); color: var(--ink-3);
            border: 2px solid var(--border); border-bottom: 4px solid var(--border);
            border-radius: 10px; font-size: 14px; font-weight: 900;
            cursor: pointer; font-family: inherit;
            transition: background .15s, color .15s, border-color .15s;
        }
        .btn-del:hover { background: var(--punch); color: var(--white); border-color: var(--punch-shadow); }
        .lc-meta { font-size: 12px; font-weight: 800; color: var(--ink-3); margin-bottom: 14px; }

        .vocab-section { padding-top: 14px; border-top: 2px dashed var(--border); }
        .vocab-section h4 { font-size: 13px; font-weight: 900; color: var(--ink-bold); margin-bottom: 10px; text-transform: uppercase; letter-spacing: .5px; }
        .vocab-list { display: flex; flex-wrap: wrap; gap: 7px; }
        .vocab-word {
            background: rgba(255,200,0,.15); color: var(--ink-bold);
            padding: 4px 12px; border-radius: 99px; font-size: 13px; font-weight: 800;
            cursor: pointer; border: 2px solid var(--yellow-shadow);
            transition: background .15s, transform .1s;
        }
        .vocab-word:hover { background: var(--yellow); transform: translateY(-2px); }

        .grammar-section {
            background: rgba(88,204,2,.06); border-left: 4px solid var(--green);
            padding: 16px; border-radius: 0 var(--rsm) var(--rsm) 0; margin-top: 14px;
        }
        .grammar-section h4 { font-size: 13px; font-weight: 900; color: var(--green-shadow); margin-bottom: 12px; text-transform: uppercase; letter-spacing: .5px; }
        .grammar-item { background: var(--white); padding: 12px; border-radius: var(--rsm); margin-bottom: 8px; border: 2px solid var(--border); }
        .grammar-item:last-child { margin-bottom: 0; }

        /* â”€â”€ EMPTY STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .empty-state {
            text-align: center; padding: 48px 20px;
            background: var(--white); border: 2px dashed var(--border-heavy);
            border-radius: var(--r);
        }
        .empty-state h3 { font-size: 22px; font-weight: 900; color: var(--ink-bold); margin-bottom: 8px; }
        .empty-state p  { font-size: 15px; font-weight: 700; color: var(--ink-3); margin-bottom: 24px; }
        .btn-yellow {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 14px 24px; background: var(--yellow); color: var(--ink-bold);
            font-size: 16px; font-weight: 900; font-family: inherit;
            border-radius: var(--rsm); border: 2px solid var(--yellow-shadow);
            border-bottom: 4px solid var(--yellow-shadow); cursor: pointer;
            letter-spacing: -.3px; transition: transform .1s, border-bottom-width .1s;
            text-decoration: none;
        }
        .btn-yellow:active { border-bottom-width: 2px; transform: translateY(2px); }

        /* â”€â”€ LOADING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .loading {
            text-align: center; padding: 60px 20px;
            font-size: 16px; font-weight: 800; color: var(--ink-3);
        }
        .loading-emoji { font-size: 48px; display: block; margin-bottom: 12px; animation: float 2s ease-in-out infinite; }

        /* â”€â”€ VOCAB POPUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #vocab-popup {
            position: fixed; max-width: 340px; background: var(--white);
            border: 2px solid var(--border-heavy); border-bottom: 6px solid var(--border-heavy);
            border-top: 6px solid var(--blue);
            padding: 20px; border-radius: var(--r); z-index: 2000;
            display: none; box-shadow: 0 20px 60px rgba(0,0,0,.2);
        }

        /* â”€â”€ CONFIRM OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .confirm-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,.6);
            z-index: 9999; display: flex; align-items: center; justify-content: center;
            padding: 20px;
        }
        .confirm-box {
            background: var(--white); padding: 32px; border-radius: var(--r);
            border: 2px solid var(--border-heavy); border-bottom: 6px solid var(--border-heavy);
            text-align: center; max-width: 380px; width: 100%;
        }
        .confirm-box h3 { font-size: 20px; font-weight: 900; margin-bottom: 8px; color: var(--ink-bold); }
        .confirm-box p  { font-size: 14px; font-weight: 700; color: var(--ink-3); margin-bottom: 24px; }
        .confirm-btns { display: flex; gap: 10px; justify-content: center; }
        .btn-confirm-yes {
            padding: 12px 24px; background: var(--punch); color: var(--white);
            border: 2px solid var(--punch-shadow); border-bottom: 4px solid var(--punch-shadow);
            border-radius: var(--rsm); font-size: 14px; font-weight: 900;
            font-family: inherit; cursor: pointer;
            transition: transform .1s, border-bottom-width .1s;
        }
        .btn-confirm-yes:active { border-bottom-width: 2px; transform: translateY(2px); }
        .btn-confirm-no {
            padding: 12px 24px; background: var(--bg); color: var(--ink-bold);
            border: 2px solid var(--border-heavy); border-bottom: 4px solid var(--border-heavy);
            border-radius: var(--rsm); font-size: 14px; font-weight: 900;
            font-family: inherit; cursor: pointer;
            transition: transform .1s, border-bottom-width .1s;
        }
        .btn-confirm-no:active { border-bottom-width: 2px; transform: translateY(2px); }

        /* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .toast {
            position: fixed; bottom: 30px; left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--ink-bold); color: var(--white);
            padding: 14px 24px; border-radius: var(--rsm);
            font-weight: 900; font-size: 15px; z-index: 9998;
            transition: transform .4s cubic-bezier(.4,0,.2,1);
            box-shadow: 0 8px 24px rgba(0,0,0,.3);
            border-bottom: 4px solid rgba(0,0,0,.4);
        }
        .toast.show { transform: translateX(-50%) translateY(0); }
        .toast.success { border-left: 5px solid var(--green); }
        .toast.error   { border-left: 5px solid var(--punch); }

        /* â”€â”€ FOOTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .footer { padding: 32px 20px; text-align: center; }
        .footer-text { font-size: 14px; font-weight: 800; color: var(--ink-3); margin-bottom: 10px; }
        .footer a { color: var(--ink-3); font-size: 13px; font-weight: 800; margin: 0 12px; text-decoration: underline; }

        @media(max-width: 600px) {
            .stat-cards { grid-template-columns: 1fr 1fr; }
            .lesson-grid { grid-template-columns: 1fr; }
            .charts-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <header class="header">
        <div class="hc">
            <div class="hl">
                <a href="/" class="logo">ğŸ˜</a>
                <a href="/" class="site-title">English For Cool Dudes</a>
            </div>
            <button class="btn-signout" onclick="logout()">Sign Out</button>
        </div>
    </header>

    <div class="page">

        <!-- LOADING STATE -->
        <div id="loading-state">
            <div class="loading">
                <span class="loading-emoji">âš¡</span>
                Loading your dashboard...
            </div>
        </div>

        <!-- DASHBOARD (hidden until loaded) -->
        <div id="dash" style="display:none; display:flex; flex-direction:column; gap:20px;">

            <!-- HERO -->
            <div class="u1 dash-hero" id="dash-hero">
                <div class="sk" style="height:14px;width:38%;margin-bottom:10px;"></div>
            </div>

            <!-- STAT CARDS -->
            <div class="u2 stat-cards" id="stat-cards"></div>

            <!-- DAILY CHALLENGE -->
            <div class="u3">
                <div class="sec-label">ğŸ¯ Today's Challenge</div>
                <div id="dc-slot"></div>
            </div>

            <!-- LEADERBOARD -->
            <div class="u3">
                <div class="sec-label">ğŸ† Top Cool Dudes This Week</div>
                <div class="chunky-card" style="padding:0;overflow:hidden;">
                    <div id="lb-rows"></div>
                </div>
            </div>

            <!-- TRACK MASTERY -->
        <div class="u4" id="track-mastery-wrap">
            <!-- injected by renderTrackMasterySection() -->
        </div>

            <!-- BADGE COLLECTION -->
            <div class="u4" id="badge-collection-wrap">
                <!-- injected by renderBadgeCollection() -->
            </div>

            <!-- ACHIEVEMENTS -->
            <div class="u4" id="achievements">
                <div class="sec-label">ğŸ† Your Achievements</div>
                <div class="ach-grid" id="ach-grid"></div>
            </div>

            <!-- PROGRESS CHARTS -->
            <div class="u5">
                <div class="sec-label">ğŸ“Š Your Learning Journey</div>
                <div class="charts-row">
                    <div class="chart-card">
                        <div class="chart-title">ğŸ“š Vocabulary Growth</div>
                        <canvas id="vocabChart" style="max-height:200px;"></canvas>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">ğŸ“… Weekly Activity</div>
                        <canvas id="activityChart" style="max-height:200px;"></canvas>
                    </div>
                </div>
                <div class="chunky-card" style="margin-top:14px;">
                    <div class="chart-title" style="margin-bottom:16px;">ğŸ”¥ 30-Day Streak History</div>
                    <div class="streak-cal" id="streak-cal"></div>
                </div>
            </div>

            <!-- LESSONS -->
            <div class="u5">
                <div class="danger-row" style="margin-bottom:12px;">
                    <div class="sec-label" style="margin-bottom:0;">ğŸ“š Recent Lessons & Vocabulary</div>
                    <button class="btn-clear" onclick="confirmClearAll()">ğŸ—‘ï¸ Clear All</button>
                </div>
                <div class="lesson-grid" id="lesson-list"></div>
                <div id="no-lessons" class="empty-state" style="display:none;">
                    <h3>ğŸ¯ Start Your Cool Dude Journey!</h3>
                    <p>Complete lessons to earn XP, build streaks, and unlock achievements!</p>
                    <a href="/" class="btn-yellow">ğŸš€ Browse Lessons</a>
                </div>
            </div>

        </div>
    </div>

    <footer class="footer">
        <p class="footer-text">Â© 2026 English For Cool Dudes ğŸ˜</p>
        <div>
            <a href="/impressum/">Impressum</a>
            <a href="/datenschutz/">Privacy</a>
        </div>
    </footer>

    <div id="vocab-popup"></div>
    <div class="toast" id="toast"></div>

    <script>

    // â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showToast(msg, type = 'success') {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.className = `toast ${type} show`;
        setTimeout(() => t.classList.remove('show'), 3000);
    }

    // â”€â”€ CONFIRM DIALOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showConfirm({ title, message, onConfirm }) {
        const overlay = document.createElement('div');
        overlay.className = 'confirm-overlay';
        overlay.innerHTML = `
            <div class="confirm-box">
                <div style="font-size:48px;margin-bottom:12px;">âš ï¸</div>
                <h3>${title}</h3>
                <p>${message}</p>
                <div class="confirm-btns">
                    <button class="btn-confirm-yes" id="c-yes">Yes, delete</button>
                    <button class="btn-confirm-no"  id="c-no">Cancel</button>
                </div>
            </div>`;
        document.body.appendChild(overlay);
        document.getElementById('c-yes').onclick = () => { overlay.remove(); onConfirm(); };
        document.getElementById('c-no').onclick  = () => overlay.remove();
    }

    // â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function logout() {
        if (window.EFCD_Auth) await window.EFCD_Auth.logout();
        else window.location.href = '/login/';
    }

    // â”€â”€ LOAD DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadDashboard() {
        try {
            if (!window.EFCD_Auth) { window.location.href = '/login/'; return; }

            await window.EFCD_Auth.initAuth();
            const user = window.EFCD_Auth.getCurrentUser();
            if (!user) { window.location.href = '/login/'; return; }

            const stats    = window.EFCD_Auth.getUserStats();
            const progress = window.EFCD_Auth.getProgressToNextLevel(stats.xp);
            const lvInfo   = window.EFCD_Auth.getLevelInfo(stats.level);

            // Hero card
            renderHero(user, stats, lvInfo, progress);

            // Stat cards
            renderStatCards(stats, progress);

            // Daily challenge
            if (window.DailyChallenges) {
                document.getElementById('dc-slot').innerHTML =
                    window.DailyChallenges.renderDailyChallengeWidget();
            }

            // Leaderboard
            await loadLeaderboard(user.id);

            // Badge collection (new!)
            await renderBadgeCollection(user.id);
            await renderTrackMasterySection(user.id);

            // Legacy achievements
            renderAchievements(stats.achievements);

            // Lessons + charts
            await loadLessons(user.id);
            await renderProgressCharts(user.id);

            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('dash').style.display = 'flex';

        } catch (err) {
            console.error('Dashboard error:', err);
            document.getElementById('loading-state').innerHTML = `
                <div class="loading" style="color:var(--punch);">
                    Error loading dashboard. <a href="/login/" style="color:var(--blue);">Log in again â†’</a>
                </div>`;
        }
    }

    // â”€â”€ HERO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderHero(user, stats, lvInfo, progress) {
        const hero = document.getElementById('dash-hero');
        const xpIn  = stats.xp % 500;
        const xpPct = Math.min(100, Math.round((xpIn / 500) * 100));
        const xpLeft = 500 - xpIn;

        hero.innerHTML = `
            <div class="dh-top">
                <div>
                    <div class="dh-greet">Your Dashboard</div>
                    <div class="dh-name">${user.name}</div>
                    <div class="dh-sub">${lvInfo.name} Â· ${stats.lessonsCompleted} lessons</div>
                </div>
                <div class="dh-streak">
                    <span class="dh-sfire">ğŸ”¥</span>
                    <span class="dh-snum">${stats.streak}</span>
                    <span class="dh-sword">Day Streak</span>
                </div>
            </div>
            <div class="dh-stats">
                <div class="dh-stat"><span class="dh-stat-n">${stats.lessonsCompleted}</span><span class="dh-stat-l">Lessons</span></div>
                <div class="dh-stat"><span class="dh-stat-n">${stats.xp.toLocaleString()}</span><span class="dh-stat-l">Total XP</span></div>
                <div class="dh-stat"><span class="dh-stat-n">${stats.achievementCount}</span><span class="dh-stat-l">Achievements</span></div>
            </div>
            <div class="dh-xp">
                <div class="dh-xp-row"><span>Level ${stats.level}</span><span>${xpLeft} XP to Level ${stats.level + 1}</span></div>
                <div class="dh-xp-track"><div class="dh-xp-fill" id="xp-fill"></div></div>
            </div>`;

        requestAnimationFrame(() => setTimeout(() => {
            const f = document.getElementById('xp-fill');
            if (f) f.style.width = xpPct + '%';
        }, 80));
    }

    // â”€â”€ STAT CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderStatCards(stats, progress) {
        const wrap = document.getElementById('stat-cards');
        wrap.innerHTML = `
            <div class="stat-card c-yellow">
                <div class="stat-card-label">Level & XP</div>
                <div class="stat-card-value">Lv ${stats.level}</div>
                <div class="stat-card-sub">${stats.xp.toLocaleString()} XP total</div>
                <div class="stat-card-bar"><div class="stat-card-fill" style="width:${progress.percent}%;background:var(--yellow);"></div></div>
                <div style="font-size:11px;font-weight:800;color:var(--ink-3);margin-top:6px;">${progress.remaining} XP to Level ${stats.level + 1}</div>
            </div>
            <div class="stat-card c-punch">
                <div class="stat-card-label">Streak</div>
                <div class="stat-card-value" style="font-size:44px;line-height:1;">ğŸ”¥</div>
                <div class="stat-card-sub">${stats.streak} days in a row</div>
                <div style="font-size:11px;font-weight:800;color:var(--ink-3);margin-top:6px;">${stats.streakMessage}</div>
            </div>
            <div class="stat-card c-blue">
                <div class="stat-card-label">Achievements</div>
                <div class="stat-card-value">${stats.achievementCount}</div>
                <div class="stat-card-sub">Unlocked</div>
                <a class="stat-card-link" href="#achievements">View all â†’</a>
            </div>`;
    }

    // â”€â”€ BADGE COLLECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function renderBadgeCollection(userId) {
        if (!window.EFCD_Badges || !window.EFCD_Auth) return;
        const profile = window.EFCD_Auth.getCurrentUser();
        if (!profile) return;

        try {
            const { data: lessons } = await window.efcdSupabaseClient
                .from('lessons')
                .select('vocabulary, lesson_level')
                .eq('user_id', userId);

            const gridHTML = window.EFCD_Badges.renderGrid(profile, lessons || []);

            const wrap = document.getElementById('badge-collection-wrap');
            if (wrap) {
                wrap.innerHTML = `
                    <div class="sec-label">ğŸ… Badge Collection</div>
                    ${gridHTML}`;
            }
        } catch (err) {
            console.warn('Badge grid error:', err);
        }
    }

        async function renderTrackMasterySection(userId) {
    if (!window.EFCD_TrackMastery) return;

    try {
        const { data: lessons } = await window.efcdSupabaseClient
            .from('lessons')
            .select('lesson_link')
            .eq('user_id', userId);

        const masteryHTML = window.EFCD_TrackMastery.render(lessons || []);

        const wrap = document.getElementById('track-mastery-wrap');
        if (wrap) {
            wrap.innerHTML = `
                <div class="sec-label">ğŸ—ºï¸ Track Mastery</div>
                ${masteryHTML}`;
        }
    } catch (err) {
        console.warn('Track mastery error:', err);
    }
}

    // â”€â”€ LEGACY ACHIEVEMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderAchievements(unlocked) {
        const grid = document.getElementById('ach-grid');
        if (!grid || !window.EFCD_Auth?.ACHIEVEMENTS) return;
        let html = '';
        for (const [id, ach] of Object.entries(window.EFCD_Auth.ACHIEVEMENTS)) {
            const on = unlocked.includes(id);
            html += `
                <div class="ach-badge ${on ? 'unlocked' : 'locked'}">
                    <span class="ach-icon">${ach.icon}</span>
                    <div class="ach-name">${ach.name}</div>
                    <div class="ach-desc">${ach.description}</div>
                    ${on ? '<span class="ach-tick">âœ“ Unlocked</span>' : ''}
                </div>`;
        }
        grid.innerHTML = html;
    }

    // â”€â”€ LEADERBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadLeaderboard(currentUserId) {
        try {
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const { data: users, error } = await window.efcdSupabaseClient
                .from('profiles')
                .select('id, full_name, xp, streak, level')
                .gte('last_lesson_date', weekAgo.toISOString().split('T')[0])
                .order('xp', { ascending: false })
                .limit(10);

            const lbRows = document.getElementById('lb-rows');
            if (!lbRows) return;

            if (error || !users?.length) {
                lbRows.innerHTML = `<div style="padding:32px;text-align:center;color:var(--ink-3);font-weight:800;">No active learners yet â€” complete a lesson to appear here! ğŸ†</div>`;
                return;
            }

            const em = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
            lbRows.innerHTML = users.map((u, i) => {
                const you = u.id === currentUserId;
                const rank = em[i] || (i + 1);
                return `<div class="lb-row${you ? ' you' : ''}">
                    <span class="lb-rank">${rank}</span>
                    <div class="lb-av">${(u.full_name||'C')[0].toUpperCase()}</div>
                    <span class="lb-name">${u.full_name || 'Cool Dude'}${you ? ' <span style="color:var(--blue);font-size:12px;">(you)</span>' : ''}</span>
                    <span class="lb-xp">${(u.xp||0).toLocaleString()} XP</span>
                </div>`;
            }).join('');
        } catch(err) { console.error('LB error:', err); }
    }

    // â”€â”€ LOAD LESSONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadLessons(userId) {
        try {
            const { data: lessons, error } = await window.efcdSupabaseClient
                .from('lessons').select('*').eq('user_id', userId)
                .order('completed_at', { ascending: false }).limit(20);

            if (error) { console.error('Lessons error:', error); return; }

            if (!lessons?.length) {
                document.getElementById('lesson-list').style.display = 'none';
                document.getElementById('no-lessons').style.display = 'block';
                return;
            }
            renderLessons(lessons);
        } catch(err) { console.error('Load lessons error:', err); }
    }

    function renderLessons(lessons) {
        const list = document.getElementById('lesson-list');
        const none = document.getElementById('no-lessons');
        if (!lessons?.length) {
            list.style.display = 'none';
            list.innerHTML = '';
            none.style.display = 'block';
            return;
        }
        none.style.display = 'none';
        list.style.display = 'grid';

        list.innerHTML = lessons.map(lesson => {
            const date = new Date(lesson.completed_at).toLocaleDateString('en-GB', { day:'numeric', month:'short', year:'numeric' });

            let vocabHTML = '';
            if (lesson.vocabulary?.length) {
                const words = lesson.vocabulary.map(item =>
                    `<span class="vocab-word" onclick="showVocabPopup(event,'${ea(item.word||'')}','${ea(item.definition||'')}')">${item.word||''}</span>`
                ).join('');
                vocabHTML = `<div class="vocab-section"><h4>ğŸ“š Saved words (${lesson.vocabulary.length}) â€” click to review</h4><div class="vocab-list">${words}</div></div>`;
            }

            let grammarHTML = '';
            if (lesson.grammar?.length) {
                const items = lesson.grammar.map((item, idx) => `
                    <div class="grammar-item">
                        <div style="font-weight:800;margin-bottom:5px;">${idx+1}. ${item.question||''}</div>
                        <div style="color:var(--green-shadow);font-weight:800;">âœ“ ${item.answer||''}</div>
                        <div style="color:var(--ink-3);font-size:.9em;margin-top:3px;">${item.explanation||''}</div>
                    </div>`).join('');
                grammarHTML = `<div class="grammar-section"><h4>âœï¸ Grammar (${lesson.grammar.length} exercises)</h4>${items}</div>`;
            }

            return `
                <div class="lesson-card" id="lc-${lesson.id}">
                    <div class="lc-head">
                        <div class="lc-title"><a href="${lesson.lesson_link||'#'}">${lesson.lesson_title}</a></div>
                        <button class="btn-del" onclick="confirmDel('${lesson.id}','${ea(lesson.lesson_title)}')" title="Remove">âœ•</button>
                    </div>
                    <div class="lc-meta">${lesson.lesson_level||'Lesson'} Â· Completed ${date}</div>
                    ${vocabHTML}
                    ${grammarHTML}
                </div>`;
        }).join('');
    }

    function ea(s) { return String(s).replace(/'/g,"\\'").replace(/"/g,'&quot;'); }

    // â”€â”€ DELETE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function confirmDel(id, title) {
        showConfirm({ title:'Remove this lesson?', message:`"${title}" will be removed. Your XP and streak are safe!`, onConfirm: () => delLesson(id) });
    }
    async function delLesson(id) {
        try {
            const { error } = await window.efcdSupabaseClient.from('lessons').delete().eq('id', id);
            if (error) throw error;
            const card = document.getElementById(`lc-${id}`);
            if (card) {
                card.style.transition = 'all .3s';
                card.style.opacity = '0';
                card.style.transform = 'scale(.92)';
                setTimeout(() => {
                    card.remove();
                    if (!document.querySelectorAll('.lesson-card').length) {
                        document.getElementById('lesson-list').style.display = 'none';
                        document.getElementById('no-lessons').style.display = 'block';
                    }
                }, 320);
            }
            showToast('âœ… Lesson removed â€” XP is safe!', 'success');
        } catch(err) { showToast('âŒ Could not delete. Try again.', 'error'); }
    }

    function confirmClearAll() {
        showConfirm({ title:'Clear all lessons?', message:'All lessons removed. XP, streak & achievements are safe!', onConfirm: clearAll });
    }
    async function clearAll() {
        try {
            const user = window.EFCD_Auth.getCurrentUser();
            if (!user) return;
            const { error } = await window.efcdSupabaseClient.from('lessons').delete().eq('user_id', user.id);
            if (error) throw error;
            const cards = document.querySelectorAll('.lesson-card');
            cards.forEach((c, i) => setTimeout(() => { c.style.transition = 'all .25s'; c.style.opacity = '0'; c.style.transform = 'scale(.9)'; }, i * 50));
            setTimeout(() => {
                document.getElementById('lesson-list').style.display = 'none';
                document.getElementById('lesson-list').innerHTML = '';
                document.getElementById('no-lessons').style.display = 'block';
            }, cards.length * 50 + 300);
            showToast('âœ… Dashboard cleared! XP & streak are safe ğŸ”¥', 'success');
        } catch(err) { showToast('âŒ Could not clear. Try again.', 'error'); }
    }

    // â”€â”€ VOCAB POPUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showVocabPopup(event, word, definition) {
        event.stopPropagation();
        const popup = document.getElementById('vocab-popup');
        popup.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <strong style="font-size:18px;color:var(--blue);">${word}</strong>
                <button onclick="speakWord('${word.replace(/'/g,"\\'")}');this.textContent='ğŸ”Š â–¶'" style="background:var(--bg);border:2px solid var(--border);border-bottom:3px solid var(--border-heavy);width:36px;height:36px;border-radius:10px;cursor:pointer;font-size:16px;">ğŸ”Š</button>
            </div>
            <div style="color:var(--ink);font-weight:700;line-height:1.6;">${definition}</div>
            <button onclick="document.getElementById('vocab-popup').style.display='none'" style="margin-top:14px;background:var(--bg);color:var(--ink-3);border:2px solid var(--border);border-bottom:3px solid var(--border-heavy);padding:8px;border-radius:var(--rsm);width:100%;font-size:13px;font-weight:900;cursor:pointer;font-family:inherit;">Close</button>`;
        popup.style.display = 'block';
        popup.style.top  = (event.clientY + 10) + 'px';
        popup.style.left = (event.clientX + 10) + 'px';
        setTimeout(() => {
            const r = popup.getBoundingClientRect();
            if (r.right  > window.innerWidth)  popup.style.left = (window.innerWidth  - r.width  - 20) + 'px';
            if (r.bottom > window.innerHeight) popup.style.top  = (event.clientY - r.height - 10) + 'px';
        }, 10);
    }
    function speakWord(word) {
        const u = new SpeechSynthesisUtterance(word);
        u.lang = 'en-GB'; u.rate = 0.9;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
    }
    document.addEventListener('click', e => {
        const p = document.getElementById('vocab-popup');
        if (p && !p.contains(e.target) && !e.target.classList.contains('vocab-word')) p.style.display = 'none';
    });

    // â”€â”€ CHARTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function renderProgressCharts(userId) {
        const { data: lessons } = await window.efcdSupabaseClient
            .from('lessons').select('*').eq('user_id', userId)
            .order('completed_at', { ascending: true });
        if (!lessons?.length) return;
        renderVocabChart(lessons);
        renderActivityChart(lessons);
        await renderStreakCalendar();
    }

    function renderVocabChart(lessons) {
        let total = 0;
        const data = lessons.map(l => {
            total += l.vocabulary?.length || 0;
            return { date: new Date(l.completed_at).toLocaleDateString('en-GB',{month:'short',day:'numeric'}), total };
        });
        const ctx = document.getElementById('vocabChart');
        if (!ctx) return;
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(d => d.date),
                datasets: [{ label:'Total Words', data: data.map(d => d.total), borderColor:'#FFC800', backgroundColor:'rgba(255,200,0,.1)', fill:true, tension:.4, borderWidth:3, pointBackgroundColor:'#FFC800' }]
            },
            options: { responsive:true, maintainAspectRatio:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true,ticks:{color:'#AFAFAF'},grid:{color:'#F0F0F0'}},x:{ticks:{color:'#AFAFAF',maxRotation:45},grid:{display:false}}} }
        });
    }

    function renderActivityChart(lessons) {
        const today = new Date();
        const days = Array.from({length:7},(_,i) => {
            const d = new Date(today); d.setDate(d.getDate() - (6 - i));
            return { day: d.toLocaleDateString('en-GB',{weekday:'short'}), count: lessons.filter(l => new Date(l.completed_at).toDateString() === d.toDateString()).length };
        });
        const ctx = document.getElementById('activityChart');
        if (!ctx) return;
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: days.map(d => d.day),
                datasets: [{ label:'Lessons', data: days.map(d => d.count), backgroundColor:'#1CB0F6', borderRadius:8 }]
            },
            options: { responsive:true, maintainAspectRatio:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true,ticks:{stepSize:1,color:'#AFAFAF'},grid:{color:'#F0F0F0'}},x:{ticks:{color:'#AFAFAF'},grid:{display:false}}} }
        });
    }

    async function renderStreakCalendar() {
        const cal = document.getElementById('streak-cal');
        if (!cal) return;
        const user = window.EFCD_Auth.getCurrentUser();
        if (!user) return;

        const { data: lessons } = await window.efcdSupabaseClient
            .from('lessons').select('completed_at').eq('user_id', user.id);

        const done = new Set((lessons||[]).map(l => new Date(l.completed_at).toDateString()));
        const today = new Date();

        cal.innerHTML = Array.from({length:30},(_,i) => {
            const d = new Date(today); d.setDate(d.getDate() - (29 - i));
            const isToday = i === 29;
            const hasDone = done.has(d.toDateString());
            return `<div class="cal-day ${hasDone?'done':'empty'} ${isToday?'today':''}" title="${d.toLocaleDateString('en-GB')}${hasDone?' âœ“':''}">
                ${hasDone ? 'ğŸ”¥' : d.getDate()}
            </div>`;
        }).join('');
    }

    // â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.addEventListener('DOMContentLoaded', loadDashboard);

    </script>
</body>
</html>
