<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pre-Intermediate English Lesson - Greetings</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- BRANDING & LAYOUT STYLES (Based on Rebrand Example) --- */
        body {
            font-family: 'Nunito', sans-serif;
            background: #F8F9FA; /* Light background */
            min-height: 100vh;
            color: #343A40; /* Dark text */
        }

        .game-container {
            max-width: 960px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* Utility classes for easy color reference */
        .brand-primary { color: #007BFF; } /* Blue */
        .brand-secondary { color: #28A745; } /* Green */
        .bg-brand-primary { background-color: #007BFF; }
        .bg-brand-secondary { background-color: #28A745; }

        /* Custom Card Style */
        .lesson-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin: 1.5rem 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
        }
        
        /* Stats Bar Custom Styles */
        .stats-bar {
            border-radius: 12px;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: #007BFF; /* Primary color for values */
        }

        /* Progress Bar */
        .progress-bar-bg {
            background-color: #E9ECEF;
            height: 10px;
            border-radius: 5px;
        }

        .progress-fill {
            background-color: #28A745; /* Green for progress */
            transition: width 0.5s ease-out;
            border-radius: 5px;
        }

        /* Activity Instructions */
        .activity-instructions {
            border-left: 4px solid #FFC107; /* Yellow accent */
            background-color: #FFF3CD;
            color: #856404;
            padding: 1rem;
            border-radius: 6px;
            font-size: 0.95rem;
        }
        
        /* Match/Option Items */
        .match-item, .option {
            transition: all 0.2s ease;
            user-select: none;
            cursor: pointer;
            border: 2px solid #E9ECEF;
        }

        .match-item:hover:not(.correct):not(.disabled),
        .option:hover:not(.correct):not(.disabled) {
            border-color: #007BFF; /* Blue hover */
        }
        
        /* General Selection Style for Match/Option/Word/Gap */
        .selected {
            background-color: #E6F7FF !important; /* Light blue background */
            border-color: #007BFF !important;
            color: #007BFF !important;
            font-weight: 700;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.5); /* Blue glow */
        }
        
        /* Correct/Incorrect feedback for matches/options */
        .correct {
            background-color: #D4EDDA !important; /* Light green */
            border-color: #28A745 !important;
            color: #155724 !important;
        }

        .incorrect {
            background-color: #F8D7DA !important; /* Light red */
            border-color: #DC3545 !important;
            color: #721C24 !important;
            animation: none !important; /* Remove shake if used */
        }
        
        /* Word Bank Click Styles */
        .word-item-drag { /* Reusing the old D&D class for styling consistency */
            background-color: #007BFF;
            color: white;
            box-shadow: 0 2px 4px rgba(0, 123, 255, 0.4);
            transition: background-color 0.2s;
            cursor: pointer;
            border: 2px solid transparent; /* Required for the selected border */
        }

        .word-item-drag:hover:not(.used) {
            background-color: #0056b3;
        }

        .word-item-drag.used {
            background-color: #E9ECEF;
            color: #6C757D;
            cursor: not-allowed;
            border-color: #CED4DA !important;
            box-shadow: none;
        }

        .gap-fill-drop-zone {
            border-bottom: 3px solid #007BFF;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .gap-fill-drop-zone.filled {
            color: #343A40;
            background-color: #F8F9FA;
            border-bottom: 3px solid #28A745;
            font-weight: 700;
            min-width: 120px !important;
            padding: 2px 5px;
        }
        
        .gap-fill-drop-zone.selected {
            background-color: #E6F7FF !important;
            border-bottom-color: #007BFF !important;
            box-shadow: 0 3px 0 rgba(0, 123, 255, 0.5);
        }

        .gap-fill-drop-zone.correct-answer {
            border-bottom-color: #28A745 !important;
            background-color: #D4EDDA !important;
        }

        .gap-fill-drop-zone.incorrect-answer {
            border-bottom-color: #DC3545 !important;
            background-color: #F8D7DA !important;
        }

        /* Buttons */
        .btn-primary {
            background-color: #007BFF;
            transition: background-color 0.2s;
        }
        .btn-primary:hover:not(:disabled) { background-color: #0056b3; }

        .btn-success {
            background-color: #28A745;
            transition: background-color 0.2s;
        }
        .btn-success:hover:not(:disabled) { background-color: #1e7e34; }

        .btn-warning {
            background-color: #FFC107;
            color: #343A40;
            transition: background-color 0.2s;
        }
        .btn-warning:hover:not(:disabled) { background-color: #e0a800; }

        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* General Feedback/Animations */
        .hidden { display: none !important; }
        
        .points-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #28A745;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1.5rem;
            font-weight: bold;
            z-index: 1000;
            animation: pointsFloat 2s ease-out forwards;
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.5);
        }

        @keyframes pointsFloat {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            30% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -80px) scale(1); }
        }

        .sticker {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: 5rem;
            opacity: 0;
            animation: stickerPop 1s forwards;
            pointer-events: none;
            z-index: 1000;
        }

        @keyframes stickerPop {
            0% { transform: translate(-50%, -50%) scale(0.5) rotate(-20deg); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2) rotate(10deg); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 0; }
        }

    </style>
</head>
<body>
    <div class="game-container">
        <header class="text-center pt-4 pb-2">
            <h1 class="text-3xl font-extrabold text-gray-800 mb-2">ü§ù English Adventure: Greetings ü§ù</h1>
            <div class="inline-block px-3 py-1 text-sm font-semibold rounded-full text-white bg-brand-secondary">
                Level <span id="currentLevel">1</span>
            </div>
        </header>

        <div class="stats-bar p-4 md:p-6 mb-6">
            <div class="progress-bar-bg mb-4">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>

            <div class="flex justify-around text-center">
                <div class="stat-item">
                    <div class="stat-value" id="totalPoints">0</div>
                    <div class="text-sm text-gray-600">Points</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="streak">0</div>
                    <div class="text-sm text-gray-600">Streak</div>
                </div>
          
            </div>
        </div>

        <div class="achievement hidden bg-yellow-100 text-yellow-800 p-3 rounded-lg font-bold text-center mb-4" id="achievement"></div>
        <div class="timer hidden fixed top-4 right-4 bg-red-600 text-white p-2 rounded-full font-bold z-50" id="timer">‚è∞ 30s</div>

        <div class="lesson-card" id="activity1">
            <h2 class="text-2xl font-bold brand-primary mb-4">üéØ Activity 1: Greetings & Replies</h2>
            <div class="activity-instructions mb-6">
                Match the common greeting with the correct reply. Tap on a phrase from the left column, then tap on its matching reply from the right column!
            </div>
            
            <div class="grid grid-cols-2 gap-4 md:gap-8 matching-container">
                <div class="matching-column">
                    <h4 class="text-lg font-semibold brand-primary mb-3 p-2 bg-blue-50 rounded-lg">üîµ Greetings</h4>
                    <div class="match-item vocabulary p-3 rounded-lg shadow-sm" data-match="1">How's it going?</div>
                    <div class="match-item vocabulary p-3 rounded-lg shadow-sm" data-match="2">Nice to meet you.</div>
                    <div class="match-item vocabulary p-3 rounded-lg shadow-sm" data-match="3">What have you been up to?</div>
                    <div class="match-item vocabulary p-3 rounded-lg shadow-sm" data-match="4">Good morning!</div>
                    <div class="match-item vocabulary p-3 rounded-lg shadow-sm" data-match="5">I'm so sorry.</div>
                    <div class="match-item vocabulary p-3 rounded-lg shadow-sm" data-match="6">Can you help me?</div>
                </div>
                
                <div class="matching-column">
                    <h4 class="text-lg font-semibold text-yellow-800 mb-3 p-2 bg-yellow-50 rounded-lg">üü° Replies</h4>
                    <div class="match-item definition p-3 rounded-lg shadow-sm" data-match="5">That's alright.</div>
                    <div class="match-item definition p-3 rounded-lg shadow-sm" data-match="3">Not much, just working a lot.</div>
                    <div class="match-item definition p-3 rounded-lg shadow-sm" data-match="1">It's going well, thanks!</div>
                    <div class="match-item definition p-3 rounded-lg shadow-sm" data-match="6">Sure, what do you need?</div>
                    <div class="match-item definition p-3 rounded-lg shadow-sm" data-match="2">You too.</div>
                    <div class="match-item definition p-3 rounded-lg shadow-sm" data-match="4">Morning! How are you?</div>
                </div>
            </div>
            
            <div class="text-center mt-6 text-lg font-semibold text-gray-700">
                <span id="matchScore">Matches: 0/6</span>
            </div>
            
            <div class="feedback-message mt-4 p-3 rounded-lg text-center hidden" id="matching-feedback"></div>
            <div class="text-center mt-6">
                <button class="btn next-activity-btn bg-brand-primary text-white font-bold py-2 px-6 rounded-full shadow-md hover:shadow-lg transition duration-200" id="matching-next" onclick="nextActivity()" style="display:none;">Continue to Next Activity ‚û°Ô∏è</button>
            </div>
        </div>

        <div class="lesson-card hidden" id="activity2">
            <h2 class="text-2xl font-bold brand-primary mb-4">üìñ Activity 2: Reading Comprehension</h2>
            <div class="activity-instructions mb-6">
                Read the short dialogue, then answer the questions below.
            </div>
            
            <div class="p-4 bg-gray-50 border-l-4 border-brand-primary rounded-lg italic mb-6">
                <strong class="brand-primary not-italic">Making Plans</strong><br><br>
                **Leo:** Hey Sarah, how's it going? I'm calling to see if you want to hang out this weekend.<br>
                **Sarah:** Hi Leo! It's going well, thanks. I'd love to! I'm a bit busy on Saturday morning, but what about the afternoon?<br>
                **Leo:** That works for me! My brother is in town, so maybe we could all catch a movie? The new superhero film is out.<br>
                **Sarah:** Oh, that sounds fantastic! I've been looking forward to that. We should meet up around 3 PM at the cinema. I can't wait!<br>
                **Leo:** Me too! See you Saturday!
            </div>

            <div class="question-container mb-6" id="reading-q1">
                <div class="text-lg font-semibold mb-3">1. Why is Leo calling Sarah?</div>
                <div class="options grid gap-3">
                    <div class="option p-3 rounded-lg shadow-sm" data-answer="correct">To make plans for the weekend.</div>
                    <div class="option p-3 rounded-lg shadow-sm" data-answer="wrong">To borrow some money.</div>
                    <div class="option p-3 rounded-lg shadow-sm" data-answer="wrong">To talk about the weather.</div>
                </div>
            </div>
            
            <div class="question-container mb-6" id="reading-q2">
                <div class="text-lg font-semibold mb-3">2. Which part of Saturday is Sarah available?</div>
                <div class="options grid gap-3">
                    <div class="option p-3 rounded-lg shadow-sm" data-answer="wrong">The morning.</div>
                    <div class="option p-3 rounded-lg shadow-sm" data-answer="correct">The afternoon.</div>
                    <div class="option p-3 rounded-lg shadow-sm" data-answer="wrong">All day.</div>
                </div>
            </div>

            <div class="question-container mb-6" id="reading-q3">
                <div class="text-lg font-semibold mb-3">3. What does Sarah mean when she says she "can't wait"?</div>
                <div class="options grid gap-3">
                    <div class="option p-3 rounded-lg shadow-sm" data-answer="wrong">She is not able to wait.</div>
                    <div class="option p-3 rounded-lg shadow-sm" data-answer="correct">She is very excited for the movie.</div>
                    <div class="option p-3 rounded-lg shadow-sm" data-answer="wrong">She has to leave soon.</div>
                </div>
            </div>
            
            <div class="feedback-message mt-4 p-3 rounded-lg text-center hidden" id="reading-feedback"></div>
            <div class="text-center mt-6">
                <button class="btn check-btn bg-brand-primary text-white font-bold py-2 px-6 rounded-full shadow-md hover:shadow-lg transition duration-200" id="reading-check-btn" onclick="checkReadingAnswers()">Check Answers ‚úì</button>
                <button class="btn next-activity-btn bg-brand-primary text-white font-bold py-2 px-6 rounded-full shadow-md hover:shadow-lg transition duration-200" id="reading-next" onclick="nextActivity()" style="display:none;">Continue to Next Activity ‚û°Ô∏è</button>
                <button class="btn try-again-btn bg-yellow-500 text-white font-bold py-2 px-6 rounded-full shadow-md hover:shadow-lg transition duration-200" id="reading-retry" onclick="retryActivity(2)" style="display:none;">Try Again üîÑ</button>
            </div>
        </div>

        <div class="lesson-card hidden" id="activity3">
            <h2 class="text-2xl font-bold brand-primary mb-4">üí¨ Activity 3: Conversation Gap-Fill</h2>
            <div class="activity-instructions mb-6">
                **Click** a word from the bank, then **click** the gap to fill it. Click a filled gap to remove the word.
            </div>
            
            <div class="word-bank-drag flex flex-wrap gap-3 p-4 bg-gray-50 border-2 border-dashed border-brand-primary rounded-lg mb-6" id="wordBankConversation">
                <div class="word-bank-title w-full font-bold brand-primary mb-2">üìù Word Bank - Click the words:</div>
                <span class="word-item-drag py-2 px-4 rounded-full font-bold" data-word="for ages">for ages</span>
                <span class="word-item-drag py-2 px-4 rounded-full font-bold" data-word="anything interesting">anything interesting</span>
                <span class="word-item-drag py-2 px-4 rounded-full font-bold" data-word="just been">just been</span>
                <span class="word-item-drag py-2 px-4 rounded-full font-bold" data-word="a while">a while</span>
                <span class="word-item-drag py-2 px-4 rounded-full font-bold" data-word="up to">up to</span>
            </div>
            
            <div class="p-4 bg-blue-50 border-l-4 border-brand-primary rounded-lg">
                <div class="gap-sentence mb-4 text-gray-700">**A:** Hey, long time no see! It's been <span class="gap-fill-drop-zone inline-block min-w-[80px] text-center px-2 py-1 font-bold" data-correct="a while"></span>.</div>
                <div class="gap-sentence mb-4 text-gray-700">**B:** I know! I've been so busy. What have you been <span class="gap-fill-drop-zone inline-block min-w-[80px] text-center px-2 py-1 font-bold" data-correct="up to"></span>?</div>
                <div class="gap-sentence mb-4 text-gray-700">**A:** Not much, really. I've <span class="gap-fill-drop-zone inline-block min-w-[80px] text-center px-2 py-1 font-bold" data-correct="just been"></span> working a lot. Have you seen <span class="gap-fill-drop-zone inline-block min-w-[80px] text-center px-2 py-1 font-bold" data-correct="anything interesting"></span> lately?</div>
                <div class="gap-sentence text-gray-700">**B:** Oh yes, I went to a great concert! We should catch up properly soon, I haven't seen you <span class="gap-fill-drop-zone inline-block min-w-[80px] text-center px-2 py-1 font-bold" data-correct="for ages"></span>.</div>
            </div>
            
            <div class="feedback-message mt-4 p-3 rounded-lg text-center hidden" id="conversation-feedback"></div>
            <div class="text-center mt-6">
                <button class="btn check-btn bg-brand-primary text-white font-bold py-2 px-6 rounded-full shadow-md hover:shadow-lg transition duration-200" id="conversation-check-btn" onclick="checkConversationFill()">Check Answers ‚úì</button>
                <button class="btn next-activity-btn bg-brand-primary text-white font-bold py-2 px-6 rounded-full shadow-md hover:shadow-lg transition duration-200" id="conversation-next" onclick="nextActivity()" style="display:none;">Continue to Next Activity ‚û°Ô∏è</button>
                <button class="btn try-again-btn bg-yellow-500 text-white font-bold py-2 px-6 rounded-full shadow-md hover:shadow-lg transition duration-200" id="conversation-retry" onclick="retryActivity(3)" style="display:none;">Try Again üîÑ</button>
            </div>
        </div>

        <div class="lesson-card hidden" id="activity4">
            <h2 class="text-2xl font-bold brand-primary mb-4">‚ñ∂Ô∏è Watch and Learn!</h2>
            <div class="activity-instructions mb-6">
                Before the next activity, let's watch a short video to learn new ways to greet people.
            </div>
            <div class="relative w-full pb-[56.25%] mb-6">
                <iframe class="absolute top-0 left-0 w-full h-full rounded-xl" src="https://www.youtube.com/embed/I_tRSrPru94" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
            <div class="text-center mt-6">
                <a href="https://www.youtube.com/watch?v=I_tRSrPru94" target="_blank" class="inline-block bg-red-600 text-white font-bold py-2 px-6 rounded-full shadow-md hover:bg-red-700 transition duration-200">Watch on YouTube ‚ÜóÔ∏è</a>
                <button class="btn next-activity-btn bg-brand-primary text-white font-bold py-2 px-6 rounded-full shadow-md hover:shadow-lg transition duration-200 ml-4" id="video-next" style="display:inline-block;" onclick="nextActivity()">Continue to Next Activity ‚û°Ô∏è</button>
            </div>
        </div>

        <div class="lesson-card hidden" id="activity5">
            <h2 class="text-2xl font-bold brand-primary mb-4">üí¨ Activity 5: Greetings & Goodbyes</h2>
            <div class="activity-instructions mb-6">
                Based on the video, choose the correct option.
            </div>
            <div class="question-container mb-6" id="greetings-q1">
                <div class="text-lg font-semibold mb-3">1. Which of these is a casual way to say "hello" from the video?</div>
                <div class="options grid gap-3">
                    <div class="option p-3 rounded-lg shadow-sm" data-answer="wrong">"Good day."</div>
                    <div class="option p-3 rounded-lg shadow-sm" data-answer="correct">"Hiya."</div>
                    <div class="option p-3 rounded-lg shadow-sm" data-answer="wrong">"Greetings."</div>
                </div>
            </div>
            <div class="question-container mb-6" id="greetings-q2">
                <div class="text-lg font-semibold mb-3">2. Which of these is not a way to say goodbye?</div>
                <div class="options grid gap-3">
                    <div class="option p-3 rounded-lg shadow-sm" data-answer="correct">"Alright!"</div>
                    <div class="option p-3 rounded-lg shadow-sm" data-answer="wrong">"See you later!"</div>
                    <div class="option p-3 rounded-lg shadow-sm" data-answer="wrong">"Cheerio!"</div>
                </div>
            </div>
            <div class="feedback-message mt-4 p-3 rounded-lg text-center hidden" id="greetings-feedback"></div>
            <div class="text-center mt-6">
                <button class="btn check-btn bg-brand-primary text-white font-bold py-2 px-6 rounded-full shadow-md hover:shadow-lg transition duration-200" id="greetings-check-btn" onclick="checkGreetingsQuiz()">Check Answers ‚úì</button>
                <button class="btn next-activity-btn bg-brand-primary text-white font-bold py-2 px-6 rounded-full shadow-md hover:shadow-lg transition duration-200" id="greetings-next" onclick="nextActivity()" style="display:none;">Continue to Next Activity ‚û°Ô∏è</button>
                <button class="btn try-again-btn bg-yellow-500 text-white font-bold py-2 px-6 rounded-full shadow-md hover:shadow-lg transition duration-200" id="greetings-retry" onclick="retryActivity(5)" style="display:none;">Try Again üîÑ</button>
            </div>
        </div>

        <div class="lesson-card hidden" id="activity6">
            <h2 class="text-2xl font-bold brand-primary mb-4">üéØ Activity 6: Click-Fill the Gaps</h2>
            <div class="activity-instructions mb-6">
                **Click** a word from the bank, then **click** the gap to fill it. Click a filled gap to remove the word.
            </div>
            
            <div class="word-bank-drag flex flex-wrap gap-3 p-4 bg-gray-50 border-2 border-dashed border-brand-primary rounded-lg mb-6" id="wordBankGap">
                <div class="word-bank-title w-full font-bold brand-primary mb-2">üìù Word Bank - Click the words:</div>
                <span class="word-item-drag py-2 px-4 rounded-full font-bold" data-word="looking forward to">looking forward to</span>
                <span class="word-item-drag py-2 px-4 rounded-full font-bold" data-word="this is">this is</span>
                <span class="word-item-drag py-2 px-4 rounded-full font-bold" data-word="Pleased to meet you">Pleased to meet you</span>
                <span class="word-item-drag py-2 px-4 rounded-full font-bold" data-word="a bit busy">a bit busy</span>
                <span class="word-item-drag py-2 px-4 rounded-full font-bold" data-word="can't wait">can't wait</span>
            </div>
            
            <div class="p-4 bg-blue-50 border-l-4 border-brand-primary rounded-lg">
                <div class="gap-sentence mb-4 text-gray-700">I'm really <span class="gap-fill-drop-zone inline-block min-w-[80px] text-center px-2 py-1 font-bold" data-correct="looking forward to"></span> my vacation next week.</div>
                <div class="gap-sentence mb-4 text-gray-700">I'm Tim and<span class="gap-fill-drop-zone inline-block min-w-[80px] text-center px-2 py-1 font-bold" data-correct="this is"></span> Georgie.</div>
                <div class="gap-sentence mb-4 text-gray-700">Hello Sian, my name's Bulli.<span class="gap-fill-drop-zone inline-block min-w-[80px] text-center px-2 py-1 font-bold" data-correct="Pleased to meet you"></span>.</div>
                <div class="gap-sentence mb-4 text-gray-700">Sorry, I'm <span class="gap-fill-drop-zone inline-block min-w-[80px] text-center px-2 py-1 font-bold" data-correct="a bit busy"></span> at the moment.</div>
                <div class="gap-sentence text-gray-700">I'm so excited about Saturday. I <span class="gap-fill-drop-zone inline-block min-w-[80px] text-center px-2 py-1 font-bold" data-correct="can't wait"></span> to see you.</div>
            </div>
            
            <div class="feedback-message mt-4 p-3 rounded-lg text-center hidden" id="gap-feedback"></div>
            <div class="text-center mt-6">
                <button class="btn check-btn bg-brand-primary text-white font-bold py-2 px-6 rounded-full shadow-md hover:shadow-lg transition duration-200" id="gap-check-btn" onclick="checkGapFill()">Check Answers ‚úì</button>
                <button class="btn next-activity-btn bg-brand-primary text-white font-bold py-2 px-6 rounded-full shadow-md hover:shadow-lg transition duration-200" id="gap-next" onclick="nextActivity()" style="display:none;">Continue to Next Activity ‚û°Ô∏è</button>
                <button class="btn try-again-btn bg-yellow-500 text-white font-bold py-2 px-6 rounded-full shadow-md hover:shadow-lg transition duration-200" id="gap-retry" onclick="retryActivity(6)" style="display:none;">Try Again üîÑ</button>
            </div>
        </div>

        <div class="lesson-card hidden" id="activity7">
            <h2 class="text-2xl font-bold brand-primary mb-4">üß† Activity 7: Final Quiz</h2>
            <div class="activity-instructions mb-6">
                Test your knowledge!
            </div>
            <div class="question-container mb-6" id="final-q1">
                <div class="text-lg font-semibold mb-3">1. What was the name of the girl wearing a jacket in the video?</div>
                <div class="options grid gap-3">
                    <div class="option p-3 rounded-lg shadow-sm" data-answer="wrong">George</div>
                    <div class="option p-3 rounded-lg shadow-sm" data-answer="correct">Sian</div>
                    <div class="option p-3 rounded-lg shadow-sm" data-answer="wrong">Buli</div>
                </div>
            </div>
            <div class="question-container mb-6" id="final-q2">
                <div class="text-lg font-semibold mb-3">2. Which of these is a formal greeting?</div>
                <div class="options grid gap-3">
                    <div class="option p-3 rounded-lg shadow-sm" data-answer="wrong">"How's it going?"</div>
                    <div class="option p-3 rounded-lg shadow-sm" data-answer="wrong">"What's up?"</div>
                    <div class="option p-3 rounded-lg shadow-sm" data-answer="correct">"Pleased to meet you."</div>
                </div>
            </div>
            <div class="question-container mb-6" id="final-q3">
                <div class="text-lg font-semibold mb-3">3. What does "Cheerio!" mean?</div>
                <div class="options grid gap-3">
                    <div class="option p-3 rounded-lg shadow-sm" data-answer="wrong">I am angry.</div>
                    <div class="option p-3 rounded-lg shadow-sm" data-answer="correct">Goodbye.</div>
                    <div class="option p-3 rounded-lg shadow-sm" data-answer="wrong">How are you, my friend?</div>
                </div>
            </div>
            <div class="feedback-message mt-4 p-3 rounded-lg text-center hidden" id="final-feedback"></div>
            <div class="text-center mt-6">
                <button class="btn check-btn bg-brand-primary text-white font-bold py-2 px-6 rounded-full shadow-md hover:shadow-lg transition duration-200" id="final-check-btn" onclick="checkFinalQuiz()">Check Answers ‚úì</button>
                <button class="btn next-activity-btn bg-brand-primary text-white font-bold py-2 px-6 rounded-full shadow-md hover:shadow-lg transition duration-200" id="final-next" onclick="nextActivity()" style="display:none;">Show Results ‚û°Ô∏è</button>
                <button class="btn try-again-btn bg-yellow-500 text-white font-bold py-2 px-6 rounded-full shadow-md hover:shadow-lg transition duration-200" id="final-retry" onclick="retryActivity(7)" style="display:none;">Try Again üîÑ</button>
            </div>
        </div>

        <div class="lesson-card hidden text-center" id="results">
            <h2 class="text-3xl font-bold brand-success mb-6">üéâ Congratulations!</h2>
            <pre class="whitespace-pre-wrap text-lg p-6 bg-gray-50 border border-gray-200 rounded-lg mb-6" id="finalResults"></pre>
            <button class="btn bg-brand-secondary text-white font-bold py-2 px-6 rounded-full shadow-md hover:shadow-lg transition duration-200" onclick="restartLesson()">üîÑ Play Again</button>
        </div>
    </div>

    <script>
        // --- Global Variables ---
        let currentActivity = 1;
        let totalPoints = 0;
        let streak = 0;
        let currentLevel = 1;
        
        // State variables for the new click-fill logic
        let selectedWordElement = null;
        let selectedGapElement = null;

        const achievements = [
            { points: 100, text: "üåü Getting Started!", unlocked: false },
            { points: 300, text: "üî• On Fire!", unlocked: false },
            { points: 500, text: "üíé Reading Master!", unlocked: false },
            { points: 700, text: "‚ö° Speed Demon!", unlocked: false },
            { points: 1000, text: "üèÜ English Champion!", unlocked: false }
        ];

        // --- Utility Functions ---
        function updateStats() {
            document.getElementById('totalPoints').textContent = totalPoints;
            document.getElementById('streak').textContent = streak;
            document.getElementById('currentLevel').textContent = currentLevel;
            const totalActivities = 7;
            // Progress calculation is based on completed activities (currentActivity - 1)
            const progress = ((currentActivity - 1) / totalActivities) * 100;
            document.getElementById('progressFill').style.width = progress.toFixed(1) + '%';

            if (totalPoints >= 300 && currentLevel === 1) {
                currentLevel = 2;
                showAchievement("üéä Level Up! Welcome to Level 2!");
            } else if (totalPoints >= 600 && currentLevel === 2) {
                currentLevel = 3;
                showAchievement("üöÄ Level Up! You reached Level 3!");
            }

            achievements.forEach(achievement => {
                if (totalPoints >= achievement.points && !achievement.unlocked) {
                    achievement.unlocked = true;
                    showAchievement(achievement.text);
                }
            });
        }

        function showAchievement(text) {
            const achievement = document.getElementById('achievement');
            achievement.textContent = text;
            achievement.classList.remove('hidden');
            setTimeout(() => {
                achievement.classList.add('hidden');
            }, 3000);
        }

        function showPointsAnimation(points) {
            const animation = document.createElement('div');
            animation.className = 'points-animation';
            animation.textContent = '+' + points + ' points!';
            document.body.appendChild(animation);
            setTimeout(() => {
                animation.remove();
            }, 2000);
        }

        function showSticker(type) {
            const sticker = document.createElement('div');
            sticker.className = 'sticker';
            if (type === 'great') {
                sticker.innerHTML = 'üíØ';
            } else if (type === 'good') {
                sticker.innerHTML = '‚ú®';
            } else {
                sticker.innerHTML = 'ü§î';
            }
            document.body.appendChild(sticker);
            setTimeout(() => {
                sticker.remove();
            }, 1000);
        }

        function showFeedback(activityId, isCorrect, message) {
            const feedbackEl = document.getElementById(activityId + '-feedback');
            feedbackEl.classList.remove('hidden');
            feedbackEl.classList.add(isCorrect ? 'bg-green-100' : 'bg-red-100');
            feedbackEl.classList.remove(isCorrect ? 'bg-red-100' : 'bg-green-100');
            feedbackEl.textContent = message;
            
            const nextBtn = document.getElementById(activityId + '-next');
            const retryBtn = document.getElementById(activityId + '-retry');
            const checkBtn = document.getElementById(activityId + '-check-btn'); // For activities with a check button
            
            if (isCorrect) {
                if (nextBtn) nextBtn.style.display = 'inline-block';
                if (retryBtn) retryBtn.style.display = 'none';
            } else {
                if (nextBtn) nextBtn.style.display = 'none';
                if (retryBtn) retryBtn.style.display = 'inline-block';
            }
            if (checkBtn) checkBtn.style.display = 'none';
        }

        function nextActivity() {
            document.getElementById('activity' + currentActivity).classList.add('hidden');
            currentActivity++;
            updateStats(); // Update progress bar
            if (currentActivity <= 7) {
                setTimeout(() => {
                    const nextActivityEl = document.getElementById('activity' + currentActivity);
                    nextActivityEl.classList.remove('hidden');
                    window.scrollTo({ top: nextActivityEl.offsetTop - 50, behavior: 'smooth' });
                }, 300);
            } else {
                showResults();
            }
        }
        
        function retryActivity(activityNum) {
            if (activityNum === 1) resetMatchingActivity();
            else if (activityNum === 2) resetReadingActivity();
            else if (activityNum === 3) resetConversationFillActivity();
            else if (activityNum === 5) resetGreetingsQuiz();
            else if (activityNum === 6) resetGapFillActivity();
            else if (activityNum === 7) resetFinalQuiz();
            
            // Hide retry and feedback, re-show check button if applicable
            document.getElementById('activity' + activityNum + '-feedback').classList.add('hidden');
            if(document.getElementById('activity' + activityNum + '-retry')) {
                document.getElementById('activity' + activityNum + '-retry').style.display = 'none';
            }
            if(document.getElementById('activity' + activityNum + '-check-btn')) {
                document.getElementById('activity' + activityNum + '-check-btn').style.display = 'inline-block';
            }
        }
        
        function showResults() {
            document.getElementById('activity' + (currentActivity - 1)).classList.add('hidden');
            document.getElementById('results').classList.remove('hidden');
            let grade = 'Good effort!';
            let emoji = 'üòä';
            if (totalPoints >= 800) {
                grade = 'LEGENDARY! üèÜ';
                emoji = 'üèÜ';
            } else if (totalPoints >= 600) {
                grade = 'Excellent! üåü';
                emoji = 'üåü';
            } else if (totalPoints >= 400) {
                grade = 'Very Good! üëç';
                emoji = 'üëç';
            } else if (totalPoints >= 200) {
                grade = 'Good Job! üòä';
                emoji = 'üòä';
            }
            
            const finalResultsText = `${emoji} You completed all activities!\n\nTotal Points: ${totalPoints}\nFinal Level: ${currentLevel}\nGrade: ${grade}\n\nYou've mastered greetings and introductions!`;
            document.getElementById('finalResults').textContent = finalResultsText;
            window.scrollTo({ top: document.getElementById('results').offsetTop - 50, behavior: 'smooth' });
        }

        function restartLesson() {
            currentActivity = 1;
            totalPoints = 0;
            streak = 0;
            currentLevel = 1;
            achievements.forEach(a => a.unlocked = false);
            
            // Reset all activities
            for (let i = 1; i <= 7; i++) {
                // Skip activity 4 (video)
                if (i !== 4) {
                     // Check if reset function exists before calling
                    const resetFunc = window['resetActivity' + i];
                    if (typeof resetFunc === 'function') {
                        resetFunc();
                    }
                    // Use generic retry function for consistency
                    retryActivity(i);
                }
            }
            
            // Show first activity
            document.querySelectorAll('.lesson-card').forEach(card => card.classList.add('hidden'));
            document.getElementById('activity1').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');
            
            updateStats();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- Activity 1: Matching Game ---
        let selectedVocab = null;
        let selectedDefinition = null;
        let matchesFound = 0;

        function resetMatchingActivity() {
            selectedVocab = null;
            selectedDefinition = null;
            matchesFound = 0;
            document.querySelectorAll('.vocabulary, .definition').forEach(item => {
                item.classList.remove('selected', 'correct', 'incorrect', 'disabled');
            });
            document.getElementById('matchScore').textContent = 'Matches: 0/6';
            document.getElementById('matching-feedback').classList.add('hidden');
            document.getElementById('matching-next').style.display = 'none';
        }

        function initializeMatchingGame() {
            document.querySelectorAll('.vocabulary, .definition').forEach(item => {
                item.addEventListener('click', function() {
                    if (this.classList.contains('correct') || this.classList.contains('disabled')) return;
                    
                    if (this.classList.contains('vocabulary')) {
                        if (selectedVocab === this) {
                            selectedVocab.classList.remove('selected');
                            selectedVocab = null;
                        } else {
                            if (selectedVocab) selectedVocab.classList.remove('selected');
                            this.classList.add('selected');
                            selectedVocab = this;
                        }
                    } else if (this.classList.contains('definition')) {
                        if (selectedDefinition === this) {
                            selectedDefinition.classList.remove('selected');
                            selectedDefinition = null;
                        } else {
                            if (selectedDefinition) selectedDefinition.classList.remove('selected');
                            this.classList.add('selected');
                            selectedDefinition = this;
                        }
                    }

                    checkMatch();
                });
            });
        }

        function checkMatch() {
            if (!selectedVocab || !selectedDefinition) return;

            if (selectedVocab.dataset.match === selectedDefinition.dataset.match) {
                // Correct match
                selectedVocab.classList.remove('selected');
                selectedVocab.classList.add('correct');
                selectedDefinition.classList.remove('selected');
                selectedDefinition.classList.add('correct');

                matchesFound++;
                document.getElementById('matchScore').textContent = `Matches: ${matchesFound}/6`;
                totalPoints += 25;
                streak++;
                showPointsAnimation(25);
                showSticker('good');
                updateStats();
                
                if (matchesFound === 6) {
                    totalPoints += 50; // Bonus for completing all
                    showPointsAnimation(50);
                    showFeedback('matching', true, 'Amazing! You matched all the phrases! üéâ');
                    // Disable remaining items to prevent further clicks
                    document.querySelectorAll('.vocabulary:not(.correct), .definition:not(.correct)').forEach(item => item.classList.add('disabled'));
                }
            } else {
                // Incorrect match - User requested: Just deselect and reset streak.
                selectedVocab.classList.remove('selected');
                selectedDefinition.classList.remove('selected');
                
                streak = 0;
                updateStats();
                showSticker('oops');
            }
            
            selectedVocab = null;
            selectedDefinition = null;
        }

        // --- Activity 2: Reading Comprehension ---
        function initializeReadingActivity() {
            document.querySelectorAll('#activity2 .option').forEach(option => {
                option.addEventListener('click', function() {
                    if (this.classList.contains('disabled')) return;
                    
                    const parent = this.closest('.options');
                    parent.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
        }

        function checkReadingAnswers() {
            let correctAnswers = 0;
            const totalQuestions = 3;
            const answers = [];
            
            for (let i = 1; i <= totalQuestions; i++) {
                const selected = document.querySelector(`#reading-q${i} .option.selected`);
                answers.push(selected);
            }

            if (answers.some(answer => !answer)) {
                showFeedback('reading', false, 'Please answer all three questions before checking.');
                document.getElementById('reading-check-btn').style.display = 'inline-block';
                document.getElementById('reading-retry').style.display = 'none';
                return;
            }

            answers.forEach((answer, index) => {
                if (answer.dataset.answer === 'correct') {
                    correctAnswers++;
                    answer.classList.add('correct');
                } else {
                    answer.classList.add('incorrect');
                    const correctOption = document.querySelector(`#reading-q${index + 1} .option[data-answer="correct"]`);
                    if (correctOption) correctOption.classList.add('correct');
                }
            });
            
            document.querySelectorAll('#activity2 .option').forEach(option => option.classList.add('disabled'));

            if (correctAnswers === totalQuestions) {
                totalPoints += 150;
                streak++;
                updateStats();
                showPointsAnimation(150);
                showSticker('great');
                showFeedback('reading', true, 'Perfect! You answered all the reading comprehension questions correctly! üìö');
            } else {
                totalPoints += correctAnswers * 25; // Partial credit
                streak = 0;
                updateStats();
                showSticker('oops');
                showFeedback('reading', false, `You got ${correctAnswers} out of ${totalQuestions} correct. Keep studying! üìñ`);
            }
        }
        
        function resetReadingActivity() {
            document.querySelectorAll('#activity2 .option').forEach(option => {
                option.classList.remove('selected', 'correct', 'incorrect', 'disabled');
            });
            // Handled by generic retryActivity
        }
        
        // --- Click-Fill Logic (Generic Functions) ---
        function fillGap(wordEl, gapEl) {
            // Unfill any gap that was previously filled by this word
            document.querySelectorAll(`.gap-fill-drop-zone`).forEach(g => {
                if (g.textContent.trim() === wordEl.dataset.word) {
                    unfillGap(g);
                }
            });

            // 1. Transfer word content
            gapEl.textContent = wordEl.dataset.word;
            gapEl.classList.add('filled');
            
            // 2. Mark word as used
            wordEl.classList.remove('selected');
            wordEl.classList.add('used');
            
            // 3. Reset selectors
            gapEl.classList.remove('selected');
            selectedWordElement = null;
            selectedGapElement = null;
        }

        function unfillGap(gapEl) {
            const word = gapEl.textContent.trim();
            const wordItem = document.querySelector(`.word-item-drag[data-word="${word}"]`);
            
            if (wordItem) {
                wordItem.classList.remove('used');
                wordItem.classList.remove('selected');
            }
            
            gapEl.textContent = '';
            gapEl.classList.remove('filled', 'selected', 'correct-answer', 'incorrect-answer');
            selectedWordElement = null;
            selectedGapElement = null;
        }

        function applyClickFillLogic(activitySelector) {
            // 1. Setup Word Clicks
            document.querySelectorAll(`${activitySelector} .word-item-drag`).forEach(item => {
                // Ensure no drag attributes remain
                item.draggable = false;
                
                item.addEventListener('click', function() {
                    if (this.classList.contains('used')) return;

                    if (selectedWordElement === this) {
                        // Deselect the current word
                        selectedWordElement.classList.remove('selected');
                        selectedWordElement = null;
                        // Clear gap selection too
                        if (selectedGapElement) selectedGapElement.classList.remove('selected');
                        selectedGapElement = null;
                    } else {
                        // Select a new word
                        if (selectedWordElement) selectedWordElement.classList.remove('selected');
                        this.classList.add('selected');
                        selectedWordElement = this;
                        
                        // If a gap is already selected and empty, fill it immediately
                        if (selectedGapElement && selectedGapElement.textContent.trim() === '') {
                            fillGap(selectedWordElement, selectedGapElement);
                        }
                        
                        // Clear gap selection
                        if (selectedGapElement) selectedGapElement.classList.remove('selected');
                        selectedGapElement = null;
                    }
                });
            });

            // 2. Setup Gap Clicks
            document.querySelectorAll(`${activitySelector} .gap-fill-drop-zone`).forEach(gap => {
                gap.addEventListener('click', function() {
                    // Do not allow interaction after checking answers
                    if (this.classList.contains('correct-answer') || this.classList.contains('incorrect-answer')) return;
                    
                    if (this.textContent.trim()) {
                        // Gap is filled -> Unfill it (return word to bank)
                        unfillGap(this);
                    } else {
                        // Gap is empty
                        if (selectedWordElement) {
                            // Fill gap with selected word
                            fillGap(selectedWordElement, this);
                        } else {
                            // Select the gap
                            if (selectedGapElement) selectedGapElement.classList.remove('selected');
                            this.classList.add('selected');
                            selectedGapElement = this;
                            
                            // Clear word selection
                            if (selectedWordElement) selectedWordElement.classList.remove('selected');
                            selectedWordElement = null;
                        }
                    }
                });
            });
        }


        // --- Activity 3: Conversation Gap-Fill (CLICK & CLICK) ---
        function initializeConversationFillActivity() {
            // Shuffle word bank
            const wordBank = document.getElementById('wordBankConversation');
            const words = Array.from(wordBank.children).filter(el => el.classList.contains('word-item-drag'));
            words.sort(() => Math.random() - 0.5);
            words.forEach(word => wordBank.appendChild(word));
            
            applyClickFillLogic('#activity3');
        }
        
        function checkConversationFill() {
            const dropZones = document.querySelectorAll('#activity3 .gap-fill-drop-zone');
            let correctCount = 0;
            const totalZones = dropZones.length;
            
            if (Array.from(dropZones).some(z => !z.textContent.trim())) {
                showFeedback('conversation', false, 'Please fill all the gaps before checking.');
                document.getElementById('conversation-check-btn').style.display = 'inline-block';
                document.getElementById('conversation-retry').style.display = 'none';
                return;
            }

            dropZones.forEach(zone => {
                const userAnswer = zone.textContent.trim().toLowerCase();
                const correctAnswer = zone.dataset.correct.toLowerCase();
                
                if (userAnswer === correctAnswer) {
                    zone.classList.add('correct-answer');
                    correctCount++;
                } else {
                    zone.classList.add('incorrect-answer');
                }
            });

            if (correctCount === totalZones) {
                totalPoints += 120;
                streak++;
                updateStats();
                showPointsAnimation(120);
                showSticker('great');
                showFeedback('conversation', true, 'Excellent! You completed the conversation correctly! üéØ');
            } else {
                totalPoints += correctCount * 15;
                streak = 0;
                updateStats();
                showSticker('oops');
                showFeedback('conversation', false, `You got ${correctCount} out of ${totalZones} correct. Review the incorrect spots! üîÑ`);
            }
            
            document.getElementById('conversation-check-btn').style.display = 'none';
        }
        
        function resetConversationFillActivity() {
            document.querySelectorAll('#activity3 .gap-fill-drop-zone').forEach(zone => {
                unfillGap(zone);
                zone.classList.remove('correct-answer', 'incorrect-answer');
            });
            
            // Re-shuffle word bank
            const wordBank = document.getElementById('wordBankConversation');
            const words = Array.from(wordBank.children).filter(el => el.classList.contains('word-item-drag'));
            words.sort(() => Math.random() - 0.5);
            words.forEach(word => wordBank.appendChild(word));
            
            // Clear any active selections
            selectedWordElement = null;
            selectedGapElement = null;
        }
        
        // Activity 4 is a video and simply moves to next activity via button click (no reset needed)

        // --- Activity 5: Greetings & Goodbyes Quiz ---
        function initializeGreetingsQuiz() {
            document.querySelectorAll('#activity5 .option').forEach(option => {
                option.addEventListener('click', function() {
                    if (this.classList.contains('disabled')) return;
                    
                    const parent = this.closest('.options');
                    parent.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
        }
        
        function checkGreetingsQuiz() {
            let correctAnswers = 0;
            const totalQuestions = 2;
            const answers = [];
            
            for (let i = 1; i <= totalQuestions; i++) {
                const selected = document.querySelector(`#greetings-q${i} .option.selected`);
                answers.push(selected);
            }

            if (answers.some(answer => !answer)) {
                showFeedback('greetings', false, 'Please answer both questions before checking.');
                document.getElementById('greetings-check-btn').style.display = 'inline-block';
                document.getElementById('greetings-retry').style.display = 'none';
                return;
            }

            answers.forEach((answer, index) => {
                if (answer.dataset.answer === 'correct') {
                    correctAnswers++;
                    answer.classList.add('correct');
                } else {
                    answer.classList.add('incorrect');
                    const correctOption = document.querySelector(`#greetings-q${index + 1} .option[data-answer="correct"]`);
                    if (correctOption) correctOption.classList.add('correct');
                }
            });
            
            document.querySelectorAll('#activity5 .option').forEach(option => option.classList.add('disabled'));

            if (correctAnswers === totalQuestions) {
                totalPoints += 100;
                streak++;
                updateStats();
                showPointsAnimation(100);
                showSticker('great');
                showFeedback('greetings', true, 'You got them all correct! You\'re a pro at greetings! üëã');
            } else {
                totalPoints += correctAnswers * 25;
                streak = 0;
                updateStats();
                showSticker('oops');
                showFeedback('greetings', false, `You got ${correctAnswers} out of ${totalQuestions} correct. Try again to master the greetings!`);
            }
        }
        
        function resetGreetingsQuiz() {
            document.querySelectorAll('#activity5 .option').forEach(option => {
                option.classList.remove('selected', 'correct', 'incorrect', 'disabled');
            });
            // Handled by generic retryActivity
        }


        // --- Activity 6: Gap Fill (CLICK & CLICK) ---
        function initializeGapFillActivity() {
            // Shuffle word bank
            const wordBank = document.getElementById('wordBankGap');
            const words = Array.from(wordBank.children).filter(el => el.classList.contains('word-item-drag'));
            words.sort(() => Math.random() - 0.5);
            words.forEach(word => wordBank.appendChild(word));
            
            applyClickFillLogic('#activity6');
        }

        function checkGapFill() {
            const dropZones = document.querySelectorAll('#activity6 .gap-fill-drop-zone');
            let correctCount = 0;
            const totalZones = dropZones.length;
            
            if (Array.from(dropZones).some(z => !z.textContent.trim())) {
                showFeedback('gap', false, 'Please fill all the gaps before checking.');
                document.getElementById('gap-check-btn').style.display = 'inline-block';
                document.getElementById('gap-retry').style.display = 'none';
                return;
            }

            dropZones.forEach(zone => {
                const userAnswer = zone.textContent.trim().toLowerCase();
                const correctAnswer = zone.dataset.correct.toLowerCase();
                
                if (userAnswer === correctAnswer) {
                    zone.classList.add('correct-answer');
                    correctCount++;
                } else {
                    zone.classList.add('incorrect-answer');
                }
            });

            if (correctCount === totalZones) {
                totalPoints += 120;
                streak++;
                updateStats();
                showPointsAnimation(120);
                showSticker('great');
                showFeedback('gap', true, 'Excellent! You completed the sentences correctly! üéØ');
            } else {
                totalPoints += correctCount * 15;
                streak = 0;
                updateStats();
                showSticker('oops');
                showFeedback('gap', false, `You got ${correctCount} out of ${totalZones} correct. Try again! üîÑ`);
            }
            
            document.getElementById('gap-check-btn').style.display = 'none';
        }

        function resetGapFillActivity() {
            document.querySelectorAll('#activity6 .gap-fill-drop-zone').forEach(zone => {
                unfillGap(zone);
                zone.classList.remove('correct-answer', 'incorrect-answer');
            });
            
            // Re-shuffle word bank
            const wordBank = document.getElementById('wordBankGap');
            const words = Array.from(wordBank.children).filter(el => el.classList.contains('word-item-drag'));
            words.sort(() => Math.random() - 0.5);
            words.forEach(word => wordBank.appendChild(word));
            
            // Clear any active selections
            selectedWordElement = null;
            selectedGapElement = null;
        }

        // --- Activity 7: Final Quiz ---
        function initializeFinalQuiz() {
            document.querySelectorAll('#activity7 .option').forEach(option => {
                option.addEventListener('click', function() {
                    if (this.classList.contains('disabled')) return;
                    
                    const parent = this.closest('.options');
                    parent.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
        }
        
        function checkFinalQuiz() {
            let correctAnswers = 0;
            const totalQuestions = 3;
            const answers = [];
            
            for (let i = 1; i <= totalQuestions; i++) {
                const selected = document.querySelector(`#final-q${i} .option.selected`);
                answers.push(selected);
            }

            if (answers.some(answer => !answer)) {
                showFeedback('final', false, 'Please answer all three questions before checking.');
                document.getElementById('final-check-btn').style.display = 'inline-block';
                document.getElementById('final-retry').style.display = 'none';
                return;
            }

            answers.forEach((answer, index) => {
                if (answer.dataset.answer === 'correct') {
                    correctAnswers++;
                    answer.classList.add('correct');
                } else {
                    answer.classList.add('incorrect');
                    const correctOption = document.querySelector(`#final-q${index + 1} .option[data-answer="correct"]`);
                    if (correctOption) correctOption.classList.add('correct');
                }
            });
            
            document.querySelectorAll('#activity7 .option').forEach(option => option.classList.add('disabled'));

            if (correctAnswers === totalQuestions) {
                totalPoints += 200;
                streak++;
                updateStats();
                showPointsAnimation(200);
                showSticker('great');
                showFeedback('final', true, 'Amazing! You passed the final test with flying colors! üèÜ');
            } else {
                totalPoints += correctAnswers * 30;
                streak = 0;
                updateStats();
                showSticker('oops');
                showFeedback('final', false, `You got ${correctAnswers} out of ${totalQuestions} correct. Time to review! üìù`);
            }
        }
        
        function resetFinalQuiz() {
            document.querySelectorAll('#activity7 .option').forEach(option => {
                option.classList.remove('selected', 'correct', 'incorrect', 'disabled');
            });
            // Handled by generic retryActivity
        }

        // --- Initialization ---
        function initializeGame() {
            updateStats();
            initializeMatchingGame();
            initializeReadingActivity();
            initializeConversationFillActivity();
            initializeGreetingsQuiz();
            initializeGapFillActivity();
            initializeFinalQuiz();
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeGame);
    </script>
</body>
</html>
