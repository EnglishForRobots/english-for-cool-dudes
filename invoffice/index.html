<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <link rel="icon" type="image/png" href="/favicon.png" sizes="32x32">
    <title>ğŸ‘©ğŸ»â€ğŸ’» The Invisible Office â€” English For Cool Dudes</title>

    <link rel="preconnect" href="https://fonts.bunny.net">
    <link href="https://fonts.bunny.net/css2?family=Nunito:wght@400;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/init-auth.js"></script>

    <style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOKENS â€” EFCD system + Tax track gold accent
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    :root {
        --blue:         #1CB0F6;
        --blue-shadow:  #1899D6;
        --yellow:       #FFC800;
        --yellow-shadow:#E5B400;
        --green:        #58CC02;
        --green-shadow: #58A700;
        --punch:        #FF4B4B;
        --punch-shadow: #EA2B2B;
        --purple:       #CE82FF;
        --purple-shadow:#A559D9;
        --teal:         #2BDECC;
        --teal-shadow:  #1FBFAF;
        --bg:           #F7F9FA;
        --white:        #FFFFFF;
        --ink:          #4B4B4B;
        --ink-bold:     #111827;
        --ink-3:        #AFAFAF;
        --border:       #E5E5E5;
        --border-heavy: #CECECE;
        --r:            24px;
        --rsm:          16px;
        --rxs:          10px;

        /* Tax track accent â€” yellow/gold */
        --accent:        var(--yellow);
        --accent-shadow: var(--yellow-shadow);
        --accent-light:  rgba(255,200,0,.13);
        --accent-border: rgba(255,200,0,.4);
        --accent-text:   #92600A;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { -webkit-text-size-adjust: 100%; scroll-behavior: smooth; }
    body {
        background: var(--bg);
        color: var(--ink);
        font-family: 'Nunito', -apple-system, system-ui, sans-serif;
        line-height: 1.5;
        overflow-x: hidden;
        padding-bottom: 84px;
        -webkit-font-smoothing: antialiased;
    }
    @media(min-width:768px){ body { padding-bottom: 0; } }
    a { color: inherit; text-decoration: none; }
    button { font-family: inherit; cursor: pointer; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ANIMATIONS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    @keyframes up      { from{opacity:0;transform:translateY(22px)} to{opacity:1;transform:translateY(0)} }
    @keyframes popin   { 0%{opacity:0;transform:scale(.88)} 70%{transform:scale(1.03)} 100%{opacity:1;transform:scale(1)} }
    @keyframes shim    { 0%{background-position:-400px 0} 100%{background-position:400px 0} }
    @keyframes nudge   { 0%,100%{transform:translateX(0)} 30%{transform:translateX(5px)} }
    @keyframes float   { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }
    @keyframes slideIn { from{opacity:0;transform:translateX(28px)} to{opacity:1;transform:translateX(0)} }
    @keyframes slideOut{ from{opacity:1;transform:translateX(0)} to{opacity:0;transform:translateX(-28px)} }
    @keyframes confetti{ 0%{opacity:1;transform:translateY(0) rotate(0deg)} 100%{opacity:0;transform:translateY(130px) rotate(400deg)} }
    @keyframes stamp   { 0%{transform:scale(3) rotate(-15deg);opacity:0} 60%{transform:scale(.9) rotate(3deg);opacity:1} 100%{transform:scale(1) rotate(-2deg);opacity:1} }
    @keyframes flick   { 0%,100%{transform:rotate(-4deg) scale(1)} 50%{transform:rotate(4deg) scale(1.12)} }

    .u1{animation:up .44s ease both .04s} .u2{animation:up .44s ease both .14s}
    .u3{animation:up .44s ease both .24s} .u4{animation:up .44s ease both .34s}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       HEADER
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .header {
        background: var(--white); border-bottom: 2px solid var(--border);
        position: sticky; top: 0; z-index: 200;
        padding: 0 20px; height: 60px; display: flex; align-items: center;
    }
    .hc { max-width: 900px; width: 100%; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
    .hl { display: flex; align-items: center; gap: 10px; }
    .logo {
        width: 40px; height: 40px; border-radius: 12px;
        background: var(--yellow); border: 2px solid var(--border-heavy);
        display: flex; align-items: center; justify-content: center;
        font-size: 22px; flex-shrink: 0; box-shadow: 0 3px 0 var(--border-heavy);
    }
    .site-title { font-size: 18px; font-weight: 900; color: var(--ink-bold); letter-spacing: -.4px; }
    @media(max-width:380px){ .site-title{display:none} }
    .hdr-stats { display: flex; align-items: center; gap: 8px; }
    .hdr-pill {
        display: flex; align-items: center; gap: 5px;
        background: var(--bg); border: 2px solid var(--border-heavy);
        border-bottom: 4px solid var(--border-heavy);
        padding: 5px 12px; border-radius: var(--rxs);
        font-size: 14px; font-weight: 900; color: var(--ink-bold);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PAGE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .page { max-width: 900px; margin: 0 auto; padding: 24px 16px 24px; display: flex; flex-direction: column; gap: 16px; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LESSON BANNER â€” blue hero, gold eyebrow (tax)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .lesson-banner {
        background: var(--blue); border: 2px solid var(--blue-shadow);
        border-bottom: 6px solid var(--blue-shadow);
        border-radius: var(--r); padding: 24px 20px 20px;
        position: relative; overflow: hidden;
    }
    .lesson-banner::after {
        content: 'ğŸ¢'; position: absolute; bottom: -16px; right: 8px;
        font-size: 120px; opacity: .1; pointer-events: none; transform: rotate(-8deg);
    }
    .lesson-eyebrow {
        display: inline-block; background: var(--yellow); color: var(--ink-bold);
        font-size: 12px; font-weight: 900; text-transform: uppercase; letter-spacing: 1.5px;
        padding: 4px 12px; border-radius: 8px; border: 2px solid var(--yellow-shadow);
        margin-bottom: 12px;
    }
    .lesson-title {
        font-size: clamp(24px, 6vw, 38px); font-weight: 900; color: var(--white);
        letter-spacing: -1px; line-height: 1.1; margin-bottom: 6px;
        position: relative; z-index: 1; text-shadow: 0 2px 0 var(--blue-shadow);
    }
    .lesson-sub { font-size: 15px; font-weight: 700; color: rgba(255,255,255,.9); position: relative; z-index: 1; }
    .prog-wrap  { margin-top: 18px; position: relative; z-index: 1; background: rgba(255,255,255,.2); padding: 12px; border-radius: var(--rsm); }
    .prog-row   { display: flex; justify-content: space-between; font-size: 13px; font-weight: 800; color: var(--white); margin-bottom: 8px; }
    .prog-track { height: 16px; background: rgba(0,0,0,.15); border-radius: 99px; overflow: hidden; border: 2px solid rgba(0,0,0,.1); }
    .prog-fill  { height: 100%; width: 0%; border-radius: 99px; background: var(--yellow); border-top: 4px solid rgba(255,255,255,.4); transition: width .7s cubic-bezier(.4,0,.2,1); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION CARD â€” chunky white card
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .sec-card {
        background: var(--white); border: 2px solid var(--border-heavy);
        border-bottom: 6px solid var(--border-heavy); border-radius: var(--r);
        overflow: hidden; opacity: 0; transform: translateY(16px);
        transition: opacity .4s ease, transform .4s ease; scroll-margin-top: 72px;
    }
    .sec-card.visible { opacity: 1; transform: translateY(0); }

    /* Tax-track colour strips */
    .sec-card::before { content: ''; display: block; height: 7px; }
    .strip-gold::before   { background: linear-gradient(90deg, var(--yellow) 0%, #FFE066 100%); }
    .strip-blue::before   { background: var(--blue);   }
    .strip-green::before  { background: var(--green);  }
    .strip-purple::before { background: var(--purple); }
    .strip-punch::before  { background: var(--punch);  }
    .strip-teal::before   { background: var(--teal);   }

    .sec-head {
        padding: 14px 20px 12px; border-bottom: 2px solid var(--border);
        display: flex; align-items: center; justify-content: space-between; gap: 10px;
    }
    .sec-head-left { display: flex; align-items: center; gap: 10px; }
    .sec-head-icon {
        width: 40px; height: 40px; border-radius: 12px;
        display: flex; align-items: center; justify-content: center;
        font-size: 20px; flex-shrink: 0;
        background: var(--bg); border: 2px solid var(--border-heavy); border-bottom: 3px solid var(--border-heavy);
    }
    .sec-head-title { font-size: 16px; font-weight: 900; color: var(--ink-bold); letter-spacing: -.3px; }
    .sec-head-sub   { font-size: 12px; font-weight: 700; color: var(--ink-3); margin-top: 1px; }
    .sec-body { padding: 20px; }
    @media(min-width:768px){ .sec-body { padding: 24px; } }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION LABELS â€” homepage divider style
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .sec-label {
        font-size: 13px; font-weight: 900; color: var(--ink-3);
        text-transform: uppercase; letter-spacing: 1.5px;
        display: flex; align-items: center; gap: 12px;
    }
    .sec-label::after { content: ''; flex: 1; height: 2px; background: var(--border); border-radius: 2px; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RISK MAP â€” world map opener mechanic
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    /* map container */
    .map-wrap {
        position: relative; border-radius: var(--rsm);
        overflow: hidden; background: #E8F4FD;
        border: 2px solid var(--border-heavy);
        margin-bottom: 14px; user-select: none;
    }
    .map-wrap svg { display: block; width: 100%; height: auto; }

    /* map counter */
    .map-counter {
        display: flex; justify-content: center; align-items: center; gap: 8px;
        margin-bottom: 14px; flex-wrap: wrap;
    }
    .map-counter-label {
        font-size: 13px; font-weight: 900; color: var(--ink-3); text-transform: uppercase; letter-spacing: 1.5px;
    }
    .map-pins-row { display: flex; gap: 6px; }
    .map-pin-dot {
        width: 28px; height: 28px; border-radius: 50%; border: 3px solid var(--border-heavy);
        background: var(--bg); display: flex; align-items: center; justify-content: center;
        font-size: 14px; transition: all .3s;
    }
    .map-pin-dot.done-safe { background: var(--green);  border-color: var(--green-shadow); }
    .map-pin-dot.done-risk { background: var(--punch);  border-color: var(--punch-shadow); }

    /* SVG pins on map */
    .map-pin {
        cursor: pointer; transition: transform .15s;
        transform-origin: center bottom;
    }
    .map-pin:hover .pin-head { filter: brightness(1.1); }
    .map-pin.stamped { cursor: default; }
    .map-pin.stamped .pin-head { opacity: .6; }

    /* pulse ring */
    @keyframes pinpulse {
        0%  { r: 10; opacity: .7; }
        100%{ r: 22; opacity: 0; }
    }
    .pin-pulse { animation: pinpulse 1.6s ease-out infinite; }
    .map-pin.stamped .pin-pulse { display: none; }

    /* stamp on map (overlay circle) */
    @keyframes stampDrop {
        0%  { opacity: 0; transform: scale(2.5) rotate(-20deg); }
        60% { transform: scale(.9) rotate(4deg); opacity: 1; }
        100%{ transform: scale(1) rotate(-2deg); opacity: 1; }
    }
    .map-stamp { animation: stampDrop .45s cubic-bezier(.175,.885,.32,1.275) both; }

    /* slide-up report sheet */
    .report-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,.45);
        z-index: 400; display: none; align-items: flex-end; justify-content: center;
    }
    .report-overlay.open { display: flex; }
    .report-sheet {
        background: var(--white); width: 100%; max-width: 600px;
        border-radius: var(--r) var(--r) 0 0; border: 2px solid var(--border-heavy);
        border-bottom: none; max-height: 88vh; overflow-y: auto;
        animation: slideUp .32s cubic-bezier(.175,.885,.32,1.275) both;
    }
    @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }

    .rs-handle { width: 36px; height: 4px; background: var(--border-heavy); border-radius: 4px; margin: 12px auto 0; }

    .rs-head {
        padding: 14px 20px 14px; border-bottom: 2px solid var(--border);
        display: flex; align-items: center; justify-content: space-between;
    }
    .rs-flag   { font-size: 28px; margin-right: 10px; }
    .rs-name   { font-size: 17px; font-weight: 900; color: var(--ink-bold); letter-spacing: -.3px; }
    .rs-loc    { font-size: 12px; font-weight: 700; color: var(--ink-3); margin-top: 1px; }
    .rs-close  {
        width: 34px; height: 34px; background: var(--bg); border: 2px solid var(--border-heavy);
        border-radius: var(--rxs); font-size: 18px; font-weight: 900; color: var(--ink-3);
        display: flex; align-items: center; justify-content: center; cursor: pointer;
        flex-shrink: 0;
    }

    .rs-body { padding: 16px 20px; }

    /* field report card inside sheet */
    .field-report {
        background: #FFFBEB; border: 2px solid var(--border);
        border-left: 5px solid var(--yellow-shadow);
        border-radius: var(--rsm); padding: 14px 16px; margin-bottom: 16px;
    }
    .fr-label { font-size: 11px; font-weight: 900; color: var(--ink-3); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 8px; }
    .fr-text  { font-size: 14px; font-weight: 700; color: var(--ink-bold); line-height: 1.7; font-style: italic; }
    .fr-text em { font-style: normal; font-weight: 900; color: var(--yellow-shadow); }

    .rs-question { font-size: 17px; font-weight: 900; color: var(--ink-bold); margin-bottom: 14px; text-align: center; }

    /* stamp buttons */
    .stamp-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
    .stamp-btn {
        display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px;
        padding: 16px 12px; min-height: 72px; font-family: inherit;
        border-radius: var(--rsm); border: 2px solid; border-bottom-width: 5px;
        transition: transform .1s, border-bottom-width .1s; cursor: pointer; touch-action: manipulation;
    }
    .stamp-btn:active { border-bottom-width: 2px; transform: translateY(3px); }
    .stamp-btn-icon { font-size: 26px; }
    .stamp-btn-label{ font-size: 13px; font-weight: 900; letter-spacing: .5px; }
    .stamp-btn.flag { background: rgba(255,75,75,.08); border-color: var(--punch-shadow); color: var(--punch-shadow); }
    .stamp-btn.safe { background: rgba(88,204,2,.08);  border-color: var(--green-shadow); color: var(--green-shadow); }
    .stamp-btn.chosen-correct   { background: var(--green) !important; color: var(--white) !important; border-color: var(--green-shadow) !important; }
    .stamp-btn.chosen-incorrect { background: var(--punch) !important; color: var(--white) !important; border-color: var(--punch-shadow) !important; }
    .stamp-btn.chosen-wrong-reveal { background: var(--bg) !important; color: var(--ink-3) !important; border-color: var(--border-heavy) !important; opacity: .55 !important; }
    .stamp-btn:disabled { opacity: .75; cursor: default; }

    /* verdict in sheet */
    .rs-verdict {
        border: 2px solid var(--border-heavy); border-radius: var(--rsm); overflow: hidden;
        display: none; animation: up .2s ease both;
    }
    .rs-verdict.show { display: block; }
    .rs-verd-banner { padding: 12px 16px; font-size: 16px; font-weight: 900; }
    .rs-verd-banner.correct   { background: var(--green); color: var(--white); }
    .rs-verd-banner.incorrect { background: var(--punch); color: var(--white); }
    .rs-verd-banner.neutral   { background: var(--yellow); color: var(--ink-bold); }
    .rs-verd-explain { padding: 14px 16px; font-size: 14px; font-weight: 700; line-height: 1.65; color: var(--ink-bold); border-top: 2px solid var(--border); }
    .ev-voc { color: var(--blue); font-weight: 900; border-bottom: 2.5px solid rgba(28,176,246,.4); cursor: pointer; }

    /* sheet next button */
    .rs-next {
        display: flex; align-items: center; justify-content: center; gap: 8px;
        width: 100%; padding: 15px; margin-top: 4px;
        background: var(--yellow); color: var(--ink-bold);
        font-size: 15px; font-weight: 900; font-family: inherit;
        border: 2px solid var(--yellow-shadow); border-bottom: 5px solid var(--yellow-shadow);
        border-radius: var(--rsm); transition: transform .1s, border-bottom-width .1s;
        touch-action: manipulation;
    }
    .rs-next:active { border-bottom-width: 2px; transform: translateY(3px); }

    /* map done summary */
    .map-done {
        text-align: center; padding: 28px 20px 24px;
        animation: popin .4s cubic-bezier(.175,.885,.32,1.275) both;
    }
    .md-icon  { font-size: 56px; display: block; margin-bottom: 10px; }
    .md-title { font-size: 22px; font-weight: 900; color: var(--ink-bold); letter-spacing: -.5px; margin-bottom: 8px; }
    .md-sub   { font-size: 14px; font-weight: 700; color: var(--ink-3); margin-bottom: 20px; }
    .md-score { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
    .md-chip  { padding: 7px 14px; border-radius: 10px; font-size: 13px; font-weight: 900; border: 2px solid; }
    .md-chip.risk { background: rgba(255,75,75,.1); color: var(--punch-shadow); border-color: var(--punch-shadow); }
    .md-chip.safe { background: rgba(88,204,2,.1);  color: var(--green-shadow); border-color: var(--green-shadow); }
    .md-btn {
        display: flex; align-items: center; justify-content: center; gap: 8px;
        width: 100%; padding: 15px; background: var(--yellow); color: var(--ink-bold);
        font-size: 16px; font-weight: 900; font-family: inherit;
        border: 2px solid var(--yellow-shadow); border-bottom: 5px solid var(--yellow-shadow);
        border-radius: var(--rsm); transition: transform .1s, border-bottom-width .1s; touch-action: manipulation;
    }
    .md-btn:active { border-bottom-width: 2px; transform: translateY(3px); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BRIEFING
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .briefing-skip {
        font-size: 12px; font-weight: 900; color: var(--ink-3);
        background: var(--bg); border: 2px solid var(--border);
        padding: 5px 12px; border-radius: var(--rxs); -webkit-appearance: none;
    }
    .b-block {
        background: var(--bg); border: 2px solid var(--border); border-left-width: 5px;
        border-radius: 0 var(--rsm) var(--rsm) 0; padding: 14px 16px; margin-bottom: 12px;
        animation: up .35s ease both;
    }
    .b-block[data-heat="1"] { border-left-color: var(--blue); }
    .b-block[data-heat="2"] { border-left-color: var(--yellow-shadow); }
    .b-block[data-heat="3"] { border-left-color: var(--punch); }
    .b-label { font-size: 11px; font-weight: 900; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 10px; }
    .b-block[data-heat="1"] .b-label { color: var(--blue-shadow); }
    .b-block[data-heat="2"] .b-label { color: #8A6400; }
    .b-block[data-heat="3"] .b-label { color: var(--punch-shadow); }
    .b-rows { display: flex; flex-direction: column; gap: 7px; }
    .b-row  { display: flex; align-items: baseline; gap: 10px; font-size: 14px; }
    .b-key  { font-size: 11px; font-weight: 900; color: var(--ink-3); text-transform: uppercase; letter-spacing: .8px; min-width: 110px; flex-shrink: 0; }
    .b-val      { font-weight: 800; color: var(--ink-bold); }
    .b-val.hot  { color: var(--punch-shadow); }
    .b-val.warm { color: #8A6400; }
    .b-val.cool { color: var(--blue-shadow); }
    .b-voc { color: var(--blue); font-weight: 900; border-bottom: 2px solid rgba(28,176,246,.35); cursor: pointer; }
    .b-alert { margin-top: 12px; padding: 12px 14px; background: rgba(255,75,75,.07); border: 2px solid rgba(255,75,75,.25); border-radius: var(--rsm); font-size: 14px; font-weight: 700; color: var(--punch-shadow); line-height: 1.5; }
    .b-alert strong { font-weight: 900; }
    .briefing-go {
        display: flex; align-items: center; justify-content: center; gap: 8px;
        width: 100%; margin-top: 18px; padding: 16px;
        background: var(--green); color: var(--white);
        font-size: 16px; font-weight: 900; font-family: inherit;
        border: 2px solid var(--green-shadow); border-bottom: 5px solid var(--green-shadow);
        border-radius: var(--rsm); transition: transform .1s, border-bottom-width .1s;
        touch-action: manipulation;
    }
    .briefing-go:active { border-bottom-width: 2px; transform: translateY(3px); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       EXERCISES â€” shared components
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .q-box { background: var(--bg); border: 2px solid var(--border); border-radius: var(--rsm); padding: 15px; margin-bottom: 10px; }
    .q-text { font-size: 15px; font-weight: 800; color: var(--ink-bold); margin-bottom: 10px; line-height: 1.4; }

    .opt-btn {
        display: block; width: 100%; text-align: left; padding: 13px 15px; min-height: 50px;
        margin-top: 7px; background: var(--white);
        border: 2px solid var(--border-heavy); border-bottom: 5px solid var(--border-heavy);
        border-radius: var(--rsm); font-size: 14px; font-weight: 800; color: var(--ink);
        font-family: inherit; -webkit-appearance: none;
        transition: transform .1s, border-bottom-width .1s, border-color .15s;
        cursor: pointer; touch-action: manipulation;
    }
    .opt-btn:active    { border-bottom-width: 2px; transform: translateY(3px); }
    .opt-btn.selected  { border-color: var(--yellow-shadow); border-bottom-color: var(--yellow-shadow); color: var(--accent-text); background: var(--accent-light); }
    .opt-btn.correct   { background: var(--green)  !important; color: var(--white) !important; border-color: var(--green-shadow) !important; }
    .opt-btn.incorrect { background: var(--punch)  !important; color: var(--white) !important; border-color: var(--punch-shadow) !important; }

    /* word bank */
    .word-bank { background: var(--bg); border: 2px solid var(--border); border-radius: var(--rsm); padding: 14px; margin-bottom: 14px; }
    .wb-label  { font-size: 11px; font-weight: 900; color: var(--ink-3); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 10px; }
    .wb-words  { display: flex; flex-wrap: wrap; gap: 8px; }
    .wb-word {
        background: var(--white); color: var(--accent-text);
        padding: 8px 14px; border-radius: var(--rsm);
        border: 2px solid var(--accent-border); border-bottom: 4px solid var(--yellow-shadow);
        font-weight: 900; font-size: 13px; font-family: inherit;
        -webkit-appearance: none; transition: transform .1s, border-bottom-width .1s;
        touch-action: manipulation;
    }
    .wb-word:active { border-bottom-width: 2px; transform: translateY(2px); }
    .wb-word.sel    { background: var(--yellow); color: var(--ink-bold); }
    .wb-word.used   { opacity: .22; pointer-events: none; }

    .gap-sents { font-size: 15px; font-weight: 700; line-height: 3.6; color: var(--ink); }
    .gap {
        display: inline-block; text-align: center; min-width: 130px;
        background: var(--white); border: 2px dashed var(--yellow-shadow);
        border-radius: var(--rsm); padding: 4px 10px; margin: 0 3px;
        font-weight: 900; color: var(--accent-text); font-size: 13px;
        cursor: pointer; min-height: 34px; transition: background .15s;
    }
    .gap.correct   { background: var(--green)  !important; border-color: var(--green-shadow) !important; border-style: solid; color: var(--white); pointer-events: none; }
    .gap.incorrect { background: var(--punch)  !important; border-color: var(--punch-shadow) !important; border-style: solid; color: var(--white); }

    /* word forms */
    .wf-item   { margin-bottom: 16px; }
    .wf-prompt { font-weight: 800; color: var(--ink-bold); margin-bottom: 7px; font-size: 14px; font-style: italic; line-height: 1.4; }
    .wf-input {
        width: 100%; padding: 13px 15px; min-height: 50px;
        background: var(--white); border: 2px solid var(--border-heavy); border-bottom: 4px solid var(--border-heavy);
        border-radius: var(--rsm); font-size: 15px; font-weight: 800; color: var(--ink-bold);
        font-family: inherit; transition: border-color .2s;
    }
    .wf-input:focus { outline: none; border-color: var(--yellow-shadow); border-bottom-color: var(--yellow-shadow); }
    .wf-input::placeholder { color: var(--ink-3); font-weight: 700; }
    .wf-input.ok  { border-color: var(--green-shadow) !important; background: rgba(88,204,2,.06); color: var(--green-shadow); }
    .wf-input.bad { border-color: var(--punch-shadow) !important; background: rgba(255,75,75,.06); color: var(--punch-shadow); }

    /* grammar */
    .gram-expl {
        background: var(--bg); border: 2px solid var(--border);
        border-left: 5px solid var(--purple);
        border-radius: 0 var(--rsm) var(--rsm) 0; padding: 16px; margin-bottom: 16px;
    }
    .gram-expl h4 { font-size: 11px; font-weight: 900; color: var(--purple-shadow); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 8px; }
    .gram-expl p  { font-size: 14px; font-weight: 700; color: var(--ink); margin-bottom: 8px; line-height: 1.5; }
    .gram-ex { padding: 8px 12px; margin: 5px 0; background: rgba(206,130,255,.1); border-left: 3px solid var(--purple); border-radius: 0 8px 8px 0; font-size: 13px; font-weight: 700; line-height: 1.5; }
    .gram-ex strong { color: var(--purple-shadow); font-weight: 900; }
    .gram-card { background: var(--bg); border: 2px solid var(--border); border-radius: var(--rsm); padding: 15px; margin-bottom: 10px; }
    @media(min-width:640px){ .gram-card { display: flex; align-items: center; gap: 16px; } }
    .gc-body { margin-bottom: 10px; flex: 1; }
    @media(min-width:640px){ .gc-body { margin-bottom: 0; } }
    .gc-sent { font-weight: 800; color: var(--ink-bold); font-size: 15px; margin-bottom: 4px; line-height: 1.4; }
    .gc-hint { font-size: 12px; font-weight: 700; color: var(--ink-3); font-style: italic; }
    .gram-sel {
        width: 100%; padding: 12px 14px; min-height: 48px;
        background: var(--white); border: 2px solid var(--border-heavy); border-bottom: 4px solid var(--border-heavy);
        border-radius: var(--rsm); font-size: 14px; font-weight: 800;
        color: var(--ink); font-family: inherit; -webkit-appearance: none; transition: border-color .15s;
    }
    @media(min-width:640px){ .gram-sel { width: auto; min-width: 220px; } }
    .gram-sel.correct   { background: var(--green); color: var(--white); border-color: var(--green-shadow); }
    .gram-sel.incorrect { background: var(--punch); color: var(--white); border-color: var(--punch-shadow); }

    /* buttons */
    .btn-row { margin-top: 18px; display: flex; flex-direction: column; gap: 10px; }
    @media(min-width:640px){ .btn-row { flex-direction: row; justify-content: center; } }
    .btn-check, .btn-reveal, .btn-reset {
        padding: 13px 24px; min-height: 50px; font-size: 15px; font-weight: 900;
        font-family: inherit; border-radius: var(--rsm); border: 2px solid; border-bottom-width: 5px;
        -webkit-appearance: none; transition: transform .1s, border-bottom-width .1s;
        touch-action: manipulation;
    }
    @media(min-width:640px){ .btn-check,.btn-reveal,.btn-reset { width: auto; } }
    .btn-check:active, .btn-reveal:active, .btn-reset:active { border-bottom-width: 2px; transform: translateY(3px); }
    .btn-check  { background: var(--yellow); color: var(--ink-bold); border-color: var(--yellow-shadow); }
    .btn-reveal { background: rgba(206,130,255,.15); color: var(--purple-shadow); border-color: var(--purple); }
    .btn-reset  { background: var(--bg); color: var(--ink-3); border-color: var(--border-heavy); }

    .result { margin-top: 12px; padding: 13px 16px; border-radius: var(--rsm); font-weight: 800; font-size: 15px; border: 2px solid; display: none; }
    .result.ok  { background: rgba(88,204,2,.09);  color: var(--green-shadow); border-color: var(--green-shadow); }
    .result.bad { background: rgba(255,75,75,.09); color: var(--punch-shadow); border-color: var(--punch-shadow); }

    .hint-btn  { display: inline-flex; align-items: center; gap: 4px; font-size: 12px; font-weight: 900; color: var(--ink-3); background: none; border: none; padding: 4px 0; cursor: pointer; font-family: inherit; }
    .hint-text { font-size: 12px; font-weight: 700; color: var(--purple-shadow); background: rgba(206,130,255,.1); border: 1px solid rgba(206,130,255,.3); border-radius: 8px; padding: 6px 10px; margin-top: 6px; display: none; line-height: 1.4; }
    .hint-text.show { display: block; }

    /* vocab glossary */
    .voc-grid { display: grid; grid-template-columns: 1fr; gap: 8px; }
    @media(min-width:600px){ .voc-grid { grid-template-columns: 1fr 1fr; } }
    .voc-item {
        background: var(--bg); border: 2px solid var(--border); border-radius: var(--rsm);
        padding: 12px 14px; display: flex; flex-direction: column; gap: 3px;
        cursor: pointer; transition: border-color .15s;
    }
    .voc-item:hover { border-color: var(--yellow-shadow); }
    .voc-item-word { font-size: 15px; font-weight: 900; color: var(--accent-text); letter-spacing: -.2px; }
    .voc-item-type { font-size: 10px; font-weight: 900; color: var(--ink-3); text-transform: uppercase; letter-spacing: 1px; }
    .voc-item-def  { font-size: 13px; font-weight: 700; color: var(--ink); line-height: 1.45; margin-top: 2px; }

    /* bottom nav */
    .bot-nav {
        position: fixed; bottom: 0; left: 0; right: 0;
        background: var(--white); border-top: 2px solid var(--border);
        padding: 10px 16px; padding-bottom: calc(10px + env(safe-area-inset-bottom));
        display: flex; align-items: center; gap: 10px; z-index: 200;
    }
    @media(min-width:768px){ .bot-nav { display: none; } }
    .bn-btn {
        flex: 1; background: var(--bg); color: var(--ink-bold);
        border: 2px solid var(--border-heavy); border-bottom: 4px solid var(--border-heavy);
        padding: 12px; border-radius: var(--rsm); font-weight: 900; font-size: 15px;
        min-height: 50px; font-family: inherit; -webkit-appearance: none;
        transition: transform .1s, border-bottom-width .1s; touch-action: manipulation;
    }
    .bn-btn:active { border-bottom-width: 2px; transform: translateY(2px); }
    .bn-btn.primary { flex: 2; background: var(--yellow); color: var(--ink-bold); border-color: var(--yellow-shadow); }
    .bn-btn:disabled { opacity: .35; cursor: not-allowed; }
    .bn-ind { font-size: 12px; font-weight: 900; color: var(--ink-3); white-space: nowrap; text-align: center; min-width: 40px; }

    /* vocab popup */
    #voc-popup {
        position: fixed; bottom: 76px; left: 12px; right: 12px;
        background: var(--white); border: 2px solid var(--border-heavy);
        border-bottom: 6px solid var(--border-heavy); border-top: 4px solid var(--yellow-shadow);
        padding: 18px 18px 20px; border-radius: var(--r) var(--r) var(--rsm) var(--rsm);
        z-index: 500; display: none; box-shadow: 0 -8px 32px rgba(0,0,0,.12);
        animation: up .22s ease both; max-height: 46vh; overflow-y: auto;
    }
    @media(min-width:768px){ #voc-popup { position: fixed; bottom: 24px; right: 24px; left: auto; max-width: 310px; border-radius: var(--r); } }
    .vp-close { position: absolute; top: 10px; right: 10px; width: 32px; height: 32px; border-radius: var(--rxs); background: var(--bg); border: 2px solid var(--border-heavy); font-size: 18px; font-weight: 900; color: var(--ink-3); display: flex; align-items: center; justify-content: center; cursor: pointer; -webkit-appearance: none; }
    .voc-word { font-size: 22px; font-weight: 900; color: var(--accent-text); letter-spacing: -.4px; margin-bottom: 2px; }
    .voc-type { font-size: 11px; font-weight: 900; color: var(--ink-3); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
    .voc-def  { font-size: 14px; font-weight: 700; color: var(--ink); line-height: 1.65; margin-bottom: 14px; }
    .voc-hear {
        width: 100%; padding: 13px; background: var(--yellow); color: var(--ink-bold);
        border: 2px solid var(--yellow-shadow); border-bottom: 5px solid var(--yellow-shadow);
        border-radius: var(--rsm); font-size: 15px; font-weight: 900; font-family: inherit;
        transition: transform .1s, border-bottom-width .1s;
    }
    .voc-hear:active { border-bottom-width: 2px; transform: translateY(3px); }

    /* badges */
    .badge-wrap { position: fixed; top: 70px; right: 12px; display: flex; flex-direction: column; gap: 8px; z-index: 999; }
    .badge { background: var(--white); border: 2px solid var(--border-heavy); border-bottom: 4px solid var(--border-heavy); border-left: 4px solid var(--yellow); padding: 10px 14px; border-radius: var(--rsm); display: flex; align-items: center; gap: 8px; transform: translateX(240px); opacity: 0; transition: transform .4s, opacity .4s; box-shadow: 0 4px 14px rgba(0,0,0,.1); }
    .badge.show { transform: translateX(0); opacity: 1; }
    .badge-icon { font-size: 22px; }
    .badge-text { font-size: 13px; font-weight: 900; color: var(--ink-bold); }
    .confetti-dot { position: fixed; width: 10px; height: 10px; border-radius: 3px; pointer-events: none; z-index: 9999; animation: confetti .9s ease-out both; }

    @media(max-width:768px){ .wf-input:focus, .gram-sel:focus { font-size: 16px; } }
    </style>
</head>
<body>

<header class="header">
    <div class="hc">
        <div class="hl">
            <a href="/tax/" class="logo">ğŸ’°</a>
            <a href="/" class="site-title">English For Cool Dudes</a>
        </div>
        <div class="hdr-stats">
            <div class="hdr-pill">ğŸ”¥ <span id="hdr-streak">0</span></div>
            <div class="hdr-pill">âš¡ <span id="hdr-xp">0</span> XP</div>
        </div>
    </div>
</header>

<div class="badge-wrap" id="badge-wrap"></div>
<!-- Report sheet overlay -->
<div class="report-overlay" id="report-overlay" onclick="handleOverlayClick(event)">
    <div class="report-sheet" id="rs-sheet">
        <div id="rs-content"></div>
    </div>
</div>

<div id="voc-popup">
    <button class="vp-close" onclick="closeVoc()">Ã—</button>
    <div id="vp-body"></div>
</div>

<div class="page">
    <div class="lesson-banner u1">
        <div class="lesson-eyebrow">ğŸ’° Tax English Â· Intermediate</div>
        <div class="lesson-title">The Invisible Office</div>
        <div class="lesson-sub">Permanent establishments, digital nomads &amp; the taxman's new weapon</div>
        <div class="prog-wrap">
            <div class="prog-row">
                <span id="prog-label">0 / 7 sections</span>
                <span id="prog-pct">0%</span>
            </div>
            <div class="prog-track"><div class="prog-fill" id="prog-fill"></div></div>
        </div>
    </div>
    
    <div id="daily-challenge-widget"></div>
    <div id="sections"></div>
</div>

<nav class="bot-nav">
    <button class="bn-btn" id="bn-prev" onclick="prevSec()" disabled>â† Back</button>
    <span class="bn-ind" id="bn-ind">1/7</span>
    <button class="bn-btn primary" id="bn-next" onclick="nextSec()">Next â†’</button>
</nav>

<script src="/supabase-auth-gamified.js"></script>
<script src="/daily-challenges-system.js"></script>
<script src="/word-match-game.js"></script>

<script>
'use strict';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LESSON DATA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const L = {
    title:      "The Invisible Office",
    lessonId:   "invisibleoffice",
    lessonLink: "/invisibleofficegame/",
    levelPage:  "/tax/",
    level:      "Tax English",

    vocabulary: [
        { word:"Permanent Establishment", type:"noun",
          definition:"A fixed place of business â€” or a person acting on the company's behalf â€” that legally creates a taxable corporate presence in a foreign country." },
        { word:"Dependent Agent",         type:"noun",
          definition:"A person who habitually acts on behalf of a company and has the authority to sign contracts binding that company in a foreign country." },
        { word:"Authority to Conclude",   type:"phrase",
          definition:"The legal power to finalise and sign contracts that are binding on the company â€” the key trigger for a dependent agent PE." },
        { word:"Auxiliary Activity",      type:"noun",
          definition:"Support functions (marketing research, storage, purchasing) that are specifically exempt from creating a PE under OECD guidelines and most tax treaties." },
        { word:"Tax Treaty",              type:"noun",
          definition:"A bilateral agreement between two countries that defines which country has the right to tax specific types of income â€” preventing double taxation." },
        { word:"Nexus",                   type:"noun",
          definition:"A sufficient legal connection between a business and a jurisdiction that gives that jurisdiction the right to impose tax." },
        { word:"Source State",            type:"noun",
          definition:"The country where income is earned or where the economic activity takes place â€” as opposed to the company's home residence state." },
        { word:"Preparatory",             type:"adjective",
          definition:"Work done in advance of the main profit-making activity. Generally PE-safe under OECD guidelines because it doesn't directly generate revenue." },
        { word:"Liable",                  type:"adjective",
          definition:"Legally responsible for paying tax or fulfilling a legal obligation â€” exposure to a claim or penalty." },
        { word:"OECD Model Convention",   type:"noun",
          definition:"The internationally agreed framework that most bilateral tax treaties are modelled on, developed by the OECD to define consistent cross-border tax rules." }
    ],

    /* RISK MAP â€” 5 employees, judge PE risk per location */
    riskMap: [
        {
            id:    'paris',
            flag:  'ğŸ‡«ğŸ‡·', name:  'Maya Chen', loc: 'Paris, France',
            cx: 480, cy: 155,
            isRisk: true,
            report: `Maya is a British national and Sales Director at <em>Meridian Tech Ltd</em>, a UK-incorporated software company headquartered in London with no offices, subsidiaries or staff outside the UK. For the past 8 months she has been living in a Paris Airbnb, meeting French clients and attending industry events â€” and <em>signing service contracts on the spot</em> when clients want to move quickly. Her view: "The CEO always approves over WhatsApp first, so the authority sits in London."`,
            question: "Does Maya's activity in France create a PE for Meridian Tech?",
            verdict: { correct:"ğŸš¨ PE Risk â€” flagged correctly!", wrong:"ğŸš¨ Actually â€” this IS a PE risk" },
            explain: `The WhatsApp approval doesn't change anything. Maya is habitually exercising <span data-voc="Authority to Conclude" class="ev-voc">authority to conclude</span> contracts in France on behalf of a UK company with no French presence. That makes her a <span data-voc="Dependent Agent" class="ev-voc">dependent agent</span> and France a <span data-voc="Source State" class="ev-voc">source state</span> with a legitimate corporate tax claim against Meridian.`
        },
        {
            id:    'berlin',
            flag:  'ğŸ‡©ğŸ‡ª', name:  'Tom Baxter', loc: 'Berlin, Germany',
            cx: 500, cy: 140,
            isRisk: false,
            report: `Tom is an Australian national working as Head of Partnerships at <em>Solaris Group Pty Ltd</em>, a Sydney-based renewable energy consultancy incorporated in Australia. He flew to Berlin for a week-long industry trade show â€” attended panels, staffed the Solaris booth, collected business cards and distributed brochures. He had introductory conversations with potential European partners but <em>sent all follow-ups back to the Sydney office</em>. No contracts were discussed, negotiated or signed.`,
            question: "Does Tom's Berlin trip create a German PE for Solaris Group?",
            verdict: { correct:"âœ… Safe â€” correct call!", wrong:"âœ… Tom's trip is actually fine" },
            explain: `Trade show attendance, booth presence and lead collection are classic <span data-voc="Auxiliary Activity" class="ev-voc">auxiliary activities</span> â€” specifically listed as <span data-voc="Preparatory" class="ev-voc">preparatory</span> and PE-exempt under the <span data-voc="OECD Model Convention" class="ev-voc">OECD Model Convention</span>. Tom exercised no commercial authority in Germany, so no <span data-voc="Nexus" class="ev-voc">nexus</span> was created for Solaris.`
        },
        {
            id:    'singapore',
            flag:  'ğŸ‡¸ğŸ‡¬', name:  'Priya Nair', loc: 'Singapore',
            cx: 760, cy: 270,
            isRisk: true,
            report: `Priya is an Indian national and Regional VP at <em>Castellan Financial Services</em>, a Dublin-incorporated Irish firm with its sole office in Dublin. Eighteen months ago she relocated to Singapore to "develop the Asian market." She rents a small office there in the company's name, has hired a local admin assistant paid from company funds, and runs client calls from Singapore daily. Priya herself does not sign contracts â€” but the local assistant <em>sends out countersigned proposals using Priya's delegated authority</em>.`,
            question: "Does Priya's Singapore operation create a PE for Castellan?",
            verdict: { correct:"ğŸš¨ PE Risk â€” well spotted!", wrong:"ğŸš¨ There are actually multiple PE triggers here" },
            explain: `Two separate PE risks: the rented office is a textbook fixed-place <span data-voc="Permanent Establishment" class="ev-voc">PE</span>, and the assistant dispatching proposals under delegated authority could independently qualify as a <span data-voc="Dependent Agent" class="ev-voc">dependent agent</span>. Castellan, an Irish company with no legitimate Singapore presence, is almost certainly <span data-voc="Liable" class="ev-voc">liable</span> for Singapore corporate tax.`
        },
        {
            id:    'saopaulo',
            flag:  'ğŸ‡§ğŸ‡·', name:  'Carlos Mendes', loc: 'SÃ£o Paulo, Brazil',
            cx: 295, cy: 320,
            isRisk: false,
            report: `Carlos is a Spanish national and Head of Market Intelligence at <em>Vantage Capital SL</em>, a Madrid-based investment firm incorporated in Spain. He travels to SÃ£o Paulo for two weeks each quarter to conduct <em>competitor analysis and sector research</em> â€” interviewing market participants, attending regulatory briefings and writing strategy reports for the Madrid team. He works from hotel business centres. All investment decisions and client agreements are executed exclusively in Madrid.`,
            question: "Does Carlos's Brazil activity create a PE for Vantage Capital?",
            verdict: { correct:"âœ… Safe â€” good judgement!", wrong:"âœ… Carlos's visits are actually in the clear" },
            explain: `Quarterly research visits by an employee with no commercial authority are squarely <span data-voc="Preparatory" class="ev-voc">preparatory</span> and <span data-voc="Auxiliary Activity" class="ev-voc">auxiliary</span> in nature. There is no fixed place, no signing authority and no <span data-voc="Nexus" class="ev-voc">nexus</span> established for Vantage in Brazil. The Spain-Brazil <span data-voc="Tax Treaty" class="ev-voc">tax treaty</span> would reinforce this protection.`
        },
        {
            id:    'newyork',
            flag:  'ğŸ‡ºğŸ‡¸', name:  'Rachel Kim', loc: 'New York, USA',
            cx: 220, cy: 175,
            isRisk: true,
            report: `Rachel is an American national and VP Sales at <em>Northgate Consulting Ltd</em>, a Canadian company incorporated in Toronto with no US offices, employees or registration. She works full-time from a WeWork in Manhattan, managing all US client relationships. She <em>negotiates every pricing and contractual term</em> in person â€” then emails the agreed terms to Toronto, where a junior administrator countersigns and returns the PDF. The Toronto legal team believes this is safe because Rachel "technically never signs."`,
            question: "Is Northgate's 'Rachel never signs' arrangement genuinely safe?",
            verdict: { correct:"ğŸš¨ PE Risk â€” sharp thinking!", wrong:"ğŸš¨ The 'no signature' workaround doesn't hold up" },
            explain: `Tax authorities apply <em>substance over form</em>. Rachel finalises every material term of every contract â€” that constitutes <span data-voc="Authority to Conclude" class="ev-voc">authority to conclude</span> regardless of who holds the pen. Courts have consistently rejected cosmetic countersigning arrangements. The WeWork may also independently qualify as a fixed-place <span data-voc="Permanent Establishment" class="ev-voc">PE</span> for Northgate in the US.`
        }
    ],

    briefing: [
        {
            heat:1, label:"ğŸ›ï¸  The PE Framework",
            rows:[
                { key:"PE stands for",    val:"Permanent Establishment",                    style:"" },
                { key:"Two types",        val:"Fixed place PE + Dependent agent PE",         style:"" },
                { key:"Creates a",        val:"Nexus â€” a taxable legal connection in that country", style:"warm" },
                { key:"Consequence",      val:"Corporate income tax liability on profits there", style:"warm" },
                { key:"Governed by",      val:"OECD Model Convention + bilateral treaties",    style:"" }
            ]
        },
        {
            heat:2, label:"âš ï¸  The Dependent Agent Test",
            rows:[
                { key:"Trigger",          val:"Habitually concludes contracts on behalf of company", style:"hot" },
                { key:"Safe harbour",     val:"Preparatory / auxiliary activities only",              style:"cool" },
                { key:"Grey area",        val:"Negotiating vs. signing â€” courts look at substance",   style:"warm" },
                { key:"Modern risk",      val:"Virtual signing treated same as physical",              style:"hot" }
            ]
        },
        {
            heat:3, label:"ğŸŒ  The Remote Work Trap",
            rows:[
                { key:"The problem",      val:"Remote worker signs contracts from abroad",             style:"hot" },
                { key:"HR assumption",    val:"\"It's just working from home\"",                       style:"" },
                { key:"Tax reality",      val:"Could create a PE â€” and back-tax liability",            style:"hot" },
                { key:"The fix",          val:"Tax sign-off required for all international remote work", style:"cool" }
            ],
            alert:`A <strong>home office or Airbnb abroad</strong> can qualify as a PE. The company doesn't need to own or lease the space â€” <strong>habitual use</strong> for business is enough.`
        }
    ],

    exercises: [
        {
            type:"trueFalse", col:"green",
            icon:"âœ…", title:"True or False?",
            sub:"Tap True or False for each statement",
            questions:[
                { q:"A company must own or lease a property abroad for it to become a Permanent Establishment.",       a:false },
                { q:"An employee doing only market research and attending trade shows usually creates a PE.",           a:false },
                { q:"The OECD Model Convention forms the basis of most bilateral tax treaties.",                       a:true  },
                { q:"An employee who habitually signs contracts on behalf of a company can create a PE.",              a:true  },
                { q:"A 90-day remote work policy automatically protects a company from PE risk.",                     a:false }
            ]
        },
        {
            type:"multipleChoice", col:"blue",
            icon:"ğŸ¯", title:"Comprehension Check",
            sub:"Choose the best answer for each question",
            questions:[
                { q:"What is the KEY legal test for a dependent agent Permanent Establishment?",
                  opts:[
                      "The employee has worked in a foreign country for more than 183 days",
                      "The employee habitually concludes contracts binding the company in that country",
                      "The company has a registered office or subsidiary in the foreign country"
                  ], correct:1 },
                { q:"What made Maya's situation change from 'safe' to 'risky'?",
                  opts:[
                      "She stayed in Paris for more than 90 days",
                      "She habitually signed contracts in France on behalf of her company",
                      "She attended client meetings and industry events in Paris"
                  ], correct:1 },
                { q:"Which of the following is generally protected under the 'auxiliary activities' exemption?",
                  opts:[
                      "Signing a â‚¬1.2M services agreement at a client's office",
                      "Negotiating the final price and terms of a major contract",
                      "Collecting market intelligence and attending trade show panels"
                  ], correct:2 }
            ]
        },
        {
            type:"gapFill", col:"purple",
            icon:"ğŸ§©", title:"Fill the Gaps",
            sub:"Select a word from the bank, then tap a blank to fill it",
            wordBank:["nexus","liable","tax treaty","source state","preparatory","dependent agent"],
            sentences:[
                { t:"Maya's contract-signing activity created ___ for the company in France.", a:"nexus" },
                { t:"Once a PE is established, a company is ___ for corporate income tax abroad.", a:"liable" },
                { t:"Attending a trade show to collect leads is ___ â€” it does not create a PE.", a:"preparatory" },
                { t:"An employee who habitually signs contracts abroad may become a ___ of that company.", a:"dependent agent" },
                { t:"The UK and France have a ___ that determines which country can tax which income.", a:"tax treaty" },
                { t:"France is the ___ because that is where Maya performed her revenue-generating work.", a:"source state" }
            ]
        },
        {
            type:"wordForms", col:"punch",
            icon:"ğŸ”¤", title:"Word Forms",
            sub:"Complete each sentence with the correct word form",
            questions:[
                { p:`The company failed to ___ its tax obligations in France. (compliance â†’ verb)`,                     a:"comply" },
                { p:`The tax authorities began a formal ___ into the company's French activities. (investigate â†’ noun)`, a:"investigation" },
                { p:`The CFO confirmed the company's ___ for French corporate tax. (liable â†’ noun)`,               a:"liability" },
                { p:`Maya's work in Paris was not ___ â€” she was generating real revenue. (prepare â†’ adjective form)`, a:"preparatory" }
            ]
        },
        {
            type:"grammar", col:"teal",
            icon:"ğŸ“–", title:"Conditionals for Legal Advice",
            sub:"Choose the correct conditional form for each sentence",
            explanation:{
                heading:"Conditionals in Legal and Tax Language",
                text:"Tax and legal professionals use conditionals carefully â€” the tense signals how real or likely a risk is.",
                examples:[
                    { label:"Zero conditional â€” general rules:",    text:`<strong>If</strong> an employee habitually signs contracts abroad, a PE <strong>is created</strong>.` },
                    { label:"First conditional â€” real risk:",       text:`<strong>If</strong> this continues, the company <strong>will be liable</strong> for French tax.` },
                    { label:"Third conditional â€” past situation:",  text:`<strong>If</strong> Maya <strong>hadn't signed</strong> the contract, there <strong>would have been</strong> no PE.` }
                ]
            },
            questions:[
                { s:"If an employee ___ contracts on behalf of the company, a PE may be established.",
                  hint:"Zero conditional â€” general legal rule â†’ present simple",
                  opts:["signs","would sign","had signed"], a:"signs" },
                { s:"If the company ___ a tax review now, they will avoid a much larger penalty later.",
                  hint:"First conditional â€” real, current risk â†’ present simple",
                  opts:["conducts","conducted","would conduct"], a:"conducts" },
                { s:"If Maya ___ that email, the tax authorities wouldn't have known about the contract.",
                  hint:"Third conditional â€” past hypothetical â†’ past perfect",
                  opts:["hadn't sent","doesn't send","won't send"], a:"hadn't sent" },
                { s:"If the HR policy ___ a tax review process, this situation could have been prevented.",
                  hint:"Third conditional â€” past missed opportunity â†’ past perfect",
                  opts:["had included","includes","included"], a:"had included" }
            ]
        }
    ],

    badges:[
        { icon:"ğŸ•µï¸", text:"Tax Detective!"  },
        { icon:"âš–ï¸",  text:"Legal Eagle!"    },
        { icon:"ğŸŒ",  text:"Global Pro!"     },
        { icon:"ğŸ“‹",  text:"Due Diligence!"  },
        { icon:"ğŸ”",  text:"Audit Ready!"    },
        { icon:"ğŸ’¼",  text:"Deal Closer!"    },
        { icon:"ğŸ†",  text:"PE Expert!"      }
    ],

    grammar:[
        { question:"Conditionals for legal advice", answer:"Zero/First/Third conditional",
          explanation:"Use zero conditional for general rules, first for current risks, third for past hypotheticals" }
    ]
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let curSec   = 0;
let doneSecs = 0;
let selWord  = null;
let mapVoted = {};
// 0=riskmap  1=briefing  2..n=exercises
const TOTAL  = 2 + L.exercises.length;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUILD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function build() {
    const wrap = document.getElementById('sections');
    let html = '';
    html += secCard(0, true,  'strip-gold',  buildRiskMap());
    html += secCard(1, false, 'strip-blue',  buildBriefing());

    html += `<div class="sec-label">ğŸ“ Practice Exercises</div>`;

    L.exercises.forEach((ex, i) => {
        const n    = i + 2;
        const body = buildExercise(ex, n);
        html += secCard(n, false, `strip-${ex.col}`,
            head(ex.icon, ex.title, ex.sub, n) +
            `<div class="sec-body">${body}</div>`);
    });

    html += `<div class="sec-label">ğŸ“– Vocabulary Glossary</div>`;
    html += buildGlossary();

    wrap.innerHTML = html;
    updateNav(); updateProg();
    setTimeout(wireAll, 60);
}

function secCard(n, visible, strip, inner) {
    return `<div class="sec-card${visible?' visible':''} ${strip}" data-sec="${n}">${inner}</div>`;
}

function head(icon, title, sub, n, extra='') {
    return `<div class="sec-head">
        <div class="sec-head-left">
            <div class="sec-head-icon">${icon}</div>
            <div><div class="sec-head-title">${title}</div><div class="sec-head-sub">${sub}</div></div>
        </div>${extra}
    </div>`;
}

/* â”€â”€ RISK MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function buildRiskMap() {
    const pins = L.riskMap.map(p => {
        // pin group: pulse ring + circle head + text label
        return `<g class="map-pin" id="pin-${p.id}" onclick="openReport('${p.id}')" role="button" aria-label="${p.flag} ${p.name}">
            <circle class="pin-pulse" cx="${p.cx}" cy="${p.cy-14}" r="10" fill="none" stroke="#FFC800" stroke-width="2.5" opacity=".7"/>
            <circle class="pin-head" cx="${p.cx}" cy="${p.cy-14}" r="10" fill="#FFC800" stroke="#E5B400" stroke-width="2"/>
            <text x="${p.cx}" y="${p.cy-10}" text-anchor="middle" font-size="11" font-family="Nunito,sans-serif">${p.flag}</text>
        </g>`;
    }).join('');

    const dots = L.riskMap.map((p,i) =>
        `<div class="map-pin-dot" id="dot-${p.id}">${p.flag}</div>`).join('');

    return head('ğŸŒ', 'Risk Map', 'Tap each employee pin â€” read their situation â€” stamp RISKY or SAFE', 0) +
        `<div class="sec-body">
            <div class="map-counter">
                <span class="map-counter-label" id="map-count-label">Tap a pin to start</span>
                <div class="map-pins-row">${dots}</div>
            </div>
            <div class="map-wrap">
                <svg viewBox="0 0 1000 500" xmlns="http://www.w3.org/2000/svg">
                    <!-- Ocean background -->
                    <rect width="1000" height="500" fill="#D6EAF8"/>
                    <!-- Simplified continents -->
                    <!-- North America -->
                    <path d="M 60 80 L 120 60 L 200 55 L 260 70 L 300 100 L 310 140 L 290 180 L 270 220 L 230 260 L 200 300 L 180 340 L 160 320 L 140 280 L 100 240 L 70 200 L 50 160 L 45 120 Z" fill="#C8E6C9" stroke="#A5D6A7" stroke-width="1.5"/>
                    <!-- Central America -->
                    <path d="M 200 300 L 230 310 L 240 340 L 220 360 L 200 350 L 185 330 Z" fill="#C8E6C9" stroke="#A5D6A7" stroke-width="1.5"/>
                    <!-- South America -->
                    <path d="M 240 320 L 310 310 L 360 330 L 380 370 L 370 420 L 340 460 L 290 470 L 250 450 L 230 410 L 220 370 L 230 340 Z" fill="#C8E6C9" stroke="#A5D6A7" stroke-width="1.5"/>
                    <!-- Europe -->
                    <path d="M 430 80 L 500 70 L 540 80 L 550 110 L 530 140 L 510 150 L 490 145 L 470 160 L 450 155 L 430 140 L 420 120 L 425 95 Z" fill="#C8E6C9" stroke="#A5D6A7" stroke-width="1.5"/>
                    <!-- Scandinavia -->
                    <path d="M 465 55 L 490 45 L 505 60 L 500 80 L 480 85 L 465 75 Z" fill="#C8E6C9" stroke="#A5D6A7" stroke-width="1.5"/>
                    <!-- UK -->
                    <path d="M 435 90 L 448 82 L 455 95 L 445 108 L 432 105 Z" fill="#C8E6C9" stroke="#A5D6A7" stroke-width="1.5"/>
                    <!-- Africa -->
                    <path d="M 440 175 L 490 165 L 540 170 L 565 200 L 560 260 L 540 320 L 510 380 L 480 400 L 455 390 L 435 350 L 415 290 L 410 240 L 415 200 Z" fill="#C8E6C9" stroke="#A5D6A7" stroke-width="1.5"/>
                    <!-- Middle East -->
                    <path d="M 555 140 L 610 135 L 630 160 L 620 190 L 590 200 L 560 195 L 550 170 Z" fill="#C8E6C9" stroke="#A5D6A7" stroke-width="1.5"/>
                    <!-- Russia / Central Asia -->
                    <path d="M 540 55 L 700 45 L 800 55 L 840 80 L 820 110 L 780 120 L 720 115 L 660 120 L 610 115 L 565 100 L 548 75 Z" fill="#C8E6C9" stroke="#A5D6A7" stroke-width="1.5"/>
                    <!-- South Asia -->
                    <path d="M 620 165 L 680 155 L 710 175 L 720 210 L 700 250 L 670 265 L 640 255 L 620 225 L 615 190 Z" fill="#C8E6C9" stroke="#A5D6A7" stroke-width="1.5"/>
                    <!-- SE Asia mainland -->
                    <path d="M 710 175 L 760 170 L 790 190 L 785 220 L 760 235 L 735 230 L 715 210 Z" fill="#C8E6C9" stroke="#A5D6A7" stroke-width="1.5"/>
                    <!-- China -->
                    <path d="M 720 90 L 820 85 L 860 110 L 850 150 L 820 175 L 780 185 L 740 180 L 710 165 L 700 140 L 710 110 Z" fill="#C8E6C9" stroke="#A5D6A7" stroke-width="1.5"/>
                    <!-- Japan -->
                    <path d="M 860 110 L 880 105 L 895 120 L 885 140 L 868 143 L 856 128 Z" fill="#C8E6C9" stroke="#A5D6A7" stroke-width="1.5"/>
                    <!-- SE Asia islands (Indonesia area) -->
                    <path d="M 755 265 L 800 258 L 830 270 L 835 290 L 800 295 L 765 285 Z" fill="#C8E6C9" stroke="#A5D6A7" stroke-width="1.5"/>
                    <path d="M 840 265 L 870 260 L 880 275 L 870 288 L 845 285 Z" fill="#C8E6C9" stroke="#A5D6A7" stroke-width="1.5"/>
                    <!-- Australia -->
                    <path d="M 780 320 L 860 310 L 920 330 L 940 370 L 930 420 L 890 450 L 840 455 L 795 435 L 775 400 L 770 360 Z" fill="#C8E6C9" stroke="#A5D6A7" stroke-width="1.5"/>
                    <!-- Greenland -->
                    <path d="M 280 30 L 340 20 L 380 35 L 370 65 L 330 75 L 285 60 Z" fill="#C8E6C9" stroke="#A5D6A7" stroke-width="1.5"/>
                    <!-- Dotted grid lines (subtle) -->
                    <line x1="0" y1="250" x2="1000" y2="250" stroke="rgba(0,0,0,.06)" stroke-width="1" stroke-dasharray="4,6"/>
                    <line x1="500" y1="0" x2="500" y2="500" stroke="rgba(0,0,0,.06)" stroke-width="1" stroke-dasharray="4,6"/>
                    <!-- Pins (on top) -->
                    ${pins}
                    <!-- Legend -->
                    <rect x="8" y="460" width="130" height="34" rx="8" fill="rgba(255,255,255,.85)" stroke="#CECECE" stroke-width="1"/>
                    <circle cx="24" cy="477" r="6" fill="#FFC800" stroke="#E5B400" stroke-width="1.5"/>
                    <text x="35" y="481" font-size="10" font-family="Nunito,sans-serif" font-weight="800" fill="#4B4B4B">Tap pin to inspect</text>
                </svg>
            </div>
            <div id="map-done-wrap"></div>
        </div>`;
}

/* render/update pin stamp on map */
function stampPin(id, isRisk) {
    const g = document.getElementById(`pin-${id}`);
    if (!g) return;
    const p = L.riskMap.find(x => x.id === id);
    if (!p) return;
    g.classList.add('stamped');
    // add stamp circle overlay
    const ns = 'http://www.w3.org/2000/svg';
    const rect = document.createElementNS(ns, 'circle');
    rect.setAttribute('cx', p.cx);
    rect.setAttribute('cy', p.cy - 14);
    rect.setAttribute('r', '13');
    rect.setAttribute('fill', isRisk ? '#FF4B4B' : '#58CC02');
    rect.setAttribute('stroke', isRisk ? '#EA2B2B' : '#58A700');
    rect.setAttribute('stroke-width', '2.5');
    rect.setAttribute('class', 'map-stamp');
    const txt = document.createElementNS(ns, 'text');
    txt.setAttribute('x', p.cx);
    txt.setAttribute('y', p.cy - 9);
    txt.setAttribute('text-anchor', 'middle');
    txt.setAttribute('font-size', '13');
    txt.setAttribute('class', 'map-stamp');
    txt.setAttribute('style', 'animation-delay:.1s');
    txt.textContent = isRisk ? 'ğŸš¨' : 'âœ…';
    g.appendChild(rect);
    g.appendChild(txt);
}

/* open report sheet */
function openReport(id) {
    const p = L.riskMap.find(x => x.id === id);
    if (!p) return;
    const already = mapVoted[id];
    const sheetHTML = `
        <div class="rs-handle"></div>
        <div class="rs-head">
            <div style="display:flex;align-items:center">
                <span class="rs-flag">${p.flag}</span>
                <div><div class="rs-name">${p.name}</div><div class="rs-loc">ğŸ“ ${p.loc}</div></div>
            </div>
            <button class="rs-close" onclick="closeReport()">Ã—</button>
        </div>
        <div class="rs-body">
            <div class="field-report">
                <div class="fr-label">ğŸ“„ Field Report</div>
                <div class="fr-text">${p.report}</div>
            </div>
            <p class="rs-question">âš–ï¸ ${p.question}</p>
            <div class="stamp-btns">
                <button class="stamp-btn flag${already ? (mapVoted[id]==='risk' ? (L.riskMap.find(x=>x.id===id).isRisk ? ' chosen-correct' : ' chosen-incorrect') : ' chosen-wrong-reveal') : ''}" onclick="castStamp('${id}',true)" ${already?'disabled':''}>
                    <span class="stamp-btn-icon">ğŸš¨</span>
                    <span class="stamp-btn-label">PE Risk</span>
                </button>
                <button class="stamp-btn safe${already ? (mapVoted[id]==='safe' ? (!L.riskMap.find(x=>x.id===id).isRisk ? ' chosen-correct' : ' chosen-incorrect') : ' chosen-wrong-reveal') : ''}" onclick="castStamp('${id}',false)" ${already?'disabled':''}>
                    <span class="stamp-btn-icon">âœ…</span>
                    <span class="stamp-btn-label">Safe</span>
                </button>
            </div>
            <div class="rs-verdict${already?'show':''}" id="rs-verd-${id}" ${already?'':'style="display:none"'}>
                ${already ? buildVerdictHTML(id, already === (p.isRisk ? 'risk' : 'safe'), p) : ''}
            </div>
        </div>`;
    document.getElementById('rs-content').innerHTML = sheetHTML;
    document.getElementById('report-overlay').classList.add('open');
    document.body.style.overflow = 'hidden';
}

function buildVerdictHTML(id, correct, p) {
    const bannerClass = correct ? 'correct' : 'incorrect';
    const bannerText  = correct
        ? (p.isRisk ? p.verdict.correct : p.verdict.correct)
        : (p.isRisk ? p.verdict.wrong   : p.verdict.wrong);
    const nextId = L.riskMap.findIndex(x => x.id === id);
    const nextP  = L.riskMap[nextId + 1];
    const nextBtn = nextP
        ? `<button class="rs-next" onclick="closeReport();setTimeout(()=>openReport('${nextP.id}'),200)">Next: ${nextP.flag} ${nextP.name} â†’</button>`
        : `<button class="rs-next" onclick="closeReport();checkMapDone()">See Your Results ğŸŒ</button>`;
    return `<div class="rs-verd-banner ${bannerClass}">${bannerText}</div>
            <div class="rs-verd-explain">${p.explain}${nextBtn}</div>`;
}

function castStamp(id, votedRisk) {
    const p = L.riskMap.find(x => x.id === id);
    if (!p || mapVoted[id]) return;
    const correct = votedRisk === p.isRisk;
    mapVoted[id]  = votedRisk ? 'risk' : 'safe';
    // animate stamp buttons
    const btns = document.querySelectorAll('.stamp-btn');
    btns.forEach(b => { b.disabled = true; });
    const chosen   = votedRisk ? btns[0] : btns[1];
    const unchosen = votedRisk ? btns[1] : btns[0];
    chosen.classList.add(correct ? 'chosen-correct' : 'chosen-incorrect');
    unchosen.classList.add('chosen-wrong-reveal');
    // show verdict
    const verd = document.getElementById(`rs-verd-${id}`);
    if (verd) { verd.innerHTML = buildVerdictHTML(id, correct, p); verd.classList.add('show'); verd.style.display = 'block'; }
    // stamp on map
    stampPin(id, p.isRisk);
    // update dot counter
    const dot = document.getElementById(`dot-${id}`);
    if (dot) dot.classList.add(p.isRisk ? 'done-risk' : 'done-safe');
    // update label
    const done = Object.keys(mapVoted).length;
    const lbl  = document.getElementById('map-count-label');
    if (lbl) lbl.textContent = `${done} / ${L.riskMap.length} inspected`;
}


function handleOverlayClick(e) {
    if (e.target === document.getElementById('report-overlay')) closeReport();
}
function closeReport() {
    document.getElementById('report-overlay').classList.remove('open');
    document.body.style.overflow = '';
}

function checkMapDone() {
    const done = Object.keys(mapVoted).length;
    if (done < L.riskMap.length) { closeReport(); return; }
    closeReport();
    doneSecs = Math.max(doneSecs, 1); updateProg(); burst(); showBadge(rndBadge());
    const risks = L.riskMap.filter(p => p.isRisk).length;
    const safes = L.riskMap.length - risks;
    document.getElementById('map-done-wrap').innerHTML = `
        <div class="map-done">
            <span class="md-icon">ğŸŒ</span>
            <div class="md-title">All Employees Inspected!</div>
            <div class="md-sub">You identified the global PE risks. Now get the full legal framework.</div>
            <div class="md-score">
                <div class="md-chip risk">ğŸš¨ ${risks} PE risks found</div>
                <div class="md-chip safe">âœ… ${safes} safe situations</div>
            </div>
            <button class="md-btn" onclick="goTo(1)">ğŸ“‹ Get The Legal Briefing â†’</button>
        </div>`;
}

/* â”€â”€ BRIEFING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function buildBriefing() {
    const skipBtn = `<button class="briefing-skip" onclick="goTo(2)">Skip â†’</button>`;
    const blocks  = L.briefing.map((b, bi) => {
        const rows  = b.rows.map(r =>
            `<div class="b-row"><span class="b-key">${r.key}</span><span class="b-val${r.style?' '+r.style:''}">${r.val}</span></div>`).join('');
        const alert = b.alert ? `<div class="b-alert">${b.alert}</div>` : '';
        return `<div class="b-block" data-heat="${b.heat}" style="animation-delay:${bi*.08}s">
            <div class="b-label">${b.label}</div>
            <div class="b-rows">${rows}</div>${alert}
        </div>`;
    }).join('');
    return head('ğŸ“‹','The Briefing','Key rules â€” read before the exercises', 1, skipBtn) +
        `<div class="sec-body">${blocks}
            <button class="briefing-go" onclick="completeSec(1)">Got It â€” Let's Go âš¡</button>
        </div>`;
}

/* â”€â”€ EXERCISE DISPATCHER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function buildExercise(ex, n) {
    if (ex.type === 'trueFalse')      return buildTF(ex, n);
    if (ex.type === 'multipleChoice') return buildMC(ex, n);
    if (ex.type === 'gapFill')        return buildGF(ex, n);
    if (ex.type === 'wordForms')      return buildWF(ex, n);
    if (ex.type === 'grammar')        return buildGR(ex, n);
    return '';
}

function buildTF(ex, n) {
    const qs = ex.questions.map((q, qi) => `
        <div class="q-box">
            <p class="q-text">${qi+1}. ${q.q}</p>
            <div class="opt-grp">
                <button class="opt-btn" data-correct="${q.a===true}">ğŸ‘ True</button>
                <button class="opt-btn" data-correct="${q.a===false}">ğŸ‘ False</button>
            </div>
        </div>`).join('');
    return qs + btnRow(n, false);
}

function buildMC(ex, n) {
    const qs = ex.questions.map((q, qi) => {
        const opts = q.opts.map((o, oi) =>
            `<button class="opt-btn" data-correct="${oi===q.correct}">${o}</button>`).join('');
        return `<div class="q-box"><p class="q-text">${qi+1}. ${q.q}</p><div class="opt-grp">${opts}</div></div>`;
    }).join('');
    return qs + btnRow(n, false);
}

function buildGF(ex, n) {
    const bank  = ex.wordBank.map(w =>
        `<button class="wb-word" data-word="${w}">${w}</button>`).join('');
    const sents = ex.sentences.map((s, si) => {
        const pts = s.t.split('___');
        return `<p style="margin-bottom:.3em">${si+1}. ${pts[0]}<span class="gap" data-answer="${s.a}"></span>${pts[1]||''}</p>`;
    }).join('');
    return `<p style="font-size:13px;font-weight:800;color:var(--ink-3);margin-bottom:12px;">Select a word from the bank, then tap a blank</p>
        <div class="word-bank"><div class="wb-label">Word Bank</div><div class="wb-words">${bank}</div></div>
        <div class="gap-sents">${sents}</div>` + btnRow(n, false);
}

function buildWF(ex, n) {
    const items = ex.questions.map((q, qi) => {
        const hint = q.a[0] + '_'.repeat(Math.max(0, q.a.length - 1));
        return `<div class="wf-item">
            <p class="wf-prompt">${qi+1}. ${q.p}</p>
            <input type="text" class="wf-input" data-answer="${q.a}" placeholder="Type your answerâ€¦">
            <button class="hint-btn" onclick="toggleHint(this)">ğŸ’¡ Hint</button>
            <div class="hint-text">${hint} (${q.a.length} letters)</div>
        </div>`;
    }).join('');
    return items + btnRow(n, true);
}

function buildGR(ex, n) {
    const ex2  = ex.explanation;
    const egs  = (ex2.examples||[]).map(e =>
        `<div class="gram-ex"><strong>${e.label}</strong> ${e.text}</div>`).join('');
    const expl = `<div class="gram-expl"><h4>${ex2.heading}</h4><p>${ex2.text}</p>${egs}</div>`;
    const cards = ex.questions.map((q, qi) => {
        const opts = q.opts.map(o => `<option value="${o}">${o}</option>`).join('');
        return `<div class="gram-card">
            <div class="gc-body">
                <p class="gc-sent">${qi+1}. ${q.s}</p>
                <p class="gc-hint">ğŸ’¡ ${q.hint}</p>
            </div>
            <select class="gram-sel" data-answer="${q.a}"><option value="">Chooseâ€¦</option>${opts}</select>
        </div>`;
    }).join('');
    return expl + cards + btnRow(n, false);
}

function buildGlossary() {
    const items = L.vocabulary.map(w => `
        <div class="voc-item" onclick="showVoc('${w.word.replace(/'/g,"\\'")}')">
            <div class="voc-item-word">${w.word}</div>
            <div class="voc-item-type">${w.type}</div>
            <div class="voc-item-def">${w.definition}</div>
        </div>`).join('');
    return `<div class="sec-card visible strip-gold">
        <div class="sec-head">
            <div class="sec-head-left">
                <div class="sec-head-icon">ğŸ“š</div>
                <div><div class="sec-head-title">All 10 Vocab Words</div><div class="sec-head-sub">Tap any word to hear it pronounced</div></div>
            </div>
        </div>
        <div class="sec-body"><div class="voc-grid">${items}</div></div>
    </div>`;
}

function btnRow(n, hasReveal) {
    return `<div class="btn-row">
        <button class="btn-check" onclick="checkSec(${n})">Check Answers</button>
        ${hasReveal ? `<button class="btn-reveal" onclick="revealWF(${n})">Reveal All</button>` : ''}
        <button class="btn-reset" onclick="resetSec(${n})">Reset</button>
    </div>
    <div id="res-${n}" class="result"></div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAVIGATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function goTo(n) {
    curSec = n;
    const el = document.querySelector(`.sec-card[data-sec="${n}"]`);
    if (el) { el.classList.add('visible'); el.scrollIntoView({behavior:'smooth',block:'start'}); }
    updateNav();
}
function nextSec() { if (curSec < TOTAL-1) { curSec++; goTo(curSec); } else finishLesson(); }
function prevSec() { if (curSec > 0) { curSec--; goTo(curSec); } }

function completeSec(n) {
    doneSecs = Math.max(doneSecs, n);
    updateProg();
    if (n >= TOTAL-1) { finishLesson(); return; }
    const next = document.querySelector(`.sec-card[data-sec="${n+1}"]`);
    if (next) { next.classList.add('visible'); next.scrollIntoView({behavior:'smooth',block:'start'}); }
    if (Math.random() < .3) showBadge(rndBadge());
    curSec = n+1; updateNav();
}

function updateNav() {
    document.getElementById('bn-prev').disabled = curSec === 0;
    document.getElementById('bn-next').textContent = curSec >= TOTAL-1 ? 'ğŸ Finish' : 'Next â†’';
    document.getElementById('bn-ind').textContent  = `${curSec+1}/${TOTAL}`;
}
function updateProg() {
    const pct = Math.round((doneSecs/TOTAL)*100);
    document.getElementById('prog-fill').style.width  = pct + '%';
    document.getElementById('prog-label').textContent = `${doneSecs} / ${TOTAL} sections`;
    document.getElementById('prog-pct').textContent   = pct + '%';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHECKERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function checkSec(n) {
    const type = L.exercises[n-2]?.type;
    if (type === 'trueFalse' || type === 'multipleChoice') checkOpts(n);
    else if (type === 'gapFill')   checkGF(n);
    else if (type === 'wordForms') checkWF(n);
    else if (type === 'grammar')   checkGR(n);
}

function checkOpts(n) {
    const groups = secEl(n).querySelectorAll('.opt-grp');
    let ok = 0, blank = 0;
    groups.forEach(g => {
        const sel = g.querySelector('.opt-btn.selected');
        if (!sel) { blank++; return; }
        g.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('correct','incorrect'));
        sel.dataset.correct === 'true' ? (sel.classList.add('correct'), ok++) : sel.classList.add('incorrect');
    });
    if (blank) return showErr(n, 'Please answer all questions first!');
    showRes(n, ok, groups.length, 'ğŸ‰ All correct!', 'wrong answers in red â€” try again!');
}

function checkGF(n) {
    const gaps = secEl(n).querySelectorAll('.gap'); let ok = 0;
    gaps.forEach(g => {
        g.classList.remove('correct','incorrect');
        const v = (g.textContent||'').trim().toLowerCase();
        if (v === g.dataset.answer.toLowerCase()) { g.classList.add('correct'); ok++; }
        else if (v) g.classList.add('incorrect');
    });
    showRes(n, ok, gaps.length, 'âœ¨ All gaps correct!', 'red gaps are wrong â€” click to clear and retry');
}

function checkWF(n) {
    const inputs = secEl(n).querySelectorAll('.wf-input'); let ok = 0;
    inputs.forEach(i => {
        i.classList.remove('ok','bad');
        if (!i.value.trim()) return;
        i.value.trim().toLowerCase() === i.dataset.answer.toLowerCase()
            ? (i.classList.add('ok'), ok++) : i.classList.add('bad');
    });
    showRes(n, ok, inputs.length, 'ğŸ¯ Word Forms Champion!', 'red boxes are wrong â€” check spelling!');
}

function checkGR(n) {
    const sels = secEl(n).querySelectorAll('.gram-sel'); let ok = 0;
    sels.forEach(s => {
        s.classList.remove('correct','incorrect');
        if (!s.value) return;
        s.value === s.dataset.answer ? (s.classList.add('correct'), ok++) : s.classList.add('incorrect');
    });
    showRes(n, ok, sels.length, 'âš–ï¸ Legal Grammar Ace!', 'red dropdowns are wrong â€” try again!');
}

function revealWF(n) {
    secEl(n).querySelectorAll('.wf-input').forEach(i => {
        i.value = i.dataset.answer; i.classList.add('ok'); i.classList.remove('bad');
    });
    hideRes(n);
}

function resetSec(n) {
    const ex = L.exercises[n-2];
    if (!ex) return;
    if (ex.type === 'trueFalse' || ex.type === 'multipleChoice')
        secEl(n).querySelectorAll('.opt-btn').forEach(b => b.classList.remove('selected','correct','incorrect'));
    if (ex.type === 'gapFill') {
        secEl(n).querySelectorAll('.gap').forEach(g => { g.textContent=''; g.classList.remove('correct','incorrect'); });
        secEl(n).querySelectorAll('.wb-word').forEach(w => w.classList.remove('sel','used'));
        selWord = null;
    }
    if (ex.type === 'wordForms') secEl(n).querySelectorAll('.wf-input').forEach(i => { i.value=''; i.classList.remove('ok','bad'); });
    if (ex.type === 'grammar')   secEl(n).querySelectorAll('.gram-sel').forEach(s => { s.value=''; s.classList.remove('correct','incorrect'); });
    hideRes(n);
}

function showRes(n, ok, total, yep, nope) {
    const el = document.getElementById(`res-${n}`); if (!el) return;
    const perfect = ok === total;
    el.style.display = 'block';
    el.className     = `result ${perfect?'ok':'bad'}`;
    el.textContent   = perfect ? yep : `${ok}/${total} correct â€” ${nope}`;
    if (perfect) { burst(); if (Math.random() < .5) showBadge(rndBadge()); setTimeout(() => completeSec(n), 1400); }
}
function showErr(n, msg) { const e=document.getElementById(`res-${n}`); if(e){e.style.display='block';e.className='result bad';e.textContent=msg;} }
function hideRes(n)      { const e=document.getElementById(`res-${n}`); if(e){e.style.display='none';} }
function secEl(n)        { return document.querySelector(`.sec-card[data-sec="${n}"]`); }

/* â”€â”€ GAP CLICK â”€â”€ */
function gapClick(gap) {
    if (gap.classList.contains('correct')) return;
    if (gap.textContent.trim()) {
        const w = Array.from(gap.closest('.sec-card').querySelectorAll('.wb-word'))
            .find(b => b.dataset.word === gap.textContent.trim());
        if (w) w.classList.remove('used');
        gap.textContent = ''; gap.classList.remove('incorrect');
    } else if (selWord) {
        gap.textContent = selWord.dataset.word;
        selWord.classList.add('used'); selWord.classList.remove('sel');
        selWord = null;
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WIRE ALL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function wireAll() {
    document.querySelectorAll('.opt-grp').forEach(g => {
        g.addEventListener('click', e => {
            const btn = e.target.closest('.opt-btn');
            if (!btn || g.querySelector('.opt-btn.correct')) return;
            g.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('selected','incorrect'));
            btn.classList.add('selected');
        });
    });
    document.querySelectorAll('.wb-word').forEach(w => {
        w.addEventListener('click', () => {
            if (w.classList.contains('used')) return;
            if (w.classList.contains('sel')) { w.classList.remove('sel'); selWord = null; }
            else { document.querySelectorAll('.wb-word').forEach(b => b.classList.remove('sel')); w.classList.add('sel'); selWord = w; }
        });
    });
    document.querySelectorAll('.gap').forEach(g => g.addEventListener('click', () => gapClick(g)));
    document.addEventListener('click', e => {
        const voc = e.target.closest('[data-voc]');
        if (voc) { e.stopPropagation(); showVoc(voc.dataset.voc); return; }
        if (!e.target.closest('#voc-popup')) closeVoc();
    });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VOCAB POPUP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showVoc(word) {
    const w = L.vocabulary.find(v => v.word.toLowerCase() === word.toLowerCase());
    if (!w) return;
    document.getElementById('vp-body').innerHTML = `
        <div class="voc-word">${w.word}</div>
        <div class="voc-type">${w.type}</div>
        <div class="voc-def">${w.definition}</div>
        <button class="voc-hear" onclick="speak('${w.word.replace(/'/g,"\\'")}')">ğŸ”Š Hear It (British English)</button>`;
    document.getElementById('voc-popup').style.display = 'block';
}
function closeVoc() { document.getElementById('voc-popup').style.display = 'none'; }
function speak(word) {
    const u = new SpeechSynthesisUtterance(word);
    u.lang = 'en-GB'; u.rate = .85;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CELEBRATIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const COLOURS = ['#FFC800','#58CC02','#1CB0F6','#FF4B4B','#CE82FF','#2BDECC'];
function burst() {
    for (let i = 0; i < 18; i++) {
        const d = document.createElement('div');
        d.className = 'confetti-dot';
        d.style.cssText = `left:${25+Math.random()*50}vw;top:${15+Math.random()*35}vh;background:${COLOURS[Math.floor(Math.random()*COLOURS.length)]};animation-delay:${Math.random()*.35}s;animation-duration:${.65+Math.random()*.6}s;transform:rotate(${Math.random()*360}deg)`;
        document.body.appendChild(d);
        setTimeout(() => d.remove(), 1300);
    }
}
function showBadge(b) {
    const el = document.createElement('div');
    el.className = 'badge';
    el.innerHTML = `<span class="badge-icon">${b.icon}</span><span class="badge-text">${b.text}</span>`;
    document.getElementById('badge-wrap').appendChild(el);
    setTimeout(() => el.classList.add('show'), 80);
    setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 400); }, 2800);
}
function rndBadge() { return L.badges[Math.floor(Math.random()*L.badges.length)]; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FINISH LESSON
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function finishLesson() {
    doneSecs = TOTAL; updateProg();
    if (!window.EFCD_Auth?.getCurrentUser()) {
        localStorage.setItem('efcd_last_lesson_done', 'true');
        if (confirm('ğŸ•µï¸ Lesson complete!\n\nSign up free to save your XP, streaks and badges.\n\nOK = Sign up | Cancel = Keep browsing'))
            window.location.href = '/signup/';
        else if (typeof showWordMatchGame === 'function')
            showWordMatchGame(L.vocabulary, () => window.location.href = L.levelPage);
        else window.location.href = L.levelPage;
        return;
    }
    localStorage.setItem('efcd_last_lesson_done', 'true');
    const completionTime = Math.floor((Date.now() - performance.timing.navigationStart) / 1000);
    const result = await window.EFCD_Auth.completeLesson({
        lessonId:       L.lessonId,
        lessonTitle:    L.title,
        lessonLevel:    L.level,
        lessonLink:     L.lessonLink,
        vocabulary:     L.vocabulary,
        grammar:        L.grammar,
        perfectScore:   true,
        completionTime: completionTime
    });

    if (window.DailyChallenges && result?.success) {
        const cr = await window.DailyChallenges.updateChallengeProgress({
            perfectScore:   true,
            vocabCount:     L.vocabulary.length,
            completionTime: completionTime,
            grammarPerfect: true
        });
        if (cr?.justCompleted) {
            setTimeout(() => window.DailyChallenges.showChallengeCompletionCelebration?.(cr.challenge), 900);
        }
    }

    if (typeof showWordMatchGame === 'function')
        showWordMatchGame(L.vocabulary, gr => showEndScreen(result, gr));
    else showEndScreen(result, null);
}

function showEndScreen(res, game) {
    const xp = (res?.xpEarned||0) + (game?.bonusXP||0);
    const ov = document.createElement('div');
    ov.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;animation:up .3s ease both;';
    ov.innerHTML = `
        <div style="background:var(--white);border:2px solid var(--border-heavy);border-bottom:8px solid var(--border-heavy);border-radius:var(--r);max-width:420px;width:100%;overflow:hidden;animation:popin .4s cubic-bezier(.175,.885,.32,1.275) both;">
            <div style="background:linear-gradient(135deg,var(--yellow) 0%,#FFE066 100%);padding:28px 20px 24px;text-align:center;position:relative;">
                <button onclick="this.closest('div').parentElement.parentElement.remove()" style="position:absolute;top:10px;right:10px;background:rgba(0,0,0,.1);border:2px solid rgba(0,0,0,.15);border-radius:var(--rxs);color:var(--ink-bold);font-size:20px;font-weight:900;width:34px;height:34px;cursor:pointer;font-family:inherit;line-height:1;display:flex;align-items:center;justify-content:center;">Ã—</button>
                <div style="font-size:68px;margin-bottom:8px;">ğŸ•µï¸</div>
                <div style="font-size:13px;font-weight:900;color:var(--accent-text);text-transform:uppercase;letter-spacing:2px;margin-bottom:4px;">Case Closed</div>
                <div style="font-size:30px;font-weight:900;color:var(--ink-bold);letter-spacing:-1px;">PE Expert status achieved!</div>
            </div>
            <div style="padding:20px;display:flex;flex-direction:column;gap:14px;">
                <div style="background:var(--bg);border:2px solid var(--border-heavy);border-bottom:4px solid var(--border-heavy);border-radius:var(--rsm);padding:18px;text-align:center;">
                    <div style="font-size:48px;font-weight:900;color:var(--yellow-shadow);">+${xp} XP</div>
                    ${res?.leveledUp ? `<div style="color:var(--green-shadow);font-weight:900;font-size:16px;margin-top:6px;">ğŸŠ LEVEL UP â†’ Level ${res.newLevel}!</div>` : ''}
                    ${res?.newStreak > 0 ? `<div style="color:var(--ink-3);font-weight:800;font-size:14px;margin-top:4px;">ğŸ”¥ ${res.newStreak}-day streak!</div>` : ''}
                </div>
                <a href="${L.levelPage}" style="display:flex;align-items:center;justify-content:center;gap:8px;padding:15px;background:var(--green);color:var(--white);font-size:16px;font-weight:900;border-radius:var(--rsm);border:2px solid var(--green-shadow);border-bottom:5px solid var(--green-shadow);">More Tax Lessons â†’</a>
                <a href="/dashboard-gamified/" style="display:flex;align-items:center;justify-content:center;padding:13px;background:var(--bg);color:var(--ink-3);font-size:14px;font-weight:800;border-radius:var(--rsm);border:2px solid var(--border-heavy);border-bottom:3px solid var(--border-heavy);">View Dashboard</a>
            </div>
        </div>`;
    document.body.appendChild(ov);
    burst(); setTimeout(burst, 300);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HINTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleHint(btn) {
    const hint = btn.nextElementSibling;
    if (!hint) return;
    hint.classList.toggle('show');
    btn.textContent = hint.classList.contains('show') ? 'ğŸ™ˆ Hide hint' : 'ğŸ’¡ Hint';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATS â€” header XP/streak
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initStats() {
    localStorage.setItem('efcd_last_lesson_url',  window.location.pathname);
    localStorage.setItem('efcd_last_lesson_name', 'The Invisible Office');
    localStorage.setItem('efcd_last_lesson_done', 'false');

    function tryInit() {
        if (typeof window.efcdReady === 'undefined') { setTimeout(tryInit, 50); return; }
        window.efcdReady.then(async () => {
            if (!window.EFCD_Auth) return;
            await window.EFCD_Auth.initAuth();
            const user = window.EFCD_Auth.getCurrentUser();
            if (user) {
                const s = window.EFCD_Auth.getUserStats();
                document.getElementById('hdr-streak').textContent = s?.streak || 0;
                document.getElementById('hdr-xp').textContent     = (s?.xp || 0).toLocaleString();
            }
        }).catch(() => {});
    }
    tryInit();
}

build();
initStats();
if (window.DailyChallenges) {
    const w = document.getElementById('daily-challenge-widget');
    if (w) {
        w.innerHTML = window.DailyChallenges.renderDailyChallengeWidget();
        const btn = w.querySelector('.dc-quest-btn');
        if (btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                if (typeof openPicker === 'function') { openPicker(); return; }

                const isEarlyBird = new Date().getHours() < 10;
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;';

                if (isEarlyBird) {
                    overlay.innerHTML = '<div style="background:linear-gradient(135deg,#FF9500 0%,#FFB800 100%);padding:36px 28px;border-radius:24px;border:2px solid #E5B400;border-bottom:6px solid #cc9000;text-align:center;max-width:360px;width:100%;font-family:Nunito,sans-serif;">'
                        + '<div style="font-size:72px;margin-bottom:4px;">ğŸ¦</div>'
                        + '<div style="font-size:72px;margin-bottom:16px;">ğŸª±</div>'
                        + '<div style="font-size:24px;font-weight:900;color:#fff;margin-bottom:8px;">THE EARLY BIRD GETS THE WORM!</div>'
                        + '<div style="font-size:15px;font-weight:800;color:rgba(255,255,255,.9);margin-bottom:24px;">You absolute legend â€” most people are still asleep. Go smash this lesson! ğŸ”¥</div>'
                        + '<button id="dc-modal-go" style="width:100%;padding:15px;background:#fff;color:#cc7000;border:none;border-radius:16px;font-size:17px;font-weight:900;cursor:pointer;margin-bottom:10px;">ğŸŒ… Start This Lesson Now â†’</button>'
                        + '<button id="dc-modal-close" style="background:none;border:none;color:rgba(255,255,255,.7);font-size:13px;font-weight:800;cursor:pointer;display:block;width:100%;">I\'ll do it later...</button>'
                        + '</div>';
                } else {
                    overlay.innerHTML = '<div style="background:linear-gradient(135deg,#1CB0F6 0%,#0d8fd4 100%);padding:36px 28px;border-radius:24px;border:2px solid #1899D6;border-bottom:6px solid #1266a8;text-align:center;max-width:360px;width:100%;font-family:Nunito,sans-serif;">'
                        + '<div style="font-size:72px;margin-bottom:12px;">ğŸ˜´</div>'
                        + '<div style="font-size:24px;font-weight:900;color:#fff;margin-bottom:8px;">The worm is asleep...</div>'
                        + '<div style="font-size:15px;font-weight:800;color:rgba(255,255,255,.9);margin-bottom:8px;">The Early Bird bonus has expired â€” but that\'s no reason to stop!</div>'
                        + '<div style="background:rgba(255,255,255,.15);border-radius:14px;padding:14px;margin-bottom:20px;">'
                        + '<div style="font-size:13px;font-weight:800;color:rgba(255,255,255,.8);">ğŸ’¡ No XP bonus â€” but you\'ll still learn something brilliant today. Do it anyway!</div>'
                        + '</div>'
                        + '<button id="dc-modal-go" style="width:100%;padding:15px;background:#FFC800;color:#111827;border:none;border-radius:16px;font-size:17px;font-weight:900;cursor:pointer;margin-bottom:10px;">ğŸ’ª Complete This Lesson Anyway!</button>'
                        + '<button id="dc-modal-close" style="background:none;border:none;color:rgba(255,255,255,.7);font-size:13px;font-weight:800;cursor:pointer;display:block;width:100%;">remind me tomorrow</button>'
                        + '</div>';
                }

                document.body.appendChild(overlay);

                // Wire buttons immediately after appendChild â€” they are guaranteed in DOM now
                document.getElementById('dc-modal-go').addEventListener('click', function() {
                    overlay.remove();
                    // already ON the lesson page â€” just close the modal, they're in the right place!
                });
                document.getElementById('dc-modal-close').addEventListener('click', function() {
                    overlay.remove();
                });
                overlay.addEventListener('click', function(e) {
                    if (e.target === overlay) overlay.remove();
                });
            });
        }
    }
}
</script>
</body>
</html>
