<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Chicken Tax - English For Cool Dudes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; background: #FFF8E1; color: #5D4037; line-height: 1.6; }
        :root { --color-primary: #FF9800; --color-secondary: #5D4037; --color-correct: #689F38; --color-incorrect: #D32F2F; --color-save-btn: #E65100; }
        .header { background: white; border-bottom: 1px solid #FFE082; padding: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.04); position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .logo { width: 36px; height: 36px; background: linear-gradient(135deg, #FFB74D 0%, #FF6F00 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .site-title { font-size: 20px; font-weight: 800; color: #5D4037; text-decoration: none; }
        .header-buttons { display: flex; align-items: center; gap: 8px; }
        .header-button { text-decoration: none; padding: 7px 14px; border-radius: 6px; font-size: 14px; font-weight: 600; transition: all 0.2s; cursor: pointer; border: 1px solid #FFE082; background: transparent; }
        .header-button.login { background: #FFF8E1; color: #E65100; }
        .header-button.signup { background: var(--color-primary); color: white; }
        .header-button.dashboard { background: #FFF9C4; color: #F57F17; }
        .header-button.logout { background: #FFEBEE; color: #C62828; }
        .user-greeting { font-size: 14px; color: #E65100; font-weight: 600; margin-right: 5px; }
        .container-main { max-width: 1000px; margin: 30px auto; padding: 30px 20px; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); border: 1px solid #FFE082; }
        .lesson-main-title { font-size: 2.5em; font-weight: 800; color: var(--color-secondary); margin-bottom: 10px; }
        .lesson-section { background: #FFFDE7; padding: 30px; border-radius: 10px; border: 1px solid #FFE082; margin-bottom: 30px; }
        .section-title { color: var(--color-secondary); font-size: 1.8em; font-weight: 800; margin-bottom: 20px; padding-bottom: 5px; border-bottom: 2px dashed #FFD54F; }
        .reading-text { background: white; border-left: 5px solid var(--color-primary); padding: 20px; border-radius: 0 8px 8px 0; font-size: 1.1em; color: #37474F; line-height: 1.8; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .highlight-word { color: var(--color-primary); font-weight: 700; cursor: help; border-bottom: 2px dotted var(--color-primary); }
        .highlight-word:hover { background-color: #FFF3E0; color: var(--color-secondary); }
        .comp-btn-group .option-button { transition: all 0.2s; background: white; color: #E65100; font-weight: 600; padding: 10px 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 1px solid #FFD54F; text-align: left; width: 100%; cursor: pointer; margin-bottom: 8px; }
        .comp-btn-group .option-button:hover { border-color: var(--color-primary); background: #FFF8E1; }
        .comp-btn-group .option-button.selected { background: #FFE082; color: #5D4037; border-color: var(--color-secondary); }
        .comp-btn-group .option-button.correct { background: #8BC34A !important; color: white !important; border-color: #689F38 !important; }
        .comp-btn-group .option-button.incorrect { background: #EF5350 !important; color: white !important; border-color: #D32F2F !important; }
        .result-message { margin-top: 15px; padding: 15px; border-radius: 8px; font-weight: 700; display: none; text-align: center; }
        .result-message.correct { background: #DCEDC8; color: #33691E; border: 1px solid #8BC34A; }
        .result-message.incorrect { background: #FFCDD2; color: #B71C1C; border: 1px solid #E57373; }
        .word-bank { background: #FFE082; border: 2px solid var(--color-secondary); border-radius: 10px; padding: 15px; margin-bottom: 20px; }
        .word-options { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .word-option { background: var(--color-secondary); color: white; padding: 10px 15px; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .word-option:hover { background: #4E342E; }
        .word-option.selected { background: var(--color-primary) !important; transform: scale(1.05); }
        .word-option.used { opacity: 0.4; pointer-events: none; background: #78909C; }
        .gap-input { display: inline-block; text-align: center; padding: 6px 10px; min-width: 150px; height: 38px; background: #FFF8E1; border: 1px dashed #FF9800; border-radius: 4px; color: #5D4037; font-weight: 600; cursor: pointer; margin: 0 4px; transition: all 0.2s; vertical-align: middle; }
        .gap-input.correct { background: #C5E1A5 !important; border-color: #689F38 !important; color: #33691E !important; border-style: solid !important; }
        .gap-input.incorrect { background: #EF9A9A !important; border-color: #D32F2F !important; color: #B71C1C !important; border-style: solid !important; }
        .button-group { margin-top: 20px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
        .check-button { background: var(--color-secondary); color: white; border: none; padding: 12px 25px; border-radius: 9999px; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.3s; }
        .check-button:hover { background: #4E342E; }
        .reset-button { background: #78909C; }
        .reveal-button { background: #FFB300; color: #3E2723; }
        .reveal-button:hover { background: #FFA000; }
        #dictionary-popup { position: fixed; width: 280px; padding: 20px; background: white; border: 3px solid var(--color-secondary); border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); z-index: 2001; display: none; color: #5D4037; }
        .word-form-input { width: 100%; padding: 12px; border: 2px solid #D1D5DB; border-radius: 8px; font-size: 1em; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <span class="logo">üêî</span>
                <a href="/tax/" class="site-title">English For Cool Dudes</a>
            </div>
            <div id="logged-out-buttons" class="header-buttons">
                <a href="/login/" class="header-button login">Login</a>
                <a href="/signup/" class="header-button signup">Sign Up</a>
            </div>
            <div id="logged-in-buttons" class="header-buttons" style="display: none;">
                <span class="user-greeting" id="user-greeting">Hey Cool Dude! üëã</span>
                <a href="/dashboard/" class="header-button dashboard">My Dashboard</a>
                <button id="logout-btn" class="header-button logout">Sign Out</button>
            </div>
        </div>
    </header>

    <div class="container-main">
        <h1 class="lesson-main-title">üêî The Chicken Tax</h1>
        <p class="text-lg text-gray-500 mb-8">Intermediate-level reading about trade history!</p>

        <section class="lesson-section">
            <h2 class="section-title">üì∞ Reading: The Chicken Tax</h2>
            <div class="reading-text">
                <p class="mb-4">In the 1960s, a simple chicken caused a big problem between countries. After World War II, American farmers sold cheap chicken to Europe. It was so cheap that German farmers could not sell their own chicken. To help German farmers, the German <span class="highlight-word" onclick="showPopup(this, 'Government')">government</span> put a tax on American chicken.</p>
                <p class="mb-4">The American government was <span class="highlight-word" onclick="showPopup(this, 'Angry')">angry</span>. <span class="highlight-word" onclick="showPopup(this, 'To get back')">To get back</span> at Germany, the USA put a 25% tax on some things from Europe. One of these things was light <span class="highlight-word" onclick="showPopup(this, 'Trucks')">trucks</span> from Germany and Japan. This tax was called the "Chicken Tax."</p>
                <p class="mb-4">The Chicken Tax changed the car <span class="highlight-word" onclick="showPopup(this, 'Industry')">industry</span>. For many years, it <span class="highlight-word" onclick="showPopup(this, 'Protected')">protected</span> American car companies from other countries. Some companies still try to <span class="highlight-word" onclick="showPopup(this, 'Avoid')">avoid</span> this tax. They build trucks in two countries to pay less tax.</p>
                <p>A small <span class="highlight-word" onclick="showPopup(this, 'Fight')">fight</span> about chicken became a big rule for trucks. Not bad for a chicken!</p>
            </div>
        </section>

        <section class="lesson-section">
            <h2 class="section-title">‚úÖ 1. True / False / Not Given</h2>
            <div class="question mb-6">
                <p class="font-semibold text-lg mb-3">1. American chicken was cheaper than German chicken.</p>
                <ul class="comp-btn-group">
                    <li class="option-button" data-correct="true">True</li>
                    <li class="option-button" data-correct="false">False</li>
                    <li class="option-button" data-correct="false">Not Given</li>
                </ul>
            </div>
            <div class="question mb-6">
                <p class="font-semibold text-lg mb-3">2. Germany put a tax on chicken to help German farmers.</p>
                <ul class="comp-btn-group">
                    <li class="option-button" data-correct="true">True</li>
                    <li class="option-button" data-correct="false">False</li>
                    <li class="option-button" data-correct="false">Not Given</li>
                </ul>
            </div>
            <div class="question mb-6">
                <p class="font-semibold text-lg mb-3">3. America taxed European trucks as revenge.</p>
                <ul class="comp-btn-group">
                    <li class="option-button" data-correct="true">True</li>
                    <li class="option-button" data-correct="false">False</li>
                    <li class="option-button" data-correct="false">Not Given</li>
                </ul>
            </div>
            <div class="button-group">
                <button class="check-button" onclick="checkComprehension()">Check Answers</button>
                <button class="check-button reset-button" onclick="resetComprehension()">Reset</button>
            </div>
            <div id="comprehension-result" class="result-message"></div>
        </section>

        <section class="lesson-section">
            <h2 class="section-title">üß© 2. Grammar: Gap Fill</h2>
            <div class="word-bank">
                <h4 class="font-bold mb-3 text-center">Word Bank:</h4>
                <div class="word-options" id="gap-fill-options">
                    <span class="word-option" data-word="repaired">repaired</span>
                    <span class="word-option" data-word="painted">painted</span>
                    <span class="word-option" data-word="manufactured">manufactured</span>
                    <span class="word-option" data-word="sent">sent</span>
                </div>
            </div>
            <div class="text-lg">
                <p class="mb-5">1. Some companies have their trucks <span class="gap-input" data-answer="manufactured"></span> abroad.</p>
                <p class="mb-5">2. They got the parts <span class="gap-input" data-answer="sent"></span> to Canada.</p>
                <p class="mb-5">3. We have the trucks <span class="gap-input" data-answer="painted"></span> red here to save money.</p>
                <p class="mb-5">4. He got his van <span class="gap-input" data-answer="repaired"></span> at the garage.</p>
            </div>
            <div class="button-group">
                <button class="check-button" onclick="checkGaps()">Check Answers</button>
                <button class="check-button reset-button" onclick="resetGaps()">Reset</button>
            </div>
            <div id="gap-result" class="result-message"></div>
        </section>

        <section class="lesson-section">
            <h2 class="section-title">üî§ 3. Word Forms</h2>
            <div class="space-y-4">
                <div>
                    <p class="font-semibold text-lg mb-2">1. The __________ of chicken was very high. (produce)</p>
                    <input type="text" class="word-form-input" data-answer="production" placeholder="Type your answer...">
                </div>
                <div>
                    <p class="font-semibold text-lg mb-2">2. The prices were __________ high. (artificial)</p>
                    <input type="text" class="word-form-input" data-answer="artificially" placeholder="Type your answer...">
                </div>
                <div>
                    <p class="font-semibold text-lg mb-2">3. Companies were __________ hurt by the tax. (heavy)</p>
                    <input type="text" class="word-form-input" data-answer="heavily" placeholder="Type your answer...">
                </div>
                <div>
                    <p class="font-semibold text-lg mb-2">4. The tax was __________ made. (intent)</p>
                    <input type="text" class="word-form-input" data-answer="intentionally" placeholder="Type your answer...">
                </div>
            </div>
            <div class="button-group">
                <button class="check-button" onclick="checkWordForms()">Check Answers</button>
                <button class="check-button reveal-button" onclick="revealWordForms()">Reveal Answers</button>
                <button class="check-button reset-button" onclick="resetWordForms()">Reset</button>
            </div>
            <div id="wordform-result" class="result-message"></div>
        </section>

        <section id="save-words-section" class="bg-amber-50 border-2 border-amber-200 p-6 rounded-xl text-center">
            <h2 class="section-title">üìö Words You've Learned</h2>
            <ul id="learned-words-list" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <li class="bg-white border-2 border-amber-300 p-2 rounded-lg cursor-pointer font-bold text-orange-700" data-word="Government">Government</li>
                <li class="bg-white border-2 border-amber-300 p-2 rounded-lg cursor-pointer font-bold text-orange-700" data-word="Angry">Angry</li>
                <li class="bg-white border-2 border-amber-300 p-2 rounded-lg cursor-pointer font-bold text-orange-700" data-word="To get back">To get back</li>
                <li class="bg-white border-2 border-amber-300 p-2 rounded-lg cursor-pointer font-bold text-orange-700" data-word="Trucks">Trucks</li>
                <li class="bg-white border-2 border-amber-300 p-2 rounded-lg cursor-pointer font-bold text-orange-700" data-word="Industry">Industry</li>
                <li class="bg-white border-2 border-amber-300 p-2 rounded-lg cursor-pointer font-bold text-orange-700" data-word="Protected">Protected</li>
                <li class="bg-white border-2 border-amber-300 p-2 rounded-lg cursor-pointer font-bold text-orange-700" data-word="Avoid">Avoid</li>
                <li class="bg-white border-2 border-amber-300 p-2 rounded-lg cursor-pointer font-bold text-orange-700" data-word="Fight">Fight</li>
            </ul>
            <div id="save-feature-loggedin" style="display: none;">
                <button id="save-words-btn" onclick="saveWordsToDashboard()" class="w-full bg-orange-600 text-white font-bold py-3 rounded-lg shadow-[0_4px_#BF360C] hover:bg-orange-700 active:translate-y-1">Save All Words to Dashboard</button>
                <p id="save-status" class="mt-3 font-semibold"></p>
            </div>
            <div id="login-prompt">
                <p class="text-red-600 font-bold mb-2">üîí Login Required to Save Progress</p>
                <a href="/login/" class="inline-block bg-orange-600 text-white font-bold py-2 px-4 rounded hover:bg-orange-700">Log In / Sign Up</a>
            </div>
        </section>
    </div>

    <div id="dictionary-popup"></div>

    <script>
        const SUPABASE_URL = 'https://knwgmrgwbpchqyqxbxea.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtud2dtcmd3YnBjaHF5cXhieGVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MDkyODgsImV4cCI6MjA3ODA4NTI4OH0.qnp2ScwSE77_idmPhpLE98sr46WvLpKtg6refFfC7s8';
        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentUser = null;

        const wordsToSave = [
            { word: "Government", type: "noun", definition: "A system of ruling, controlling." },
            { word: "Angry", type: "adjective", definition: "Feeling or showing strong annoyance or hostility." },
            { word: "To get back", type: "phrasal verb", definition: "Take revenge, retaliate." },
            { word: "Trucks", type: "noun", definition: "Large vehicles for moving goods." },
            { word: "Industry", type: "noun", definition: "A specific area of business producing certain goods." },
            { word: "Protected", type: "adjective", definition: "Kept safe from danger." },
            { word: "Avoid", type: "verb", definition: "Try not to do or pay something." },
            { word: "Fight", type: "noun", definition: "A struggle or conflict." }
        ];

        async function checkUser() {
            try {
                const { data: { user } } = await sb.auth.getUser();
                if (user) {
                    currentUser = user;
                    document.getElementById('logged-in-buttons').style.display = 'flex';
                    document.getElementById('logged-out-buttons').style.display = 'none';
                    document.getElementById('save-feature-loggedin').style.display = 'block';
                    document.getElementById('login-prompt').style.display = 'none';
                    const name = user.user_metadata.full_name ? user.user_metadata.full_name.split(' ')[0] : 'Cool Dude';
                    document.getElementById('user-greeting').textContent = `Hey ${name}! üëã`;
                }
            } catch (err) { console.error(err); }
        }

        function showPopup(target, word) {
            const wordObj = wordsToSave.find(w => w.word.toLowerCase() === word.toLowerCase());
            const popup = document.getElementById('dictionary-popup');
            if (!popup || !wordObj) return;

            popup.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                    <div><strong>${wordObj.word}</strong> <span style="font-size:0.85em; color:#E65100;">(${wordObj.type})</span></div>
                    <button onclick="playAudio('${wordObj.word}')" style="background: var(--color-primary); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer;">üîä</button>
                </div>
                <div style="color: #334155; line-height: 1.5;">${wordObj.definition}</div>
            `;

            popup.style.display = 'block';
            const rect = target.getBoundingClientRect();
            let leftPos = rect.left;
            let topPos = rect.bottom + 10;
            if (leftPos + 300 > window.innerWidth) leftPos = window.innerWidth - 320;
            if (topPos + 150 > window.innerHeight) topPos = rect.top - popup.offsetHeight - 10;
            popup.style.left = Math.max(10, leftPos) + 'px';
            popup.style.top = topPos + 'px';
        }

        function hidePopup() { document.getElementById('dictionary-popup').style.display = 'none'; }
        function playAudio(word) { window.speechSynthesis.cancel(); window.speechSynthesis.speak(new SpeechSynthesisUtterance(word)); }

        function checkComprehension() {
            const questions = document.querySelectorAll('.question');
            let correct = 0;
            questions.forEach(q => {
                const selected = q.querySelector('.option-button.selected');
                q.querySelectorAll('.option-button').forEach(opt => {
                    opt.classList.remove('correct', 'incorrect');
                    if (opt.dataset.correct === 'true') opt.classList.add('correct');
                });
                if (selected && selected.dataset.correct === 'true') correct++;
                else if (selected) selected.classList.add('incorrect');
            });
            const res = document.getElementById('comprehension-result');
            res.style.display = 'block';
            res.textContent = `${correct}/${questions.length} correct.`;
            res.className = correct === questions.length ? 'result-message correct' : 'result-message incorrect';
        }

        function resetComprehension() {
            document.querySelectorAll('.option-button').forEach(btn => btn.classList.remove('selected', 'correct', 'incorrect'));
            document.getElementById('comprehension-result').style.display = 'none';
        }

        let selectedGapWord = null;
        function checkGaps() {
            let correct = 0;
            const blanks = document.querySelectorAll('.gap-input');
            blanks.forEach(blank => {
                const isCorrect = blank.textContent.trim().toLowerCase() === blank.dataset.answer.toLowerCase();
                blank.classList.remove('correct', 'incorrect');
                if (isCorrect) { blank.classList.add('correct'); correct++; }
                else if (blank.textContent) blank.classList.add('incorrect');
            });
            const res = document.getElementById('gap-result');
            res.style.display = 'block';
            res.textContent = `${correct}/${blanks.length} correct.`;
            res.className = correct === blanks.length ? 'result-message correct' : 'result-message incorrect';
        }

        // --- FIXED RESET GAPS FUNCTION ---
        function resetGaps() {
            selectedGapWord = null;
            document.querySelectorAll('.gap-input').forEach(blank => {
                blank.textContent = '';
                blank.classList.remove('correct', 'incorrect');
            });
            document.querySelectorAll('.word-option').forEach(opt => {
                opt.classList.remove('used', 'selected');
            });
            document.getElementById('gap-result').style.display = 'none';
        }

        function checkWordForms() {
            let correct = 0;
            const inputs = document.querySelectorAll('.word-form-input');
            inputs.forEach(input => {
                const isCorrect = input.value.trim().toLowerCase() === input.dataset.answer.toLowerCase();
                input.style.borderColor = isCorrect ? '#689F38' : '#D32F2F';
                input.style.background = isCorrect ? '#DCEDC8' : '#FFCDD2';
                if (isCorrect) correct++;
            });
            const res = document.getElementById('wordform-result');
            res.style.display = 'block';
            res.textContent = `${correct}/${inputs.length} correct.`;
            res.className = correct === inputs.length ? 'result-message correct' : 'result-message incorrect';
        }

        function revealWordForms() {
            document.querySelectorAll('.word-form-input').forEach(input => {
                input.value = input.dataset.answer;
                input.style.borderColor = '#689F38';
                input.style.background = '#DCEDC8';
            });
            document.getElementById('wordform-result').style.display = 'none';
        }

        function resetWordForms() {
            document.querySelectorAll('.word-form-input').forEach(input => {
                input.value = '';
                input.style.borderColor = '#D1D5DB';
                input.style.background = 'white';
            });
            document.getElementById('wordform-result').style.display = 'none';
        }

        window.addEventListener('DOMContentLoaded', () => {
            checkUser();
            document.addEventListener('click', (e) => {
                if (!e.target.classList.contains('highlight-word') && !e.target.closest('#dictionary-popup') && !e.target.closest('#learned-words-list li')) {
                    hidePopup();
                }
            });
            window.addEventListener('scroll', hidePopup, { passive: true });

            document.querySelectorAll('.option-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.closest('.comp-btn-group').querySelectorAll('.option-button').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                });
            });

            document.querySelectorAll('.word-option').forEach(option => {
                option.addEventListener('click', () => {
                    if (option.classList.contains('used')) return;
                    document.querySelectorAll('.word-option').forEach(o => o.classList.remove('selected'));
                    selectedGapWord = option;
                    option.classList.add('selected');
                });
            });

            document.querySelectorAll('.gap-input').forEach(blank => {
                blank.addEventListener('click', () => {
                    if (selectedGapWord) {
                        if (blank.textContent) {
                            const oldOpt = Array.from(document.querySelectorAll('.word-option')).find(o => o.dataset.word === blank.textContent);
                            if (oldOpt) oldOpt.classList.remove('used');
                        }
                        blank.textContent = selectedGapWord.dataset.word;
                        selectedGapWord.classList.add('used');
                        selectedGapWord.classList.remove('selected');
                        selectedGapWord = null;
                    } else if (blank.textContent) {
                        const opt = Array.from(document.querySelectorAll('.word-option')).find(o => o.dataset.word === blank.textContent);
                        if (opt) opt.classList.remove('used');
                        blank.textContent = '';
                    }
                });
            });

            document.querySelectorAll('#learned-words-list li').forEach(li => {
                li.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showPopup(li, li.dataset.word);
                    playAudio(li.dataset.word);
                });
            });
        });
    </script>
</body>
</html>
