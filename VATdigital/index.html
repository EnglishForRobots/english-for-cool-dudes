<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>VAT on Digital Services - English for Cool Dudes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --color-primary: #0EA5E9;
            --color-secondary: #8B5CF6;
            --color-accent: #F472B6;
            --color-background: #F0F9FF;
            --color-text: #0F172A;
            --color-correct: #10B981;
            --color-incorrect: #EF4444;
            --color-new-feature: #6366F1;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--color-background);
            color: var(--color-text);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* --- HEADER --- */
        .header {
            background: #FFFFFF;
            border-bottom: 1px solid #E2E8F0;
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .header-buttons { display: flex; align-items: center; gap: 8px; }
        .header-button {
            text-decoration: none; padding: 7px 14px; border-radius: 6px;
            font-size: 14px; font-weight: 600; cursor: pointer; border: 1px solid #E2E8F0;
        }
        .header-button.signup { background: var(--color-primary); color: white; border: none; }

        /* --- LESSON CARDS --- */
        .lesson-container { max-width: 800px; margin: 20px auto 40px; padding: 0 15px; min-height: 80vh; }
        .content-card {
            background: #FFFFFF; border-radius: 12px; padding: 24px; margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #F1F5F9;
        }
        
        .collapsible-header {
            color: var(--color-secondary); font-size: 1.4em; font-weight: 700;
            margin-bottom: 15px; border-bottom: 2px dashed var(--color-primary);
            padding-bottom: 5px; cursor: pointer;
        }

        .reading-text {
            background: #F8FAFC; border-left: 4px solid var(--color-primary);
            padding: 20px; border-radius: 0 8px 8px 0; font-size: 1.05em;
        }

        /* --- INTERACTIVE ELEMENTS --- */
        .dictionary-word {
            text-decoration: underline dashed var(--color-secondary) 2px;
            text-underline-offset: 4px; cursor: help; font-weight: 600;
        }

        .quiz-option {
            background: #FFFFFF; border: 2px solid #E2E8F0; padding: 14px;
            margin-bottom: 10px; border-radius: 8px; cursor: pointer; font-weight: 600;
        }
        .quiz-option.selected { border-color: var(--color-primary); background: #F0F9FF; }
        .quiz-option.correct { background: var(--color-correct) !important; color: white !important; }
        .quiz-option.incorrect { background: var(--color-incorrect) !important; color: white !important; }

        .gap-input {
            display: inline-block; min-width: 100px; padding: 0 10px;
            border-bottom: 2px solid var(--color-primary); background: #F1F5F9;
            text-align: center; cursor: pointer; font-weight: bold; margin: 0 5px;
        }
        .gap-input.correct { background: #DCFCE7 !important; color: #166534; }
        .gap-input.incorrect { background: #FEE2E2 !important; color: #991B1B; }

        .word-option {
            background: white; border: 2px solid var(--color-secondary);
            padding: 6px 15px; border-radius: 20px; cursor: pointer; font-weight: 600;
        }
        .word-option.selected { background: var(--color-secondary); color: white; }
        .word-option.used { opacity: 0.3; pointer-events: none; }

        /* --- POPUPS & UTILS --- */
        #dictionary-popup {
            position: absolute; background: white; padding: 15px; border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 9999; display: none;
            max-width: 250px; border: 1px solid #E2E8F0; font-size: 0.9em;
        }

        .check-btn { background: var(--color-secondary); color: white; width: 100%; padding: 12px; border-radius: 8px; font-weight: 700; margin-top: 15px; cursor: pointer; }
        .next-btn { background: var(--color-primary); color: white; padding: 10px 20px; border-radius: 8px; font-weight: 700; float: right; margin-top: 15px; cursor: pointer; }

        .confetti-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5000; display: none; }
        .confetti-piece { position: absolute; top: -50px; font-size: 1.5rem; animation: fall linear forwards; }
        @keyframes fall { 0% { transform: translateY(0) rotate(0); opacity: 1; } 100% { transform: translateY(100vh) rotate(360deg); opacity: 0; } }
    </style>
</head>
<body>

    <div id="confettiContainer" class="confetti-container"></div>
    <div id="dictionary-popup"></div>

    <header class="header">
        <div class="header-content">
            <div class="flex items-center gap-3">
                <span class="logo">üíª</span>
                <a href="/tax/" class="text-xl font-bold text-slate-900">English For Cool Dudes</a>
            </div>
            <div class="header-buttons">
                <a href="/dashboard/" class="header-button">My Dashboard</a>
            </div>
        </div>
    </header>

    <main class="lesson-container">
        <h1 class="text-3xl font-black mb-1">‚òÅÔ∏è VAT on Digital Services</h1>
        <p class="text-indigo-600 font-bold mb-6">Progress: Stage <span id="current-stage">1</span> of 5</p>

        <div class="content-card">
            <h2 class="collapsible-header" onclick="toggleCollapse('reading-content')">üìú Reading Text (Tap to Hide/Show)</h2>
            <div id="reading-content" class="reading-text">
                In the past, tax rules were designed for physical goods. Today, the concept of <span class="dictionary-word" data-definition="The location where a sale is considered to take place for tax purposes." data-type="noun">Place of Supply</span> is crucial. For <span class="dictionary-word" data-definition="Services delivered over the internet." data-type="noun">digital services</span>‚Äîoften referred to as <span class="dictionary-word" data-definition="Assets that do not have a physical nature." data-type="noun">intangibles</span>‚Äîthe rules differ. In <span class="dictionary-word" data-definition="Business to Consumer." data-type="adj">B2C</span> transactions, VAT is due where the customer is. This creates a <span class="dictionary-word" data-definition="The level or point at which something starts." data-type="noun">threshold</span> for registration. For <span class="dictionary-word" data-definition="Business to Business." data-type="adj">B2B</span>, the <span class="dictionary-word" data-definition="A rule where the buyer pays the VAT." data-type="noun">reverse charge mechanism</span> applies.
            </div>
        </div>

        <div id="stage-1" class="content-card stage-section">
            <h2 class="text-xl font-bold mb-4">1. Main Concept</h2>
            <p class="text-gray-600 mb-4">What is the main challenge discussed?</p>
            <div class="question-box" data-correct="Determining the correct 'Place of Supply'">
                <div class="quiz-option">Physical goods are too heavy.</div>
                <div class="quiz-option">Determining the correct 'Place of Supply'</div>
                <div class="quiz-option">B2B transactions are illegal.</div>
            </div>
            <button class="check-btn" onclick="checkRadio(1)">Check Answer</button>
            <button class="next-btn" onclick="nextStage(2)" style="display:none;">Next Stage &rarr;</button>
        </div>

        <div id="stage-2" class="content-card stage-section" style="display:none;">
            <h2 class="text-xl font-bold mb-4">2. Detail Check (Select TWO)</h2>
            <p class="text-indigo-600 font-bold mb-2">In B2C transactions...</p>
            <div class="question-box" data-type="checkbox" data-correct="A,C">
                <div class="quiz-option" data-val="A">VAT is due where the customer is.</div>
                <div class="quiz-option" data-val="B">VAT is always based on the seller's HQ.</div>
                <div class="quiz-option" data-val="C">Companies face multiple registrations.</div>
            </div>
            <button class="check-btn" onclick="checkCheckbox(2)">Check Answers</button>
            <button class="next-btn" onclick="nextStage(3)" style="display:none;">Next Stage &rarr;</button>
        </div>

        <div id="stage-3" class="content-card stage-section" style="display:none;">
            <h2 class="text-xl font-bold mb-4">3. Terminology Practice</h2>
            <div class="flex flex-wrap gap-2 mb-6 p-4 bg-indigo-50 rounded-lg">
                <div class="word-option" data-word="intangibles">intangibles</div>
                <div class="word-option" data-word="threshold">threshold</div>
                <div class="word-option" data-word="mechanism">mechanism</div>
            </div>
            <div class="space-y-6 text-lg">
                <p>1. E-books are <span class="gap-input" data-answer="intangibles">____</span>.</p>
                <p>2. You must register once you hit the <span class="gap-input" data-answer="threshold">____</span>.</p>
                <p>3. Use the reverse charge <span class="gap-input" data-answer="mechanism">____</span>.</p>
            </div>
            <button class="check-btn" onclick="checkGapFill(3)">Check Gaps</button>
            <button class="next-btn" onclick="nextStage(4)" style="display:none;">Next Stage &rarr;</button>
        </div>

        <div id="stage-4" class="content-card stage-section" style="display:none;">
            <h2 class="text-2xl font-black text-indigo-700">üéâ Lesson Complete!</h2>
            <p class="mb-4">You've mastered Digital VAT concepts.</p>
            <div id="final-words-list" class="grid grid-cols-2 gap-2"></div>
            <button class="check-btn mt-6" onclick="location.reload()">Restart Lesson</button>
        </div>

    </main>

    <script>
        let selectedWordBtn = null;
        let incorrectWordsForIndex = new Set();

        // 1. Dictionary Popup Logic
        document.querySelectorAll('.dictionary-word').forEach(word => {
            word.onclick = (e) => {
                const popup = document.getElementById('dictionary-popup');
                popup.innerHTML = `<strong>${word.innerText}</strong> (${word.dataset.type})<br>${word.dataset.definition}`;
                popup.style.display = 'block';
                popup.style.left = e.pageX + 'px';
                popup.style.top = (e.pageY + 10) + 'px';
                e.stopPropagation();
            };
        });

        document.onclick = () => document.getElementById('dictionary-popup').style.display = 'none';

        function toggleCollapse(id) {
            const el = document.getElementById(id);
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        // 2. Quiz Logic
        document.querySelectorAll('.quiz-option').forEach(opt => {
            opt.onclick = function() {
                const box = this.parentElement;
                if (box.dataset.answered === 'true') return;
                
                if (box.parentElement.dataset.type === 'checkbox') {
                    this.classList.toggle('selected');
                } else {
                    box.querySelectorAll('.quiz-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                }
            };
        });

        function checkRadio(stage) {
            const box = document.querySelector(`#stage-${stage} .question-box`);
            const sel = box.querySelector('.quiz-option.selected');
            if (!sel) return;
            
            if (sel.innerText === box.dataset.correct) {
                sel.classList.add('correct');
                box.dataset.answered = 'true';
                document.querySelector(`#stage-${stage} .next-btn`).style.display = 'block';
                triggerConfetti();
            } else {
                sel.classList.add('incorrect');
            }
        }

        function checkCheckbox(stage) {
            const box = document.querySelector(`#stage-${stage} .question-box`);
            const correct = box.dataset.correct.split(',');
            const options = box.querySelectorAll('.quiz-option');
            
            options.forEach(opt => {
                const val = opt.dataset.val;
                if (correct.includes(val)) opt.classList.add('correct');
                else if (opt.classList.contains('selected')) opt.classList.add('incorrect');
            });
            document.querySelector(`#stage-${stage} .next-btn`).style.display = 'block';
        }

        // 3. Gap Fill Logic
        document.querySelectorAll('.word-option').forEach(opt => {
            opt.onclick = function() {
                document.querySelectorAll('.word-option').forEach(o => o.classList.remove('selected'));
                this.classList.add('selected');
                selectedWordBtn = this;
            };
        });

        document.querySelectorAll('.gap-input').forEach(gap => {
            gap.onclick = function() {
                if (!selectedWordBtn) return;
                if (this.dataset.usedWord) {
                    document.querySelector(`[data-word="${this.dataset.usedWord}"]`).classList.remove('used');
                }
                this.innerText = selectedWordBtn.innerText;
                this.dataset.usedWord = selectedWordBtn.dataset.word;
                selectedWordBtn.classList.add('used');
                selectedWordBtn = null;
                document.querySelectorAll('.word-option').forEach(o => o.classList.remove('selected'));
            };
        });

        function checkGapFill(stage) {
            const gaps = document.querySelectorAll(`#stage-${stage} .gap-input`);
            let allGood = true;
            gaps.forEach(gap => {
                if (gap.innerText === gap.dataset.answer) {
                    gap.classList.add('correct');
                } else {
                    gap.classList.add('incorrect');
                    allGood = false;
                    // FIX: Tracking incorrect word for the extra practice pop-up
                    incorrectWordsForIndex.add(gap.dataset.answer);
                }
            });
            if (allGood) {
                document.querySelector(`#stage-${stage} .next-btn`).style.display = 'block';
                triggerConfetti();
            }
        }

        // 4. Navigation
        function nextStage(num) {
            document.querySelectorAll('.stage-section').forEach(s => s.style.display = 'none');
            document.getElementById(`stage-${num}`).style.display = 'block';
            document.getElementById('current-stage').innerText = num;
            if (num === 4) populateSummary();
        }

        function populateSummary() {
            const list = document.getElementById('final-words-list');
            document.querySelectorAll('.dictionary-word').forEach(w => {
                const item = document.createElement('div');
                item.className = "p-3 bg-white border rounded shadow-sm text-sm font-bold";
                item.innerText = w.innerText;
                list.appendChild(item);
            });
            console.log("Words to send to Index extra practice:", Array.from(incorrectWordsForIndex));
        }

        function triggerConfetti() {
            const container = document.getElementById('confettiContainer');
            container.style.display = 'block';
            for (let i = 0; i < 20; i++) {
                const p = document.createElement('div');
                p.className = 'confetti-piece';
                p.innerText = '‚ú®';
                p.style.left = Math.random() * 100 + 'vw';
                p.style.animationDuration = (Math.random() * 2 + 1) + 's';
                container.appendChild(p);
                setTimeout(() => p.remove(), 2000);
            }
        }
    </script>
</body>
</html>
