<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>VAT on Digital Services - English for Cool Dudes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* --- COOL DUDES BRANDING & MOBILE-FIRST STYLES --- */
        :root {
            --color-primary: #0EA5E9; /* Sky Blue - Tech/Digital */
            --color-secondary: #8B5CF6; /* Violet - Services */
            --color-accent: #F472B6; /* Pink - Highlight */
            --color-background: #F0F9FF; /* Very Light Blue */
            --color-text: #0F172A; /* Dark Slate */
            --color-correct: #10B981;
            --color-incorrect: #EF4444;
            --color-new-feature: #6366F1; /* Indigo */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: var(--color-background);
            color: var(--color-text);
            line-height: 1.6;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden; /* Prevent scrollbars from confetti */
        }

        /* === REUSABLE HEADER STYLES === */
        .header {
            background: #FFFFFF;
            border-bottom: 1px solid #E2E8F0;
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .site-title {
            font-size: 20px;
            font-weight: 600;
            color: #0F172A;
            letter-spacing: -0.02em;
            text-decoration: none;
        }

        .header-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-button {
            text-decoration: none;
            padding: 7px 14px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
            cursor: pointer;
            border: 1px solid #E2E8F0;
            background: transparent;
        }

        .header-button.login {
            background: #F1F5F9;
            color: #475569;
        }

        .header-button.login:hover {
            background: #FFFFFF;
            color: #0F172A;
            border-color: #94A3B8;
        }

        .header-button.signup {
            background: var(--color-primary);
            color: white;
            border: 1px solid transparent;
        }

        .header-button.signup:hover {
            background: #0284C7;
            box-shadow: 0 2px 5px rgba(14, 165, 233, 0.4);
        }

        .header-button.dashboard {
            background: #EEF2FF;
            color: #4F46E5;
            border-color: #818CF8;
        }

        .header-button.dashboard:hover {
            background: #E0E7FF;
            border-color: #6366F1;
        }

        .header-button.logout {
            background: #FEF2F2;
            color: #DC2626;
            border-color: #FECACA;
        }

        .header-button.logout:hover {
            background: #FEE2E2;
            color: #B91C1C;
        }

        .user-greeting {
            font-size: 14px;
            color: #475569;
            font-weight: 600;
            margin-right: 5px;
            white-space: nowrap;
        }
        
        /* Lesson Layout */
        .lesson-container {
            max-width: 800px;
            margin: 20px auto 40px;
            padding: 0 15px;
            min-height: 80vh; /* Ensure footer pushes down */
        }
        
        /* Content Blocks */
        .content-card {
            background-color: #FFFFFF;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #F1F5F9;
            position: relative;
            z-index: 10;
            pointer-events: auto;
        }
        
        /* Collapsible Header Style */
        .collapsible-header {
            color: var(--color-secondary);
            font-size: 1.6em;
            font-weight: 600;
            margin-bottom: 15px;
            border-bottom: 2px dashed var(--color-primary);
            padding-bottom: 5px;
            cursor: pointer; 
            user-select: none;
            transition: color 0.2s;
        }
        .collapsible-header:hover {
            color: var(--color-primary);
        }

        /* Reading Text Style */
        .reading-text {
            background: #F8FAFC; 
            border-left: 4px solid var(--color-primary);
            padding: 20px;
            border-radius: 0 8px 8px 0;
            font-size: 1.05em;
            white-space: pre-wrap;
            color: #334155;
        }
        
        /* Dictionary Word Style */
        .dictionary-word {
            text-decoration: underline dashed var(--color-secondary) 2px;
            text-underline-offset: 4px;
            cursor: help;
            font-weight: 600; 
            color: var(--color-text);
            transition: color 0.2s;
        }
        .dictionary-word:hover {
            color: var(--color-secondary);
            background-color: #F3E8FF;
        }

        /* Quiz Options */
        .quiz-option {
            background: #FFFFFF;
            border: 2px solid #E2E8F0;
            padding: 16px; 
            margin-bottom: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            display: block;
            user-select: none;
            color: #475569;
        }
        .quiz-option:hover {
            background: #F0F9FF;
            border-color: var(--color-primary);
            color: var(--color-primary);
        }
        .quiz-option.selected {
            background: #E0F2FE;
            color: #0369A1;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px var(--color-primary);
        }
        .quiz-option.correct { 
            background: var(--color-correct) !important;
            color: white !important;
            border-color: var(--color-correct) !important;
            box-shadow: none;
        }
        .quiz-option.incorrect { 
            background: var(--color-incorrect) !important;
            color: white !important;
            border-color: var(--color-incorrect) !important;
            box-shadow: none;
        }
        .quiz-option.disabled {
            pointer-events: none;
            opacity: 0.8;
        }
        
        /* Gap Fill Styles */
        .word-bank {
            background: #EEF2FF;
            border: 2px solid var(--color-secondary);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }
        .word-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        .word-option {
            background-color: #FFFFFF; 
            color: var(--color-secondary);
            border: 2px solid var(--color-secondary);
            padding: 8px 16px; 
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            font-size: 0.95em;
        }
        .word-option:hover {
            background-color: var(--color-secondary);
            color: white;
            transform: translateY(-2px);
        }
        .word-option.used {
            opacity: 0.4;
            pointer-events: none;
            background-color: #CBD5E1;
            border-color: #CBD5E1;
            color: #64748B;
            transform: none;
        }
        .word-option.selected {
            background-color: var(--color-secondary);
            color: white;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .gap-input {
            display: inline-block;
            text-align: center;
            padding: 0 10px;
            min-width: 120px; 
            height: 36px; 
            background-color: #F1F5F9;
            border-bottom: 2px solid var(--color-primary);
            border-radius: 4px 4px 0 0;
            color: var(--color-text);
            font-weight: 600;
            cursor: pointer;
            line-height: 34px; 
            vertical-align: bottom;
            margin: 0 4px;
            transition: all 0.2s ease;
        }
        .gap-input:hover {
            background-color: #E0F2FE;
        }
        .gap-input.filled {
             background-color: #E0E7FF;
             color: var(--color-secondary);
             border-bottom-color: var(--color-secondary);
        }
        .gap-input.correct {
             background-color: #DCFCE7 !important;
             color: #166534 !important;
             border-bottom-color: #166534 !important;
             pointer-events: none;
        }
        .gap-input.incorrect {
             background-color: #FEE2E2 !important;
             color: #991B1B !important;
             border-bottom-color: #991B1B !important;
        }

        /* Buttons */
        .check-btn {
            background-color: var(--color-secondary);
            color: white;
            padding: 14px 28px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 20px;
            display: block;
            width: 100%;
            border: none;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .check-btn:hover {
            background-color: #7C3AED;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }
        .check-btn:active {
            transform: translateY(0);
        }

        .next-btn {
            background-color: var(--color-primary);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            float: right;
            margin-top: 15px;
            border: none;
        }
        .next-btn:hover {
            background-color: #0284C7;
        }
        
        /* Save Section */
        #save-words-section {
            background: linear-gradient(135deg, #EEF2FF 0%, #E0E7FF 100%);
            border: 1px solid #C7D2FE;
            padding: 25px;
            border-radius: 12px;
            margin-top: 30px;
            text-align: center;
        }

        #save-words-btn {
            background-color: #4F46E5;
            color: white;
            padding: 14px 28px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2);
            font-size: 1.1em;
        }
        #save-words-btn:hover:not(:disabled) {
            background-color: #4338CA;
            transform: scale(1.02);
        }
        #save-words-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #login-prompt {
            background: #FEF9C3;
            border: 1px solid #FDE047;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        /* Popups */
        #feedback-popup {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 16px 24px;
            background: var(--color-text);
            color: white;
            border-radius: 50px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 2000;
            display: none;
            font-size: 1.1em;
            font-weight: 600;
            text-align: center;
            border: 2px solid white;
        }

      #dictionary-popup {
    position: fixed; 
    max-width: 280px;
    padding: 20px;
    background: #FFFFFF; 
    color: #334155;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    z-index: 10000; /* Higher than confetti */
    display: none;
    font-size: 1em;
    line-height: 1.5;
    border: 1px solid #E2E8F0;
    text-align: left;
    pointer-events: auto; /* Ensure it's clickable */
}
        
        /* Final Words List Styling (Improved Design) */
        #learned-words-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
            list-style: none;
            padding: 0;
            margin-left: 0;
        }
        #learned-words-list li {
            background: #FFFFFF;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #E2E8F0;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        #learned-words-list li:hover {
            background-color: #EEF2FF;
            border-color: #8B5CF6;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .word-term {
            display: block;
            font-weight: 600;
            color: #0F172A;
            margin-bottom: 4px;
        }
        .word-type {
            display: block;
            font-size: 0.85em;
            color: #64748B;
            font-style: italic;
        }

        /* --- ADDED FOOTER STYLES --- */
        .footer {
            background: #FFFFFF;
            border-top: 1px solid #E5E9F2;
            padding: 32px 20px;
            margin-top: 60px;
            text-align: center;
        }

        .footer-text {
            font-size: 14px;
            color: #718096;
        }

        /* --- CONFETTI ANIMATION STYLES --- */
.confetti-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none; /* This prevents blocking clicks */
    z-index: 9999; /* High but not blocking */
    overflow: hidden;
    display: none;
    visibility: hidden; /* Extra safety */
}
.confetti-container.active {
    display: block;
    visibility: visible;
}
        
        .confetti-piece {
            position: absolute;
            top: -50px;
            font-size: 2rem;
            animation: fall linear forwards;
        }
        @keyframes fall {
            0% { transform: translateY(-50px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(110vh) rotate(360deg); opacity: 0; }
        }

        @media (max-width: 768px) {
            .user-greeting { display: none; }
            .header-buttons { gap: 5px; }
        }
    </style>
</head>
<body>
    <div id="confettiContainer" class="confetti-container"></div>

    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <span class="logo">üíª</span>
                <a href="/tax/" class="site-title">English For Cool Dudes</a>
            </div>
            
            <div id="logged-out-buttons" class="header-buttons" style="display: none;">
                <a href="/login/" class="header-button login">Login</a>
                <a href="/signup/" class="header-button signup">Sign Up</a>
            </div>

            <div id="logged-in-buttons" class="header-buttons" style="display: none;">
                <span class="user-greeting" id="user-greeting">Hey Cool Dude! üëã</span>
                <a href="/dashboard/" class="header-button dashboard">My Dashboard</a>
                <button id="logout-btn" class="header-button logout">Sign Out</button>
            </div>
        </div>
    </header>

    <main class="lesson-container">
        <h1 class="text-3xl font-black text-gray-900 mb-2">‚òÅÔ∏è VAT on Digital Services</h1>
        <h2 class="text-lg text-indigo-600 font-bold mb-6">The "Netflix Tax" and Cross-Border Rules</h2>
        <p class="text-gray-500 mb-8 text-sm uppercase tracking-wide font-bold">Level: Advanced | Topic: International Tax / Indirect Tax</p>
        
        <div class="flex justify-between items-center text-sm font-semibold mb-4 text-gray-600 bg-white p-3 rounded-lg border border-gray-100">
            <span>Progress: Stage <span id="current-stage">1</span> of 5</span>
            <span id="lesson-progress-text"></span>
        </div>
        
        <div class="content-card" data-section-id="0" data-completed="false">
            <h2 class="collapsible-header" onclick="toggleCollapse('reading-content')">üìú Reading Text (Click to Read/Hide)</h2>
            <div class="reading-text" id="reading-content" style="display: block;"> 
                <h4 class="text-xl font-bold text-gray-800 mb-4">The Digital Tax Frontier</h4>

                In the past, tax rules were designed for physical goods crossing borders. However, the modern digital economy has complicated this framework. Today, the concept of <span class="dictionary-word" data-definition="The location where a sale is considered to take place for tax purposes." data-type="noun">Place of Supply</span> is crucial in determining which <span class="dictionary-word" data-definition="The official power to make legal decisions; a specific territory or country." data-type="noun">jurisdiction</span> has the right to tax a transaction.

                For <span class="dictionary-word" data-definition="Services delivered over the internet (e.g., streaming, software, e-books)." data-type="noun">digital services</span>‚Äîoften referred to as <span class="dictionary-word" data-definition="Assets that do not have a physical nature (like software or IP)." data-type="noun">intangibles</span>‚Äîthe rules differ depending on the customer. In <span class="dictionary-word" data-definition="Business to Consumer: Transactions between a business and an individual." data-type="adjective">B2C</span> transactions, the general rule is that VAT is due where the *customer* is located, not the seller. This creates a heavy <span class="dictionary-word" data-definition="The action of complying with a command or law." data-type="noun">compliance</span> burden, forcing companies to register for VAT in multiple countries once they exceed a certain sales <span class="dictionary-word" data-definition="The level or point at which something starts to happen (e.g., registration limit)." data-type="noun">threshold</span>.

                Conversely, for <span class="dictionary-word" data-definition="Business to Business: Transactions between two businesses." data-type="adjective">B2B</span> transactions, the <span class="dictionary-word" data-definition="A rule where the buyer, rather than the seller, pays the VAT to the government." data-type="noun">reverse charge mechanism</span> often applies. This shifts the tax liability from the supplier to the business customer, who must account for the VAT in their own return.

                Failure to collect and pay these taxes can lead to severe penalties. Companies must ensure they calculate the correct rate and make the timely <span class="dictionary-word" data-definition="A sum of money sent in payment for goods or services." data-type="noun">remittance</span> of tax collected to the foreign authority. While some small businesses may be <span class="dictionary-word" data-definition="Free from an obligation or liability imposed on others." data-type="adjective">exempt</span> under specific schemes, most digital giants must navigate this complex web of global levies.
            </div>
        </div>

        <div id="stage-1" class="content-card" data-section-id="1">
            <h2 class="mb-0 collapsible-header" onclick="this.removeAttribute('onclick');">1 / 5: Main Concept</h2>
            <p class="text-gray-600 mb-6 font-medium">What is the main challenge regarding VAT and digital services discussed in the text?</p>

            <div class="question-box" data-correct-value="Determining the correct 'Place of Supply' and jurisdiction for tax." data-answered="false">
                <div class="quiz-options">
                    <div class="quiz-option" data-value="Physical goods are too heavy to ship across borders.">Physical goods are too heavy to ship across borders.</div>
                    
                    <div class="quiz-option" data-value="B2B transactions are illegal in the digital economy.">B2B transactions are illegal in the digital economy.</div>
<div class="quiz-option" data-value="Determining the correct 'Place of Supply' and jurisdiction for tax.">Determining the correct 'Place of Supply' and jurisdiction for tax.</div>
                </div>
            </div>
            <button class="check-btn" onclick="checkRadioQuestion(document.querySelector('#stage-1 .question-box'))">Check Answer</button>
            <button class="next-btn" onclick="nextStage(2)" style="display:none;">Next Stage &rarr;</button>
        </div>

        <div id="stage-2" class="content-card" data-section-id="2" style="display:none;">
            <h2 class="mb-0 collapsible-header" onclick="this.removeAttribute('onclick');">2 / 5: Detail Check</h2>
            <p class="text-gray-600 mb-4 font-medium">Answer the following questions about the text. Select ALL correct options for each.</p>

            <p class="font-bold text-indigo-600 mt-4 mb-2">Question A: In B2C transactions...</p>
            <div class="question-box" data-correct-values="A,C" data-type="checkbox" data-answered="false">
                <div class="quiz-options">
                    <div class="quiz-option" data-value="A">VAT is generally due where the customer is located.</div>
                    <div class="quiz-option" data-value="B">VAT is always calculated based on the seller's HQ.</div>
                    <div class="quiz-option" data-value="C">Companies face a compliance burden (multiple registrations).</div>
                </div>
            </div>

            <p class="font-bold text-indigo-600 mt-6 mb-2">Question B: What is true about the Reverse Charge Mechanism?</p>
            <div class="question-box" data-correct-values="D,E" data-type="checkbox" data-answered="false">
                <div class="quiz-options">
                    <div class="quiz-option" data-value="D">It applies primarily to B2B transactions.</div>
                    <div class="quiz-option" data-value="E">It shifts the tax liability to the business customer.</div>
                    <div class="quiz-option" data-value="F">It means the government pays the company.</div>
                </div>
            </div>

            <button class="check-btn" onclick="checkCheckboxQuestion(document.querySelectorAll('#stage-2 .question-box'))">Check Answers</button>
            <button class="next-btn" onclick="nextStage(3)" style="display:none;">Next Stage &rarr;</button>
        </div>

        <div id="stage-3" class="content-card" data-section-id="3" style="display:none;">
            <h2 class="mb-0 collapsible-header" onclick="this.removeAttribute('onclick');">3 / 5: Key Nouns</h2>
            <h4 class="text-lg font-bold mt-4 text-indigo-600">üìù Practice the Terminology</h4>
            
            <div class="word-bank">
                <p class="font-bold mb-3 text-xs text-gray-400 uppercase tracking-wider">Word Bank</p>
                <div class="word-options" id="noun-bank">
                    <div class="word-option" data-word="jurisdiction">jurisdiction</div>
                    <div class="word-option" data-word="threshold">threshold</div>
                    
                    <div class="word-option" data-word="remittance">remittance</div>
                    <div class="word-option" data-word="intangibles">intangibles</div>
                    <div class="word-option" data-word="mechanism">mechanism</div>
                </div>
            </div>

            <div class="gap-fill-text text-lg leading-loose space-y-4" id="gap-fill-nouns" data-answered="false">
                <p>1. Software and e-books are examples of <span class="gap-input" data-answer="intangibles" data-original-text="____" data-filled-word="">____</span>.</p>
                <p>2. Once sales exceed the registration <span class="gap-input" data-answer="threshold" data-original-text="____" data-filled-word="">____</span>, you must register for VAT.</p>
                <p>3. The reverse charge <span class="gap-input" data-answer="mechanism" data-original-text="____" data-filled-word="">____</span> simplifies B2B tax collection.</p>
                <p>4. Keeping up with tax laws in every <span class="gap-input" data-answer="jurisdiction" data-original-text="____" data-filled-word="">____</span> is difficult.</p>
                <p>5. Timely <span class="gap-input" data-answer="remittance" data-original-text="____" data-filled-word="">____</span> of the collected tax is mandatory.</p>
            </div>

            <button type="button" class="check-btn" onclick="checkGapFillStage(3)">Check Nouns</button>
            <button class="next-btn" onclick="nextStage(4)" style="display:none;">Next Stage &rarr;</button>
        </div>

        <div id="stage-4" class="content-card" data-section-id="4" style="display:none;">
            <h2 class="mb-0 collapsible-header" onclick="this.removeAttribute('onclick');">4 / 5: Concepts & Adjectives</h2>
            <h4 class="text-lg font-bold mt-4 text-indigo-600">‚ö° Practice the Concepts</h4>
            
            <div class="word-bank">
                <p class="font-bold mb-3 text-xs text-gray-400 uppercase tracking-wider">Word Bank</p>
                <div class="word-options" id="concept-bank">
                    <div class="word-option" data-word="exempt">exempt</div>
                    <div class="word-option" data-word="B2B">B2B</div>
                    <div class="word-option" data-word="B2C">B2C</div>
                    <div class="word-option" data-word="digital">digital</div>
                    <div class="word-option" data-word="liable">liable</div>
                </div>
            </div>

            <div class="gap-fill-text text-lg leading-loose space-y-4" id="gap-fill-concepts" data-answered="false">
                <p>1. Streaming services are considered <span class="gap-input" data-answer="digital" data-original-text="____" data-filled-word="">____</span> services.</p>
                <p>2. In <span class="gap-input" data-answer="B2C" data-original-text="____" data-filled-word="">____</span> sales, the seller collects the tax from the consumer.</p>
                <p>3. Some small businesses may be <span class="gap-input" data-answer="exempt" data-original-text="____" data-filled-word="">____</span> from registration.</p>
                <p>4. The customer is <span class="gap-input" data-answer="liable" data-original-text="____" data-filled-word="">____</span> for the tax in a reverse charge scenario.</p>
                <p>5. <span class="gap-input" data-answer="B2B" data-original-text="____" data-filled-word="">____</span> transactions often involve the reverse charge.</p>
            </div>

            <button type="button" class="check-btn" onclick="checkGapFillStage(4)">Check Concepts</button>
            <button class="next-btn" onclick="nextStage(5)" style="display:none;">Next Stage &rarr;</button>
        </div>

        <div id="stage-5" class="content-card" data-section-id="5" style="display:none;">
            <h2 class="mb-0 collapsible-header" onclick="this.removeAttribute('onclick');">5 / 5: Inference</h2>
            <p class="text-gray-600 mb-4 font-medium">Why does the text suggest that the "Place of Supply" rules create a burden for companies?</p>

            <div class="question-box" data-correct-value="Because companies may have to register and pay tax in many different countries." data-answered="false">
                <div class="quiz-options">
                    <div class="quiz-option" data-value="Because digital services are tax-free.">Because digital services are tax-free.</div>
                    <div class="quiz-option" data-value="Because companies may have to register and pay tax in many different countries.">Because companies may have to register and pay tax in many different countries.</div>
                    <div class="quiz-option" data-value="Because only physical goods are taxed now.">Because only physical goods are taxed now.</div>
                </div>
            </div>
            <button class="check-btn" onclick="checkRadioQuestion(document.querySelector('#stage-5 .question-box'))">Check Answer</button>
            <button class="next-btn" onclick="showFinalSummary()" style="display:none;">View Summary &rarr;</button>
        </div>
        
        <div id="stage-6" class="content-card" style="display:none; border-left: 4px solid var(--color-new-feature);">
            <h2 class="text-2xl font-black text-indigo-700 mb-2">üéâ Lesson Complete!</h2>
            <p class="text-lg mb-6 text-gray-600">You've mastered the basics of Digital Services VAT.</p>
            
            <div class="bg-indigo-50 p-5 rounded-lg border border-indigo-100 mb-6">
                <h3 class="font-bold text-lg text-indigo-900 mb-3">Vocabulary Review (Tap for definition):</h3>
                <ul id="learned-words-list">
                    </ul>
            </div>
            
            <div id="save-words-section">
                <h3 class="font-bold text-gray-800 mb-2">Keep these words!</h3>
                <p class="text-sm text-gray-500 mb-4">Save them to your dashboard to practice later.</p>
                
                <div id="save-feature-loggedin" style="display: none;">
                    <button id="save-words-btn" onclick="saveWordsToDashboard()">üíæ Save 14 Words to Dashboard</button>
                    <p id="save-status" class="text-sm mt-3 font-semibold"></p>
                </div>
                
                <div id="login-prompt" style="display: none;">
                    <p class="text-yellow-800 font-bold mb-2">üîí Login to save your progress!</p>
                    <a href="/login/" class="inline-block bg-yellow-500 text-white font-bold py-2 px-4 rounded hover:bg-yellow-600 transition">Log In / Sign Up</a>
                </div>
            </div>
        </div>

    </main>
<footer class="footer">
    <p class="footer-text">¬© 2025 English For Cool Dudes - üòé</p>
    <div style="margin-top: 10px;">
        <a href="/impressum/" style="color: #667EEA; margin-right: 15px; text-decoration: none;">Impressum</a>
        <a href="/datenschutz/" style="color: #667EEA; text-decoration: none;">Datenschutzerkl√§rung</a>
    </div>
</footer>
    <div id="dictionary-popup"></div>
    <div id="feedback-popup"></div>

<script>
    // --- Supabase & Global Logic ---
    const SUPABASE_URL = 'https://knwgmrgwbpchqyqxbxea.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtud2dtcmd3YnBjaHF5cXhieGVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MDkyODgsImV4cCI6MjA3ODA4NTI4OH0.qnp2ScwSE77_idmPhpLE98sr46WvLpKtg6refFfC7s8';

    // Use 'sb' to avoid conflicts
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let currentUser = null;

    // Lesson Data
    const lessonTitle = "VAT on Digital Services: The Netflix Tax";
    const lessonLink = "/VATdigital/";
    const lessonLevel = "ADVANCED";

    // Vocabulary List
    const learnedWords = [
        { word: "VAT", definition: "A consumption tax placed on a product whenever value is added at each stage of the supply chain.", type: "noun" },
        { word: "digital services", definition: "Services delivered over the internet or an electronic network (e.g., streaming, software).", type: "noun" },
        { word: "Place of Supply", definition: "The location where a sale is considered to take place for tax purposes.", type: "noun" },
        { word: "jurisdiction", definition: "The official power to make legal decisions and judgments; a specific territory.", type: "noun" },
        { word: "reverse charge mechanism", definition: "A rule where the buyer, rather than the seller, is responsible for paying the VAT.", type: "noun" },
        { word: "B2B", definition: "Business to Business: Commercial transactions between two businesses.", type: "adjective" },
        { word: "B2C", definition: "Business to Consumer: Commercial transactions between a business and an individual.", type: "adjective" },
        { word: "remittance", definition: "A sum of money sent in payment for goods or services or as a gift.", type: "noun" },
        { word: "compliance", definition: "The action or fact of complying with a wish or command (e.g., tax laws).", type: "noun" },
        { word: "threshold", definition: "The level or point at which something starts to happen (e.g., registration threshold).", type: "noun" },
        { word: "intangibles", definition: "Assets that do not have a physical nature (like software or IP).", type: "noun" },
        { word: "exempt", definition: "Free from an obligation or liability imposed on others.", type: "adjective" },
        { word: "liable", definition: "Responsible by law; legally answerable.", type: "adjective" },
        { word: "mechanism", definition: "A system of parts working together in a machine; a piece of machinery.", type: "noun" }
    ];

    // --- Helper Functions ---
    function getWordDefinition(word) {
        return learnedWords.find(w => w.word.toLowerCase() === word.toLowerCase());
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // --- Feedback Popup ---
    const feedbackPopup = document.getElementById('feedback-popup');
    function showFeedback(message, type = 'correct') {
        feedbackPopup.textContent = message;
        feedbackPopup.style.backgroundColor = type === 'correct' ? 'var(--color-correct)' : 'var(--color-incorrect)';
        feedbackPopup.style.display = 'block';
        setTimeout(() => { feedbackPopup.style.display = 'none'; }, 2000);
    }

    // --- Dictionary Popup (FIXED) ---
    const dictionaryPopup = document.getElementById('dictionary-popup');
    
    function showDictionaryPopup(targetElement, definition) {
        if (!definition) return;
        dictionaryPopup.innerHTML = definition;
        dictionaryPopup.style.display = 'block';
        
        // Get position relative to viewport
        const rect = targetElement.getBoundingClientRect();
        
        // Calculate Top: Just use rect.bottom + margin. DO NOT add scrollY for fixed elements.
        let top = rect.bottom + 15; 
        
        // Check if it runs off the bottom of the screen
        if (top + dictionaryPopup.offsetHeight > window.innerHeight) {
            // Flip to top if not enough space below
            top = rect.top - dictionaryPopup.offsetHeight - 10;
        }
        
        // Calculate Left
        let left = rect.left + (rect.width / 2) - (dictionaryPopup.offsetWidth / 2);
        
        // Keep it inside the screen horizontally
        if (left < 10) left = 10;
        if (left + dictionaryPopup.offsetWidth > window.innerWidth - 10) {
            left = window.innerWidth - dictionaryPopup.offsetWidth - 10;
        }
        
        dictionaryPopup.style.top = `${top}px`;
        dictionaryPopup.style.left = `${left}px`;
    }

    // Close dictionary popup properly
    document.addEventListener('click', (e) => {
        // Only close if clicking OUTSIDE popup and NOT on a trigger word
        const isTrigger = e.target.classList.contains('dictionary-word') || e.target.closest('#learned-words-list li');
        const isPopup = dictionaryPopup.contains(e.target);
        
        if (dictionaryPopup.style.display === 'block' && !isPopup && !isTrigger) {
            dictionaryPopup.style.display = 'none';
        }
    }, true); 

    // --- Auth & Initialization ---
    async function initializeAuth() {
        const { data: { user } } = await sb.auth.getUser();
        if (user) {
            currentUser = user;
            document.getElementById('logged-out-buttons').style.display = 'none';
            document.getElementById('logged-in-buttons').style.display = 'flex';
            document.getElementById('save-feature-loggedin').style.display = 'block';
            
            const userName = user.user_metadata.full_name ? user.user_metadata.full_name.split(' ')[0] : 'Cool Dude';
            document.getElementById('user-greeting').textContent = `Hey ${userName}! üëã`;
        } else {
            document.getElementById('logged-out-buttons').style.display = 'flex';
            document.getElementById('login-prompt').style.display = 'block';
        }
    }

    // --- Mistake Tracking ---
    async function saveMistake(word) {
        if (!currentUser) return;
        try {
            const wordObj = getWordDefinition(word);
            // Use 'sb.from'
            const { error } = await sb.from('user_mistakes').upsert({
                user_id: currentUser.id,
                word: word,
                definition: wordObj ? wordObj.definition : '',
                word_type: wordObj ? wordObj.type : 'word',
                lesson: lessonTitle,
                lesson_link: lessonLink,
                last_made_at: new Date().toISOString()
            }, { onConflict: 'user_id,word' });
            
            if (error) console.error('Error saving mistake:', error);
        } catch (err) { console.error(err); }
    }

    // --- Save Words Logic ---
    async function saveWordsToDashboard() {
        const btn = document.getElementById('save-words-btn');
        btn.disabled = true;
        btn.textContent = "Saving...";
        
        if (!currentUser) return;

        try {
            const { error } = await sb.from('lessons').upsert([{
                user_id: currentUser.id,
                lesson_title: lessonTitle,
                lesson_link: lessonLink,
                lesson_level: lessonLevel,
                vocabulary: learnedWords,
                completed_at: new Date().toISOString()
            }], { onConflict: 'user_id,lesson_title' });

            if (error) throw error;
            
            btn.textContent = "‚úÖ Saved!";
            btn.style.backgroundColor = "var(--color-correct)";
            showFeedback("Words saved to dashboard!", "correct");
            setTimeout(() => window.location.href = '/dashboard/', 1000);
        } catch (err) {
            btn.disabled = false;
            btn.textContent = "‚ùå Error. Try Again.";
            btn.style.backgroundColor = "var(--color-incorrect)";
            console.error(err);
        }
    }

    // --- Quiz Logic: Radio ---
    function checkRadioQuestion(box) {
        if (box.dataset.answered === 'true') return;
        const selected = box.querySelector('.quiz-option.selected');
        if (!selected) { showFeedback('Please select an answer.', 'incorrect'); return; }

        if (selected.dataset.value === box.dataset.correctValue) {
            selected.classList.add('correct');
            showFeedback('Correct!', 'correct');
            box.dataset.answered = 'true';
            box.closest('.content-card').querySelector('.check-btn').style.display = 'none';
            box.closest('.content-card').querySelector('.next-btn').style.display = 'block';
        } else {
            selected.classList.add('incorrect');
            showFeedback('Incorrect. Try again.', 'incorrect');
            setTimeout(() => selected.classList.remove('incorrect', 'selected'), 1000);
        }
    }

    // --- Quiz Logic: Checkbox ---
    function checkCheckboxQuestion(boxes) {
        let allCorrect = true;
        let anySelected = false;

        boxes.forEach(box => {
            const correctVals = box.dataset.correctValues.split(',');
            const selected = Array.from(box.querySelectorAll('.quiz-option.selected'));
            const selectedVals = selected.map(opt => opt.dataset.value);
            
            if (selected.length > 0) anySelected = true;

            const sortedCorrect = correctVals.sort();
            const sortedSelected = selectedVals.sort();
            
            const isMatch = JSON.stringify(sortedCorrect) === JSON.stringify(sortedSelected);
            
            if (!isMatch) allCorrect = false;
            
            selected.forEach(opt => {
                if (correctVals.includes(opt.dataset.value)) {
                    opt.classList.add('correct');
                } else {
                    opt.classList.add('incorrect');
                }
            });
        });

        if (!anySelected) {
            showFeedback('Please select at least one answer.', 'incorrect');
            return;
        }

        const container = boxes[0].closest('.content-card');
        if (allCorrect) {
            showFeedback('All correct!', 'correct');
            boxes.forEach(b => {
                b.dataset.answered = 'true';
                b.querySelectorAll('.quiz-option').forEach(opt => opt.classList.add('disabled'));
            });
            container.querySelector('.check-btn').style.display = 'none';
            container.querySelector('.next-btn').style.display = 'block';
        } else {
            showFeedback('Some answers are wrong or missing. Try again.', 'incorrect');
            setTimeout(() => {
                document.querySelectorAll('.quiz-option').forEach(o => {
                    if (o.classList.contains('incorrect')) {
                        o.classList.remove('selected', 'incorrect');
                    }
                });
            }, 1500);
        }
    }

    // --- Quiz Logic: Gap Fill ---
    let selectedWord = null;

    function setupGapFill() {
        document.querySelectorAll('.word-option').forEach(opt => {
            opt.addEventListener('click', (e) => {
                e.stopPropagation();
                if (opt.classList.contains('used')) return;
                if (selectedWord) selectedWord.classList.remove('selected');
                selectedWord = opt;
                opt.classList.add('selected');
            });
        });

        document.querySelectorAll('.gap-input').forEach(gap => {
            gap.addEventListener('click', (e) => {
                e.stopPropagation();
                if (gap.classList.contains('filled')) {
                    const wordText = gap.dataset.filledWord;
                    const bank = gap.closest('.content-card').querySelector('.word-options');
                    const bankWord = Array.from(bank.children).find(w => w.dataset.word === wordText);
                    if (bankWord) bankWord.classList.remove('used');
                    
                    gap.textContent = gap.dataset.originalText;
                    gap.classList.remove('filled', 'correct', 'incorrect');
                    delete gap.dataset.filledWord;
                    return;
                }
                if (selectedWord) {
                    gap.textContent = selectedWord.dataset.word;
                    gap.dataset.filledWord = selectedWord.dataset.word;
                    gap.classList.add('filled');
                    selectedWord.classList.remove('selected');
                    selectedWord.classList.add('used');
                    selectedWord = null;
                }
            });
        });
    }

    function checkGapFillStage(stageNum) {
        const card = document.getElementById(`stage-${stageNum}`);
        if (card.querySelector('.gap-fill-text').dataset.answered === 'true') return;

        const gaps = card.querySelectorAll('.gap-input');
        let allCorrect = true;
        let allFilled = true;

        gaps.forEach(gap => {
            if (!gap.classList.contains('filled')) {
                allFilled = false;
                return;
            }
            if (gap.dataset.filledWord === gap.dataset.answer) {
                gap.classList.add('correct');
                gap.classList.remove('incorrect');
            } else {
                gap.classList.add('incorrect');
                allCorrect = false;
                saveMistake(gap.dataset.answer); // Save mistake to DB
            }
        });

        if (!allFilled) {
            showFeedback('Please fill all gaps.', 'incorrect');
        } else if (allCorrect) {
            showFeedback('Perfect!', 'correct');
            card.querySelector('.gap-fill-text').dataset.answered = 'true';
            card.querySelector('.check-btn').style.display = 'none';
            card.querySelector('.next-btn').style.display = 'block';
        } else {
            showFeedback('Some errors. Correct answers saved to your review list.', 'incorrect');
        }
    }

    // --- Confetti Animation ---
    const emojis = ['üí∏', '‚òÅÔ∏è', 'üíª', 'üìä', 'üòé', 'üéâ', '‚öñÔ∏è', 'üíº'];
    let celebrationInterval;

    function startCelebration() {
        const container = document.getElementById('confettiContainer');
        container.classList.add('active');
        celebrationInterval = setInterval(() => {
            const piece = document.createElement('div');
            piece.classList.add('confetti-piece');
            piece.textContent = emojis[Math.floor(Math.random() * emojis.length)];
            piece.style.left = Math.random() * 100 + 'vw';
            piece.style.animationDuration = (Math.random() * 2 + 3) + 's';
            container.appendChild(piece);
            setTimeout(() => piece.remove(), 5000);
        }, 200);
        
        setTimeout(() => {
            clearInterval(celebrationInterval);
            container.classList.remove('active');
            container.innerHTML = '';
        }, 5000);
    }

    // --- Stage Navigation ---
    function nextStage(num) {
        document.querySelectorAll('.content-card[id^="stage-"]').forEach(c => c.style.display = 'none');
        
        const nextStageEl = document.getElementById(`stage-${num}`);
        if (nextStageEl) {
            nextStageEl.style.display = 'block';
            document.getElementById('current-stage').textContent = num;
            
            // Scroll to the content for better UX
            const readingHeight = document.getElementById('reading-content').parentElement.offsetHeight;
            window.scrollTo({ top: readingHeight + 50, behavior: 'smooth' });
        }
    }

    function toggleCollapse(id) {
        const el = document.getElementById(id);
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }

    function showFinalSummary() {
        document.querySelectorAll('.content-card[id^="stage-"]').forEach(c => c.style.display = 'none');
        document.getElementById('stage-6').style.display = 'block';
        
        startCelebration();

        const list = document.getElementById('learned-words-list');
        list.innerHTML = learnedWords.map(w => 
            `<li>
                <span class="word-term">${w.word}</span>
                <span class="word-type">${w.type}</span>
                <div style="display:none;">${w.definition}</div> 
            </li>`
        ).join('');
        
        list.querySelectorAll('li').forEach(li => {
            li.addEventListener('click', (e) => {
                e.stopPropagation();
                const term = li.querySelector('.word-term').textContent;
                const def = li.querySelector('div').textContent;
                const type = li.querySelector('.word-type').textContent;
                showDictionaryPopup(li, `<b style="color:#4F46E5">${term}</b> (${type})<br/>${def}`);
            });
        });
    }

    // --- Setup ---
    document.addEventListener('DOMContentLoaded', () => {
        initializeAuth();
        
        // Radio selection
        document.querySelectorAll('.question-box:not([data-type="checkbox"]) .quiz-option').forEach(opt => {
            opt.addEventListener('click', (e) => {
                e.stopPropagation();
                opt.parentNode.querySelectorAll('.quiz-option').forEach(o => o.classList.remove('selected'));
                opt.classList.add('selected');
            });
        });

        // Checkbox selection
        document.querySelectorAll('.question-box[data-type="checkbox"] .quiz-option').forEach(opt => {
            opt.addEventListener('click', (e) => {
                e.stopPropagation();
                opt.classList.toggle('selected');
            });
        });
        
        // Dictionary click (Reading Text)
        document.querySelectorAll('.dictionary-word').forEach(w => {
            w.addEventListener('click', (e) => {
                e.stopPropagation();
                showDictionaryPopup(w, `<b style="color:#0EA5E9">${w.textContent}</b>: ${w.dataset.definition}`);
            });
        });

        // Shuffle Banks
        const nounBank = document.getElementById('noun-bank');
        const conceptBank = document.getElementById('concept-bank');
        if(nounBank) {
            const words = Array.from(nounBank.children);
            shuffleArray(words).forEach(w => nounBank.appendChild(w));
        }
        if(conceptBank) {
            const words = Array.from(conceptBank.children);
            shuffleArray(words).forEach(w => conceptBank.appendChild(w));
        }

        setupGapFill();
    });
</script>
</body>
</html>
