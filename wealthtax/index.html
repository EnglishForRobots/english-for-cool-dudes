<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="icon" type="image/png" href="/favicon.png" sizes="32x32">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="manifest" href="/manifest.json">
    <title>Wealth Tax: The Global Debate - English For Cool Dudes</title>
    
    
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- BRANDING & LAYOUT STYLES --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: #F1F5F9; /* Light Slate Background */
            color: #1E293B; /* Dark Slate Text */
            line-height: 1.6;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
        }

        /* --- THEME: FINANCE/WEALTH TAX PALETTE (BLUE/GOLD) üí∂ --- */
        :root {
            --color-primary: #1E3A8A; /* Dark Blue (Gov/Finance) */
            --color-secondary: #0F172A; /* Slate Black */
            --color-accent: #D97706; /* Gold (Money) */
            --color-white: #FFFFFF;
            
            /* Feedback Colors */
            --color-correct: #059669; /* Emerald Green */
            --color-incorrect: #DC2626; /* Error Red */
            
            --color-save-btn: #D97706; 
        }

        /* Header */
        .header {
            background: var(--color-white);
            border-bottom: 2px solid var(--color-primary);
            padding: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
            position: sticky; top: 0; z-index: 100;
        }
        .header-content {
            max-width: 1200px; margin: 0 auto; padding: 0 20px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .header-left { display: flex; align-items: center; gap: 15px; }

        .logo {
            width: 36px; height: 36px;
            background: linear-gradient(135deg, #1E3A8A 0%, #3B82F6 100%); 
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
            font-size: 20px; color: white;
        }
        .site-title { font-size: 20px; font-weight: 600; color: #0F172A; text-decoration: none; letter-spacing: -0.02em; }

        /* Buttons */
        .header-buttons { display: flex; align-items: center; gap: 8px; }
        .header-button {
            text-decoration: none; padding: 7px 14px; border-radius: 6px;
            font-size: 14px; font-weight: 600; transition: all 0.2s;
            white-space: nowrap; cursor: pointer; border: 1px solid #CBD5E1;
            background: transparent;
        }
        .header-button.login { background: #FFF; color: #475569; }
        .header-button.login:hover { background: #F8FAFC; color: var(--color-primary); }
        
        .header-button.signup { background: var(--color-primary); color: white; border-color: var(--color-primary); }
        .header-button.signup:hover { background: #1E40AF; box-shadow: 0 2px 5px rgba(30, 58, 138, 0.3); }
        
        .header-button.dashboard { background: #EFF6FF; color: var(--color-primary); border-color: #BFDBFE; }
        .header-button.logout { background: #FEF2F2; color: #DC2626; border-color: #FECACA; }
        
        .user-greeting { font-size: 14px; color: #475569; font-weight: 600; margin-right: 5px; display: block; }

        /* Container */
        .container-main {
            max-width: 1000px; margin: 30px auto; padding: 30px 20px;
            background-color: var(--color-white); border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.06); border: 2px solid #E2E8F0;
        }

        .lesson-main-title {
            font-size: 2.5em; font-weight: 800; color: var(--color-primary); 
            margin-bottom: 10px; letter-spacing: -0.02em;
        }

        .lesson-section {
            background-color: #F8FAFC; padding: 30px; border-radius: 10px;
            border: 1px solid #E2E8F0; margin-bottom: 30px;
        }

        .section-title {
            color: var(--color-secondary); font-size: 1.8em; font-weight: 800;
            margin-bottom: 20px; padding-bottom: 5px; border-bottom: 2px dashed #94A3B8;
        }
        
        /* Reading Text */
        .reading-text {
            background: #FFFFFF; border-left: 5px solid var(--color-primary);
            padding: 20px; border-radius: 0 8px 8px 0; font-size: 1.1em;
            color: #334155; line-height: 1.8; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .highlight-word {
            color: var(--color-primary); font-weight: 700; cursor: help;
            border-bottom: 2px dotted var(--color-accent); transition: all 0.2s;
        }
        .highlight-word:hover { background-color: #FEF3C7; color: #D97706; border-radius: 4px; }
        
        /* Match Cards */
        .match-card {
            border: 2px solid transparent; 
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            cursor: pointer; user-select: none; border-radius: 0.75rem; 
            padding: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.04); font-weight: 600;
            opacity: 1; transform: scale(1); min-height: 80px; display: flex; align-items: center; justify-content: center;
        }
        .match-card.term {
            background-color: #F1F5F9; border: 2px solid var(--color-primary); 
            text-align: center; color: var(--color-primary); font-size: 1.1em;
        }
        .match-card.definition {
            background-color: #FFFFFF; text-align: left; border: 2px solid #CBD5E1; color: #475569; font-size: 0.95em;
        }
        .match-card.selected {
            border-color: var(--color-accent); background-color: #FEF3C7; 
            box-shadow: 0 0 0 4px #FDE68A; transform: scale(1.02); color: #D97706;
        }
        
        /* Vanishing Style */
        .match-card.matched {
            background-color: #DCFCE7 !important; 
            border-color: #059669 !important; 
            color: #064E3B !important;
            transform: scale(1.05);
        }
        .match-card.vanished {
            opacity: 0 !important;
            pointer-events: none;
            transform: scale(0.5);
        }

        /* Quiz Buttons */
        .comp-btn-group .option-button {
            transition: all 0.2s; background-color: #FFFFFF; color: #334155;
            font-weight: 600; padding: 12px 15px; border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); border: 1px solid #E2E8F0;
            text-align: left; width: 100%; cursor: pointer; margin-bottom: 10px;
        }
        .comp-btn-group .option-button:hover { border-color: var(--color-primary); background-color: #F8FAFC; }
        .comp-btn-group .option-button.selected { background-color: #EFF6FF; color: var(--color-primary) !important; border-color: var(--color-primary); box-shadow: 0 0 0 4px #BFDBFE; }
        .comp-btn-group .option-button.correct { background-color: #DCFCE7 !important; color: #166534 !important; border-color: #166534 !important; box-shadow: 0 0 0 4px #166534 !important; }
        .comp-btn-group .option-button.incorrect { background-color: #FEE2E2 !important; color: #991B1B !important; border-color: #991B1B !important; box-shadow: 0 0 0 4px #991B1B !important; }

        .result-message { margin-top: 15px; padding: 15px; border-radius: 8px; font-weight: 700; display: none; text-align: center; }
        .result-message.correct { background-color: #DCFCE7; color: #166534; border: 1px solid #86EFAC; }
        .result-message.incorrect { background-color: #FEE2E2; color: #991B1B; border: 1px solid #FCA5A5; }
        
        /* Gap-Fill */
        .word-bank { background: #EFF6FF; border: 2px dashed var(--color-primary); border-radius: 10px; padding: 20px; margin-bottom: 25px; }
        .word-options { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .word-option {
            background-color: #FFFFFF; color: var(--color-secondary); padding: 8px 16px;
            border-radius: 8px; cursor: pointer; transition: all 0.2s; font-weight: 700;
            box-shadow: 0 2px 0 rgba(0,0,0,0.1); border: 2px solid var(--color-secondary);
        }
        .word-option:hover { background-color: #F1F5F9; border-color: var(--color-primary); color: var(--color-primary); transform: translateY(-2px); }
        .word-option.selected { background-color: var(--color-primary) !important; color: white !important; border-color: var(--color-primary) !important; transform: scale(1.05); }
        .word-option.used { opacity: 0.4; pointer-events: none; background-color: #94A3B8; border-color: #94A3B8; color: white; transform: none; }

        .gap-input {
            display: inline-block; text-align: center; padding: 0 10px; min-width: 120px; 
            height: 32px; line-height: 30px; background-color: #FFFFFF; border-bottom: 3px solid var(--color-secondary); 
            color: var(--color-primary); font-weight: 700; cursor: pointer; margin: 0 4px; transition: all 0.2s;
        }
        .gap-input:empty { background-color: #F8FAFC; }
        .gap-input.filled { background-color: #EFF6FF; border-bottom-color: var(--color-primary); }
        .gap-input.correct { background-color: var(--color-correct) !important; color: white !important; border-bottom-color: var(--color-correct) !important; pointer-events: none; }
        .gap-input.incorrect { background-color: var(--color-incorrect) !important; color: white !important; border-bottom-color: var(--color-incorrect) !important; }

        /* Buttons & Save */
        .button-group { margin-top: 20px; display: flex; gap: 15px; justify-content: center; }
        .check-button {
            background: var(--color-secondary); color: white; border: none; padding: 12px 25px;
            border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 700;
            transition: all 0.3s; box-shadow: 0 4px 0 #000; text-transform: uppercase; letter-spacing: 1px;
        }
        .check-button:hover { background: #334155; transform: translateY(-2px); box-shadow: 0 6px 0 #000; }
        .check-button:active { transform: translateY(2px); box-shadow: 0 0 0 #000; }
        .reset-button { background: #64748B; box-shadow: 0 4px 0 #334155; }
        .reset-button:hover { background: #475569; box-shadow: 0 6px 0 #334155; }

        #save-words-section { background: #F8FAFC; border: 2px solid #E2E8F0; padding: 25px; border-radius: 12px; margin-top: 40px; text-align: center; }
        #save-words-btn {
            background-color: var(--color-save-btn); color: white; padding: 14px 30px;
            border-radius: 9999px; font-weight: 700; cursor: pointer; transition: all 0.2s;
            display: block; width: 100%; border: none; box-shadow: 0 4px #92400E;
            text-transform: uppercase; font-size: 1.1em;
        }
        #save-words-btn:hover:not(:disabled) { background-color: #B45309; transform: translateY(-2px); box-shadow: 0 6px #92400E; }
        #save-words-btn:active:not(:disabled) { box-shadow: 0 0 #92400E; transform: translateY(2px); }
        
        #learned-words-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; margin-bottom: 20px; text-align: center; list-style: none; }
        #learned-words-list li {
            background: white; padding: 12px 15px; border-radius: 8px; border: 1px solid #E2E8F0;
            font-size: 0.95em; cursor: pointer; transition: all 0.2s; font-weight: 700; color: #334155;
        }
        #learned-words-list li:hover { transform: translateY(-2px); border-color: var(--color-primary); color: var(--color-primary); box-shadow: 0 4px 10px rgba(0,0,0,0.05); background-color: #F8FAFC; }

        /* Popups */
        #feedback-popup {
            position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%);
            padding: 25px 40px; border-radius: 16px; font-weight: 700; color: white;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); z-index: 2000; display: none;
            text-align: center; font-size: 1.2em; border: 4px solid white; min-width: 300px;
        }
        #dictionary-popup {
            position: fixed; max-width: 300px; padding: 20px; background: #FFFFFF;
            border: 3px solid var(--color-primary); border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 2001; display: none;
            font-size: 1em; color: #334155; line-height: 1.5;
        }
        @media (max-width: 768px) { .user-greeting { display: none; } }

         .footer {
            background: #FFFFFF;
            border-top: 1px solid #E5E9F2;
            padding: 32px 20px;
            margin-top: 60px;
            text-align: center;
        }

        .footer-text {
            font-size: 14px;
            color: #718096;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <span class="logo">üèõÔ∏è</span>
                <a href="/tax/" class="site-title">English For Cool Dudes</a>
            </div>
            <div id="logged-out-buttons" class="header-buttons" style="display: none;">
                <a href="/login/" class="header-button login">Login</a>
                <a href="/signup/" class="header-button signup">Sign Up</a>
            </div>
            <div id="logged-in-buttons" class="header-buttons" style="display: none;">
                <span class="user-greeting" id="user-greeting">Hey Cool Dude! üëã</span>
                <a href="/dashboard-gamified/" class="header-button dashboard">My Dashboard</a>
                <button id="logout-btn" class="header-button logout">Sign Out</button>
            </div>
        </div>
    </header>

    <div class="container-main">
        <h1 class="lesson-main-title">üí∂ Wealth Tax: The Global Debate</h1>
        <p class="text-lg text-gray-500 mb-8">Advanced (C1) | Topic: Tax Policy & Inequality</p>

        <main class="space-y-8">
            
            <section class="lesson-section shadow-lg">
                <h2 class="section-title">üìú 1. Context: To Tax or Not to Tax?</h2>
                <div class="reading-text">
                    <h3 class="font-bold text-xl mb-4 text-gray-800">The Wealth Tax Dilemma</h3>
                    <p class="mb-4">In Germany, the Wealth Tax has been <span class="highlight-word" onclick="showDictionaryPopup(this, 'Suspended')">suspended</span> since 1997. The Constitutional Court ruled that valuation methods for real estate versus financial assets were unequal. However, calls for its reintroduction are growing. Proponents argue that it is the most effective tool for <span class="highlight-word" onclick="showDictionaryPopup(this, 'Redistribution')">redistribution</span>, ensuring the gap between the ultra-rich and the working class does not widen.</p>
                    
                    <p class="mb-4">Opponents, particularly in the middle class, cite <span class="highlight-word" onclick="showDictionaryPopup(this, 'Liquidity')">liquidity</span> concerns. A business owner might be "wealthy" on paper because they own a factory, but they may not have the cash on hand to pay a tax on those <span class="highlight-word" onclick="showDictionaryPopup(this, 'Assets')">assets</span>.</p>
                    
                    <p>Internationally, the debate is equally heated. France famously replaced its broad wealth tax (ISF) with a real-estate specific tax (IFI) to prevent <span class="highlight-word" onclick="showDictionaryPopup(this, 'Capital Flight')">capital flight</span>, where millionaires moved their tax residency to Belgium or Switzerland.</p>
                </div>
            </section>

            <section id="exercise-1" class="lesson-section shadow-lg">
                <h2 class="section-title">üîó 2. Vocabulary Memory Match</h2>
                <p class="text-gray-600 mb-6 font-medium">Match the term to its definition. Correct pairs will vanish!</p>

                <div id="vocab-match-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </section>
        
            <section id="exercise-2" class="lesson-section shadow-lg">
                <h2 class="section-title">üìà 3. Policy Details</h2>
                <p class="text-gray-600 mb-4 font-medium">Select the correct statement based on the text.</p>
                
                <div class="question" data-question="1">
                    <p class="font-bold text-gray-800 mb-3">1. Why was the German tax suspended in 1997?</p>
                    <ul class="options-list space-y-3 comp-btn-group" data-question="1">
                        <li class="option-button" data-correct="false">Because the government had a budget surplus.</li>
                        <li class="option-button" data-correct="true">Because valuation methods were ruled unequal by the court.</li>
                        <li class="option-button" data-correct="false">Because the EU made it illegal.</li>
                    </ul>
                </div>
                
                <div class="question" data-question="2">
                    <p class="font-bold text-gray-800 mb-3">2. What is the main "liquidity" concern?</p>
                    <ul class="options-list space-y-3 comp-btn-group" data-question="2">
                        <li class="option-button" data-correct="true">Owners have assets (factories) but not enough cash to pay the tax.</li>
                        <li class="option-button" data-correct="false">The tax money flows out of the country too quickly.</li>
                        <li class="option-button" data-correct="false">Business owners want to move to France.</li>
                    </ul>
                </div>

                <div class="button-group">
                    <button class="check-button" onclick="checkComprehension()">Check Answers</button>
                    <button class="check-button reset-button" onclick="resetComprehension()">Reset</button>
                </div>
                <div id="comprehension-result" class="result-message"></div>
            </section>

            <section id="exercise-3" class="lesson-section shadow-lg">
                <h2 class="section-title">üìù 4. Finance Vocabulary (Context)</h2>
                <p class="text-gray-600 mb-6 font-medium">Fill in the blanks. Incorrect answers will be saved for review.</p>
                
                <div class="word-bank">
                    <p class="font-bold mb-2 text-xs text-gray-500 uppercase w-full text-center">Word Bank</p>
                    <div class="word-options" id="gap-fill-options">
                        <div class="word-option" data-word="redistribution">redistribution</div>
                        <div class="word-option" data-word="assets">assets</div>
                        <div class="word-option" data-word="liquidity">liquidity</div>
                        <div class="word-option" data-word="inequality">inequality</div>
                        <div class="word-option" data-word="capital flight">capital flight</div>
                    </div>
                </div>

                <div class="gap-fill-text text-lg leading-loose space-y-4">
                    <p>1. The government hopes that higher taxes will help with wealth <span class="gap-input" data-answer="redistribution">____</span>.</p>
                    <p>2. We cannot pay the tax because we have a <span class="gap-input" data-answer="liquidity">____</span> problem; no cash on hand.</p>
                    <p>3. The <span class="gap-input" data-answer="assets">____</span> of the company include real estate, patents, and machinery.</p>
                    <p>4. Rising <span class="gap-input" data-answer="inequality">____</span> is a major social issue in many developed nations.</p>
                    <p>5. If taxes are too high, the country might experience <span class="gap-input" data-answer="capital flight">____</span>.</p>
                </div>
                <div class="button-group">
                    <button class="check-button" onclick="checkGaps()">Check Vocabulary</button>
                    <button class="check-button reset-button" onclick="resetGaps()">Reset</button>
                </div>
                <div id="gap-result" class="result-message"></div>
            </section>

            <section class="lesson-section shadow-lg border-t-4 border-yellow-600">
                <h2 class="section-title">üéâ Audit Complete!</h2>
                <p class="mb-4 text-gray-600">You have analyzed the Wealth Tax debate. Review definitions below:</p>
                
                <ul id="learned-words-list">
                    <li data-word="redistribution">redistribution</li><li data-word="liquidity">liquidity</li><li data-word="assets">assets</li><li data-word="inequality">inequality</li>
                    <li data-word="capital flight">capital flight</li><li data-word="suspended">suspended</li><li data-word="revenue">revenue</li><li data-word="unfair">unfair</li>
                </ul>

                <div id="save-words-section">
                    <h3 class="text-xl font-bold mb-3" style="color: var(--color-accent);">üíæ Save Your Progress</h3>
                    
                    <div id="save-feature-loggedin" style="display: none;">
                        <p class="text-gray-700 mb-4">Save these words to your personal dashboard.</p>
                        <button id="save-words-btn" onclick="saveWordsToDashboard()">Save 8 Words to Inventory</button>
                        <p id="save-status" class="text-center mt-3 font-semibold"></p>
                    </div>
                    
                    <div id="login-prompt" style="display: none;">
                        <p class="text-red-600 font-bold mb-2">üîí Login to save your progress!</p>
                        <a href="/login/" class="inline-block bg-blue-600 text-white font-bold py-2 px-4 rounded hover:bg-blue-700 transition">Log In / Sign Up</a>
                    </div>
                </div>
            </section>

        </main>
        <footer class="footer">
    <p class="footer-text">¬© 2026 English For Cool Dudes - üòé</p>
    <div style="margin-top: 10px;">
        <a href="/impressum/" style="color: #667EEA; margin-right: 15px; text-decoration: none;">Impressum</a>
        <a href="/datenschutz/" style="color: #667EEA; text-decoration: none;">Datenschutzerkl√§rung</a>
    </div>
</footer>
    </div>
    
    <div id="feedback-popup"></div>
    <div id="dictionary-popup"></div>

    <script>
        // --- CONFIG ---
        const SUPABASE_URL = 'https://knwgmrgwbpchqyqxbxea.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtud2dtcmd3YnBjaHF5cXhieGVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MDkyODgsImV4cCI6MjA3ODA4NTI4OH0.qnp2ScwSE77_idmPhpLE98sr46WvLpKtg6refFfC7s8';
        
        // FIX: RENAMED TO wealthTaxClient to avoid conflict
        const wealthTaxClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentUser = null;

        const lessonTitle = "Wealth Tax: The Global Debate";
        const lessonLink = "/wealthtax/";
        const lessonLevel = "C1";

        const wordsToSave = [
            { word: "redistribution", type: "noun", definition: "Transfer of wealth/income from rich to poor." },
            { word: "liquidity", type: "noun", definition: "Availability of cash to pay bills." },
            { word: "assets", type: "noun", definition: "Property owned regarded as having value." },
            { word: "inequality", type: "noun", definition: "Difference in size/wealth; lack of equality." },
            { word: "capital flight", type: "noun phrase", definition: "Assets flowing out of a country due to tax/economy." },
            { word: "suspended", type: "verb/adj", definition: "Temporarily prevented from continuing." },
            { word: "revenue", type: "noun", definition: "Income, especially of a company or state." },
            { word: "unfair", type: "adjective", definition: "Not following rules of justice." }
        ];

        // --- AUTH ---
        async function checkUser() {
            try {
                const { data: { user } } = await wealthTaxClient.auth.getUser();
                if (user) {
                    currentUser = user;
                    document.getElementById('logged-in-buttons').style.display = 'flex';
                    document.getElementById('logged-out-buttons').style.display = 'none';
                    document.getElementById('save-feature-loggedin').style.display = 'block';
                    document.getElementById('login-prompt').style.display = 'none';
                    const name = user.user_metadata.full_name ? user.user_metadata.full_name.split(' ')[0] : 'Cool Dude';
                    document.getElementById('user-greeting').textContent = `Hey ${name}! üëã`;
                } else {
                    document.getElementById('logged-in-buttons').style.display = 'none';
                    document.getElementById('logged-out-buttons').style.display = 'flex';
                    document.getElementById('save-feature-loggedin').style.display = 'none';
                    document.getElementById('login-prompt').style.display = 'block';
                }
            } catch (err) { console.error(err); }
        }

        async function saveWordsToDashboard() {
            if (!currentUser) return;
            const btn = document.getElementById('save-words-btn');
            const status = document.getElementById('save-status');
            btn.disabled = true; btn.textContent = "Processing...";

            const { error } = await wealthTaxClient.from('lessons').upsert([{
                user_id: currentUser.id, lesson_title: lessonTitle, lesson_link: lessonLink,
                lesson_level: lessonLevel, vocabulary: wordsToSave, completed_at: new Date().toISOString()
            }], { onConflict: 'user_id,lesson_title' });

            if (!error) {
                btn.textContent = "‚úÖ Inventory Saved!"; btn.style.backgroundColor = "#059669";
                status.textContent = "Assets secured! Check your dashboard.";
                setTimeout(() => window.location.href = '/dashboard/', 1500);
            } else {
                btn.textContent = "‚ùå Error"; btn.disabled = false;
                status.textContent = "Error saving. Please try again.";
            }
        }
        
        async function saveMistake(word) {
            if(!currentUser) return;
            const wObj = wordsToSave.find(w=>w.word.toLowerCase()===word.toLowerCase()) || {word, definition:'Review this term', type:'term'};
            await wealthTaxClient.from('user_mistakes').upsert({
                user_id: currentUser.id, word: wObj.word, definition: wObj.definition, word_type: wObj.type,
                lesson: lessonTitle, lesson_link: lessonLink, last_made_at: new Date().toISOString()
            }, {onConflict: 'user_id,word'});
        }

        document.getElementById('logout-btn').addEventListener('click', async () => {
            await wealthTaxClient.auth.signOut(); window.location.href = '/';
        });

        // --- UTILS ---
        function showFeedback(msg, type) {
            const el = document.getElementById('feedback-popup');
            el.textContent = msg; el.style.display = 'block';
            el.style.backgroundColor = type === 'correct' ? '#059669' : '#DC2626';
            el.style.borderColor = type === 'correct' ? '#064E3B' : '#7F1D1D';
            setTimeout(() => { el.style.display = 'none'; }, 1800);
        }

        function showDictionaryPopup(target, word) {
            const wordObj = wordsToSave.find(w => w.word.toLowerCase() === word.toLowerCase());
            const popup = document.getElementById('dictionary-popup');
            if(wordObj) popup.innerHTML = `<strong>${wordObj.word}</strong> <span style="font-size:0.85em; color:#D97706;">(${wordObj.type})</span><br>${wordObj.definition}`;
            else popup.innerHTML = `<strong>${word}</strong><br>Definition not found.`;
            popup.style.display = 'block';
            const rect = target.getBoundingClientRect();
            let topPos = rect.top - popup.offsetHeight - 10;
            if (topPos < 10) topPos = rect.bottom + 10;
            popup.style.top = topPos + 'px';
            popup.style.left = (rect.left + (rect.width/2) - (popup.offsetWidth/2)) + 'px';
        }
        document.body.addEventListener('click', (e) => {
            if (!e.target.closest('#dictionary-popup') && !e.target.closest('#learned-words-list li') && !e.target.closest('.highlight-word')) {
                document.getElementById('dictionary-popup').style.display = 'none';
            }
        });

        // --- EXERCISES ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        function cleanText(text) { return text ? text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z]/g, '').toLowerCase() : ''; }

        /* MATCHING */
        const newVocabData = [
            { type: 'term', content: "Redistribution", key: 'A' }, { type: 'definition', content: "Moving wealth from rich to poor.", key: 'A' },
            { type: 'term', content: "Liquidity", key: 'B' }, { type: 'definition', content: "Having cash available.", key: 'B' },
            { type: 'term', content: "Assets", key: 'C' }, { type: 'definition', content: "Property owned (e.g. factory).", key: 'C' },
            { type: 'term', content: "Inequality", key: 'D' }, { type: 'definition', content: "Large gap between rich & poor.", key: 'D' },
            { type: 'term', content: "Capital Flight", key: 'E' }, { type: 'definition', content: "Money leaving the country.", key: 'E' }
        ];
        let selectedTermCard = null, selectedDefinitionCard = null, matchedPairs = 0;

        const funCorrect = [
            "Inequality Reduced! ‚öñÔ∏è", 
            "Fair Share! üí∞", 
            "Assets Secured! üèõÔ∏è", 
            "Tax Paid! ‚úÖ"
        ];
        const funIncorrect = [
            "Capital Flight! ‚úàÔ∏è", 
            "Audit Failed! üìâ", 
            "Tax Evasion! üö´", 
            "Liquidity Crisis! üí∏"
        ];

        function initVocab() {
            const matchContainer = document.getElementById('vocab-match-container');
            matchContainer.innerHTML = ''; 
            shuffleArray(newVocabData);
            
            // Staggered Fade In Animation
            newVocabData.forEach((item, index) => {
                const card = document.createElement('div'); 
                card.className = `match-card interactive-element ${item.type}`;
                card.innerHTML = item.type === 'term' ? `<span>${item.content}</span>` : `<span>${item.content}</span>`; 
                card.dataset.key = item.key; card.dataset.type = item.type;
                
                // Init hidden
                card.style.opacity = '0';
                card.style.transform = 'scale(0.8)';
                
                card.addEventListener('click', () => handleMatchClick(card));
                matchContainer.appendChild(card);
                
                // Reveal
                setTimeout(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'scale(1)';
                }, index * 100);
            });
            selectedTermCard = null; selectedDefinitionCard = null; matchedPairs = 0;
        }

        function handleMatchClick(card) {
            if (card.classList.contains('matched') || card.classList.contains('vanished')) return;
            const type = card.dataset.type;
            let currentSelection = type === 'term' ? selectedTermCard : selectedDefinitionCard;
            if (currentSelection) currentSelection.classList.remove('selected');
            if (currentSelection === card) {
                if (type === 'term') selectedTermCard = null; else selectedDefinitionCard = null;
                return;
            }
            if (type === 'term') selectedTermCard = card; else selectedDefinitionCard = card;
            card.classList.add('selected');

            if (selectedTermCard && selectedDefinitionCard) {
                if (selectedTermCard.dataset.key === selectedDefinitionCard.dataset.key) {
                    
                    // Match Success!
                    [selectedTermCard, selectedDefinitionCard].forEach(el => { 
                        el.classList.remove('selected'); 
                        el.classList.add('matched'); // Green
                        
                        // Vanish
                        setTimeout(() => {
                            el.classList.add('vanished');
                        }, 500);
                    });
                    
                    showFeedback(funCorrect[Math.floor(Math.random() * funCorrect.length)], 'correct');
                    matchedPairs++;
                    
                    // Auto-Reset
                    if (matchedPairs === newVocabData.length / 2) {
                        setTimeout(() => {
                            showFeedback("üéâ All Matched! Resetting...", 'correct');
                            setTimeout(initVocab, 2000);
                        }, 1000);
                    }
                    selectedTermCard = null; selectedDefinitionCard = null;
                } else {
                    showFeedback(funIncorrect[Math.floor(Math.random() * funIncorrect.length)], 'incorrect');
                    setTimeout(() => {
                        if(selectedTermCard) selectedTermCard.classList.remove('selected'); 
                        if(selectedDefinitionCard) selectedDefinitionCard.classList.remove('selected');
                        selectedTermCard = null; selectedDefinitionCard = null;
                    }, 800);
                }
            }
        }
        function resetVocab() { initVocab(); }

        /* COMPREHENSION */
        function checkComprehension() {
            const questions = document.querySelectorAll('.question'); let correctAnswers = 0;
            questions.forEach(q => {
                const selected = q.querySelector('.option-button.selected');
                q.querySelectorAll('.option-button').forEach(opt => {
                    opt.classList.remove('correct', 'incorrect');
                    if (opt.dataset.correct === 'true') opt.classList.add('correct');
                });
                if (selected) {
                    if (selected.dataset.correct === 'true') correctAnswers++; else selected.classList.add('incorrect');
                }
            });
            const resultDiv = document.getElementById('comprehension-result'); resultDiv.style.display = 'block';
            if (correctAnswers === questions.length) { resultDiv.textContent = 'üéâ Policy Expert! Analysis Correct.'; resultDiv.className = 'result-message correct'; }
            else { resultDiv.textContent = `You got ${correctAnswers}/${questions.length} correct.`; resultDiv.className = 'result-message incorrect'; }
        }
        function resetComprehension() {
            document.querySelectorAll('.option-button').forEach(item => item.classList.remove('selected', 'correct', 'incorrect'));
            document.getElementById('comprehension-result').style.display = 'none';
        }

        /* GAP FILL */
        const gapAnswers = ['redistribution', 'liquidity', 'assets', 'inequality', 'capital flight']; 
        let selectedGapWord = null; 
        
        function initGaps() {
            const wordOptionsContainer = document.getElementById('gap-fill-options');
            const options = Array.from(wordOptionsContainer.children);
            shuffleArray(options);
            options.forEach(option => { wordOptionsContainer.appendChild(option); option.classList.remove('used', 'selected'); });
            document.querySelectorAll('.gap-input').forEach(blank => { blank.textContent = '____'; blank.classList.remove('correct', 'incorrect', 'selected'); });
            selectedGapWord = null; document.getElementById('gap-result').style.display = 'none';
        }
        
        function handleGapBlankClick(blank) {
            if (blank.textContent.trim() !== '' && blank.textContent.trim() !== '____') { 
                const cleanedWord = blank.textContent; 
                const btn = Array.from(document.querySelectorAll('.word-option')).find(b => b.textContent === cleanedWord);
                if (btn) btn.classList.remove('used');
                blank.textContent = '____'; blank.classList.remove('correct', 'incorrect', 'filled');
                return;
            } 
            if (selectedGapWord) {
                blank.textContent = selectedGapWord.textContent.trim();
                blank.classList.add('filled');
                selectedGapWord.classList.remove('selected'); selectedGapWord.classList.add('used');
                selectedGapWord = null;
            } 
        }
        
        function checkGaps() {
            let correctCount = 0;
            let attemptedCount = 0;
            const blanks = document.querySelectorAll('.gap-input');
            
            blanks.forEach(blank => { 
                const answerWord = blank.dataset.answer;
                const extractedWord = blank.textContent.trim();
                
                blank.classList.remove('selected', 'incorrect');
                
                if (!extractedWord || extractedWord === '____' || extractedWord === '') {
                    return;
                }
                
                attemptedCount++;

                if (extractedWord.toLowerCase() === answerWord.toLowerCase()) { 
                    blank.classList.add('correct'); correctCount++; 
                } else { 
                    blank.classList.add('incorrect');
                    saveMistake(answerWord); 
                }
            });

            const resultDiv = document.getElementById('gap-result'); resultDiv.style.display = 'block';
            
            if (correctCount === blanks.length) { 
                resultDiv.textContent = 'üéâ Perfect! Fiscal policy mastered.'; 
                resultDiv.className = 'result-message correct';
                resultDiv.style.backgroundColor = ''; resultDiv.style.color = ''; resultDiv.style.borderColor = '';
            } else if (attemptedCount === 0) {
                resultDiv.textContent = 'Please fill in a word first.'; 
                resultDiv.className = 'result-message incorrect';
                resultDiv.style.backgroundColor = '#F1F5F9'; resultDiv.style.color = '#64748B'; resultDiv.style.borderColor = '#CBD5E1';
            } else if (correctCount === attemptedCount) {
                resultDiv.textContent = `Good start! ${correctCount} correct so far. Keep going!`; 
                resultDiv.className = 'result-message correct';
                resultDiv.style.backgroundColor = '#FEF3C7'; 
                resultDiv.style.color = '#B45309'; 
                resultDiv.style.borderColor = '#FCD34D';
            } else { 
                resultDiv.textContent = `You got ${correctCount} correct out of ${attemptedCount} attempted.`; 
                resultDiv.className = 'result-message incorrect'; 
                resultDiv.style.backgroundColor = ''; resultDiv.style.color = ''; resultDiv.style.borderColor = '';
            }
        }

        function resetGaps() {
            initGaps();
        }

        document.addEventListener('DOMContentLoaded', () => {
            checkUser(); initVocab(); initGaps();
            document.querySelectorAll('#learned-words-list li').forEach(li => li.addEventListener('click', (e) => { e.stopPropagation(); showDictionaryPopup(li, li.dataset.word); }));
            document.querySelectorAll('.option-button').forEach(item => item.addEventListener('click', () => {
                item.closest('.question').querySelectorAll('.option-button').forEach(opt => opt.classList.remove('selected', 'correct', 'incorrect'));
                item.classList.add('selected'); document.getElementById('comprehension-result').style.display = 'none';
            }));
            document.querySelectorAll('.word-option').forEach(option => option.addEventListener('click', () => {
                if (option.classList.contains('used')) return;
                if (selectedGapWord) selectedGapWord.classList.remove('selected');
                if (selectedGapWord === option) selectedGapWord = null;
                else { selectedGapWord = option; selectedGapWord.classList.add('selected'); }
            }));
            document.querySelectorAll('.gap-input').forEach(blank => blank.addEventListener('click', () => handleGapBlankClick(blank)));
        });
    </script>
</body>
</html>
