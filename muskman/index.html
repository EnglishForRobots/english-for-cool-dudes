<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title id="page-title">Loading...</title>
    <!-- System fonts only ‚Äî no external font requests -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/init-auth.js"></script>

    <script>
const LESSON_CONFIG = {

    title:      "üöÄ Elon Musk's Big Bet",
    subtitle:   "SpaceX, xAI, and the $1.5 trillion IPO ‚Äî fact or fiction?",
    level:      "Business",
    lessonId:   "spacex-elon-musk",
    lessonLink: "/spacex-elon-musk/",
    logoEmoji:  "üöÄ",
    levelPage:  "/business/",

    colors: {
        primary:    "#00D4FF",
        secondary:  "#0A0E1A",
        background: "#060910"
    },

    vocabulary: [
        { word: "IPO",        type: "noun",      definition: "Initial Public Offering ‚Äî when a private company sells its shares to the public for the first time." },
        { word: "Valuation",  type: "noun",      definition: "The estimated financial worth of a company." },
        { word: "Merger",     type: "noun",      definition: "When two or more companies combine to become one." },
        { word: "Revenue",    type: "noun",      definition: "The total amount of money a company earns from its business activities." },
        { word: "Profitable", type: "adjective", definition: "Making more money than is spent; generating a profit." },
        { word: "Prospectus", type: "noun",      definition: "An official document a company publishes before an IPO, containing financial details." },
        { word: "Run rate",   type: "phrase",    definition: "A prediction of future performance based on current figures ‚Äî e.g. doubling monthly revenue to estimate annual revenue." },
        { word: "Shares",     type: "noun",      definition: "Units of ownership in a company that can be bought and sold." },
        { word: "Tripartite", type: "adjective", definition: "Consisting of three parts or involving three parties." },
        { word: "Far-fetched", type: "adjective", definition: "Unlikely or difficult to believe; not realistic." }
    ],

    sections: [

        {
            type:  "reading",
            title: "üì° 1. Reading: The $1.5 Trillion Plan",

            facts: [
                "SpaceX was valued at $800 billion in December 2025",
                "X (Twitter) + xAI merged first, then merged again with SpaceX in January 2026",
                "The SpaceX IPO is planned for July 2026",
                "xAI's chatbot is called Grok ‚Äî a rival to ChatGPT"
            ],

            content: `
                <p class="mb-4">Elon Musk is planning to take SpaceX public in July 2026 with a target <vocab>valuation</vocab> of $1.5 trillion. But SpaceX is no longer just a rocket company ‚Äî it now includes X (formerly Twitter) and xAI, the company behind the Grok chatbot.</p>
                <p class="mb-4">In early 2025, Musk merged X and xAI together. Then, in January 2026, he merged that combined company with SpaceX. This <vocab>tripartite</vocab> <vocab>merger</vocab> means that when the SpaceX <vocab>IPO</vocab> happens, investors who buy <vocab>shares</vocab> will automatically own a piece of all three businesses.</p>
                <p class="mb-4">So how much are they worth? SpaceX generated around $15 billion in <vocab>revenue</vocab> in 2025 and is <vocab>profitable</vocab>. xAI, however, is losing money ‚Äî it earned roughly $500 million a year but lost around $5 billion. Combined, the company has about $16 billion in revenue but only $3 billion in profit.</p>
                <p class="mb-4">At a $1.5 trillion valuation, investors would be paying around 500 times the company's earnings. One analyst called the idea of this price <vocab>far-fetched</vocab>, saying he won't invest until the official <vocab>prospectus</vocab> shows much better numbers. But in the tech world, big bets sometimes pay off ‚Äî and <vocab>run rate</vocab> growth of 50% per year makes even wild valuations feel possible.</p>
            `
        },

        {
            type:  "trueFalse",
            title: "‚úÖ 2. True or False?",
            questions: [
                { question: "SpaceX was valued at $1.5 trillion in December 2025.",           answer: false },
                { question: "xAI is the company behind the Grok chatbot.",                    answer: true  },
                { question: "SpaceX is a profitable company.",                                answer: true  },
                { question: "Investors in the IPO can choose to buy SpaceX without xAI.",     answer: false },
                { question: "The SpaceX IPO is planned for July 2026.",                       answer: true  }
            ]
        },

        {
            type:  "multipleChoice",
            title: "üéØ 3. Comprehension Check",
            questions: [
                {
                    question: "What does 'going public' mean for SpaceX?",
                    options: [
                        "SpaceX will publish all of its secret rocket designs",
                        "SpaceX will sell shares to ordinary investors for the first time",
                        "SpaceX will become a government-owned company"
                    ],
                    correct: 1
                },
                {
                    question: "Why might investors be nervous about the $1.5 trillion valuation?",
                    options: [
                        "Because SpaceX has never launched a rocket successfully",
                        "Because the price is 500 times the company's earnings ‚Äî extremely high",
                        "Because Elon Musk plans to retire before the IPO"
                    ],
                    correct: 1
                },
                {
                    question: "What is the order of the mergers?",
                    options: [
                        "SpaceX merged with X, then xAI joined later",
                        "xAI merged with SpaceX, then X joined later",
                        "X and xAI merged first, then the result merged with SpaceX"
                    ],
                    correct: 2
                }
            ]
        },

        {
            type:  "gapFill",
            title: "üß© 4. Fill the Gaps",
            wordBank: ["merger", "prospectus", "valuation", "profitable", "shares", "run rate"],
            sentences: [
                { text: "The SpaceX ___ is set at $1.5 trillion.",                              answer: "valuation"  },
                { text: "Investors who buy ___ will own part of all three companies.",           answer: "shares"     },
                { text: "The ___ of X and xAI happened before SpaceX was involved.",            answer: "merger"     },
                { text: "Unlike xAI, SpaceX is ___ ‚Äî it makes more money than it spends.",      answer: "profitable" },
                { text: "The analyst said he would wait for the official ___ before investing.", answer: "prospectus" },
                { text: "xAI's annual ___ for losses is estimated at $5 billion.",              answer: "run rate"   }
            ]
        },

        {
            type:  "wordForms",
            title: "üî§ 5. Word Forms",
            questions: [
                { prompt: "SpaceX plans to ___ its shares in July. (IPO ‚Üí verb: to go public / to ___)",               answer: "list"    },
                { prompt: "The two companies will ___. (merger ‚Üí verb form)",                                           answer: "merge"   },
                { prompt: "xAI is not making money ‚Äî it is ___. (profit ‚Üí adjective: the opposite of profitable)",    answer: "unprofitable" },
                { prompt: "He made a ___ investment in the company. (value ‚Üí adjective: worth a lot)",                 answer: "valuable" }
            ]
        },

        {
            type:  "grammar",
            title: "üìñ 6. Grammar: Future Forms",

            explanation: {
                heading: "üìå Talking About the Future",
                text: "We use different forms to talk about the future depending on how certain or planned something is.",
                examples: [
                    { label: "‚úÖ will + verb (predictions):",       sentence: "The company <em>will generate</em> $23 billion in 2026." },
                    { label: "‚úÖ be going to (firm plans):",        sentence: "Musk <em>is going to</em> launch the IPO in July." },
                    { label: "‚úÖ Present continuous (arranged):",   sentence: "SpaceX <em>is listing</em> its shares next summer." }
                ]
            },

            questions: [
                {
                    sentence: "Analysts predict the company ___ $23 billion in revenue next year.",
                    hint:     "Prediction about the future ‚Üí will",
                    options:  ["generates", "will generate", "is generating"],
                    answer:   "will generate"
                },
                {
                    sentence: "Musk ___ all three companies under one IPO.",
                    hint:     "Firm, planned intention ‚Üí going to",
                    options:  ["will merge", "is going to merge", "merges"],
                    answer:   "is going to merge"
                },
                {
                    sentence: "The IPO ___ in July 2026 ‚Äî the date is already set.",
                    hint:     "Arranged future event ‚Üí present continuous",
                    options:  ["happens", "will happen", "is happening"],
                    answer:   "is happening"
                },
                {
                    sentence: "If the numbers look bad, many investors ___ participate.",
                    hint:     "Conditional prediction ‚Üí will",
                    options:  ["won't", "aren't going to", "don't"],
                    answer:   "won't"
                }
            ]
        }

    ],

    grammar: [
        { question: 'Future prediction: company + generate + $23bn next year', answer: "will generate",       explanation: "Will for predictions" },
        { question: 'Firm plan: Musk + merge + companies under one IPO',        answer: "is going to merge",  explanation: "Going to for firm plans" },
        { question: 'Arranged event: IPO + happen + July (date is set)',         answer: "is happening",       explanation: "Present continuous for arranged future" },
        { question: 'Negative prediction: investors + not + participate',        answer: "won't",              explanation: "Will not for negative predictions" }
    ],

    badges: [
        { icon: "üöÄ", text: "Launch Ready!"        },
        { icon: "üí∞", text: "Market Genius!"       },
        { icon: "üõ∏", text: "To the Moon!"         },
        { icon: "ü§ñ", text: "AI Expert!"           },
        { icon: "üìà", text: "Bull Market!"         },
        { icon: "‚≠ê", text: "Star Investor!"       }
    ]

};
    </script>

    <style>
        :root {
            --color-primary:    #00D4FF;
            --color-secondary:  #0A0E1A;
            --color-background: #060910;
            --color-accent:     #7B61FF;
            --color-silver:     #A8B8D0;
            --color-glow:       rgba(0, 212, 255, 0.15);
            --color-correct:    #00E676;
            --color-incorrect:  #FF3D71;
            --spacing-mobile:   16px;
            --spacing-desktop:  24px;
            --touch-min:        48px;
            --bottom-nav-height: 70px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--color-background);
            background-image:
                radial-gradient(ellipse at 20% 20%, rgba(0, 212, 255, 0.04) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(123, 97, 255, 0.04) 0%, transparent 50%);
            color: var(--color-silver);
            line-height: 1.7;
            -webkit-font-smoothing: antialiased;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: var(--bottom-nav-height);
        }
        @media (min-width: 768px) { body { padding-bottom: 0; } }

        /* Stars background */
        body::before {
            content: '';
            position: fixed; inset: 0; z-index: 0; pointer-events: none;
            background-image:
                radial-gradient(1px 1px at 10% 15%, rgba(255,255,255,0.6) 0%, transparent 100%),
                radial-gradient(1px 1px at 25% 40%, rgba(255,255,255,0.4) 0%, transparent 100%),
                radial-gradient(1px 1px at 45% 10%, rgba(255,255,255,0.5) 0%, transparent 100%),
                radial-gradient(1px 1px at 60% 70%, rgba(255,255,255,0.3) 0%, transparent 100%),
                radial-gradient(1px 1px at 75% 25%, rgba(255,255,255,0.6) 0%, transparent 100%),
                radial-gradient(1px 1px at 85% 55%, rgba(255,255,255,0.4) 0%, transparent 100%),
                radial-gradient(1px 1px at 92% 85%, rgba(255,255,255,0.5) 0%, transparent 100%),
                radial-gradient(1.5px 1.5px at 35% 80%, rgba(0,212,255,0.4) 0%, transparent 100%),
                radial-gradient(1.5px 1.5px at 70% 45%, rgba(123,97,255,0.3) 0%, transparent 100%);
        }

        /* HEADER */
        .header {
            background: rgba(6, 9, 16, 0.95);
            border-bottom: 1px solid rgba(0, 212, 255, 0.3);
            padding: 12px var(--spacing-mobile);
            position: sticky; top: 0; z-index: 100;
            backdrop-filter: blur(20px);
            box-shadow: 0 4px 30px rgba(0, 212, 255, 0.08);
        }
        @media (min-width: 768px) { .header { padding: 16px var(--spacing-desktop); } }

        .header-content { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; position: relative; z-index: 1; }
        .header-left { display: flex; align-items: center; gap: 12px; }

        .logo {
            width: 38px; height: 38px;
            background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
            border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.4);
        }

        .site-title {
            font-family: 'Courier New', Courier, monospace;
            font-size: 13px; font-weight: 700;
            color: var(--color-primary);
            text-decoration: none;
            letter-spacing: 1px;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
            display: none;
        }
        @media (min-width: 480px) { .site-title { display: inline; } }
        @media (min-width: 768px) { .site-title { font-size: 16px; } }

        .streak-display {
            display: flex; align-items: center; gap: 10px;
            background: rgba(0, 212, 255, 0.06);
            padding: 6px 14px;
            border-radius: 4px;
            border: 1px solid rgba(0, 212, 255, 0.2);
        }
        .streak-item { display: flex; align-items: center; gap: 6px; }
        .streak-icon { font-size: 16px; }
        .streak-number { font-family: 'Courier New', Courier, monospace; font-size: 16px; font-weight: 900; color: var(--color-primary); text-shadow: 0 0 10px rgba(0,212,255,0.6); }
        .streak-label { font-size: 9px; color: rgba(168,184,208,0.6); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; display: none; }
        @media (min-width: 480px) { .streak-label { display: block; } }

        /* MAIN CONTAINER */
        .container-main {
            max-width: 900px; margin: 24px auto;
            padding: 28px var(--spacing-mobile);
            background: rgba(10, 14, 26, 0.9);
            border-radius: 8px;
            border: 1px solid rgba(0, 212, 255, 0.15);
            box-shadow:
                0 0 0 1px rgba(0, 212, 255, 0.05),
                0 20px 60px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(0, 212, 255, 0.1);
            position: relative; z-index: 1;
        }
        @media (min-width: 768px) { .container-main { margin: 36px auto; padding: 40px var(--spacing-desktop); } }

        .lesson-main-title {
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.6em; font-weight: 900;
            color: white;
            margin-bottom: 4px;
            line-height: 1.2;
            text-shadow: 0 0 30px rgba(0, 212, 255, 0.4);
            letter-spacing: 1px;
        }
        @media (min-width: 768px) { .lesson-main-title { font-size: 2.4em; } }

        .lesson-subtitle { font-size: 0.9em; color: var(--color-silver); margin: 8px 0 20px; opacity: 0.8; }

        /* PROGRESS BAR */
        .progress-container {
            background: rgba(255,255,255,0.05);
            height: 4px; border-radius: 99px;
            margin-bottom: 28px; overflow: hidden;
            border: 1px solid rgba(0,212,255,0.1);
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary), var(--color-accent));
            width: 0%; transition: width 0.6s cubic-bezier(0.4,0,0.2,1);
            box-shadow: 0 0 12px rgba(0,212,255,0.8);
        }

        /* SECTIONS */
        .lesson-section {
            background: rgba(255,255,255,0.02);
            padding: 20px;
            border-radius: 6px;
            border: 1px solid rgba(0, 212, 255, 0.08);
            margin-bottom: 20px;
            opacity: 0; transform: translateY(20px); transition: opacity 0.5s, transform 0.5s;
        }
        .lesson-section.visible { opacity: 1; transform: translateY(0); }
        @media (min-width: 768px) { .lesson-section { padding: 28px; margin-bottom: 24px; } }

        .section-title {
            font-family: 'Courier New', Courier, monospace;
            color: var(--color-primary);
            font-size: 1em; font-weight: 700;
            margin-bottom: 16px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 212, 255, 0.2);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            text-shadow: 0 0 15px rgba(0,212,255,0.4);
        }
        @media (min-width: 768px) { .section-title { font-size: 1.1em; } }

        /* READING */
        .fact-box {
            background: rgba(0, 212, 255, 0.04);
            border: 1px solid rgba(0, 212, 255, 0.25);
            border-left: 3px solid var(--color-primary);
            border-radius: 4px;
            padding: 14px 16px;
            margin-bottom: 16px;
        }
        .fact-box h4 {
            color: var(--color-primary); font-family: 'Courier New', Courier, monospace;
            font-size: 0.75em; font-weight: 700;
            text-transform: uppercase; letter-spacing: 2px;
            margin-bottom: 10px;
        }
        .fact-box li { list-style: none; padding: 5px 0 5px 20px; position: relative; color: var(--color-silver); border-bottom: 1px solid rgba(255,255,255,0.04); font-size: 0.9em; }
        .fact-box li:last-child { border-bottom: none; }
        .fact-box li::before { content: '‚ñ∏'; position: absolute; left: 0; color: var(--color-primary); font-size: 0.8em; top: 7px; }

        .reading-text {
            background: rgba(0, 0, 0, 0.3);
            border-left: 3px solid var(--color-primary);
            padding: 16px 20px;
            border-radius: 0 4px 4px 0;
            font-size: 1em;
            color: #CBD5E8;
            line-height: 1.8;
        }
        @media (min-width: 768px) { .reading-text { font-size: 1.05em; } }
        .reading-text .mb-4 { margin-bottom: 1.1rem; }

        .highlight-word {
            color: var(--color-primary);
            font-weight: 600;
            cursor: pointer;
            border-bottom: 1px dashed rgba(0,212,255,0.5);
            display: inline-block;
            padding: 1px 2px;
            transition: all 0.2s;
        }
        .highlight-word:active { background: rgba(0,212,255,0.15); border-radius: 3px; border-bottom-color: transparent; }
        @media (min-width: 768px) { .highlight-word:hover { background: rgba(0,212,255,0.12); border-radius: 3px; border-bottom-color: transparent; } }

        /* QUESTIONS */
        .question-box {
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(0, 212, 255, 0.1);
            border-radius: 6px;
            padding: 14px;
            margin-bottom: 10px;
        }
        .question-text { font-size: 0.95em; font-weight: 600; margin-bottom: 10px; color: #E0EAF8; }

        .option-button {
            display: block; width: 100%; text-align: left;
            padding: 12px 14px; min-height: var(--touch-min); margin-top: 6px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(0, 212, 255, 0.15);
            border-radius: 4px;
            font-weight: 400; cursor: pointer; transition: all 0.2s;
            color: var(--color-silver); font-size: 0.9em;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            -webkit-appearance: none;
        }
        .option-button:active { background: rgba(0,212,255,0.08); }
        @media (min-width: 768px) { .option-button:hover { background: rgba(0,212,255,0.07); border-color: rgba(0,212,255,0.35); } }
        .option-button.selected   { background: rgba(0,212,255,0.1); border-color: rgba(0,212,255,0.5); color: var(--color-primary); }
        .option-button.correct    { background: rgba(0,230,118,0.12) !important; color: #00E676 !important; border-color: #00E676 !important; }
        .option-button.incorrect  { background: rgba(255,61,113,0.12) !important; color: #FF3D71 !important; border-color: #FF3D71 !important; }

        /* GAP FILL */
        .word-bank {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 6px;
            padding: 12px 14px;
            margin-bottom: 16px;
        }
        .word-bank-label { font-family: 'Courier New', Courier, monospace; font-weight: 700; color: var(--color-primary); margin-bottom: 10px; font-size: 0.7em; text-transform: uppercase; letter-spacing: 2px; }
        .word-options { display: flex; flex-wrap: wrap; gap: 8px; }

        .word-option {
            background: rgba(0, 212, 255, 0.1);
            color: var(--color-primary);
            padding: 8px 14px; min-height: 38px;
            display: inline-flex; align-items: center;
            border-radius: 4px; cursor: pointer; transition: 0.2s;
            font-weight: 600; font-size: 0.85em;
            -webkit-appearance: none;
            border: 1px solid rgba(0, 212, 255, 0.3);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        .word-option.selected { background: rgba(0,212,255,0.25); border-color: var(--color-primary); box-shadow: 0 0 12px rgba(0,212,255,0.3); }
        .word-option.used { opacity: 0.2; pointer-events: none; }

        .gap-sentences { font-size: 1em; line-height: 3; color: #CBD5E8; }

        .gap-input {
            display: inline-block; text-align: center;
            padding: 4px 8px; min-width: 110px; min-height: 32px;
            background: rgba(0,0,0,0.4);
            border: 2px dashed rgba(0, 212, 255, 0.4);
            border-radius: 4px;
            font-weight: 600; cursor: pointer; margin: 0 4px;
            font-size: 0.9em; line-height: 24px; transition: all 0.2s;
            color: var(--color-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        .gap-input.correct   { background: rgba(0,230,118,0.1) !important; border-color: #00E676 !important; border-style: solid; pointer-events: none; color: #00E676; }
        .gap-input.incorrect { background: rgba(255,61,113,0.1) !important; border-color: #FF3D71 !important; border-style: solid; color: #FF3D71; }

        /* WORD FORMS */
        .word-form-item { margin-bottom: 16px; }
        .word-form-prompt { font-weight: 600; color: #CBD5E8; margin-bottom: 8px; font-size: 0.95em; }
        .word-form-input {
            width: 100%; padding: 12px 14px; min-height: var(--touch-min);
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(0, 212, 255, 0.2); border-radius: 4px;
            transition: 0.3s; font-size: 0.95em;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            color: var(--color-primary);
        }
        .word-form-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(0,212,255,0.1); }
        .word-form-input::placeholder { color: rgba(168,184,208,0.3); }
        .word-form-input.revealed { background: rgba(0,230,118,0.08) !important; color: #00E676; border-color: #00E676; }

        /* GRAMMAR */
        .grammar-explanation {
            background: rgba(0, 0, 0, 0.4);
            padding: 16px;
            border-radius: 6px;
            border: 1px solid rgba(123, 97, 255, 0.3);
            border-left: 3px solid var(--color-accent);
            margin-bottom: 18px;
        }
        .grammar-explanation h4 { color: var(--color-accent); font-family: 'Courier New', Courier, monospace; font-size: 0.7em; font-weight: 700; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 2px; }
        .grammar-explanation p { color: var(--color-silver); font-size: 0.9em; margin-bottom: 10px; }
        .grammar-example { background: rgba(123,97,255,0.07); padding: 8px 14px; border-left: 2px solid var(--color-accent); border-radius: 0 4px 4px 0; margin: 6px 0; font-size: 0.88em; }
        .grammar-example strong { color: var(--color-accent); }
        .grammar-example span { color: var(--color-silver); }

        .grammar-card {
            background: rgba(0,0,0,0.25);
            border-left: 3px solid var(--color-accent);
            padding: 14px 16px;
            margin-bottom: 10px;
            border-radius: 0 4px 4px 0;
            border: 1px solid rgba(123,97,255,0.15);
            border-left-width: 3px;
        }
        @media (min-width: 768px) { .grammar-card { display: flex; justify-content: space-between; align-items: center; gap: 20px; } }
        .grammar-card-text { margin-bottom: 10px; }
        @media (min-width: 768px) { .grammar-card-text { margin-bottom: 0; flex: 1; } }
        .grammar-card-sentence { font-weight: 600; color: #E0EAF8; font-size: 0.95em; margin-bottom: 4px; }
        .grammar-card-hint { font-size: 0.82em; color: rgba(168,184,208,0.5); font-style: italic; }

        .grammar-select {
            width: 100%; padding: 12px 14px; min-height: var(--touch-min);
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(123, 97, 255, 0.3); border-radius: 4px;
            font-weight: 600; cursor: pointer; font-size: 0.9em;
            -webkit-appearance: none;
            color: var(--color-silver);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        @media (min-width: 768px) { .grammar-select { width: auto; min-width: 200px; } }
        .grammar-select.correct   { background: rgba(0,230,118,0.1); border-color: #00E676; color: #00E676; }
        .grammar-select.incorrect { background: rgba(255,61,113,0.1); border-color: #FF3D71; color: #FF3D71; }

        /* BUTTONS */
        .button-group { margin-top: 18px; display: flex; flex-direction: column; gap: 10px; align-items: center; }
        @media (min-width: 768px) { .button-group { flex-direction: row; justify-content: center; } }

        .btn-continue, .btn-check, .btn-reveal, .btn-reset {
            padding: 13px 22px; min-height: var(--touch-min); border-radius: 4px;
            cursor: pointer; font-weight: 700; transition: all 0.2s; width: 100%; max-width: 360px; font-size: 0.9em;
            -webkit-appearance: none;
            font-family: 'Courier New', Courier, monospace;
            text-transform: uppercase; letter-spacing: 1px;
            border: none;
        }
        @media (min-width: 768px) { .btn-continue, .btn-check, .btn-reveal, .btn-reset { width: auto; max-width: none; padding: 11px 24px; } }

        .btn-continue, .btn-check {
            background: linear-gradient(135deg, var(--color-primary), #0090B8);
            color: #060910;
            box-shadow: 0 4px 20px rgba(0,212,255,0.3);
        }
        .btn-continue:active, .btn-check:active { transform: scale(0.97); box-shadow: 0 2px 10px rgba(0,212,255,0.2); }
        @media (min-width: 768px) { .btn-continue:hover, .btn-check:hover { box-shadow: 0 6px 25px rgba(0,212,255,0.5); } }

        .btn-reveal {
            background: rgba(123,97,255,0.2);
            color: var(--color-accent);
            border: 1px solid rgba(123,97,255,0.4);
        }
        .btn-reset {
            background: rgba(255,255,255,0.04);
            color: rgba(168,184,208,0.6);
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* RESULT MESSAGES */
        .result-message { margin-top: 12px; padding: 12px 16px; border-radius: 4px; font-weight: 600; display: none; font-size: 0.9em; border-left: 3px solid; }
        .result-message.correct   { background: rgba(0,230,118,0.08); color: #00E676; border-color: #00E676; }
        .result-message.incorrect { background: rgba(255,61,113,0.08); color: #FF3D71; border-color: #FF3D71; }

        /* BOTTOM NAV */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(6, 9, 16, 0.98);
            border-top: 1px solid rgba(0, 212, 255, 0.2);
            padding: 10px 16px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            display: flex; align-items: center; gap: 10px;
            z-index: 200;
            backdrop-filter: blur(20px);
        }
        @media (min-width: 768px) { .bottom-nav { display: none; } }
        .bottom-nav-btn {
            flex: 1;
            background: rgba(255,255,255,0.04);
            color: var(--color-silver);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 12px; border-radius: 4px;
            font-weight: 700; font-size: 13px; min-height: var(--touch-min);
            cursor: pointer; transition: all 0.2s;
            font-family: 'Courier New', Courier, monospace;
            -webkit-appearance: none;
        }
        .bottom-nav-btn.primary {
            flex: 2;
            background: linear-gradient(135deg, var(--color-primary), #0090B8);
            color: #060910;
            border-color: transparent;
            box-shadow: 0 0 20px rgba(0,212,255,0.25);
        }
        .bottom-nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .section-indicator { font-size: 11px; font-weight: 700; color: rgba(168,184,208,0.5); white-space: nowrap; font-family: 'Courier New', Courier, monospace; }

        /* DICTIONARY POPUP */
        #dictionary-popup {
            position: fixed; bottom: var(--bottom-nav-height); left: 16px; right: 16px;
            background: rgba(10, 14, 26, 0.98);
            border-top: 2px solid var(--color-primary);
            padding: 20px;
            border-radius: 8px 8px 0 0;
            z-index: 2000; display: none;
            box-shadow: 0 -20px 60px rgba(0, 212, 255, 0.15);
            animation: slideUp 0.3s;
            max-height: 50vh; overflow-y: auto;
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(0,212,255,0.2);
            border-right: 1px solid rgba(0,212,255,0.2);
        }
        @media (min-width: 768px) {
            #dictionary-popup { position: fixed; bottom: auto; left: auto; right: auto; max-width: 320px; border-radius: 6px; }
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .popup-close {
            position: absolute; top: 12px; right: 12px;
            width: 30px; height: 30px; border-radius: 4px;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            font-size: 16px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            color: var(--color-silver);
        }

        /* BADGES */
        .badge-container { position: fixed; top: 80px; right: 10px; display: flex; flex-direction: column; gap: 8px; z-index: 999; }
        @media (min-width: 768px) { .badge-container { top: 100px; right: 20px; } }
        .badge {
            background: rgba(10, 14, 26, 0.96);
            padding: 10px 14px; border-radius: 6px;
            border: 1px solid rgba(0, 212, 255, 0.3);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.15);
            display: flex; align-items: center; gap: 8px;
            transform: translateX(300px); opacity: 0; transition: all 0.5s;
        }
        .badge.show { transform: translateX(0); opacity: 1; }
        .badge-icon { font-size: 20px; }
        .badge-text { font-family: 'Courier New', Courier, monospace; font-weight: 700; color: var(--color-primary); font-size: 11px; text-transform: uppercase; letter-spacing: 1px; }

        /* CELEBRATION */
        .celebration {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%,-50%) scale(0);
            background: linear-gradient(135deg, #0A0E1A, #0D1525);
            border: 2px solid var(--color-primary);
            color: var(--color-primary); padding: 28px 40px;
            border-radius: 8px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.3em; font-weight: 900;
            box-shadow: 0 0 60px rgba(0,212,255,0.4), 0 20px 60px rgba(0,0,0,0.5);
            z-index: 1000; opacity: 0; transition: all 0.4s;
            text-align: center; letter-spacing: 2px;
        }
        .celebration.show { opacity: 1; transform: translate(-50%,-50%) scale(1); }
    </style>
</head>
<body>

    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <a href="#" id="logo-link" style="text-decoration:none;">
                    <span class="logo" id="logo-emoji">üòé</span>
                </a>
                <a href="/business/" class="site-title">English For Cool Dudes</a>
            </div>
            <div class="streak-display">
                <div class="streak-item">
                    <span class="streak-icon">üî•</span>
                    <div>
                        <div class="streak-number" id="streak-count">0</div>
                        <div class="streak-label">Streak</div>
                    </div>
                </div>
                <div class="streak-item">
                    <span class="streak-icon">üéØ</span>
                    <div>
                        <div class="streak-number" id="total-lessons">0</div>
                        <div class="streak-label">Lessons</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="badge-container" id="badge-container"></div>
    <div class="celebration" id="celebration"></div>

    <div class="container-main">
        <h1 class="lesson-main-title" id="lesson-title">Loading...</h1>
        <p class="lesson-subtitle" id="lesson-subtitle"></p>
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div id="daily-challenge-widget"></div>
        <div id="lesson-sections"></div>
    </div>

    <nav class="bottom-nav">
        <button class="bottom-nav-btn" onclick="previousSection()" id="btn-prev" disabled>‚Üê Back</button>
        <span class="section-indicator" id="section-indicator">1/1</span>
        <button class="bottom-nav-btn primary" onclick="nextSection()" id="btn-next">Next ‚Üí</button>
    </nav>

    <div id="dictionary-popup">
        <button class="popup-close" onclick="closePopup()">√ó</button>
        <div id="popup-content"></div>
    </div>

    <script src="/supabase-auth-gamified.js"></script>
    <script src="/daily-challenges-system.js"></script>
    <script src="/word-match-game.js"></script>

    <script>
let currentSection    = 1;
let completedSections = 0;
let selectedGapWord   = null;

(function buildLesson() {
    if (LESSON_CONFIG.colors) {
        const r = document.documentElement;
        if (LESSON_CONFIG.colors.primary)    r.style.setProperty('--color-primary',    LESSON_CONFIG.colors.primary);
        if (LESSON_CONFIG.colors.secondary)  r.style.setProperty('--color-secondary',  LESSON_CONFIG.colors.secondary);
        if (LESSON_CONFIG.colors.background) {
            r.style.setProperty('--color-background', LESSON_CONFIG.colors.background);
            document.body.style.background = LESSON_CONFIG.colors.background;
        }
    }
    document.getElementById('page-title').textContent     = LESSON_CONFIG.title + ' - English For Cool Dudes';
    document.getElementById('lesson-title').textContent   = LESSON_CONFIG.title;
    document.getElementById('lesson-subtitle').textContent = LESSON_CONFIG.level + ' | ' + LESSON_CONFIG.subtitle;
    document.getElementById('logo-emoji').textContent     = LESSON_CONFIG.logoEmoji;
    document.getElementById('logo-link').href             = LESSON_CONFIG.levelPage;

    const container = document.getElementById('lesson-sections');
    let html = '', num = 0;

    LESSON_CONFIG.sections.forEach((sec, i) => {
        num++;
        const vis = i === 0 ? ' visible' : '';
        const attr = `class="lesson-section${vis}" data-section="${num}"`;

        if (sec.type === 'video') {
            const discussHTML = sec.discussion && sec.discussion.length
                ? `<div class="discussion-box"><h3>üí¨ Discussion Questions</h3><ul>${sec.discussion.map(q=>`<li>${q}</li>`).join('')}</ul></div>` : '';
            html += `<section ${attr}><h2 class="section-title">${sec.title}</h2>
                ${sec.intro ? `<p class="video-intro">${sec.intro}</p>` : ''}
                <div class="video-wrapper"><div class="video-container">
                    <iframe src="${sec.youtubeUrl}" title="Video" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div></div>${discussHTML}
                <div class="button-group"><button class="btn-continue" onclick="completeSection(${num})">Continue ‚Üí</button></div></section>`;
        }

        else if (sec.type === 'reading') {
            const content = sec.content.replace(/<vocab>(.*?)<\/vocab>/gi, (m, w) =>
                `<span class="highlight-word" onclick="showPopup(this,'${w}')">${w}</span>`);
            const factsHTML = sec.facts && sec.facts.length
                ? `<div class="fact-box"><h4>‚ñ∏ Mission Briefing</h4><ul>${sec.facts.map(f=>`<li>${f}</li>`).join('')}</ul></div>` : '';
            html += `<section ${attr}><h2 class="section-title">${sec.title}</h2>
                ${factsHTML}<div class="reading-text">${content}</div>
                <div class="button-group"><button class="btn-continue" onclick="completeSection(${num})">Continue ‚Üí</button></div></section>`;
        }

        else if (sec.type === 'trueFalse') {
            const qHTML = sec.questions.map((q, qi) => `
                <div class="question-box"><p class="question-text">${qi+1}. ${q.question}</p>
                <div class="comp-btn-group">
                    <button class="option-button" data-correct="${q.answer === true}">True</button>
                    <button class="option-button" data-correct="${q.answer === false}">False</button>
                </div></div>`).join('');
            html += `<section ${attr}><h2 class="section-title">${sec.title}</h2>${qHTML}
                <div class="button-group">
                    <button class="btn-check" onclick="checkTrueFalse(${num})">Check Answers</button>
                    <button class="btn-reset" onclick="resetTrueFalse(${num})">Reset</button>
                </div><div id="result-${num}" class="result-message"></div></section>`;
        }

        else if (sec.type === 'multipleChoice') {
            const qHTML = sec.questions.map((q, qi) => {
                const opts = q.options.map((o, oi) =>
                    `<button class="option-button" data-correct="${oi === q.correct}">${o}</button>`).join('');
                return `<div class="question-box"><p class="question-text">${qi+1}. ${q.question}</p><div class="comp-btn-group">${opts}</div></div>`;
            }).join('');
            html += `<section ${attr}><h2 class="section-title">${sec.title}</h2>${qHTML}
                <div class="button-group">
                    <button class="btn-check" onclick="checkMultiChoice(${num})">Check Answers</button>
                    <button class="btn-reset" onclick="resetMultiChoice(${num})">Reset</button>
                </div><div id="result-${num}" class="result-message"></div></section>`;
        }

        else if (sec.type === 'gapFill') {
            const bankHTML = sec.wordBank.map(w => `<button class="word-option" data-word="${w}">${w}</button>`).join('');
            const sentHTML = sec.sentences.map((s, si) => {
                const parts = s.text.split('___');
                return `<p class="mb-4">${si+1}. ${parts[0]}<span class="gap-input" data-answer="${s.answer}"></span>${parts[1]||''}</p>`;
            }).join('');
            html += `<section ${attr}><h2 class="section-title">${sec.title}</h2>
                <p style="color:rgba(168,184,208,0.5);margin-bottom:12px;font-size:0.88em;">Select a word, then tap a gap to fill it.</p>
                <div class="word-bank"><p class="word-bank-label">Word Bank</p><div class="word-options">${bankHTML}</div></div>
                <div class="gap-sentences">${sentHTML}</div>
                <div class="button-group">
                    <button class="btn-check" onclick="checkGapFill(${num})">Check Answers</button>
                    <button class="btn-reset" onclick="resetGapFill(${num})">Reset</button>
                </div><div id="result-${num}" class="result-message"></div></section>`;
        }

        else if (sec.type === 'wordForms') {
            const items = sec.questions.map((q, qi) => `
                <div class="word-form-item">
                    <p class="word-form-prompt">${qi+1}. ${q.prompt}</p>
                    <input type="text" class="word-form-input" data-answer="${q.answer}" placeholder="Type your answer here...">
                </div>`).join('');
            html += `<section ${attr}><h2 class="section-title">${sec.title}</h2>${items}
                <div class="button-group">
                    <button class="btn-check"  onclick="checkWordForms(${num})">Check Answers</button>
                    <button class="btn-reveal" onclick="revealWordForms(${num})">Reveal Answers</button>
                    <button class="btn-reset"  onclick="resetWordForms(${num})">Reset</button>
                </div><div id="result-${num}" class="result-message"></div></section>`;
        }

        else if (sec.type === 'grammar') {
            let explHTML = '';
            if (sec.explanation) {
                const ex = sec.explanation;
                const examplesHTML = (ex.examples||[]).map(e =>
                    `<div class="grammar-example"><strong>${e.label}</strong> <span>${e.sentence}</span></div>`).join('');
                explHTML = `<div class="grammar-explanation"><h4>${ex.heading}</h4><p>${ex.text}</p>${examplesHTML}</div>`;
            }
            const cards = sec.questions.map((q, qi) => {
                const opts = q.options.map(o => `<option value="${o}">${o}</option>`).join('');
                return `<div class="grammar-card">
                    <div class="grammar-card-text">
                        <p class="grammar-card-sentence">${qi+1}. ${q.sentence}</p>
                        <p class="grammar-card-hint">${q.hint}</p>
                    </div>
                    <select class="grammar-select" data-answer="${q.answer}"><option value="">Choose...</option>${opts}</select>
                </div>`;
            }).join('');
            html += `<section ${attr}><h2 class="section-title">${sec.title}</h2>${explHTML}${cards}
                <div class="button-group">
                    <button class="btn-check" onclick="checkGrammar(${num})">Check Grammar</button>
                    <button class="btn-reset" onclick="resetGrammar(${num})">Reset</button>
                </div><div id="result-${num}" class="result-message"></div></section>`;
        }
    });

    container.innerHTML = html;
    window.totalSections = LESSON_CONFIG.sections.length;
    updateNav(); updateProgress();
    setTimeout(wireEvents, 50);
})();

async function initStats() {
    if (typeof window.efcdReady !== 'undefined') await window.efcdReady;
    if (typeof window.EFCD_Auth === 'undefined') return;
    await window.EFCD_Auth.initAuth();
    const user = window.EFCD_Auth.getCurrentUser();
    if (user) {
        const s = window.EFCD_Auth.getUserStats();
        document.getElementById('streak-count').textContent  = s.streak;
        document.getElementById('total-lessons').textContent = s.lessonsCompleted;
    }
}
if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initStats);
else initStats();

if (window.DailyChallenges) {
    document.getElementById('daily-challenge-widget').innerHTML = window.DailyChallenges.renderDailyChallengeWidget();
}

function nextSection() {
    if (currentSection < window.totalSections) { currentSection++; showSection(currentSection); }
    else completeLessonAndSave();
}
function previousSection() { if (currentSection > 1) { currentSection--; showSection(currentSection); } }
function showSection(num) {
    const sec = document.querySelector(`.lesson-section[data-section="${num}"]`);
    if (sec) { sec.classList.add('visible'); sec.scrollIntoView({ behavior:'smooth', block:'start' }); }
    updateNav();
}
function updateNav() {
    document.getElementById('btn-prev').disabled = (currentSection === 1);
    document.getElementById('btn-next').textContent = currentSection === window.totalSections ? 'Finish ‚úì' : 'Next ‚Üí';
    document.getElementById('section-indicator').textContent = currentSection + '/' + window.totalSections;
}
function updateProgress() {
    const pct = ((completedSections) / (window.totalSections || 1)) * 100;
    document.getElementById('progress-bar').style.width = pct + '%';
}
function completeSection(sectionNum) {
    completedSections = Math.max(completedSections, sectionNum);
    updateProgress();
    if (sectionNum >= window.totalSections) { completeLessonAndSave(); return; }
    const next = document.querySelector(`.lesson-section[data-section="${sectionNum + 1}"]`);
    if (next) { next.classList.add('visible'); next.scrollIntoView({ behavior:'smooth', block:'center' }); }
    if (Math.random() < 0.3) showBadge(getRandomBadge());
    currentSection = sectionNum + 1; updateNav();
}
function showResult(num, correct, total, goodMsg, badMsg) {
    const el = document.getElementById('result-' + num);
    if (!el) return;
    const perfect = correct === total;
    el.style.display = 'block';
    el.className = 'result-message ' + (perfect ? 'correct' : 'incorrect');
    el.textContent = perfect ? goodMsg : correct + '/' + total + ' correct. ' + badMsg;
    if (perfect) { celebrate('üöÄ PERFECT!'); showBadge(getRandomBadge()); setTimeout(() => completeSection(num), 1600); }
}
function hideResult(num) { const el = document.getElementById('result-' + num); if (el) { el.style.display = 'none'; el.className = 'result-message'; } }
function checkTrueFalse(num) {
    const sec = document.querySelector(`.lesson-section[data-section="${num}"]`);
    const groups = sec.querySelectorAll('.comp-btn-group');
    let correct = 0, unanswered = 0;
    groups.forEach(g => {
        const sel = g.querySelector('.option-button.selected');
        if (!sel) { unanswered++; return; }
        g.querySelectorAll('.option-button').forEach(b => b.classList.remove('correct','incorrect'));
        if (sel.dataset.correct === 'true') { sel.classList.add('correct'); correct++; } else sel.classList.add('incorrect');
    });
    if (unanswered > 0) { const res=document.getElementById('result-'+num); res.style.display='block'; res.className='result-message incorrect'; res.textContent='Please answer all questions first!'; return; }
    showResult(num, correct, groups.length, 'üéâ All correct!', 'Wrong answers highlighted ‚Äî try again!');
}
function resetTrueFalse(num) { const sec=document.querySelector(`.lesson-section[data-section="${num}"]`); sec.querySelectorAll('.option-button').forEach(b=>b.classList.remove('selected','correct','incorrect')); hideResult(num); }
function checkMultiChoice(num) {
    const sec = document.querySelector(`.lesson-section[data-section="${num}"]`);
    const groups = sec.querySelectorAll('.comp-btn-group');
    let correct = 0, unanswered = 0;
    groups.forEach(g => {
        const sel = g.querySelector('.option-button.selected');
        if (!sel) { unanswered++; return; }
        g.querySelectorAll('.option-button').forEach(b => b.classList.remove('correct','incorrect'));
        if (sel.dataset.correct === 'true') { sel.classList.add('correct'); correct++; } else sel.classList.add('incorrect');
    });
    if (unanswered > 0) { const res=document.getElementById('result-'+num); res.style.display='block'; res.className='result-message incorrect'; res.textContent='Please answer all questions first!'; return; }
    showResult(num, correct, groups.length, 'üíØ Perfect!', 'Wrong answers highlighted ‚Äî try again!');
}
function resetMultiChoice(num) { const sec=document.querySelector(`.lesson-section[data-section="${num}"]`); sec.querySelectorAll('.option-button').forEach(b=>b.classList.remove('selected','correct','incorrect')); hideResult(num); }
function handleGapClick(blank) {
    if (blank.classList.contains('correct')) return;
    if (blank.textContent.trim()) {
        const sec=blank.closest('.lesson-section');
        const opt=Array.from(sec.querySelectorAll('.word-option')).find(o=>o.dataset.word===blank.textContent.trim());
        if (opt) opt.classList.remove('used');
        blank.textContent=''; blank.classList.remove('incorrect');
    } else if (selectedGapWord) {
        blank.textContent=selectedGapWord.dataset.word;
        selectedGapWord.classList.add('used'); selectedGapWord.classList.remove('selected');
        selectedGapWord=null;
    }
}
function checkGapFill(num) {
    const sec=document.querySelector(`.lesson-section[data-section="${num}"]`);
    const blanks=sec.querySelectorAll('.gap-input'); let correct=0;
    blanks.forEach(b=>{b.classList.remove('correct','incorrect');if((b.textContent||'').trim().toLowerCase()===b.dataset.answer.toLowerCase()){b.classList.add('correct');correct++;}else if(b.textContent.trim())b.classList.add('incorrect');});
    showResult(num,correct,blanks.length,'‚ú® All gaps correct!','Click a red gap to remove it and try again.');
}
function resetGapFill(num) { const sec=document.querySelector(`.lesson-section[data-section="${num}"]`); sec.querySelectorAll('.gap-input').forEach(b=>{b.textContent='';b.classList.remove('correct','incorrect');}); sec.querySelectorAll('.word-option').forEach(o=>o.classList.remove('used','selected')); selectedGapWord=null; hideResult(num); }
function checkWordForms(num) {
    const sec=document.querySelector(`.lesson-section[data-section="${num}"]`);
    const inputs=sec.querySelectorAll('.word-form-input'); let correct=0;
    inputs.forEach(inp=>{inp.style.background='';inp.style.borderColor='';if(inp.value.trim().toLowerCase()===inp.dataset.answer.toLowerCase()){inp.style.background='rgba(0,230,118,0.1)';inp.style.borderColor='#00E676';correct++;}else if(inp.value.trim()){inp.style.background='rgba(255,61,113,0.1)';inp.style.borderColor='#FF3D71';}});
    showResult(num,correct,inputs.length,'üéØ Word Forms Champion!','Red boxes are wrong ‚Äî check your spelling!');
}
function revealWordForms(num) { const sec=document.querySelector(`.lesson-section[data-section="${num}"]`); sec.querySelectorAll('.word-form-input').forEach(inp=>{inp.value=inp.dataset.answer;inp.classList.add('revealed');inp.style.background='';inp.style.borderColor='';}); hideResult(num); }
function resetWordForms(num) { const sec=document.querySelector(`.lesson-section[data-section="${num}"]`); sec.querySelectorAll('.word-form-input').forEach(inp=>{inp.value='';inp.style.background='';inp.style.borderColor='';inp.classList.remove('revealed');}); hideResult(num); }
function checkGrammar(num) {
    const sec=document.querySelector(`.lesson-section[data-section="${num}"]`);
    const selects=sec.querySelectorAll('.grammar-select'); let correct=0;
    selects.forEach(sel=>{sel.classList.remove('correct','incorrect');if(!sel.value)return;if(sel.value===sel.dataset.answer){sel.classList.add('correct');correct++;}else sel.classList.add('incorrect');});
    showResult(num,correct,selects.length,'üì° Grammar Ace!','Red dropdowns are wrong ‚Äî try again!');
}
function resetGrammar(num) { const sec=document.querySelector(`.lesson-section[data-section="${num}"]`); sec.querySelectorAll('.grammar-select').forEach(sel=>{sel.value='';sel.classList.remove('correct','incorrect');}); hideResult(num); }
function celebrate(msg) {
    const el=document.getElementById('celebration');
    el.textContent=msg||'üöÄ PERFECT!'; el.classList.add('show');
    setTimeout(()=>el.classList.remove('show'),2000);
}
function getRandomBadge() { const list=(LESSON_CONFIG.badges&&LESSON_CONFIG.badges.length)?LESSON_CONFIG.badges:[{icon:'‚≠ê',text:'GREAT!'}]; return list[Math.floor(Math.random()*list.length)]; }
function showBadge(badge) {
    const el=document.createElement('div'); el.className='badge';
    el.innerHTML=`<span class="badge-icon">${badge.icon}</span><span class="badge-text">${badge.text}</span>`;
    document.getElementById('badge-container').appendChild(el);
    setTimeout(()=>el.classList.add('show'),100);
    setTimeout(()=>{el.classList.remove('show');setTimeout(()=>el.remove(),500);},3000);
}
function showPopup(target, word) {
    const w=LESSON_CONFIG.vocabulary.find(v=>v.word.toLowerCase()===word.toLowerCase());
    if(!w)return;
    const popup=document.getElementById('dictionary-popup');
    const content=document.getElementById('popup-content');
    content.innerHTML=`
        <div style="margin-bottom:12px;">
            <strong style="color:var(--color-primary);font-family:'Courier New',Courier,monospace;font-size:1.1em;text-shadow:0 0 15px rgba(0,212,255,0.5);">${w.word}</strong>
            <span style="font-size:0.8em;color:rgba(168,184,208,0.5);margin-left:8px;">(${w.type||''})</span>
        </div>
        <p style="color:var(--color-silver);line-height:1.7;margin-bottom:16px;font-size:0.95em;">${w.definition}</p>
        <button onclick="playAudio('${w.word}')"
            style="width:100%;background:linear-gradient(135deg,var(--color-primary),#0090B8);color:#060910;border:none;padding:12px;border-radius:4px;font-weight:700;font-size:0.9em;cursor:pointer;font-family:'Courier New',Courier,monospace;text-transform:uppercase;letter-spacing:1px;">
            üîä HEAR IT
        </button>`;
    popup.style.display='block';
    if(window.innerWidth>=768){const rect=target.getBoundingClientRect();popup.style.top=(rect.bottom+8)+'px';popup.style.left=rect.left+'px';setTimeout(()=>{const pr=popup.getBoundingClientRect();if(pr.right>window.innerWidth-10)popup.style.left=(window.innerWidth-pr.width-10)+'px';},10);}
}
function closePopup() { document.getElementById('dictionary-popup').style.display='none'; }
function playAudio(word) { const u=new SpeechSynthesisUtterance(word);u.lang='en-GB';u.rate=0.9;window.speechSynthesis.cancel();window.speechSynthesis.speak(u); }
function wireEvents() {
    document.querySelectorAll('.comp-btn-group').forEach(group=>{
        group.addEventListener('click',e=>{const btn=e.target.closest('.option-button');if(!btn)return;if(group.querySelector('.option-button.correct'))return;group.querySelectorAll('.option-button').forEach(b=>b.classList.remove('selected','incorrect'));btn.classList.add('selected');});
    });
    document.querySelectorAll('.word-option').forEach(opt=>{
        opt.addEventListener('click',()=>{if(opt.classList.contains('used'))return;if(opt.classList.contains('selected')){opt.classList.remove('selected');selectedGapWord=null;}else{document.querySelectorAll('.word-option').forEach(o=>o.classList.remove('selected'));opt.classList.add('selected');selectedGapWord=opt;}});
    });
    document.querySelectorAll('.gap-input').forEach(b=>b.addEventListener('click',()=>handleGapClick(b)));
    document.addEventListener('click',e=>{if(!e.target.closest('#dictionary-popup')&&!e.target.classList.contains('highlight-word'))closePopup();});
}
async function completeLessonAndSave() {
    completedSections=window.totalSections; updateProgress();
    if(typeof window.EFCD_Auth==='undefined'||!window.EFCD_Auth.getCurrentUser()){
        const signup=confirm('üöÄ Lesson Complete!\n\n‚ú® Sign up free to:\n‚Ä¢ Save your progress & earn XP\n‚Ä¢ Unlock achievements\n‚Ä¢ Track your streak\n\nOK to sign up | Cancel to continue without saving');
        if(signup){window.location.href='/signup/';}
        else if(typeof showWordMatchGame==='function'){showWordMatchGame(LESSON_CONFIG.vocabulary,()=>{window.location.href=LESSON_CONFIG.levelPage;});}
        else{window.location.href=LESSON_CONFIG.levelPage;}
        return;
    }
    const result=await window.EFCD_Auth.completeLesson({lessonId:LESSON_CONFIG.lessonId,lessonTitle:LESSON_CONFIG.title,lessonLevel:LESSON_CONFIG.level,lessonLink:LESSON_CONFIG.lessonLink,vocabulary:LESSON_CONFIG.vocabulary,grammar:LESSON_CONFIG.grammar||[],perfectScore:true,completionTime:Math.floor((Date.now()-performance.timing.navigationStart)/1000)});
    if(window.DailyChallenges&&result.success){const cr=await window.DailyChallenges.updateChallengeProgress({perfectScore:true,vocabCount:LESSON_CONFIG.vocabulary.length,completionTime:Math.floor((Date.now()-performance.timing.navigationStart)/1000),grammarPerfect:true});if(cr.justCompleted){window.DailyChallenges.showChallengeCompletionCelebration(cr.challenge);setTimeout(()=>{if(typeof showWordMatchGame==='function')showWordMatchGame(LESSON_CONFIG.vocabulary,gr=>showCelebrationScreen(result,gr));},2500);return;}}
    if(result.success){if(typeof showWordMatchGame==='function')showWordMatchGame(LESSON_CONFIG.vocabulary,gr=>showCelebrationScreen(result,gr));else showCelebrationScreen(result,null);}
}
function showCelebrationScreen(result,gameResult){
    const totalXP=result.xpEarned+((gameResult&&gameResult.bonusXP)||0);
    const overlay=document.createElement('div');
    overlay.style.cssText='position:fixed;inset:0;background:rgba(6,9,16,0.97);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;animation:fadeIn 0.3s;';
    let h=`<div style="background:rgba(10,14,26,0.98);padding:36px 28px;border-radius:8px;text-align:center;max-width:480px;width:100%;animation:scaleIn 0.4s;position:relative;border:1px solid rgba(0,212,255,0.3);box-shadow:0 0 60px rgba(0,212,255,0.15);">
        <button id="close-cel" style="position:absolute;top:14px;right:14px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:4px;width:32px;height:32px;cursor:pointer;font-size:16px;color:var(--color-silver);">√ó</button>
        <div style="font-size:64px;margin-bottom:14px;">üöÄ</div>
        <h2 style="font-size:22px;margin-bottom:14px;color:white;font-family:'Courier New',Courier,monospace;font-weight:900;letter-spacing:2px;text-shadow:0 0 20px rgba(0,212,255,0.4);">MISSION COMPLETE</h2>
        <div style="background:rgba(0,212,255,0.06);padding:20px;border-radius:6px;margin-bottom:20px;border:1px solid rgba(0,212,255,0.2);">
            <div style="font-size:44px;font-weight:900;color:var(--color-primary);font-family:'Courier New',Courier,monospace;text-shadow:0 0 20px rgba(0,212,255,0.5);">+${totalXP} XP</div>
            ${gameResult&&gameResult.bonusXP?`<div style="font-size:12px;color:var(--color-silver);margin-top:6px;">üéÆ Includes +${gameResult.bonusXP} XP game bonus!</div>`:''}
            ${result.leveledUp?`<div style="font-size:18px;color:var(--color-primary);margin-top:10px;font-family:'Courier New',Courier,monospace;">üéä LEVEL UP! LEVEL ${result.newLevel}</div>`:''}
            ${result.newStreak>0?`<div style="font-size:16px;margin-top:10px;color:var(--color-silver);">üî• ${result.newStreak} day streak!</div>`:''}
        </div>`;
    if(result.newAchievements&&result.newAchievements.length){h+=`<div style="background:rgba(123,97,255,0.08);padding:16px;border-radius:6px;margin-bottom:20px;border:1px solid rgba(123,97,255,0.2);"><div style="font-family:'Courier New',Courier,monospace;font-weight:900;font-size:13px;margin-bottom:10px;color:var(--color-accent);letter-spacing:1px;">üèÜ NEW ACHIEVEMENTS</div>${result.newAchievements.map(id=>{const a=window.EFCD_Auth.ACHIEVEMENTS[id];return`<div style="background:rgba(0,0,0,0.3);padding:10px;border-radius:4px;margin:6px 0;border-left:3px solid var(--color-accent);"><span style="font-size:24px;">${a.icon}</span> <span style="color:var(--color-silver);">${a.name}</span></div>`;}).join('')}</div>`;}
    h+=`<div style="display:flex;flex-direction:column;gap:10px;">
        <a href="/dashboard-gamified/" style="background:rgba(255,255,255,0.05);color:var(--color-silver);padding:12px;border-radius:4px;text-decoration:none;font-weight:700;font-family:'Courier New',Courier,monospace;font-size:12px;text-transform:uppercase;letter-spacing:1px;border:1px solid rgba(255,255,255,0.1);">View Dashboard</a>
        <a href="${LESSON_CONFIG.levelPage}" style="background:linear-gradient(135deg,var(--color-primary),#0090B8);color:#060910;padding:12px;border-radius:4px;text-decoration:none;font-weight:700;font-family:'Courier New',Courier,monospace;font-size:12px;text-transform:uppercase;letter-spacing:1px;">Next Mission ‚Üí</a>
        <button id="btn-retry" style="background:transparent;color:rgba(168,184,208,0.5);padding:12px;border-radius:4px;border:1px solid rgba(255,255,255,0.08);font-weight:700;cursor:pointer;font-family:'Courier New',Courier,monospace;font-size:11px;text-transform:uppercase;letter-spacing:1px;">Retry</button>
    </div></div>`;
    overlay.innerHTML=h;document.body.appendChild(overlay);
    setTimeout(()=>{document.getElementById('close-cel')?.addEventListener('click',()=>overlay.remove());document.getElementById('btn-retry')?.addEventListener('click',()=>location.reload());document.addEventListener('keydown',function esc(e){if(e.key==='Escape'){overlay.remove();document.removeEventListener('keydown',esc);}});},100);
}
const s=document.createElement('style');
s.textContent='@keyframes fadeIn{from{opacity:0}to{opacity:1}}@keyframes scaleIn{from{transform:scale(0.8);opacity:0}to{transform:scale(1);opacity:1}}';
document.head.appendChild(s);
    </script>
</body>
</html>
