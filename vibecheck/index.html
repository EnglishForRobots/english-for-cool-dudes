<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibe Check - English For Cool Dudes</title>
    <link rel="icon" href="data:,">
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* --- APP STYLING --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #F3F4F6;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            overflow: hidden;
        }

        .phone-mockup {
            width: 100%;
            max-width: 400px;
            height: 100%;
            max-height: 850px;
            background: #FFFFFF;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            overflow: hidden;
        }

        @media (min-width: 640px) {
            .phone-mockup {
                height: 90vh;
                border-radius: 30px;
                border: 8px solid #1F2937;
            }
        }

        /* --- ANIMATIONS --- */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        
        .shake-screen {
            animation: shake 0.5s;
            animation-iteration-count: 1;
        }

        /* Header */
        .chat-header {
            background: #F9FAFB;
            padding: 15px;
            border-bottom: 1px solid #E5E7EB;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 10;
        }
        
        .avatar {
            width: 45px; height: 45px;
            background: #E5E7EB;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px;
            border: 2px solid #E5E7EB;
        }

        .status-dot {
            width: 10px; height: 10px; background: #10B981;
            border-radius: 50%; display: inline-block; margin-right: 5px;
        }

        /* Vibe Meter */
        .vibe-container {
            width: 80px; height: 10px; background: #E5E7EB; border-radius: 5px; overflow: hidden;
        }
        .vibe-fill {
            height: 100%; background: #10B981; width: 50%; transition: width 0.5s, background-color 0.5s;
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            background: #E5E5F7; 
            background-image: radial-gradient(#444cf7 0.5px, transparent 0.5px), radial-gradient(#444cf7 0.5px, #e5e5f7 0.5px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            scroll-behavior: smooth;
        }

        /* Bubbles */
        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 15px;
            line-height: 1.4;
            position: relative;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .msg-npc {
            align-self: flex-start;
            background: #FFFFFF;
            color: #1F2937;
            border-bottom-left-radius: 4px;
        }
        
        .msg-user {
            align-self: flex-end;
            background: #3B82F6;
            color: white;
            border-bottom-right-radius: 4px;
        }

        /* COACH MESSAGE */
        .msg-coach {
            align-self: center;
            background: rgba(255, 255, 255, 0.85);
            border: 1px dashed #9CA3AF;
            color: #4B5563;
            font-size: 13px;
            font-weight: 600;
            padding: 8px 14px;
            border-radius: 15px;
            margin-top: -5px;
            margin-bottom: 5px;
            animation: fadeIn 0.5s;
            text-align: center;
        }

        .typing-indicator {
            align-self: flex-start;
            background: white;
            padding: 10px 15px;
            border-radius: 20px;
            display: none;
            gap: 5px;
            width: fit-content;
        }
        .dot { width: 6px; height: 6px; background: #9CA3AF; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        @keyframes popIn { from { opacity: 0; transform: translateY(10px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Input Area */
        .input-area {
            background: #FFFFFF;
            padding: 15px;
            border-top: 1px solid #E5E7EB;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* Choice Buttons */
        .choices-container {
            display: flex; flex-direction: column; gap: 8px;
        }
        .choice-btn {
            background: #F3F4F6;
            border: 1px solid #E5E7EB;
            padding: 12px;
            border-radius: 12px;
            text-align: left;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            color: #374151;
            font-weight: 500;
        }
        .choice-btn:hover { background: #DBEAFE; border-color: #3B82F6; color: #1D4ED8; }

        /* Writing Input */
        .writing-container {
            display: none; width: 100%; gap: 10px;
        }
        .text-input {
            flex: 1; padding: 12px; border-radius: 25px; border: 1px solid #D1D5DB; outline: none; font-size: 15px;
        }
        .text-input:focus { border-color: #3B82F6; }
        .send-btn {
            width: 45px; height: 45px; border-radius: 50%; background: #3B82F6; color: white;
            border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 18px;
        }
        .send-btn:hover { background: #2563EB; }

        /* Overlays */
        #game-over-overlay, #menu-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.85);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 50; text-align: center; color: white; padding: 30px;
        }
        
        #menu-overlay { display: flex; background: #111827; }

        .menu-btn {
            background: white; color: #111827; width: 100%; padding: 15px;
            margin-bottom: 15px; border-radius: 12px; font-weight: 700;
            cursor: pointer; transition: transform 0.2s; border: none; font-size: 16px;
        }
        .menu-btn:hover { transform: scale(1.02); background: #F3F4F6; }

        /* Difficulty Toggle */
        .diff-selector {
            background: #374151; padding: 5px; border-radius: 10px; display: flex; gap: 5px; margin-bottom: 30px;
        }
        .diff-opt {
            padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; color: #9CA3AF;
        }
        .diff-opt.active {
            background: #3B82F6; color: white;
        }

    </style>
</head>
<body>

    <div class="phone-mockup" id="app-container">
        
        <div class="chat-header">
            <div style="display: flex; align-items: center; gap: 10px;">
                <button onclick="showMenu()" style="font-size: 20px; cursor: pointer; background:none; border:none;">‚¨ÖÔ∏è</button>
                <div class="avatar" id="npc-avatar">üëî</div>
                <div>
                    <div style="font-weight: 700; font-size: 15px;" id="npc-name">The Boss</div>
                    <div style="font-size: 11px; color: #6B7280;"><span class="status-dot"></span>Online</div>
                </div>
            </div>
            <div>
                <div style="font-size: 10px; text-transform: uppercase; color: #9CA3AF; font-weight: 700; margin-bottom: 2px;">Vibe Meter</div>
                <div class="vibe-container">
                    <div class="vibe-fill" id="vibe-bar"></div>
                </div>
            </div>
        </div>

        <div class="chat-area" id="chat-area">
            <div class="typing-indicator" id="typing-indicator">
                <div class="dot"></div><div class="dot"></div><div class="dot"></div>
            </div>
        </div>

        <div class="input-area">
            <div class="choices-container" id="choices-area"></div>
            
            <div class="writing-container" id="writing-area">
                <input type="text" class="text-input" id="user-input" placeholder="Type your reply..." autocomplete="off">
                <button class="send-btn" onclick="submitWriting()">‚û§</button>
            </div>
        </div>

        <div id="menu-overlay">
            <h1 style="font-size: 32px; font-weight: 800; margin-bottom: 10px;">üí¨ Vibe Check</h1>
            <p style="color: #9CA3AF; margin-bottom: 20px;">English for Cool Dudes</p>
            
            <div class="diff-selector">
                <div class="diff-opt active" id="diff-chill" onclick="setDifficulty('chill')">üòé Chill (Training)</div>
                <div class="diff-opt" id="diff-pro" onclick="setDifficulty('pro')">üî• Pro (Survival)</div>
            </div>
            
            <p id="diff-desc" style="font-size:12px; color: #6B7280; margin-bottom: 20px; font-style: italic;">Training Mode: Hints ON, Coach ON, 50% Start</p>

            <button class="menu-btn" onclick="pickRandomScenario('business')">üëî Business (5 Stories)</button>
            <button class="menu-btn" onclick="pickRandomScenario('dating')">üåπ Social / Dating (5 Stories)</button>
            <button class="menu-btn" onclick="pickRandomScenario('casual')">üß¢ Slang / Friends (5 Stories)</button>
        </div>

        <div id="game-over-overlay">
            <div style="font-size: 60px; margin-bottom: 10px;" id="end-emoji">üö´</div>
            <h2 style="font-size: 28px; font-weight: 700; margin-bottom: 10px;" id="end-title">BLOCKED!</h2>
            <p style="color: #D1D5DB; margin-bottom: 30px;" id="end-reason">Your vibe was way off.</p>
            
            <button class="menu-btn" onclick="restartCurrentScenario()">üîÑ Try Again (Same Story)</button>
            <button class="menu-btn" style="background: transparent; color: white; border: 1px solid white;" onclick="showMenu()">Main Menu</button>
        </div>

    </div>

    <script>
        // --- GAME CONFIG ---
        let difficulty = 'chill'; // 'chill' or 'pro'
        
        // TIMINGS
        const TIME_INITIAL_PAUSE = 600;
        const TIME_TYPING = 3000;
        const TIME_READING = 2500;

        // --- GAME DATA (15 STORIES) ---
        const scenarioDB = {
            business: [
                {
                    name: "Mr. Sterling", avatar: "üëî", startNode: 1,
                    nodes: {
                        1: { text: "Where is the quarterly report? It was due an hour ago. üò°", type: "choice", options: [
                            { text: "Chill out, I'm doing it.", vibe: -40, feedback: "Too casual/rude for a boss!", next: "fail_rude" },
                            { text: "I'm so sorry! I forgot.", vibe: -20, feedback: "Don't admit you forgot. Be professional.", next: "fail_weak" },
                            { text: "I'm finalizing the details now. It will be in your inbox in 10 mins.", vibe: +10, next: 2 }
                        ]},
                        2: { text: "Fine. Just make sure the budget section is accurate this time.", type: "choice", options: [
                            { text: "It's always accurate.", vibe: -10, feedback: "Too defensive.", next: 3 },
                            { text: "Noted. I've double-checked the figures.", vibe: +20, next: 3 },
                            { text: "Whatever you say.", vibe: -30, feedback: "Passive aggressive attitude.", next: "fail_attitude" }
                        ]},
                        3: { text: "Wait, I see a typo in the email you just sent. You wrote 'We look forward to hare from you'. Fix it.", type: "writing", correctKeywords: ["hear", "hearing", "apologize", "sorry", "correction"], hint: "Fix the verb 'hare' to 'hear'", next: 4 },
                        4: { text: "Better. Are you available for a client call at 5 PM?", type: "choice", options: [
                            { text: "No, I'm going home.", vibe: -50, feedback: "Refusing a request directly is risky.", next: "fail_lazy" },
                            { text: "I can make myself available.", vibe: +20, next: "win" },
                            { text: "I suppose so.", vibe: -10, feedback: "Sounds unenthusiastic.", next: "win" }
                        ]},
                        "win": { text: "Excellent. Send the invite.", end: true, win: true },
                        "fail_rude": { text: "Excuse me? Visit HR immediately. You're fired.", end: true, win: false },
                        "fail_weak": { text: "I need confidence, not apologies. Get out.", end: true, win: false },
                        "fail_attitude": { text: "I don't like your tone. Go home.", end: true, win: false },
                        "fail_lazy": { text: "Then don't bother coming back tomorrow.", end: true, win: false }
                    }
                },
                {
                    name: "Mrs. Vance", avatar: "üíº", startNode: 1,
                    nodes: {
                        1: { text: "You wanted to see me about your salary?", type: "choice", options: [
                            { text: "Yeah, I want more money.", vibe: -30, feedback: "Too blunt/greedy.", next: "fail_greedy" },
                            { text: "I'd like to discuss a potential raise.", vibe: +10, next: 2 },
                            { text: "I'm broke, please help.", vibe: -20, feedback: "Too desperate/personal.", next: "fail_beg" }
                        ]},
                        2: { text: "I see. Why do you think you deserve a raise right now?", type: "writing", correctKeywords: ["performance", "results", "value", "hard work", "worked hard", "work hard", "working hard", "sales", "numbers", "target", "dedicated", "dedication", "effort"], hint: "Mention your hard work or results", next: 3 },
                        3: { text: "Fair point. Your results have been good. What figure were you thinking?", type: "choice", options: [
                            { text: "10% increase.", vibe: +10, next: 4 },
                            { text: "Double my salary.", vibe: -50, feedback: "Unrealistic expectation.", next: "fail_unreal" },
                            { text: "Whatever you can give.", vibe: -10, feedback: "Undervalues yourself.", next: "fail_weak" }
                        ]},
                        4: { text: "10% is high. We can offer 5%.", type: "choice", options: [
                            { text: "That's an insult.", vibe: -40, feedback: "Very rude reaction.", next: "fail_rude" },
                            { text: "I appreciate the offer, could we meet at 7%?", vibe: +30, next: "win" },
                            { text: "Okay, fine.", vibe: 0, next: "win_weak" }
                        ]},
                        "win": { text: "You drive a hard bargain. 7% it is. Sign here.", end: true, win: true },
                        "win_weak": { text: "Great. 5% effective immediately. Back to work.", end: true, win: true },
                        "fail_greedy": { text: "We don't just hand out cash. Request denied.", end: true, win: false },
                        "fail_beg": { text: "This is a business, not a charity.", end: true, win: false },
                        "fail_unreal": { text: "Get real. Meeting over.", end: true, win: false },
                        "fail_weak": { text: "If you don't value yourself, neither will I. No raise.", end: true, win: false },
                        "fail_rude": { text: "Watch your attitude. Request denied.", end: true, win: false }
                    }
                },
                {
                    name: "Client (John)", avatar: "ü§ù", startNode: 1,
                    nodes: {
                        1: { text: "We received the shipment, but half the items are broken! ü§¨", type: "choice", options: [
                            { text: "Not my problem.", vibe: -50, feedback: "Refusing responsibility.", next: "fail_rude" },
                            { text: "Oh no! Let me look into that immediately.", vibe: +20, next: 2 },
                            { text: "Maybe the postman dropped it.", vibe: -20, feedback: "Making excuses.", next: "fail_excuse" }
                        ]},
                        2: { text: "You better fix this or we are cancelling the contract.", type: "writing", correctKeywords: ["refund", "replacement", "replace", "send new", "money back", "fix", "resolve", "solution", "sorry"], hint: "Offer refund/replace", next: 3 },
                        3: { text: "A replacement sounds acceptable. When will it arrive?", type: "choice", options: [
                            { text: "Whenever the truck gets there.", vibe: -30, feedback: "Too vague/lazy.", next: "fail_lazy" },
                            { text: "We are shipping it express today.", vibe: +30, next: "win" },
                            { text: "Next week maybe.", vibe: -10, feedback: "Too slow.", next: "fail_slow" }
                        ]},
                        "win": { text: "Okay. Send me the tracking number. Thanks for fixing it.", end: true, win: true },
                        "fail_rude": { text: "Wow. I'm calling your manager.", end: true, win: false },
                        "fail_excuse": { text: "I don't care whose fault it is. Fix it or we leave.", end: true, win: false },
                        "fail_lazy": { text: "Unacceptable. Contract cancelled.", end: true, win: false },
                        "fail_slow": { text: "Too slow. We are going to a competitor.", end: true, win: false }
                    }
                },
                // NEW: Interview
                {
                    name: "HR Manager", avatar: "üìã", startNode: 1,
                    nodes: {
                        1: { text: "Thanks for coming in. Tell me, what is your biggest weakness?", type: "choice", options: [
                            { text: "I work too hard.", vibe: -10, feedback: "A clich√© answer.", next: 2 },
                            { text: "Sometimes I focus too much on details.", vibe: +20, next: 2 },
                            { text: "I'm lazy in the mornings.", vibe: -40, feedback: "Never admit to being lazy!", next: "fail_lazy" }
                        ]},
                        2: { text: "Interesting. And why do you want to work here?", type: "writing", correctKeywords: ["grow", "learn", "opportunity", "reputation", "company", "career", "skills", "challenge"], hint: "Mention growth, learning, or the company reputation", next: 3 },
                        3: { text: "Good answer. Do you have any questions for me?", type: "choice", options: [
                            { text: "No, I'm good.", vibe: -20, feedback: "Always ask a question!", next: "fail_interest" },
                            { text: "How much vacation do I get?", vibe: -10, feedback: "Don't ask about perks first.", next: "fail_perks" },
                            { text: "What does a typical day look like?", vibe: +20, next: "win" }
                        ]},
                        "win": { text: "Great question! Let me introduce you to the team. You're hired!", end: true, win: true },
                        "fail_lazy": { text: "We need energetic people here. Goodbye.", end: true, win: false },
                        "fail_interest": { text: "You don't seem very interested. We'll call you.", end: true, win: false },
                        "fail_perks": { text: "You should care about the work, not just the vacation.", end: true, win: false }
                    }
                },
                // NEW: Toxic Coworker
                {
                    name: "Karen", avatar: "üòí", startNode: 1,
                    nodes: {
                        1: { text: "Did you see what Mike is wearing today? So unprofessional.", type: "choice", options: [
                            { text: "Yeah, he looks like a clown.", vibe: -20, feedback: "Don't gossip!", next: "fail_gossip" },
                            { text: "I think he looks fine.", vibe: +10, next: 2 },
                            { text: "I'm trying to focus on my work.", vibe: +20, next: 2 }
                        ]},
                        2: { text: "You're no fun. Anyway, are you going to the meeting?", type: "writing", correctKeywords: ["yes", "attend", "going", "join", "be there", "busy", "later", "time"], hint: "Confirm if you are going", next: 3 },
                        3: { text: "I'm thinking of skipping it. It's so boring. You should skip it too.", type: "choice", options: [
                            { text: "Okay, let's skip it.", vibe: -40, feedback: "Bad influence!", next: "fail_skip" },
                            { text: "I can't, it's important.", vibe: +20, next: "win" },
                            { text: "Maybe...", vibe: -10, feedback: "Be decisive.", next: 3 }
                        ]},
                        "win": { text: "Fine, be a teacher's pet. See you there.", end: true, win: true },
                        "fail_gossip": { text: "Exactly! I'm going to tell everyone you said that.", end: true, win: false },
                        "fail_skip": { text: "The boss noticed we were missing. We are in big trouble.", end: true, win: false }
                    }
                }
            ],
            dating: [
                {
                    name: "Sarah", avatar: "üåπ", startNode: 1,
                    nodes: {
                        1: { text: "Hey! Just saw your profile. You seem fun. üòä", type: "choice", options: [
                            { text: "I know.", vibe: -20, feedback: "Too arrogant.", next: 2 },
                            { text: "Hey! Thanks, you too. How's your week going?", vibe: +20, next: 2 },
                            { text: "Send pics.", vibe: -100, feedback: "CREEPY. Don't do this.", next: "fail_creep" }
                        ]},
                        2: { text: "It's been okay! Just super busy with work. I need a break lol.", type: "choice", options: [
                            { text: "Jobs are boring.", vibe: -10, feedback: "Negative vibe.", next: 3 },
                            { text: "That sucks. You should quit.", vibe: -20, feedback: "Bad advice.", next: 3 },
                            { text: "I hear that. We should do something fun then!", vibe: +20, next: 3 }
                        ]},
                        3: { text: "Exactly! I love Italian food btw. üçù", type: "writing", correctKeywords: ["dinner", "eat", "food", "italian", "pasta", "pizza", "weekend", "together", "meet", "fancy", "like", "go"], hint: "Ask her out for food", next: 4 },
                        4: { text: "Ooh I'd love that! Saturday night? ü•Ç", type: "choice", options: [
                            { text: "Saturday works perfectly.", vibe: +20, next: "win" },
                            { text: "Maybe. I might be busy.", vibe: -30, feedback: "Playing too hard to get.", next: "fail_cold" },
                            { text: "If you pay.", vibe: -50, feedback: "Very cheap/rude.", next: "fail_cheap" }
                        ]},
                        "win": { text: "Great! Can't wait! See you then üòò", end: true, win: true },
                        "fail_creep": { text: "Uhh... blocked.", end: true, win: false },
                        "fail_cold": { text: "Okay nevermind then...", end: true, win: false },
                        "fail_cheap": { text: "Wow. Bye.", end: true, win: false }
                    }
                },
                {
                    name: "Jessica", avatar: "üç∑", startNode: 1,
                    nodes: {
                        1: { text: "That dinner was delicious! üòã Here comes the check.", type: "choice", options: [
                            { text: "You paying?", vibe: -40, feedback: "Cheap/Rude.", next: "fail_cheap" },
                            { text: "Let me get this.", vibe: +20, next: 2 },
                            { text: "Let's split it.", vibe: 0, next: 2 }
                        ]},
                        2: { text: "Are you sure? It's kind of expensive.", type: "writing", correctKeywords: ["worry", "fine", "okay", "treat", "my treat", "got this", "pay", "no problem", "pleasure"], hint: "Say 'My treat' / It's fine", next: 3 },
                        3: { text: "That is so sweet of you! So... what do you want to do now?", type: "choice", options: [
                            { text: "Your place?", vibe: -50, feedback: "Moving too fast!", next: "fail_fast" },
                            { text: "We could grab a drink at a jazz bar?", vibe: +20, next: "win" },
                            { text: "I'm going home.", vibe: -20, feedback: "Boring ending.", next: "fail_boring" }
                        ]},
                        "win": { text: "I love jazz! Let's go! üé∑", end: true, win: true },
                        "fail_cheap": { text: "Wow... okay. I'll pay for myself and leave.", end: true, win: false },
                        "fail_fast": { text: "Whoa, slow down. I'm going home alone.", end: true, win: false },
                        "fail_boring": { text: "Oh. Okay. Goodnight then.", end: true, win: false }
                    }
                },
                {
                    name: "Tom", avatar: "üé∏", startNode: 1,
                    nodes: {
                        1: { text: "Hey! Are you new to the city?", type: "choice", options: [
                            { text: "Yes, I just moved here.", vibe: +10, next: 2 },
                            { text: "Who asks?", vibe: -30, feedback: "Too aggressive.", next: "fail_aggro" },
                            { text: "No.", vibe: -10, next: 2 }
                        ]},
                        2: { text: "Cool! I'm playing a gig at a bar downtown tonight. You should come!", type: "writing", correctKeywords: ["love", "cool", "sound", "great", "fun", "what time", "where", "details", "address", "music"], hint: "Ask details / Say yes", next: 3 },
                        3: { text: "It starts at 9PM at The Blue Note. Bring friends!", type: "choice", options: [
                            { text: "I don't have friends.", vibe: -20, feedback: "A bit awkward.", next: "fail_awkward" },
                            { text: "Awesome, I'll be there!", vibe: +20, next: "win" },
                            { text: "I hate loud music.", vibe: -40, feedback: "Buzzkill.", next: "fail_rude" }
                        ]},
                        "win": { text: "Sick! See you there! ü§ò", end: true, win: true },
                        "fail_aggro": { text: "Whoa, relax. Just asking.", end: true, win: false },
                        "fail_awkward": { text: "Oh... uh, okay. Maybe next time.", end: true, win: false },
                        "fail_rude": { text: "Nevermind then.", end: true, win: false }
                    }
                },
                // NEW: Coffee Shop
                {
                    name: "Stranger (Lily)", avatar: "‚òï", startNode: 1,
                    nodes: {
                        1: { text: "Excuse me, I think you have my coffee? I ordered the Latte.", type: "choice", options: [
                            { text: "No, this is mine.", vibe: -20, feedback: "A bit rude/defensive.", next: 2 },
                            { text: "Oh! I'm so sorry, let me check.", vibe: +20, next: 2 },
                            { text: "Get your own.", vibe: -50, feedback: "Extremely rude!", next: "fail_rude" }
                        ]},
                        2: { text: "It says 'Lily' on the cup. My name is Lily.", type: "writing", correctKeywords: ["sorry", "mistake", "wrong", "apologize", "my bad", "new one", "buy"], hint: "Apologize and offer to fix it", next: 3 },
                        3: { text: "It's okay! It happens. The line is so long though...", type: "choice", options: [
                            { text: "Yeah, bye.", vibe: -30, feedback: "Dismissive.", next: "fail_awkward" },
                            { text: "I'll buy you a new one. It's the least I can do.", vibe: +30, next: "win" },
                            { text: "You should wait in line then.", vibe: -20, feedback: "Not friendly.", next: "fail_rude" }
                        ]},
                        "win": { text: "That is so nice of you! I'd love that. I'm Lily, by the way.", end: true, win: true },
                        "fail_rude": { text: "Ugh, people these days.", end: true, win: false },
                        "fail_awkward": { text: "Okay... weirdo.", end: true, win: false }
                    }
                },
                // NEW: The Ghost
                {
                    name: "Mike", avatar: "üëª", startNode: 1,
                    nodes: {
                        1: { text: "Hey... long time no see. Sorry I disappeared for 2 weeks.", type: "choice", options: [
                            { text: "You are the worst.", vibe: -40, feedback: "Too aggressive immediately.", next: "fail_angry" },
                            { text: "Yeah, what happened?", vibe: +10, next: 2 },
                            { text: "I didn't notice.", vibe: -10, feedback: "Playing it too cool.", next: 2 }
                        ]},
                        2: { text: "My phone broke and I lost all my contacts. I felt so bad! üò≠", type: "writing", correctKeywords: ["believe", "okay", "fine", "worry", "understand", "lie", "really", "true", "happen"], hint: "Say you believe him OR you don't", next: 3 },
                        3: { text: "I promise it's the truth! Can I make it up to you with a drink?", type: "choice", options: [
                            { text: "No thanks, bye.", vibe: -20, feedback: "End of story.", next: "fail_cold" },
                            { text: "One drink. But you are paying.", vibe: +20, next: "win" },
                            { text: "Okay, but no more disappearing.", vibe: +30, next: "win" }
                        ]},
                        "win": { text: "Deal! I'll pick you up at 8. üöó", end: true, win: true },
                        "fail_angry": { text: "Whoa, chill. I won't bother you again.", end: true, win: false },
                        "fail_cold": { text: "Message received. Have a nice life.", end: true, win: false }
                    }
                }
            ],
            casual: [
                {
                    name: "Alex", avatar: "üß¢", startNode: 1,
                    nodes: {
                        1: { text: "Yo! What are you up to today?", type: "choice", options: [
                            { text: "I am currently working.", vibe: -10, feedback: "Too formal for 'Yo'", next: 2 },
                            { text: "Not much, just chilling. You?", vibe: +20, next: 2 },
                            { text: "Go away.", vibe: -50, feedback: "Just mean.", next: "fail_mean" }
                        ]},
                        2: { text: "Just finished at the gym. I'm starving. üçî", type: "writing", correctKeywords: ["eat", "food", "lunch", "hungry", "grab", "burger", "meal", "dinner", "snack", "same", "me too"], hint: "Suggest getting food", next: 3 },
                        3: { text: "Yes! Burger King? My treat.", type: "choice", options: [
                            { text: "I prefer a 5-star restaurant.", vibe: -30, feedback: "Snobbish.", next: "fail_snob" },
                            { text: "Sounds good, let's go!", vibe: +20, next: "win" },
                            { text: "No, I'm on a diet.", vibe: -10, feedback: "Boring response.", next: "fail_boring" }
                        ]},
                        "win": { text: "Sweet. Meet you there in 10 mins! üçü", end: true, win: true },
                        "fail_mean": { text: "Rude...", end: true, win: false },
                        "fail_snob": { text: "Since when are you so fancy? Forget it.", end: true, win: false },
                        "fail_boring": { text: "Ugh, you're no fun.", end: true, win: false }
                    }
                },
                {
                    name: "Sam", avatar: "üéÆ", startNode: 1,
                    nodes: {
                        1: { text: "Dude, are you watching the game tonight?", type: "choice", options: [
                            { text: "Which game?", vibe: 0, next: 2 },
                            { text: "Yeah! It's gonna be epic.", vibe: +20, next: 2 },
                            { text: "Sports are a waste of time.", vibe: -40, feedback: "Don't ruin the fun.", next: "fail_buzzkill" }
                        ]},
                        2: { text: "United vs City! It's the final! I'm watching at home.", type: "writing", correctKeywords: ["come", "over", "watch", "join", "can i", "invite", "party", "beer", "bring"], hint: "Ask to come over / join", next: 3 },
                        3: { text: "Yeah for sure! Bring some snacks though.", type: "choice", options: [
                            { text: "I will arrive with provisions.", vibe: -20, feedback: "You sound like a robot.", next: "fail_robot" },
                            { text: "I'll bring chips and beer.", vibe: +20, next: "win" },
                            { text: "No, you buy them.", vibe: -30, feedback: "Cheap.", next: "fail_cheap" }
                        ]},
                        "win": { text: "Legend! Door is open. ‚öΩ", end: true, win: true },
                        "fail_buzzkill": { text: "You must be fun at parties...", end: true, win: false },
                        "fail_robot": { text: "Why are you talking like a textbook? üòÇ", end: true, win: false },
                        "fail_cheap": { text: "Bro, don't be cheap. Forget it.", end: true, win: false }
                    }
                },
                {
                    name: "Lisa", avatar: "‚úàÔ∏è", startNode: 1,
                    nodes: {
                        1: { text: "I'm so bored. We should do something this weekend.", type: "choice", options: [
                            { text: "I agree.", vibe: -10, feedback: "A bit stiff.", next: 2 },
                            { text: " Totally! Any ideas?", vibe: +20, next: 2 },
                            { text: "I am busy studying grammar.", vibe: -30, feedback: "Boring!", next: "fail_nerd" }
                        ]},
                        2: { text: "I was thinking maybe a road trip? Or the beach?", type: "writing", correctKeywords: ["beach", "sea", "sand", "swim", "sun", "ocean", "road", "trip", "drive", "car", "go"], hint: "Choose beach or road trip", next: 3 },
                        3: { text: "Beach sounds perfect! But I don't have a car. üöó", type: "choice", options: [
                            { text: "We can take the train.", vibe: +20, next: "win" },
                            { text: "I can drive us.", vibe: +30, next: "win" },
                            { text: "Then we can't go.", vibe: -40, feedback: "Unhelpful.", next: "fail_lazy" }
                        ]},
                        "win": { text: "Awesome plan! I'll pack the sunscreen. ‚òÄÔ∏è", end: true, win: true },
                        "fail_nerd": { text: "Okay... have fun with that.", end: true, win: false },
                        "fail_lazy": { text: "Wow, helpful. Nevermind.", end: true, win: false }
                    }
                },
                // NEW: Angry Roommate
                {
                    name: "Roommate (Ben)", avatar: "üè†", startNode: 1,
                    nodes: {
                        1: { text: "Dude. The kitchen is a mess. Are you ever going to wash your dishes?", type: "choice", options: [
                            { text: "Relax, I'll do it later.", vibe: -20, feedback: "Procrastinating makes it worse.", next: 2 },
                            { text: "Sorry! I was super busy. I'll do it now.", vibe: +20, next: 2 },
                            { text: "They aren't my dishes.", vibe: -30, feedback: "Don't lie!", next: "fail_lie" }
                        ]},
                        2: { text: "You said you'd do it 'later' three days ago. It smells bad.", type: "writing", correctKeywords: ["now", "promise", "clean", "wash", "sorry", "right away", "tonight", "fix"], hint: "Promise to clean it NOW", next: 3 },
                        3: { text: "Fine. But if it's not clean by tonight, I'm throwing them out.", type: "choice", options: [
                            { text: "You wouldn't dare.", vibe: -50, feedback: "Don't challenge an angry roommate.", next: "fail_fight" },
                            { text: "Understood. I'm on it.", vibe: +20, next: "win" },
                            { text: "Chill out.", vibe: -10, feedback: "Dismissive.", next: "win" }
                        ]},
                        "win": { text: "Good. Thanks, man.", end: true, win: true },
                        "fail_lie": { text: "I saw you eating that pasta. Don't lie to me.", end: true, win: false },
                        "fail_fight": { text: "Watch me. *Crash* There go your plates.", end: true, win: false }
                    }
                },
                // NEW: Lost Tourist
                {
                    name: "Tourist", avatar: "üó∫Ô∏è", startNode: 1,
                    nodes: {
                        1: { text: "Excuse me! Do you speak English? I am very lost.", type: "choice", options: [
                            { text: "No.", vibe: -20, feedback: "Unhelpful.", next: "fail_rude" },
                            { text: "Yeah, what's up?", vibe: +20, next: 2 },
                            { text: "I'm busy.", vibe: -30, feedback: "Rude.", next: "fail_rude" }
                        ]},
                        2: { text: "I am looking for the train station. Google Maps is not working!", type: "writing", correctKeywords: ["straight", "left", "right", "turn", "block", "street", "corner", "walk", "minutes", "follow"], hint: "Give directions (Left/Right/Straight)", next: 3 },
                        3: { text: "Okay, go straight and turn left. Is it far?", type: "choice", options: [
                            { text: "Nah, it's like a 5 min walk.", vibe: +20, next: "win" },
                            { text: "Yes, you should take a taxi.", vibe: +10, next: "win" },
                            { text: "I don't know.", vibe: -10, feedback: "Then why did you give directions?", next: "fail_confused" }
                        ]},
                        "win": { text: "Thank you so much! You saved me! üôè", end: true, win: true },
                        "fail_rude": { text: "Oh... okay. Sorry to bother you.", end: true, win: false },
                        "fail_confused": { text: "I am more confused now. Bye.", end: true, win: false }
                    }
                }
            ]
        };

        // --- STATE ---
        let currentCategory = null;
        let activeScenarioIndex = 0; 
        let currentScenarioData = null; 
        let currentNodeId = 1;
        let vibe = 50; 

        // --- DOM ELEMENTS ---
        const chatArea = document.getElementById('chat-area');
        const choicesArea = document.getElementById('choices-area');
        const writingArea = document.getElementById('writing-area');
        const vibeBar = document.getElementById('vibe-bar');
        const typingIndicator = document.getElementById('typing-indicator');
        const userInput = document.getElementById('user-input');
        const appContainer = document.getElementById('app-container');
        const diffDesc = document.getElementById('diff-desc');

        // --- INIT ---
        function showMenu() {
            document.getElementById('menu-overlay').style.display = 'flex';
            document.getElementById('game-over-overlay').style.display = 'none';
        }

        function setDifficulty(level) {
            difficulty = level;
            document.getElementById('diff-chill').classList.remove('active');
            document.getElementById('diff-pro').classList.remove('active');
            document.getElementById(`diff-${level}`).classList.add('active');
            
            if (level === 'chill') {
                diffDesc.innerText = "Training Mode: Hints ON, Coach ON, 50% Start";
            } else {
                diffDesc.innerText = "Survival Mode: No Hints, No Coach, 20% Start";
            }
        }

        // Pick a RANDOM scenario from the category array
        function pickRandomScenario(category) {
            currentCategory = category;
            const scenariosList = scenarioDB[category];
            activeScenarioIndex = Math.floor(Math.random() * scenariosList.length);
            startScenario(scenariosList[activeScenarioIndex]);
        }

        // Restart the EXACT same scenario (for "Try Again")
        function restartCurrentScenario() {
            if (currentCategory !== null) {
                const scenariosList = scenarioDB[currentCategory];
                startScenario(scenariosList[activeScenarioIndex]);
            } else {
                showMenu();
            }
        }

        function startScenario(data) {
            currentScenarioData = data;
            currentNodeId = data.startNode;
            
            // DIFFICULTY: Start Vibe
            vibe = (difficulty === 'chill') ? 50 : 20;
            
            // UI Setup
            document.getElementById('menu-overlay').style.display = 'none';
            document.getElementById('game-over-overlay').style.display = 'none';
            
            document.getElementById('npc-name').innerText = data.name;
            document.getElementById('npc-avatar').innerText = data.avatar;
            chatArea.innerHTML = ''; 
            updateVibeUI();
            
            chatArea.appendChild(typingIndicator);
            processNode();
        }

        // --- GAME LOOP ---
        function processNode() {
            const node = currentScenarioData.nodes[currentNodeId];
            
            // Hide Inputs
            choicesArea.innerHTML = '';
            writingArea.style.display = 'none';

            // 1. Initial Pause
            setTimeout(() => {
                
                // 2. Typing...
                typingIndicator.style.display = 'flex';
                scrollToBottom();

                // 3. Reveal Message
                setTimeout(() => {
                    typingIndicator.style.display = 'none';
                    addMessage(node.text, 'npc');

                    // Check End
                    if (node.end) {
                        setTimeout(() => triggerGameOver(node.win), 2000);
                        return;
                    }

                    // 4. Reveal Choices
                    setTimeout(() => {
                        if (node.type === 'choice') {
                            showChoices(node.options);
                        } else if (node.type === 'writing') {
                            showWritingInput(node.hint);
                        }
                    }, TIME_READING);

                }, TIME_TYPING); 

            }, TIME_INITIAL_PAUSE); 
        }

        // --- INPUT HANDLERS ---
        function showChoices(options) {
            options.forEach(opt => {
                const btn = document.createElement('div');
                btn.className = 'choice-btn';
                btn.innerText = opt.text;
                btn.onclick = () => handleChoice(opt);
                choicesArea.appendChild(btn);
            });
            scrollToBottom();
        }

        function handleChoice(option) {
            addMessage(option.text, 'user');
            choicesArea.innerHTML = '';
            
            // DIFFICULTY MODIFIERS
            let vibeChange = option.vibe;
            if (difficulty === 'pro' && vibeChange < 0) {
                vibeChange *= 1.5; // High damage in Pro
            }

            updateVibe(vibeChange, option.feedback);
            
            if (vibe <= 0) {
                setTimeout(() => triggerGameOver(false), 1500);
                return;
            }

            currentNodeId = option.next;
            processNode();
        }

        function showWritingInput(hint) {
            writingArea.style.display = 'flex';
            userInput.value = '';
            
            // DIFFICULTY: Hide Hints in Pro
            userInput.placeholder = (difficulty === 'chill') ? (hint || "Type your reply...") : "Type your reply...";
            userInput.focus();
            scrollToBottom();
        }

        function submitWriting() {
            const text = userInput.value.trim();
            if (!text) return;

            const node = currentScenarioData.nodes[currentNodeId];
            const keywords = node.correctKeywords;
            
            const isCorrect = keywords.some(k => text.toLowerCase().includes(k.toLowerCase()));

            writingArea.style.display = 'none';
            addMessage(text, 'user');

            if (isCorrect) {
                updateVibe(20, null);
                currentNodeId = node.next;
                processNode();
            } else {
                updateVibe(-20, "Incorrect keyword/grammar.");
                
                setTimeout(() => {
                    typingIndicator.style.display = 'flex';
                    scrollToBottom();
                    setTimeout(() => {
                        typingIndicator.style.display = 'none';
                        if (vibe <= 0) {
                            addMessage("I don't get what you're saying. Bye.", 'npc');
                            setTimeout(() => triggerGameOver(false), 2000);
                        } else {
                            addMessage("Huh? I don't understand.", 'npc');
                            setTimeout(() => showWritingInput(node.hint), 1500);
                        }
                    }, 1500);
                }, 500);
            }
        }

        // --- UI HELPERS ---
        function addMessage(text, type) {
            const div = document.createElement('div');
            div.className = `message msg-${type}`;
            div.innerText = text;
            chatArea.insertBefore(div, typingIndicator);
            scrollToBottom();
        }

        function updateVibe(amount, feedback) {
            vibe += amount;
            if (vibe > 100) vibe = 100;
            if (vibe < 0) vibe = 0;
            updateVibeUI();

            if (amount < 0) {
                shakeScreen();
                // DIFFICULTY: No Coach in Pro
                if (feedback && difficulty === 'chill') {
                    showCoachMessage(feedback);
                }
            }
        }

        function shakeScreen() {
            appContainer.classList.add('shake-screen');
            setTimeout(() => {
                appContainer.classList.remove('shake-screen');
            }, 500);
        }

        function showCoachMessage(text) {
            const div = document.createElement('div');
            div.className = 'msg-coach';
            div.innerText = "üí° Tip: " + text;
            chatArea.insertBefore(div, typingIndicator);
            scrollToBottom();
        }

        function updateVibeUI() {
            vibeBar.style.width = vibe + '%';
            if (vibe > 60) vibeBar.style.background = '#10B981'; // Green
            else if (vibe > 30) vibeBar.style.background = '#F59E0B'; // Orange
            else vibeBar.style.background = '#EF4444'; // Red
        }

        function scrollToBottom() {
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function triggerGameOver(win) {
            const overlay = document.getElementById('game-over-overlay');
            const title = document.getElementById('end-title');
            const reason = document.getElementById('end-reason');
            const emoji = document.getElementById('end-emoji');

            overlay.style.display = 'flex';
            
            if (win) {
                emoji.innerText = "üéâ";
                title.innerText = "VIBE CHECK PASSED!";
                title.style.color = "#10B981";
                reason.innerText = "You kept the conversation flowing perfectly.";
            } else {
                emoji.innerText = "üö´";
                title.innerText = "BLOCKED";
                title.style.color = "#EF4444";
                reason.innerText = "Your vibe dropped to zero. Conversation over.";
            }
        }

        userInput.addEventListener("keypress", function(event) {
            if (event.key === "Enter") submitWriting();
        });

    </script>
</body>
</html>
