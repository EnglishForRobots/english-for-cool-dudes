<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
    <link rel="apple-touch-icon" href="/images/icon-180.png" sizes="180x180">
    <link rel="icon" type="image/png" href="/images/icon-192.png" sizes="192x192">

    <link rel="manifest" href="/manifest.json">
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Journey Through Germany - Optimized</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- BRANDING & MOBILE-FIRST STYLES (Unified 'Cool Dudes' Look) --- */
        :root {
            --color-primary: #1A5E7F; /* Deep Blue */
            --color-secondary: #00A896; /* Teal/Aqua (Accent) */
            --color-accent: #FFC107; /* Amber/Highlight */
            --color-background: #F8F9FB; /* Light Gray-Blue */
            --color-text: #2C3E50; /* Dark Blue-Gray */
            --color-correct: #2ECC71; /* Green */
            --color-incorrect: #E74C3C; /* Red */
        }
        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }
        .header {
            background: #FFFFFF;
            border-bottom: 1px solid #E5E9F2;
            padding: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            text-decoration: none;
            color: var(--color-text);
        }
        .logo {
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, var(--color-accent) 0%, #FF9800 100%);
            color: white;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 900;
        }
        .site-title {
            font-size: 18px;
            font-weight: 900;
            color: #1A202C;
            letter-spacing: -0.02em;
        }

        /* Lesson Layout */
        .lesson-container {
            max-width: 800px;
            margin: 20px auto 40px;
            padding: 0 15px;
        }
        
        /* Content Blocks */
        .content-card {
            background-color: #FFFFFF;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        h2 {
            color: var(--color-primary);
            font-size: 1.8em;
            font-weight: 800;
            margin-bottom: 15px;
            border-bottom: 3px solid var(--color-accent);
            display: block; 
            width: 100%;
            padding-bottom: 3px;
        }
        
        /* Matching Styles (Vertical Scrolling/Card-based) */
        .matching-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .match-card {
            border: 2px solid transparent; 
            transition: all 0.2s ease;
            cursor: pointer;
            user-select: none;
            border-radius: 0.75rem; 
            padding: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            font-weight: 600;
            text-align: left;
            background-color: #f7faff;
            color: var(--color-text); /* Ensure text is readable */
        }
        .match-card.term {
            border-color: var(--color-primary);
            color: var(--color-primary);
        }
        .match-card.definition {
            border-color: #ccc;
        }
        .match-card.selected {
            border-color: var(--color-secondary);
            background-color: #e6ffe6;
            box-shadow: 0 0 0 4px var(--color-secondary);
            transform: scale(1.02);
        }

        /* VIBRANT MATCH COLORS */
        .match-color-1 { background-color: #F0FFF4 !important; border-color: #059669 !important; box-shadow: 0 0 0 4px #059669 !important; color: var(--color-text); transform: none; pointer-events: none; opacity: 1; } /* Emerald Green */
        .match-color-2 { background-color: #FFF7ED !important; border-color: #F97316 !important; box-shadow: 0 0 0 4px #F97316 !important; color: var(--color-text); transform: none; pointer-events: none; opacity: 1; } /* Bright Orange */
        .match-color-3 { background-color: #F3F4F6 !important; border-color: #3B82F6 !important; box-shadow: 0 0 0 4px #3B82F6 !important; color: var(--color-text); transform: none; pointer-events: none; opacity: 1; } /* Royal Blue */
        .match-color-4 { background-color: #FEF2F2 !important; border-color: #EF4444 !important; box-shadow: 0 0 0 4px #EF4444 !important; color: var(--color-text); transform: none; pointer-events: none; opacity: 1; } /* Vibrant Red */
        .match-color-5 { background-color: #F5F3FF !important; border-color: #8B5CF6 !important; box-shadow: 0 0 0 4px #8B5CF6 !important; color: var(--color-text); transform: none; pointer-events: none; opacity: 1; } /* Violet Purple */
        
        /* Reading Text Style & Dictionary Words */
        .reading-text {
            background: #F0F4F7; 
            border: 1px solid #E5E9F2;
            padding: 15px;
            border-radius: 8px;
            font-size: 1.05em;
        }
        .dictionary-word {
            font-weight: 700;
            color: var(--color-primary);
            cursor: help; /* Change cursor to indicate help/info */
            border-bottom: 1px dashed var(--color-primary); /* Dashed underline */
            white-space: nowrap; /* Prevent word break */
        }
        .dictionary-word:hover {
            color: var(--color-secondary);
            border-bottom: 1px solid var(--color-secondary);
        }

        /* Dictionary Pop-up Style */
        #dictionary-popup-float {
            position: fixed; /* Use fixed for better mobile behavior */
            top: 0;
            left: 0;
            max-width: 250px;
            padding: 10px;
            background: var(--color-primary);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 2000;
            display: none;
            font-size: 0.9em;
            line-height: 1.4;
            opacity: 0;
            transition: opacity 0.1s ease-in-out;
            pointer-events: none; /* Allows clicks to pass through to elements below if not needed */
        }
        #dictionary-popup-float.active {
            opacity: 1;
            display: block;
        }


        /* Multiple Choice Styles */
        .quiz-option {
            background: #FFFFFF;
            border: 1px solid #E5E9F2;
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
        }
        .quiz-option:hover {
            background: #EEF2FF;
            border-color: var(--color-primary);
        }
        .quiz-option.selected {
            background: #e6ffe6;
            border-color: var(--color-secondary);
            box-shadow: 0 0 0 2px var(--color-secondary);
        }
        .quiz-option.correct {
            background: var(--color-correct) !important;
            color: white;
            border-color: var(--color-correct) !important;
        }
        .quiz-option.incorrect {
            background: var(--color-incorrect) !important;
            color: white;
            border-color: var(--color-incorrect) !important;
            animation: flash-red 0.3s 2;
        }
        
        /* Gap Fill Styles */
        .word-bank {
            background: #EAF2F8;
            border: 2px solid var(--color-primary);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .word-option {
            background-color: var(--color-secondary); 
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s, opacity 0.3s;
            font-weight: 600;
        }
        .word-option.used {
            opacity: 0.5;
            pointer-events: none;
            background-color: #AAB8C2;
            transform: none;
        }
        .gap-input {
            display: inline-block;
            text-align: center;
            padding: 6px 10px;
            min-width: 100px;
            height: 38px;
            background-color: #E5E9F2;
            border: 1px dashed var(--color-primary);
            border-radius: 4px;
            color: var(--color-text);
            font-style: italic;
            cursor: pointer;
            line-height: 24px;
            vertical-align: middle;
            font-weight: 600;
            margin: 0 4px;
            transition: all 0.2s ease;
        }

        /* Clearer Gap Fill Button */
        .check-btn {
            background-color: var(--color-primary);
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 15px;
            display: block;
            width: 100%;
            border: none;
            /* Stronger 3D effect */
            box-shadow: 0 4px #104358; 
        }
        .check-btn:hover {
            background-color: #104358;
        }
        .check-btn:active {
            box-shadow: 0 1px #104358;
            transform: translateY(3px);
        }

        /* Pop-up/Flash */
        #feedback-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 30px;
            background: var(--color-secondary);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            font-size: 1.2em;
            font-weight: 700;
            text-align: center;
        }
        @keyframes flash-red {
            0%, 100% { background-color: #E74C3C; color: white; }
            50% { background-color: white; color: #E74C3C; }
        }
    </style>
</head>
<body>
    <header class="header">
        <a href="/intermediate/" class="header-content">
            <div class="logo">😎</div>
            <div class="site-title">English For Cool Dudes</div>
        </a>
    </header>

    <main class="lesson-container">
        <h1 class="text-3xl font-black text-gray-800 mb-5">🇩🇪 A Journey Through Germany</h1>
        <p class="text-gray-600 mb-8">Level: Intermediate | Topic: Culture & History</p>

        <div class="content-card">
            <h2>1. Vocabulary Match</h2>
            <p class="text-gray-600 mb-4">Match the word to its definition. Click two cards to form a pair. Matched pairs will turn a unique color.</p>
            <div class="matching-grid" id="vocab-match-area">
                <div class="match-card term" data-group="term" data-pair="A">populous</div>
                <div class="match-card definition" data-group="definition" data-pair="D">separated or caused to be separate</div>
                <div class="match-card definition" data-group="definition" data-pair="A">having a large population</div>
                <div class="match-card term" data-group="term" data-pair="B">complex</div>
                <div class="match-card definition" data-group="definition" data-pair="E">full of life, energy, and excitement</div>
                <div class="match-card term" data-group="term" data-pair="C">landmarks</div>
                <div class="match-card definition" data-group="definition" data-pair="C">an object or a feature of a place that is easily recognizable</div>
                <div class="match-card term" data-group="term" data-pair="D">divided</div>
                <div class="match-card definition" data-group="definition" data-pair="B">consisting of many different and connected parts</div>
                <div class="match-card term" data-group="term" data-pair="E">vibrant</div>
            </div>
        </div>

        <div class="content-card">
            <h2>2. Short Reading Text</h2>
            <p class="text-gray-600 mb-4">Read the text about Germany's profile. **Click the underlined words** to see their definition.</p>
            <div class="reading-text text-justify" id="reading-text-content">
                <p>Germany, officially the Federal Republic of Germany, is a country in Central Europe. It is the <span class="dictionary-word" data-word="populous">second most populous</span> country in Europe after Russia, and the most populous member state of the European Union. Germany's history is incredibly <span class="dictionary-word" data-word="complex">complex</span>, from the Holy Roman Empire to its <span class="dictionary-word" data-word="reunification">reunification</span> in 1990.</p>
                <p class="mt-3">The capital, Berlin, is famous for its historical <span class="dictionary-word" data-word="landmarks">landmarks</span> like the Brandenburg Gate and the remains of the Berlin Wall. The wall <span class="dictionary-word" data-word="divided">divided</span> the city for almost <span class="dictionary-word" data-word="decades">three decades</span>, from 1961 to 1989. Its fall marked a significant moment in modern history and led to the reunification of East and West Germany.</p>
                <p class="mt-3">Beyond its history, Germany is known for its engineering, <span class="dictionary-word" data-word="automotive">automotive industry</span> (brands like Mercedes-Benz and BMW), and <span class="dictionary-word" data-word="vibrant">vibrant</span> cultural traditions. Oktoberfest, for instance, is a world-famous festival held <span class="dictionary-word" data-word="annually">annually</span> in Munich, Bavaria. German <span class="dictionary-word" data-word="cuisine">cuisine</span>, which includes sausages (Wurst) and bread (Brot), is also a key part of the culture.</p>
            </div>
        </div>

        <div id="dictionary-popup-float"></div>
        
        <div class="content-card">
            <h2>3. Multiple Choice Comprehension</h2>
            <p class="text-gray-600 mb-4">Choose the correct option based on the text.</p>
            <div class="space-y-4" id="mc-comp-area">
                <div class="question-box" data-correct="1990">
                    <p>1. What year did Germany reunify?</p>
                    <div class="quiz-options space-y-2">
                        <div class="quiz-option" onclick="checkMc(this, '1990', 'mc-comp-area')">1990</div>
                        <div class="quiz-option" onclick="checkMc(this, '1990', 'mc-comp-area')">1961</div>
                        <div class="quiz-option" onclick="checkMc(this, '1990', 'mc-comp-area')">1989</div>
                    </div>
                </div>
                <div class="question-box" data-correct="Munich">
                    <p>2. In which city is the world-famous Oktoberfest held?</p>
                    <div class="quiz-options space-y-2">
                        <div class="quiz-option" onclick="checkMc(this, 'Munich', 'mc-comp-area')">Berlin</div>
                        <div class="quiz-option" onclick="checkMc(this, 'Munich', 'mc-comp-area')">Munich</div>
                        <div class="quiz-option" onclick="checkMc(this, 'Munich', 'mc-comp-area')">Frankfurt</div>
                    </div>
                </div>
                <div class="question-box" data-correct="automotive industry">
                    <p>3. Besides history and culture, Germany is renowned for its:</p>
                    <div class="quiz-options space-y-2">
                        <div class="quiz-option" onclick="checkMc(this, 'automotive industry', 'mc-comp-area')">fashion industry</div>
                        <div class="quiz-option" onclick="checkMc(this, 'automotive industry', 'mc-comp-area')">fishing industry</div>
                        <div class="quiz-option" onclick="checkMc(this, 'automotive industry', 'mc-comp-area')">automotive industry</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-card">
            <h2>4. True or False</h2>
            <p class="text-gray-600 mb-4">Decide if the following statements are true or false according to the reading text.</p>
            <div class="space-y-4" id="true-false-area">
                <div class="question-box" data-correct="False">
                    <p>1. Germany is the most populous country in all of Europe.</p>
                    <div class="quiz-options space-y-2">
                        <div class="quiz-option" onclick="checkMc(this, 'False', 'true-false-area')">True</div>
                        <div class="quiz-option" onclick="checkMc(this, 'False', 'true-false-area')">False</div>
                    </div>
                </div>
                <div class="question-box" data-correct="False">
                    <p>2. The Berlin Wall divided the city for less than 20 years.</p>
                    <div class="quiz-options space-y-2">
                        <div class="quiz-option" onclick="checkMc(this, 'False', 'true-false-area')">True</div>
                        <div class="quiz-option" onclick="checkMc(this, 'False', 'true-false-area')">False</div>
                    </div>
                </div>
                <div class="question-box" data-correct="True">
                    <p>3. German food includes Wurst (sausages) and Brot (bread).</p>
                    <div class="quiz-options space-y-2">
                        <div class="quiz-option" onclick="checkMc(this, 'True', 'true-false-area')">True</div>
                        <div class="quiz-option" onclick="checkMc(this, 'True', 'true-false-area')">False</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-card">
            <h2>5. Word Matching: Synonyms & Collocations</h2>
            <p class="text-gray-600 mb-4">Match the words that have a similar meaning. Click two cards to form a pair.</p>
            <div class="matching-grid" id="synonym-match-area">
                <div class="match-card term" data-group="term" data-pair="A">populous</div>
                <div class="match-card definition" data-group="definition" data-pair="D">food</div>
                <div class="match-card definition" data-group="definition" data-pair="A">crowded</div>
                <div class="match-card term" data-group="term" data-pair="B">reunification</div>
                <div class="match-card definition" data-group="definition" data-pair="E">lively</div>
                <div class="match-card term" data-group="term" data-pair="C">landmarks</div>
                <div class="match-card definition" data-group="definition" data-pair="C">monuments</div>
                <div class="match-card term" data-group="term" data-pair="D">cuisine</div>
                <div class="match-card definition" data-group="definition" data-pair="B">union</div>
                <div class="match-card term" data-group="term" data-pair="E">vibrant</div>
            </div>
        </div>

        <div class="content-card">
            <h2>6. Grammar Focus: Reported Speech</h2>
            <p class="text-gray-600 mb-4">Reported speech (or indirect speech) is used to tell someone what another person said, without using the person's exact words.</p>
            <div class="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 p-4 mb-4" role="alert">
                <p class="font-bold">Key Tense Change:</p>
                <p>When reporting speech in the past, the verb tense usually moves **backwards**.</p>
                <ul class="list-disc ml-6 mt-2">
                    <li>**Present Simple** (I live in Berlin) becomes **Past Simple** (She said she lived in Berlin).</li>
                    <li>**Present Perfect** (I have been) becomes **Past Perfect** (He said he had been).</li>
                    <li>**Will** becomes **Would** (They said they would travel).</li>
                </ul>
            </div>
            <p>Example: *Direct Speech:* "I will visit Oktoberfest next year."</p>
            <p>*Reported Speech:* He said that he **would visit** Oktoberfest the following year.</p>
        </div>

        <div class="content-card">
            <h2>7. Reported Speech: Choose the Correct Option</h2>
            <p class="text-gray-600 mb-4">Convert the direct speech to reported speech. Choose the correct option.</p>
            <div class="space-y-4" id="reported-speech-area">
                <div class="question-box" data-correct="She said that she was going to visit Berlin the following month.">
                    <div class="quiz-question font-semibold mb-2">Direct Speech: "I am going to visit Berlin next month," she said.</div>
                    <div class="quiz-options space-y-2">
                        <div class="quiz-option" onclick="checkMc(this, 'She said that she was going to visit Berlin the following month.', 'reported-speech-area')">She said that she was going to visit Berlin the following month.</div>
                        <div class="quiz-option" onclick="checkMc(this, 'She said that she was going to visit Berlin the following month.', 'reported-speech-area')">She said that she is going to visit Berlin next month.</div>
                        <div class="quiz-option" onclick="checkMc(this, 'She said that she was going to visit Berlin the following month.', 'reported-speech-area')">She said that I was going to visit Berlin the next month.</div>
                    </div>
                </div>
                <div class="question-box" data-correct="The tour guide explained that he had lived in Germany for five years.">
                    <div class="quiz-question font-semibold mb-2">Direct Speech: "He has lived in Germany for five years," the tour guide explained.</div>
                    <div class="quiz-options space-y-2">
                        <div class="quiz-option" onclick="checkMc(this, 'The tour guide explained that he had lived in Germany for five years.', 'reported-speech-area')">The tour guide explained that he had lived in Germany for five years.</div>
                        <div class="quiz-option" onclick="checkMc(this, 'The tour guide explained that he had lived in Germany for five years.', 'reported-speech-area')">The tour guide explained that he has lived in Germany for five years.</div>
                        <div class="quiz-option" onclick="checkMc(this, 'The tour guide explained that he had lived in Germany for five years.', 'reported-speech-area')">The tour guide explained that he lives in Germany for five years.</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-card">
            <h2>8. Gap Fill: Click to Complete</h2>
            <p class="text-gray-600 mb-4">Click a word in the bank, then click a gap to place it. Click a word in the gap to deselect it.</p>
            
            <div class="word-bank mb-4">
                <p class="font-bold mb-3 text-sm text-gray-700">Word Bank:</p>
                <div class="word-options flex flex-wrap gap-2" id="word-bank-gapfill">
                    <div class="word-option" data-word="marked">marked</div>
                    <div class="word-option" data-word="became">became</div>
                    <div class="word-option" data-word="was">was</div>
                    <div class="word-option" data-word="reunited">reunited</div>
                    <div class="word-option" data-word="fell">fell</div>
                </div>
            </div>

            <div class="gap-fill-text text-lg leading-loose" id="gap-fill-area">
                The Berlin Wall <span class="gap-input" data-answer="was" data-original-text="____" data-filled-word="">____</span> built in 1961. Its fall <span class="gap-input" data-answer="marked" data-original-text="____" data-filled-word="">____</span> a new era. The citizens celebrated as the barrier <span class="gap-input" data-answer="fell" data-original-text="____" data-filled-word="">____</span> down. East and West Germany <span class="gap-input" data-answer="reunited" data-original-text="____" data-filled-word="">____</span> and Berlin <span class="gap-input" data-answer="became" data-original-text="____" data-filled-word="">____</span> the capital.
            </div>

            <button type="button" class="check-btn" onclick="checkGapFill()">Check Gap Fill Answers</button>
            <div id="gap-fill-feedback" class="text-center font-semibold mt-3"></div>
        </div>

        <div class="content-card">
            <h2>9. Final Choice Activity</h2>
            <p class="text-gray-600 mb-4">Choose the most appropriate word to complete each sentence (similar words).</p>
             <div class="space-y-4" id="mc-final-area">
                <div class="question-box" data-correct="population">
                    <p>1. The country's *populous / population* is the largest in the EU.</p>
                    <div class="quiz-options space-y-2">
                        <div class="quiz-option" onclick="checkMc(this, 'population', 'mc-final-area')">populous</div>
                        <div class="quiz-option" onclick="checkMc(this, 'population', 'mc-final-area')">population</div>
                    </div>
                </div>
                <div class="question-box" data-correct="site">
                    <p>2. The Brandenburg Gate is a *site / sight* of historical importance.</p>
                    <div class="quiz-options space-y-2">
                        <div class="quiz-option" onclick="checkMc(this, 'site', 'mc-final-area')">site</div>
                        <div class="quiz-option" onclick="checkMc(this, 'site', 'mc-final-area')">sight</div>
                    </div>
                </div>
                <div class="question-box" data-correct="annual">
                    <p>3. Oktoberfest is an *annual / annually* event in Bavaria.</p>
                    <div class="quiz-options space-y-2">
                        <div class="quiz-option" onclick="checkMc(this, 'annual', 'mc-final-area')">annual</div>
                        <div class="quiz-option" onclick="checkMc(this, 'annual', 'mc-final-area')">annually</div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <div id="feedback-popup"></div>

    <script>
        const colors = {
            primary: '#1A5E7F',
            secondary: '#00A896',
            correct: '#2ECC71',
            incorrect: '#E74C3C',
        };
        
        // Array of classes for multi-color matching (Vibrant versions)
        const MATCH_COLORS = [
            'match-color-1', // Emerald Green
            'match-color-2', // Bright Orange
            'match-color-3', // Royal Blue
            'match-color-4', // Vibrant Red
            'match-color-5'  // Violet Purple
        ];
        let matchColorIndex = 0; // Index to cycle through colors
        
        // --- DICTIONARY DATA ---
        const DICTIONARY = {
            "populous": "Having a large number of people living in an area.",
            "complex": "Consisting of many different and connected parts; complicated.",
            "reunification": "The process of being united or brought together again after being divided.",
            "landmarks": "Objects or features of a landscape or place that are easily recognizable.",
            "divided": "Separated or caused to be separate.",
            "decades": "Periods of ten years.",
            "automotive": "Relating to motor vehicles, such as cars, trucks, and buses.",
            "vibrant": "Full of energy, excitement, and brightness; lively.",
            "annually": "Occurring once every year.",
            "cuisine": "A style or method of cooking, especially one characteristic of a particular country or region."
        };

        // --- DICTIONARY FUNCTIONS ---
        let hideTimeout; // This needs to be available globally

        function setupDictionary() {
            const words = document.querySelectorAll('.dictionary-word');
            
            words.forEach(word => {
                // Bind click event to show definition
                word.addEventListener('click', (event) => showDefinition(word.getAttribute('data-word'), event));
            });

            // Global click listener to hide the dictionary if clicked outside the reading area
            document.addEventListener('click', (event) => {
                const popup = document.getElementById('dictionary-popup-float');
                // Check if the clicked element is NOT a dictionary word
                if (!event.target.closest('.dictionary-word')) {
                    hideDefinition();
                }
            });
        }
        
        function showDefinition(wordKey, event) {
            event.stopPropagation(); // Stop the event from immediately triggering the global hide listener
            clearTimeout(hideTimeout);
            
            const popup = document.getElementById('dictionary-popup-float');
            const definition = DICTIONARY[wordKey];
            
            if (!definition) return;

            popup.innerHTML = `<p class="font-bold uppercase mb-1 text-sm">${wordKey}</p><p>${definition}</p>`;

            // Get position relative to the viewport
            const rect = event.target.getBoundingClientRect();
            
            // Calculate position using fixed positioning
            let topPos = rect.bottom + 10;
            let leftPos = rect.left + 10;

            // Simple boundary checking for mobile responsiveness (fixed position)
            const padding = 15;
            if (leftPos + 250 > window.innerWidth - padding) { // 250px max-width + padding
                leftPos = window.innerWidth - 250 - padding;
            }
            if (topPos + popup.offsetHeight > window.innerHeight - padding) {
                // If it goes off the bottom, put it above the word
                topPos = rect.top - popup.offsetHeight - 10;
            }
            
            // Fallback for very top elements
            if (topPos < 0) topPos = rect.bottom + 10;


            popup.style.top = `${topPos}px`;
            popup.style.left = `${leftPos}px`;
            popup.classList.add('active'); 

            // Auto-hide after 3 seconds 
            hideTimeout = setTimeout(hideDefinition, 3000);
        }

        function hideDefinition() {
            const popup = document.getElementById('dictionary-popup-float');
            popup.classList.remove('active');
            clearTimeout(hideTimeout);
        }


        // --- GLOBAL FEEDBACK FUNCTIONS ---

        function showPopup(message, isCorrect = true) {
            const popup = document.getElementById('feedback-popup');
            popup.textContent = message;
            // Logic to determine background color based on German phrases
            if (message.includes('Jawohl')) {
                popup.style.background = colors.primary; // Deep Blue for success
            } else if (message.includes('Schade')) {
                popup.style.background = colors.incorrect; // Red for failure
            } else {
                popup.style.background = isCorrect ? colors.secondary : colors.incorrect; // Fallback
            }
            
            popup.style.display = 'block';
            setTimeout(() => {
                popup.style.display = 'none';
            }, 1000);
        }

        function flashRed(element) {
            element.classList.add('flash-red');
            setTimeout(() => {
                element.classList.remove('flash-red');
            }, 600);
        }

        // --- 1. & 5. MATCHING LOGIC ---

        let selectedCard = null;

        function setupMatching(areaId) {
            const area = document.getElementById(areaId);
            const cards = area.querySelectorAll('.match-card');
            cards.forEach(card => {
                card.addEventListener('click', () => handleMatchClick(card, areaId));
            });
        }

        function handleMatchClick(card, areaId) {
            // Check if card is already matched (has a match-color class)
            const isMatched = MATCH_COLORS.some(cls => card.classList.contains(cls));
            if (isMatched) return;

            if (selectedCard === card) {
                // Deselect the current card
                selectedCard.classList.remove('selected');
                selectedCard = null;
            } else if (selectedCard) {
                // Second card is selected - Check for match
                const group1 = selectedCard.getAttribute('data-group');
                const group2 = card.getAttribute('data-group');

                // Must be from different groups
                if (group1 === group2) {
                    selectedCard.classList.remove('selected');
                    card.classList.add('selected');
                    selectedCard = card;
                    return;
                }

                const pair1 = selectedCard.getAttribute('data-pair');
                const pair2 = card.getAttribute('data-pair');

                if (pair1 === pair2) {
                    // Correct Match - Apply next color
                    const colorClass = MATCH_COLORS[matchColorIndex % MATCH_COLORS.length];
                    
                    selectedCard.classList.add(colorClass);
                    card.classList.add(colorClass);
                    selectedCard.classList.remove('selected');
                    card.classList.remove('selected');
                    
                    matchColorIndex++; // Move to the next color
                    showPopup('Jawohl! Correct Match ✅', true);

                    // Check if all matched
                    const area = document.getElementById(areaId);
                    if (area.querySelectorAll('.match-card:not([class*="match-color-"])').length === 0) {
                         showPopup('Jawohl! Alle Paare korrekt! 🎉', true); 
                    }
                } else {
                    // Incorrect Match - Flash Red
                    flashRed(selectedCard);
                    flashRed(card);
                    // Retain "Try Again" here as the cards deselect and reset.
                    showPopup('Schade! Try Again ❌', false); 
                    selectedCard.classList.remove('selected');
                    selectedCard = null; // Clear selection after incorrect guess
                }

                selectedCard = null; // Ensure only one card is selected after a match/mismatch
            } else {
                // First card selected
                card.classList.add('selected');
                selectedCard = card;
            }
        }


        // --- 3, 4, 7, 9. MULTIPLE CHOICE LOGIC (Instant feedback and German popups) ---

        function checkMc(selectedOption, correctAnswer, areaId) {
            // Hide dictionary on any quiz interaction
            hideDefinition();

            const questionBox = selectedOption.closest('.question-box');
            const options = questionBox.querySelectorAll('.quiz-option');
            const userAnswer = selectedOption.textContent.trim();
            const area = document.getElementById(areaId); 

            // 1. Clear previous selection/results in this question
            options.forEach(opt => opt.classList.remove('correct', 'incorrect', 'selected'));
            selectedOption.classList.add('selected'); 
            
            // Also remove the solved flag for a fresh check
            questionBox.removeAttribute('data-solved-correctly');

            // 2. Check if correct
            if (userAnswer === correctAnswer) {
                selectedOption.classList.remove('selected');
                selectedOption.classList.add('correct');
                
                // Instant feedback for the click
                showPopup('Jawohl! Correct Match ✅', true); 

                // Mark question as solved correctly
                questionBox.setAttribute('data-solved-correctly', 'true');

                // 3. Check for activity completion
                const questions = area.querySelectorAll('.question-box');
                let allQuestionsCorrect = true;
                questions.forEach(q => {
                    if (q.getAttribute('data-solved-correctly') !== 'true') {
                        allQuestionsCorrect = false;
                    }
                });

                if (allQuestionsCorrect) {
                    showPopup('Jawohl! Alle Antworten korrekt! 🎉', true);
                }
            } else {
                // 4. Handle Incorrect
                selectedOption.classList.add('incorrect');
                
                // Highlight the correct answer (REVEALS ANSWER)
                options.forEach(opt => {
                    if (opt.textContent.trim() === correctAnswer) {
                        opt.classList.add('correct');
                    }
                });
                
                // Show German incorrect popup (REMOVED 'Try Again' since answer is revealed)
                showPopup('Schade! Leider falsch. ❌', false);

                // Ensure the solved flag is NOT set
                questionBox.removeAttribute('data-solved-correctly');
            }
        }

        // --- 8. GAP FILL LOGIC (Click to fill/deselect) ---

        let selectedWord = null;

        function bindGapFillListeners() {
            const wordOptions = document.querySelectorAll('#word-bank-gapfill .word-option');
            const gapInputs = document.querySelectorAll('.gap-input');

            wordOptions.forEach(word => {
                word.addEventListener('click', () => handleWordSelect(word));
            });

            gapInputs.forEach(gap => {
                gap.addEventListener('click', () => handleGapFill(gap));
            });
        }

        function handleWordSelect(word) {
            // Deselect the previously selected word if any
            if (selectedWord) {
                selectedWord.classList.remove('selected');
            }

            // Select the new word
            if (selectedWord === word) {
                selectedWord = null; // Toggle off if clicking the same word
            } else {
                word.classList.add('selected');
                selectedWord = word;
            }
        }

        function handleGapFill(gap) {
            const currentWord = gap.getAttribute('data-filled-word');
            
            if (currentWord) {
                // Case 1: Gap already filled -> Deselect word and put back in bank
                const wordElement = document.querySelector(`#word-bank-gapfill .word-option[data-word="${currentWord}"]`);
                if (wordElement) {
                    wordElement.classList.remove('used');
                    wordElement.classList.remove('selected');
                }
                gap.textContent = gap.getAttribute('data-original-text');
                gap.setAttribute('data-filled-word', '');
                gap.classList.remove('correct', 'incorrect');
                selectedWord = null;

            } else if (selectedWord) {
                // Case 2: Gap is empty and a word is selected -> Fill gap
                const wordToFill = selectedWord.getAttribute('data-word');
                
                // Check if the selected word is already used in another gap
                const alreadyUsedGap = document.querySelector(`.gap-input[data-filled-word="${wordToFill}"]`);
                if(alreadyUsedGap) {
                    // If it is, swap it: remove it from the other gap first
                    alreadyUsedGap.textContent = alreadyUsedGap.getAttribute('data-original-text');
                    alreadyUsedGap.setAttribute('data-filled-word', '');
                    alreadyUsedGap.classList.remove('correct', 'incorrect');
                }

                gap.textContent = wordToFill;
                gap.setAttribute('data-filled-word', wordToFill);
                
                selectedWord.classList.add('used');
                selectedWord.classList.remove('selected');
                selectedWord = null;
            }
        }

        function checkGapFill() {
            const gapInputs = document.querySelectorAll('.gap-input');
            let correctCount = 0;

            gapInputs.forEach(gap => {
                const userWord = gap.getAttribute('data-filled-word');
                const correctAnswer = gap.getAttribute('data-answer');
                
                gap.classList.remove('correct', 'incorrect');

                if (userWord === correctAnswer) {
                    gap.classList.add('correct');
                    correctCount++;
                } else if (userWord) {
                    gap.classList.add('incorrect');
                }
            });

            const resultDiv = document.getElementById('gap-fill-feedback');
            if (correctCount === gapInputs.length) {
                resultDiv.innerHTML = '🎉 **Jawohl!** All gaps filled correctly.';
                resultDiv.className = 'text-center font-semibold mt-3 text-green-700';
            } else {
                resultDiv.innerHTML = `**Schade!** You got **${correctCount}** out of ${gapInputs.length} correct. Try Again!`;
                resultDiv.className = 'text-center font-semibold mt-3 text-red-700';
            }
        }


        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            setupMatching('vocab-match-area');
            setupMatching('synonym-match-area');
            bindGapFillListeners(); 
            setupDictionary(); // Initialize the fixed dictionary feature
        });
    </script>
</body>
</html>
