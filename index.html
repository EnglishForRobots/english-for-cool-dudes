<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="/favicon.png" sizes="32x32">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="manifest" href="/manifest.json">
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English For Cool Dudes</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: #F8F9FB;
            color: #2C3E50;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* === REUSABLE HEADER STYLES === */
        .header {
            background: #FFFFFF;
            border-bottom: 1px solid #E5E9F2;
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
            margin-bottom: 20px;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .site-title {
            font-size: 20px;
            font-weight: 800;
            color: #1A202C;
            letter-spacing: -0.02em;
            text-decoration: none;
        }

        .header-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-button {
            text-decoration: none;
            padding: 7px 14px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 700;
            transition: all 0.2s;
            white-space: nowrap;
            cursor: pointer;
            border: 1px solid #E5E9F2;
            background: transparent;
        }

        .header-button.login {
            background: #F8F9FB;
            color: #4A5568;
        }

        .header-button.login:hover {
            background: #FFFFFF;
            color: #2C3E50;
            border-color: #718096;
        }

        .header-button.signup {
            background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%);
            color: white;
            border: 1px solid transparent;
        }

        .header-button.signup:hover {
            background: linear-gradient(135deg, #5A6AD0 0%, #6D4396 100%);
            box-shadow: 0 2px 5px rgba(102, 126, 234, 0.4);
        }

        .header-button.dashboard {
            background: #FFFBEA;
            color: #92400E;
            border-color: #FCD34D;
        }

        .header-button.dashboard:hover {
            background: #FCD34D;
            border-color: #F59E0B;
        }

        .header-button.logout {
            background: #F8F9FB;
            color: #E53E3E;
        }

        .header-button.logout:hover {
            background: #FEEBEB;
            color: #C53030;
            border-color: #FBD3DA;
        }

        .user-greeting {
            font-size: 14px;
            color: #4A5568;
            font-weight: 700;
            margin-right: 5px;
            white-space: nowrap;
        }

        /* Clickable word style */
        .clickable-word {
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
            transition: color 0.2s;
        }

        .clickable-word:hover {
            color: #667EEA;
        }

        /* Dictionary popup */
        #dictionary-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 10001;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        #dictionary-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* Welcome Banner */
        .welcome-banner {
            background: linear-gradient(135deg, #3498DB 0%, #2980B9 100%);
            color: white;
            padding: 40px;
            border-radius: 12px;
            margin-bottom: 40px;
            text-align: center;
        }

        .welcome-title {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 10px;
        }

        .welcome-subtitle {
            font-size: 18px;
            font-weight: 600;
            opacity: 0.95;
        }

        /* Section Headers */
        .section {
            margin-bottom: 50px;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #E5E9F2;
        }

        .section-icon {
            font-size: 26px;
        }

        .section-title {
            font-size: 22px;
            font-weight: 800;
            color: #1A202C;
            letter-spacing: -0.02em;
        }

        /* Course Grid */
        .course-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        /* Course Card */
        .course-card {
            background: #FFFFFF;
            border: 1px solid #E5E9F2;
            border-radius: 12px;
            padding: 0;
            text-decoration: none;
            color: inherit;
            display: block;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .course-card:hover {
            border-color: #667EEA;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.12);
            transform: translateY(-2px);
        }

        .course-header {
            padding: 28px;
            background: linear-gradient(135deg, #F8F9FB 0%, #FFFFFF 100%);
            border-bottom: 1px solid #E5E9F2;
        }

        .course-icon {
            font-size: 48px;
            margin-bottom: 12px;
            display: block;
        }

        .course-title {
            font-size: 20px;
            font-weight: 800;
            color: #1A202C;
            margin-bottom: 8px;
            letter-spacing: -0.01em;
        }

        .course-level {
            display: inline-block;
            background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%);
            color: white;
            padding: 5px 14px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .course-body {
            padding: 28px;
        }

        .course-description {
            font-size: 15px;
            color: #4A5568;
            line-height: 1.7;
            margin-bottom: 18px;
        }

        .course-meta {
            display: flex;
            gap: 18px;
            font-size: 13px;
            color: #718096;
            font-weight: 600;
            padding-top: 18px;
            border-top: 1px solid #E5E9F2;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Quick Links Section */
        .quick-links {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 40px;
        }

        .quick-link {
            background: #FFFFFF;
            border: 1px solid #E5E9F2;
            border-radius: 10px;
            padding: 20px;
            text-decoration: none;
            color: inherit;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .quick-link:hover {
            border-color: #667EEA;
            background: #F8F9FB;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.12);
            transform: translateY(-1px);
        }

        .quick-link-icon {
            font-size: 32px;
            flex-shrink: 0;
        }

        .quick-link-text {
            flex: 1;
        }

        .quick-link-title {
            font-size: 15px;
            font-weight: 700;
            color: #1A202C;
            margin-bottom: 3px;
        }

        .quick-link-desc {
            font-size: 13px;
            color: #718096;
        }

        /* Info Box */
        .info-box {
            background: linear-gradient(135deg, #FFF9E6 0%, #FFF3CD 100%);
            border-left: 4px solid #F59E0B;
            padding: 20px 24px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .info-box p {
            font-size: 15px;
            color: #92400E;
            font-weight: 600;
            margin: 0;
            line-height: 1.6;
        }
        
        /* Ticker */
        #latest-updates-ticker {
            position: fixed;
            top: 20px; 
            right: 50%;
            margin-right: -580px;
            z-index: 1000;
            cursor: pointer;
            background: #FFC107;
            color: #92400E;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 800;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, background-color 0.2s, opacity 0.2s;
            border: 2px solid #F59E0B;
            animation: pulse 2s infinite ease-in-out;
            text-decoration: none;
            white-space: nowrap;
            max-width: 450px;
            text-overflow: ellipsis;
            overflow: hidden;
            display: inline-block;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); }
            50% { transform: scale(1.03); box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.6); }
            100% { transform: scale(1); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); }
        }

        #latest-updates-ticker:hover {
            background: #FFD54F;
            transform: scale(1.05);
            animation: none;
        }
        
        /* Footer */
        .footer {
            background: #FFFFFF;
            border-top: 1px solid #E5E9F2;
            padding: 32px 20px;
            margin-top: 60px;
            text-align: center;
        }

        .footer-text {
            font-size: 14px;
            color: #718096;
        }

        /* Responsive */
        @media (max-width: 1240px) {
            #latest-updates-ticker {
                right: 20px;
                margin-right: 0;
            }
        }

        @media (max-width: 768px) {
            .user-greeting {
                display: none;
            }
            
            .header-button {
                padding: 6px 10px;
                font-size: 12px;
            }

            .welcome-banner {
                padding: 30px 20px;
            }

            .welcome-title {
                font-size: 26px;
            }

            .welcome-subtitle {
                font-size: 16px;
            }

            .course-grid {
                grid-template-columns: 1fr;
            }

            .quick-links {
                grid-template-columns: 1fr;
            }

            .section-title {
                font-size: 20px;
            }
        }

        @media (max-width: 480px) {
            .header-content {
                gap: 10px;
            }

            .logo {
                font-size: 28px;
            }

            .site-title {
                font-size: 18px;
            }

            .container {
                padding: 20px 15px 80px 15px; /* Add bottom padding for ticker */
            }

            .course-header,
            .course-body {
                padding: 20px;
            }
            
            /* Move ticker to bottom on mobile */
            #latest-updates-ticker {
                top: auto;
                bottom: 0;
                right: 0;
                left: 0;
                margin-right: 0;
                border-radius: 0;
                font-size: 13px;
                padding: 12px 15px;
                max-width: 100%;
                text-align: center;
                border: none;
                border-top: 2px solid #F59E0B;
                box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.1);
            }
        }
        
        /* Landscape orientation on phones */
        @media (max-width: 896px) and (max-height: 480px) and (orientation: landscape) {
            #latest-updates-ticker {
                top: auto;
                bottom: 0;
                right: 0;
                left: 0;
                margin-right: 0;
                border-radius: 0;
                font-size: 12px;
                padding: 10px 15px;
                max-width: 100%;
                text-align: center;
                border: none;
                border-top: 2px solid #F59E0B;
                box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.1);
            }
            
            .container {
                padding-bottom: 70px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <span class="logo">üòé</span>
                <a href="/" class="site-title">English For Cool Dudes</a>
            
                <div id="logged-out-buttons" class="header-buttons" style="display: none;">
                    <a href="/login/" class="header-button login">Login</a>
                    <a href="/signup/" class="header-button signup">Sign Up</a>
                </div>

                <div id="logged-in-buttons" class="header-buttons" style="display: none;">
                    <span class="user-greeting" id="user-greeting">Hey Cool Dude! üëã</span>
                    <a href="/dashboard/" class="header-button dashboard">My Dashboard</a>
                    <button id="logout-btn" class="header-button logout">Sign Out</button>
                </div>
            </div>
        </div>
    </header>

    <div id="dictionary-overlay"></div>
    <div id="dictionary-popup">
        <div id="dictionary-content"></div>
    </div>

    <a href="/crocs/" id="latest-updates-ticker">
        üòé NEW! ADVANCED: Crocs' China Strategy üêä
    </a>

    <main class="container">
        <div class="info-box">
            <p>‚úç Sign Up, Log in, Save Your Lessons and Words to Your Dashboard!</p>
        </div>

        <section class="section">
            <div class="section-header">
                <span class="section-icon">üíº</span>
                <h2 class="section-title">Specialized English</h2>
            </div>
            <div class="course-grid">
                <a href="/business/" class="course-card">
                    <div class="course-header">
                        <span class="course-icon">üíº</span>
                        <h3 class="course-title">Business English</h3>
                        <span class="course-level">Professional</span>
                    </div>
                    <div class="course-body">
                        <p class="course-description">
                            Master professional communication for meetings, emails, presentations, and business negotiations.
                        </p>
                        <div class="course-meta">
                            <span class="meta-item">üìö Multiple lessons</span>
                            <span class="meta-item">‚è±Ô∏è Self-paced</span>
                        </div>
                    </div>
                </a>

                <a href="/tax/" class="course-card">
                    <div class="course-header">
                        <span class="course-icon">üí∞</span>
                        <h3 class="course-title">Tax English</h3>
                        <span class="course-level">Specialist</span>
                    </div>
                    <div class="course-body">
                        <p class="course-description">
                            Learn tax terminology, concepts, and documentation language for accounting professionals.
                        </p>
                        <div class="course-meta">
                            <span class="meta-item">üìö Multiple lessons</span>
                            <span class="meta-item">‚è±Ô∏è Self-paced</span>
                        </div>
                    </div>
                </a>

                <a href="/legal/" class="course-card">
                    <div class="course-header">
                        <span class="course-icon">‚öñÔ∏è</span>
                        <h3 class="course-title">Legal English</h3>
                        <span class="course-level">Specialist</span>
                    </div>
                    <div class="course-body">
                        <p class="course-description">
                            Navigate legal terminology, contracts, and documentation with confidence and precision.
                        </p>
                        <div class="course-meta">
                            <span class="meta-item">üìö Multiple lessons</span>
                            <span class="meta-item">‚è±Ô∏è Self-paced</span>
                        </div>
                    </div>
                </a>
            </div>
        </section>

        <section class="section">
            <div class="section-header">
                <span class="section-icon">üìñ</span>
                <h2 class="section-title">General English Courses</h2>
            </div>
            <div class="course-grid">
                <a href="/beginner/" class="course-card">
                    <div class="course-header">
                        <span class="course-icon">üå±</span>
                        <h3 class="course-title">Beginner Course</h3>
                        <span class="course-level">A1-A2</span>
                    </div>
                    <div class="course-body">
                        <p class="course-description">
                            Start your English journey. Learn basic grammar, vocabulary, and everyday conversation skills.
                        </p>
                        <div class="course-meta">
                            <span class="meta-item">üìö Foundation level</span>
                            <span class="meta-item">‚è±Ô∏è Step by step</span>
                        </div>
                    </div>
                </a>

                <a href="/intermediate/" class="course-card">
                    <div class="course-header">
                        <span class="course-icon">üöÄ</span>
                        <h3 class="course-title">Intermediate Course</h3>
                        <span class="course-level">B1-B2</span>
                    </div>
                    <div class="course-body">
                        <p class="course-description">
                            Build confidence with complex grammar and expand your vocabulary for real-world situations.
                        </p>
                        <div class="course-meta">
                            <span class="meta-item">üìö Expanding skills</span>
                            <span class="meta-item">‚è±Ô∏è Progressive</span>
                        </div>
                    </div>
                </a>

                <a href="/advanced/" class="course-card">
                    <div class="course-header">
                        <span class="course-icon">üéØ</span>
                        <h3 class="course-title">Advanced Course</h3>
                        <span class="course-level">C1-C2</span>
                    </div>
                    <div class="course-body">
                        <p class="course-description">
                            Master sophisticated expressions, idioms, and achieve native-like fluency in British English.
                        </p>
                        <div class="course-meta">
                            <span class="meta-item">üìö Mastery level</span>
                            <span class="meta-item">‚è±Ô∏è Advanced</span>
                        </div>
                    </div>
                </a>
            </div>
        </section>

        <section class="section">
            <div class="section-header">
                <span class="section-icon">‚ö°</span>
                <h2 class="section-title">Quick Access</h2>
            </div>
            <div class="quick-links">
                <a href="/chat/" class="quick-link">
                    <span class="quick-link-icon">üí¨</span>
                    <div class="quick-link-text">
                        <div class="quick-link-title">Chat with Dudebot</div>
                        <div class="quick-link-desc">Practise conversations with AI</div>
                    </div>
                </a>
            </div>
        </section>
    </main>

    <footer class="footer">
        <p class="footer-text">¬© 2025 English For Cool Dudes - Learn British English effectively</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://knwgmrgwbpchqyqxbxea.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtud2dtcmd3YnBjaHF5cXhieGVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MDkyODgsImV4cCI6MjA3ODA4NTI4OH0.qnp2ScwSE77_idmPhpLE98sr46WvLpKtg6refFfC7s8';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Dictionary functionality
        async function lookupWord(word) {
            const popup = document.getElementById('dictionary-popup');
            const overlay = document.getElementById('dictionary-overlay');
            const content = document.getElementById('dictionary-content');
            
            content.innerHTML = '<p style="text-align: center;">Loading...</p>';
            popup.style.display = 'block';
            overlay.style.display = 'block';
            
            try {
                const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`);
                
                if (!response.ok) {
                    content.innerHTML = `
                        <h2 style="color: #DC2626; margin-bottom: 15px;">Word not found</h2>
                        <p style="color: #666;">Sorry, we couldn't find a definition for "${word}".</p>
                        <button onclick="closeDictionary()" style="
                            background: #667EEA;
                            color: white;
                            border: none;
                            padding: 12px 30px;
                            border-radius: 8px;
                            font-weight: 700;
                            cursor: pointer;
                            font-size: 16px;
                            margin-top: 20px;
                        ">Close</button>
                    `;
                    return;
                }
                const data = await response.json();
                const entry = data[0];
                let html = `<h2 style="color: #1A202C; margin-bottom: 20px;">${entry.word}</h2>`;

                if (entry.phonetic) {
                    html += `<p style="color: #718096; margin-bottom: 20px; font-style: italic;">${entry.phonetic}</p>`;
                }

                entry.meanings.forEach(meaning => {
                    html += `<div style="margin-bottom: 20px;">`;
                    html += `<h3 style="color: #667EEA; margin-bottom: 10px;">${meaning.partOfSpeech}</h3>`;
                    meaning.definitions.slice(0, 3).forEach((def, idx) => {
                        html += `<p style="margin-bottom: 10px;"><strong>${idx + 1}.</strong> ${def.definition}</p>`;
                        if (def.example) {
                            html += `<p style="color: #718096; font-style: italic; margin-left: 20px; margin-bottom: 10px;">Example: "${def.example}"</p>`;
                        }
                    });
                    html += `</div>`;
                });

                html += `<button onclick="closeDictionary()" style="
                    background: #667EEA;
                    color: white;
                    border: none;
                    padding: 12px 30px;
                    border-radius: 8px;
                    font-weight: 700;
                    cursor: pointer;
                    font-size: 16px;
                    margin-top: 20px;
                ">Close</button>`;
                content.innerHTML = html;

            } catch (error) {
                console.error('Dictionary lookup error:', error);
                content.innerHTML = `
                    <h2 style="color: #DC2626; margin-bottom: 15px;">Error</h2>
                    <p style="color: #666;">Sorry, there was an error looking up this word.</p>
                    <button onclick="closeDictionary()" style="
                        background: #667EEA;
                        color: white;
                        border: none;
                        padding: 12px 30px;
                        border-radius: 8px;
                        font-weight: 700;
                        cursor: pointer;
                        font-size: 16px;
                        margin-top: 20px;
                    ">Close</button>
                `;
            }
        }

        function closeDictionary() {
            document.getElementById('dictionary-popup').style.display = 'none';
            document.getElementById('dictionary-overlay').style.display = 'none';
        }

        document.getElementById('dictionary-overlay').addEventListener('click', closeDictionary);

        async function checkForMistakesOnHomepage() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return;

                const { data: mistakes, error } = await supabase
                    .from('user_mistakes')
                    .select('id, word, definition, word_type, lesson, lesson_link, last_made_at') // IMPORTANT: Added 'id' for better tracking/deletion
                    .eq('user_id', user.id)
                    .order('last_made_at', { ascending: false })
                    .limit(10);

                if (error) {
                    console.error('Error fetching mistakes:', error);
                    return;
                }

                if (mistakes && mistakes.length > 0) {
                    showMistakeReminderHomepage(mistakes);
                }
            } catch (error) {
                console.error('Error checking mistakes:', error);
            }
        }

        // 2. ENHANCED: Show mistake reminder with dictionary and optional practice function
        function showMistakeReminderHomepage(mistakes) {
            // Group by lesson for better organization
            const lessonGroups = {};
            mistakes.forEach(m => {
                if (!lessonGroups[m.lesson]) {
                    lessonGroups[m.lesson] = { words: [], link: m.lesson_link };
                }
                lessonGroups[m.lesson].words.push(m);
            });

            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 600px;
                width: 90%;
                max-height: 85vh;
                overflow-y: auto;
            `;

            let lessonHTML = '';
            for (const [lessonName, lessonData] of Object.entries(lessonGroups)) {
                const wordList = lessonData.words.map(w =>
                    `<strong class="clickable-word" data-word="${w.word}" data-definition="${w.definition || 'No definition available'}" data-type="${w.word_type || 'word'}">${w.word}</strong>`
                ).join(', ');
                
                lessonHTML += `
                    <div style="margin: 15px 0; padding: 15px; background: #FEF2F2; border-radius: 8px; border-left: 4px solid #DC2626;">
                        <p style="font-size: 14px; color: #666; margin-bottom: 8px; font-weight: 600;">
                            üìö ${lessonName} ${lessonData.link ? `<a href="${lessonData.link}" style="color: #667EEA; text-decoration: none; margin-left: 8px; font-size: 12px;">‚Üó Revisit</a>` : ''}
                        </p>
                        <p style="color: #DC2626; font-weight: 600; line-height: 1.6;">${wordList}</p>
                    </div>
                `;
            }

            popup.innerHTML = `
                <h2 style="color: #DC2626; margin-bottom: 15px; font-size: 24px; font-weight: 800;"> 
                    üéØ Words to Review! (${mistakes.length}) 
                </h2>
                <p style="color: #666; margin-bottom: 20px; line-height: 1.6;"> 
                    You had trouble with these words recently. <strong>Click any word</strong> to see its definition: 
                </p>
                ${lessonHTML}
                
                <div style="margin-top: 15px; background: #F8F9FB; padding: 15px; border-radius: 8px; border: 1px solid #E5E9F2;">
                    <p style="font-weight: 700; color: #1A202C; margin-bottom: 10px;">
                        ‚úÖ Manage Your List (Clear Mastered Words):
                    </p>
                    <div id="word-checkboxes" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px;">
                        </div>
                    <button id="clear-selected-btn" style="
                        background: #DC2626;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 8px;
                        font-weight: 700;
                        cursor: pointer;
                        font-size: 14px;
                        margin-top: 15px;
                        width: 100%;
                        opacity: 0.6;
                        pointer-events: none;
                        transition: opacity 0.2s;
                    ">üóëÔ∏è Clear Selected Words</button>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                    <button id="practice-btn" style="
                        background: #667EEA;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-weight: 700;
                        cursor: pointer;
                        font-size: 16px;
                        flex: 1;
                        min-width: 140px;
                    ">üî• Practice Now</button>
                    
                    <button id="got-it-btn" style="
                        background: #E5E9F2;
                        color: #4A5568;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-weight: 700;
                        cursor: pointer;
                        font-size: 16px;
                        flex: 1;
                        min-width: 140px;
                    ">Got it! üëç</button>
                </div>
            `;

            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 9999;
            `;

            document.body.appendChild(overlay);
            document.body.appendChild(popup);

            // Add click handlers for clickable words
            popup.querySelectorAll('.clickable-word').forEach(wordEl => {
                wordEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const definition = `<div style="text-align: left;">
                        <strong style="font-size: 16px; color: #1A202C;">${wordEl.dataset.word}</strong>
                        <span style="color: #718096; font-style: italic; margin-left: 8px;">(${wordEl.dataset.type})</span>
                        <p style="margin-top: 8px; color: #4A5568; line-height: 1.5;">${wordEl.dataset.definition}</p>
                    </div>`;

                    // Close any existing dictionary popup
                    const existingDict = document.getElementById('mistake-dictionary-popup');
                    if (existingDict) existingDict.remove();

                    // Create new dictionary popup
                    const dictPopup = document.createElement('div');
                    dictPopup.id = 'mistake-dictionary-popup';
                    dictPopup.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: white;
                        padding: 20px;
                        border-radius: 12px;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.4);
                        z-index: 10002;
                        max-width: 400px;
                        width: 85%;
                        border: 3px solid #667EEA;
                    `;
                    dictPopup.innerHTML = definition + `
                        <button onclick="this.parentElement.remove()" style="
                            background: #667EEA;
                            color: white;
                            border: none;
                            padding: 8px 20px;
                            border-radius: 6px;
                            font-weight: 700;
                            cursor: pointer;
                            font-size: 14px;
                            margin-top: 15px;
                            width: 100%;
                        ">Got it</button>
                    `;
                    document.body.appendChild(dictPopup);
                });
            });

            document.getElementById('practice-btn').addEventListener('click', () => {
                alert('Practice functionality coming soon!');
                popup.remove();
                overlay.remove();
            });

            document.getElementById('got-it-btn').addEventListener('click', () => {
                popup.remove();
                overlay.remove();
            });
            
            // --- NEW LOGIC: Checkbox creation and Clear button logic ---
            const wordCheckboxes = document.getElementById('word-checkboxes');
            const clearButton = document.getElementById('clear-selected-btn');
            
            // Use a Map to filter down to unique words/lessons for the checkboxes
            const uniqueMistakesMap = new Map();
            mistakes.forEach(m => {
                // Use a combined key of word and lesson link to handle the same word in different lessons
                const key = `${m.word}::${m.lesson_link || 'no_link'}`; 
                if (!uniqueMistakesMap.has(key)) {
                    uniqueMistakesMap.set(key, m);
                }
            });

            // Populate checkboxes
            Array.from(uniqueMistakesMap.values()).forEach((m, index) => {
                const checkboxId = `clear-word-${index}`;
                
                // This attribute stores the unique identifier (word::lessonLink) for deletion
                const dataAttribute = `${m.word}::${m.lesson_link || 'no_link'}`; 

                wordCheckboxes.innerHTML += `
                    <div style="display: flex; align-items: center; gap: 5px; background: white; padding: 5px; border-radius: 4px; border: 1px solid #E5E9F2;">
                        <input type="checkbox" id="${checkboxId}" data-clear-word="${dataAttribute}" style="width: 16px; height: 16px;">
                        <label for="${checkboxId}" style="font-size: 13px; font-weight: 600; color: #4A5568; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; cursor: pointer;" title="${m.word}">${m.word}</label>
                    </div>
                `;
            });

            // Checkbox change listener (Enables/Disables Clear button)
            wordCheckboxes.addEventListener('change', () => {
                const checkedCount = wordCheckboxes.querySelectorAll('input:checked').length;
                if (checkedCount > 0) {
                    clearButton.style.opacity = '1';
                    clearButton.style.pointerEvents = 'auto';
                } else {
                    clearButton.style.opacity = '0.6';
                    clearButton.style.pointerEvents = 'none';
                }
            });

            // Clear button click listener
            clearButton.addEventListener('click', async () => {
                const wordsToClear = Array.from(wordCheckboxes.querySelectorAll('input:checked')).map(input => {
                    const [word, lessonLink] = input.dataset.clearWord.split('::');
                    return { word, lessonLink: lessonLink === 'no_link' ? null : lessonLink };
                });

                if (wordsToClear.length > 0) {
                    clearButton.textContent = 'Clearing...';
                    clearButton.disabled = true;
                    await clearUserMistakes(wordsToClear);
                    
                    // Close and re-run check to update the list immediately
                    popup.remove();
                    overlay.remove();
                    setTimeout(() => checkForMistakesOnHomepage(), 500);
                }
            });
            // --- END NEW LOGIC ---
        }
        
        // 6. NEW: Function to delete mistakes by word and lesson_link
        async function clearUserMistakes(wordsToClear) {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    alert('You must be logged in to clear mistakes.');
                    return;
                }

                const deletePromises = wordsToClear.map(({ word, lessonLink }) => {
                    // Find ALL mistakes for this specific user/word/lesson combination and delete them
                    let query = supabase.from('user_mistakes')
                        .delete()
                        .eq('user_id', user.id)
                        .eq('word', word);
                        
                    if (lessonLink) { 
                        query = query.eq('lesson_link', lessonLink);
                    } else {
                        query = query.is('lesson_link', null);
                    }
                        
                    return query;
                });
                
                // Execute all deletion promises concurrently
                await Promise.all(deletePromises);
                
                console.log('Successfully cleared selected words from practice list.');
                alert('Selected words have been removed from your practice list!');
                
            } catch (error) {
                console.error('Error clearing mistakes:', error);
                alert('Failed to clear words. Please try again.');
            }
        }
        
        // Auth header initialization
        async function initializeAuthHeader() {
            const loggedOutButtons = document.getElementById('logged-out-buttons');
            const loggedInButtons = document.getElementById('logged-in-buttons');
            const userGreeting = document.getElementById('user-greeting');
            const logoutBtn = document.getElementById('logout-btn');

            if (!loggedOutButtons || !loggedInButtons || !logoutBtn || !userGreeting) {
                console.error("Auth header elements not found.");
                return;
            }

            try {
                const { data: { user } } = await supabase.auth.getUser();

                if (user) {
                    const emailParts = user.email.split('@');
                    const username = emailParts[0];
                    userGreeting.textContent = `Hey ${username}! üëã`;
                    if (loggedOutButtons) loggedOutButtons.style.display = 'none';
                    if (loggedInButtons) loggedInButtons.style.display = 'flex';
                } else {
                    console.log('User not logged in');
                    if (loggedOutButtons) loggedOutButtons.style.display = 'flex';
                    if (loggedInButtons) loggedInButtons.style.display = 'none';
                }
            } catch (err) {
                console.error('Error checking auth:', err);
                if (loggedOutButtons) loggedOutButtons.style.display = 'flex';
                if (loggedInButtons) loggedInButtons.style.display = 'none';
            }

            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    try {
                        const { error } = await supabase.auth.signOut();
                        if (error) {
                            console.error('Logout error:', error);
                            alert('Logout failed. Please try again.');
                        } else {
                            window.location.reload();
                        }
                    } catch (err) {
                        console.error('Unexpected logout error:', err);
                    }
                });
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await initializeAuthHeader();
            
            // This line triggers the mistake popup!
            setTimeout(() => checkForMistakesOnHomepage(), 1500);
        });
    </script>
</body>
</html>
