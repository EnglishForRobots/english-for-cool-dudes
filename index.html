<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="/favicon.png" sizes="32x32">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="manifest" href="/manifest.json">
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English For Cool Dudes</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: #F8F9FB;
            color: #2C3E50;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* === REUSABLE HEADER STYLES === */
        .header {
            background: #FFFFFF;
            border-bottom: 1px solid #E5E9F2;
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
            margin-bottom: 20px;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .site-title {
            font-size: 20px;
            font-weight: 800;
            color: #1A202C;
            letter-spacing: -0.02em;
            text-decoration: none;
        }

        .header-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-button {
            text-decoration: none;
            padding: 7px 14px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 700;
            transition: all 0.2s;
            white-space: nowrap;
            cursor: pointer;
            border: 1px solid #E5E9F2;
            background: transparent;
        }

        .header-button.login {
            background: #F8F9FB;
            color: #4A5568;
        }

        .header-button.login:hover {
            background: #FFFFFF;
            color: #2C3E50;
            border-color: #718096;
        }

        .header-button.signup {
            background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%);
            color: white;
            border: 1px solid transparent;
        }

        .header-button.signup:hover {
            background: linear-gradient(135deg, #5A6AD0 0%, #6D4396 100%);
            box-shadow: 0 2px 5px rgba(102, 126, 234, 0.4);
        }

        .header-button.dashboard {
            background: #FFFBEA;
            color: #92400E;
            border-color: #FCD34D;
        }

        .header-button.dashboard:hover {
            background: #FCD34D;
            border-color: #F59E0B;
        }

        .header-button.logout {
            background: #F8F9FB;
            color: #E53E3E;
        }

        .header-button.logout:hover {
            background: #FEEBEB;
            color: #C53030;
            border-color: #FBD3DA;
        }

        .user-greeting {
            font-size: 14px;
            color: #4A5568;
            font-weight: 700;
            margin-right: 5px;
            white-space: nowrap;
        }

        /* Clickable word style */
        .clickable-word {
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
            transition: color 0.2s;
        }

        .clickable-word:hover {
            color: #667EEA;
        }

        /* Dictionary popup */
        #dictionary-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 10001;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        #dictionary-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* Welcome Banner */
        .welcome-banner {
            background: linear-gradient(135deg, #3498DB 0%, #2980B9 100%);
            color: white;
            padding: 40px;
            border-radius: 12px;
            margin-bottom: 40px;
            text-align: center;
        }

        .welcome-title {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 10px;
        }

        .welcome-subtitle {
            font-size: 18px;
            font-weight: 600;
            opacity: 0.95;
        }

        /* Section Headers */
        .section {
            margin-bottom: 50px;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #E5E9F2;
        }

        .section-icon {
            font-size: 26px;
        }

        .section-title {
            font-size: 22px;
            font-weight: 800;
            color: #1A202C;
            letter-spacing: -0.02em;
        }

        /* Course Grid */
        .course-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        /* Course Card */
        .course-card {
            background: #FFFFFF;
            border: 1px solid #E5E9F2;
            border-radius: 12px;
            padding: 0;
            text-decoration: none;
            color: inherit;
            display: block;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .course-card:hover {
            border-color: #667EEA;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.12);
            transform: translateY(-2px);
        }

        .course-header {
            padding: 28px;
            background: linear-gradient(135deg, #F8F9FB 0%, #FFFFFF 100%);
            border-bottom: 1px solid #E5E9F2;
        }

        .course-icon {
            font-size: 48px;
            margin-bottom: 12px;
            display: block;
        }

        .course-title {
            font-size: 20px;
            font-weight: 800;
            color: #1A202C;
            margin-bottom: 8px;
            letter-spacing: -0.01em;
        }

        .course-level {
            display: inline-block;
            background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%);
            color: white;
            padding: 5px 14px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .course-body {
            padding: 28px;
        }

        .course-description {
            font-size: 15px;
            color: #4A5568;
            line-height: 1.7;
            margin-bottom: 18px;
        }

        .course-meta {
            display: flex;
            gap: 18px;
            font-size: 13px;
            color: #718096;
            font-weight: 600;
            padding-top: 18px;
            border-top: 1px solid #E5E9F2;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Quick Links Section */
        .quick-links {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 40px;
        }

        .quick-link {
            background: #FFFFFF;
            border: 1px solid #E5E9F2;
            border-radius: 10px;
            padding: 20px;
            text-decoration: none;
            color: inherit;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .quick-link:hover {
            border-color: #667EEA;
            background: #F8F9FB;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.12);
            transform: translateY(-1px);
        }

        .quick-link-icon {
            font-size: 32px;
            flex-shrink: 0;
        }

        .quick-link-text {
            flex: 1;
        }

        .quick-link-title {
            font-size: 15px;
            font-weight: 700;
            color: #1A202C;
            margin-bottom: 3px;
        }

        .quick-link-desc {
            font-size: 13px;
            color: #718096;
        }

        /* Info Box */
        .info-box {
            background: linear-gradient(135deg, #FFF9E6 0%, #FFF3CD 100%);
            border-left: 4px solid #F59E0B;
            padding: 20px 24px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .info-box p {
            font-size: 15px;
            color: #92400E;
            font-weight: 600;
            margin: 0;
            line-height: 1.6;
        }
        
        /* Ticker */
        #latest-updates-ticker {
            position: fixed;
            top: 20px; 
            right: 50%;
            margin-right: -580px;
            z-index: 1000;
            cursor: pointer;
            background: #FFC107;
            color: #92400E;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 800;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, background-color 0.2s, opacity 0.2s;
            border: 2px solid #F59E0B;
            animation: pulse 2s infinite ease-in-out;
            text-decoration: none;
            white-space: nowrap;
            max-width: 450px;
            text-overflow: ellipsis;
            overflow: hidden;
            display: inline-block;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); }
            50% { transform: scale(1.03); box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.6); }
            100% { transform: scale(1); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); }
        }

        #latest-updates-ticker:hover {
            background: #FFD54F;
            transform: scale(1.05);
            animation: none;
        }
        
        /* Footer */
        .footer {
            background: #FFFFFF;
            border-top: 1px solid #E5E9F2;
            padding: 32px 20px;
            margin-top: 60px;
            text-align: center;
        }

        .footer-text {
            font-size: 14px;
            color: #718096;
        }

        /* Responsive */
        @media (max-width: 1240px) {
            #latest-updates-ticker {
                right: 20px;
                margin-right: 0;
            }
        }

        @media (max-width: 768px) {
            .user-greeting {
                display: none;
            }
            
            .header-button {
                padding: 6px 10px;
                font-size: 12px;
            }

            .welcome-banner {
                padding: 30px 20px;
            }

            .welcome-title {
                font-size: 26px;
            }

            .welcome-subtitle {
                font-size: 16px;
            }

            .course-grid {
                grid-template-columns: 1fr;
            }

            .quick-links {
                grid-template-columns: 1fr;
            }

            .section-title {
                font-size: 20px;
            }
        }

        @media (max-width: 480px) {
            .header-content {
                gap: 10px;
            }

            .logo {
                font-size: 28px;
            }

            .site-title {
                font-size: 18px;
            }

            .container {
                padding: 20px 15px 80px 15px; /* Add bottom padding for ticker */
            }

            .course-header,
            .course-body {
                padding: 20px;
            }
            
            /* Move ticker to bottom on mobile */
            #latest-updates-ticker {
                top: auto;
                bottom: 0;
                right: 0;
                left: 0;
                margin-right: 0;
                border-radius: 0;
                font-size: 13px;
                padding: 12px 15px;
                max-width: 100%;
                text-align: center;
                border: none;
                border-top: 2px solid #F59E0B;
                box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.1);
            }
        }
        
        /* Landscape orientation on phones */
        @media (max-width: 896px) and (max-height: 480px) and (orientation: landscape) {
            #latest-updates-ticker {
                top: auto;
                bottom: 0;
                right: 0;
                left: 0;
                margin-right: 0;
                border-radius: 0;
                font-size: 12px;
                padding: 10px 15px;
                max-width: 100%;
                text-align: center;
                border: none;
                border-top: 2px solid #F59E0B;
                box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.1);
            }
            
            .container {
                padding-bottom: 70px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <span class="logo">üòé</span>
                <a href="/" class="site-title">English For Cool Dudes</a>
            
                <div id="logged-out-buttons" class="header-buttons" style="display: none;">
                    <a href="/login/" class="header-button login">Login</a>
                    <a href="/signup/" class="header-button signup">Sign Up</a>
                </div>

                <div id="logged-in-buttons" class="header-buttons" style="display: none;">
                    <span class="user-greeting" id="user-greeting">Hey Cool Dude! üëã</span>
                    <a href="/dashboard/" class="header-button dashboard">My Dashboard</a>
                    <button id="logout-btn" class="header-button logout">Sign Out</button>
                </div>
            </div>
        </div>
    </header>

    <div id="dictionary-overlay"></div>
    <div id="dictionary-popup">
        <div id="dictionary-content"></div>
    </div>

    <a href="/crocs/" id="latest-updates-ticker">
        üòé NEW! ADVANCED: Crocs' China Strategy üêä
    </a>

    <main class="container">
        <div class="info-box">
            <p>‚úç Sign Up, Log in, Save Your Lessons and Words to Your Dashboard!</p>
        </div>

        <section class="section">
            <div class="section-header">
                <span class="section-icon">üíº</span>
                <h2 class="section-title">Specialized English</h2>
            </div>
            <div class="course-grid">
                <a href="/business/" class="course-card">
                    <div class="course-header">
                        <span class="course-icon">üíº</span>
                        <h3 class="course-title">Business English</h3>
                        <span class="course-level">Professional</span>
                    </div>
                    <div class="course-body">
                        <p class="course-description">
                            Master professional communication for meetings, emails, presentations, and business negotiations.
                        </p>
                        <div class="course-meta">
                            <span class="meta-item">üìö Multiple lessons</span>
                            <span class="meta-item">‚è±Ô∏è Self-paced</span>
                        </div>
                    </div>
                </a>

                <a href="/tax/" class="course-card">
                    <div class="course-header">
                        <span class="course-icon">üí∞</span>
                        <h3 class="course-title">Tax English</h3>
                        <span class="course-level">Specialist</span>
                    </div>
                    <div class="course-body">
                        <p class="course-description">
                            Learn tax terminology, concepts, and documentation language for accounting professionals.
                        </p>
                        <div class="course-meta">
                            <span class="meta-item">üìö Multiple lessons</span>
                            <span class="meta-item">‚è±Ô∏è Self-paced</span>
                        </div>
                    </div>
                </a>

                <a href="/legal/" class="course-card">
                    <div class="course-header">
                        <span class="course-icon">‚öñÔ∏è</span>
                        <h3 class="course-title">Legal English</h3>
                        <span class="course-level">Specialist</span>
                    </div>
                    <div class="course-body">
                        <p class="course-description">
                            Navigate legal terminology, contracts, and documentation with confidence and precision.
                        </p>
                        <div class="course-meta">
                            <span class="meta-item">üìö Multiple lessons</span>
                            <span class="meta-item">‚è±Ô∏è Self-paced</span>
                        </div>
                    </div>
                </a>
            </div>
        </section>

        <section class="section">
            <div class="section-header">
                <span class="section-icon">üìñ</span>
                <h2 class="section-title">General English Courses</h2>
            </div>
            <div class="course-grid">
                <a href="/beginner/" class="course-card">
                    <div class="course-header">
                        <span class="course-icon">üå±</span>
                        <h3 class="course-title">Beginner Course</h3>
                        <span class="course-level">A1-A2</span>
                    </div>
                    <div class="course-body">
                        <p class="course-description">
                            Start your English journey. Learn basic grammar, vocabulary, and everyday conversation skills.
                        </p>
                        <div class="course-meta">
                            <span class="meta-item">üìö Foundation level</span>
                            <span class="meta-item">‚è±Ô∏è Step by step</span>
                        </div>
                    </div>
                </a>

                <a href="/intermediate/" class="course-card">
                    <div class="course-header">
                        <span class="course-icon">üöÄ</span>
                        <h3 class="course-title">Intermediate Course</h3>
                        <span class="course-level">B1-B2</span>
                    </div>
                    <div class="course-body">
                        <p class="course-description">
                            Build confidence with complex grammar and expand your vocabulary for real-world situations.
                        </p>
                        <div class="course-meta">
                            <span class="meta-item">üìö Expanding skills</span>
                            <span class="meta-item">‚è±Ô∏è Progressive</span>
                        </div>
                    </div>
                </a>

                <a href="/advanced/" class="course-card">
                    <div class="course-header">
                        <span class="course-icon">üéØ</span>
                        <h3 class="course-title">Advanced Course</h3>
                        <span class="course-level">C1-C2</span>
                    </div>
                    <div class="course-body">
                        <p class="course-description">
                            Master sophisticated expressions, idioms, and achieve native-like fluency in British English.
                        </p>
                        <div class="course-meta">
                            <span class="meta-item">üìö Mastery level</span>
                            <span class="meta-item">‚è±Ô∏è Advanced</span>
                        </div>
                    </div>
                </a>
            </div>
        </section>

        <section class="section">
            <div class="section-header">
                <span class="section-icon">‚ö°</span>
                <h2 class="section-title">Quick Access</h2>
            </div>
            <div class="quick-links">
                <a href="/chat/" class="quick-link">
                    <span class="quick-link-icon">üí¨</span>
                    <div class="quick-link-text">
                        <div class="quick-link-title">Chat with Dudebot</div>
                        <div class="quick-link-desc">Practise conversations with AI</div>
                    </div>
                </a>
            </div>
        </section>
    </main>

    <footer class="footer">
        <p class="footer-text">¬© 2025 English For Cool Dudes - Learn British English effectively</p>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://knwgmrgwbpchqyqxbxea.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtud2dtcmd3YnBjaHF5cXhieGVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MDkyODgsImV4cCI6MjA3ODA4NTI4OH0.qnp2ScwSE77_idmPhpLE98sr46WvLpKtg6refFfC7s8';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Dictionary functions (kept as is)
        function showDictionary(word, definition, type) {
            document.getElementById('dictionary-popup').style.display = 'block';
            document.getElementById('dictionary-overlay').style.display = 'block';
            
            const content = document.getElementById('dictionary-content');
            content.innerHTML = `
                <h3 style="color: #667EEA; font-size: 20px; margin-bottom: 10px; font-weight: 800;">${word} <span style="font-size: 14px; color: #718096; font-weight: 600;">(${type})</span></h3>
                <p style="color: #4A5568; line-height: 1.7; margin-bottom: 20px;">${definition}</p>
                <button onclick="closeDictionary()" style="background: #E5E9F2; color: #4A5568; border: none; padding: 10px 30px; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 16px; margin-top: 20px; ">Close</button>
            `;
        }

        function closeDictionary() {
            document.getElementById('dictionary-popup').style.display = 'none';
            document.getElementById('dictionary-overlay').style.display = 'none';
        }
        document.getElementById('dictionary-overlay').addEventListener('click', closeDictionary);


        // --- NEW/UPDATED MISTAKE MANAGEMENT LOGIC ---

        // Function to update the state of the 'Clear Selected Words' button
        function handleCheckboxChange() {
            const popup = document.getElementById('mistake-reminder-popup');
            if (!popup) return;
            
            const clearSelectedBtn = popup.querySelector('#clear-selected-btn');
            const checkboxes = popup.querySelectorAll('.word-checkbox');
            
            const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
            
            // Logic to enable/disable button
            if (anyChecked) {
                clearSelectedBtn.style.opacity = '1.0';
                clearSelectedBtn.style.pointerEvents = 'auto';
                clearSelectedBtn.style.background = '#DC2626';
            } else {
                clearSelectedBtn.style.opacity = '0.6';
                clearSelectedBtn.style.pointerEvents = 'none';
                clearSelectedBtn.style.background = '#DC2626'; 
            }
        }

        // Function to clear only the selected mistake words
        async function clearSelectedMistakes() {
            const popup = document.getElementById('mistake-reminder-popup');
            if (!popup) return;

            const checkboxes = popup.querySelectorAll('.word-checkbox:checked');
            if (checkboxes.length === 0) {
                alert("Please select at least one word to clear.");
                return;
            }

            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    alert('You must be logged in to clear words.');
                    return;
                }

                const confirmed = confirm(`Are you sure you want to clear the ${checkboxes.length} selected word(s)?`);
                if (!confirmed) return;
                
                const deletePromises = [];

                checkboxes.forEach(checkbox => {
                    const [word, lesson] = checkbox.dataset.key.split('::');
                    
                    // Build the deletion promise for each checked word
                    deletePromises.push(
                        supabase
                            .from('user_mistakes')
                            .delete()
                            .eq('user_id', user.id)
                            .eq('word', word)
                            .eq('lesson', lesson)
                    );
                });

                // Execute all deletions concurrently
                const results = await Promise.all(deletePromises);
                let errorOccurred = false;

                results.forEach(result => {
                    if (result.error) {
                        console.error('Error clearing mistake:', result.error);
                        errorOccurred = true;
                    }
                });

                if (errorOccurred) {
                    alert('Finished clearing words, but some errors occurred. Check the console for details.');
                } else {
                    // Successfully cleared, now refresh the list
                    alert(`${checkboxes.length} word(s) successfully cleared!`);
                }

                // Close the current popup and re-run the check to display the new list
                document.getElementById('mistake-reminder-popup').remove();
                document.getElementById('mistake-reminder-overlay').remove();
                checkForMistakesOnHomepage();
                
            } catch (error) {
                console.error('Unexpected error during selected mistake clearing:', error);
                alert('An unexpected error occurred while clearing words.');
            }
        }


        // 1. Check for mistakes
        async function checkForMistakesOnHomepage() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return; // Only show for logged-in users

                const { data: mistakes, error } = await supabase
                    .from('user_mistakes')
                    .select('word, definition, word_type, lesson, lesson_link, last_made_at')
                    .eq('user_id', user.id)
                    .order('last_made_at', { ascending: false })
                    .limit(10); // Show up to 10 recent mistakes

                if (error) {
                    console.error('Error fetching mistakes:', error);
                    return;
                }

                if (mistakes && mistakes.length > 0) {
                    showMistakeReminderHomepage(mistakes);
                }

            } catch (error) {
                console.error('Error checking mistakes:', error);
            }
        }


        // 2. ENHANCED: Show mistake reminder with dictionary and new management options
        function showMistakeReminderHomepage(mistakes) {
            // Group by lesson for better organization
            const lessonGroups = {};
            mistakes.forEach(m => {
                if (!lessonGroups[m.lesson]) {
                    lessonGroups[m.lesson] = { words: [], link: m.lesson_link };
                }
                lessonGroups[m.lesson].words.push(m);
            });

            // Variables for both main word list and checkboxes
            let lessonHTML = '';
            let wordCheckboxesHTML = '';

            for (const [lessonName, lessonData] of Object.entries(lessonGroups)) {
                // --- Part 1: Word Display (The clickable dictionary list) ---
                const wordList = lessonData.words.map(w =>
                    `<strong class="clickable-word" data-word="${w.word}" data-definition="${w.definition || 'No definition available'}" data-type="${w.word_type || 'word'}">${w.word}</strong>`
                ).join(', ');

                lessonHTML += `
                    <div style="margin: 15px 0; padding: 15px; background: #FEF2F2; border-radius: 8px; border-left: 4px solid #DC2626;">
                        <p style="font-size: 14px; color: #666; margin-bottom: 8px; font-weight: 600;">
                            üìö ${lessonName}
                            ${lessonData.link ? `<a href="${lessonData.link}" style="color: #667EEA; text-decoration: none; margin-left: 8px; font-size: 12px;">‚Üó Revisit</a>` : ''}
                        </p>
                        <p style="color: #DC2626; font-weight: 600; line-height: 1.6;">${wordList}</p>
                    </div>
                `;
                
                // --- Part 2: Checkbox Creation (For the management box) ---
                lessonData.words.forEach(w => {
                    const uniqueKey = `${w.word}::${w.lesson}`;
                    wordCheckboxesHTML += `
                        <div style="display: flex; align-items: center;">
                            <input type="checkbox" id="check-${uniqueKey}" data-key="${uniqueKey}" class="word-checkbox" style="margin-right: 6px; cursor: pointer; transform: scale(1.1);">
                            <label for="check-${uniqueKey}" style="font-size: 14px; cursor: pointer; color: #4A5568;">${w.word}</label>
                        </div>
                    `;
                });
            }


            const popup = document.createElement('div');
            popup.id = 'mistake-reminder-popup'; // Added ID
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 600px;
                width: 90%;
                max-height: 85vh;
                overflow-y: auto;
            `;

            popup.innerHTML = `
                <h2 style="color: #DC2626; margin-bottom: 15px; font-size: 24px; font-weight: 800;"> üö® Don't Forget These Words! </h2>
                <p style="color: #666; margin-bottom: 20px;">We noticed you struggled with these words recently. Time to review and practice them!</p>

                ${lessonHTML}

                <div style="margin-top: 15px; background: #F8F9FB; padding: 15px; border-radius: 8px; border: 1px solid #E5E9F2;">
                    <p style="font-weight: 700; color: #1A202C; margin-bottom: 10px;">
                        ‚úÖ Manage Your List: (Individual Clear)
                    </p>
                    <div id="word-checkboxes" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px;">
                        ${wordCheckboxesHTML} 
                    </div>
                    <button id="clear-selected-btn" style="
                        background: #DC2626;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 8px;
                        font-weight: 700;
                        cursor: pointer;
                        font-size: 14px;
                        margin-top: 15px;
                        width: 100%;
                        opacity: 0.6;
                        pointer-events: none;
                        transition: opacity 0.2s;
                    ">üóëÔ∏è Clear Selected Words</button>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                    <button id="practice-btn" style="
                        background: #667EEA;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-weight: 700;
                        cursor: pointer;
                        font-size: 16px;
                        flex: 1;
                        min-width: 140px;
                    ">üî• Practice Now</button>
                    
                    <button id="got-it-btn" style="
                        background: #E5E9F2;
                        color: #4A5568;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-weight: 700;
                        cursor: pointer;
                        font-size: 16px;
                        flex: 1;
                        min-width: 140px;
                    ">Got it! üëç</button>
                    
                    <button id="clear-all-btn" style="
                        background: #DC2626;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-weight: 700;
                        cursor: pointer;
                        font-size: 16px;
                        flex: 1;
                        min-width: 140px;
                    ">üóëÔ∏è Clear All Words</button>
                </div>
            `;

            const overlay = document.createElement('div');
            overlay.id = 'mistake-reminder-overlay'; // Added ID
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 9999;
            `;

            document.body.appendChild(overlay);
            document.body.appendChild(popup);


            // --- NEW: Bind listeners for individual word clearing ---
            const clearSelectedBtn = popup.querySelector('#clear-selected-btn');
            const checkboxes = popup.querySelectorAll('.word-checkbox');

            // Checkbox change handler (for enabling/disabling the clear button)
            checkboxes.forEach(cb => cb.addEventListener('change', handleCheckboxChange));

            // Initial state setup for the button
            handleCheckboxChange(); 

            // Bind the clear selected button
            clearSelectedBtn.addEventListener('click', clearSelectedMistakes);
            // --- END NEW LISTENERS ---


            // Add click handlers for clickable words (Dictionary)
            popup.querySelectorAll('.clickable-word').forEach(wordEl => {
                wordEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showDictionary(wordEl.dataset.word, wordEl.dataset.definition, wordEl.dataset.type);
                });
            });

            // Practice button
            document.getElementById('practice-btn').addEventListener('click', () => {
                document.getElementById('mistake-reminder-popup').remove();
                document.getElementById('mistake-reminder-overlay').remove();
                startPractice(mistakes);
            });

            // Got it button (Dismiss)
            document.getElementById('got-it-btn').addEventListener('click', () => {
                document.getElementById('mistake-reminder-popup').remove();
                document.getElementById('mistake-reminder-overlay').remove();
            });
            
            // Clear All button logic (Kept as is, now has a dedicated ID)
            document.getElementById('clear-all-btn').addEventListener('click', async () => {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    alert('You must be logged in to clear your word list.');
                    return;
                }

                const confirmed = confirm(`Are you sure you want to clear ALL ${mistakes.length} words from your list? This cannot be undone.`);
                if (!confirmed) return;

                const { error } = await supabase
                    .from('user_mistakes')
                    .delete()
                    .eq('user_id', user.id);

                if (error) {
                    console.error('Error clearing all mistakes:', error);
                    alert('Failed to clear words. Please try again.');
                } else {
                    alert('Your entire word list has been cleared!');
                    document.getElementById('mistake-reminder-popup').remove();
                    document.getElementById('mistake-reminder-overlay').remove();
                    // No need to call checkForMistakesOnHomepage as the list is now empty
                }
            });
        }


        // 3. Practice Function (kept as is)
        function startPractice(mistakes) {
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            function generateGapSentence(word, definition) {
                // A dictionary of known sentence patterns to make the exercises better
                const sentencePatterns = {
                    'portrayal': [
                        `The media's <span class="practice-gap" data-answer="${word}">____</span> of the politician was very negative.`,
                        `The film offered a realistic <span class="practice-gap" data-answer="${word}">____</span> of working-class life.`,
                        `Artists have long debated the accurate <span class="practice-gap" data-answer="${word}">____</span> of emotion.`,
                    ],
                    'sculptures': [
                        `Rodin is famous for his bronze <span class="practice-gap" data-answer="${word}">____</span>.`,
                        `The museum displays ancient Roman <span class="practice-gap" data-answer="${word}">____</span> made of marble.`,
                        `The artist created a series of abstract <span class="practice-gap" data-answer="${word}">____</span> for the park.`,
                    ],
                    // === BRITISH FOOD IDIOMS VOCABULARY ===
                    'cream of the crop': [
                        `Only the <span class="practice-gap" data-answer="${word}">____</span> were invited to the exclusive dinner.`,
                        `They selected the <span class="practice-gap" data-answer="${word}">____</span> from the job applicants.`,
                        `This vineyard produces the <span class="practice-gap" data-answer="${word}">____</span> of its region.`,
                    ],
                    'take the biscuit': [
                        `His excuse for being late really <span class="practice-gap" data-answer="${word}">____</span>; it was unbelievable.`,
                        `Of all the bad jokes I've heard, that one definitely <span class="practice-gap" data-answer="${word}">____</span>.`,
                        `She won the argument, but the way she celebrated really <span class="practice-gap" data-answer="${word}">____</span>.`,
                    ],
                    'spill the beans': [
                        `Please don't <span class="practice-gap" data-answer="${word}">____</span> about the surprise party!`,
                        `He accidentally <span class="practice-gap" data-answer="${word}">____</span> about the company's new product.`,
                        `She promised not to <span class="practice-gap" data-answer="${word}">____</span> until the right time.`,
                    ],
                    'not my cup of tea': [
                        `I appreciate modern art, but it's <span class="practice-gap" data-answer="${word}">____</span>.`,
                        `Football is really <span class="practice-gap" data-answer="${word}">____</span>; I prefer rugby.`,
                        `Camping in the rain is <span class="practice-gap" data-answer="${word}">____</span>.`,
                    ],
                    'bring home the bacon': [
                        `It's a traditional expectation that the man <span class="practice-gap" data-answer="${word}">____</span>.`,
                        `After graduating, she got a high-paying job to <span class="practice-gap" data-answer="${word}">____</span> for her family.`,
                        `He works two jobs to <span class="practice-gap" data-answer="${word}">____</span> and pay the bills.`,
                    ],
                    // === BANK OF ENGLAND VOCABULARY (ADVANCED) ===
                    'Monetary Stability': [
                        `The Bank's main goal is to maintain <span class="practice-gap" data-answer="${word}">____</span> in the UK.`,
                        `<span class="practice-gap" data-answer="${word}">____</span> means keeping inflation low and predictable.`,
                        `Central banks work to ensure <span class="practice-gap" data-answer="${word}">____</span> for the economy.`,
                    ],
                    'Inflation': [
                        `When prices rise rapidly, we call it high <span class="practice-gap" data-answer="${word}">____</span>.`,
                        `The Bank raises interest rates to control <span class="practice-gap" data-answer="${word}">____</span>.`,
                        `<span class="practice-gap" data-answer="${word}">____</span> makes your money worth less over time.`,
                    ],
                    'confidence': [
                        `Public <span class="practice-gap" data-answer="${word}">____</span> in the banking system is crucial.`,
                        `The Bank's actions help maintain <span class="practice-gap" data-answer="${word}">____</span> in the economy.`,
                        `People need <span class="practice-gap" data-answer="${word}">____</span> that their money is safe.`,
                    ],
                    'banknotes': [
                        `The Bank of England prints all British <span class="practice-gap" data-answer="${word}">____</span>.`,
                        `Only the central bank can issue <span class="practice-gap" data-answer="${word}">____</span> in England.`,
                        `These <span class="practice-gap" data-answer="${word}">____</span> feature portraits of the King.`,
                    ],
                    'vault': [
                        `Gold reserves are stored in a secure underground <span class="practice-gap" data-answer="${word}">____</span>.`,
                        `The Bank's <span class="practice-gap" data-answer="${word}">____</span> holds billions of pounds worth of gold.`,
                        `Access to the <span class="practice-gap" data-answer="${word}">____</span> is highly restricted.`,
                    ],
                    'Governor': [
                        `The <span class="practice-gap" data-answer="${word}">____</span> is the highest-ranking official at the Bank.`,
                        `The <span class="practice-gap" data-answer="${word}">____</span> leads the Monetary Policy Committee.`,
                        `Britain's central bank <span class="practice-gap" data-answer="${word}">____</span> is appointed by the King.`,
                    ],
                    // === TRICK OR TREAT VOCABULARY (A1 BEGINNER) ===
                    'Candy': [
                        `The children collected lots of <span class="practice-gap" data-answer="${word}">____</span> on Halloween.`,
                        `Would you like some <span class="practice-gap" data-answer="${word}">____</span>? I have chocolate.`,
                        `Put the <span class="practice-gap" data-answer="${word}">____</span> in your bag, please.`,
                    ],
                    'Door': [
                        `Please open the <span class="practice-gap" data-answer="${word}">____</span> for me.`,
                        `Knock on the <span class="practice-gap" data-answer="${word}">____</span> and say "Trick or Treat!"`,
                        `The <span class="practice-gap" data-answer="${word}">____</span> is closed. Can you open it?`,
                    ],
                    'Bag': [
                        `Put your candy in this <span class="practice-gap" data-answer="${word}">____</span>.`,
                        `My <span class="practice-gap" data-answer="${word}">____</span> is full of sweets now!`,
                        `I carry a big <span class="practice-gap" data-answer="${word}">____</span> for Halloween.`,
                    ],
                    'Costume': [
                        `I like your ghost <span class="practice-gap" data-answer="${word}">____</span>! Very scary!`,
                        `What <span class="practice-gap" data-answer="${word}">____</span> will you wear this Halloween?`,
                        `She has a beautiful princess <span class="practice-gap" data-answer="${word}">____</span>.`,
                    ],
                    'Trick or Treat': [
                        `The children shout "<span class="practice-gap" data-answer="${word}">____</span>!" at every house.`,
                        `When you knock on the door, say "<span class="practice-gap" data-answer="${word}">____</span>!"`,
                        `<span class="practice-gap" data-answer="${word}">____</span> is what we say on Halloween night.`,
                    ],
                };

                // Normalize the word (to handle singular/plural if needed)
                const normalizedWord = word.toLowerCase();

                // If we have specific patterns for this word, use them
                if (sentencePatterns[normalizedWord]) {
                    const patterns = sentencePatterns[normalizedWord];
                    return patterns[Math.floor(Math.random() * patterns.length)];
                }

                // Otherwise, use intelligent fallback based on word type in definition
                const defLower = definition.toLowerCase();

                // Check if it's a verb (simple heuristic)
                if (defLower.includes('to ') || word.endsWith('s') || word.endsWith('ed') || word.endsWith('ing')) {
                    return `We need to <span class="practice-gap" data-answer="${word}">____</span> this carefully.`;
                }
                
                // Check if it's describing a person/people/thing (simple heuristic)
                if (defLower.includes('people') || defLower.includes('person') || defLower.includes('someone') || defLower.includes('thing')) {
                    return `The <span class="practice-gap" data-answer="${word}">____</span> were important in this story.`;
                } 

                // Default fallback
                return `It is important to understand the meaning of the word <span class="practice-gap" data-answer="${word}">____</span> in this context.`;
            }

            // Limit to 6 random words for practice
            const practiceWords = shuffleArray([...mistakes]).slice(0, 6);
            
            // Generate sentences
            let sentencesHTML = practiceWords.map((w, index) => {
                const sentence = generateGapSentence(w.word, w.definition);
                return `
                    <div style="margin-bottom: 20px; font-size: 17px; background: #FFF; padding: 15px; border-radius: 8px; border: 1px solid #E5E9F2;">
                        ${index + 1}. ${sentence}
                    </div>
                `;
            }).join('');


            // Create and display the practice popup
            const practicePopup = document.createElement('div');
            practicePopup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 700px;
                width: 90%;
                max-height: 85vh;
                overflow-y: auto;
            `;

            const overlay = document.createElement('div');
            overlay.id = 'mistake-reminder-overlay-practice'; // Use a distinct ID
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 9999;
            `;

            // Shuffle words for word bank
            const shuffled = shuffleArray([...practiceWords]);

            practicePopup.innerHTML = `
                <h2 style="color: #667EEA; margin-bottom: 15px; font-size: 24px; font-weight: 800;"> üî• Quick Practice Exercise </h2>
                <p style="color: #666; margin-bottom: 20px;">Fill in the blanks with the correct words:</p>

                <div style="background: #F0F4FF; border: 2px solid #667EEA; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                    <p style="font-weight: 700; margin-bottom: 10px; color: #4A5568;">Word Bank (Click to Select):</p>
                    <div id="practice-word-bank" style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${shuffled.map(w => `
                            <span class="practice-word" data-word="${w.word}" style="
                                background: #667EEA;
                                color: white;
                                padding: 8px 14px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: 600;
                                transition: all 0.2s;
                                user-select: none;
                            ">${w.word}</span>
                        `).join('')}
                    </div>
                </div>

                <div id="practice-sentences">
                    ${sentencesHTML}
                </div>

                <p id="practice-feedback" style="font-weight: 700; font-size: 18px; margin: 20px 0; text-align: center; color: #4A5568; min-height: 25px;">Ready to check your answers?</p>
                
                <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                    <button id="check-practice-btn" style="
                        background: #10B981;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-weight: 700;
                        cursor: pointer;
                        font-size: 16px;
                        flex: 1;
                        min-width: 140px;
                        transition: background-color 0.2s;
                    ">‚úÖ Check Answers</button>
                    
                    <button id="close-practice-btn" style="
                        background: #E5E9F2;
                        color: #4A5568;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-weight: 700;
                        cursor: pointer;
                        font-size: 16px;
                        flex: 1;
                        min-width: 140px;
                    ">Close</button>
                </div>
            `;

            document.body.appendChild(overlay);
            document.body.appendChild(practicePopup);

            let selectedWord = null;

            // Word bank selection logic
            document.querySelectorAll('.practice-word').forEach(wordEl => {
                wordEl.addEventListener('click', () => {
                    if (wordEl.classList.contains('used')) return;

                    // Deselect previously selected word
                    if (selectedWord) {
                        selectedWord.style.boxShadow = 'none';
                    }
                    
                    // Select new word
                    selectedWord = wordEl;
                    selectedWord.style.boxShadow = '0 0 0 3px #667EEA';
                });
            });

            // Gap fill logic
            document.querySelectorAll('.practice-gap').forEach(gap => {
                gap.style.borderBottom = '2px dashed #999';
                gap.style.padding = '0 5px';
                gap.style.cursor = 'pointer';
                gap.style.minWidth = '80px';
                gap.style.display = 'inline-block';
                gap.style.textAlign = 'center';
                gap.style.fontWeight = '700';
                gap.style.color = '#1A202C';
                gap.style.background = '#F8F9FB';
                gap.style.borderColor = '#E5E9F2';
                gap.style.borderRadius = '4px';

                gap.addEventListener('click', () => {
                    if (!selectedWord) return;
                    if (gap.dataset.filled === 'true') {
                        // Restore the word to the bank
                        const oldWordEl = document.querySelector(`.practice-word[data-word="${gap.dataset.filledWord}"]`);
                        if (oldWordEl) {
                            oldWordEl.classList.remove('used');
                            oldWordEl.style.opacity = '1.0';
                            oldWordEl.style.pointerEvents = 'auto';
                        }
                    }

                    // Fill the gap with the currently selected word
                    gap.textContent = selectedWord.dataset.word;
                    gap.dataset.filled = 'true';
                    gap.dataset.filledWord = selectedWord.dataset.word;
                    
                    // Mark the gap's appearance for not checked yet
                    gap.style.background = '#FBBF24'; 
                    gap.style.borderStyle = 'solid';
                    gap.style.borderColor = '#F59E0B';

                    // Mark the word as used in the bank
                    selectedWord.classList.add('used');
                    selectedWord.style.opacity = '0.3';
                    selectedWord.style.pointerEvents = 'none';
                    selectedWord.style.boxShadow = 'none'; // Clear selection visual
                    selectedWord = null;
                });
            });

            // Check button
            document.getElementById('check-practice-btn').addEventListener('click', () => {
                let correct = 0;
                let total = 0;
                document.querySelectorAll('.practice-gap').forEach(gap => {
                    total++;
                    const isCorrect = gap.dataset.filledWord === gap.dataset.answer;
                    if (isCorrect) {
                        correct++;
                        gap.style.background = '#10B981';
                        gap.style.color = 'white';
                        gap.style.borderColor = '#10B981';
                    } else {
                        gap.style.background = '#DC2626';
                        gap.style.color = 'white';
                        gap.style.borderColor = '#DC2626';
                    }
                });

                const feedback = document.getElementById('practice-feedback');
                if (correct === total) {
                    feedback.innerHTML = 'üéâ Perfect! All correct!';
                    feedback.style.color = '#10B981';
                } else {
                    feedback.innerHTML = `üìä You got ${correct}/${total} correct. Keep practicing!`;
                    feedback.style.color = '#F59E0B';
                }
                
                document.getElementById('check-practice-btn').style.pointerEvents = 'none'; // Prevent re-checking
                document.getElementById('check-practice-btn').style.opacity = '0.6';
            });

            // Close button
            document.getElementById('close-practice-btn').addEventListener('click', () => {
                practicePopup.remove();
                overlay.remove();
            });

            overlay.addEventListener('click', () => {
                practicePopup.remove();
                overlay.remove();
            });
        }


        // 4. Ticker Function (kept as is)
        const LESSON_STATES = [
            { text: 'üòé NEW! ADVANCED: Crocs\' China Strategy üêä', href: '/crocs/' },
            { text: 'üíº BUSINESS: Master Financial English üìà', href: '/business/' },
            { text: '‚öñÔ∏è LEGAL: Contract Terms Explained ‚úçÔ∏è', href: '/legal/' },
            { text: 'üéØ ADVANCED: British Food Idioms üá¨üáß', href: '/advanced/british-foodv9.html' }
        ];

        let currentTickerIndex = 0;
        
        function updateTicker() {
            const ticker = document.getElementById('latest-updates-ticker');
            if (!ticker) return;

            currentTickerIndex = (currentTickerIndex + 1) % LESSON_STATES.length;
            
            // Fade out
            ticker.style.opacity = 0;
            
            setTimeout(() => {
                // Change content
                ticker.textContent = LESSON_STATES[currentTickerIndex].text;
                ticker.href = LESSON_STATES[currentTickerIndex].href;
                // Fade in
                ticker.style.opacity = 1;
            }, 200); // Wait for fade out to complete
        }
        
        function startTickerAnimation() {
            const ticker = document.getElementById('latest-updates-ticker');
            if (!ticker) return;

            ticker.textContent = LESSON_STATES[0].text;
            ticker.href = LESSON_STATES[0].href;
            setInterval(updateTicker, 4000); // Change every 4 seconds

            // Pause animation on hover
            ticker.addEventListener('mouseenter', () => {
                ticker.style.animation = 'none';
                ticker.style.transform = 'scale(1.05)';
            });
            ticker.addEventListener('mouseleave', () => {
                ticker.style.animation = 'pulse 2s infinite ease-in-out';
                ticker.style.transform = 'scale(1)';
            });
        }


        // 5. Authentication (kept as is)
        async function initializeAuthHeader() {
            const loggedOutButtons = document.getElementById('logged-out-buttons');
            const loggedInButtons = document.getElementById('logged-in-buttons');
            const logoutBtn = document.getElementById('logout-btn');
            const userGreeting = document.getElementById('user-greeting');

            try {
                const { data: { user } } = await supabase.auth.getUser();

                if (user) {
                    const email = user.email || 'Cool Dude';
                    const username = email.split('@')[0];
                    if (userGreeting) userGreeting.textContent = `Hey ${username}! üëã`;
                    if (loggedOutButtons) loggedOutButtons.style.display = 'none';
                    if (loggedInButtons) loggedInButtons.style.display = 'flex';
                } else {
                    console.log('User not logged in');
                    if (loggedOutButtons) loggedOutButtons.style.display = 'flex';
                    if (loggedInButtons) loggedInButtons.style.display = 'none';
                }
            } catch (err) {
                console.error('Error checking auth:', err);
                if (loggedOutButtons) loggedOutButtons.style.display = 'flex';
                if (loggedInButtons) loggedInButtons.style.display = 'none';
            }

            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    try {
                        const { error } = await supabase.auth.signOut();
                        if (error) {
                            console.error('Logout error:', error);
                            alert('Logout failed. Please try again.');
                        } else {
                            window.location.reload();
                        }
                    } catch (err) {
                        console.error('Unexpected logout error:', err);
                    }
                });
            }
        }


        // 6. Initialization on Load
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeAuthHeader();
            startTickerAnimation();
            
            // This line triggers the mistake popup after a short delay
            setTimeout(() => checkForMistakesOnHomepage(), 1500);
        });
    </script>
</body>
</html>
