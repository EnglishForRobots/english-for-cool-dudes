<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="/favicon.png" sizes="32x32">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="manifest" href="/manifest.json">
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English For Cool Dudes</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif; background: #F8F9FB; color: #2C3E50; line-height: 1.6; -webkit-font-smoothing: antialiased; }

        /* === 1. CLEAN MAIN HEADER === */
        .header { background: #FFFFFF; border-bottom: 1px solid #E5E9F2; padding: 20px 0; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.04); margin-bottom: 20px; }
        .header-content { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; }
        
        .header-left { display: flex; align-items: center; gap: 15px; }
        .logo { width: 36px; height: 36px; background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .site-title { font-size: 20px; font-weight: 600; color: #1A202C; letter-spacing: -0.02em; text-decoration: none; }

        .header-buttons { display: flex; align-items: center; gap: 8px; }
        .header-button { text-decoration: none; padding: 7px 14px; border-radius: 6px; font-size: 14px; font-weight: 600; transition: all 0.2s; white-space: nowrap; cursor: pointer; border: 1px solid #E5E9F2; background: transparent; }
        .header-button.login { background: #F8F9FB; color: #4A5568; }
        .header-button.login:hover { background: #FFFFFF; color: #2C3E50; border-color: #718096; }
        .header-button.signup { background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%); color: white; border: 1px solid transparent; }
        .header-button.signup:hover { background: linear-gradient(135deg, #5A6AD0 0%, #6D4396 100%); box-shadow: 0 2px 5px rgba(102, 126, 234, 0.4); }
        .header-button.dashboard { background: #FFFBEA; color: #92400E; border-color: #FCD34D; }
        .header-button.dashboard:hover { background: #FCD34D; border-color: #F59E0B; }
        .header-button.logout { background: #F8F9FB; color: #E53E3E; }
        .header-button.logout:hover { background: #FEEBEB; color: #C53030; border-color: #FBD3DA; }
        .user-greeting { font-size: 14px; color: #4A5568; font-weight: 600; margin-right: 5px; white-space: nowrap; }

        /* === 2. INFO BOX (NOW THE PULSE TICKER) === */
        .container { max-width: 1200px; margin: 0 auto; padding: 30px 20px; }
        
        .info-box { 
            background: linear-gradient(135deg, #FFF9E6 0%, #FFF3CD 100%); 
            border-left: 4px solid #F59E0B; 
            padding: 20px 24px; 
            border-radius: 10px; 
            margin-bottom: 20px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            display: flex;
            align-items: center;
            min-height: 60px; 
        }

        /* === 2.5 THE REPAIR SHOP WIDGET (NEW!) === */
        #repair-shop-widget {
            display: none; /* Hidden by default until we check for mistakes */
            background: #FFFFFF;
            border: 1px solid #E5E9F2;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 40px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        #repair-shop-widget.has-mistakes {
            background: #FEF2F2;
            border-color: #FECACA;
            border-left: 4px solid #EF4444;
        }
        
        #repair-shop-widget.all-clear {
            background: #F0FDF4;
            border-color: #BBF7D0;
            border-left: 4px solid #22C55E;
        }

        .repair-content { display: flex; align-items: center; justify-content: space-between; gap: 20px; flex-wrap: wrap; }
        .repair-text h3 { font-size: 18px; font-weight: 700; margin-bottom: 5px; }
        .repair-text p { font-size: 14px; color: #64748B; }
        
        .repair-btn {
            background: #EF4444; color: white; border: none; padding: 10px 20px;
            border-radius: 6px; font-weight: 600; cursor: pointer; text-decoration: none;
            display: inline-flex; align-items: center; gap: 8px; font-size: 14px;
            transition: transform 0.2s;
        }
        .repair-btn:hover { background: #DC2626; transform: translateY(-1px); }

        /* The animated text inside the box */
        #pulse-ticker-text { 
            font-size: 15px; 
            color: #92400E; 
            font-weight: 600; 
            margin: 0; 
            line-height: 1.6;
            transition: opacity 0.5s ease-in-out;
            width: 100%;
        }
        
        /* Link style inside the ticker */
        #pulse-ticker-text a {
            color: #78350F;
            text-decoration: underline;
            text-decoration-style: dotted;
            transition: all 0.2s;
        }
        #pulse-ticker-text a:hover {
            color: #B45309;
            background: rgba(255,255,255,0.5);
        }
        
        /* === 3. COURSE CARDS === */
        .section { margin-bottom: 50px; }
        .section-header { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #E5E9F2; }
        .section-icon { font-size: 26px; }
        .section-title { font-size: 22px; font-weight: 600; color: #1A202C; letter-spacing: -0.02em; }
        .course-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .course-card { background: #FFFFFF; border: 1px solid #E5E9F2; border-radius: 12px; padding: 0; text-decoration: none; color: inherit; display: block; transition: all 0.2s; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
        .course-card:hover { border-color: #667EEA; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.12); transform: translateY(-2px); }
        .course-header { padding: 28px; background: linear-gradient(135deg, #F8F9FB 0%, #FFFFFF 100%); border-bottom: 1px solid #E5E9F2; }
        .course-icon { font-size: 48px; margin-bottom: 12px; display: block; }
        .course-title { font-size: 20px; font-weight: 600; color: #1A202C; margin-bottom: 8px; }
        .course-level { display: inline-block; background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%); color: white; padding: 5px 14px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px; }
        .course-body { padding: 28px; }
        .course-description { font-size: 15px; color: #4A5568; line-height: 1.7; margin-bottom: 18px; }
        .course-meta { display: flex; gap: 18px; font-size: 13px; color: #718096; font-weight: 600; padding-top: 18px; border-top: 1px solid #E5E9F2; }
        .meta-item { display: flex; align-items: center; gap: 5px; }

        /* QUICK LINKS */
        .quick-links { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 40px; }
        .quick-link { background: #FFFFFF; border: 1px solid #E5E9F2; border-radius: 10px; padding: 20px; text-decoration: none; color: inherit; display: flex; align-items: center; gap: 16px; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
        .quick-link:hover { border-color: #667EEA; background: #F8F9FB; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.12); transform: translateY(-1px); }
        .quick-link-icon { font-size: 32px; flex-shrink: 0; }
        .quick-link-title { font-size: 15px; font-weight: 600; color: #1A202C; margin-bottom: 3px; }
        .quick-link-desc { font-size: 13px; color: #718096; }

        /* BOTTOM TICKER (COURSE UPDATES) */
        #latest-updates-ticker { position: fixed; top: 20px; right: 50%; margin-right: -580px; z-index: 1000; cursor: pointer; background: #FFC107; color: #92400E; padding: 8px 15px; border-radius: 20px; font-size: 14px; font-weight: 600; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); transition: transform 0.2s; border: 2px solid #F59E0B; animation: pulse 2s infinite ease-in-out; text-decoration: none; white-space: nowrap; max-width: 450px; text-overflow: ellipsis; overflow: hidden; display: inline-block; }
        #latest-updates-ticker:hover { background: #FFD54F; transform: scale(1.05); animation: none; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }

        /* POPUPS */
        .clickable-word { cursor: pointer; text-decoration: underline; text-decoration-style: dotted; transition: color 0.2s; }
        .clickable-word:hover { color: #667EEA; }
        #dictionary-popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 10001; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        #dictionary-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; }

        /* FOOTER */
        .footer { background: #FFFFFF; border-top: 1px solid #E5E9F2; padding: 32px 20px; margin-top: 60px; text-align: center; }
        .footer-text { font-size: 14px; color: #718096; }

        /* RESPONSIVE */
        @media (max-width: 1240px) { #latest-updates-ticker { right: 20px; margin-right: 0; } }
        @media (max-width: 768px) { .user-greeting { display: none; } .course-grid, .quick-links { grid-template-columns: 1fr; } }
        @media (max-width: 480px) { 
            .container { padding: 20px 15px 80px 15px; }
            #latest-updates-ticker { top: auto; bottom: 0; right: 0; left: 0; margin-right: 0; border-radius: 0; width: 100%; text-align: center; border: none; border-top: 2px solid #F59E0B; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <span class="logo">üòé</span>
                <a href="/" class="site-title">English For Cool Dudes</a>
                
                <div id="logged-out-buttons" class="header-buttons" style="display: none;">
                    <a href="/login/" class="header-button login">Login</a>
                    <a href="/signup/" class="header-button signup">Sign Up</a>
                </div>

                <div id="logged-in-buttons" class="header-buttons" style="display: none;">
                    <span class="user-greeting" id="user-greeting">Hey Cool Dude! üëã</span>
                    <a href="/dashboard/" class="header-button dashboard">My Dashboard</a>
                    <button id="logout-btn" class="header-button logout">Sign Out</button>
                </div>
            </div>
        </div>
    </header>

    <div id="dictionary-overlay"></div>
    <div id="dictionary-popup">
        <div id="dictionary-content"></div>
    </div>

    <a href="/phrasals/" id="latest-updates-ticker">
        üß© NEW! INTERMEDIATE: Top 10 Phrasal Verbs For Work üòé
    </a>

    <main class="container">
        <div class="info-box">
            <p id="pulse-ticker-text">Loading Office Activity... üè¢</p>
        </div>

        <div id="repair-shop-widget">
            <div class="repair-content">
                <div class="repair-text">
                    <h3 id="repair-title">üîß The Repair Shop</h3>
                    <p id="repair-desc">Checking for vocabulary that needs fixing...</p>
                </div>
                <button id="start-repair-btn" class="repair-btn" style="display:none;">
                    üõ†Ô∏è Start Quick Repair (2 min)
                </button>
            </div>
        </div>

        <section class="section">
            <div class="section-header">
                <span class="section-icon">üíº</span>
                <h2 class="section-title">Specialized English</h2>
            </div>
            <div class="course-grid">
                <a href="/business/" class="course-card">
                    <div class="course-header">
                        <span class="course-icon">üíº</span>
                        <h3 class="course-title">Business English</h3>
                        <span class="course-level">Professional</span>
                    </div>
                    <div class="course-body">
                        <p class="course-description">Master professional communication for meetings, emails, presentations, and business negotiations.</p>
                        <div class="course-meta">
                            <span class="meta-item">üìö Multiple lessons</span>
                            <span class="meta-item">‚è±Ô∏è Self-paced</span>
                        </div>
                    </div>
                </a>
                <a href="/tax/" class="course-card">
                    <div class="course-header">
                        <span class="course-icon">üí∞</span>
                        <h3 class="course-title">Tax English</h3>
                        <span class="course-level">Specialist</span>
                    </div>
                    <div class="course-body">
                        <p class="course-description">Learn tax terminology, concepts, and documentation language for accounting professionals.</p>
                        <div class="course-meta">
                            <span class="meta-item">üìö Multiple lessons</span>
                            <span class="meta-item">‚è±Ô∏è Self-paced</span>
                        </div>
                    </div>
                </a>
                <a href="/legal/" class="course-card">
                    <div class="course-header">
                        <span class="course-icon">‚öñÔ∏è</span>
                        <h3 class="course-title">Legal English</h3>
                        <span class="course-level">Specialist</span>
                    </div>
                    <div class="course-body">
                        <p class="course-description">Navigate legal terminology, contracts, and documentation with confidence and precision.</p>
                        <div class="course-meta">
                            <span class="meta-item">üìö Multiple lessons</span>
                            <span class="meta-item">‚è±Ô∏è Self-paced</span>
                        </div>
                    </div>
                </a>
            </div>
        </section>

        <section class="section">
            <div class="section-header">
                <span class="section-icon">üìñ</span>
                <h2 class="section-title">General English Courses</h2>
            </div>
            <div class="course-grid">
                <a href="/beginner/" class="course-card">
                    <div class="course-header">
                        <span class="course-icon">üå±</span>
                        <h3 class="course-title">Beginner Course</h3>
                        <span class="course-level">A1-A2</span>
                    </div>
                    <div class="course-body">
                        <p class="course-description">Start your English journey. Learn basic grammar, vocabulary, and everyday conversation skills.</p>
                        <div class="course-meta">
                            <span class="meta-item">üìö Foundation level</span>
                            <span class="meta-item">‚è±Ô∏è Step by step</span>
                        </div>
                    </div>
                </a>
                <a href="/intermediate/" class="course-card">
                    <div class="course-header">
                        <span class="course-icon">üöÄ</span>
                        <h3 class="course-title">Intermediate Course</h3>
                        <span class="course-level">B1-B2</span>
                    </div>
                    <div class="course-body">
                        <p class="course-description">Build confidence with complex grammar and expand your vocabulary for real-world situations.</p>
                        <div class="course-meta">
                            <span class="meta-item">üìö Expanding skills</span>
                            <span class="meta-item">‚è±Ô∏è Progressive</span>
                        </div>
                    </div>
                </a>
                <a href="/advanced/" class="course-card">
                    <div class="course-header">
                        <span class="course-icon">üéØ</span>
                        <h3 class="course-title">Advanced Course</h3>
                        <span class="course-level">C1-C2</span>
                    </div>
                    <div class="course-body">
                        <p class="course-description">Master sophisticated expressions, idioms, and achieve native-like fluency in British English.</p>
                        <div class="course-meta">
                            <span class="meta-item">üìö Mastery level</span>
                            <span class="meta-item">‚è±Ô∏è Advanced</span>
                        </div>
                    </div>
                </a>
            </div>
        </section>

        <section class="section">
            <div class="section-header">
                <span class="section-icon">‚òï</span>
                <h2 class="section-title">The Break Room</h2>
            </div>
            <div class="quick-links">
                <a href="/games/" class="quick-link">
                    <span class="quick-link-icon">üéÆ</span>
                    <div class="quick-link-text">
                        <div class="quick-link-title">Game Zone</div>
                        <div class="quick-link-desc">Play Taboo, Memory Match & More</div>
                    </div>
                </a>
            </div>
        </section>
    </main>

    <footer class="footer">
        <p class="footer-text">¬© 2025 English For Cool Dudes - üòé</p>
        <div style="margin-top: 10px;">
            <a href="/impressum/" style="color: #667EEA; margin-right: 15px; text-decoration: none;">Impressum</a>
            <a href="/datenschutz/" style="color: #667EEA; text-decoration: none;">Datenschutzerkl√§rung</a>
        </div>
    </footer>

<script>
    const SUPABASE_URL = 'https://knwgmrgwbpchqyqxbxea.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtud2dtcmd3YnBjaHF5cXhieGVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MDkyODgsImV4cCI6MjA3ODA4NTI4OH0.qnp2ScwSE77_idmPhpLE98sr46WvLpKtg6refFfC7s8';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // --- 1. DICTIONARY (No changes needed here) ---
    function showDictionary(word, definition, type) {
        document.getElementById('dictionary-popup').style.display = 'block';
        document.getElementById('dictionary-overlay').style.display = 'block';
        const content = document.getElementById('dictionary-content');
        content.innerHTML = `
            <h3 style="color: #667EEA; font-size: 20px; margin-bottom: 10px; font-weight: 600;">${word} <span style="font-size: 14px; color: #718096; font-weight: 600;">(${type})</span></h3>
            <p style="color: #4A5568; line-height: 1.7; margin-bottom: 20px;">${definition}</p>
            <button onclick="closeDictionary()" style="background: #E5E9F2; color: #4A5568; border: none; padding: 10px 30px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px; margin-top: 20px; ">Close</button>
        `;
    }

    function closeDictionary() {
        document.getElementById('dictionary-popup').style.display = 'none';
        document.getElementById('dictionary-overlay').style.display = 'none';
    }
    document.getElementById('dictionary-overlay').addEventListener('click', closeDictionary);

    // --- 2. THE "BRAIN BOOST" LOGIC (Updated for Positivity & Spaced Repetition) ---
    
    async function checkForMistakesOnHomepage() {
        try {
            const { data: { user } = {} } = await supabase.auth.getUser();
            if (!user) {
                document.getElementById('repair-shop-widget').style.display = 'none';
                return;
            }

            // A. Fetch Mistakes (Priority 1)
            const { data: mistakes } = await supabase
                .from('user_mistakes')
                .select('word, definition, word_type, lesson, lesson_link')
                .eq('user_id', user.id)
                .limit(5); // Get max 5 mistakes

            let practiceBatch = mistakes || [];

            // B. If we have fewer than 5 mistakes, fetch "Stale" Correct Words (Priority 2)
            if (practiceBatch.length < 5) {
                const needed = 5 - practiceBatch.length;
                
                // Fetch lessons completed more than 1 day ago (Simple Spaced Repetition)
                const { data: lessons } = await supabase
                    .from('lessons')
                    .select('vocabulary')
                    .eq('user_id', user.id)
                    .order('completed_at', { ascending: true }) // Oldest lessons first
                    .limit(3);

                if (lessons && lessons.length > 0) {
                    let poolOfKnownWords = [];
                    // Extract words from the JSON vocabulary column
                    lessons.forEach(lesson => {
                        if(Array.isArray(lesson.vocabulary)) {
                            poolOfKnownWords.push(...lesson.vocabulary);
                        }
                    });

                    // Shuffle and pick needed amount
                    poolOfKnownWords = poolOfKnownWords.sort(() => 0.5 - Math.random()).slice(0, needed);
                    
                    // Add them to the batch (tagging them as 'review' instead of 'mistake')
                    poolOfKnownWords.forEach(w => {
                        practiceBatch.push({
                            word: w.word,
                            definition: w.definition,
                            word_type: w.type || 'word',
                            lesson: 'Review', // Label as Review
                            is_review: true // Flag to track this isn't a mistake
                        });
                    });
                }
            }

            // C. Update the Widget UI
            const widget = document.getElementById('repair-shop-widget');
            const title = document.getElementById('repair-title');
            const desc = document.getElementById('repair-desc');
            const btn = document.getElementById('start-repair-btn');

            if (practiceBatch.length > 0) {
                // POSITIVE REBRANDING
                widget.style.display = 'block';
                // Change style to Blue/Purple (Growth) instead of Red (Error)
                widget.style.background = '#F0F9FF'; 
                widget.style.borderColor = '#BAE6FD';
                widget.style.borderLeft = '4px solid #0EA5E9'; // Sky Blue

                title.innerHTML = `üöÄ Daily Brain Boost`;
                title.style.color = '#0369A1';
                
                const mistakeCount = practiceBatch.filter(x => !x.is_review).length;
                const reviewCount = practiceBatch.filter(x => x.is_review).length;
                
                desc.innerHTML = `Ready to strengthen your memory? <br>
                                  <span style="font-size:12px; color:#64748B;">
                                  (üéØ ${mistakeCount} Focus Words + üß† ${reviewCount} Memory Reviews)
                                  </span>`;
                
                btn.style.display = 'inline-flex';
                btn.innerHTML = "‚ö° Boost My English (2 min)";
                btn.style.background = '#0EA5E9'; 
                
                btn.onclick = () => startPractice(practiceBatch);
            } else {
                // If absolutely no words found (brand new user)
                widget.style.display = 'none';
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // --- 3. PRACTICE FUNCTION (Handles both Mistakes & Reviews) ---
    function startPractice(batch) {
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- SENTENCE GENERATION (Keep your existing sentencePatterns object here!) ---
        function generateGapSentence(word, definition) {
             const sentencePatterns = {
                 // ... PASTE YOUR EXISTING HUGE LIST OF SENTENCES HERE ...
                 // (I have hidden them for brevity, but keep the list from your previous code)
             };

            const normalizedWord = word.toLowerCase();

            if (sentencePatterns[normalizedWord]) {
                const patterns = sentencePatterns[normalizedWord];
                return patterns[Math.floor(Math.random() * patterns.length)];
            }
            if (definition && definition.length > 3) {
                return `<strong>Definition:</strong> "${definition}" <br> Word: <span class="practice-gap" data-answer="${word}">____</span>`;
            }
            return `The word is: <span class="practice-gap" data-answer="${word}">____</span>`;
        }

        const practiceItems = batch.map(w => {
            const sentence = generateGapSentence(w.word, w.definition);
            return sentence ? { word: w.word, sentence: sentence, is_review: w.is_review } : null;
        }).filter(item => item !== null); 

        // Generate sentences HTML
        let sentencesHTML = practiceItems.map((item, index) => {
            const badge = item.is_review 
                ? `<span style="background:#DCFCE7; color:#166534; font-size:10px; padding:2px 6px; border-radius:4px; font-weight:700; margin-left:8px;">MEMORY CHECK</span>` 
                : `<span style="background:#FEF2F2; color:#991B1B; font-size:10px; padding:2px 6px; border-radius:4px; font-weight:700; margin-left:8px;">FOCUS</span>`;
            
            return `
                <div style="margin-bottom: 20px; font-size: 17px; background: #FFF; padding: 15px; border-radius: 8px; border: 1px solid #E5E9F2;">
                    ${index + 1}. ${item.sentence} ${badge}
                </div>
            `;
        }).join('');

        // --- POPUP UI ---
        const practicePopup = document.createElement('div');
        practicePopup.style.cssText = `
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 30px; border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 10000;
            max-width: 700px; width: 90%; max-height: 85vh; overflow-y: auto;
        `;

        const overlay = document.createElement('div');
        overlay.id = 'mistake-reminder-overlay-practice';
        overlay.style.cssText = `
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 9999;
        `;

        const shuffledWordsForBank = shuffleArray(practiceItems.map(item => ({ word: item.word })));

        practicePopup.innerHTML = `
            <h2 style="color: #0EA5E9; margin-bottom: 15px; font-size: 24px; font-weight: 600;"> üöÄ Daily Brain Boost </h2>
            <p style="color: #666; margin-bottom: 20px;">Complete the gaps to strengthen your memory:</p>

            <div style="background: #F0F9FF; border: 2px solid #0EA5E9; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                <p style="font-weight: 600; margin-bottom: 10px; color: #0369A1;">Word Bank:</p>
                <div id="practice-word-bank" style="display: flex; flex-wrap: wrap; gap: 8px;">
                    ${shuffledWordsForBank.map(w => `
                        <span class="practice-word" data-word="${w.word}" style="
                            background: #0EA5E9; color: white; padding: 8px 14px;
                            border-radius: 6px; cursor: pointer; font-weight: 600;
                            transition: all 0.2s; user-select: none;
                        ">${w.word}</span>
                    `).join('')}
                </div>
            </div>

            <div id="practice-sentences">${sentencesHTML}</div>

            <p id="practice-feedback" style="font-weight: 600; font-size: 18px; margin: 20px 0; text-align: center; color: #4A5568; min-height: 25px;"></p>
            
            <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                <button id="check-practice-btn" style="
                    background: #10B981; color: white; border: none; padding: 12px 24px;
                    border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px;
                    flex: 1; min-width: 140px; transition: background-color 0.2s;
                ">‚úÖ Check Answers</button>
                
                <button id="close-practice-btn" style="
                    background: #E5E9F2; color: #4A5568; border: none; padding: 12px 24px;
                    border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px;
                    flex: 1; min-width: 140px;
                ">Close</button>
            </div>
        `;

        document.body.appendChild(overlay);
        document.body.appendChild(practicePopup);

        // --- INTERACTION LOGIC (Select/Fill) ---
        let selectedWord = null;
        document.querySelectorAll('.practice-word').forEach(wordEl => {
            wordEl.addEventListener('click', () => {
                if (wordEl.classList.contains('used')) return;
                if (selectedWord) selectedWord.style.boxShadow = 'none';
                selectedWord = wordEl;
                selectedWord.style.boxShadow = '0 0 0 3px #0EA5E9';
            });
        });

        document.querySelectorAll('.practice-gap').forEach(gap => {
            // Updated styling for the new theme
            gap.style.borderBottom = '2px dashed #999';
            gap.style.padding = '0 5px'; gap.style.cursor = 'pointer';
            gap.style.minWidth = '80px'; gap.style.display = 'inline-block';
            gap.style.textAlign = 'center'; gap.style.fontWeight = '600';
            gap.style.color = '#0369A1'; gap.style.background = '#F0F9FF';
            gap.style.borderColor = '#BAE6FD'; gap.style.borderRadius = '4px';

            gap.addEventListener('click', () => {
                if (!selectedWord) return;
                if (gap.dataset.filled === 'true') {
                    const oldWordEl = document.querySelector(`.practice-word[data-word="${gap.dataset.filledWord}"]`);
                    if (oldWordEl) {
                        oldWordEl.classList.remove('used');
                        oldWordEl.style.opacity = '1.0'; oldWordEl.style.pointerEvents = 'auto';
                    }
                }
                gap.textContent = selectedWord.dataset.word;
                gap.dataset.filled = 'true';
                gap.dataset.filledWord = selectedWord.dataset.word;
                gap.style.background = '#FDE047'; gap.style.borderStyle = 'solid'; gap.style.borderColor = '#EAB308';
                gap.style.color = '#854D0E';

                selectedWord.classList.add('used');
                selectedWord.style.opacity = '0.3'; selectedWord.style.pointerEvents = 'none';
                selectedWord.style.boxShadow = 'none';
                selectedWord = null;
            });
        });

        // --- CHECKING & SAVING LOGIC ---
        document.getElementById('check-practice-btn').addEventListener('click', async () => {
            let correct = 0, total = 0;
            const wordsToDelete = [];

            document.querySelectorAll('.practice-gap').forEach(gap => {
                total++;
                if (gap.dataset.filledWord === gap.dataset.answer) {
                    correct++;
                    gap.style.background = '#10B981'; gap.style.color = 'white'; gap.style.borderColor = '#10B981';
                    // Only delete if it was a MISTAKE (not a review word)
                    // We check this by seeing if the batch item had is_review: true/false
                    const originalItem = batch.find(b => b.word === gap.dataset.answer);
                    if (originalItem && !originalItem.is_review) {
                        wordsToDelete.push(gap.dataset.answer);
                    }
                } else {
                    gap.style.background = '#DC2626'; gap.style.color = 'white'; gap.style.borderColor = '#DC2626';
                }
            });

            const feedback = document.getElementById('practice-feedback');
            
            // Delete repaired mistakes from DB
            if (wordsToDelete.length > 0) {
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (user) {
                        const deletePromises = wordsToDelete.map(word => 
                            supabase.from('user_mistakes').delete().eq('user_id', user.id).eq('word', word)
                        );
                        await Promise.all(deletePromises);
                        checkForMistakesOnHomepage(); // Refresh widget
                    }
                } catch (err) { console.error("Error repairing words:", err); }
            }

            if (correct === total) {
                feedback.innerHTML = 'üéâ Amazing! Memory Boosted!'; feedback.style.color = '#10B981';
            } else {
                feedback.innerHTML = `You got ${correct}/${total}. Keep practicing!`; feedback.style.color = '#F59E0B';
            }
            
            document.getElementById('check-practice-btn').style.pointerEvents = 'none';
            document.getElementById('check-practice-btn').style.opacity = '0.6';
        });

        const closeFn = () => { practicePopup.remove(); overlay.remove(); };
        document.getElementById('close-practice-btn').addEventListener('click', closeFn);
        overlay.addEventListener('click', closeFn);
    }
    
    // --- LOAD ON START ---
    document.addEventListener('DOMContentLoaded', async () => {
        await initializeAuthHeader();
        loadOfficePulse();
        startTickerAnimation();
        // Delay slightly to let Auth load
        setTimeout(() => checkForMistakesOnHomepage(), 1500);
    });
</script>
</body>
</html>
