<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="/favicon.png" sizes="32x32">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="manifest" href="/manifest.json">
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English For Cool Dudes</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif; background: #F8F9FB; color: #2C3E50; line-height: 1.6; -webkit-font-smoothing: antialiased; }

        /* === 1. CLEAN MAIN HEADER === */
        .header { background: #FFFFFF; border-bottom: 1px solid #E5E9F2; padding: 20px 0; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.04); margin-bottom: 20px; }
        .header-content { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; }
        
        .header-left { display: flex; align-items: center; gap: 15px; }
        .logo { width: 36px; height: 36px; background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .site-title { font-size: 20px; font-weight: 600; color: #1A202C; letter-spacing: -0.02em; text-decoration: none; }

        .header-buttons { display: flex; align-items: center; gap: 8px; }
        .header-button { text-decoration: none; padding: 7px 14px; border-radius: 6px; font-size: 14px; font-weight: 600; transition: all 0.2s; white-space: nowrap; cursor: pointer; border: 1px solid #E5E9F2; background: transparent; }
        .header-button.login { background: #F8F9FB; color: #4A5568; }
        .header-button.login:hover { background: #FFFFFF; color: #2C3E50; border-color: #718096; }
        .header-button.signup { background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%); color: white; border: 1px solid transparent; }
        .header-button.signup:hover { background: linear-gradient(135deg, #5A6AD0 0%, #6D4396 100%); box-shadow: 0 2px 5px rgba(102, 126, 234, 0.4); }
        .header-button.dashboard { background: #FFFBEA; color: #92400E; border-color: #FCD34D; }
        .header-button.dashboard:hover { background: #FCD34D; border-color: #F59E0B; }
        .header-button.logout { background: #F8F9FB; color: #E53E3E; }
        .header-button.logout:hover { background: #FEEBEB; color: #C53030; border-color: #FBD3DA; }
        .user-greeting { font-size: 14px; color: #4A5568; font-weight: 600; margin-right: 5px; white-space: nowrap; }

        /* === 2. INFO BOX (NOW THE PULSE TICKER) === */
        .container { max-width: 1200px; margin: 0 auto; padding: 30px 20px; }
        
        .info-box { 
            background: linear-gradient(135deg, #FFF9E6 0%, #FFF3CD 100%); 
            border-left: 4px solid #F59E0B; 
            padding: 20px 24px; 
            border-radius: 10px; 
            margin-bottom: 30px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            display: flex;
            align-items: center;
            min-height: 60px; 
        }

        /* The animated text inside the box */
        #pulse-ticker-text { 
            font-size: 15px; 
            color: #92400E; 
            font-weight: 600; 
            margin: 0; 
            line-height: 1.6;
            transition: opacity 0.5s ease-in-out;
            width: 100%;
        }
        
        /* Link style inside the ticker */
        #pulse-ticker-text a {
            color: #78350F;
            text-decoration: underline;
            text-decoration-style: dotted;
            transition: all 0.2s;
        }
        #pulse-ticker-text a:hover {
            color: #B45309;
            background: rgba(255,255,255,0.5);
        }
        
        /* === 3. COURSE CARDS === */
        .section { margin-bottom: 50px; }
        .section-header { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #E5E9F2; }
        .section-icon { font-size: 26px; }
        .section-title { font-size: 22px; font-weight: 600; color: #1A202C; letter-spacing: -0.02em; }
        .course-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .course-card { background: #FFFFFF; border: 1px solid #E5E9F2; border-radius: 12px; padding: 0; text-decoration: none; color: inherit; display: block; transition: all 0.2s; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
        .course-card:hover { border-color: #667EEA; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.12); transform: translateY(-2px); }
        .course-header { padding: 28px; background: linear-gradient(135deg, #F8F9FB 0%, #FFFFFF 100%); border-bottom: 1px solid #E5E9F2; }
        .course-icon { font-size: 48px; margin-bottom: 12px; display: block; }
        .course-title { font-size: 20px; font-weight: 600; color: #1A202C; margin-bottom: 8px; }
        .course-level { display: inline-block; background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%); color: white; padding: 5px 14px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px; }
        .course-body { padding: 28px; }
        .course-description { font-size: 15px; color: #4A5568; line-height: 1.7; margin-bottom: 18px; }
        .course-meta { display: flex; gap: 18px; font-size: 13px; color: #718096; font-weight: 600; padding-top: 18px; border-top: 1px solid #E5E9F2; }
        .meta-item { display: flex; align-items: center; gap: 5px; }

        /* QUICK LINKS */
        .quick-links { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 40px; }
        .quick-link { background: #FFFFFF; border: 1px solid #E5E9F2; border-radius: 10px; padding: 20px; text-decoration: none; color: inherit; display: flex; align-items: center; gap: 16px; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
        .quick-link:hover { border-color: #667EEA; background: #F8F9FB; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.12); transform: translateY(-1px); }
        .quick-link-icon { font-size: 32px; flex-shrink: 0; }
        .quick-link-title { font-size: 15px; font-weight: 600; color: #1A202C; margin-bottom: 3px; }
        .quick-link-desc { font-size: 13px; color: #718096; }

        /* BOTTOM TICKER (COURSE UPDATES) */
        #latest-updates-ticker { position: fixed; top: 20px; right: 50%; margin-right: -580px; z-index: 1000; cursor: pointer; background: #FFC107; color: #92400E; padding: 8px 15px; border-radius: 20px; font-size: 14px; font-weight: 600; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); transition: transform 0.2s; border: 2px solid #F59E0B; animation: pulse 2s infinite ease-in-out; text-decoration: none; white-space: nowrap; max-width: 450px; text-overflow: ellipsis; overflow: hidden; display: inline-block; }
        #latest-updates-ticker:hover { background: #FFD54F; transform: scale(1.05); animation: none; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }

        /* POPUPS */
        .clickable-word { cursor: pointer; text-decoration: underline; text-decoration-style: dotted; transition: color 0.2s; }
        .clickable-word:hover { color: #667EEA; }
        #dictionary-popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 10001; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        #dictionary-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; }

        /* FOOTER */
        .footer { background: #FFFFFF; border-top: 1px solid #E5E9F2; padding: 32px 20px; margin-top: 60px; text-align: center; }
        .footer-text { font-size: 14px; color: #718096; }

        /* RESPONSIVE */
        @media (max-width: 1240px) { #latest-updates-ticker { right: 20px; margin-right: 0; } }
        @media (max-width: 768px) { .user-greeting { display: none; } .course-grid, .quick-links { grid-template-columns: 1fr; } }
        @media (max-width: 480px) { 
            .container { padding: 20px 15px 80px 15px; }
            #latest-updates-ticker { top: auto; bottom: 0; right: 0; left: 0; margin-right: 0; border-radius: 0; width: 100%; text-align: center; border: none; border-top: 2px solid #F59E0B; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <span class="logo">üòé</span>
                <a href="/" class="site-title">English For Cool Dudes</a>
                
                <div id="logged-out-buttons" class="header-buttons" style="display: none;">
                    <a href="/login/" class="header-button login">Login</a>
                    <a href="/signup/" class="header-button signup">Sign Up</a>
                </div>

                <div id="logged-in-buttons" class="header-buttons" style="display: none;">
                    <span class="user-greeting" id="user-greeting">Hey Cool Dude! üëã</span>
                    <a href="/dashboard/" class="header-button dashboard">My Dashboard</a>
                    <button id="logout-btn" class="header-button logout">Sign Out</button>
                </div>
            </div>
        </div>
    </header>

    <div id="dictionary-overlay"></div>
    <div id="dictionary-popup">
        <div id="dictionary-content"></div>
    </div>

    <a href="/VATdigital/" id="latest-updates-ticker">
        üåê NEW! TAX: The Netflix Tax üé¨üçø 
    </a>

    <main class="container">
        <div class="info-box">
            <p id="pulse-ticker-text">Loading Office Activity... üè¢</p>
        </div>

        <section class="section">
            <div class="section-header">
                <span class="section-icon">üíº</span>
                <h2 class="section-title">Specialized English</h2>
            </div>
            <div class="course-grid">
                <a href="/business/" class="course-card">
                    <div class="course-header">
                        <span class="course-icon">üíº</span>
                        <h3 class="course-title">Business English</h3>
                        <span class="course-level">Professional</span>
                    </div>
                    <div class="course-body">
                        <p class="course-description">Master professional communication for meetings, emails, presentations, and business negotiations.</p>
                        <div class="course-meta">
                            <span class="meta-item">üìö Multiple lessons</span>
                            <span class="meta-item">‚è±Ô∏è Self-paced</span>
                        </div>
                    </div>
                </a>
                <a href="/tax/" class="course-card">
                    <div class="course-header">
                        <span class="course-icon">üí∞</span>
                        <h3 class="course-title">Tax English</h3>
                        <span class="course-level">Specialist</span>
                    </div>
                    <div class="course-body">
                        <p class="course-description">Learn tax terminology, concepts, and documentation language for accounting professionals.</p>
                        <div class="course-meta">
                            <span class="meta-item">üìö Multiple lessons</span>
                            <span class="meta-item">‚è±Ô∏è Self-paced</span>
                        </div>
                    </div>
                </a>
                <a href="/legal/" class="course-card">
                    <div class="course-header">
                        <span class="course-icon">‚öñÔ∏è</span>
                        <h3 class="course-title">Legal English</h3>
                        <span class="course-level">Specialist</span>
                    </div>
                    <div class="course-body">
                        <p class="course-description">Navigate legal terminology, contracts, and documentation with confidence and precision.</p>
                        <div class="course-meta">
                            <span class="meta-item">üìö Multiple lessons</span>
                            <span class="meta-item">‚è±Ô∏è Self-paced</span>
                        </div>
                    </div>
                </a>
            </div>
        </section>

        <section class="section">
            <div class="section-header">
                <span class="section-icon">üìñ</span>
                <h2 class="section-title">General English Courses</h2>
            </div>
            <div class="course-grid">
                <a href="/beginner/" class="course-card">
                    <div class="course-header">
                        <span class="course-icon">üå±</span>
                        <h3 class="course-title">Beginner Course</h3>
                        <span class="course-level">A1-A2</span>
                    </div>
                    <div class="course-body">
                        <p class="course-description">Start your English journey. Learn basic grammar, vocabulary, and everyday conversation skills.</p>
                        <div class="course-meta">
                            <span class="meta-item">üìö Foundation level</span>
                            <span class="meta-item">‚è±Ô∏è Step by step</span>
                        </div>
                    </div>
                </a>
                <a href="/intermediate/" class="course-card">
                    <div class="course-header">
                        <span class="course-icon">üöÄ</span>
                        <h3 class="course-title">Intermediate Course</h3>
                        <span class="course-level">B1-B2</span>
                    </div>
                    <div class="course-body">
                        <p class="course-description">Build confidence with complex grammar and expand your vocabulary for real-world situations.</p>
                        <div class="course-meta">
                            <span class="meta-item">üìö Expanding skills</span>
                            <span class="meta-item">‚è±Ô∏è Progressive</span>
                        </div>
                    </div>
                </a>
                <a href="/advanced/" class="course-card">
                    <div class="course-header">
                        <span class="course-icon">üéØ</span>
                        <h3 class="course-title">Advanced Course</h3>
                        <span class="course-level">C1-C2</span>
                    </div>
                    <div class="course-body">
                        <p class="course-description">Master sophisticated expressions, idioms, and achieve native-like fluency in British English.</p>
                        <div class="course-meta">
                            <span class="meta-item">üìö Mastery level</span>
                            <span class="meta-item">‚è±Ô∏è Advanced</span>
                        </div>
                    </div>
                </a>
            </div>
        </section>

        <section class="section">
            <div class="section-header">
                <span class="section-icon">‚òï</span>
                <h2 class="section-title">The Break Room</h2>
            </div>
            <div class="quick-links">
                <a href="/games/" class="quick-link">
                    <span class="quick-link-icon">üéÆ</span>
                    <div class="quick-link-text">
                        <div class="quick-link-title">Game Zone</div>
                        <div class="quick-link-desc">Play Taboo, Memory Match & More</div>
                    </div>
                </a>
            </div>
        </section>
    </main>

    <footer class="footer">
        <p class="footer-text">¬© 2025 English For Cool Dudes - üòé</p>
        <div style="margin-top: 10px;">
            <a href="/impressum/" style="color: #667EEA; margin-right: 15px; text-decoration: none;">Impressum</a>
            <a href="/datenschutz/" style="color: #667EEA; text-decoration: none;">Datenschutzerkl√§rung</a>
        </div>
    </footer>

<script>
    const SUPABASE_URL = 'https://knwgmrgwbpchqyqxbxea.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtud2dtcmd3YnBjaHF5cXhieGVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MDkyODgsImV4cCI6MjA3ODA4NTI4OH0.qnp2ScwSE77_idmPhpLE98sr46WvLpKtg6refFfC7s8';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // --- DICTIONARY FUNCTIONS ---
    function showDictionary(word, definition, type) {
        document.getElementById('dictionary-popup').style.display = 'block';
        document.getElementById('dictionary-overlay').style.display = 'block';
        const content = document.getElementById('dictionary-content');
        content.innerHTML = `
            <h3 style="color: #667EEA; font-size: 20px; margin-bottom: 10px; font-weight: 600;">${word} <span style="font-size: 14px; color: #718096; font-weight: 600;">(${type})</span></h3>
            <p style="color: #4A5568; line-height: 1.7; margin-bottom: 20px;">${definition}</p>
            <button onclick="closeDictionary()" style="background: #E5E9F2; color: #4A5568; border: none; padding: 10px 30px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px; margin-top: 20px; ">Close</button>
        `;
    }

    function closeDictionary() {
        document.getElementById('dictionary-popup').style.display = 'none';
        document.getElementById('dictionary-overlay').style.display = 'none';
    }
    document.getElementById('dictionary-overlay').addEventListener('click', closeDictionary);

    // --- MISTAKE MANAGEMENT LOGIC ---
    function handleCheckboxChange() {
        const popup = document.getElementById('mistake-reminder-popup');
        if (!popup) return;
        const clearSelectedBtn = popup.querySelector('#clear-selected-btn');
        const checkboxes = popup.querySelectorAll('.word-checkbox');
        const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
        
        if (anyChecked) {
            clearSelectedBtn.style.opacity = '1.0';
            clearSelectedBtn.style.pointerEvents = 'auto';
        } else {
            clearSelectedBtn.style.opacity = '0.6';
            clearSelectedBtn.style.pointerEvents = 'none';
        }
    }

    async function clearSelectedMistakes() {
        const popup = document.getElementById('mistake-reminder-popup');
        if (!popup) return;
        const checkboxes = popup.querySelectorAll('.word-checkbox:checked');
        if (checkboxes.length === 0) return alert("Please select at least one word.");

        try {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) return alert('You must be logged in.');
            if (!confirm(`Clear ${checkboxes.length} selected word(s)?`)) return;
            
            const deletePromises = [];
            checkboxes.forEach(checkbox => {
                const [word, lesson] = checkbox.dataset.key.split('::');
                deletePromises.push(supabase.from('user_mistakes').delete().eq('user_id', user.id).eq('word', word).eq('lesson', lesson));
            });

            await Promise.all(deletePromises);
            alert(`${checkboxes.length} word(s) cleared!`);
            document.getElementById('mistake-reminder-popup').remove();
            document.getElementById('mistake-reminder-overlay').remove();
            checkForMistakesOnHomepage();
        } catch (error) {
            console.error(error);
            alert('Error clearing words.');
        }
    }

    async function checkForMistakesOnHomepage() {
        try {
            const { data: { user } = {} } = await supabase.auth.getUser();
            if (!user) return; 

            const { data: mistakes, error } = await supabase
                .from('user_mistakes')
                .select('word, definition, word_type, lesson, lesson_link, last_made_at')
                .eq('user_id', user.id)
                .order('last_made_at', { ascending: false })
                .limit(10); 

            if (error) return console.error('Error:', error);

            if (mistakes && mistakes.length > 0) {
                showMistakeReminderHomepage(mistakes);
                if (mistakes.length === 10) {
                    const tenthItemDate = mistakes[9].last_made_at;
                    await supabase.from('user_mistakes').delete().eq('user_id', user.id).lt('last_made_at', tenthItemDate); 
                }
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function showMistakeReminderHomepage(mistakes) {
        const lessonGroups = {};
        mistakes.forEach(m => {
            if (!lessonGroups[m.lesson]) lessonGroups[m.lesson] = { words: [], link: m.lesson_link };
            lessonGroups[m.lesson].words.push(m);
        });

        let lessonHTML = '';
        let wordCheckboxesHTML = '';

        for (const [lessonName, lessonData] of Object.entries(lessonGroups)) {
            const wordList = lessonData.words.map(w =>
                `<strong class="clickable-word" data-word="${w.word}" data-definition="${w.definition || ''}" data-type="${w.word_type || 'word'}">${w.word}</strong>`
            ).join(', ');

            lessonHTML += `
                <div style="margin: 15px 0; padding: 15px; background: #FEF2F2; border-radius: 8px; border-left: 4px solid #DC2626;">
                    <p style="font-size: 14px; color: #666; margin-bottom: 8px; font-weight: 600;">
                        üìö ${lessonName} ${lessonData.link ? `<a href="${lessonData.link}" style="color: #667EEA; text-decoration: none; margin-left: 8px; font-size: 12px;">‚Üó Revisit</a>` : ''}
                    </p>
                    <p style="color: #DC2626; font-weight: 600; line-height: 1.6;">${wordList}</p>
                </div>
            `;
            
            lessonData.words.forEach(w => {
                const uniqueKey = `${w.word}::${w.lesson}`;
                wordCheckboxesHTML += `
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="check-${uniqueKey}" data-key="${uniqueKey}" class="word-checkbox" style="margin-right: 6px; transform: scale(1.1);">
                        <label for="check-${uniqueKey}" style="font-size: 14px; color: #4A5568;">${w.word}</label>
                    </div>`;
            });
        }

        const popup = document.createElement('div');
        popup.id = 'mistake-reminder-popup';
        popup.style.cssText = `position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 10000; max-width: 600px; width: 90%; max-height: 85vh; overflow-y: auto;`;
        popup.innerHTML = `
        <h2 style="color: #DC2626; margin-bottom: 15px; font-size: 24px; font-weight: 600;"> üö® Don't Forget These Words! </h2>
                <p style="color: #666; margin-bottom: 20px;">You might want to review and practise these words. Have fun!</p>

                ${lessonHTML}

                <div style="margin-top: 15px; background: #F8F9FB; padding: 15px; border-radius: 8px; border: 1px solid #E5E9F2;">
                    <p style="font-weight: 600; color: #1A202C; margin-bottom: 10px;">
                        ‚úÖ Manage Your List:
                    </p>
                    <div id="word-checkboxes" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px;">
                        ${wordCheckboxesHTML} 
                    </div>
                    <button id="clear-selected-btn" style="
                        background: #DC2626;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 8px;
                        font-weight: 600;
                        cursor: pointer;
                        font-size: 14px;
                        margin-top: 15px;
                        width: 100%;
                        opacity: 0.6;
                        pointer-events: none;
                        transition: opacity 0.2s;
                    ">üóëÔ∏è Clear Selected Words</button>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                    <button id="practice-btn" style="
                        background: #667EEA;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-weight: 600;
                        cursor: pointer;
                        font-size: 16px;
                        flex: 1;
                        min-width: 140px;
                    ">üî• Practice Now</button>
                    
                    <button id="got-it-btn" style="
                        background: #E5E9F2;
                        color: #4A5568;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-weight: 600;
                        cursor: pointer;
                        font-size: 16px;
                        flex: 1;
                        min-width: 140px;
                    ">Got it! üëç</button>
                    
                    <button id="clear-all-btn" style="
                        background: #DC2626;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-weight: 600;
                        cursor: pointer;
                        font-size: 16px;
                        flex: 1;
                        min-width: 140px;
                    ">üóëÔ∏è Clear All Words</button>
                </div>
            `;

        const overlay = document.createElement('div');
        overlay.id = 'mistake-reminder-overlay';
        overlay.style.cssText = `position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999;`;

        document.body.appendChild(overlay);
        document.body.appendChild(popup);

        popup.querySelectorAll('.word-checkbox').forEach(cb => cb.addEventListener('change', handleCheckboxChange));
        popup.querySelector('#clear-selected-btn').addEventListener('click', clearSelectedMistakes);
        popup.querySelectorAll('.clickable-word').forEach(wordEl => {
            wordEl.addEventListener('click', (e) => { e.stopPropagation(); showDictionary(wordEl.dataset.word, wordEl.dataset.definition, wordEl.dataset.type); });
        });

        document.getElementById('practice-btn').addEventListener('click', () => {
            document.getElementById('mistake-reminder-popup').remove();
            document.getElementById('mistake-reminder-overlay').remove();
            startPractice(mistakes);
        });

        document.getElementById('got-it-btn').addEventListener('click', () => {
            document.getElementById('mistake-reminder-popup').remove();
            document.getElementById('mistake-reminder-overlay').remove();
        });
    }

    // --- PRACTICE FUNCTION (WITH YOUR ORIGINAL WORDS + FALLBACK) ---
    function startPractice(mistakes) {
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function generateGapSentence(word, definition) {
            // 1. YOUR ORIGINAL SENTENCE LIST (RESTORED)
            const sentencePatterns = {

                To ensure the "Extra Practice" pop-up works for your new Phrasal Verbs lesson, you need to add these definitions to the sentencePatterns object inside your index.html.

Find the const sentencePatterns = { line (around line 496 in your code) and paste these new entries at the bottom of that list, just before the closing };.

Copy and Paste this block into sentencePatterns:
JavaScript

                // --- NEW PHRASAL VERBS ---
                'catch up': [
                    `I need to <span class="practice-gap" data-answer="${word}">____</span> on some emails before I go home.`,
                    `Go on ahead, I will <span class="practice-gap" data-answer="${word}">____</span> with you in a minute.`
                ],
                'put off': [
                    `Don't <span class="practice-gap" data-answer="${word}">____</span> doing your tax return until the last minute!`,
                    `We had to <span class="practice-gap" data-answer="${word}">____</span> the meeting because the boss is sick.`
                ],
                'call off': [
                    `The singer lost his voice, so they had to <span class="practice-gap" data-answer="${word}">____</span> the concert.`,
                    `Management decided to <span class="practice-gap" data-answer="${word}">____</span> the strike.`
                ],
                'look into': [
                    `That is a strange error. I will <span class="practice-gap" data-answer="${word}">____</span> it right away.`,
                    `Please <span class="practice-gap" data-answer="${word}">____</span> alternative suppliers for paper.`
                ],
                'run out of': [
                    `We need to go to the store, we have <span class="practice-gap" data-answer="${word}">____</span> milk.`,
                    `If we <span class="practice-gap" data-answer="${word}">____</span> time, we will finish this tomorrow.`
                ],
                'set up': [
                    `It took me two hours to <span class="practice-gap" data-answer="${word}">____</span> the new Wi-Fi system.`,
                    `Can you <span class="practice-gap" data-answer="${word}">____</span> a meeting with the client?`
                ],
                'fill in': [
                    `The receptionist is away, can you <span class="practice-gap" data-answer="${word}">____</span> for him today?`,
                    `Please <span class="practice-gap" data-answer="${word}">____</span> your details on this form.`
                ],
                'get along': [
                    `I am lucky that I <span class="practice-gap" data-answer="${word}">____</span> really well with my mother-in-law.`,
                    `It is important to <span class="practice-gap" data-answer="${word}">____</span> with your colleagues.`
                ],
                'turn down': [
                    `The salary was too low, so I had to <span class="practice-gap" data-answer="${word}">____</span> the job offer.`,
                    `Could you please <span class="practice-gap" data-answer="${word}">____</span> the music? It's too loud.`
                ],
                'burn out': [
                    `You work too hard! You are going to <span class="practice-gap" data-answer="${word}">____</span> if you aren't careful.`,
                    `Take a holiday to avoid suffering from <span class="practice-gap" data-answer="${word}">____</span>.`
                ]

'tortoise': [
    `Jonathan is the oldest <span class="practice-gap" data-answer="${word}">____</span> in the world.`,
    `A <span class="practice-gap" data-answer="${word}">____</span> moves very slowly and carries a shell.`
],
'island': [
    `St. Helena is a remote <span class="practice-gap" data-answer="${word}">____</span> in the Atlantic Ocean.`,
    `Robinson Crusoe was stranded on a desert <span class="practice-gap" data-answer="${word}">____</span>.`
],
'shell': [
    `The tortoise has a hard <span class="practice-gap" data-answer="${word}">____</span> to protect its body.`,
    `You can find a sea <span class="practice-gap" data-answer="${word}">____</span> on the beach.`
],
'born': [
    `Jonathan was <span class="practice-gap" data-answer="${word}">____</span> in the year 1832.`,
    `She was <span class="practice-gap" data-answer="${word}">____</span> in a small hospital in London.`
],
'slow': [
    `Tortoises are very <span class="practice-gap" data-answer="${word}">____</span> animals.`,
    `Please drive <span class="practice-gap" data-answer="${word}">____</span>; there are children playing.`
],
'history': [
    `He has lived through a lot of <span class="practice-gap" data-answer="${word}">____</span>, including two World Wars.`,
    `I am studying European <span class="practice-gap" data-answer="${word}">____</span> at university.`
],
'famous': [
    `Jonathan is very <span class="practice-gap" data-answer="${word}">____</span> on the island; everyone knows him.`,
    `He wants to be a <span class="practice-gap" data-answer="${word}">____</span> actor one day.`
],
'healthy': [
    `He eats <span class="practice-gap" data-answer="${word}">____</span> food like carrots and cucumbers.`,
    `Exercise is important for keeping your body <span class="practice-gap" data-answer="${word}">____</span>.`
],
'grass': [
    `He grazes on fresh <span class="practice-gap" data-answer="${word}">____</span> in the governor's garden.`,
    `Please keep off the <span class="practice-gap" data-answer="${word}">____</span> in the park.`
],
'sleep': [
    `He likes to <span class="practice-gap" data-answer="${word}">____</span> in the sun to stay warm.`,
    `I didn't get enough <span class="practice-gap" data-answer="${word}">____</span> last night.`
],
'visitor': [
    `A <span class="practice-gap" data-answer="${word}">____</span> came all the way from America to see him.`,
    `You must sign in as a <span class="practice-gap" data-answer="${word}">____</span> at the front desk.`
],
'record': [
    `He holds the world <span class="practice-gap" data-answer="${word}">____</span> for the oldest land animal.`,
    `She broke the speed <span class="practice-gap" data-answer="${word}">____</span> in the race.`
],

'budget': [
    `We must stick to our monthly <span class="practice-gap" data-answer="${word}">____</span> to save money.`,
    `The project went over <span class="practice-gap" data-answer="${word}">____</span> by $5,000.`
],
'expense': [
    `Travel is a major business <span class="practice-gap" data-answer="${word}">____</span> for us.`,
    `He filed an <span class="practice-gap" data-answer="${word}">____</span> report for his hotel bill.`
],
'profit': [
    `The company made a huge <span class="practice-gap" data-answer="${word}">____</span> this quarter.`,
    `They sold the house at a <span class="practice-gap" data-answer="${word}">____</span>.`
],
'tax': [
    `You must pay income <span class="practice-gap" data-answer="${word}">____</span> every year.`,
    `Sales <span class="practice-gap" data-answer="${word}">____</span> is added to the price of goods.`
],
'deposit': [
    `I need to go to the bank to <span class="practice-gap" data-answer="${word}">____</span> this check.`,
    `The landlord requires a security <span class="practice-gap" data-answer="${word}">____</span>.`
],
'withdraw': [
    `She stopped at the ATM to <span class="practice-gap" data-answer="${word}">____</span> some cash.`,
    `You cannot <span class="practice-gap" data-answer="${word}">____</span> more money than you have.`
],
'salary': [
    `He receives a monthly <span class="practice-gap" data-answer="${word}">____</span> of $3,000.`,
    `She negotiated a higher starting <span class="practice-gap" data-answer="${word}">____</span>.`
],
'transfer': [
    `I will <span class="practice-gap" data-answer="${word}">____</span> the money to your account today.`,
    `Bank <span class="practice-gap" data-answer="${word}">____</span> fees can be expensive.`
],
'interest': [
    `The bank pays 2% <span class="practice-gap" data-answer="${word}">____</span> on savings accounts.`,
    `High <span class="practice-gap" data-answer="${word}">____</span> rates make loans more expensive.`
],
'loan': [
    `They took out a bank <span class="practice-gap" data-answer="${word}">____</span> to buy a new car.`,
    `It will take five years to pay off the student <span class="practice-gap" data-answer="${word}">____</span>.`
],
'account': [
    `I opened a new savings <span class="practice-gap" data-answer="${word}">____</span> yesterday.`,
    `Please check your bank <span class="practice-gap" data-answer="${word}">____</span> details.`
],
'balance': [
    `Her bank <span class="practice-gap" data-answer="${word}">____</span> is currently zero.`,
    `You need to check your <span class="practice-gap" data-answer="${word}">____</span> before spending.`
],
                'conspirators': [
                    `The <span class="practice-gap" data-answer="${word}">____</span> met in secret to plan their attack.`,
                    `Police arrested several <span class="practice-gap" data-answer="${word}">____</span> involved in the plot.`
                ],
                'effigies': [
                    `On Bonfire Night, people burn <span class="practice-gap" data-answer="${word}">____</span> of Guy Fawkes.`,
                    `During the festival, <span class="practice-gap" data-answer="${word}">____</span> were displayed throughout the town.`
                ],
                'commemorates': [
                    `This holiday <span class="practice-gap" data-answer="${word}">____</span> an important historical event.`,
                    `Every year, the ceremony <span class="practice-gap" data-answer="${word}">____</span> those who fought for freedom.`
                ],
                'assembled': [
                    `The team <span class="practice-gap" data-answer="${word}">____</span> in the meeting room at 9am.`,
                    `He <span class="practice-gap" data-answer="${word}">____</span> a group of experts to solve the problem.`
                ],
                'uncovered': [
                    `Investigators <span class="practice-gap" data-answer="${word}">____</span> evidence of the crime.`,
                    `The journalist <span class="practice-gap" data-answer="${word}">____</span> a major scandal.`
                ],
                'shed': [
                    `The country has <span class="practice-gap" data-answer="${word}">____</span> its colonial past.`,
                    `She tried to <span class="practice-gap" data-answer="${word}">____</span> her negative reputation.`
                ],
                'charismatic': [
                    `The <span class="practice-gap" data-answer="${word}">____</span> leader inspired millions of followers.`,
                    `His <span class="practice-gap" data-answer="${word}">____</span> personality made him very popular.`
                ],
                'treason': [
                    `He was executed for <span class="practice-gap" data-answer="${word}">____</span> against the crown.`,
                    `Betraying your country is considered <span class="practice-gap" data-answer="${word}">____</span>.`
                ],
                'persecution': [
                    `They fled their homeland to escape religious <span class="practice-gap" data-answer="${word}">____</span>.`,
                    `The <span class="practice-gap" data-answer="${word}">____</span> of minorities is a serious human rights issue.`
                ],
                'gunpowder': [
                    `The barrels were filled with <span class="practice-gap" data-answer="${word}">____</span> for the explosion.`,
                    `They stored the <span class="practice-gap" data-answer="${word}">____</span> in a secret cellar.`
                ],
                'radicalization': [
                    `The <span class="practice-gap" data-answer="${word}">____</span> of young people is a growing concern.`,
                    `His <span class="practice-gap" data-answer="${word}">____</span> happened gradually over several years.`
                ],
                'vestige': [
                    `The old castle is the last <span class="practice-gap" data-answer="${word}">____</span> of medieval times.`,
                    `Only a <span class="practice-gap" data-answer="${word}">____</span> of the ancient city remains today.`
                ],
                'pageantry': [
                    `The royal wedding was full of traditional <span class="practice-gap" data-answer="${word}">____</span>.`,
                    `British <span class="practice-gap" data-answer="${word}">____</span> is famous around the world.`
                ],
                'audit': [
                    `The purpose of the <span class="practice-gap" data-answer="${word}">____</span> is to check the company's financial records.`,
                    `An external <span class="practice-gap" data-answer="${word}">____</span> was scheduled for next quarter.`
                ],
                'financial statements': [
                    `The <span class="practice-gap" data-answer="${word}">____</span> must be prepared according to GAAP.`,
                    `We reviewed the company's <span class="practice-gap" data-answer="${word}">____</span> before investing.`
                ],
                'annual report': [
                    `The <span class="practice-gap" data-answer="${word}">____</span> summarizes the company's performance for the year.`,
                    `We published our <span class="practice-gap" data-answer="${word}">____</span> last week.`
                ],
                'scrutiny': [
                    `The CEO's expenses came under intense <span class="practice-gap" data-answer="${word}">____</span>.`,
                    `Every line item required careful <span class="practice-gap" data-answer="${word}">____</span> from the auditors.`
                ],
                'settled': [
                    `All outstanding tax liabilities have been <span class="practice-gap" data-answer="${word}">____</span>.`,
                    `The dispute was amicably <span class="practice-gap" data-answer="${word}">____</span> out of court.`
                ],
                'verify': [
                    `We need to <span class="practice-gap" data-answer="${word}">____</span> the source of these funds.`,
                    `Please <span class="practice-gap" data-answer="${word}">____</span> the exact number before you report it.`
                ],
                'paramount': [
                    `Data security is <span class="practice-gap" data-answer="${word}">____</span> in this transaction.`,
                    `Client confidentiality is of <span class="practice-gap" data-answer="${word}">____</span> importance.`
                ],
                'review': [
                    `The board will <span class="practice-gap" data-answer="${word}">____</span> the quarterly earnings next Monday.`,
                    `We must perform an internal <span class="practice-gap" data-answer="${word}">____</span> before the external one.`
                ],
                'discrepancies': [
                    `The accountant found minor <span class="practice-gap" data-answer="${word}">____</span> between the two ledgers.`,
                    `We need to explain the <span class="practice-gap" data-answer="${word}">____</span> in the inventory count.`
                ],
                'inventories': [
                    `Proper valuation of <span class="practice-gap" data-answer="${word}">____</span> is a key audit focus.`,
                    `The warehouse holds all of the company's finished <span class="practice-gap" data-answer="${word}">____</span>.`
                ],
                'remote audits': [
                    `<span class="practice-gap" data-answer="${word}">____</span> have become increasingly common since 2020.`,
                    `We prefer <span class="practice-gap" data-answer="${word}">____</span> as they save travel time.`
                ],
                'prevalent': [
                    `This type of issue is especially <span class="practice-gap" data-answer="${word}">____</span> in the construction industry.`,
                    `Digital record-keeping is now the most <span class="practice-gap" data-answer="${word}">____</span> method.`
                ],
                'ledgers': [
                    `The auditors requested access to the company's general <span class="practice-gap" data-answer="${word}">____</span>.`,
                    `All transactions are recorded in the electronic <span class="practice-gap" data-answer="${word}">____</span>.`
                ],
                'onus': [
                    `The <span class="practice-gap" data-answer="${word}">____</span> is on the taxpayer to prove their deductions.`,
                    `The legal <span class="practice-gap" data-answer="${word}">____</span> is on the seller to disclose all defects.`
                ],
                'accessible': [
                    `Ensure all files are readily <span class="practice-gap" data-answer="${word}">____</span> to the audit team.`,
                    `The new database makes data more <span class="practice-gap" data-answer="${word}">____</span>.`
                ],
                'opinion': [
                    `The final result of the audit is typically an <span class="practice-gap" data-answer="${word}">____</span>.`,
                    `The auditor issued a qualified <span class="practice-gap" data-answer="${word}">____</span>.`
                ],
                'unqualified opinion': [
                    `An <span class="practice-gap" data-answer="${word}">____</span> means the financial statements are fair.`,
                    `Receiving an <span class="practice-gap" data-answer="${word}">____</span> is the best possible result.`
                ],
                'qualified opinion': [
                    `A <span class="practice-gap" data-answer="${word}">____</span> suggests material misstatements were found.`,
                    `The <span class="practice-gap" data-answer="${word}">____</span> led to a significant tax adjustment.`
                ],
                'implications': [
                    `We must understand the <span class="practice-gap" data-answer="${word}">____</span> of the new legislation.`,
                    `The political <span class="practice-gap" data-answer="${word}">____</span> of the decision were huge.`
                ],
                'cream of the crop': [
                    `Only the <span class="practice-gap" data-answer="${word}">____</span> were invited to the exclusive dinner.`,
                    `They selected the <span class="practice-gap" data-answer="${word}">____</span> from the job applicants.`
                ],
                'take the biscuit': [
                    `His excuse for being late really <span class="practice-gap" data-answer="${word}">____</span>; it was unbelievable.`,
                    `Of all the bad jokes I've heard, that one definitely <span class="practice-gap" data-answer="${word}">____</span>.`
                ],
                'spill the beans': [
                    `Please don't <span class="practice-gap" data-answer="${word}">____</span> about the surprise party!`,
                    `He accidentally <span class="practice-gap" data-answer="${word}">____</span> about the company's new product.`
                ],
                'not my cup of tea': [
                    `I appreciate modern art, but it's <span class="practice-gap" data-answer="${word}">____</span>.`,
                    `Football is really <span class="practice-gap" data-answer="${word}">____</span>; I prefer rugby.`
                ],
                'bring home the bacon': [
                    `It's a traditional expectation that the man <span class="practice-gap" data-answer="${word}">____</span>.`,
                    `He works two jobs to <span class="practice-gap" data-answer="${word}">____</span> and pay the bills.`
                ],
                'monetary stability': [
                    `The Bank's main goal is to maintain <span class="practice-gap" data-answer="${word}">____</span> in the UK.`,
                    `Central banks work to ensure <span class="practice-gap" data-answer="${word}">____</span> for the economy.`
                ],
                'inflation': [
                    `When prices rise rapidly, we call it high <span class="practice-gap" data-answer="${word}">____</span>.`,
                    `The Bank raises interest rates to control <span class="practice-gap" data-answer="${word}">____</span>.`
                ],
                'confidence': [
                    `Public <span class="practice-gap" data-answer="${word}">____</span> in the banking system is crucial.`,
                    `People need <span class="practice-gap" data-answer="${word}">____</span> that their money is safe.`
                ],
                'banknotes': [
                    `The Bank of England prints all British <span class="practice-gap" data-answer="${word}">____</span>.`,
                    `Only the central bank can issue <span class="practice-gap" data-answer="${word}">____</span> in England.`
                ],
                'vault': [
                    `Gold reserves are stored in a secure underground <span class="practice-gap" data-answer="${word}">____</span>.`,
                    `The Bank's <span class="practice-gap" data-answer="${word}">____</span> holds billions of pounds worth of gold.`
                ],
                'governor': [
                    `The <span class="practice-gap" data-answer="${word}">____</span> is the highest-ranking official at the Bank.`,
                    `The <span class="practice-gap" data-answer="${word}">____</span> leads the Monetary Policy Committee.`
                ],
                'regulation': [
                    `New banking <span class="practice-gap" data-answer="${word}">____</span> was introduced to prevent financial crises.`,
                    `The Financial Conduct Authority enforces strict <span class="practice-gap" data-answer="${word}">____</span>.`
                ],
                'stimulate': [
                    `The government hopes to <span class="practice-gap" data-answer="${word}">____</span> the economy by cutting taxes.`,
                    `Lowering interest rates can help <span class="practice-gap" data-answer="${word}">____</span> borrowing and spending.`
                ],
                'crucial': [
                    `Maintaining public trust is <span class="practice-gap" data-answer="${word}">____</span> for the central bank's authority.`,
                    `It is <span class="practice-gap" data-answer="${word}">____</span> that we act quickly to control inflation.`
                ],
                'adapt': [
                    `Businesses must <span class="practice-gap" data-answer="${word}">____</span> to new financial <span class="practice-gap" data-answer="regulation">regulation</span> quickly.`,
                    `We must <span class="practice-gap" data-answer="${word}">____</span> our strategy in light of the new data.`
                ],
                'set': [
                    `The Monetary Policy Committee must <span class="practice-gap" data-answer="${word}">____</span> the base interest rate.`,
                    `The new law will <span class="practice-gap" data-answer="${word}">____</span> the framework for banking operations.`
                ],
                'central': [
                    `The Bank of England is the <span class="practice-gap" data-answer="${word}">____</span> bank of the United Kingdom.`,
                    `Price stability is a <span class="practice-gap" data-answer="${word}">____</span> theme of their policy document.`
                ],
                'candy': [
                    `The children collected lots of <span class="practice-gap" data-answer="${word}">____</span> on Halloween.`,
                    `Would you like some <span class="practice-gap" data-answer="${word}">____</span>? I have chocolate.`
                ],
                'door': [
                    `Please open the <span class="practice-gap" data-answer="${word}">____</span> for me.`,
                    `Knock on the <span class="practice-gap" data-answer="${word}">____</span> and say "Trick or Treat!"`
                ],
                'bag': [
                    `Put your candy in this <span class="practice-gap" data-answer="${word}">____</span>.`,
                    `I carry a big <span class="practice-gap" data-answer="${word}">____</span> for Halloween.`
                ],
                'costume': [
                    `I like your ghost <span class="practice-gap" data-answer="${word}">____</span>! Very scary!`,
                    `What <span class="practice-gap" data-answer="${word}">____</span> will you wear this Halloween?`
                ],
                'trick or treat': [
                    `The children shout "<span class="practice-gap" data-answer="${word}">____</span>!" at every house.`,
                    `When you knock on the door, say "<span class="practice-gap" data-answer="${word}">____</span>!"`
                ],
                'vat': [
                    `The standard rate of <span class="practice-gap" data-answer="${word}">____</span> in the UK is 20%.`,
                    `Import duties and <span class="practice-gap" data-answer="${word}">____</span> apply to goods entering the country.`
                ],
                'digital services': [
                    `Streaming movies is an example of <span class="practice-gap" data-answer="${word}">____</span>.`,
                    `New tax rules specifically target <span class="practice-gap" data-answer="${word}">____</span> like software and e-books.`
                ],
                'place of supply': [
                    `The <span class="practice-gap" data-answer="${word}">____</span> rules determine which country gets the tax.`,
                    `For digital goods, the <span class="practice-gap" data-answer="${word}">____</span> is usually where the customer lives.`
                ],
                'jurisdiction': [
                    `The company operates in more than one legal <span class="practice-gap" data-answer="${word}">____</span>.`,
                    `Which <span class="practice-gap" data-answer="${word}">____</span> has the right to tax this profit?`
                ],
                'reverse charge mechanism': [
                    `The <span class="practice-gap" data-answer="${word}">____</span> shifts the tax responsibility to the buyer.`,
                    `In B2B trade, we often use the <span class="practice-gap" data-answer="${word}">____</span> to avoid VAT registration.`
                ],
                'b2b': [
                    `<span class="practice-gap" data-answer="${word}">____</span> transactions are often between wholesalers and retailers.`,
                    `Our <span class="practice-gap" data-answer="${word}">____</span> marketing strategy focuses on other companies.`
                ],
                'b2c': [
                    `<span class="practice-gap" data-answer="${word}">____</span> sales require the seller to charge local VAT.`,
                    `In <span class="practice-gap" data-answer="${word}">____</span> transactions, the customer is the end-user.`
                ],
                'remittance': [
                    `Please send the <span class="practice-gap" data-answer="${word}">____</span> to our bank account by Friday.`,
                    `International money <span class="practice-gap" data-answer="${word}">____</span> can take several days.`
                ],
                'compliance': [
                    `The legal team ensures full <span class="practice-gap" data-answer="${word}">____</span> with all regulations.`,
                    `Failure to maintain <span class="practice-gap" data-answer="${word}">____</span> can result in heavy fines.`
                ],
                'threshold': [
                    `You must register for VAT once you cross the sales <span class="practice-gap" data-answer="${word}">____</span>.`,
                    `The tax-free <span class="practice-gap" data-answer="${word}">____</span> for income tax is ¬£12,570.`
                ],
                'intangibles': [
                    `Software and patents are classified as <span class="practice-gap" data-answer="${word}">____</span>.`,
                    `Digital downloads are taxed as <span class="practice-gap" data-answer="${word}">____</span> rather than physical goods.`
                ],
                'exempt': [
                    `Basic food items are usually <span class="practice-gap" data-answer="${word}">____</span> from VAT.`,
                    `Charities are often <span class="practice-gap" data-answer="${word}">____</span> from paying certain taxes.`
                ],
                'liable': [
                    `If you break the contract, you may be <span class="practice-gap" data-answer="${word}">____</span> for damages.`,
                    `Directors can be held personally <span class="practice-gap" data-answer="${word}">____</span> for company debts.`
                ],
                'mechanism': [
                    `The government introduced a new <span class="practice-gap" data-answer="${word}">____</span> for collecting taxes.`,
                    `The reverse charge is a useful <span class="practice-gap" data-answer="${word}">____</span> to prevent fraud.`
                ],
                'impounded': [
                    `The text claimed my car would be <span class="practice-gap" data-answer="${word}">____</span> if I didn't pay the fine.`,
                    `Police <span class="practice-gap" data-answer="${word}">____</span> the vehicle after finding illegal goods.`
                ],
                'duped': [
                    `Millions of people were <span class="practice-gap" data-answer="${word}">____</span> by the fake text message.`,
                    `The scammers <span class="practice-gap" data-answer="${word}">____</span> her into giving them her password.`
                ],
                'phishing': [
                    `This email looks like a <span class="practice-gap" data-answer="${word}">____</span> attempt; don't click the link.`,
                    `<span class="practice-gap" data-answer="${word}">____</span> scams often try to steal credit card details.`
                ],
                'red flags': [
                    `The poor grammar in the message raised <span class="practice-gap" data-answer="${word}">____</span> for me.`,
                    `There were several <span class="practice-gap" data-answer="${word}">____</span> in his story that made police suspicious.`
                ],
                'authorization': [
                    `Please enter the <span class="practice-gap" data-answer="${word}">____</span> code sent to your phone.`,
                    `Never share your 2-factor <span class="practice-gap" data-answer="${word}">____</span> code with anyone.`
                ],
                'revenue': [
                    `This scam generates over $1 billion in illicit <span class="practice-gap" data-answer="${word}">____</span>.`,
                    `Toll roads are a significant source of government <span class="practice-gap" data-answer="${word}">____</span>.`
                ],
                'transmit': [
                    `The software allows them to <span class="practice-gap" data-answer="${word}">____</span> the card signal across the ocean.`,
                    `Please <span class="practice-gap" data-answer="${word}">____</span> the data to the secure server immediately.`
                ],
                'legitimate': [
                    `The website looked <span class="practice-gap" data-answer="${word}">____</span>, but it was actually fake.`,
                    `She had a <span class="practice-gap" data-answer="${word}">____</span> reason for being late.`
                ],
                'authenticated': [
                    `The user must be <span class="practice-gap" data-answer="${word}">____</span> before accessing the file.`,
                    `Once the card is <span class="practice-gap" data-answer="${word}">____</span>, the payment goes through.`
                ],
                'proof of concept': [
                    `They built a small <span class="practice-gap" data-answer="${word}">____</span> to show investors how it works.`,
                    `We need a <span class="practice-gap" data-answer="${word}">____</span> before we fund the full project.`
                ],
                'tokenized': [
                    `For security, your credit card number is <span class="practice-gap" data-answer="${word}">____</span>.`,
                    `The database stores <span class="practice-gap" data-answer="${word}">____</span> values to protect privacy.`
                ],
                'illicit': [
                    `The gang made millions from <span class="practice-gap" data-answer="${word}">____</span> activities.`,
                    `Smuggling is an example of <span class="practice-gap" data-answer="${word}">____</span> trade.`
                ]
            };

            const normalizedWord = word.toLowerCase();

            // 2. CHECK FOR SPECIFIC SENTENCES
            if (sentencePatterns[normalizedWord]) {
                const patterns = sentencePatterns[normalizedWord];
                return patterns[Math.floor(Math.random() * patterns.length)];
            }

            // 3. FALLBACK MECHANISM (Use Definition)
            if (definition && definition.length > 3) {
                return `<strong>Definition:</strong> "${definition}" <br> Word: <span class="practice-gap" data-answer="${word}">____</span>`;
            }

            // 4. FINAL FAILSAFE
            return `The word is: <span class="practice-gap" data-answer="${word}">____</span>`;
        }

        // Limit to 6 random words from the mistakes list
        const initialWords = shuffleArray([...mistakes]).slice(0, 10);
        
        // Generate items using the new logic
        const practiceItems = initialWords.map(w => {
            const sentence = generateGapSentence(w.word, w.definition);
            return sentence ? { word: w.word, sentence: sentence } : null;
        }).filter(item => item !== null); 

        if (practiceItems.length === 0) {
             alert("No practice words available right now.");
             return; 
        }

        // Generate sentences HTML
        let sentencesHTML = practiceItems.map((item, index) => {
            return `
                <div style="margin-bottom: 20px; font-size: 17px; background: #FFF; padding: 15px; border-radius: 8px; border: 1px solid #E5E9F2;">
                    ${index + 1}. ${item.sentence}
                </div>
            `;
        }).join('');

        // --- UI CREATION (Popup) ---
        const practicePopup = document.createElement('div');
        practicePopup.style.cssText = `
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 30px; border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 10000;
            max-width: 700px; width: 90%; max-height: 85vh; overflow-y: auto;
        `;

        const overlay = document.createElement('div');
        overlay.id = 'mistake-reminder-overlay-practice';
        overlay.style.cssText = `
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 9999;
        `;

        // Shuffle words for word bank
        const shuffledWordsForBank = shuffleArray(practiceItems.map(item => ({ word: item.word })));

        practicePopup.innerHTML = `
            <h2 style="color: #667EEA; margin-bottom: 15px; font-size: 24px; font-weight: 600;"> üî• Quick Practice Exercise </h2>
            <p style="color: #666; margin-bottom: 20px;">Fill in the blanks:</p>

            <div style="background: #F0F4FF; border: 2px solid #667EEA; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                <p style="font-weight: 600; margin-bottom: 10px; color: #4A5568;">Word Bank (Click to Select):</p>
                <div id="practice-word-bank" style="display: flex; flex-wrap: wrap; gap: 8px;">
                    ${shuffledWordsForBank.map(w => `
                        <span class="practice-word" data-word="${w.word}" style="
                            background: #667EEA; color: white; padding: 8px 14px;
                            border-radius: 6px; cursor: pointer; font-weight: 600;
                            transition: all 0.2s; user-select: none;
                        ">${w.word}</span>
                    `).join('')}
                </div>
            </div>

            <div id="practice-sentences">${sentencesHTML}</div>

            <p id="practice-feedback" style="font-weight: 600; font-size: 18px; margin: 20px 0; text-align: center; color: #4A5568; min-height: 25px;">Ready to check your answers?</p>
            
            <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                <button id="check-practice-btn" style="
                    background: #10B981; color: white; border: none; padding: 12px 24px;
                    border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px;
                    flex: 1; min-width: 140px; transition: background-color 0.2s;
                ">‚úÖ Check Answers</button>
                
                <button id="close-practice-btn" style="
                    background: #E5E9F2; color: #4A5568; border: none; padding: 12px 24px;
                    border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px;
                    flex: 1; min-width: 140px;
                ">‚ùå Close</button>
            </div>
        `;

        document.body.appendChild(overlay);
        document.body.appendChild(practicePopup);

        // --- INTERACTION LOGIC ---
        let selectedWord = null;

        // 1. Select Word
        document.querySelectorAll('.practice-word').forEach(wordEl => {
            wordEl.addEventListener('click', () => {
                if (wordEl.classList.contains('used')) return;
                if (selectedWord) selectedWord.style.boxShadow = 'none';
                selectedWord = wordEl;
                selectedWord.style.boxShadow = '0 0 0 3px #667EEA';
            });
        });

        // 2. Fill Gap
        document.querySelectorAll('.practice-gap').forEach(gap => {
            // Apply styles dynamically
            gap.style.borderBottom = '2px dashed #999';
            gap.style.padding = '0 5px'; gap.style.cursor = 'pointer';
            gap.style.minWidth = '80px'; gap.style.display = 'inline-block';
            gap.style.textAlign = 'center'; gap.style.fontWeight = '600';
            gap.style.color = '#1A202C'; gap.style.background = '#F8F9FB';
            gap.style.borderColor = '#E5E9F2'; gap.style.borderRadius = '4px';

            gap.addEventListener('click', () => {
                if (!selectedWord) return;
                // If refilling, free up the old word
                if (gap.dataset.filled === 'true') {
                    const oldWordEl = document.querySelector(`.practice-word[data-word="${gap.dataset.filledWord}"]`);
                    if (oldWordEl) {
                        oldWordEl.classList.remove('used');
                        oldWordEl.style.opacity = '1.0';
                        oldWordEl.style.pointerEvents = 'auto';
                    }
                }
                // Fill
                gap.textContent = selectedWord.dataset.word;
                gap.dataset.filled = 'true';
                gap.dataset.filledWord = selectedWord.dataset.word;
                gap.style.background = '#FBBF24'; gap.style.borderStyle = 'solid'; gap.style.borderColor = '#F59E0B';

                // Mark word used
                selectedWord.classList.add('used');
                selectedWord.style.opacity = '0.3'; selectedWord.style.pointerEvents = 'none';
                selectedWord.style.boxShadow = 'none';
                selectedWord = null;
            });
        });

        // 3. Check Answers
        document.getElementById('check-practice-btn').addEventListener('click', () => {
            let correct = 0, total = 0;
            document.querySelectorAll('.practice-gap').forEach(gap => {
                total++;
                if (gap.dataset.filledWord === gap.dataset.answer) {
                    correct++;
                    gap.style.background = '#10B981'; gap.style.color = 'white'; gap.style.borderColor = '#10B981';
                } else {
                    gap.style.background = '#DC2626'; gap.style.color = 'white'; gap.style.borderColor = '#DC2626';
                }
            });

            const feedback = document.getElementById('practice-feedback');
            if (correct === total) {
                feedback.innerHTML = 'üéâ Perfect! All correct!'; feedback.style.color = '#10B981';
            } else {
                feedback.innerHTML = `üìä You got ${correct}/${total} correct.`; feedback.style.color = '#F59E0B';
            }
            document.getElementById('check-practice-btn').style.pointerEvents = 'none';
            document.getElementById('check-practice-btn').style.opacity = '0.6';
        });

        // 4. Close
        const closeFn = () => { practicePopup.remove(); overlay.remove(); };
        document.getElementById('close-practice-btn').addEventListener('click', closeFn);
        overlay.addEventListener('click', closeFn);
    }

   // --- OFFICE PULSE LOGIC (Team Stats) ---
    async function loadOfficePulse() {
        const pulseText = document.getElementById('pulse-ticker-text');
        if(!pulseText) return;

        // 1. Fetch Recent Activity Feed
        const { data: feed } = await supabase.from('office_pulse').select('*');

        // Initialize empty list (No sign-up message, no total count)
        const messages = [];

        // Add Recent Activity to the list
        if (feed && feed.length > 0) {
            feed.forEach(item => {
                const time = getTimeAgo(new Date(item.completed_at));
                const link = item.lesson_link || '#'; 
                // Add the "Cool Dude" completion message
                messages.push(`ü•≥ ${time}: A Cool Dude finished <a href="${link}" target="_blank">${item.lesson_title}</a> (+${item.word_count} words)`);
            });
        } else {
            // Fallback if the database is empty
            messages.push("üöÄ Be the first Cool Dude to complete a lesson today!");
        }

        // Display the first message immediately
        if (messages.length > 0) {
            pulseText.innerHTML = messages[0];
        }

        // If we have more than 1 message, start cycling
        if (messages.length > 1) {
            let msgIndex = 1; // FIX: Start at 1 because 0 is already showing!
            
            setInterval(() => {
                pulseText.style.opacity = 0;
                setTimeout(() => {
                    pulseText.innerHTML = messages[msgIndex];
                    pulseText.style.opacity = 1;
                    msgIndex = (msgIndex + 1) % messages.length;
                }, 500);
            }, 5000);
        }
    }

    // --- HELPER FUNCTIONS (Animation & Time) ---
    function getTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + " years ago";
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + " months ago";
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + " days ago";
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + " hours ago";
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + " mins ago";
        return "Just now";
    }

    function animateValue(obj, start, end, duration) {
        if(!obj) return;
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = Math.floor(progress * (end - start) + start);
            if (progress < 1) window.requestAnimationFrame(step);
        };
        window.requestAnimationFrame(step);
    }

    // --- AUTH & INIT ---
    async function initializeAuthHeader() {
        const loggedOutButtons = document.getElementById('logged-out-buttons');
        const loggedInButtons = document.getElementById('logged-in-buttons');
        const logoutBtn = document.getElementById('logout-btn');
        const userGreeting = document.getElementById('user-greeting');

         try {
            const { data: { user }, error } = await supabase.auth.getUser();

            if (user) {
                console.log('User logged in:', user.email);
                let userName = 'Cool Dude';
                if (user.user_metadata && user.user_metadata.full_name) {
                    userName = user.user_metadata.full_name.split(' ')[0];
                } else if (user.email) {
                    userName = user.email.split('@')[0];
                }
                
                if (userGreeting) userGreeting.textContent = `Hey ${userName}! üëã`;
                if (loggedInButtons) loggedInButtons.style.display = 'flex';
                if (loggedOutButtons) loggedOutButtons.style.display = 'none';
            } else {
                if (loggedOutButtons) loggedOutButtons.style.display = 'flex';
                if (loggedInButtons) loggedInButtons.style.display = 'none';
            }
        } catch (err) {
            console.error('Error checking auth:', err);
            if (loggedOutButtons) loggedOutButtons.style.display = 'flex';
            if (loggedInButtons) loggedInButtons.style.display = 'none';
        }

        if (logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                try {
                    const { error } = await supabase.auth.signOut();
                    if (error) console.error('Logout error:', error);
                    else window.location.reload();
                } catch (err) {
                    console.error('Unexpected logout error:', err);
                }
            });
        }
    }

    // --- TICKER (BOTTOM) ---
    const LESSON_STATES = [
        { text: 'üåê NEW! TAX: The Netflix Tax üé¨üçø', href: '/VATdigital/' },
                { text: "üö© NEW! LEGAL: Due Diligence in M&A üíº", href: "/duediligence/" },
                { text: "üî• NEW! BEGINNER: Bonfire Night and Guy Fawkes üéÜ", href: "/bonfire/" },
                { text: "üèß NEW! INTERMEDIATE: The Bank of England üí∞", href: "/boe/" },
                { text: "üèß NEW! TAX: Tax Audit Essentials üîç", href: "/audit/" },
                { text: "üöÄ NEW! BUSINESS: Career Progression üéØ", href: "/feedback/" },
                { text: "üëª NEW! BEGINNER: Trick or Treat! üéÉ", href: "/trickortreat/" },
                { text: "üéÉ NEW! INTERMEDIATE: Beware The Black Cat! üëª", href: "/halloween/" },
                { text: "üßü‚Äç‚ôÇÔ∏è NEW! ADVANCED: The Creation's Ruin - Frankenstein ‚ö∞Ô∏è", href: "/frank/" },
                { text: "üòé NEW! ADVANCED: Unusual European Foods üç¥", href: "/weirdeurofoods/" },
                { text: "üòé NEW! BUSINESS: Change Management üß≠", href: "/changemanagement/" },
                { text: "üòé NEW! TAX: International Tax Essentials üåé", href: "/internationaltaxation/" },
                { text: "üòé NEW! BEGINNER: What's The Weather Like? ‚òî", href: "/weather/" },
                { text: "üòé NEW! INTERMEDIATE: Fortune Cookie English ü•†", href: "/fortunecookies/" },
                { text: "üòé NEW! LEGAL: Intellectual Property Law üèõÔ∏è", href: "/iplaw/" },
    ];
    let currentTickerIndex = 0;
    function updateTicker() {
        const ticker = document.getElementById('latest-updates-ticker');
        if (!ticker) return;
        currentTickerIndex = (currentTickerIndex + 1) % LESSON_STATES.length;
        ticker.style.opacity = 0;
        setTimeout(() => {
            ticker.textContent = LESSON_STATES[currentTickerIndex].text;
            ticker.href = LESSON_STATES[currentTickerIndex].href;
            ticker.style.opacity = 1;
        }, 200);
    }
    
    function startTickerAnimation() {
        const ticker = document.getElementById('latest-updates-ticker');
        if (!ticker) return;
        ticker.textContent = LESSON_STATES[0].text;
        ticker.href = LESSON_STATES[0].href;
        setInterval(updateTicker, 4000);
        ticker.addEventListener('mouseenter', () => {
            ticker.style.animation = 'none';
            ticker.style.transform = 'scale(1.05)';
        });
        ticker.addEventListener('mouseleave', () => {
            ticker.style.animation = 'pulse 2s infinite ease-in-out';
            ticker.style.transform = 'scale(1)';
        });
    }

    // --- MAIN INIT ---
    document.addEventListener('DOMContentLoaded', async () => {
        await initializeAuthHeader();
        loadOfficePulse();
        startTickerAnimation();
        setTimeout(() => checkForMistakesOnHomepage(), 1500);
    });
</script>
</body>
</html>
