<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="/favicon.png" sizes="32x32">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="manifest" href="/manifest.json">
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English For Cool Dudes</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif; background: #F8F9FB; color: #2C3E50; line-height: 1.6; -webkit-font-smoothing: antialiased; }

        /* === 1. CLEAN MAIN HEADER === */
        .header { background: #FFFFFF; border-bottom: 1px solid #E5E9F2; padding: 20px 0; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.04); margin-bottom: 20px; }
        .header-content { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; }
        
        .header-left { display: flex; align-items: center; gap: 15px; }
        .logo { width: 36px; height: 36px; background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .site-title { font-size: 20px; font-weight: 600; color: #1A202C; letter-spacing: -0.02em; text-decoration: none; }

        .header-buttons { display: flex; align-items: center; gap: 8px; }
        .header-button { text-decoration: none; padding: 7px 14px; border-radius: 6px; font-size: 14px; font-weight: 600; transition: all 0.2s; white-space: nowrap; cursor: pointer; border: 1px solid #E5E9F2; background: transparent; }
        .header-button.login { background: #F8F9FB; color: #4A5568; }
        .header-button.login:hover { background: #FFFFFF; color: #2C3E50; border-color: #718096; }
        .header-button.signup { background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%); color: white; border: 1px solid transparent; }
        .header-button.signup:hover { background: linear-gradient(135deg, #5A6AD0 0%, #6D4396 100%); box-shadow: 0 2px 5px rgba(102, 126, 234, 0.4); }
        .header-button.dashboard { background: #FFFBEA; color: #92400E; border-color: #FCD34D; }
        .header-button.dashboard:hover { background: #FCD34D; border-color: #F59E0B; }
        .header-button.logout { background: #F8F9FB; color: #E53E3E; }
        .header-button.logout:hover { background: #FEEBEB; color: #C53030; border-color: #FBD3DA; }
        .user-greeting { font-size: 14px; color: #4A5568; font-weight: 600; margin-right: 5px; white-space: nowrap; }

        /* === 2. INFO BOX === */
        .container { max-width: 1200px; margin: 0 auto; padding: 30px 20px; }
        
        .info-box { 
            background: linear-gradient(135deg, #FFF9E6 0%, #FFF3CD 100%); 
            border-left: 4px solid #F59E0B; 
            padding: 20px 24px; 
            border-radius: 10px; 
            margin-bottom: 20px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            display: flex;
            align-items: center;
            min-height: 60px; 
        }

        /* === 2.5 THE REPAIR SHOP WIDGET === */
        #repair-shop-widget {
            display: none; 
            background: #FFFFFF;
            border: 1px solid #E5E9F2;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 40px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .repair-content { display: flex; align-items: center; justify-content: space-between; gap: 20px; flex-wrap: wrap; }
        .repair-text h3 { font-size: 18px; font-weight: 700; margin-bottom: 5px; }
        .repair-text p { font-size: 14px; color: #64748B; }
        
        .repair-btn {
            background: #EF4444; color: white; border: none; padding: 10px 20px;
            border-radius: 6px; font-weight: 600; cursor: pointer; text-decoration: none;
            display: inline-flex; align-items: center; gap: 8px; font-size: 14px;
            transition: transform 0.2s;
        }
        .repair-btn:hover { transform: translateY(-1px); }

        #pulse-ticker-text { 
            font-size: 15px; color: #92400E; font-weight: 600; margin: 0; line-height: 1.6;
            transition: opacity 0.5s ease-in-out; width: 100%;
        }
        #pulse-ticker-text a {
            color: #78350F; text-decoration: underline; text-decoration-style: dotted; transition: all 0.2s;
        }
        #pulse-ticker-text a:hover { color: #B45309; background: rgba(255,255,255,0.5); }
        
        /* === GAME CARDS === */
        .match-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
        .match-card {
            background: white; border: 2px solid #E2E8F0; border-radius: 8px;
            padding: 15px; cursor: pointer; min-height: 80px; display: flex;
            align-items: center; justify-content: center; text-align: center;
            font-size: 14px; font-weight: 600; color: #475569;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); user-select: none;
        }
        .match-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        .match-card.term { background: #FFF1F2; border-color: #FECACA; color: #BE123C; }
        .match-card.def { background: #FFFFFF; border-color: #CBD5E1; color: #334155; font-weight: 400; font-size: 13px; }
        
        .match-card.selected { border-color: #F59E0B; background: #FFFBEB; box-shadow: 0 0 0 3px #FCD34D; transform: scale(1.02); }
        
        .match-card.matched { 
            pointer-events: none; opacity: 0; transform: scale(0.8); 
        }
        
        /* ANIMATIONS */
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }

        /* === 3. COURSE CARDS === */
        .section { margin-bottom: 50px; }
        .section-header { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #E5E9F2; }
        .section-icon { font-size: 26px; }
        .section-title { font-size: 22px; font-weight: 600; color: #1A202C; letter-spacing: -0.02em; }
        .course-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .course-card { background: #FFFFFF; border: 1px solid #E5E9F2; border-radius: 12px; padding: 0; text-decoration: none; color: inherit; display: block; transition: all 0.2s; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
        .course-card:hover { border-color: #667EEA; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.12); transform: translateY(-2px); }
        .course-header { padding: 28px; background: linear-gradient(135deg, #F8F9FB 0%, #FFFFFF 100%); border-bottom: 1px solid #E5E9F2; }
        .course-icon { font-size: 48px; margin-bottom: 12px; display: block; }
        .course-title { font-size: 20px; font-weight: 600; color: #1A202C; margin-bottom: 8px; }
        .course-level { display: inline-block; background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%); color: white; padding: 5px 14px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px; }
        .course-body { padding: 28px; }
        .course-description { font-size: 15px; color: #4A5568; line-height: 1.7; margin-bottom: 18px; }
        .course-meta { display: flex; gap: 18px; font-size: 13px; color: #718096; font-weight: 600; padding-top: 18px; border-top: 1px solid #E5E9F2; }
        .meta-item { display: flex; align-items: center; gap: 5px; }

        /* QUICK LINKS */
        .quick-links { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 40px; }
        .quick-link { background: #FFFFFF; border: 1px solid #E5E9F2; border-radius: 10px; padding: 20px; text-decoration: none; color: inherit; display: flex; align-items: center; gap: 16px; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
        .quick-link:hover { border-color: #667EEA; background: #F8F9FB; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.12); transform: translateY(-1px); }
        .quick-link-icon { font-size: 32px; flex-shrink: 0; }
        .quick-link-title { font-size: 15px; font-weight: 600; color: #1A202C; margin-bottom: 3px; }
        .quick-link-desc { font-size: 13px; color: #718096; }

        #latest-updates-ticker { position: fixed; top: 20px; right: 50%; margin-right: -580px; z-index: 1000; cursor: pointer; background: #FFC107; color: #92400E; padding: 8px 15px; border-radius: 20px; font-size: 14px; font-weight: 600; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); transition: transform 0.2s; border: 2px solid #F59E0B; animation: pulse 2s infinite ease-in-out; text-decoration: none; white-space: nowrap; max-width: 450px; text-overflow: ellipsis; overflow: hidden; display: inline-block; }
        #latest-updates-ticker:hover { background: #FFD54F; transform: scale(1.05); animation: none; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }

        /* POPUPS */
        #dictionary-popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 10001; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        #dictionary-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; }

        .footer { background: #FFFFFF; border-top: 1px solid #E5E9F2; padding: 32px 20px; margin-top: 60px; text-align: center; }
        .footer-text { font-size: 14px; color: #718096; }

        @media (max-width: 1240px) { #latest-updates-ticker { right: 20px; margin-right: 0; } }
        @media (max-width: 768px) { .user-greeting { display: none; } .course-grid, .quick-links { grid-template-columns: 1fr; } }
        @media (max-width: 480px) { 
            .container { padding: 20px 15px 80px 15px; }
            #latest-updates-ticker { top: auto; bottom: 0; right: 0; left: 0; margin-right: 0; border-radius: 0; width: 100%; text-align: center; border: none; border-top: 2px solid #F59E0B; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <span class="logo">üòé</span>
                <a href="/" class="site-title">English For Cool Dudes</a>
                
                <div id="logged-out-buttons" class="header-buttons" style="display: none;">
                    <a href="/login/" class="header-button login">Login</a>
                    <a href="/signup/" class="header-button signup">Sign Up</a>
                </div>

                <div id="logged-in-buttons" class="header-buttons" style="display: none;">
                    <span class="user-greeting" id="user-greeting">Hey Cool Dude! üëã</span>
                    <a href="/dashboard/" class="header-button dashboard">My Dashboard</a>
                    <button id="logout-btn" class="header-button logout">Sign Out</button>
                </div>
            </div>
        </div>
    </header>

    <div id="dictionary-overlay"></div>
    <div id="dictionary-popup">
        <div id="dictionary-content"></div>
    </div>

    <a href="/phrasals/" id="latest-updates-ticker">
        üß© NEW! INTERMEDIATE: Top 10 Phrasal Verbs For Work üòé
    </a>

    <main class="container">
        <div class="info-box">
            <p id="pulse-ticker-text">Loading Office Activity... üè¢</p>
        </div>

        <div id="repair-shop-widget">
            <div class="repair-content">
                <div class="repair-text">
                    <h3 id="repair-title">üîß The Repair Shop</h3>
                    <p id="repair-desc">Checking for vocabulary that needs fixing...</p>
                </div>
                <button id="start-repair-btn" class="repair-btn" style="display:none;">
                    üõ†Ô∏è Start Quick Repair (2 min)
                </button>
            </div>
        </div>

        <section class="section">
            <div class="section-header">
                <span class="section-icon">üíº</span>
                <h2 class="section-title">Specialized English</h2>
            </div>
            <div class="course-grid">
                <a href="/business/" class="course-card">
                    <div class="course-header">
                        <span class="course-icon">üíº</span>
                        <h3 class="course-title">Business English</h3>
                        <span class="course-level">Professional</span>
                    </div>
                    <div class="course-body">
                        <p class="course-description">Master professional communication for meetings, emails, presentations, and business negotiations.</p>
                        <div class="course-meta">
                            <span class="meta-item">üìö Multiple lessons</span>
                            <span class="meta-item">‚è±Ô∏è Self-paced</span>
                        </div>
                    </div>
                </a>
                <a href="/tax/" class="course-card">
                    <div class="course-header">
                        <span class="course-icon">üí∞</span>
                        <h3 class="course-title">Tax English</h3>
                        <span class="course-level">Specialist</span>
                    </div>
                    <div class="course-body">
                        <p class="course-description">Learn tax terminology, concepts, and documentation language for accounting professionals.</p>
                        <div class="course-meta">
                            <span class="meta-item">üìö Multiple lessons</span>
                            <span class="meta-item">‚è±Ô∏è Self-paced</span>
                        </div>
                    </div>
                </a>
                <a href="/legal/" class="course-card">
                    <div class="course-header">
                        <span class="course-icon">‚öñÔ∏è</span>
                        <h3 class="course-title">Legal English</h3>
                        <span class="course-level">Specialist</span>
                    </div>
                    <div class="course-body">
                        <p class="course-description">Navigate legal terminology, contracts, and documentation with confidence and precision.</p>
                        <div class="course-meta">
                            <span class="meta-item">üìö Multiple lessons</span>
                            <span class="meta-item">‚è±Ô∏è Self-paced</span>
                        </div>
                    </div>
                </a>
            </div>
        </section>

        <section class="section">
            <div class="section-header">
                <span class="section-icon">üìñ</span>
                <h2 class="section-title">General English Courses</h2>
            </div>
            <div class="course-grid">
                <a href="/beginner/" class="course-card">
                    <div class="course-header">
                        <span class="course-icon">üå±</span>
                        <h3 class="course-title">Beginner Course</h3>
                        <span class="course-level">A1-A2</span>
                    </div>
                    <div class="course-body">
                        <p class="course-description">Start your English journey. Learn basic grammar, vocabulary, and everyday conversation skills.</p>
                        <div class="course-meta">
                            <span class="meta-item">üìö Foundation level</span>
                            <span class="meta-item">‚è±Ô∏è Step by step</span>
                        </div>
                    </div>
                </a>
                <a href="/intermediate/" class="course-card">
                    <div class="course-header">
                        <span class="course-icon">üöÄ</span>
                        <h3 class="course-title">Intermediate Course</h3>
                        <span class="course-level">B1-B2</span>
                    </div>
                    <div class="course-body">
                        <p class="course-description">Build confidence with complex grammar and expand your vocabulary for real-world situations.</p>
                        <div class="course-meta">
                            <span class="meta-item">üìö Expanding skills</span>
                            <span class="meta-item">‚è±Ô∏è Progressive</span>
                        </div>
                    </div>
                </a>
                <a href="/advanced/" class="course-card">
                    <div class="course-header">
                        <span class="course-icon">üéØ</span>
                        <h3 class="course-title">Advanced Course</h3>
                        <span class="course-level">C1-C2</span>
                    </div>
                    <div class="course-body">
                        <p class="course-description">Master sophisticated expressions, idioms, and achieve native-like fluency in British English.</p>
                        <div class="course-meta">
                            <span class="meta-item">üìö Mastery level</span>
                            <span class="meta-item">‚è±Ô∏è Advanced</span>
                        </div>
                    </div>
                </a>
            </div>
        </section>

        <section class="section">
            <div class="section-header">
                <span class="section-icon">‚òï</span>
                <h2 class="section-title">The Break Room</h2>
            </div>
            <div class="quick-links">
                <a href="/games/" class="quick-link">
                    <span class="quick-link-icon">üéÆ</span>
                    <div class="quick-link-text">
                        <div class="quick-link-title">Game Zone</div>
                        <div class="quick-link-desc">Play Taboo, Memory Match & More</div>
                    </div>
                </a>
            </div>
        </section>
    </main>

    <footer class="footer">
        <p class="footer-text">¬© 2025 English For Cool Dudes - üòé</p>
        <div style="margin-top: 10px;">
            <a href="/impressum/" style="color: #667EEA; margin-right: 15px; text-decoration: none;">Impressum</a>
            <a href="/datenschutz/" style="color: #667EEA; text-decoration: none;">Datenschutzerkl√§rung</a>
        </div>
    </footer>

<script>
    const SUPABASE_URL = 'https://knwgmrgwbpchqyqxbxea.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtud2dtcmd3YnBjaHF5cXhieGVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MDkyODgsImV4cCI6MjA3ODA4NTI4OH0.qnp2ScwSE77_idmPhpLE98sr46WvLpKtg6refFfC7s8';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // --- 1. DICTIONARY FUNCTIONS ---
    function showDictionary(word, definition, type) {
        document.getElementById('dictionary-popup').style.display = 'block';
        document.getElementById('dictionary-overlay').style.display = 'block';
        const content = document.getElementById('dictionary-content');
        content.innerHTML = `
            <h3 style="color: #667EEA; font-size: 20px; margin-bottom: 10px; font-weight: 600;">${word} <span style="font-size: 14px; color: #718096; font-weight: 600;">(${type})</span></h3>
            <p style="color: #4A5568; line-height: 1.7; margin-bottom: 20px;">${definition}</p>
            <button onclick="closeDictionary()" style="background: #E5E9F2; color: #4A5568; border: none; padding: 10px 30px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px; margin-top: 20px; ">Close</button>
        `;
    }

    function closeDictionary() {
        document.getElementById('dictionary-popup').style.display = 'none';
        document.getElementById('dictionary-overlay').style.display = 'none';
    }
    document.getElementById('dictionary-overlay').addEventListener('click', closeDictionary);

    // --- 2. BRAIN BOOST (MATCHING GAME LOGIC) ---
    async function checkForMistakesOnHomepage() {
        try {
            const { data: { user } = {} } = await supabase.auth.getUser();
            if (!user) {
                document.getElementById('repair-shop-widget').style.display = 'none';
                return;
            }

            // 1. Spaced Repetition Timeframe (Review stuff older than 24h)
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const isoYesterday = yesterday.toISOString();

            // 2. Fetch Mistakes (Priority A - Red)
            const { data: mistakes } = await supabase
                .from('user_mistakes')
                .select('word, definition, word_type, lesson, lesson_link')
                .eq('user_id', user.id)
                .limit(4); // Limit to 4 pairs

            let practiceBatch = mistakes || [];

            // 3. Fetch Spaced Reviews (Priority B - Green)
            if (practiceBatch.length < 4) {
                const slotsNeeded = 4 - practiceBatch.length;
                
                const { data: oldLessons } = await supabase
                    .from('lessons')
                    .select('vocabulary')
                    .eq('user_id', user.id)
                    .lt('completed_at', isoYesterday) 
                    .limit(5);

                if (oldLessons && oldLessons.length > 0) {
                    let poolOfKnownWords = [];
                    oldLessons.forEach(lesson => {
                        if(Array.isArray(lesson.vocabulary)) {
                            lesson.vocabulary.forEach(v => {
                                const isAlreadyInBatch = practiceBatch.some(pb => pb.word === v.word);
                                if (!isAlreadyInBatch) poolOfKnownWords.push(v);
                            });
                        }
                    });

                    poolOfKnownWords = poolOfKnownWords.sort(() => 0.5 - Math.random()).slice(0, slotsNeeded);
                    
                    poolOfKnownWords.forEach(w => {
                        practiceBatch.push({
                            word: w.word,
                            definition: w.definition,
                            word_type: w.type || 'word',
                            lesson: 'Review',
                            is_review: true 
                        });
                    });
                }
            }

            // 4. Render Widget (UPDATED LOGIC HERE)
            const widget = document.getElementById('repair-shop-widget');
            const title = document.getElementById('repair-title');
            const desc = document.getElementById('repair-desc');
            const btn = document.getElementById('start-repair-btn');

            if (practiceBatch.length > 0) {
                widget.style.display = 'block';
                // Positive Blue Styling
                widget.style.background = '#F0F9FF'; 
                widget.style.borderColor = '#BAE6FD';
                widget.style.borderLeft = '4px solid #0EA5E9'; 

                const mistakeCount = practiceBatch.filter(x => !x.is_review).length;
                const reviewCount = practiceBatch.filter(x => x.is_review).length;
                
                let headline = "üöÄ Daily Brain Boost";
                let subtext = "";
                let statsHtml = "";

                if (mistakeCount > 0 && reviewCount > 0) {
                    subtext = "Stay sharp, Cool Dude. Don't let those words escape!";
                    statsHtml = `(üéØ <span style="font-weight:bold; color:#B91C1C;">${mistakeCount} Focus Words</span> + üß† <span style="font-weight:bold; color:#15803D;">${reviewCount} Reviews</span>)`;
                } else if (mistakeCount === 0 && reviewCount > 0) {
                    subtext = "Keep your streak alive! Master what you've learned.";
                    statsHtml = `(üß† <span style="font-weight:bold; color:#15803D;">${reviewCount} Words ready for review!</span>)`;
                } else if (mistakeCount > 0 && reviewCount === 0) {
                    subtext = "Expand your world today. Learn something new!";
                    statsHtml = `(üéØ <span style="font-weight:bold; color:#B91C1C;">${mistakeCount} New Words to learn!</span>)`;
                } else {
                    headline = "üéâ All Caught Up!";
                    subtext = "You are crushing it! Enjoy your day.";
                    statsHtml = `(üåü <span style="font-weight:bold; color:#D97706;">Zero pending tasks</span>)`;
                }

                title.innerHTML = headline;
                title.style.color = '#0369A1';
                
                desc.innerHTML = `${subtext}<br><span style="font-size:12px; color:#64748B;">${statsHtml}</span>`;
                
                btn.style.display = 'inline-flex';
                btn.innerHTML = "üß© Play Match Game (1 min)";
                btn.style.background = '#0EA5E9'; 
                
                btn.onclick = () => startMatchGame(practiceBatch);
            } else {
                widget.style.display = 'none';
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // --- 3. THE MATCH GAME ENGINE ---
    function startMatchGame(batch) {
        
        // A. FETCH DATA FROM NEW DICTIONARY TABLE
        // Extract words to query
        const wordList = batch.map(b => b.word);
        let dictData = null;

        // Note: For matching game, we mainly just need definitions. 
        // We will try fetching them from the new table if they exist.
        // If not, we fallback to the local definitions saved in 'batch'.
        
        // B. BUILD GRID ITEMS
        let gridItems = [];
        
        batch.forEach((item, index) => {
            // Term Card
            gridItems.push({
                id: index,
                type: 'term',
                content: item.word,
                matchId: index, 
                originalItem: item 
            });
            // Definition Card
            gridItems.push({
                id: index + 100, 
                type: 'def',
                content: item.definition || "Definition not found",
                matchId: index,
                originalItem: item
            });
        });

        // Shuffle
        gridItems.sort(() => 0.5 - Math.random());

        // C. BUILD MODAL UI
        const practicePopup = document.createElement('div');
        practicePopup.style.cssText = `
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 30px; border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4); z-index: 10000;
            max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto;
        `;

        const overlay = document.createElement('div');
        overlay.id = 'mistake-reminder-overlay-practice';
        overlay.style.cssText = `
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); z-index: 9999; backdrop-filter: blur(2px);
        `;

        practicePopup.innerHTML = `
            <div style="text-align:center; margin-bottom: 20px;">
                <h2 style="color: #0EA5E9; margin: 0 0 5px 0; font-size: 24px; font-weight: 700;">üß© Memory Match</h2>
                <p style="color: #64748B; margin: 0; font-size: 14px;">Tap a RED word and its WHITE definition. Correct pairs vanish!</p>
            </div>
            
            <div id="game-grid" class="match-grid">
                ${gridItems.map(item => `
                    <div class="match-card ${item.type}" data-id="${item.id}" data-match="${item.matchId}">
                        ${item.content}
                    </div>
                `).join('')}
            </div>

            <div id="game-feedback" style="text-align: center; margin-top: 20px; font-weight: 700; color: #0EA5E9; min-height: 24px;"></div>

            <div style="margin-top: 20px; text-align: center;">
                <button id="close-game-btn" style="
                    background: #E2E8F0; color: #475569; border: none; padding: 10px 25px;
                    border-radius: 99px; font-weight: 600; cursor: pointer; font-size: 14px;
                ">Give Up / Close</button>
            </div>
        `;

        document.body.appendChild(overlay);
        document.body.appendChild(practicePopup);

        // D. GAMEPLAY LOGIC
        let selectedCards = [];
        let matchedCount = 0;
        const totalPairs = batch.length;
        const feedbackEl = document.getElementById('game-feedback');

        // NEW: Dynamic Feedback Arrays
        const positiveMsgs = ["BOOM! üí•", "Spot on! üéØ", "Too easy! üòé", "Memory Master! üß†", "Correct! ‚úÖ"];
        const negativeMsgs = ["Not quite... ü§î", "Try again! ‚ùå", "Keep looking! üëÄ", "Nope! üõë", "Close! ü§è"];

        document.querySelectorAll('.match-card').forEach(card => {
            card.addEventListener('click', () => {
                if (card.classList.contains('matched') || card.classList.contains('selected')) return;
                if (selectedCards.length >= 2) return;

                card.classList.add('selected');
                selectedCards.push(card);

                if (selectedCards.length === 2) {
                    checkMatch();
                }
            });
        });

        async function checkMatch() {
            const [card1, card2] = selectedCards;
            const matchId1 = card1.dataset.match;
            const matchId2 = card2.dataset.match;

            if (matchId1 === matchId2) {
                // MATCH FOUND (Random Positive Message)
                const winMsg = positiveMsgs[Math.floor(Math.random() * positiveMsgs.length)];
                feedbackEl.textContent = winMsg;
                feedbackEl.style.color = "#16A34A"; // Green
                
                setTimeout(() => {
                    card1.classList.add('matched');
                    card2.classList.add('matched');
                    card1.classList.remove('selected');
                    card2.classList.remove('selected');
                }, 300);

                matchedCount++;
                
                // DELETE MISTAKE FROM DB (If it was a mistake)
                const originalItem = batch[matchId1]; 
                if (originalItem && !originalItem.is_review) {
                    try {
                        const { data: { user } } = await supabase.auth.getUser();
                        if (user) {
                            await supabase.from('user_mistakes').delete().eq('user_id', user.id).eq('word', originalItem.word);
                        }
                    } catch (err) { console.error(err); }
                }

                if (matchedCount === totalPairs) {
                    // --- VICTORY SCREEN (AUTO CLOSE VERSION) ---
                    setTimeout(() => {
                        practicePopup.innerHTML = `
                            <div style="text-align:center; padding: 40px 20px; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
                                <div style="font-size: 80px; margin-bottom: 20px; animation: bounce 2s infinite;">üöÄ</div>
                                <h2 style="color: #0EA5E9; font-size: 28px; font-weight: 800; margin: 0 0 10px 0;">To The Moon!</h2>
                                <p style="color: #64748B; font-size: 18px; margin: 0;">Awesome job, you cleared the board!</p>
                                <div style="margin-top: 30px; font-size: 14px; color: #94A3B8;">
                                    Time for something new!
                                </div>
                            </div>
                        `;
                        
                        // Refresh main widget immediately
                        checkForMistakesOnHomepage();

                        // Auto Close after 2.5 seconds
                        setTimeout(() => {
                            closeFn();
                        }, 2500);
                    }, 800); 
                }

            } else {
                // NO MATCH (Random Negative Message)
                const failMsg = negativeMsgs[Math.floor(Math.random() * negativeMsgs.length)];
                feedbackEl.textContent = failMsg;
                feedbackEl.style.color = "#EF4444"; 
                setTimeout(() => {
                    card1.classList.remove('selected');
                    card2.classList.remove('selected');
                }, 1000);
            }
            
            selectedCards = [];
        }

        const closeFn = () => { 
            practicePopup.remove(); 
            overlay.remove(); 
            if (matchedCount > 0) checkForMistakesOnHomepage(); 
        };
        document.getElementById('close-game-btn').addEventListener('click', closeFn);
    }

    // --- 4. OFFICE PULSE ---
    async function loadOfficePulse() {
        const pulseText = document.getElementById('pulse-ticker-text');
        if(!pulseText) return;

        const { data: feed } = await supabase.from('office_pulse').select('*');
        const messages = [];

        if (feed && feed.length > 0) {
            feed.forEach(item => {
                const time = getTimeAgo(new Date(item.completed_at));
                const link = item.lesson_link || '#'; 
                messages.push(`ü•≥ ${time}: A Cool Dude finished <a href="${link}" target="_blank">${item.lesson_title}</a> (+${item.word_count} words)`);
            });
        } else {
            messages.push("üöÄ Be the first Cool Dude to complete a lesson today!");
        }

        if (messages.length > 0) pulseText.innerHTML = messages[0];

        if (messages.length > 1) {
            let msgIndex = 1; 
            setInterval(() => {
                pulseText.style.opacity = 0;
                setTimeout(() => {
                    pulseText.innerHTML = messages[msgIndex];
                    pulseText.style.opacity = 1;
                    msgIndex = (msgIndex + 1) % messages.length;
                }, 500);
            }, 5000);
        }
    }

    // --- HELPER FUNCTIONS ---
    function getTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + " years ago";
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + " months ago";
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + " days ago";
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + " hours ago";
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + " mins ago";
        return "Just now";
    }

    // --- AUTH ---
    async function initializeAuthHeader() {
        const loggedOutButtons = document.getElementById('logged-out-buttons');
        const loggedInButtons = document.getElementById('logged-in-buttons');
        const logoutBtn = document.getElementById('logout-btn');
        const userGreeting = document.getElementById('user-greeting');

         try {
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                let userName = 'Cool Dude';
                if (user.user_metadata && user.user_metadata.full_name) userName = user.user_metadata.full_name.split(' ')[0];
                else if (user.email) userName = user.email.split('@')[0];
                
                if (userGreeting) userGreeting.textContent = `Hey ${userName}! üëã`;
                if (loggedInButtons) loggedInButtons.style.display = 'flex';
                if (loggedOutButtons) loggedOutButtons.style.display = 'none';
            } else {
                if (loggedOutButtons) loggedOutButtons.style.display = 'flex';
                if (loggedInButtons) loggedInButtons.style.display = 'none';
            }
        } catch (err) { console.error('Error checking auth:', err); }

        if (logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                await supabase.auth.signOut();
                window.location.reload();
            });
        }
    }
</script>
<script src="tickerData.js"></script>
<script> 
    // --- MAIN INIT ---
    document.addEventListener('DOMContentLoaded', async () => {
        await initializeAuthHeader();
        loadOfficePulse();
        if(typeof startTickerAnimation === 'function') startTickerAnimation();
        setTimeout(() => checkForMistakesOnHomepage(), 1500);
    });
</script>
</body>
</html>
