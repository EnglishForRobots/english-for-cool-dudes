<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Tax: International Tax Professionals' Challenge</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0072b1 0%, #1a96c7 50%, #6cdceb 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #0072b1, #1a96c7);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        .header::before {
            content: 'üåç';
            position: absolute;
            top: 20px;
            left: 30px;
            font-size: 3em;
            animation: bounce 2s infinite;
        }
        .header::after {
            content: '‚öñÔ∏è';
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 3em;
            animation: bounce 2s infinite 1s;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }
        .game-stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 15px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            display: block;
        }
        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
        }
        .progress-bar {
            width: 100%;
            height: 15px;
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            overflow: hidden;
        }
        .progress {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #FFD700);
            border-radius: 10px;
            width: 0%;
            transition: width 0.8s ease;
            position: relative;
        }
        .progress::after {
            content: 'üéØ';
            position: absolute;
            right: -10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2em;
            animation: bounce 2s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(-50%) scale(1); }
            50% { transform: translateY(-60%) scale(1.2); }
        }
        .lesson-content {
            padding: 30px;
        }
        .section {
            margin-bottom: 40px;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .section:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }
        .warmup { background: linear-gradient(135deg, #FFE0B2, #FFAB40); }
        .listening { background: linear-gradient(135deg, #E8F5E8, #66BB6A); }
        .vocab { background: linear-gradient(135deg, #F3E5F5, #AB47BC); }
        .gapfill { background: linear-gradient(135deg, #FFF3E0, #FFA726); }
        .quiz { background: linear-gradient(135deg, #FFEBEE, #EF5350); }
        .challenge { background: linear-gradient(135deg, #FFF8E1, #FFCA28); }
        .comprehension { background: linear-gradient(135deg, #E3F2FD, #42A5F5); }
        .analysis { background: linear-gradient(135deg, #F1F8E9, #8BC34A); }
        .grammar { background: linear-gradient(135deg, #FFD1E3, #F48FB1); }
        .new-vocab { background: linear-gradient(135deg, #C5CAE9, #7986CB); }
        .reported-speech { background: linear-gradient(135deg, #E0F7FA, #4DD0E1); }

        .section-title {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }
        .level-badge {
            background: #0072b1;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.7em;
            position: absolute;
            right: 0;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 114, 177, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 114, 177, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 114, 177, 0); }
        }
        .story-box {
            background: white;
            padding: 25px;
            border-radius: 15px;
            border-left: 5px solid #66BB6A;
            font-size: 1.1em;
            line-height: 1.8;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .quiz-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .question-counter {
            background: #EF5350;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        .quiz-question {
            font-size: 1.2em;
            margin-bottom: 20px;
            color: #333;
            font-weight: 500;
        }
        .quiz-options {
            display: grid;
            gap: 12px;
        }
        .quiz-option {
            background: #f8f9fa;
            border: 2px solid #ddd;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1em;
        }
        .quiz-option:hover {
            background: #e3f2fd;
            border-color: #42A5F5;
            transform: translateX(5px);
        }
        .quiz-option.correct {
            background: #66BB6A !important;
            color: white !important;
            border-color: #4CAF50 !important;
        }
        .quiz-option.incorrect {
            background: #EF5350 !important;
            color: white !important;
            border-color: #f44336 !important;
        }
        .number-input {
            display: inline-block;
            width: 100px;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 0 5px;
            text-align: center;
            font-weight: bold;
            transition: border-color 0.3s ease;
            font-size: 1.1em;
        }
        .number-input:focus {
            outline: none;
            border-color: #42A5F5;
        }
        .number-input.correct {
            border-color: #66BB6A;
            background: #E8F5E8;
        }
        .number-input.incorrect {
            border-color: #EF5350;
            background: #FFEBEE;
        }
        .true-false-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 20px 0;
        }
        .tf-button {
            background: white;
            border: 3px solid #ddd;
            padding: 20px 40px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        .tf-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        .tf-button.true {
            color: #66BB6A;
            border-color: #66BB6A;
        }
        .tf-button.false {
            color: #EF5350;
            border-color: #EF5350;
        }
        .tf-button.selected.true {
            background: #66BB6A;
            color: white;
        }
        .tf-button.selected.false {
            background: #EF5350;
            color: white;
        }
        .btn {
            background: linear-gradient(135deg, #0072b1, #1a96c7);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1.1em;
            margin: 15px 10px;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(0, 114, 177, 0.3);
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 114, 177, 0.4);
        }
        .achievement {
            background: linear-gradient(135deg, #FFD700, #FFA000);
            color: white;
            padding: 15px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
            animation: achievementPop 0.6s ease;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            min-width: 300px;
        }
        @keyframes achievementPop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .highlight {
            background: linear-gradient(120deg, #FFEB3B 0%, #FFE082 100%);
            padding: 3px 6px;
            border-radius: 5px;
            font-weight: 500;
        }
        .feedback-box {
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            font-size: 1.1em;
            animation: slideIn 0.5s ease;
        }
        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .feedback-box.excellent {
            background: linear-gradient(135deg, #E8F5E8, #C8E6C9);
            border-left: 5px solid #66BB6A;
            color: #2E7D32;
        }
        .feedback-box.needs-improvement {
            background: linear-gradient(135deg, #FFEBEE, #FFCDD2);
            border-left: 5px solid #EF5350;
            color: #C62828;
        }
        .timer {
            background: #FF5722;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            animation: timerPulse 1s infinite;
            margin: 10px 0;
        }
        @keyframes timerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Gap Fill Styles */
        .gap-fill-text {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 5px solid #FFA726;
            font-size: 1.1em;
            line-height: 1.8;
        }
        .gap-input {
            display: inline-block;
            width: 120px;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 0 5px;
            text-align: center;
            font-weight: bold;
            transition: border-color 0.3s ease;
            background: #FFF8E1;
            cursor: pointer;
        }
        .gap-input:focus {
            outline: none;
            border-color: #FFA726;
        }
        .gap-input.correct {
            border-color: #66BB6A;
            background: #E8F5E8;
        }
        .gap-input.incorrect {
            border-color: #EF5350;
            background: #FFEBEE;
        }
        .word-bank {
            background: #FFF8E1;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border: 2px dashed #FFA726;
        }
        .word-option {
            display: inline-block;
            background: #FFA726;
            color: white;
            padding: 8px 15px;
            margin: 5px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }
        .word-option:hover {
            background: #FF8F00;
            transform: scale(1.05);
        }
        .word-option.used {
            background: #ccc;
            color: #666;
            cursor: not-allowed;
        }
        .word-option.selected {
             background: #FF8F00;
             box-shadow: 0 0 0 3px #FFA726;
        }

        /* Collocations Matching */
        .matching-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 20px 0;
        }
        .matching-column {
            background: white;
            padding: 20px;
            border-radius: 15px;
            border: 3px solid #8BC34A;
        }
        .matching-item {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .matching-item:hover {
            background: #E8F5E8;
            border-color: #8BC34A;
        }
        .matching-item.selected {
            background: #8BC34A;
            color: white;
        }
        .matching-item.matched {
            background: #C8E6C9;
            border-color: #66BB6A;
            cursor: default;
        }
        
        .did-you-know {
            background: linear-gradient(135deg, #E0F7FA, #80DEEA);
            border-left: 5px solid #00ACC1;
            color: #006064;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            font-size: 1.1em;
            line-height: 1.6;
        }
        .did-you-know h3 {
            color: #004D40;
            margin-bottom: 15px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .did-you-know ul {
            list-style-type: none;
            padding-left: 20px;
        }
        .did-you-know li {
            margin-bottom: 10px;
            position: relative;
        }
        .did-you-know li::before {
            content: 'üí°';
            position: absolute;
            left: -20px;
            font-size: 1.2em;
        }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 2em; }
            .section { margin-bottom: 20px; padding: 20px; }
            .game-stats { flex-direction: column; gap: 15px; }
            .true-false-container { flex-direction: column; align-items: center; }
            .achievement { 
                position: static; 
                margin: 20px auto; 
                min-width: auto; 
                width: 90%; 
            }
            .matching-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body onload="shuffleCollocations(); displayVocabQuestion(); setupAdvancedGrammar(); setupGrammar();">
    <div class="container">
        <div class="header">
            <h1>üåç Global Tax: Professionals' Challenge</h1>
            <p class="subtitle">Upper Intermediate Business English for International Tax</p>
            
            <div class="game-stats">
                <div class="stat-item">
                    <span class="stat-number" id="score">0</span>
                    <span class="stat-label">POINTS</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="level">1</span>
                    <span class="stat-label">LEVEL</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="streak">0</span>
                    <span class="stat-label">STREAK</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="achievements">0</span>
                    <span class="stat-label">üèÜ BADGES</span>
                </div>
            </div>
            
            <div class="progress-bar">
                <div class="progress" id="progressBar"></div>
            </div>
        </div>

        <div class="lesson-content">
            <div class="section warmup">
                <h2 class="section-title">
                    <span class="emoji">‚ö°</span>Speed Challenge: Tax Terms
                    <span class="level-badge">LEVEL 1</span>
                </h2>
                
                <div class="timer" id="speedTimer" style="display:none;">
                    <span>‚è∞</span>
                    <span id="timeLeft">30</span> seconds
                </div>
                
                <div class="quiz-container" id="speedQuiz" style="display:none;">
                    <div class="question-counter">Speed Round 1/5</div>
                    <div class="quiz-question"></div>
                    <div class="quiz-options"></div>
                </div>

                <button class="btn" onclick="startSpeedRound()">üèÉ‚Äç‚ôÇÔ∏è Start 30-Second Challenge</button>
            </div>

            <hr>

            <div class="did-you-know">
                <h3>üí° Did you know?</h3>
                <ul>
                    <li>The **OECD** (Organisation for Economic Co-operation and Development) has 38 member countries and is a key driver of international tax policy, including the BEPS project.</li>
                    <li>**Transfer pricing** is the setting of prices for goods, services, and intangibles sold between controlled (or related) entities within a multinational enterprise.</li>
                    <li>The **BEPS** (Base Erosion and Profit Shifting) project includes 15 Action Plans designed to tackle tax avoidance strategies that exploit gaps and mismatches in tax rules.</li>
                </ul>
            </div>

            <hr>

            <div class="section listening">
                <h2 class="section-title">
                    <span class="emoji">üìä</span>Reading Comprehension: The OECD's Pillar Two
                    <span class="level-badge">LEVEL 2</span>
                </h2>

                <div class="story-box">
                    <p><strong>üìà The Global Minimum Tax: Pillar Two of the BEPS project</strong></p>
                    <p>The OECD's global minimum tax, also known as Pillar Two, aims to ensure large multinational corporations pay a minimum corporate tax rate of <span class="highlight">15%</span> on their profits globally. This initiative applies to companies with annual revenues exceeding ‚Ç¨<span class="highlight">750 million</span>.</p>
                    
                    <p>The rules are expected to generate an additional **$150 billion** in global tax revenues annually. As of early 2024, approximately **40** countries have either implemented or are in the process of implementing the Pillar Two rules.</p>
                    
                    <p>The OECD estimates that more than **10,000** multinational enterprises fall under the scope of these new rules, representing a significant number of companies that will need to <span class="highlight">restructure their tax compliance processes</span>.</p>
                </div>

                <div class="quiz-container">
                    <div class="question-counter">Numbers Challenge</div>
                    <div class="quiz-question">Complete the sentences with the correct numbers from the text:</div>
                    
                    <p style="margin: 15px 0;">1. The minimum corporate tax rate is <input type="number" class="number-input" id="num1" data-answer="15">%.</p>
                    
                    <p style="margin: 15px 0;">2. Companies with revenues over <input type="number" class="number-input" id="num2" data-answer="750"> million euros are affected.</p>
                    
                    <p style="margin: 15px 0;">3. The rules could generate <input type="number" class="number-input" id="num3" data-answer="150"> billion dollars in new revenue annually.</p>
                    
                    <p style="margin: 15px 0;">4. Approximately <input type="number" class="number-input" id="num4" data-answer="40"> countries are implementing Pillar Two.</p>
                    
                    <p style="margin: 15px 0;">5. More than <input type="number" class="number-input" id="num5" data-answer="10000"> multinational enterprises are in scope.</p>
                </div>

                <button class="btn" onclick="checkNumbers()">üìä Check My Numbers</button>
            </div>

            <hr>

            <div class="section quiz">
                <h2 class="section-title">
                    <span class="emoji">‚úÖ</span>True or False?
                    <span class="level-badge">LEVEL 3</span>
                </h2>
                <div class="quiz-container">
                    <div class="quiz-question">A tax treaty between two countries prevents all taxation on cross-border business.</div>
                    <div class="true-false-container">
                        <button class="tf-button true" onclick="answerTrueFalse(this, false, true)">TRUE</button>
                        <button class="tf-button false" onclick="answerTrueFalse(this, false, false)">FALSE</button>
                    </div>
                </div>
                 <div class="quiz-container">
                    <div class="quiz-question">A Permanent Establishment (PE) is a concept used to determine if a foreign company has a taxable presence in a country.</div>
                    <div class="true-false-container">
                        <button class="tf-button true" onclick="answerTrueFalse(this, true, true)">TRUE</button>
                        <button class="tf-button false" onclick="answerTrueFalse(this, true, false)">FALSE</button>
                    </div>
                </div>
            </div>

            <hr>

            <div class="section grammar">
                <h2 class="section-title">
                    <span class="emoji">üìù</span>Grammar Challenge: Complex Conditionals
                    <span class="level-badge">UPPER-INT</span>
                </h2>
                <div class="quiz-container" id="grammarQuiz">
                    </div>
                <button class="btn" onclick="checkGrammar()">‚úÖ Check My Answers</button>
            </div>

            <hr>

            <div class="section reported-speech">
                <h2 class="section-title">
                    <span class="emoji">üíº</span>Advanced Grammar: Business Scenarios
                    <span class="level-badge">UPPER-INT</span>
                </h2>
                <div class="quiz-container" id="advancedGrammarQuiz">
                    </div>
                <button class="btn" onclick="checkAdvancedGrammar()">‚úÖ Check My Answers</button>
            </div>
            
            <hr>

            <div class="section gapfill">
                <h2 class="section-title">
                    <span class="emoji">üìù</span>Gap Fill: Transfer Pricing Fundamentals
                    <span class="level-badge">LEVEL 5</span>
                </h2>
                
                <div class="word-bank">
                    <strong>Word Bank:</strong>
                    <span class="word-option" onclick="selectWord(this)" data-word="arm's-length">arm's-length</span>
                    <span class="word-option" onclick="selectWord(this)" data-word="allocate">allocate</span>
                    <span class="word-option" data-word="intercompany" onclick="selectWord(this)">intercompany</span>
                    <span class="word-option" data-word="mitigate" onclick="selectWord(this)">mitigate</span>
                    <span class="word-option" data-word="taxable" onclick="selectWord(this)">taxable</span>
                    <span class="word-option" data-word="jurisdictions" onclick="selectWord(this)">jurisdictions</span>
                    <span class="word-option" data-word="profits" onclick="selectWord(this)">profits</span>
                    <span class="word-option" data-word="audits" onclick="selectWord(this)">audits</span>
                </div>

                <div class="gap-fill-text">
                    <p>International tax professionals must ensure that <input type="text" class="gap-input" id="gap1" data-answer="intercompany" readonly onclick="fillGap(this)"> transactions between related entities are priced according to the <input type="text" class="gap-input" id="gap2" data-answer="arm's-length" readonly onclick="fillGap(this)"> principle.</p>
                    
                    <p>The goal is to accurately <input type="text" class="gap-input" id="gap3" data-answer="allocate" readonly onclick="fillGap(this)"> <input type="text" class="gap-input" id="gap4" data-answer="profits" readonly onclick="fillGap(this)"> to the correct <input type="text" class="gap-input" id="gap5" data-answer="jurisdictions" readonly onclick="fillGap(this)"> and avoid shifting profits to low-tax areas.</p>
                    
                    <p>Compliance with these rules is crucial to <input type="text" class="gap-input" id="gap6" data-answer="mitigate" readonly onclick="fillGap(this)"> the risk of penalties and lengthy tax <input type="text" class="gap-input" id="gap7" data-answer="audits" readonly onclick="fillGap(this)">. This ensures the correct amount of <input type="text" class="gap-input" id="gap8" data-answer="taxable" readonly onclick="fillGap(this)"> income is reported in each country.</p>
                </div>

                <button class="btn" onclick="checkGapFill()">‚úÖ Check Gap Fill</button>
            </div>
            
            <hr>

            <div class="section new-vocab">
                <h2 class="section-title">
                    <span class="emoji">üí¨</span>Contextual Vocabulary Quiz
                    <span class="level-badge">UPPER-INT</span>
                </h2>
                <div class="quiz-container" id="vocabQuiz">
                    <div class="question-counter">Question 1/3</div>
                    <div class="quiz-question"></div>
                    <div class="quiz-options">
                        </div>
                </div>
            </div>
            
            <hr>

            <div class="section vocab">
                <h2 class="section-title">
                    <span class="emoji">üîó</span>Business Collocations Matching
                    <span class="level-badge">LEVEL 6</span>
                </h2>
                
                <p><strong>Instructions:</strong> Match the business verbs with their common noun partners. Click one from each column!</p>
                
                <div class="matching-container">
                    <div class="matching-column" id="verbsColumn">
                        <h3 style="text-align: center; margin-bottom: 15px;">VERBS</h3>
                    </div>
                    <div class="matching-column" id="nounsColumn">
                        <h3 style="text-align: center; margin-bottom: 15px;">NOUNS</h3>
                    </div>
                </div>

                <button class="btn" onclick="checkMatching()">üîó Check Matches</button>
            </div>
        </div>
    </div>

    <script>
        let score = 0;
        let level = 1;
        let streak = 0;
        let achievements = 0;
        const totalSections = 8;
        let totalQuestionsAnswered = 0;
        let correctAnswersCount = 0;

        function updateStats(points, resetStreak = false) {
            score += points;
            if (resetStreak) {
                streak = 0;
            } else {
                streak++;
            }
            if (score >= 100 * level) {
                level++;
                score = 0;
                showAchievement(`Level Up! You are now Level ${level}! üéâ`);
            }
            document.getElementById('score').textContent = score;
            document.getElementById('level').textContent = level;
            document.getElementById('streak').textContent = streak;
            updateProgressBar();
        }

        function updateProgressBar() {
            const progress = (score / (100 * level)) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
        }

        function showAchievement(message) {
            const achievementBox = document.createElement('div');
            achievementBox.className = 'achievement';
            achievementBox.textContent = message;
            document.body.appendChild(achievementBox);
            achievements++;
            document.getElementById('achievements').textContent = achievements;
            setTimeout(() => {
                achievementBox.remove();
            }, 3000);
        }

        function showFeedback(element, isCorrect, message) {
            const feedbackBox = document.createElement('div');
            feedbackBox.className = `feedback-box ${isCorrect ? 'excellent' : 'needs-improvement'}`;
            feedbackBox.innerHTML = `${isCorrect ? 'ü•≥ Excellent!' : 'üòü Try again!'} ${message}`;
            element.parentNode.insertBefore(feedbackBox, element.nextSibling);
            setTimeout(() => {
                feedbackBox.remove();
            }, 5000);
        }

        // Helper function to shuffle an array
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Speed Challenge
        let speedQuizIndex = 0;
        const speedQuestions = [
            { q: 'What does "OECD" stand for?', a: 'Organisation for Economic Co-operation and Development', options: ['Organisation for Economic Co-operation and Development', 'Overseas Economic Contribution Department', 'Organization of European Corporate Dynamics', 'Official Economic and Corporate Data'] },
            { q: 'What is "transfer pricing"?', a: 'Setting prices for related-party transactions', options: ['Pricing for shipping transfers', 'Setting prices for related-party transactions', 'Transferring funds between banks', 'Setting up pricing for new products'] },
            { q: 'What does "BEPS" stand for?', a: 'Base Erosion and Profit Shifting', options: ['Business Exchange and Payment System', 'Base Erosion and Profit Shifting', 'Banking Enterprise Profit Solutions', 'Borderless Economic Planning Standards'] },
            { q: 'What is a "tax treaty"?', a: 'An agreement to avoid double taxation', options: ['A tax payment contract', 'An agreement to avoid double taxation', 'A list of tax laws', 'A form for tax returns'] },
            { q: 'What is a "tax jurisdiction"?', a: 'A country or region with its own tax laws', options: ['A tax court', 'A country or region with its own tax laws', 'A tax-free zone', 'A legal case about tax'] }
        ];
        let speedTimer;
        let timeLeft = 30;
        let speedQuizCorrect = 0;

        function startSpeedRound() {
            speedQuizIndex = 0;
            speedQuizCorrect = 0;
            timeLeft = 30;
            document.getElementById('speedTimer').style.display = 'inline-flex';
            document.querySelector('.warmup button').style.display = 'none';
            document.getElementById('speedQuiz').style.display = 'block';
            nextSpeedQuestion();
            speedTimer = setInterval(() => {
                timeLeft--;
                document.getElementById('timeLeft').textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(speedTimer);
                    endSpeedRound();
                }
            }, 1000);
        }
        
        function nextSpeedQuestion() {
            if (speedQuizIndex >= speedQuestions.length) {
                endSpeedRound();
                return;
            }
            const q = speedQuestions[speedQuizIndex];
            const quizContainer = document.getElementById('speedQuiz');
            quizContainer.querySelector('.question-counter').textContent = `Speed Round ${speedQuizIndex + 1}/5`;
            quizContainer.querySelector('.quiz-question').textContent = q.q;

            const optionsContainer = quizContainer.querySelector('.quiz-options');
            optionsContainer.innerHTML = '';
            
            const shuffledOptions = shuffleArray([...q.options]);

            shuffledOptions.forEach(optionText => {
                const optionElement = document.createElement('div');
                optionElement.className = 'quiz-option';
                optionElement.textContent = optionText;
                
                const isCorrect = optionText === q.a;
                optionElement.onclick = () => answerSpeed(optionElement, isCorrect);
                
                optionsContainer.appendChild(optionElement);
            });
        }

        function answerSpeed(element, isCorrect) {
            const allOptions = element.parentNode.children;
            for (let i = 0; i < allOptions.length; i++) {
                allOptions[i].style.pointerEvents = 'none';
                if (allOptions[i].textContent === speedQuestions[speedQuizIndex].a) {
                    allOptions[i].classList.add('correct');
                } else if (element === allOptions[i]) {
                    element.classList.add('incorrect');
                }
            }
            if (isCorrect) {
                speedQuizCorrect++;
            }
            setTimeout(() => {
                speedQuizIndex++;
                if (speedQuizIndex < speedQuestions.length) {
                    nextSpeedQuestion();
                } else {
                    endSpeedRound();
                }
            }, 1000);
        }

        function endSpeedRound() {
            clearInterval(speedTimer);
            document.getElementById('speedTimer').style.display = 'none';
            document.querySelector('.warmup button').style.display = 'block';
            let message = `You got ${speedQuizCorrect} out of 5 correct!`;
            if (speedQuizCorrect === 5) {
                showAchievement('Speed Demon! 5/5 correct! üèÜ');
                updateStats(50);
            } else {
                updateStats(speedQuizCorrect * 10, true);
            }
            showFeedback(document.querySelector('.warmup'), speedQuizCorrect === 5, message);
        }

        // Numbers Challenge
        function checkNumbers() {
            const inputs = document.querySelectorAll('#num1, #num2, #num3, #num4, #num5');
            let correctCount = 0;
            inputs.forEach(input => {
                const isCorrect = input.value == input.getAttribute('data-answer');
                if (isCorrect) {
                    input.classList.remove('incorrect');
                    input.classList.add('correct');
                    correctCount++;
                } else {
                    input.classList.remove('correct');
                    input.classList.add('incorrect');
                }
            });

            if (correctCount === inputs.length) {
                updateStats(50);
                showAchievement('Numbers Guru! All numbers correct! üì¢');
                showFeedback(document.querySelector('.listening'), true, 'You got all the numbers right!');
            } else {
                updateStats(0, true);
                showFeedback(document.querySelector('.listening'), false, `You got ${correctCount} out of ${inputs.length} correct. The correct answers are: 15, 750, 150, 40, 10000.`);
            }
        }

        // True/False
        function answerTrueFalse(button, correctAnswer, userChoice) {
            const container = button.closest('.quiz-container');
            const allButtons = container.querySelectorAll('.tf-button');
            allButtons.forEach(btn => btn.style.pointerEvents = 'none');
            
            if (userChoice === correctAnswer) {
                button.classList.add('selected', 'true');
                updateStats(25);
                showFeedback(container, true, 'Great job! That is correct!');
            } else {
                button.classList.add('selected', 'false');
                updateStats(0, true);
                const correctButton = container.querySelector(correctAnswer ? '.tf-button.true' : '.tf-button.false');
                correctButton.classList.add('selected', 'true');
                showFeedback(container, false, 'That is incorrect. The correct answer is ' + (correctAnswer ? 'True' : 'False') + '.');
            }
        }

        // Grammar Challenge - Complex Conditionals
        const grammarQuestions = [
            {
                q: 'Complete: "If a company were to manipulate its transfer prices, it _____ severe penalties."',
                a: 'would face',
                options: ['will face', 'would face', 'faces', 'is facing']
            },
            {
                q: 'Complete: "Had the tax treaty been ratified, they _____ a lower withholding tax rate."',
                a: 'would have applied',
                options: ['will apply', 'would apply', 'would have applied', 'applied']
            },
            {
                q: 'Complete: "Unless we file the tax return on time, we _____ a late filing penalty."',
                a: 'will incur',
                options: ['will incur', 'would incur', 'incur', 'incurred']
            }
        ];

        function setupGrammar() {
            const container = document.getElementById('grammarQuiz');
            container.innerHTML = '';
            
            grammarQuestions.forEach((q, index) => {
                const quizBox = document.createElement('div');
                quizBox.className = 'quiz-container';
                quizBox.innerHTML = `
                    <div class="question-counter">Grammar ${index + 1}/${grammarQuestions.length}</div>
                    <div class="quiz-question">${q.q}</div>
                    <div class="quiz-options">
                        ${q.options.map((option, i) => `
                            <div class="quiz-option" data-correct="${option === q.a}" onclick="checkGrammarOption(this, ${option === q.a})">${option}</div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(quizBox);
            });
        }

        function checkGrammarOption(element, isCorrect) {
            const quizContainer = element.closest('.quiz-container');
            const allOptions = quizContainer.querySelectorAll('.quiz-option');
            allOptions.forEach(opt => opt.style.pointerEvents = 'none');

            if (isCorrect) {
                element.classList.add('correct');
                updateStats(30);
                showFeedback(quizContainer, true, 'Correct! Well done with conditionals.');
            } else {
                element.classList.add('incorrect');
                updateStats(0, true);
                const correctElement = Array.from(allOptions).find(opt => opt.dataset.correct === 'true');
                if (correctElement) {
                    correctElement.classList.add('correct');
                }
                showFeedback(quizContainer, false, 'Incorrect. Review conditional sentence structures.');
            }
        }

        function checkGrammar() {
            if (document.getElementById('grammarQuiz').children.length === 0) {
                setupGrammar();
            }
        }

        // Advanced Grammar Section
        const advancedGrammarQuestions = [
            {
                type: 'reported-speech',
                q: 'The tax director said, "We have to consider the new BEPS regulations."',
                a: 'The tax director said that they had to consider the new BEPS regulations.',
                options: [
                    'The tax director said that we have to consider the new BEPS regulations.',
                    'The tax director said that they have to consider the new BEPS regulations.',
                    'The tax director said that they had to consider the new BEPS regulations.',
                    'The tax director said that they consider the new BEPS regulations.'
                ]
            },
            {
                type: 'passive-voice',
                q: 'Transform to passive: "The auditors will scrutinize the company‚Äôs transfer pricing documentation."',
                a: 'The company‚Äôs transfer pricing documentation will be scrutinized by the auditors.',
                options: [
                    'The company‚Äôs transfer pricing documentation will be scrutinized by the auditors.',
                    'The auditors will be scrutinized by the company‚Äôs transfer pricing documentation.',
                    'The company‚Äôs transfer pricing documentation is being scrutinized.',
                    'The company‚Äôs transfer pricing documentation was scrutinized.'
                ]
            },
            {
                type: 'subjunctive',
                q: 'Complete: "The authorities demanded that the company _____ its profits fairly."',
                a: 'allocate',
                options: [
                    'allocates',
                    'to allocate',
                    'allocate',
                    'allocated'
                ]
            }
        ];

        function setupAdvancedGrammar() {
            const container = document.getElementById('advancedGrammarQuiz');
            container.innerHTML = '';
            
            advancedGrammarQuestions.forEach((q, index) => {
                const quizBox = document.createElement('div');
                quizBox.className = 'quiz-container';
                quizBox.innerHTML = `
                    <div class="question-counter">Advanced ${index + 1}/${advancedGrammarQuestions.length}</div>
                    <div class="quiz-question"><strong>Task:</strong> ${q.q}</div>
                    <div class="quiz-options">
                        ${q.options.map((option, i) => `
                            <div class="quiz-option" data-correct="${option === q.a}" onclick="checkAdvancedGrammarOption(this, ${option === q.a})">${option}</div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(quizBox);
            });
        }
        
        function checkAdvancedGrammarOption(element, isCorrect) {
            const quizContainer = element.closest('.quiz-container');
            const allOptions = quizContainer.querySelectorAll('.quiz-option');
            allOptions.forEach(opt => opt.style.pointerEvents = 'none');

            if (isCorrect) {
                element.classList.add('correct');
                updateStats(30);
                showFeedback(quizContainer, true, 'Correct! Excellent use of advanced grammar.');
            } else {
                element.classList.add('incorrect');
                updateStats(0, true);
                const correctElement = Array.from(allOptions).find(opt => opt.dataset.correct === 'true');
                if (correctElement) {
                    correctElement.classList.add('correct');
                }
                showFeedback(quizContainer, false, 'Incorrect. Review advanced grammar structures.');
            }
        }
        
        function checkAdvancedGrammar() {
            let allAnswered = true;
            document.querySelectorAll('#advancedGrammarQuiz .quiz-container').forEach(quizBox => {
                const hasAnswer = quizBox.querySelector('.quiz-option.correct, .quiz-option.incorrect');
                if (!hasAnswer) {
                    allAnswered = false;
                }
            });
            
            if (allAnswered) {
                const correctCount = document.querySelectorAll('#advancedGrammarQuiz .quiz-option.correct').length;
                if (correctCount === advancedGrammarQuestions.length) {
                    showAchievement('Grammar Pro! All scenarios correct! üèÜ');
                }
            } else {
                showFeedback(document.querySelector('.reported-speech'), false, 'Please complete all questions before checking your final score!');
            }
        }

        // Gap Fill
        let selectedWord = null;
        function selectWord(element) {
            document.querySelectorAll('.word-option').forEach(opt => opt.classList.remove('selected'));
            
            if (!element.classList.contains('used')) {
                element.classList.add('selected');
                selectedWord = element;
            } else {
                selectedWord = null;
            }
        }

        function fillGap(input) {
            if (input.value) {
                const wordInGap = input.value;
                const wordOption = document.querySelector(`.word-option[data-word="${wordInGap}"]`);
                if (wordOption) {
                    wordOption.classList.remove('used');
                }
                input.value = '';
                input.classList.remove('correct', 'incorrect');
            }
            
            if (selectedWord) {
                const wordToFill = selectedWord.dataset.word;
                input.value = wordToFill;
                selectedWord.classList.add('used');
                selectedWord.classList.remove('selected');
                selectedWord = null;
            }
        }

        function checkGapFill() {
            const inputs = document.querySelectorAll('.gap-input');
            let correctCount = 0;
            inputs.forEach(input => {
                const isCorrect = input.value === input.getAttribute('data-answer');
                if (isCorrect) {
                    input.classList.add('correct');
                    correctCount++;
                } else {
                    input.classList.add('incorrect');
                }
            });

            if (correctCount === inputs.length) {
                updateStats(100);
                showAchievement('Fill-in Master! Perfect score! ‚úèÔ∏è');
                showFeedback(document.querySelector('.gapfill'), true, 'All gaps filled correctly!');
            } else {
                updateStats(0, true);
                showFeedback(document.querySelector('.gapfill'), false, `You got ${correctCount} out of ${inputs.length} correct. The correct words are: intercompany, arm's-length, allocate, profits, jurisdictions, mitigate, audits, taxable.`);
            }
        }
        
        // Vocabulary Activity
        const vocabQuestions = [
            { q: 'The company decided to _____ its operations to a low-tax jurisdiction to reduce its tax burden.', a: 'relocate', options: ['relocate', 'liquidate', 'negotiate', 'regulate'] },
            { q: 'To remain compliant, the multinational must ensure all transactions adhere to the _____ principle.', a: 'arm\'s-length', options: ['arm\'s-length', 'fair-value', 'transfer-pricing', 'capital-gains'] },
            { q: 'The new regulations are designed to _____ against aggressive tax planning and profit shifting.', a: 'safeguard', options: ['safeguard', 'disregard', 'regard', 'forward'] }
        ];
        let vocabQuizIndex = 0;

        function displayVocabQuestion() {
            const container = document.getElementById('vocabQuiz');
            const optionsContainer = container.querySelector('.quiz-options');
            
            if (vocabQuizIndex >= vocabQuestions.length) {
                showFeedback(container, true, 'You have completed the vocabulary quiz!');
                return;
            }

            const q = vocabQuestions[vocabQuizIndex];
            container.querySelector('.question-counter').textContent = `Question ${vocabQuizIndex + 1}/${vocabQuestions.length}`;
            container.querySelector('.quiz-question').innerHTML = q.q;

            optionsContainer.innerHTML = '';
            
            const shuffledOptions = shuffleArray([...q.options]);

            shuffledOptions.forEach(optionText => {
                const optionElement = document.createElement('div');
                optionElement.className = 'quiz-option';
                optionElement.textContent = optionText;
                
                const isCorrect = optionText === q.a;
                optionElement.onclick = () => checkVocabAnswer(optionElement, isCorrect);
                
                optionsContainer.appendChild(optionElement);
            });
        }

        function checkVocabAnswer(element, isCorrect) {
            const container = element.closest('.quiz-container');
            const allOptions = container.querySelectorAll('.quiz-option');
            allOptions.forEach(opt => opt.style.pointerEvents = 'none');

            if (isCorrect) {
                element.classList.add('correct');
                updateStats(25);
                showFeedback(container, true, 'That is the correct word!');
            } else {
                element.classList.add('incorrect');
                updateStats(0, true);
                const correctElement = Array.from(allOptions).find(opt => opt.textContent === vocabQuestions[vocabQuizIndex].a);
                if (correctElement) {
                    correctElement.classList.add('correct');
                }
                showFeedback(container, false, `Incorrect. The correct answer is "${vocabQuestions[vocabQuizIndex].a}".`);
            }
            
            setTimeout(() => {
                vocabQuizIndex++;
                displayVocabQuestion();
            }, 1500);
        }

        // Collocations Matching
        const collocations = [
            {verb: 'ALLOCATE', noun: 'profits'},
            {verb: 'MITIGATE', noun: 'risk'},
            {verb: 'COMPLY', noun: 'with regulations'},
            {verb: 'FILE', noun: 'a tax return'},
            {verb: 'APPLY', noun: 'a tax treaty'}
        ];
        
        let selectedVerb = null;
        let selectedNoun = null;
        let matchedPairs = 0;
        let allItems = new Map();

        function shuffleCollocations() {
            const verbs = collocations.map(c => c.verb);
            const nouns = collocations.map(c => c.noun);
            
            for (let i = nouns.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [nouns[i], nouns[j]] = [nouns[j], nouns[i]];
            }
            
            const verbsColumn = document.getElementById('verbsColumn');
            verbsColumn.innerHTML = '<h3 style="text-align: center; margin-bottom: 15px;">VERBS</h3>';
            verbs.forEach(verb => {
                const verbItem = document.createElement('div');
                verbItem.className = 'matching-item';
                verbItem.textContent = verb;
                verbItem.dataset.match = collocations.find(c => c.verb === verb).noun;
                verbItem.addEventListener('click', () => selectMatching('verb', verbItem));
                verbsColumn.appendChild(verbItem);
                allItems.set(verb, verbItem);
            });
            
            const nounsColumn = document.getElementById('nounsColumn');
            nounsColumn.innerHTML = '<h3 style="text-align: center; margin-bottom: 15px;">NOUNS</h3>';
            nouns.forEach(noun => {
                const nounItem = document.createElement('div');
                nounItem.className = 'matching-item';
                nounItem.textContent = noun;
                nounItem.dataset.match = collocations.find(c => c.noun === noun).verb;
                nounItem.addEventListener('click', () => selectMatching('noun', nounItem));
                nounsColumn.appendChild(nounItem);
                allItems.set(noun, nounItem);
            });
            
            matchedPairs = 0;
        }

        function selectMatching(type, element) {
            if (element.classList.contains('matched')) return;

            if (type === 'verb') {
                if (selectedVerb) {
                    selectedVerb.classList.remove('selected');
                }
                selectedVerb = element;
            } else {
                if (selectedNoun) {
                    selectedNoun.classList.remove('selected');
                }
                selectedNoun = element;
            }

            element.classList.add('selected');
        }

        function checkMatching() {
            if (selectedVerb && selectedNoun) {
                const verbMatch = selectedVerb.dataset.match;
                const nounMatch = selectedNoun.textContent;

                if (verbMatch === nounMatch) {
                    selectedVerb.classList.add('matched');
                    selectedNoun.classList.add('matched');
                    matchedPairs++;
                    updateStats(30);
                    showFeedback(document.querySelector('.matching-container'), true, 'Correct match! Keep going!');
                } else {
                    updateStats(0, true);
                    showFeedback(document.querySelector('.matching-container'), false, 'Incorrect match. Try another pair!');
                }

                selectedVerb.classList.remove('selected');
                selectedNoun.classList.remove('selected');
                selectedVerb = null;
                selectedNoun = null;

                if (matchedPairs === collocations.length) {
                    showAchievement('Collocation Champion! All pairs matched! üèÜ');
                    updateStats(100);
                }
            }
        }

        // Initialize when page loads
        window.onload = function() {
            shuffleCollocations();
            displayVocabQuestion();
            setupAdvancedGrammar();
            setupGrammar();
        };
    </script>
</body>
</html>
